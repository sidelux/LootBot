process.on('uncaughtException', function (err) {
	console.error("\x1b[31m" + err.stack + "\x1b[0m");
});

process.on('unhandledRejection', function(reason, p){
	console.error("\x1b[31m" + reason.stack + ")\x1b[0m");
});

//Globali
var max_mission_id = 290;
var firstStart = 0;
var banlist_id = [];
var banlist_tx = [];
var timevar = [];

var crazyMode = 0;
var luckyMode = 0;
var arena = 0;
var xxxteria = 0;
var xxxteriaBlock = 0;
var autoEstrazione = 0;
var halloween = 0;
var villa = 0;		//Ricordati il blocco anche da setFinishedMission
var mistery = 0;
var wanted = 0;
var eventStory = 0;
var eventMana = 0;
var eventFestival = 0;
var specialMission = 0;
var eventDust = 0;
var eventGiant = 0;

var sconto = 10;
var max_duration = 5;
var wait_room = 900;
var wait_dungeon = 2;
var wait_dungeon_long = 5;
var max_istance = 120;
var rankList = [20,50,75,100,150,200,500,1000];

var progLev = [50,100,200,300,500,750,1000];
var progLevRew = [50000,100000,150000,250000,1000000,2500000,5000000];
var progMis = [10, 25, 50, 75, 100, 250, 500, 1000, 2000, 5000, 10000];
var progMisRew = [5000, 12500, 25000, 50000, 75000, 100000, 250000, 350000, 500000, 1000000, 2000000];
var progDung = [1, 5, 10, 25, 50, 75, 100, 250, 500];
var progDungRew = [10000, 50000, 75000, 100000, 250000, 500000, 750000, 1000000, 2000000];

var re = new RegExp("^[0-9]*$");
var re2 = new RegExp("^[a-zA-Z0-9Ã Ã¨Ã¬Ã²Ã¹ ]*$");
var re3 = new RegExp("^[a-zA-Z0-9?,.Ã Ã¨Ã©Ã¬Ã²Ã¹@ ]*$");

var TelegramBot = require('node-telegram-bot-api');
var fs = require('fs')
var Schedule = require('node-schedule');
var similarWord = require('fast-levenshtein');

var token = '171514820:AAHSsAF-_bkpB5Du5NLvRqlUpzgSntwz22c';
var bot = new TelegramBot(token, {polling: true});

var Schedule = require('node-schedule');
var exec = require('child_process').exec;

var j = Schedule.scheduleJob('00 3 * * *', function(){		//3 notte
	refreshHeists();
	refreshLife();
});

var j2 = Schedule.scheduleJob('59 23 * * *', function(){	//23:59 notte
	saveActive();	
});

var j3 = Schedule.scheduleJob('01 00 * * *', function(){	//00:01 notte
	var d = new Date();
	if (d.getDay() != 5){
		autoMana();
	}
	if (d.getDay() != 2){
		autoDust();
	}
	if ((d.getDay() != 6) && (d.getDay() != 0)){
		reloadAchievement();
	}else{
		resetAchievement();
	}
	if (d.getDay() == 1){
		craftWeek();
	}
	market_generation();
	resetDungeonSkip();
	resetRefill();
});

callNTimes(40000, function(){					//40 secondi
	checkMissions();
});

callNTimes(60000, function() { 					//Ogni 1 minuto
	if (mistery == 1){
		checkChestEvent();
	}
	if (eventStory == 1){
		checkEventMissions();
	}
	checkDragonArena();
	checkEventMissions();
	checkSpecialMissions();
	checkDungeonRoom();
	checkDungeonEnd();
	checkDungeonExpire();
	checkIstanceExpire();
	checkHeists();
	checkHeistsProgress();
	checkDust();

	var d = new Date();
	if ((d.getDay() != 6) && (d.getDay() != 0)){
		crazyMode = 0;
	}else if (crazyMode == 1){
		wait_room = 300;
		wait_dungeon = 2;
	}
	if ((d.getDay() != 6) && (d.getDay() != 0) && (luckyMode == 1)){
		luckyMode = 0;
	}
	if ((d.getDay() == 4) || (d.getDay() == 5)){
		eventMana = 1;
		checkKeyboard();
	}else{
		eventMana = 0;
		checkKeyboard();
	}
	if ((d.getDay() == 1) || (d.getDay() == 2)){
		eventDust = 1;
		checkKeyboard();
	}else{
		eventDust = 0;
		checkKeyboard();
	}

	if (eventFestival == 1){
		reloadFestival();
	}
	if (autoEstrazione == 1){
		estrazione();
	}
});

callNTimes(120000, function() {  				//Ogni 2 minuti
	checkProtection();
	checkDungeonNotification();
	checkDungeonNotificationIstance();
	checkReborn();
});

callNTimes(300000, function() {                                 //Ogni 5 minuti
	checkRebornChest();
	checkTeam();
	refreshBosses();
	checkTravels();
	checkCave();
	checkEnchant();
	checkEnchant2();
	checkEnchant3();
});

callNTimes(1800000, function() { 				//Ogni mezz'ora
	checkEvents();
	checkRefill();
	checkTeamAct();
	checkAct();
	checkGnome();
});

function reloadBans(){
	banlist_id = [];
	banlist_tx = [];

	var lineReader = require('readline').createInterface({
		input: require('fs').createReadStream('banlist.txt')
	});

	lineReader.on('line', function (line) {
		var elem = line.split("|");
		if (line != ""){
			banlist_id.push(elem[0]);
			banlist_tx.push(elem[1]);
			//console.log(elem[0]);
		}
	});
	console.log('Banlist caricata');
};

reloadBans();

var mysql      = require('mysql');
var connection = mysql.createConnection({
	host     : 'xxx',
	user     : 'root',
	password : 'xxx',
	database : 'xxx'
});

connection.connect();

checkMissions();
checkSpecialMissions();
checkReborn();
checkDungeonRoom();
refreshBosses();
checkEnchant();
checkEnchant2();
checkEnchant3();

var d = new Date();
if ((d.getDay() != 6) && (d.getDay() != 0)){
	crazyMode = 0;
}else if (crazyMode == 1){
	wait_room = 300;
	wait_dungeon = 2;
}

function checkSpam(message){
	var isOk = true;
	if (timevar[message.from.id] != undefined){
		diff = new Date()/1000 - timevar[message.from.id];
		if (diff < 2){
			console.log("SPAM Utente " + message.from.username + " - " + diff);
			isOk = false;
		}
	}
	timevar[message.from.id] = Math.round(new Date()/1000);

	return isOk;
}

bot.on('message', function (message) {
	//console.log(update.chat);
	var msg = message;
	var text = msg.text;
	var user = msg.from.username;
	var chat_id = msg.chat.id;
	var account_id = msg.from.id;
	console.log(getNow("it") + " - " + user + ": " + text);

	connection.query('SELECT id FROM last_command WHERE account_id = ' + msg.from.id, function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0){
			connection.query('INSERT INTO last_command (account_id, command, time) VALUES (' + msg.from.id + ',"' + mysql_real_escape_string(text) + '","' + getNow("en") + '")', function (err, rows, fields){
				if (err) throw err;
			});
		}else{
			connection.query('UPDATE last_command SET command = "' + mysql_real_escape_string(text) + '", time = "' + getNow("en") + '" WHERE account_id = ' + msg.from.id, function (err, rows, fields){
				if (err) throw err;
			});
		}
	});
	connection.query('SELECT account_id, market_ban FROM player WHERE nickname = "' + user + '"', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0){
			bot.sendMessage(chat_id, "Account non trovato");
		}else{
			if (rows[0].account_id != account_id){
				if (rows[0].market_ban == 0){
					bot.sendMessage("@lnotify", "#Accountid " + user + "-" + account_id + ": " + text);
					connection.query('UPDATE player SET market_ban = 1 WHERE nickname = "' + user + '"', function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(chat_id, "E' stata trovata un'incongruenza id relativa al tuo account, comunica a @fenix45. Intanto sei impossibilitato ad utilizzare il mercato");
					});
				}
			}
		}
	});

	connection.query('SELECT global_msg, global_msg_on FROM config', function(err, rows, fields) {
		if (err) throw err;
		if (rows[0].global_msg_on == 1){
			var msg = rows[0].global_msg;
			connection.query('SELECT 1 FROM global_msg WHERE account_id = ' + account_id, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					connection.query('INSERT INTO global_msg (account_id) VALUES (' + account_id + ')', function(err, rows, fields) {
						if (err) throw err;
					});
					bot.sendMessage(chat_id, msg, html);
				}
			});
		}
	});
});

const answerCallbacks = {};

bot.on("message", function(msg) {
	const callback = answerCallbacks[msg.chat.id];
	if (callback) {
		delete answerCallbacks[msg.chat.id];
		return callback(msg);
	}
});


var mainKeys = [];
mainKeys = [['âš” Nuova Missione âš” '],['ðŸ—¡ Dungeon ðŸ›¡'],['Crea ðŸ“¦','Rifugio ðŸ”¦','Cerca ðŸ”Ž'],['Zaino âš’','Scrigni ðŸ”‘'],['Giocatore ðŸ‘¤ '],['Boss ðŸ— ','Team ðŸ†','Imprese ðŸ‹ï¸ '],['Mercato ðŸ’° ', 'Negozio ðŸ’¸ '],['Viaggio ðŸ—º'],['Albero Talenti ðŸŒ³ ','ArtefattiðŸŒŸ '],['Edificio Abbandonato ðŸš '],['Top ðŸ”','Drago ðŸ‰','Eventi ðŸŽ¯ '],['Informazioni ðŸ“–','Sfide del Destino ðŸŒ'],['Vacanza â›± ','Crediti ðŸ“š ']]

var defaultKeys = [];
defaultKeys = mainKeys.slice();

var resp = {
	reply_markup: JSON.stringify(
		{force_reply: true}
	)
};

var mark = {
	parse_mode: "Markdown"
};

var html = {
	parse_mode: "HTML"
};

var main = {};
var main_html = {};
var mainReborn = {};
var mainReborn2 = {};
var mainReborn2_html = {};
var mainReborn_html = {};

var back = {
	parse_mode: "Markdown",
	disable_web_page_preview: true,
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Torna al menu"]]
	}
};

var back_html = {
	parse_mode: "Html",
	disable_web_page_preview: true,
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Torna al menu"]]
	}
};

var yesno = {
	parse_mode: "Markdown",
	reply_markup: {
		"force_reply": true,
		"resize_keyboard": true,
		"one_time_keyboard": true,
		"keyboard": [["Si"],["Torna al menu"]]
	}
};

var conf = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Conferma"],["Torna al menu"]]
	}
};

var abort_travel = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Ritorna"],["Torna al menu"]]
	}
};

var abort_mission = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Termina subito"],["Torna al menu"]]
	}
};

var team = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Torna al Team"],["Torna al menu"]]
	}
};

var team_html = {
	parse_mode: "HTML",
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Torna al Team"],["Torna al menu"]]
	}
};

var no_preview = {
	parse_mode: "Markdown",
	disable_web_page_preview: true
};

var revive = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Torna in Vita"],["Torna al menu"]]
	}
};

var no_preview_html = {
	parse_mode: "HTML",
	disable_web_page_preview: true
};

var no_preview_back = {
	parse_mode: "Markdown",
	disable_web_page_preview: true,
	reply_markup: {
		resize_keyboard: true,
		one_time_keyboard: true,
		"keyboard": [["Torna al menu"]]
	}
};

bot.onText(/^\/key/, function(message, match) {
	checkKeyboard();
	bot.sendMessage(message.chat.id, "Tastiera aggiornata", mark);
});

bot.onText(/^\/eventon (.+)|^\/eventon|^\/eventoff (.+)|^\/eventoff/, function(message, match) {
	if (message.from.username == "fenix45"){

		var event = "";
		if ((match[1] == undefined) && (match[2] == undefined)){
			bot.sendMessage(message.chat.id, "mana - lotteria - crazy - lucky - arena - festival - special - ricercato - polvere");
			return;
		}
		if (message.text.indexOf("eventon") != -1){
			event = match[1];
		}else if (message.text.indexOf("eventoff") != -1){
			event = match[2];
		}

		var onoff = 1;
		if (message.text.indexOf("eventoff") != -1){
			onoff = 0;
		}

		if (event == "mana"){
			eventMana = onoff;
		}else if (event == "lotteria"){
			xxxteria = onoff;
		}else if (event == "crazy"){
			crazyMode = onoff;
		}else if (event == "lucky"){
			luckyMode = onoff;
		}else if (event == "arena"){
			arena = onoff;
		}else if (event == "festival"){
			eventFestival = onoff;
		}else if (event == "ricercato"){
			wanted = onoff;
		}else if (event == "polvere"){
			polvere = onoff;
		}

		checkKeyboard();
		bot.sendMessage(message.chat.id, "Evento " + event + " impostato a " + onoff);
	}
});

var dMana = new Date();
if ((dMana.getDay() == 4) || (dMana.getDay() == 5)){
	eventMana = 1;
}else{
	eventMana = 0;
}
if ((d.getDay() == 1) || (d.getDay() == 2)){
	eventDust = 1;
	checkKeyboard();
}else{
	eventDust = 0;
	checkKeyboard();
}

checkKeyboard();

function checkKeyboard(){
	mainKeys = defaultKeys.slice();		//Resetta

	var mainKeysR = [];
	mainKeysR = mainKeys.slice();

	var mainKeysR2 = [];
	mainKeysR2 = mainKeys.slice();

	var mainKeysR3 = [];
	mainKeysR3 = mainKeys.slice();

	mainKeysR.splice(0, 0, ['â­ï¸ Rinasci â­ï¸ ']);
	mainKeysR2.splice(0, 0, ['â­ï¸ Cassa Rinascita ðŸŽ']);
	mainKeysR3.splice(0, 0, ['âœ¨ Reincarnazione âš¡ï¸']);

	if (eventMana == 1){
		mainKeys.splice(0, 0, ['â› Miniere di Mana â›° ']);
		mainKeysR.splice(1, 0, ['â› Miniere di Mana â›° ']);
		mainKeysR2.splice(1, 0, ['â› Miniere di Mana â›° ']);
	}
	if (xxxteria == 1){
		mainKeys.splice(0, 0, ['ðŸ’Ž Lootteria (Evento) ðŸ’° ']);
		mainKeysR.splice(1, 0, ['ðŸ’Ž Lootteria (Evento) ðŸ’° ']);	
		mainKeysR2.splice(1, 0, ['ðŸ’Ž Lootteria (Evento) ðŸ’° ']);	
	}
	if (crazyMode == 1){
		mainKeys.splice(0, 0, ['ðŸŽ‰ Weekend della Follia (Evento) ðŸ˜±']);
		mainKeysR.splice(1, 0, ['ðŸŽ‰ Weekend della Follia (Evento) ðŸ˜±']);	
		mainKeysR2.splice(1, 0, ['ðŸŽ‰ Weekend della Follia (Evento) ðŸ˜±']);	
	}
	if (luckyMode == 1){
		mainKeys.splice(0, 0, ['ðŸŒŸ Weekend della Fortuna (Evento) ðŸ€']);
		mainKeysR.splice(1, 0, ['ðŸŒŸ Weekend della Fortuna (Evento) ðŸ€']);	
		mainKeysR2.splice(1, 0, ['ðŸŒŸ Weekend della Fortuna (Evento) ðŸ€']);	
	}
	if (arena == 1){
		mainKeys.splice(0, 0, ['ðŸ² Arena dei Draghi (Evento) ðŸ”¥ ']);
		mainKeysR.splice(1, 0, ['ðŸ² Arena dei Draghi (Evento) ðŸ”¥']);	
		mainKeysR2.splice(1, 0, ['ðŸ² Arena dei Draghi (Evento) ðŸ”¥']);
	}
	if (eventFestival == 1){
		mainKeys.splice(0, 0, ['ðŸŽ‰Crafting Festival (Evento) ðŸ› ']);
		mainKeysR.splice(1, 0, ['ðŸŽ‰Crafting Festival (Evento) ðŸ› ']);
		mainKeysR2.splice(1, 0, ['ðŸŽ‰Crafting Festival (Evento) ðŸ› ']);
	}
	if (specialMission == 1){
		mainKeys.splice(0, 0, ['ðŸ¹Itinerario Propizio (Evento) ðŸŽ¯']);
		mainKeysR.splice(1, 0, ['ðŸ¹Itinerario Propizio (Evento) ðŸŽ¯']);
		mainKeysR2.splice(1, 0, ['ðŸ¹Itinerario Propizio (Evento) ðŸŽ¯']);
	}
	if (wanted == 1){
		mainKeys.splice(0, 0, ['ðŸ’°Il Ricercato (Evento) ðŸ‘º']);
		mainKeysR.splice(1, 0, ['ðŸ’°Il Ricercato (Evento) ðŸ‘º']);
		mainKeysR2.splice(1, 0, ['ðŸ’°Il Ricercato (Evento) ðŸ‘º']);
	}
	if (eventDust == 1){
		mainKeys.splice(0, 0, ['â² Generatore di Polvere ðŸ”¥']);
		mainKeysR.splice(1, 0, ['â² Generatore di Polvere ðŸ”¥']);
		mainKeysR2.splice(1, 0, ['â² Generatore di Polvere ðŸ”¥']);
	}

	main = {
		parse_mode: "Markdown",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeys
		}
	};

	main_html = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeys
		}
	};

	mainReborn = {
		parse_mode: "Markdown",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeysR
		}
	};

	mainReborn_html = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeysR
		}
	};

	mainReborn2 = {
		parse_mode: "Markdown",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeysR2
		}
	};

	mainReborn2_html = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeysR2
		}
	};

	mainReborn3 = {
		parse_mode: "Markdown",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeysR3
		}
	};

	mainReborn3_html = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": mainKeysR3
		}
	};
	//console.log("--- Tastiere ricaricate ---");
};

bot.onText(/^\/ping/, function(message, match) {
	bot.sendMessage(message.chat.id, "_Pong_", mark);
});

//EASTEREGG

bot.onText(/^Sniffa$/i, function(message, match) {
	bot.sendMessage(message.chat.id, "Uh, un ðŸ¼!");
});

bot.onText(/^Edo$/i, function(message, match) {
	bot.sendMessage(message.chat.id, "Boss âš¡ï¸");
});

//EASTEREGG

bot.onText(/^\/cmd (.+)/, function(message, match){
	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){

		if (match[1] == undefined){
			bot.sendMessage(message.chat.id, "Comando non valido");
			return;
		}

		if (match[1] == "backuplist"){
			exec("cd /home/fenix/backup && ls -1 | head -10", function (error, stdout, stderr) {
				bot.sendMessage(message.chat.id, stdout + "\n" + stderr);
			});
		}else if (match[1] == "reboot"){
			bot.sendMessage(message.chat.id, "Sei sicuro?", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text.toLowerCase() == "si"){
						exec("cd /home/fenix/xxxBot && forever restart xxxBot.js", function (error, stdout, stderr) {
							bot.sendMessage(message.chat.id, stdout + "\n" + stderr);
						});
						bot.sendMessage(message.chat.id, "Riavviato!");
					};
				};
			});
		}else if (match[1] == "backup"){
			exec("cd /home/fenix && ./backup.sh", function (error, stdout, stderr) {
				bot.sendMessage(message.chat.id, stdout + "\n" + stderr);
			});			
		}
	}
});

bot.onText(/^\/id (.+)/, function(message, match) {
	if (message.from.username == "fenix45"){
		connection.query('SELECT nickname, account_id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields){
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non ho trovato l'utente");
				return;
			}

			bot.sendMessage(message.chat.id, rows[0].account_id);
		});
	}
});

bot.onText(/^\/gen/, function(message, match) {
	market_generation();
	console.log("OK");
});

bot.onText(/^\/global (.+)/, function(message, match) {
	if (message.from.username == "fenix45"){
		//asd
	}
});

function market_generation(){
	var items = [];
	var rarity = [];

	connection.query('DELETE FROM market_pack', function (err, rows, fields){
		if (err) throw err;

		connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity = "C" ORDER BY RAND() LIMIT 10', function (err, rows, fields){
			if (err) throw err;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				items.push(rows[i].id);
				rarity.push(1);
			}
			connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity = "NC" ORDER BY RAND() LIMIT 5', function (err, rows, fields){
				if (err) throw err;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					items.push(rows[i].id);
					rarity.push(2);
				}
				connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity = "R" ORDER BY RAND() LIMIT 4', function (err, rows, fields){
					if (err) throw err;
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						items.push(rows[i].id);
						rarity.push(3);
					}
					connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity = "UR" ORDER BY RAND() LIMIT 3', function (err, rows, fields){
						if (err) throw err;
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							items.push(rows[i].id);
							rarity.push(4);
						}
						connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity = "L" ORDER BY RAND() LIMIT 2', function (err, rows, fields){
							if (err) throw err;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								items.push(rows[i].id);
								rarity.push(5);
							}
							connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity = "E" ORDER BY RAND() LIMIT 1', function (err, rows, fields){
								if (err) throw err;
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									items.push(rows[i].id);
									rarity.push(6);
								}

								var item = 0;
								var rar = 0;

								for (var i = 0, len = items.length; i < len; i++) {

									item = items[i];
									rar = rarity[i];

									connection.query('SELECT price FROM market_direct_history WHERE time BETWEEN date_sub(NOW(),INTERVAL 2 WEEK) AND NOW() AND price != (SELECT value FROM item WHERE id = ' + item + ') AND item_id = ' + item, function (err, rows, fields){
										if (err) throw err;
										var price = 0;
										var arr = [];
										if (Object.keys(rows).length > 0){
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												arr.push(rows[i].price);
											}
											price = estimate(arr);
											price = getRandomArbitrary(price-(price*0.1), price);
											connection.query('INSERT INTO market_pack (pack_id, item_id, price) VALUES (' + this.rar + ',' + this.item + ',' + price + ')', function (err, rows, fields){
												if (err) throw err;
											});
										}
									}.bind( {item: item, rar: rar} ));
								}
								console.log("Mercato a rotazione aggiornato");

								connection.query('UPDATE player SET market_pack = 0', function (err, rows, fields){
									if (err) throw err;
								});

							});
						});
					});
				});
			});
		});
	});
}

bot.onText(/^\/stima (.+)/, function(message, match) {
	connection.query('SELECT price FROM market_direct_history WHERE time BETWEEN date_sub(NOW(),INTERVAL 2 WEEK) AND NOW() AND price != (SELECT value FROM item WHERE name = "' + match[1] + '") AND item_id = (SELECT id FROM item WHERE name = "' + match[1] + '")', function (err, rows, fields){
		if (err) throw err;
		var arr = [];
		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Nessun prezzo per l'oggetto specificato");
			return;
		}
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			arr.push(rows[i].price);
		}
		bot.sendMessage(message.chat.id, "Stima con " + Object.keys(rows).length + " prezzi: " + estimate(arr));
	});
});

bot.onText(/^\/unban ([^\s]+)/, function(message, match) {
	if (message.from.username == "fenix45"){
		var lineReader = require('readline').createInterface({
			input: require('fs').createReadStream('banlist.txt')
		});

		var account_id = match[1];
		var i = 0;
		var text = "";

		lineReader.on('line', function (line) {
			if (line != ""){
				if (elem[0] != account_id){
					text += line;
				}
			}
		});
		fs.appendFile('banlist2.txt', text, function (err) {
			if (err) throw err;
			bot.sendMessage(message.chat.id, account_id + " sbannato!");
		});
	};
});

bot.onText(/^\/marketban (.+)/, function(message, match) {
	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		connection.query('SELECT id, market_ban, nickname, id, account_id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields){
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non ho trovato nessun utente con quel nickname.");
				return;
			}

			if (rows[0].market_ban == 0){
				connection.query('UPDATE player SET market_ban = 1 WHERE id = ' + rows[0].id, function (err, rows, fields){
					if (err) throw err;
				});

				bot.sendMessage(message.chat.id, rows[0].nickname + " bannato dal mercato.");
			}else{
				connection.query('UPDATE player SET market_ban = 0 WHERE id = ' + rows[0].id, function (err, rows, fields){
					if (err) throw err;
				});

				bot.sendMessage(message.chat.id, rows[0].nickname + " sbannato dal mercato.");
			}
		});
	};
});

bot.onText(/^\/setmsg (.+)/, function(message, match) {
	if (message.from.username == "fenix45"){
		connection.query('UPDATE config SET global_msg = "' + match[1] + '"', function (err, rows, fields){
			if (err) throw err;
			connection.query('SELECT global_msg FROM config', function (err, rows, fields){
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Messaggio impostato, ora /actmsg\n\n" + rows[0].global_msg, html);
			});
		});
	}
});

bot.onText(/^\/actmsg/, function(message, match) {
	if (message.from.username == "fenix45"){
		connection.query('SELECT global_msg_on FROM config', function (err, rows, fields){
			if (err) throw err;
			if (rows[0].global_msg_on == 0){
				connection.query('UPDATE config SET global_msg_on = 1', function (err, rows, fields){
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Messaggio attivato");
				});
			}else{
				connection.query('UPDATE config SET global_msg_on = 0', function (err, rows, fields){
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Messaggio disattivato");
				});
			}
			connection.query('DELETE FROM global_msg', function (err, rows, fields){
				if (err) throw err;
			});
		});
	}
});

bot.onText(/^\/setwarn ([^\s]+) (.+)/, function(message, match) {
	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		connection.query('SELECT nickname, id, account_id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields){
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non ho trovato nessun utente con quel nickname.");
				return;
			}
			connection.query('UPDATE player SET market_warn = ' + match[2] + ' WHERE id = ' + rows[0].id, function (err, rows, fields){
				if (err) throw err;
			});
			bot.sendMessage(message.chat.id, rows[0].nickname + " impostato a " + match[2] + " warn");
		});
	};
});

bot.onText(/^\/ban ([^\s]+) (.+)/, function(message, match) {
	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		connection.query('SELECT nickname, id, account_id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields){
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non ho trovato nessun utente con quel nickname.");
				return;
			}			

			fs.appendFile('banlist.txt', "\r\n" + rows[0].account_id + '|' + match[2], function (err) {
				if (err) throw err;

				reloadBans();

				connection.query('DELETE FROM market_direct WHERE nickname = "' + rows[0].nickname + '"', function (err, rows, fields){
					if (err) throw err;
				});
				connection.query('DELETE FROM market WHERE nickname = "' + rows[0].nickname + '"', function (err, rows, fields){
					if (err) throw err;
				});
				connection.query('DELETE FROM public_shop WHERE player_id = ' + rows[0].id, function (err, rows, fields){
					if (err) throw err;
				});
				connection.query('UPDATE player SET market_ban = 1 WHERE id = ' + rows[0].id, function (err, rows, fields){
					if (err) throw err;
				});
				connection.query('DELETE FROM team_player WHERE player_id = ' + rows[0].id, function (err, rows, fields){
					if (err) throw err;
				});

				bot.sendMessage(message.chat.id, rows[0].nickname + " (" + rows[0].account_id + ") bannato. Banlist aggiornata.");
				bot.sendMessage(rows[0].account_id, "Sei stato bannato dal bot, _Bye_.", mark);
			});
		});
	};
});

bot.onText(/^\/banlist/, function(message, match) {
	if (message.from.username != "fenix45"){
		return;
	}
	reloadBans();
	bot.sendMessage(message.chat.id, "Banlist aggiornata");
});

bot.onText(/^\/save/, function(message, match) {
	if (message.from.username != "fenix45"){
		return;
	}
	saveActive();
	bot.sendMessage(message.chat.id, "Salvata");
});

bot.onText(/^\/festival/, function(message, match) {
	if (message.from.username != "fenix45"){
		return;
	}
	reloadFestival();
	bot.sendMessage(message.chat.id, "Fatto!");	
});

bot.onText(/^\/active/, function(message, match) {
	connection.query('SELECT count, time FROM active_history ORDER BY time DESC', function (err, rows, fields){
		if (err) throw err;

		var text = "";
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			text += rows[i].count + " -> " + rows[i].time + "\n";
		}
		bot.sendMessage(message.chat.id, text);
	});
});

function saveActive(){
	var d = new Date();
	var today = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate());
	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

	connection.query('SELECT COUNT(*) As active FROM `last_command` WHERE time LIKE "' + today + '%"', function(err, rows, fields) {
		if (err) throw err;
		var act = rows[0].active;

		connection.query('INSERT INTO active_history (count, time) VALUES (' + act + ',"' + long_date + '")', function(err, rows, fields) {
			if (err) throw err;
			console.log("AttivitÃ  giocatori salvatata! --> " + act + " <--");
		});
	});
}

bot.onText(/\/start (.+)|\/start/i, function(message, match) {
	if (typeof message.from.username == 'undefined'){
		bot.sendMessage(message.chat.id, "Devi impostare un username su Telegram per poter giocare, puoi farlo tramite le *impostazioni*. Una volta impostato, usa di nuovo il comando /start, oppure /start CODICE nel caso di un link invito.", mark);
		return;
	}
	if (message.from.username == undefined){
		return;
	}
	var invite = match[1];
	console.log("Codice invito: " + invite);

	var code = "Non disponibile";

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			connection.query('UPDATE player SET chat_id = ' + message.chat.id + ' WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Sei giÃ  registrato! Se hai qualche problema, segnala a @fenix45", back);
			});

			return;
		}
		connection.query('SELECT * FROM player WHERE account_id = ' + message.from.id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				bot.sendMessage(message.chat.id, "Questo id Ã¨ giÃ  registrato, se hai cambiato nome utente usa /migrazione. Grazie!", back);
				return;
			}

			var rnd_code = makeid();
			var money = 0;
			connection.query('SELECT COUNT(*) AS num, nickname, id, chat_id FROM player WHERE invite_code = "' + invite + '"', function(err, rows, fields) {
				if (err) throw err;

				var invite = "";

				if (rows[0].num > 0){
					money = 2000;
					bot.sendMessage(rows[0].chat_id, "Un utente si Ã¨ registrato con il tuo link invito, hai ricevuto 1000 Â§ di bonus. Riceverai un premio cospicuo quando il giocatore raggiungerÃ  la prima rinascita");
					setAchievement(rows[0].chat_id, rows[0].id, 41, 1);

					connection.query('UPDATE `player` SET `money`=money+1000 WHERE id=' + rows[0].id + ' LIMIT 1', function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Ti sei registrato con un link invito, hai ricevuto 2000 Â§ di bonus.");
					});

					var d = new Date();
					var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

					invite = " (" + rows[0].nickname + ")";

					connection.query('INSERT INTO referral_list (new_player, player_id, time) VALUES ((SELECT MAX(id) FROM player)+1,' + rows[0].id + ',"' + long_date + '")', function(err, rows, fields) {
						if (err) throw err;
					});
				}
				money += 5000;
				connection.query('INSERT INTO `player`(`id`, account_id, `nickname`, chat_id, money, invite_code) VALUES (DEFAULT,' + message.from.id + ',"' + message.from.username + '",' + message.chat.id + ',' + money + ',"' + rnd_code + '")', function(err, rows, fields) {
					if (err) throw err;

					bot.sendMessage("@lnotify", "#Registrazione: " + message.from.username + invite);

					printStart(message);
				});
			});
		});
	});
});

bot.onText(/\/fixboss/, function(message) {
	fixBoss(message);
	bot.sendMessage(message.chat.id, "Boss sistemati!");
});

function fixBoss(message){
	connection.query('UPDATE boss_team SET life = 100 WHERE killedby = "" AND life < 0',  function(err, rows, fields) {
		if (err) throw err;
	});	
}

function dailyChest(message, player_id) {
	var rand = 0;
	var chest_id = 0;

	rand = Math.round((Math.random()*99)+1);
	if ((rand <= 100) && (rand >= 50)){		//50%
		chest_id = 1;
	}else if ((rand < 50) && (rand >= 20)){		//30%   
		chest_id = 2;
	}else if ((rand < 20) && (rand >= 10)){ 	//10%
		chest_id = 3;
	}else if ((rand < 10) && (rand >= 0)){ 		//10%
		chest_id = 4;
	}else{
		console.log("Errore condizioni, random: " + rand);
	}

	connection.query('SELECT COUNT(*) As num FROM daily_chest WHERE player_id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		if (rows[0].num == 0){
			connection.query('SELECT name, rarity_shortname FROM chest WHERE id = ' + chest_id, function(err, rows, fields) {
				if (err) throw err;
				connection.query('INSERT INTO `inventory_chest`(`player_id`, `chest_id`) VALUES (' + player_id + ',' + chest_id + ')', function(err, rows, fields) {
					if (err) throw err;
				});
				connection.query('INSERT INTO daily_chest(`player_id`, `chest_id`) VALUES (' + player_id + ',' + chest_id + ')', function(err, rows, fields) {
					if (err) throw err;
				});
				bot.sendMessage(message.chat.id, "Iniziando la prima missione della giornata, hai ricevuto lo scrigno giornaliero: *" + rows[0].name + "* (" + rows[0].rarity_shortname + ")!", back);
				setAchievement(message.chat.id, player_id, 39, 1);
			});
		}
	});
};

bot.onText(/Crediti/i, function(message) {
	var text = 	"Crediti Rilevanti\n\n" +
		"@fenix45\nLastSoldier95\n\n" +
		"@FedeDark - @GasterTheSkeleton - @MattiaCris8\n" +
		"@mmmMANUuuu - @rosikcool - @SimoneBigozzi\n" +
		"@alessandromrx - @Lara997 - @IfrinGalanodel\n" +
		"@ekvas - @LordOfKraken - @Shari_8" +

		"\n\nOltre alle tantissime altre persone che hanno collaborato, anche se in piccola parte!";

	bot.sendMessage(message.chat.id, text, back_html);
});

bot.onText(/avvEstraz/, function(message) {
	if ((message.from.username == "fenix45") || (message.from.username == "Lara997")){
		connection.query('SELECT player.nickname, player.chat_id FROM event_lottery_coins, player WHERE event_lottery_coins.player_id = player.id GROUP BY player_id', function(err, rows, fields) {
			if (err) throw err;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				bot.sendMessage(rows[i].chat_id, "*Lootteria*: L'estrazione inizierÃ  a breve!", mark);
			}
			bot.sendMessage(message.chat.id, "Notifica inviata a " + Object.keys(rows).length + " utenti");
		});
	};
});

bot.onText(/fineEstraz/, function(message) {
	if ((message.from.username == "fenix45") || (message.from.username == "Lara997")){
		var prize = "";
		connection.query('SELECT item.name FROM event_lottery_prize, item WHERE event_lottery_prize.item_id = item.id', function(err, rows, fields) {
			if (err) throw err;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				prize += "> " + rows[i].name + "\n";
			}

			var kb = {
				parse_mode: "Markdown",
				disable_web_page_preview: true,
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Scrigno di Consolazione"],["Torna al menu"]]
				}
			};

			connection.query('SELECT player.nickname, player.id, player.chat_id FROM event_lottery_coins, player WHERE event_lottery_coins.player_id = player.id GROUP BY player_id', function(err, rows, fields) {
				if (err) throw err;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					bot.sendMessage(rows[i].chat_id, "*Lootteria*: L'estrazione Ã¨ terminata! Usa il pulsante sotto per ricevere uno scrigno di consolazione!\n(Puoi anche scrivere Scrigno di Consolazione a mano)", kb);
				}
				bot.sendMessage(message.chat.id, "Notifica inviata a " + Object.keys(rows).length + " utenti");
			});
		});
	};
});

bot.onText(/Scrigno di Consolazione/i, function(message) {
	connection.query('SELECT id, holiday FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		connection.query('SELECT extracted FROM `event_lottery_prize` ORDER BY id DESC', function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].extracted == 0){
				bot.sendMessage(message.chat.id, "L'estrazione Ã¨ in corso!", back)
				return;
			}

			connection.query('SELECT id FROM event_lottery_coins WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Non hai partecipato alla lotteria oppure hai vinto qualcosa durante l'estrazione.",back);
					return;
				}

				var date = new Date();
				var chest_id = 0;
				var chestName = "";
				switch(date.getDay()){
					case 6:
						chestName = "Scrigno di Diamante";
						chest_id = 4;
						break;
					case 0: 
						chestName = "Scrigno Leggendario";
						chest_id = 5;
						break;
									}

				bot.sendMessage(message.chat.id, "Riscattare lo Scrigno?", yesno).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text.toLowerCase() == "si"){
							connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + player_id + ',' + chest_id + ')', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai ricevuto *" + chestName + "* come premio di consolazione!", back);

								connection.query('DELETE FROM event_lottery_coins WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									console.log(player_id + " consolazione riscattata");
								});
							});
						};
					};
				});
			});
		});
	});
});

function estrazione(){
	connection.query(	'SELECT E.id, item_id, I.name As item_name, money, chest_id, exp, C.name As chest_name, gems, token, mana, extracted, quantity ' +
					 'FROM event_lottery_prize As E LEFT JOIN item As I ON E.item_id = I.id LEFT JOIN chest As C ON E.chest_id = C.id ' +
					 'WHERE E.extracted = 0', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			console.log("Non ci sono piÃ¹ premi");
			autoEstrazione = 0;
			connection.query('SELECT chat_id FROM player, event_lottery_coins WHERE event_lottery_coins.player_id = player.id GROUP BY event_lottery_coins.player_id', function(err, rows, fields) {
				if (err) throw err;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					bot.sendMessage(rows[i].chat_id, "Estrazioni Lootteria terminate!", html);
				}
			});
			return;
		}

		var ext_id = rows[0].id;

		var name = "";
		var type = "";
		var item_id = 0;
		var chest_id = 0;
		var money = 0;
		var token = 0;
		var exp = 0;
		var mana = 0;
		var quantity = 1;

		if ((rows[0].item_id != 0) && (rows[0].item_id != null)){
			type = "item";
			name = rows[0].item_name;
			item_id = rows[0].item_id;
			quantity = rows[0].quantity;
		}else if (rows[0].money != 0){
			type = "money";
			name = rows[0].money + " Â§";
			money = rows[0].money;
		}else if ((rows[0].chest_id != 0) && (rows[0].item_id != null)){
			type = "chest";
			name = rows[0].chest_name;
			chest_id = rows[0].chest_id;
			quantity = rows[0].quantity;
		}else if (rows[0].gems != 0){
			type = "gems";
			name = rows[0].gems + " ðŸ’Ž";
		}else if (rows[0].token != 0){
			type = "token";
			name = rows[0].token + " ðŸŒ";
			token = rows[0].token;
		}else if (rows[0].exp != 0){
			type = "exp";
			name = rows[0].exp + " exp";
			exp = rows[0].exp;
		}else if (rows[0].mana != 0){
			type = "mana";
			name = rows[0].mana + " Mana tutti i tipi";
			mana = rows[0].mana;
		}else{
			console.log("Errore estrazione");
			return;
		}

		connection.query('SELECT COUNT(*) As num FROM event_lottery_coins', function(err, rows, fields) {
			if (err) throw err;

			var num = parseInt(rows[0].num)-1;
			var rand = Math.round(Math.random()*num);

			//COMMENTI per test
			//connection.query('SELECT player_id, nickname FROM event_lottery_coins, player WHERE player.id = event_lottery_coins.player_id ORDER BY RAND() LIMIT ' + rand + ',' + (rand+quantity), function(err, rows, fields) {
			connection.query('SELECT player_id, nickname FROM event_lottery_coins, player WHERE player.id = event_lottery_coins.player_id AND player_id != 1 AND player_id != 3 ORDER BY RAND() LIMIT ' + rand + ',' + quantity, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0){
					console.log("Errore estrazione vincitore " + rand + "-" + quantity);
					return;
				}

				if (Object.keys(rows).length > 10){
					console.log("QuantitÃ  elevata " + Object.keys(rows).length + " - " + rand + " - " + quantity);
					return;
				}

				connection.query('UPDATE event_lottery_prize SET extracted = 1 WHERE extracted = 0 AND id = ' + ext_id, function(err, rows, fields) {
					if (err) throw err;
				});

				var text = "<i>Lootteria</i> - Estrazione per <b>" + name + "</b>!\n\n";

				var playerId = 0;
				var nickname = "";
				var nick_extracted = [];

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					playerId = rows[i].player_id;
					nickname = rows[i].nickname;
					nick_extracted.push(playerId);
					console.log("Estratto " + nickname);

					if (quantity > 1){
						text += "> " + nickname + "\n";
					}else{
						text += "Il vincitore Ã¨ <b>" + nickname + "</b>\n";
					}

					if (type == "item"){
						connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + playerId + ',' + item_id + ')', function(err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "chest"){
						connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + playerId + ',' + chest_id + ')', function(err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "money"){
						connection.query('UPDATE player SET money = money + ' + money + ' WHERE id = ' + playerId, function(err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "gems"){
						connection.query('UPDATE player SET gems = gems+' + gems + ' WHERE id = ' + playerId, function(err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "token"){
						connection.query('UPDATE player SET token = token + ' + token + ' WHERE id = ' + playerId, function(err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "exp"){
						connection.query('UPDATE player SET exp = exp + ' + exp + ' WHERE id = ' + playerId, function(err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "mana"){
						connection.query('UPDATE event_mana_status SET mana_1 = mana_1 + ' + mana + ', mana_2 = mana_2 + ' + mana + ', mana_3 = mana_3 + ' + mana + ' WHERE player_id = ' + playerId, function(err, rows, fields) {
							if (err) throw err;
						});
					}
				};

				connection.query('SELECT MAX(id) As tot FROM event_lottery_prize', function(err, rows, fields) {
					if (err) throw err;

					var tot = rows[0].tot;
					connection.query('SELECT chat_id FROM player, event_lottery_coins WHERE event_lottery_coins.player_id = player.id GROUP BY event_lottery_coins.player_id', function(err, rows, fields) {
						if (err) throw err;

						text += "\n" + ext_id + " / " + tot;	
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bot.sendMessage(rows[i].chat_id, text, html);
						}
						console.log("Estrazione " + ext_id + " terminata");

						for (var i = 0, len = Object.keys(nick_extracted).length; i < len; i++) {
							playerId = nick_extracted[i];
							connection.query('DELETE FROM event_lottery_coins WHERE player_id = ' + playerId, function(err, rows, fields) {
								if (err) throw err;
							});
						}
					});
				});
			});
		});
	});
}

bot.onText(/estrazione/, function(message) {
	if (message.from.username == "fenix45"){
		if (autoEstrazione == 0){
			autoEstrazione = 1;
		}else{
			autoEstrazione = 0;
		}
		bot.sendMessage(message.chat.id, "Autoestrazione impostato a " + autoEstrazione);
		//estrazione();
	};
});

bot.onText(/spboss (.+)/, function(message, match) {
	var team_id = match[1];

	if ((team_id == "undefined") || (team_id == undefined)){
		bot.sendMessage(message.chat.id, "Boh!", back);
	}

	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		spawnTeamBoss(team_id);
		bot.sendMessage(message.chat.id, "Fatto :3", back);
	}else{
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.", back);
	}
});

bot.onText(/\/getid (.+)/, function(message, match) {
	connection.query('SELECT * FROM player WHERE nickname = "' + match[1] + '"', function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(message.chat.id, rows[0].id);
	});
});

bot.onText(/\/lacrima (.+)/, function(message, match) {

	if (match[1] == undefined){
		bot.sendMessage(message.chat.id, "/lacrima nickname");
		return;
	}

	var nick = match[1];
	console.log(nick);

	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		connection.query('SELECT * FROM player WHERE nickname = "' + nick + '"', function(err, rows, fields) {
			if (err) throw err;
			var player_id = rows[0].id;
			lacrima(player_id, rows[0].chat_id);
			bot.sendMessage(message.chat.id, "Lacrima inviata a " + nick + "!");
		});
	}else{
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

function lacrima(player_id, chat_id){
	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',641)', function(err, rows, fields) {
		if (err) throw err;
	});
	connection.query('INSERT INTO tear (player_id, type) VALUES (' + player_id + ',1)', function(err, rows, fields) {
		if (err) throw err;
	});
	bot.sendMessage(chat_id, "Hai raggiunto il livello 300!\nPer questo hai ottenuto una *Lacrima dell'Immortale* come ricompensa!\nOra crea l'oggetto finale che preferisci e ottieni 2 artefatti per continuare alla rinascita!", mark);
}

function lacrima2(player_id, chat_id){
	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',674)', function(err, rows, fields) {
		if (err) throw err;
	});
	connection.query('INSERT INTO tear (player_id, type) VALUES (' + player_id + ',2)', function(err, rows, fields) {
		if (err) throw err;
	});
	bot.sendMessage(chat_id, "Hai raggiunto il livello 500!\nPer questo hai ottenuto una *Lacrima del Rinnegato* come ricompensa!", mark);
}

bot.onText(/\/dona (.+)/, function(message, match) {
	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		if (match[1] == undefined){
			bot.sendMessage(message.chat.id, "/dona nickname quantitÃ ");
			return;
		}

		var split = match[1].split(" ");

		var nick = split[0];
		var qnt = split[1];

		connection.query('SELECT * FROM player WHERE nickname = "' + nick + '"', function(err, rows, fields) {
			if (err) throw err;
			var player_id = rows[0].id;
			connection.query('UPDATE player SET token = token + ' + qnt + ' WHERE id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});
			bot.sendMessage(rows[0].chat_id, "Hai ricevuto *" + qnt + " Gettoni* dall'amministratore per la tua donazione!", mark);
			bot.sendMessage(message.chat.id, "Consegnati!");
		});
	}else{
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/m (.+)/, function(message, match) {
	if (match[1] == undefined){
		bot.sendMessage(message.chat.id, "/m nickname testo");
		return;
	}

	var split = match[1].split(/ (.+)/);

	var nick = split[0];
	var msg = split[1];

	if (re3.test(msg) == false){
		bot.sendMessage(message.chat.id, "Puoi usare solo '?' ',' o '.'");
		return;
	}

	nick = nick.replace("@","");

	connection.query('SELECT account_id, id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO direct_message (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Sei stato aggiunto al registro messaggi, usa /ricezione per bloccare i messaggi in entrata o riattivarli");
				});
			}

			connection.query('SELECT id, chat_id, account_id FROM player WHERE nickname = "' + nick + '"', function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Il giocatore non esiste!");
					return;
				}

				var account_id = (rows[0].account_id).toString();
				if (banlist_id.indexOf(account_id) != -1){
					bot.sendMessage(message.chat.id, "Il giocatore Ã¨ bannato");
					return;
				}

				var player_id2 = rows[0].id;
				var chat_id2 = rows[0].chat_id;

				connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = ' + player_id2, function(err, rows, fields) {
					if (err) throw err;
					var allow = 1;
					if (Object.keys(rows).length == 0){
						connection.query('INSERT INTO direct_message (player_id, to_id) VALUES (' + player_id2 + ', ' + player_id + ')', function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(chat_id2, "Sei stato aggiunto al registro messaggi, usa /ricezione per bloccare i messaggi in entrata o riattivarli, '/r testo' per rispondere all'ultima discussione");
						});
					}else{
						allow = rows[0].allow;
					}

					if (allow == 0){
						bot.sendMessage(message.chat.id, "Il giocatore ha bloccato la ricezione messaggi");
						return;
					}

					connection.query('UPDATE direct_message SET reply_text = "' + msg.slice(0, 30) + "..." + '", to_id = ' + player_id + ' WHERE player_id = ' + player_id2, function(err, rows, fields) {
						if (err) throw err;
					});

					bot.sendMessage(chat_id2, "<b>Messaggio da @" + message.from.username + ":</b>\n" + msg, html);
					bot.sendMessage(message.chat.id, "Inviato!");
				});
			});
		});
	});
});

bot.onText(/\/r (.+)/, function(message, match) {
	if (match[1] == undefined){
		bot.sendMessage(message.chat.id, "/r testo");
		return;
	}

	var msg = match[1];

	if (re3.test(msg) == false){
		bot.sendMessage(message.chat.id, "Puoi usare solo '?' ',' o '.'");
		return;
	}

	connection.query('SELECT account_id, id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT id, player_id, allow, to_id, reply_text FROM direct_message WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Inizia prima una conversazione");
				return;
			}

			if (rows[0].to_id == 0){
				bot.sendMessage(message.chat.id, "Nessun messaggio a cui rispondere");
				return;
			}

			var reply_text = rows[0].reply_text;

			connection.query('SELECT id, chat_id, account_id FROM player WHERE id = ' + rows[0].to_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Il giocatore non esiste!");
					return;
				}

				var account_id = (rows[0].account_id).toString();
				if (banlist_id.indexOf(account_id) != -1){
					bot.sendMessage(message.chat.id, "Il giocatore Ã¨ bannato");
					return;
				}

				var player_id2 = rows[0].id;
				var chat_id2 = rows[0].chat_id;

				connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = ' + player_id2, function(err, rows, fields) {
					if (err) throw err;
					var allow = 1;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Il giocatore non Ã¨ registrato, invia prima un messaggio");
						return;
					}else{
						allow = rows[0].allow;
					}

					if (allow == 0){
						bot.sendMessage(message.chat.id, "Il giocatore ha bloccato la ricezione messaggi");
						return;
					}

					connection.query('UPDATE direct_message SET reply_text = "' + msg.slice(0, 30) + "..." + '", to_id = ' + player_id + ' WHERE player_id = ' + player_id2, function(err, rows, fields) {
						if (err) throw err;
					});

					bot.sendMessage(chat_id2, "<b>Risposta da @" + message.from.username + ":</b>\n<i>" + reply_text + "</i>\n" + msg, html);
					bot.sendMessage(message.chat.id, "Inviato!");					
				});
			});			
		});
	});	
});

bot.onText(/\/ricezione/, function(message, match) {
	connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Registrati prima inviando un messaggio");
			return;
		}

		var allow = rows[0].allow;
		var player_id = rows[0].player_id;

		if (allow == 1){
			allow = 0;
			bot.sendMessage(message.chat.id, "Ricezione messaggi disattivata");
		}else if (allow == 0){
			allow = 1;
			bot.sendMessage(message.chat.id, "Ricezione messaggi attivata");
		}
		connection.query('UPDATE direct_message SET allow = ' + allow + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});
	});
});

bot.onText(/\/dai_scrigni (.+)/, function(message, match) {
	if (match[1] == undefined){
		bot.sendMessage(message.chat.id, "/dai_scrigni nickname id_scrigno quantitÃ ");
		return;
	}

	var split = match[1].split(" ");

	var nick = split[0];
	var chest_id = split[1];
	var qnt = split[2];

	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		connection.query('SELECT * FROM player WHERE nickname = "' + nick + '"', function(err, rows, fields) {
			if (err) throw err;			
			var chat_id = rows[0].chat_id;
			var player_id = rows[0].id;
			connection.query('SELECT name FROM chest WHERE id = ' + chest_id, function(err, rows, fields) {
				if (err) throw err;
				var chest_name = rows[0].name;
				for (var i = 0; i < qnt; i++) {
					connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + player_id + ',' + chest_id + ')', function(err, rows, fields) {
						if (err) throw err;
					});
				}
				bot.sendMessage(chat_id, "Hai ricevuto " + qnt + "x *" + chest_name + "* dal Mercante Leggendario!", mark);
				bot.sendMessage(message.chat.id, "Consegnato!");
			});
		});
	}else{
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/dai_oggetto (.+)/, function(message, match) {
	var split = match[1].split(" ");

	var nick = split[0];
	var item_id = split[1];
	var qnt = split[2];

	if ((message.from.username == "fenix45") || (message.from.username == "LastSoldier95")){
		connection.query('SELECT * FROM player WHERE nickname = "' + nick + '"', function(err, rows, fields) {
			if (err) throw err;			
			var chat_id = rows[0].chat_id;
			var player_id = rows[0].id;
			connection.query('SELECT name FROM item WHERE id = ' + item_id, function(err, rows, fields) {
				if (err) throw err;
				var item_name = rows[0].name;
				for (var i = 0; i < qnt; i++) {
					connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + item_id + ')', function(err, rows, fields) {
						if (err) throw err;
					});
				}
				bot.sendMessage(chat_id, "Hai ricevuto " + qnt + "x *" + item_name + "* dal Mercante Leggendario!", mark);
				bot.sendMessage(message.chat.id, "Consegnato!");
			});
		});
	}else{
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/invitati/i, function(message) {
	connection.query('SELECT player.nickname, player.exp, player.reborn FROM referral_list, player WHERE new_player = player.id AND player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Nessun utente si Ã¨ registrato con il tuo link");
			return;
		}

		var text = Object.keys(rows).length + " giocatori si sono registrati con il tuo link invito:\n";
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			text += "> @" + rows[i].nickname + " Livello: " + Math.floor(rows[i].exp/10) + " Rinascita: " + (rows[i].reborn-1) + "\n";
		}
		bot.sendMessage(message.chat.id, text);
	});
});



bot.onText(/\/messaggio (.+)|\/messaggio/, function(message, match) {
	if ((match[1] == undefined) || (match[1] == "")){
		bot.sendMessage(message.chat.id, "Specifica il messaggio da inviare al tuo team, il messaggio viene tagliato se vai a capo. Sintassi: /messaggio testo", back);
		return;
	}

	var msg = match[1];

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT player_id FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') AND role = 1', function(err, rows, fields) {
			if (err) throw err;

			var adminId = rows[0].player_id;

			connection.query('SELECT player_id, chat_id FROM `team_player`, player WHERE team_player.player_id = player.id AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY team_player.id', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Non sei in un team", back);
					return;
				}

				if (adminId != player_id){
					bot.sendMessage(message.chat.id, "Non sei amministratore del team", back);
					return;
				}

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].chat_id != message.chat.id){
						bot.sendMessage(rows[i].chat_id, "Messaggio dall'Amministratore Team\n" + msg);
					}
				}
				bot.sendMessage(message.chat.id, "Messaggio inviato a " + (Object.keys(rows).length-1) + " giocatori del team");
			});
		});
	});
});

bot.onText(/\/migrazione/, function(message, match) {
	if (message.from.username == undefined){
		bot.sendMessage(message.chat.id, "Imposta il nickname prima di migrare", back);
		return;
	}
	bot.sendMessage(message.chat.id, "Il tuo account verrÃ  aggiornato al tuo attuale username, verrÃ  inviata una notifica all'amministratore. Continuare?", yesno).then(function() {
		answerCallbacks[message.chat.id] = function(answer) {
			if (answer.text.toLowerCase() == "si"){
				connection.query('SELECT id, nickname, account_id FROM player WHERE account_id = ' + message.from.id, function(err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Non ho trovato il tuo account, segnala a @fenix45", back);
						return;
					}

					var account_id = (rows[0].account_id).toString();
					if (banlist_id.indexOf(account_id) != -1){
						var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
						bot.sendMessage(message.chat.id, text, mark);
						return;
					}

					var id = rows[0].id;
					var nickname = rows[0].nickname;

					connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"',  function(err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length > 0){
							bot.sendMessage(message.chat.id, "Non puoi migrare su un utente giÃ  registrato, contatta @fenix45", back);
							bot.sendMessage("@lnotify", "#MigrazioneNegata: " + message.from.username);
							return;
						}

						connection.query('UPDATE player SET nickname = "' + message.from.username + '" WHERE id = ' + id, function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Migrazione completata!", back);

							bot.sendMessage("@lnotify", "#Migrazione: " + nickname + " -> " + message.from.username);
						});
					});
				});
			};
		};
	});
});

bot.onText(/\/segnala (.+)|\/segnala/, function(message, match) {
	if ((match[1] == undefined) || (match[1] == "")){
		bot.sendMessage(message.chat.id, "*Comando da usare responsabilmente*\nPer segnalare un utente usa la seguente sintassi /segnala testo", back);
		return;
	}

	connection.query('INSERT INTO warn (author, text, time) VALUES ("' + message.from.username + '","' + match[1] + '","' + getNow("en") + '")', function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(message.chat.id, "Segnalazione completata! Grazie.", back);
	});
});

bot.onText(/\/riscatta (.+)/, function(message, match) {
	var code = match[1];

	connection.query('SELECT * FROM code_list WHERE code = "' + code + '"', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Questo codice non Ã¨ valido", back);
			return;
		}
		if (rows[0].used != ""){
			bot.sendMessage(message.chat.id, "Questo codice Ã¨ giÃ  stato utilizzato", back);
			return;
		}
		var nick = rows[0].nickname;
		if ((nick != message.from.username) && (nick != "")){
			bot.sendMessage(message.chat.id, "Non puoi riscattare questo codice privato", back);
			return;
		}
		var chest_id = parseInt(rows[0].chest_id);
		if (chest_id != 0){
			connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES ((SELECT id FROM player WHERE nickname = "' + message.from.username + '"),' + chest_id + ')', function(err, rows, fields) {
				if (err) throw err;
				connection.query('SELECT name FROM chest WHERE id = ' + chest_id, function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai ottenuto *" + rows[0].name + "*!", back);
				});
			});
		}
		var item_id = parseInt(rows[0].item_id);
		if (item_id != 0){
			connection.query('INSERT INTO inventory (player_id, item_id) VALUES ((SELECT id FROM player WHERE nickname = "' + message.from.username + '"),' + item_id + ')', function(err, rows, fields) {
				if (err) throw err;
				connection.query('SELECT name FROM item WHERE id = ' + item_id, function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai ottenuto *" + rows[0].name + "*!", back);
				});
			});			
		}
		var money = parseInt(rows[0].money);
		if (money != 0){
			connection.query('UPDATE player SET money = money + ' + money + ' WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Hai ottenuto *" + money + "* Â§!", back);
			});			
		}
		var gems = parseInt(rows[0].gems);
		if (gems != 0){
			connection.query('UPDATE player SET gems = gems + ' + gems + ' WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Hai ottenuto *" + gems + "* ðŸ’Ž !", back);
			});			
		}
		connection.query('UPDATE code_list SET used = "' + message.from.username + '" WHERE code = "' + code + '"', function(err, rows, fields) {
			if (err) throw err;
			console.log("Codice: " + code + " utilizzato");
		});		
	});
});

bot.onText(/craftweek/i, function(message) {
	if (message.from.username == "fenix45"){
		bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text.toLowerCase() == "si"){
					craftWeek();
					bot.sendMessage(message.chat.id, "Fatto!", back);
				}
			}
		});
	}
});

function craftWeek(){
	connection.query('UPDATE player SET craft_week = 0', function(err, rows, fields) {
		if (err) throw err;
	});
}

bot.onText(/resetach/i, function(message) {
	if (message.from.username == "fenix45"){
		bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text.toLowerCase() == "si"){
					reloadAchievement();
					bot.sendMessage(message.chat.id, "Fatto!", back);
				};
			};
		});
	}
});

function resetAchievement(){
	connection.query('DELETE FROM achievement_daily', function(err, rows, fields) {
		if (err) throw err;
	});
	connection.query('DELETE FROM achievement_status', function(err, rows, fields) {
		if (err) throw err;
	});
	console.log("Imprese azzerate");
};

function reloadAchievement(){
	connection.query('SELECT id, name, item_rarity, type FROM (SELECT * FROM achievement_list ORDER BY RAND()) as t WHERE id NOT IN (SELECT achievement_id FROM achievement_daily) GROUP BY type ORDER BY RAND() LIMIT 3', function(err, rows, fields) {
		//connection.query('SELECT id, name, item_rarity, type FROM (SELECT * FROM achievement_list ORDER BY RAND()) as t GROUP BY type ORDER BY RAND() LIMIT 3', function(err, rows, fields) {
		if (err) throw err;

		connection.query('DELETE FROM achievement_daily', function(err, rows, fields) {
			if (err) throw err;
		});
		connection.query('DELETE FROM achievement_status', function(err, rows, fields) {
			if (err) throw err;
		});

		var rarity = 0;
		var id = 0;
		var type = 0;

		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			rarity = rows[i].item_rarity;
			id = rows[i].id;
			type = rows[i].type;

			console.log("> " + rows[i].name);

			if ((rarity != 0) && (type == 12)){
				connection.query('SELECT item.id FROM item, rarity WHERE rarity.shortname = item.rarity AND rarity.id = ' + rarity + ' AND craftable = 1 ORDER BY RAND()', function(err, rows, fields) {
					if (err) throw err;
					connection.query('INSERT INTO achievement_daily (id, achievement_id, item_id) VALUES (' + (this.i+1) + ',' + this.id + ',' + rows[0].id + ')', function(err, rows, fields) {
						if (err) throw err;
					});
				}.bind( {i: i, id: id} ));
			}else{
				connection.query('INSERT INTO achievement_daily (id, achievement_id, item_id) VALUES (' + (i+1) + ',' + id + ',' + rarity + ')', function(err, rows, fields) {
					if (err) throw err;
				});
			}
		}
		console.log("Imprese ricaricate");
	});
};

bot.onText(/automana/i, function(message) {
	if (message.from.username == "fenix45"){
		bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text.toLowerCase() == "si"){
					autoMana();
					bot.sendMessage(message.chat.id, "Fatto!", back);
				};
			};
		});
	}
});

function autoMana(){
	connection.query('SELECT mana.name, class, reborn, chat_id, nickname, player_id, rate, type, ROUND(TIMESTAMPDIFF(MINUTE,time_start,NOW())/60*rate,0) As quantity FROM event_mana_status, event_mana_zone, player, mana WHERE mana.id = event_mana_zone.type AND player.id = player_id AND event_mana_status.time_start IS NOT NULL AND event_mana_status.zone_id = event_mana_zone.id', function (err, rows, fields) {
		if (err) throw err;

		var mana_type = "";
		var text = "";
		if (Object.keys(rows).length > 0){
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				mana_type = 'mana_' + rows[i].type;
				if ((rows[i].class == 2) && (rows[i].reborn > 1)){
					rows[i].quantity += rows[i].quantity*0.3;
				}
				if ((rows[i].class == 3) && (rows[i].type == 2) && (rows[i].reborn > 1)){
					rows[i].quantity += rows[i].quantity*0.5;
				}
				if ((rows[i].class == 3) && (rows[i].type != 2) && (rows[i].reborn > 1)){
					rows[i].quantity -= rows[i].quantity*0.2;
				}
				if ((rows[i].class == 4) && (rows[i].type == 3) && (rows[i].reborn > 1)){
					rows[i].quantity += rows[i].quantity*0.5;
				}
				if ((rows[i].class == 4) && (rows[i].type != 3) && (rows[i].reborn > 1)){
					rows[i].quantity -= rows[i].quantity*0.2;
				}
				if ((rows[i].class == 5) && (rows[i].type == 1) && (rows[i].reborn > 1)){
					rows[i].quantity += rows[i].quantity*1;
				}
				if ((rows[i].class == 5) && (rows[i].type != 1) && (rows[i].reborn > 1)){
					rows[i].quantity -= rows[i].quantity*0.1;
				}
				if ((rows[i].class == 6) && (rows[i].reborn > 1)){
					rows[i].quantity -= rows[i].quantity*0.1;
				}
				rows[i].quantity = Math.floor(rows[i].quantity);

				connection.query('UPDATE event_mana_status SET ' + mana_type + ' = ' + mana_type + ' + ' + rows[i].quantity + ', zone_id = 0, time_start = NULL WHERE player_id = ' + rows[i].player_id, function (err, rows, fields){
					if (err) throw err;
				});
				bot.sendMessage(rows[i].chat_id, "Le miniere sono state chiuse, hai ricevuto " + rows[i].quantity + " Mana " + rows[i].name + "!");
				text += "\n" + rows[i].quantity + " Mana " + rows[i].name + " per " + rows[i].nickname + "(" + rows[i].player_id + ")";
			}
			console.log(text);
		}else{
			console.log("Nessuna miniera da terminare");
		}
	});	
};

function autoDust(){
	connection.query('SELECT chat_id, nickname, player_id, extracting FROM event_dust_status, player WHERE player.id = player_id AND extracting = 1', function (err, rows, fields) {
		if (err) throw err;

		var text = "";
		if (Object.keys(rows).length > 0){
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				connection.query('UPDATE event_dust_status SET extracting = 0, last_update = NULL WHERE player_id = ' + rows[i].player_id, function (err, rows, fields){
					if (err) throw err;
				});
				bot.sendMessage(rows[i].chat_id, "I Generatori di Polvere sono stati spenti!");
			}
		}else{
			console.log("Nessuna polvere da terminare");
		}
	});	
};

function makeid() {
	var text = "";
	var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

	for( var i=0; i < 10; i++ )
		text += possible.charAt(Math.floor(Math.random() * possible.length));

	return text;
}

function printStart(message){
	connection.query('SELECT invite_code FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var code = rows[0].invite_code;
		bot.sendMessage(message.chat.id, 	'âš¡ï¸ Benvenuto nel *xxx*!âš¡ï¸ \n\n'+
						'Benvenuto nel bot piÃ¹ divertente di Telegram! Intraprendi missioni, crea i migliori oggetti per scalare la classifica!\n\n'+
						'Il tuo nickname Ã¨: <b>' + message.from.username + '</b>.\n' +
						'Se modifichi il nickname perderai i dati di gioco! Usa il comando /migrazione per modificarlo automaticamente.\n\n' +
						'Il gioco si basa sul drop e creazione oggetti, per guadagnare un oggetto devi andare in missione âš”, sconfiggere boss e ispezionare.\n' +
						'Puoi affrontare i Dungeon per ottenere scrigni e oggetti e formare team per giocare in compagnia.\n' +
						'Una volta completata una missione ricevi uno <b>scrigno</b> di diversa raritÃ , una volta aperto otterrai un oggetto utilizzabile nelle creazioni.\n'+
						'Importante: visualizza le FAQ nel bot di supporto @xxxplusbot (scrivendo /faq)\n\n'+
						'<b>Regolamento</b>\n'+
						'- E\' <b>vietato</b> lo sfruttamento di bug, account-schiavi, account-zaini, account secondari e tutto ciÃ² che fornisce vantaggi al giocatore generati esternamente al proprio account, pena il ban di tutti i coinvolti.\n'+
						'- Si prega di non utilizzare nomi osceni o di carattere spiacevole nel drago o nel team.\n'+
						'- E\' vietato compiere frodi nel mercato e in tutte le modalitÃ  di trattazione oggetti, pena l\'esclusione da esso.\n'+
						'- L\'amministratore puÃ² bannare a sua discrezione se nota comportamenti scorretti, <b>anche senza specificare la motivazione</b>.\n\n'+
						'<b>Link Utili</b>\n'+
						'<a href="https://storebot.me/bot/xxxgamebot">Vota il bot</a>\n'+
						'<a href="https://telegram.me/joinchat/AThc-z_EfojvcE8mbGw1Cw">Gruppo Pubblico</a> - <a href="https://telegram.me/joinchat/EXFobEDH8FbDpQ4MTmw-mQ">Gruppo Scuola</a>\n'+
						'<a href="http://fenixweb.net/">Dona per aiutarmi a mantenere il server, riceverai dei gettoni!</a>\n'+
						'\n'+
						'<b>Crediti Principali</b>\n'+
						'Edoardo Cortese @fenix45\n'+
						'Emanuele Finiguerra @LastSoldier95\n\n'+
						'<b>Versione</b> 1.4', no_preview_html);

		mainMenu(message);
	});
}

bot.onText(/informazioni/i, function(message) {
	printStart(message);
});

function mainMenu(message){
	calcLife(message);
	var market = 0;

	var price_drop = 0;
	var price_drop_msg = "";
	var n = new Date().getDay()
	var n2 = new Date().getDate();

	if ((n == 0) && (crazyMode == 0)){
		if (n2 < 10){
			sconto = 20;
		}
		price_drop = 1;
		price_drop_msg = "\nðŸ’¸ Oggi sconti del <b>" + sconto + "%</b> al negozio ed al mercato!";
	}else if (n == 2){
		price_drop_msg = "\nðŸ€ Oggi giornata <b>fortunata</b>!";		
	}else{
		var links = [	"<a href='http://telegram.me/storebot?start=xxxgamebot'>Vota</a> il bot!",
					 "Entra nella <a href='https://telegram.me/joinchat/AThc-z_EfojvcE8mbGw1Cw'>Taverna</a>!",
					 "Commercia nel <a href='https://telegram.me/joinchat/AThc-z90Erh4M2O8Mk5QLw'>Mercato</a>!",
					 "Iscriviti a @xxxAvvisi per seguire le novitÃ !",
					 "<a href='https://paypal.me/fenixtm'>Dona</a> e riceverai alcuni gettoni per tentare la fortuna!",
					 "Aggiungi @xxxplusbot al tuo gruppo!",
					 ((n != 6) && (n != 0) ? "Ricordati di completare le Imprese Giornaliere!" : "In settimana completa le Imprese Giornaliere!")];
		var rand = Math.round(Math.random()*(Object.keys(links).length-1));
		price_drop_msg = "\n " + links[rand];
	}

	if (message.from.username == undefined){
		bot.sendMessage("@lnotify", "#undefined " + "-" + account_id);
		return;
	}

	var time = "ðŸŒ• Salve";
	var n = new Date().getHours();

	if ((n >= 7) && (n <= 19)){
		time = "â˜€ï¸ Buongiorno";
	}else if ((n > 19) && (n < 23)){
		time = "ðŸŒ™ Buonasera";
	}

	var msgtext = "<b>" + time + " " + message.from.username + "! Cosa vuoi fare?</b>";

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Il tuo account non Ã¨ stato trovato, se hai cambiato nickname usa /migrazione, altrimenti usa /start per crearne uno nuovo.", mark);
			return;
		}

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var mission_id = rows[0].mission_id;
		var mission_special_id = rows[0].mission_special_id;
		var travel_id = rows[0].travel_id;
		var cave_id = rows[0].cave_id;
		var lev = Math.floor(rows[0].exp/10);
		var exp = rows[0].exp;
		var life = rows[0].life;
		var tot_life = rows[0].total_life;
		var reborn = rows[0].reborn;
		var money = rows[0].money;
		var holiday = rows[0].holiday;
		var boost_id = rows[0].boost_id;
		var hide_rein = rows[0].hide_rein;

		var mission_time_end = rows[0].mission_time_end;
		var mission_special_time_end = rows[0].mission_special_time_end;
		var travel_time_end = rows[0].travel_time_end;
		var cave_time_end = rows[0].cave_time_end;
		var dungeon_time = rows[0].dungeon_time;
		var boost_end = rows[0].boost_mission;

		if (rows[0].paralyzed > 0){
			var plur = "i";
			if (rows[0].paralyzed == 1){
				plur = "o";
			}
			msgtext = msgtext + "\nâš¡ï¸ Sei paralizzato ancora per <b>" + rows[0].paralyzed + " turn" + plur + "</b>";
		}

		connection.query('SELECT room_time FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			var min = 0;

			if (Object.keys(rows).length > 0){
				if (rows[0].room_time != null){
					var now = new Date();
					var room_time = new Date(rows[0].room_time);
					min = Math.round(((room_time - now)/1000)/60);
				}
			}

			connection.query('SELECT wait_time FROM heist_progress WHERE from_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0){
					if (rows[0].wait_time == null){
						msgtext = msgtext + "\nâ“ Gnomo in attesa di istruzioni";
					}else{
						var wait_time = new Date(rows[0].wait_time);
						msgtext = msgtext + "\nðŸ”¦ Gnomo in esplorazione fino alle " + addZero(wait_time.getHours()) + ":" + addZero(wait_time.getMinutes());
					}
				}

				connection.query('SELECT zone_id FROM event_mana_status WHERE time_start IS NOT NULL AND player_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length > 0){
						var zone = "";
						if (rows[0].zone_id == 1){
							type = "Blu";
						}else if (rows[0].zone_id == 2){
							type = "Giallo";
						}else if (rows[0].zone_id == 3){
							type = "Rosso";
						}

						msgtext = msgtext + "\nâ› Estrazione di Mana " + type + " in corso";
					}

					connection.query('SELECT COUNT(*) As cnt FROM heist WHERE to_id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length > 0){
							if (rows[0].cnt > 0){
								var plur = "o";
								if (rows[0].cnt > 1){
									plur = "i";
								}
								msgtext = msgtext + "\nâš ï¸ <b>" + rows[0].cnt + "</b> gnom" + plur + " in lontananza";
							}
						}

						connection.query('SELECT COUNT(*) As cnt FROM heist_progress WHERE to_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length > 0){
								if (rows[0].cnt > 0){
									var plur = "o";
									if (rows[0].cnt > 1){
										plur = "i";
									}
									msgtext = msgtext + "\nâš ï¸ <b>" + rows[0].cnt + "</b> gnom" + plur + " davanti al rifugio";
								}
							}

							connection.query('SELECT extracting, generated FROM event_dust_status WHERE player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length > 0){
									if (rows[0].extracting == 1){
										msgtext = msgtext + "\nâ² Generatore attivo (" + rows[0].generated + " unitÃ )";
									}
								}

								connection.query('SELECT datetime FROM heist WHERE from_id = ' + player_id,  function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length > 0){
										var heist_end = new Date(rows[0].datetime);
										msgtext = msgtext + "\nðŸ”¦ Gnomo in ispezione alle " + addZero(heist_end.getHours()) + ":" + addZero(heist_end.getMinutes());
									}

									connection.query('SELECT name, progress, value, ROUND(progress/value*100) As perc FROM achievement_daily, achievement_list, achievement_status WHERE achievement_daily.achievement_id = achievement_list.id AND achievement_status.achievement_id = achievement_list.id AND player_id = ' + player_id + ' AND progress < value AND completed = 0 ORDER BY perc DESC', function(err, rows, fields) {
										if (err) throw err;

										var achievement = "";
										if (Object.keys(rows).length > 0){
											achievement = "\nðŸ‹ Impresa imminente: " + rows[0].name + " (" + formatNumber(rows[0].progress) + "/" + formatNumber(rows[0].value) + ")";
										}

										connection.query('SELECT boost_time FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;

											if (mission_id > 0){
												var mission_end = new Date(mission_time_end);
												var now = new Date();
												var tomorrow = new Date();
												tomorrow.setDate(now.getDate() + 1);
												var tomorrow2 = new Date();
												tomorrow2.setDate(now.getDate() + 2);
												if (tomorrow.getFullYear() == mission_end.getFullYear() && tomorrow.getMonth() == mission_end.getMonth() && tomorrow.getDate() == mission_end.getDate()) {
													msgtext = msgtext + "\nâš” Missione fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes()) + " di domani";
												}else if (tomorrow2.getFullYear() == mission_end.getFullYear() && tomorrow2.getMonth() == mission_end.getMonth() && tomorrow2.getDate() == mission_end.getDate()) {
													msgtext = msgtext + "\nâš” Missione fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes()) + " di dopodomani";
												}else{
													msgtext = msgtext + "\nâš” Missione fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes());
												}
											}
											if (mission_special_id > 0){
												var mission_end = new Date(mission_special_time_end);
												msgtext = msgtext + "\nðŸ—¾ Itinerario fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes());
											}
											if (travel_id > 0){
												var travel_end = new Date(travel_time_end);
												msgtext = msgtext + "\nðŸ—º Viaggio fino alle " + addZero(travel_end.getHours()) + ":" + addZero(travel_end.getMinutes()) + " del " + addZero(travel_end.getDate()) + "/" + addZero(travel_end.getMonth()+1) + "/" + travel_end.getFullYear();
											}
											if (cave_id > 0){
												var cave_end = new Date(cave_time_end);
												msgtext = msgtext + "\nðŸ—» Esplorazione cava fino alle " + addZero(cave_end.getHours()) + ":" + addZero(cave_end.getMinutes()) + " del " + addZero(cave_end.getDate()) + "/" + addZero(cave_end.getMonth()+1) + "/" + cave_end.getFullYear();
											}
											if (dungeon_time != null){
												var dungeon = new Date(dungeon_time);
												msgtext = msgtext + "\nðŸ›¡ Attesa dungeon fino alle " + addZero(dungeon.getHours()) + ":" + addZero(dungeon.getMinutes());
											}
											if (Object.keys(rows).length > 0){
												if (rows[0].boost_time != null){
													var dragon = new Date(rows[0].boost_time);
													var now = new Date();
													if (dragon < now){
														msgtext = msgtext + "\nðŸ¶ Bevanda pronta al ritiro" ;
													}else{
														msgtext = msgtext + "\nðŸ¶ Produzione bevanda alle " + addZero(dragon.getHours()) + ":" + addZero(dragon.getMinutes());
													}
												}
											}

											if (min > 0){
												var plur = "i";
												if (min == 1){
													plur = "o";
												}
												msgtext = msgtext + "\nðŸ›¡ Prossima stanza tra " + min + " minut" + plur;
											}
											if (boost_id == 1){
												var plur = "i";
												if (boost_end == 1){
													plur = "e";
												}
												msgtext = msgtext + "\nðŸ¹ Bevanda Energetica attiva per " + boost_end + " mission" + plur;
											}
											if (boost_id == 2){
												var plur = "i";
												if (boost_end == 1){
													plur = "e";
												}
												msgtext = msgtext + "\nðŸ¹ Bevanda Duplicante attiva per " + boost_end + " mission" + plur;
											}
											if (boost_id == 4){
												var plur = "i";
												if (boost_end == 1){
													plur = "e";
												}
												msgtext = msgtext + "\nðŸ¹ Bevanda Livellante attiva per " + boost_end + " mission" + plur;
											}
											if (boost_id == 3){
												var plur = "i";
												if (boost_end == 1){
													plur = "io";
												}
												msgtext = msgtext + "\nðŸ¹ Bevanda Fiamma di Drago attiva per " + boost_end + " viagg" + plur;
											}
											if (boost_id == 5){
												var plur = "i";
												if (boost_end == 1){
													plur = "e";
												}
												msgtext = msgtext + "\nðŸ¹ Bevanda Quadrifoglio attiva per " + boost_end + " mission" + plur;
											}
											if (boost_id == 6){
												var plur = "hi";
												if (boost_end == 1){
													plur = "o";
												}
												msgtext = msgtext + "\nðŸ¹ Bevanda Furia attiva per " + boost_end + " attacc" + plur;
											}
											if (boost_id == 7){
												var plur = "i";
												if (boost_end == 1){
													plur = "e";
												}
												msgtext = msgtext + "\nðŸ¹ Bevanda Bottino attiva per " + boost_end + " mission" + plur;
											}
											if (holiday > 0){
												msgtext = msgtext + "\nâ›± Sei in modalitÃ  Vacanza!";
											}
											if (achievement != ""){
												msgtext += achievement;
											}
											var reb = "";
											if (reborn > 1){
												reb = " R" + (reborn-1);
											}
											msgtext += "\n" + rebSym(reborn) + " <b>" + lev + "</b> â¤ï¸ " + formatNumber(life) + "/" + formatNumber(tot_life) + "\nðŸ’° " + formatNumber(money) + " Â§";
											msgtext += price_drop_msg;

											if (((exp >= 1000) && (reborn == 1)) || ((exp >= 1500) && (reborn == 2)) || ((exp >= 2000) && (reborn == 3)) || ((exp >= 3000) && (reborn == 4))){
												bot.sendMessage(message.chat.id, msgtext, mainReborn_html);
											}else if (((exp <= 50) && (reborn == 2)) || ((exp <= 50) && (reborn == 3)) || ((exp <= 50) && (reborn == 4))){
												bot.sendMessage(message.chat.id, msgtext, mainReborn2_html);
											}else if ((exp == 10000) && (hide_rein == 0)){
												bot.sendMessage(message.chat.id, msgtext, mainReborn3_html);
											}else{
												bot.sendMessage(message.chat.id, msgtext, main_html);
											}
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
}

function rebSym(reborn){
	var rebSym = "ðŸ”°";
	if (reborn == 1){
		rebSym = "ðŸ”…";
	}else if (reborn == 2){
		rebSym = "ðŸ”†";
	}else if (reborn == 3){
		rebSym = "ðŸ’«";
	}else if (reborn == 4){
		rebSym = "ðŸ”±";
	}else if (reborn == 5){
		rebSym = "âšœ";
	}
	return rebSym;
}

bot.onText(/torna al menu$/i, function(message) {
	mainMenu(message);
});
bot.onText(/niente$/i, function(message) {
	mainMenu(message);
});
bot.onText(/nessuno$/i, function(message) {
	mainMenu(message);
});
bot.onText(/annulla$/i, function(message) {
	mainMenu(message);
});

bot.onText(/giocatore/i, function(message) {
	getInfo(message, message.from.username, 6);
});

function getInfo(message, player, myhouse_id){
	calcLife(message);

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		helpMsg(message.chat.id, rows[0].id, 8);
	});

	connection.query('SELECT id, house_id, class, reborn, custom_name, weapon_id, weapon2_id, weapon3_id, charm_id FROM player WHERE nickname="' + player + '"', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Il giocatore non esiste.", back);
			return;
		}

		var player_id = rows[0].id;
		var custom_name = rows[0].custom_name;

		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var charm_id = rows[0].charm_id;
		var house_id = rows[0].house_id;
		var reborn = rows[0].reborn;
		var class_id = rows[0].class;

		connection.query('SELECT name, id FROM item WHERE id = ' + weapon_id, function(err, rows, fields) {
			if (err) throw err;
			var weapon = "-";
			var weapon_id = 0;
			if (Object.keys(rows).length > 0){
				weapon_id = rows[0].id;
				if ((weapon_id == 638) || (weapon_id == 639) || (weapon_id == 640)){
					if (custom_name != null){
						weapon = custom_name + rows[0].name.replace("Necro","");
					}else{
						weapon = rows[0].name;
					}
				}else{
					weapon = rows[0].name;
				}
			};

			connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 1', function(err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				if (Object.keys(rows).length > 0){
					abBonus = rows[0].ability_level;
				}

				connection.query('SELECT name, description FROM item WHERE id = ' + charm_id, function(err, rows, fields) {
					if (err) throw err;
					var talismano = "-";
					var talismano_desc = "";
					if (Object.keys(rows).length > 0){
						talismano = rows[0].name;
						talismano_desc = " (" + rows[0].description + ")";
					};

					connection.query('SELECT name FROM player, team, team_player WHERE player.id = ' + player_id + ' AND team.id = team_player.team_id AND team_player.player_id = player.id', function(err, rows, fields) {
						if (err) throw err;
						var team_desc = "";
						if (Object.keys(rows).length > 0){
							team_desc = " (" + rows[0].name.trim() + ")";
						};

						connection.query('SELECT name FROM house WHERE id = ' + house_id, function(err, rows, fields) {
							if (err) throw err;
							var house_name = rows[0].name;

							connection.query('SELECT name FROM item WHERE id = ' + weapon2_id, function(err, rows, fields) {
								if (err) throw err;
								var weapon2 = "-";
								if (Object.keys(rows).length > 0){
									weapon2 = rows[0].name;
								}

								connection.query('SELECT name FROM item WHERE id = ' + weapon3_id, function(err, rows, fields) {
									if (err) throw err;
									var weapon3 = "-";
									if (Object.keys(rows).length > 0){
										weapon3 = rows[0].name;
									}

									connection.query('SELECT dragon.* FROM player, dragon WHERE player.id = dragon.player_id AND player.id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										var dragon_name = "-";
										var dragon_level = "-";
										var dragon_damage = "-";
										var dragon_defense = "-";
										var dragon_critical = "-";

										var dragon_clawsid = 0;
										var dragon_saddleid = 0;

										var dragon_claws = 0;

										var dragon = 0;

										if (Object.keys(rows).length > 0){
											dragon = 1;

											if (charm_id == 602){
												rows[0].damage += 25;
												rows[0].critical += 10;
											}
											
											if ((class_id == 7) && (reborn > 1)){
												rows[0].claws += rows[0].claws*0.5;
											}
											if ((class_id == 7) && (reborn > 1)){
												rows[0].saddle += rows[0].saddle*0.5;
											}
											if ((class_id == 7) && (reborn >= 4)){
												rows[0].damage += rows[0].damage*0.5;
											}
											if ((class_id == 7) && (reborn >= 4)){
												rows[0].defense += rows[0].defense*0.5;
											}
											if ((class_id == 7) && (reborn == 3)){
												rows[0].critical += 5;
											}
											if ((class_id == 7) && (reborn >= 4)){
												rows[0].critical += 7;
											}

											dragon_name = rows[0].name.replace(new RegExp("_", "g"), " ").trim() + " " + rows[0].type;
											dragon_level = rows[0].level;
											dragon_damage = "+" + (rows[0].damage + rows[0].claws);
											dragon_defense = "-" + (rows[0].defense + rows[0].saddle);
											dragon_critical = rows[0].critical + "%";

											dragon_claws = parseInt(rows[0].claws);

											dragon_clawsid = rows[0].claws_id;
											dragon_saddleid = rows[0].saddle_id;
										}

										connection.query('SELECT name, COUNT(name) As num FROM item WHERE id = ' + dragon_clawsid, function(err, rows, fields) {
											if (err) throw err;

											var dragon_claws_n = "-";
											if (rows[0].num > 0){
												dragon_claws_n = rows[0].name;
											}

											connection.query('SELECT name, COUNT(name) As num FROM item WHERE id = ' + dragon_saddleid, function(err, rows, fields) {
												if (err) throw err;

												var dragon_saddle_n = "-";
												if (rows[0].num > 0){
													dragon_saddle_n = rows[0].name;
												}

												connection.query('SELECT P1.nickname As player, P2.nickname As new, time FROM referral_list INNER JOIN player P1 ON P1.id = player_id INNER JOIN player P2 ON P2.id = new_player WHERE P2.id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;

													var referral = "";
													if (Object.keys(rows).length > 0){
														var d = new Date(rows[0].time);
														var short_date = addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();
														referral = "Invitato da: " + rows[0].player + " (" + short_date + ")\n";
													}

													connection.query('SELECT class.name FROM player, class WHERE player.id = ' + player_id + ' AND player.class = class.id', function(err, rows, fields) {
														if (err) throw err;

														var class_name = "-";
														if (Object.keys(rows).length > 0){
															class_name = rows[0].name;
														}

														connection.query('SELECT * FROM player WHERE id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															var stars = rebSym(reborn);

															if (player_id == 1){
																stars = " ðŸ‘‘";
															}

															//Talismani

															if (charm_id == 62){
																rows[0].weapon += 5;
															}
															if (charm_id == 184){
																rows[0].weapon += 15;
															}
															if (charm_id == 188){
																rows[0].weapon += 20;
															}
															if (charm_id == 63){
																rows[0].weapon2 -= 5;
															}
															if (charm_id == 186){
																rows[0].weapon2 -= 15;
															}
															if (charm_id == 189){
																rows[0].weapon2 -= 20;
															}
															if (charm_id == 404){
																rows[0].weapon_crit += 6;
															}
															if (charm_id == 493){
																rows[0].weapon_crit += 2;
															}
															if (charm_id == 494){
																rows[0].weapon_crit += 4;
															}
															if (charm_id == 495){
																rows[0].weapon2_crit += 3;
															}
															if (charm_id == 496){
																rows[0].weapon3_crit += 3;
															}
															if (abBonus > 0){
																rows[0].weapon_crit += abBonus;
																rows[0].weapon2_crit += abBonus;
																rows[0].weapon3_crit += abBonus;
															}

															//Vocazioni

															if ((class_id == 2) && (reborn == 3)){
																rows[0].weapon2_crit += 5;
															}
															if ((class_id == 2) && (reborn >= 4)){
																rows[0].weapon2_crit += 5;
																rows[0].weapon3_crit += 5;
															}
															if ((class_id == 4) && (reborn == 3)){
																rows[0].weapon_crit += 2;
															}
															if ((class_id == 4) && (reborn >= 4)){
																rows[0].weapon_crit += 7;
																rows[0].weapon2_crit += 7;
																rows[0].weapon3_crit += 7;
															}
															if ((class_id == 5) && (reborn == 3)){
																rows[0].weapon3_crit += 3;
															}
															if ((class_id == 5) && (reborn >= 4)){
																rows[0].weapon3_crit += 5;
															}
															if ((class_id == 6) && (reborn == 3)){
																rows[0].weapon2_crit += 2;
															}
															if ((class_id == 6) && (reborn == 3)){
																rows[0].weapon3_crit += 2;
															}
															if ((class_id == 6) && (reborn >= 4)){
																rows[0].weapon2_crit += 7;
															}
															if ((class_id == 6) && (reborn >= 4)){
																rows[0].weapon3_crit += 7;
															}
															if ((class_id == 6) && (reborn == 5)){
																rows[0].weapon2_crit += 7;
															}
															if ((class_id == 6) && (reborn == 5)){
																rows[0].weapon3_crit += 7;
															}
															if ((class_id == 8) && (reborn == 3)){
																rows[0].weapon3_crit += 5;
															}
															if ((class_id == 8) && (reborn >= 4)){
																rows[0].weapon3_crit += 7;
															}
															if ((class_id == 8) && (reborn == 5)){
																rows[0].weapon_crit += 7;
															}
															if ((class_id == 9) && (reborn == 3)){
																rows[0].weapon_crit += 2;
																rows[0].weapon3_crit += 2;
															}
															if ((class_id == 9) && (reborn >= 4)){
																rows[0].weapon_crit += 7;
																rows[0].weapon3_crit += 7;
															}
															
															if ((class_id == 7) && (reborn == 5)){
																rows[0].weapon_crit += dragon_critical/2;
															}
															
															if ((class_id == 8) && (reborn > 1)){
																rows[0].weapon += rows[0].weapon*0.1;
															}
															if ((class_id == 8) && (reborn == 5)){
																rows[0].weapon += rows[0].weapon*0.1;
															}
															if ((class_id == 8) && ((reborn == 3) || (reborn >= 4))){
																rows[0].weapon += rows[0].weapon*0.07;
															}
															
															//Descrizioni

															var weapon_desc = "";
															if (weapon != "-"){
																weapon_desc = " (+" + Math.round(rows[0].weapon) + ", " + rows[0].weapon_crit + "%, " + rows[0].weapon_enchant + ")";
															}
															var weapon2_desc = "";
															if (weapon2 != "-"){
																weapon2_desc = " (" + Math.round(rows[0].weapon2) + ", " + rows[0].weapon2_crit + "%, " + rows[0].weapon2_enchant + ")";
															}
															var weapon3_desc = "";
															if (weapon3 != "-"){
																weapon3_desc = " (" + Math.round(rows[0].weapon3) + ", " + rows[0].weapon3_crit + "%, " + rows[0].weapon3_enchant + ")";
															}

															var nickname = rows[0].nickname;
															var weapon_d = parseInt(rows[0].weapon);
															var lev = Math.floor(rows[0].exp/10);
															var player_atk = (lev+weapon_d+rows[0].weapon_enchant) + " - " + ((lev+weapon_d+rows[0].weapon_enchant)+(weapon_d+rows[0].weapon_enchant+dragon_claws));
															var player_description = rows[0].player_description;

															var Keys = []

															if (player == message.from.username){
																Keys.push(["Vocazione ðŸ¹"]);
																Keys.push(["Visualizza Link Invito","Statistiche Personali"]);
																if ((weapon_id == 638) || (weapon_id == 639) || (weapon_id == 640)){
																	Keys.push(["Nomina Necrolama"]);
																}
																if ((Math.floor(rows[0].exp) == 300) || (rows[0].reborn == 5)){
																	//Keys.push(["Scambia Speciali"]);
																}
																Keys.push(["Resetta Guide","Descrizione Personale"]);
															}else{
																if (myhouse_id == 1){
																	rows[0].life = "?";
																	rows[0].total_life = "?";
																	rows[0].heist_count = "?";
																	rows[0].spy_count = "?";
																	rows[0].money = "?";
																	rows[0].exp = "?";
																	lev = "?";
																	weapon = "?";
																	weapon_desc = "";
																	weapon2 = "?";
																	weapon2_desc = "";
																	weapon3 = "?";
																	weapon3_desc = "";
																	talismano = "?";
																	talismano_desc = "";
																	dragon_name = "?";
																	dragon_level = "?";
																	dragon_claws_n = "?";
																	dragon_damage = "?";
																	dragon_saddle_n = "?";
																	dragon_defense = "?";
																	dragon_critical = "?";
																}else if (myhouse_id == 2){
																	rows[0].heist_count = "?";
																	rows[0].spy_count = "?";
																	rows[0].money = "?";
																	weapon = "?";
																	weapon_desc = "";
																	weapon2 = "?";
																	weapon2_desc = "";
																	weapon3 = "?";
																	weapon3_desc = "";
																	talismano = "?";
																	talismano_desc = "";
																	dragon_name = "?";
																	dragon_level = "?";
																	dragon_claws_n = "?";
																	dragon_damage = "?";
																	dragon_saddle_n = "?";
																	dragon_defense = "?";
																	dragon_critical = "?";
																}else if (myhouse_id == 3){
																	rows[0].heist_count = "?";
																	rows[0].spy_count = "?";
																	rows[0].money = "?";
																	talismano = "?";
																	talismano_desc = "";
																	dragon_name = "?";
																	dragon_level = "?";
																	dragon_claws_n = "?";
																	dragon_damage = "?";
																	dragon_saddle_n = "?";
																	dragon_defense = "?";
																	dragon_critical = "?";
																}else if (myhouse_id == 4){
																	rows[0].heist_count = "?";
																	rows[0].spy_count = "?";
																	rows[0].money = "?";
																}else if (myhouse_id == 5){
																	rows[0].money = "?";
																}
															}
															Keys.push(["Torna al menu"]);

															var kb = {
																parse_mode: "HTML",
																reply_markup: {
																	resize_keyboard: true,
																	one_time_keyboard: true,
																	"keyboard": Keys
																}
															};

															bot.sendMessage(message.chat.id, "<b>Giocatore</b> ðŸ‘¤\n" +
																			nickname + team_desc + "\n" +
																			stars + " " + lev + " (" + rows[0].exp + " xp)" + "\n\n" +
																			"ðŸ¹ " + class_name + "\n" +
																			"ðŸ’Ž " + rows[0].gems + "\n" +
																			"ðŸŒ " + rows[0].token + "\n" +
																			"ðŸ’° " + formatNumber(rows[0].money) + " Â§\n" +
																			"â¤ï¸ " + rows[0].life + " / " + rows[0].total_life + " hp\n" +
																			"ðŸ“¦ " + rows[0].craft_count + " (" + rows[0].craft_week + ")\n" +
																			"\n<b>Equipaggiamento</b> âš”ï¸\n" +
																			"ðŸ—¡ " + weapon + weapon_desc + "\n" +
																			"ðŸ¥‹ " + weapon2 + weapon2_desc + "\n" +
																			"ðŸ›¡ " + weapon3 + weapon3_desc + "\n" +
																			"ðŸ“¿ " + talismano + "\n" +
																			"ðŸ’¥ " + player_atk + "\n" +

																			(dragon ? "\n<b>" + dragon_name + " (L" + dragon_level + ")</b> ðŸ‰\n" : "") +
																			(dragon ? dragon_claws_n + " (" + dragon_damage + ")\n" : "") +
																			(dragon ? dragon_saddle_n + " (" + dragon_defense + ")\n" : "") +
																			(dragon ? "CRIT " + dragon_critical + "\n" : "") +

																			"\n<b>Altro</b> ðŸ’±\n" +
																			referral +
																			"AbilitÃ : " + rows[0].ability + "\n" +
																			"Rango: " + getRankName(rows[0].rank, 0) + " (" + rows[0].rank + ")\n" +
																			(player_description != null ? "\n<i>" + player_description  + "</i>" : ""), kb);
														});
													});
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
};

bot.onText(/descrizione personale/i, function(message) {
	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		bot.sendMessage(message.chat.id, "Inserisci la descrizione del tuo personaggio, comparirÃ  quando altri giocatori ti spiano.\nNon utilizzare insulti, bestemmie, offese verso gli altri player, ecc., massimo 250 caratteri, non andare a capo e non tutti i simboli sono consentiti", back).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text != "Torna al menu"){
					var resp = answer.text;
					var reg = new RegExp("^[a-zA-ZÃ Ã¨Ã¬Ã²Ã¹.,\\\?\!\'\@\(\) ]{1,250}$");
					if (reg.test(resp) == false){
						bot.sendMessage(message.chat.id, "Nome non valido, riprova", back);
						return;
					}
					bot.sendMessage(message.chat.id, "Descrizione personaggio impostata:\n\n_" + resp + "_", back);
					connection.query('UPDATE player SET player_description = "' + resp + '" WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
					});
				}
			}
		});
	});
});

bot.onText(/scambia speciali/i, function(message) {

	return;

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		var kb = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Lacrima dell'Immortale"],["Lacrima del Rinnegato"],["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, "Puoi decidere quale dei 3 oggetti per i crafting finali vuoi scambiare con uno che hai attualmente, seleziona l'oggetto da scambiare.", kb).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text == "Torna al menu"){
					return;
				}else{

					var item1 = answer.text;

					bot.sendMessage(message.chat.id, "Con quale oggetto vuoi scambiarlo?", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text == "Torna al menu"){
								return;
							}else{

								var item2 = answer.text;

								bot.sendMessage(message.chat.id, "Sei sicuro?", yesno).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {
										if (answer.text.toLowerCase() == "si"){
											connection.query('SELECT id FROM item WHERE name = "' + item1 + '" AND id IN (674, 641)', function(err, rows, fields) {
												if (err) throw err;

												if (Object.keys(rows).length == 0){
													bot.sendMessage(message.chat.id, "Il primo oggetto non esiste o non Ã¨ valido", back);
													return;
												}

												var id1 = rows[0].id;

												connection.query('SELECT id FROM item WHERE name = "' + item2 + '" AND id IN (674, 641)', function(err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "Il secondo oggetto non esiste o non Ã¨ valido", back);
														return;
													}

													var id2 = rows[0].id;

													connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + id1, function(err, rows, fields) {
														if (err) throw err;

														if (Object.keys(rows).length == 0){
															bot.sendMessage(message.chat.id, "Non possiedi " + item1, back);
															return;
														}

														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + id1 + ' LIMIT 1', function(err, rows, fields) {
															if (err) throw err;
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + id2 + ')', function(err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai scambiato " + item1 + " con " + item2 + "!", back);
															});
														});
													});
												});
											});
										}
									}
								});
							}
						};
					});
				}
			}
		});
	});
});

bot.onText(/nomina necrolama/i, function(message) {
	connection.query('SELECT id, weapon_id, custom_name FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var weapon_id = rows[0].weapon_id;

		if (rows[0].custom_name != null){
			bot.sendMessage(message.chat.id, "Ripristinare il nome originale della Necrolama?", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text.toLowerCase() == "si"){
						connection.query('UPDATE player SET custom_name = NULL WHERE id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Hai ripristinato il nome originale della tua Necrolama!", back);
						});
					}
				}
			});
			return;
		}

		if ((weapon_id != 638) && (weapon_id != 639) && (weapon_id != 640)){
			bot.sendMessage(message.chat.id, "Equipaggia una delle 3 Necrolame Incantate per utilizzare questa funzionalitÃ ", back);
			return;
		}

		bot.sendMessage(message.chat.id, "Inserisci il nome da utilizzare per la tua *Necrolama*, risulterÃ  poi in questo modo: '_Nomeinserito_+lama' per esempio inserendo '_Banana_', il nome " +
						"diventerÃ  '_Bananalama_'.\nNon utilizzare nomi non consoni, divinitÃ , insulti, ecc., massimo 10 caratteri e nessun simbolo!", back).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text != "Torna al menu"){
					var resp = answer.text;
					var reg = new RegExp("^[a-zA-Z]{0,10}$");
					if (reg.test(resp) == false){
						bot.sendMessage(message.chat.id, "Nome non valido, riprova", back);
						return;
					}
					connection.query('SELECT name FROM item WHERE id = ' + weapon_id, function(err, rows, fields) {
						if (err) throw err;

						bot.sendMessage(message.chat.id, "Complimenti! La tua nuova Necrolama si chiama ora *" + resp + rows[0].name.replace("Necro","") + "*!", back);
						connection.query('UPDATE player SET custom_name = "' + resp + '" WHERE id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});
					});
				}
			}
		});
	});
});

bot.onText(/resetta guide/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		bot.sendMessage(message.chat.id, "Sei sicuro di voler ripristinare tutte le guide per sezione?", yesno).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text.toLowerCase() == "si"){
					connection.query('DELETE FROM help_message WHERE player_id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Le guide sono state resettate!", back);
					});
				}
			}
		});
	});
});

bot.onText(/vocazioni|vocazione/i, function(message) {

	if (message.text == "Cambia Vocazione"){
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back);
			return;
		}

		var player_id = rows[0].id;
		var player_class = rows[0].class;
		var reborn = rows[0].reborn;
		var changed = rows[0].class_changed;

		if (reborn == 1){
			bot.sendMessage(message.chat.id, "Non puoi selezionare una vocazione fino alla Rinascita 1", back);
			return;
		}

		connection.query('SELECT name, description FROM class', function(err, rows, fields) {
			if (err) throw err;

			var iKeys = [];
			var text = "";

			for (var i = 1, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push([rows[i].name]);
				//text += "*" + rows[i].name + "*: " + rows[i].description + "\n";
			}

			iKeys.push(["Torna al menu"]);

			var sClass = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			var bClass = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna alle vocazioni"]]
				}
			};

			var backChange = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Cambia Vocazione"],["Torna al menu"]]
				}
			};

			var cClass = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Si"],["Torna alle vocazioni"]]
				}
			};

			if (player_class == 1){
				bot.sendMessage(message.chat.id, "Le *Vocazioni* sono dei percorsi che puoi scegliere e per migliorare una particolare sezione del tuo personaggio.\nSeleziona la vocazione che preferisci per trarne i benefici associati, *ma fai attenzione, non potrai piÃ¹ cambiarla!*\n\n" + 
								"Le caratteristiche di Rinascita 1 si preservano fino alla fine, come anche quelle di Rinascita 3 e 4. Mentre la Rinascita 2 viene rimpiazzata dalla 3.", sClass).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text != "Torna al menu"){
							connection.query('SELECT id, name, description FROM class WHERE name = "' + answer.text + '"', function(err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "Vocazione non valida!", bClass);
									return;
								}

								var class_id = rows[0].id;
								var class_name = rows[0].name;
								var description = rows[0].description;

								bot.sendMessage(message.chat.id, "La vocazione " + class_name + " offre i seguenti bonus/malus:\n\n" + description + "\n\nScegli questa vocazione?", cClass).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {
										if (answer.text.toLowerCase() == "si"){
											bot.sendMessage(message.chat.id, "Sicuro?", cClass).then(function() {
												answerCallbacks[message.chat.id] = function(answer) {
													if (answer.text.toLowerCase() == "si"){
														connection.query('UPDATE player SET class = ' + class_id + ' WHERE id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Hai selezionato la vocazione *" + class_name + "*!", back);
														});
													}
												}
											});
										}
									}
								});
							});
						}
					};
				});
			}else{

				if (player_class == 5){
					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Genera Pozioni","Genera Piuma"],["Cambia Vocazione"],["Torna al menu"]]
						}
					};					
				}

				connection.query('SELECT name, description FROM class WHERE id = ' + player_class, function(err, rows, fields) {
					if (err) throw err;
					if (player_class == 5){
						bot.sendMessage(message.chat.id, "Informazioni sulla vocazione *" + rows[0].name + "*:\n\n" + rows[0].description, kb).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text.toLowerCase() == "genera pozioni"){

									if (reborn < 3){
										bot.sendMessage(message.chat.id, "Non puoi creare pozioni a questo livello di rinascita");
										return;
									}

									var mana = 50;
									var num = 4;
									var pot = "Piccole";
									var potId = 92;
									if (reborn == 4){
										mana = 100;
										pot = "Medie";
										potId = 93;
									}else if (reborn == 5){
										mana = 250;
										pot = "Grandi";
										potId = 94;
										num = 6;
									}

									bot.sendMessage(message.chat.id, "Vuoi consumare " + mana + " Mana Blu per generare " + num + " Pozioni " + pot + "?", cClass).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){
												connection.query('SELECT mana_1 FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													if (rows[0].mana_1 < mana){
														bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Blu!", bClass);
														return;
													}
													connection.query('UPDATE event_mana_status SET mana_1 = mana_1-' + mana + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
														connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + potId + ')', function(err, rows, fields) {
															if (err) throw err;
														}); 
														connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + potId + ')', function(err, rows, fields) {
															if (err) throw err;
														}); 
														connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + potId + ')', function(err, rows, fields) {
															if (err) throw err;
														}); 
														connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + potId + ')', function(err, rows, fields) {
															if (err) throw err;
														});
														if (reborn == 5){
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + potId + ')', function(err, rows, fields) {
																if (err) throw err;
															}); 
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + potId + ')', function(err, rows, fields) {
																if (err) throw err;
															}); 
														}
														bot.sendMessage(message.chat.id, "Hai ottenuto " + num + " Pozioni " + pot + " per " + mana + " Mana Blu!", bClass);
													});
												});
											}
										}
									});
								}else if (answer.text.toLowerCase() == "genera piuma"){
									if (reborn != 5){
										bot.sendMessage(message.chat.id, "Il tuo livello rinascita non Ã¨ sufficiente!", bClass);
										return;
									}
									bot.sendMessage(message.chat.id, "Vuoi consumare 250 Mana Blu per generare 3 Piume di Fenice?", cClass).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){
												connection.query('SELECT mana_1 FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													if (rows[0].mana_1 < 250){
														bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Blu!", bClass);
														return;
													}
													connection.query('UPDATE event_mana_status SET mana_1 = mana_1-250 WHERE player_id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
														connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',619)', function(err, rows, fields) {
															if (err) throw err;
														}); 
														connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',619)', function(err, rows, fields) {
															if (err) throw err;
														}); 
														connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',619)', function(err, rows, fields) {
															if (err) throw err;
														}); 
														bot.sendMessage(message.chat.id, "Hai ottenuto 3 Piume di Fenice per 250 Mana Blu!", bClass);
													});
												});
											}
										}
									});
								}
							}
						});
					}else{
						bot.sendMessage(message.chat.id, "Informazioni sulla vocazione *" + rows[0].name + "*:\n\n" + rows[0].description, backChange);
					}
				});
			}
		});
	});
});

bot.onText(/cambia vocazione/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back);
			return;
		}

		var player_id = rows[0].id;
		var player_class = rows[0].class;
		var reborn = rows[0].reborn;
		var changed = rows[0].class_changed;

		if (reborn == 1){
			bot.sendMessage(message.chat.id, "Non puoi selezionare una vocazione fino alla Rinascita 1", back);
			return;
		}

		var bClass = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Torna alle vocazioni"]]
			}
		};
		var cClass = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Si"],["Torna alle vocazioni"]]
			}
		};

		if (changed == 1){
			bot.sendMessage(message.chat.id, "Hai giÃ  cambiato la vocazione", bClass);
			return;
		}

		if (player_class == 1){
			bot.sendMessage(message.chat.id, "Puoi cambiare vocazione solo dopo averne scelta una", bClass);
			return;
		}

		var scadenza = new Date(2017, 5, 14);
		var oggi = new Date();

		//		if (oggi > scadenza){
		bot.sendMessage(message.chat.id, "Non Ã¨ piÃ¹ possibile cambiare la vocazione, tempo scaduto", bClass);
		return;
		//		}

		bot.sendMessage(message.chat.id, "Sei sicuro di voler modificare la Vocazione? Puoi farlo solamente una volta dal momento in cui sceglierai 'Si', hai tempo fino a Domenica 14/05", cClass).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text.toLowerCase() == "si"){
					connection.query('UPDATE player SET class = 1, class_changed = 1 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Hai resettato la vocazione, ora fai la nuova scelta", bClass);
					});
				}
			}
		});	
	});
});

bot.onText(/statistiche personali/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var missioni = rows[0].mission_count;
		var imprese = rows[0].achievement_count;
		var dungeon_tot = rows[0].dungeon_count;
		connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE to_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var ispezioniSubite = rows[0].cnt;

			connection.query('SELECT kill_streak FROM team_player WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				var scalate = 0;
				if (Object.keys(rows).length > 0){
					scalate = rows[0].kill_streak;
				}

				connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE from_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
					var ispezioniEffettuate = rows[0].cnt;
					connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail > 0 AND to_id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						var ispezioniSubiteVinte = rows[0].cnt;
						connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail = 0 AND to_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							var ispezioniSubitePerse = rows[0].cnt;
							connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail = 0 AND from_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								var ispezioniEffettuateVinte = rows[0].cnt;
								connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail > 0 AND from_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									var ispezioniEffettuatePerse = rows[0].cnt;
									connection.query('SELECT COUNT(*) As cnt FROM search_history WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										var ricerche = rows[0].cnt;
										connection.query('SELECT COUNT(*) As cnt FROM market_direct_history WHERE from_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
											var vendite = rows[0].cnt;
											connection.query('SELECT COUNT(*) As cnt FROM market_direct_history WHERE to_id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												var acquisti = rows[0].cnt;
												connection.query('SELECT COUNT(*) As cnt FROM market_history WHERE from_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													var scambiOut = rows[0].cnt;
													connection.query('SELECT COUNT(*) As cnt FROM market_history WHERE to_id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
														var scambiIn = rows[0].cnt;
														connection.query('SELECT COUNT(*) As cnt FROM referral_list WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															var invitati = rows[0].cnt;
															connection.query('SELECT COUNT(*) As cnt FROM inventory_rarity WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																var oggetti = rows[0].cnt;
																connection.query('SELECT COUNT(*) As cnt FROM public_lottery_history WHERE creator_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	var lotterie = rows[0].cnt;
																	connection.query('SELECT COUNT(*) As cnt FROM public_lottery_history WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		var lotterieVinte = rows[0].cnt;
																		connection.query('SELECT COUNT(*) As cnt FROM ability WHERE player_id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			var abilita = rows[0].cnt;

																			var text = 	"*Statistiche giocatore*\n\n" +
																				"*Missioni completate*: " + missioni + "\n" +
																				"*Imprese completate*: " + imprese + "\n" +
																				"*Dungeon completati*: " + dungeon_tot + "\n" +
																				"*Ispezioni subite*: " + ispezioniSubite + "\n" +
																				"*Ispezioni subite vinte*: " + ispezioniSubiteVinte + "\n" +
																				"*Ispezioni subite perse*: " + ispezioniSubitePerse + "\n" +
																				"*Ispezioni effettuate vinte*: " + ispezioniEffettuateVinte + "\n" +
																				"*Ispezioni effettuate perse*: " + ispezioniEffettuatePerse + "\n" +
																				"*Ricerche*: " + ricerche + "\n" +
																				"*Acquisti*: " + acquisti + "\n" +
																				"*Vendite*: " + vendite + "\n" +
																				"*Scambi in uscita*: " + scambiOut + "\n" +
																				"*Scambi in entrata*: " + scambiIn + "\n" +
																				"*Utenti invitati*: " + invitati + "\n" +
																				"*Oggetti posseduti*: " + oggetti + "\n" +
																				"*Lotterie*: " + lotterie + "\n" +
																				"*Lotterie vinte*: " + lotterieVinte + "\n" +
																				"*AbilitÃ  sbloccate*: " + abilita + "\n" +
																				"*Scalate personali*: " + scalate + "\n";

																			bot.sendMessage(message.chat.id, text, back);

																		});
																	});
																});
															});
														});
													});
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
});

function getRankImg(rank){

	var img = "rank/";

	if (rank < rankList[0]){
		img += "rank1.webp";
	}else if (rank < rankList[1]){
		img += "rank2.webp";
	}else if (rank < rankList[2]){
		img += "rank3.webp";
	}else if (rank < rankList[3]){
		img += "rank4.webp";
	}else if (rank < rankList[4]){
		img += "rank5.webp";
	}else if (rank < rankList[5]){
		img += "rank6.webp";
	}else if (rank < rankList[6]){
		img += "rank7.webp";
	}

	return img;
}

function getRankName(rank, opt){

	if (opt == 0){
		var text = "";

		if (rank < rankList[0]){
			text = "Esploratore Novizio";
		}else if (rank < rankList[1]){
			text = "Esploratore Modesto";
		}else if (rank < rankList[2]){
			text = "Esploratore Professionista";
		}else if (rank < rankList[3]){
			text = "Avventuriero Giovane";
		}else if (rank < rankList[4]){
			text = "Avventuriero Forestiero";
		}else if (rank < rankList[5]){
			text = "Avventuriero della Notte";
		}else if (rank < rankList[6]){
			text = "Avventuriero Impavido";
		}

		return text;
	}else if (opt == 1){
		var next = 0;

		for (var i = 0, len = Object.keys(rankList).length; i < len; i++) {
			if (rank < rankList[i]){
				next = rankList[i];
				break;
			}
		}

		return next;
	}
}

bot.onText(/dungeon/i, function(message) {
	var dBack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna al dungeon"],["Torna al menu"]]
		}
	};

	var dYesNo = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Si"],["Torna al dungeon"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var player_life = rows[0].life;
		var player_total_life = rows[0].total_life;
		var player_ability = rows[0].ability;
		var player_money = rows[0].money;
		var player_rank = rows[0].rank;
		var player_reborn = rows[0].reborn;
		var player_level = Math.floor(rows[0].exp/10);
		var player_class_id = rows[0].class;
		var player_dungeon_skip = rows[0].dungeon_skip;

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (player_reborn == 1){
			bot.sendMessage(message.chat.id, "Per accedere ai dungeon devi aver raggiunto almeno la Rinascita 1", back);
			return;
		}

		if ((player_class_id == 1) && (player_reborn >= 3)){
			bot.sendMessage(message.chat.id, "Raggiunta questa Rinascita la Vocazione Ã¨ obbligatoria, la puoi scegliere nella sezione Giocatore > Vocazione", back);
			return;
		}

		if (player_life <= 0){
			bot.sendMessage(message.chat.id, "Non puoi entrare nel dungeon da morto", back);
			return;
		}
		var dungeon_time = rows[0].dungeon_time;

		var nightText = "";
		var nightMode = 0;
		var now = new Date();
		if (now.getHours() <= 6){
			nightText = "*, attento, di notte i dungeon nascondono piÃ¹ insidie!*";
			nightMode = 1;
		}

		connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 3', function(err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0){
				if (crazyMode == 1){
					abBonus = parseInt(rows[0].ability_level)*15;
				}else{
					abBonus = parseInt(rows[0].ability_level)*30;
				}
			}

			connection.query('SELECT * FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					connection.query('SELECT * FROM dungeon_list ORDER BY min_rank', function(err, rows, fields) {
						if (err) throw err;

						var iKeys = [];

						iKeys.push(["Il tuo Rango"]);
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							var num = rows[i].name.match(/\d+/g);
							if (num == null) {
								if (rows[i].name != "Test"){
									iKeys.push([rows[i].name + " (stanze: " + rows[i].rooms + ", punti min: " + rows[i].min_rank + ")"]);
								}
							}
						}

						iKeys.push(["Resetta il Rango"]);
						iKeys.push(["Torna al menu"]);

						var dSelect = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						var rank = getRankName(player_rank, 0);

						bot.sendMessage(message.chat.id,"Benvenuto nella *Sala di Ritrovo degli Esploratori*\nQui puoi controllare i dungeon esistenti ed esplorarli.\n" +
										"Il tuo rango attuale Ã¨ _" + rank + "_\n" +
										"Seleziona il dungeon da esplorare" + nightText, dSelect).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {

								if (answer.text == "Torna al menu"){
									return;
								}

								if (answer.text == "Il tuo Rango"){
									var next_rank = 0;
									next_rank = parseInt(getRankName(player_rank, 1));
									bot.sendMessage(message.chat.id, "Rango Attuale: *" + rank + "* (" + player_rank + ")\nAumento Rango a " + next_rank + " punti", dBack);
									bot.sendSticker(message.chat.id, getRankImg(player_rank));
									return;
								}

								if (answer.text == "Resetta il Rango"){
									if (player_reborn < 2){
										bot.sendMessage(message.chat.id, "Per resettare i tuoi punti dungeon, devi aver raggiunto la rinascita 2 ed essere massimo livello 5.", dBack);
										return;
									}
									if (player_level > 5){
										bot.sendMessage(message.chat.id, "Per resettare i tuoi punti dungeon, devi aver raggiunto la rinascita 2 ed essere massimo livello 5.", dBack);
										return;
									}
									bot.sendMessage(message.chat.id, "Sei sicuro di voler resettare i tuoi punti dungeon?", dYesNo).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){
												connection.query('UPDATE player SET rank = 0 WHERE id = ' + player_id, function (err, rows, fields){
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai resettato i punti dungeon!", dBack);
												});
											}
										}
									});
									return;
								}

								if (dungeon_time != null){
									var d = new Date(dungeon_time);
									var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

									var dVarco = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											one_time_keyboard: true,
											"keyboard": [["Si"],["Prosegui il dungeon"],["Torna al menu"]]
										}
									};

									bot.sendMessage(message.chat.id, "Puoi tornare nei dungeon alle " + short_date + "\nVuoi utilizzare un Varco Temporale per annullare l'attesa?", dVarco).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){

												if (player_dungeon_skip >= 3){
													bot.sendMessage(message.chat.id, "Puoi usare un Varco Temporale solamente 3 volte al giorno", back);
													return;
												}

												connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 645', function(err, rows, fields) {
													if (err) throw err;
													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "Non possiedi un Varco Temporale", back);
														return;
													}
													connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 645 LIMIT 1', function(err, rows, fields) {
														if (err) throw err;
														connection.query('UPDATE player SET dungeon_time = NULL, dungeon_skip = dungeon_skip+1 WHERE id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Puoi tornare nel dungeon!", back);
														});
													});
												});
											}
										};
									});
									return;
								}

								if (answer.text != "Torna al menu"){
									var name1 = answer.text.substring(0, answer.text.indexOf("(")-1);
									name1 = name1.replace(/[0-9]/g, '')

									connection.query('SELECT id FROM dungeon_list WHERE name = "' + name1 + '"', function(err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
											return;
										}

										connection.query('SELECT COUNT(id) As cnt FROM dungeon_list WHERE main = 0 AND name LIKE "' + name1 + '%"', function(err, rows, fields) {
											if (err) throw err;

											var this_istance_number = rows[0].cnt;

											connection.query('SELECT * FROM dungeon_list WHERE name LIKE "' + name1 + '%" AND duration < 5 ORDER BY duration DESC', function(err, rows, fields) {
												if (err) throw err;

												if (Object.keys(rows).length == 0){
													bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
													return;
												}

												if (player_rank < rows[0].min_rank){
													bot.sendMessage(message.chat.id, "Sali di rango per iniziare questo dungeon", dBack);
													return;
												}

												var this_rank = rows[0].min_rank;
												var this_room = rows[0].rooms;

												var iKeys = [];
												iKeys.push(["Genera Nuova Istanza"]);

												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													if (i < 120){
														var num = rows[i].name.match(/\d+/g);
														if (num != null) {
															iKeys.push([rows[i].name + " (" + (5-rows[i].duration) + " posti liberi)"]);
														}
													}
												}
												iKeys.push(["Torna al dungeon"]);
												iKeys.push(["Torna al menu"]);

												var dSelect2 = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": iKeys
													}
												};

												var d = new Date();
												d.setHours(d.getHours() + (parseInt(this_room)+5));
												var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

												connection.query('SELECT DISTINCT(min_rank) FROM `dungeon_list` ORDER BY min_rank', function (err, rows, fields){
													if (err) throw err;

													var last_rank = 0;
													for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
														if (player_rank >= rows[i].min_rank){
															last_rank = rows[i].min_rank;
														}
													}

													if ((last_rank != this_rank) && (message.from.username != "fenix45")){
														bot.sendMessage(message.chat.id, "Il tuo rango Ã¨ troppo alto per accedere a questo dungeon", dBack);
														return;
													}

													bot.sendMessage(message.chat.id, "Seleziona una variante di dungeon esistente o creane una nuova, in ogni variante la disposizione delle stanze sarÃ  diversa e scompariranno dopo 5 esplorazioni.\n" +
																	"Possono essere ancora create *" + (Math.abs(max_istance-this_istance_number)) + "* istanze.", dSelect2).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															if ((answer.text != "Torna al menu") && (answer.text != "Torna al dungeon")){

																if (answer.text == "Genera Nuova Istanza"){
																	connection.query('SELECT * FROM dungeon_list WHERE name LIKE "' + name1 + '%" ORDER BY LENGTH(name), name', function(err, rows, fields) {
																		if (err) throw err;

																		if (Object.keys(rows).length == 0){
																			bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
																			return;
																		}

																		var newname = "";
																		var dungeon_rooms = rows[0].rooms;
																		var dungeon_rank = rows[0].min_rank;
																		var istance = 0;
																		var num = rows[Object.keys(rows).length-1].name.match(/\d+/g);
																		if (num == null) {
																			// Caso in cui esiste solo il dungeon base
																			istance = 1;
																		}else{
																			// Caso in cui Ã¨ presente giÃ  una stanza numerata

																			var numArray = rows.map(function (item) { return item.name.replace( /^\D+/g, ''); });
																			//console.log(numArray);

																			istance = findMissing(numArray);
																			if (istance == undefined){
																				istance = parseInt(rows[Object.keys(rows).length-1].name.replace( /^\D+/g, ''))+1;
																			}
																			console.log(">> NEWISTANCE: " + istance);
																		}

																		newname = name1 + " " + istance;

																		if (istance == -1){
																			bot.sendMessage(message.chat.id, "Errore creazione istanza, riprova", dBack);
																			return;
																		}

																		if (Object.keys(rows).length > max_istance){
																			bot.sendMessage(message.chat.id, "Questo dungeon ha raggiunto il limite massimo di istanze, gioca prima a quelle giÃ  create", dBack);
																			return;
																		}

																		var d = new Date();
																		d.setDate(d.getDate()+7);
																		var long_date2 = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																		connection.query('INSERT INTO dungeon_list (name, rooms, min_rank, finish_date, creator_id) VALUES ("' + newname + '",' + dungeon_rooms + ',' + dungeon_rank + ',"' + long_date2 + '",' + player_id + ')', function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('SELECT * FROM dungeon_list WHERE name = "' + newname + '"', function(err, rows, fields){
																				var dungeon_id = rows[0].id;
																				var dungeon_name = rows[0].name;

																				var duration = rows[0].duration;
																				if (duration >= max_duration){
																					bot.sendMessage(message.chat.id, "Questo dungeon Ã¨ giÃ  pieno di esploratori, aspetta che qualcuno esca o genera una nuova istanza.", dBack);
																					return;
																				}

																				connection.query('UPDATE dungeon_list SET duration = duration+1 WHERE id = ' + dungeon_id, function (err, rows, fields){
																					if (err) throw err;

																					connection.query('INSERT INTO dungeon_status (player_id, dungeon_id, room_id, finish_time) VALUES (' + player_id + ',' + dungeon_id + ',1,"' + long_date + '")', function(err, rows, fields) {
																						if (err) throw err;
																						bot.sendMessage(message.chat.id, "Sei stato aggiunto alla Lista Avventurieri del dungeon *" + dungeon_name + "*!", dBack);
																					});
																				});
																			});
																		});
																	});
																}else{
																	var name2 = answer.text.substring(0, answer.text.indexOf("(")-1);

																	if (name2.match(/\d+/g) == null){
																		bot.sendMessage(message.chat.id, "Istanza non valida", dBack);
																		return;
																	}

																	connection.query('SELECT * FROM dungeon_list WHERE name = "' + name2 + '"', function(err, rows, fields) {
																		if (err) throw err;

																		if (Object.keys(rows).length == 0){
																			bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
																			return;
																		}

																		if (player_rank < rows[0].min_rank){
																			bot.sendMessage(message.chat.id, "Sali di rango per iniziare questo dungeon", dBack);
																			return;
																		}

																		var dungeon_id = rows[0].id;
																		var dungeon_name = rows[0].name;

																		var duration = rows[0].duration;
																		var creator_id = rows[0].creator_id;
																		var creation = rows[0].creation_date;
																		var finish = rows[0].finish_date;

																		var long_date_creation = toDate("it", creation);
																		var long_date_finish = toDate("it", finish);

																		var confDg = {
																			parse_mode: "HTML",
																			reply_markup: {
																				resize_keyboard: true,
																				one_time_keyboard: true,
																				"keyboard": [["Si"],["Torna al dungeon"]]
																			}
																		};

																		connection.query('SELECT nickname, room_id FROM dungeon_status S, dungeon_list L, player P WHERE L.id = ' + dungeon_id + ' AND L.id = S.dungeon_id AND S.player_id = P.id', function(err, rows, fields) {
																			if (err) throw err;

																			var playerlist = "";
																			if (Object.keys(rows).length > 0){
																				playerlist = "\n";
																				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																					playerlist += "> " + rows[i].nickname + " (stanza " + rows[i].room_id + ")\n";
																				};
																				playerlist += "\n";
																			};

																			connection.query('SELECT nickname FROM player WHERE id = ' + creator_id, function(err, rows, fields) {
																				if (err) throw err;

																				var creator_name = "?";
																				if (Object.keys(rows).length > 0){
																					creator_name = rows[0].nickname;
																				}

																				bot.sendMessage(message.chat.id, "<i>" + name2 + "</i>\n<b>Data creazione</b>: " + long_date_creation + "\n<b>Creatore dell'istanza</b>: " + creator_name +
																								"\n<b>Data crollo</b>: " + long_date_finish + "\n<b>Esploratori al suo interno</b>: " + duration + "/" + max_duration + "\n" + 
																								playerlist + "Continuare?", confDg).then(function() {
																					answerCallbacks[message.chat.id] = function(answer) {
																						if (answer.text.toLowerCase() == "si"){
																							connection.query('SELECT duration FROM dungeon_list WHERE name = "' + name2 + '"', function(err, rows, fields) {
																								if (err) throw err;
																								if (rows[0].duration >= max_duration){
																									bot.sendMessage(message.chat.id, "Questo dungeon Ã¨ giÃ  pieno di esploratori, aspetta che qualcuno esca o genera una nuova istanza.", dBack);
																									return;
																								}
																								connection.query('UPDATE dungeon_list SET duration = duration+1 WHERE id = ' + dungeon_id, function (err, rows, fields){
																									if (err) throw err;
																									connection.query('INSERT INTO dungeon_status (player_id, dungeon_id, room_id, finish_time) VALUES (' + player_id + ',' + dungeon_id + ',1,"' + long_date + '")', function(err, rows, fields) {
																										if (err) throw err;
																										bot.sendMessage(message.chat.id, "Sei stato aggiunto alla Lista Avventurieri del dungeon *" + dungeon_name + "*!", dBack);
																										setAchievement(message.chat.id, player_id, 27, 1);
																									});
																								});
																							});
																						};
																					};
																				});
																			});
																		});
																	});
																};
															};
														};
													});
												});
											});
										});
									});
								};
							};
						});
					});
				}else{

					if (dungeon_time != null){
						var d = new Date(dungeon_time);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

						var dVarco = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": [["Si"],["Prosegui il dungeon"],["Torna al menu"]]
							}
						};

						bot.sendMessage(message.chat.id, "Puoi tornare nei dungeon alle " + short_date + "\nVuoi utilizzare un Varco Temporale per annullare l'attesa?", dVarco).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text.toLowerCase() == "si"){

									if (player_dungeon_skip >= 3){
										bot.sendMessage(message.chat.id, "Puoi usare un Varco Temporale solamente 3 volte al giorno", back);
										return;
									}

									connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 645', function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "Non possiedi un Varco Temporale", back);
											return;
										}
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 645 LIMIT 1', function(err, rows, fields) {
											connection.query('UPDATE player SET dungeon_time = NULL, dungeon_skip = dungeon_skip+1 WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Puoi tornare nel dungeon!", back);
											});
										});
									});
								}
							};
						});
						return;
					}

					var dNav = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["â˜ ï¸","â¬†ï¸","ðŸ”‘"],["â¬…ï¸","âš’","âž¡ï¸"],["Scappa","Torna al menu"]]
						}
					};

					var dNext = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Prosegui il dungeon"],["Torna al menu"]]
						}
					};

					var dNext2 = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Prosegui"],["Torna al menu"]]
						}
					};

					var dStart = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Entra nel dungeon"],["Torna al menu"]]
						}
					};

					var dBattle = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Attacca","Scappa"],["Torna al menu"]]
						}
					};

					var dChest = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Prendi"],["Torna al menu"]]
						}
					};

					var dPeople = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Aiuta","Ignora"],["Torna al menu"]]
						}
					};

					var dPotions = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Segui la Vecchia","Ignora"],["Torna al menu"]]
						}
					};

					var dButtons = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["1","2","3"],["4","5","6"],["Scappa"],["Torna al menu"]]
						}
					};

					var dKeys = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Tipo 1: Scorciatoia"],["Tipo 2: Rivelazione"],["Torna al dungeon"]]
						}
					};

					var dungeon_id = parseInt(rows[0].dungeon_id);
					var room_id = parseInt(rows[0].room_id);
					var monster_id = rows[0].monster_id;
					var last_dir = rows[0].last_dir;
					var room_time = new Date(rows[0].room_time);
					var param = rows[0].param;
					var finish_time = new Date(rows[0].finish_time);

					if (rows[0].room_time != null){
						var now = new Date();
						var min = Math.round(((room_time - now)/1000)/60);
						if (min >= 0){
							if (min > 0){
								bot.sendMessage(message.chat.id, "Sei impegnato nel dungeon ancora " + min + " minuti", dNext);
							}else{
								bot.sendMessage(message.chat.id, "Sei impegnato nel dungeon ancora per qualche secondo", dNext);
							}
							return;
						}else{
							connection.query('UPDATE dungeon_status SET room_time = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
							});
						}
					}

					connection.query('UPDATE `player` SET magic_to = 2 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
					});

					var text = "";

					connection.query('SELECT * FROM dungeon_rooms WHERE dungeon_id = ' + dungeon_id, function(err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0){
							connection.query('SELECT * FROM dungeon_list WHERE id = ' + dungeon_id, function(err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0){
									connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Il dungeon corrispondente non esiste piÃ¹, selezionane un altro.", back);
									});
									return;
								}

								bot.sendMessage(message.chat.id, "Il dungeon Ã¨ in costruzione, attendi.");

								var rooms = parseInt(rows[0].rooms);
								var id = rows[0].id;

								//	Mostro: > 10
								//	Scrigno: 1
								//	Monete: 2
								//	Trappola: 3
								//	Viandante: 4
								//	Trasporto: 5
								//	Persone in pericolo: 6
								//	Vecchia strega: 7
								//	Elementale: 8
								//	Divisa in due: 9
								//	Spada o bottino: 10
								//	Fontana di Mana: 0
								//  Fessura nel muro: -1
								//  Ascia Gigante: -2
								//	Gabbia con parola: -3
								//	Predone scambio: -4
								//	Meditazione: -5
								//	Desideri: -6
								//	Drago di TheLast: -7

								var arr = [];
								var p1 = Math.round((rooms*3)/100*60);
								var rand = 0;
								var limitS = 0; //Limitazione spawn spade

								console.log("Generazione nuovo dungeon con " + rooms + " stanze...");

								for (var i = 0; i < (rooms*3); i++) {
									if (i < p1){
										rand = Math.round(Math.random()*10+(rooms+1)); //per evitare che venga generato 10, cioÃ¨ un errore dove non trova il mostro
										arr.push([rand]);
									}else{
										rand = Math.round(Math.random()*21-11);		//-11 a +10
										//	if (rand == 10){
										//		limitS++;
										//	}
										//	if ((rand == 10) && (limitS >= 30)){
										//		i--;
										//	}else{
										arr.push([rand]);
										//	}
									}
								}

								arr = shuffle(arr);

								var arr1 = arr.slice(0, rooms);
								var arr2 = arr.slice(rooms, rooms*2);
								var arr3 = arr.slice(rooms*2, rooms*3);

								for (var i = 0; i < rooms; i++) {
									top = arr1[i];
									right = arr2[i];
									left = arr3[i];
									connection.query('INSERT INTO dungeon_rooms (room_id, dungeon_id, player_id, dir_top, dir_right, dir_left) VALUES (' + (i+1) + ',' + dungeon_id + ',' + player_id + ',' + top + ',' + right + ',' + left + ')', function(err, rows, fields) {
										if (err) throw err;
									});
									if ((top == 4) || (right == 4) || (left == 4)){
										connection.query('SELECT id, value, estimate FROM item WHERE craftable = 0 AND rarity NOT IN ("UE","A","H","S","U","IN") ORDER BY RAND() LIMIT 3', function (err, rows, fields) {
											if (err) throw err;

											var item1 = rows[0].id;
											var item2 = rows[1].id;
											var item3 = rows[2].id;

											var est1 = parseInt(rows[0].estimate);
											var est2 = parseInt(rows[1].estimate);
											var est3 = parseInt(rows[2].estimate);

											var price1 = Math.round(Math.random()*(est1*0.1)+(est1));
											var price2 = Math.round(Math.random()*(est2*0.1)+(est2));
											var price3 = Math.round(Math.random()*(est3*0.1)+(est3));

											connection.query('INSERT INTO dungeon_market (room_id, dungeon_id, item_1, item_2, item_3, price_1, price_2, price_3) ' +
															 'VALUES (' + (this.i+1) + ',' + dungeon_id + ',' + item1 + ',' + item2 + ',' + item3 + ',' + price1 + ',' + price2 + ',' + price3 + ')', function(err, rows, fields) {
												if (err) throw err;
											});
										}.bind( {i: i} ));
									}
									if ((top == -4) || (right == -4) || (left == -4)){
										connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity NOT IN ("UE","A","H","S","U","IN") ORDER BY RAND() LIMIT 2', function (err, rows, fields) {
											if (err) throw err;

											var item1 = rows[0].id;
											var item2 = rows[1].id;

											connection.query('INSERT INTO dungeon_trade (room_id, dungeon_id, item_1, item_2) ' +
															 'VALUES (' + (this.i+1) + ',' + dungeon_id + ',' + item1 + ',' + item2 + ')', function(err, rows, fields) {
												if (err) throw err;
											});
										}.bind( {i: i} ));
									}
									if ((top == -11) || (right == -11) || (left == -11)){
										connection.query('SELECT COUNT(id) As cnt FROM dungeon_well WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
											if (err) throw err;

											if (rows[0].cnt == 0){
												connection.query('INSERT INTO dungeon_well (dungeon_id) VALUES (' + dungeon_id + ')', function(err, rows, fields) {
													if (err) throw err;
												});
											};
										});
									}
								}

								console.log("Generazione completata, id " + (id+1));

								connection.query('UPDATE dungeon_status SET room_id = 1 WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il dungeon Ã¨ stato creato, ora inizia l'esplorazione!", dStart);
								});
							});
						}else{

							connection.query('SELECT rooms FROM dungeon_list WHERE id = ' + dungeon_id, function (err, rows, fields) {
								if (err) throw err;

								var room_num = rows[0].rooms;

								connection.query('SELECT * FROM dungeon_rooms WHERE room_id = ' + room_id + ' AND dungeon_id = ' + dungeon_id, function(err, rows, fields) {
									if (err) throw err;

									if (monster_id != 0){
										bot.sendMessage(message.chat.id, "Stai combattendo contro un mostro!\nNon puoi proseguire senza averlo prima sconfitto.", dBattle).then(function() {
											answerCallbacks[message.chat.id] = function(answer) {
												if (answer.text == "Scappa"){
													bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															if (answer.text.toLowerCase() == "si"){

																var rand = Math.random()*100;
																if (rand < 20){
																	var dmg = Math.round(player_total_life*20/100);
																}else{
																	var dmg = Math.round(player_total_life*30/100);
																}

																var exText = "";

																connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});

																if (player_life - dmg <= 0){
																	exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	if (player_rank > 0){
																		connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																}else{
																	exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																	var d = new Date();
																	d.setHours(d.getHours() + (wait_dungeon-1));
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});							
																bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);

															}
														}
													});
												}
											};
										});
										return;
									}

									var now = new Date();
									var min_tot = Math.round(((finish_time - now)/1000)/60);
									var ore = Math.floor(min_tot/60);
									var min = Math.round(min_tot%60);

									min = ('0' + min).slice(-2);

									text = "Stanza " + room_id + "/" + room_num + " (" + ore + ":" + min + " rimanenti)\n";

									if (room_id == 1){
										text += "Decidi di addentrarti nel dungeon. Nell'oscuritÃ  intravedi una strada e vari corridoi che si perdono a vista d'occhio. Quale direzione scegli di intraprendere?";
									}else{
										var dText = 	[
											"L'atmosfera cupa e misteriosa ti inquieta, hai davanti a te 3 strade, dove prosegui?",
											"Una stanza di fronte a te mostra 3 porte in 3 diverse direzioni, dove decidi di proseguire?",
											"Indeciso sulla direzione, rimani a riflettere sperando che sia il miglior percorso, quale strada scegli?",
											"Di fronte a te diverse strade che portano in direzioni diverse, dove ti dirigi?"
										];
										var len = parseInt(Object.keys(dText).length)-1;
										var index = Math.round(Math.random()*len);

										text += dText[index];
									}

									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Sei arrivato alla stanza finale! Per uscire devi sconfiggere la Bestia del Dungeon.");

										connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + (parseInt(room_num)+5) + ' ORDER BY RAND()', function (err, rows, fields){
											if (err) throw err;
											if (Object.keys(rows).length == 0){
												bot.sendMessage(message.chat.id, "Errore", back);
												return;
											}
											connection.query('UPDATE dungeon_status SET boss_battle = 1, monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ' WHERE player_id = ' + player_id, function (err, rows, fields){
												if (err) throw err;
											});

											setTimeout(function() {
												bot.sendMessage(message.chat.id, "Incontri una Bestia *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo e completare il dungeon, oppure scappare.", dBattle).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Scappa"){
															bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if (answer.text.toLowerCase() == "si"){

																		var rand = Math.random()*100;
																		if (rand < 50){
																			var dmg = Math.round(player_total_life*20/100);
																		}else{
																			var dmg = Math.round(player_total_life*30/100);
																		}

																		var exText = "";

																		connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});

																		if (player_life - dmg <= 0){
																			exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																			var d = new Date();
																			d.setHours(d.getHours() + wait_dungeon_long);
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																			if (player_rank > 0){
																				connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																		}else{
																			exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																			var d = new Date();
																			d.setHours(d.getHours() + (wait_dungeon-1));
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																		connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																		bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																	}
																}
															});
														}
													};
												});
											}, 1000);
										});
										return;
									}


									var dir_top = parseInt(rows[0].dir_top);
									var dir_right = parseInt(rows[0].dir_right);
									var dir_left = parseInt(rows[0].dir_left);

									var dir = null;

									if (last_dir != null){
										text = "Sei tornato esattamente nel punto in cui eri prima. Ora prosegui.";
										dNav = dNext2;
									}

									bot.sendMessage(message.chat.id, text, dNav).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text == "â¬†ï¸"){
												dir = dir_top;
											}else if (answer.text == "â¬…ï¸"){
												dir = dir_left;
											}else if (answer.text == "âž¡ï¸"){
												dir = dir_right;
											}else if (answer.text == "ðŸ”‘"){
												bot.sendMessage(message.chat.id, "Puoi utilizzare le chiavi per sfruttare diverse funzionalitÃ ", dKeys).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Tipo 1: Scorciatoia"){
															bot.sendMessage(message.chat.id, "Puoi prendere una scorciatoia utilizzando una Chiave Tipo 1, procedi?", dYesNo).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if (answer.text.toLowerCase() == "si"){
																		connection.query('SELECT id FROM inventory WHERE item_id = 604 AND player_id = ' + player_id, function(err, rows, fields){
																			if (err) throw err;
																			if (Object.keys(rows).length == 0){
																				bot.sendMessage(message.chat.id, "Non hai abbastanza Chiavi Tipo 1", dBack);
																			}else{
																				connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 604 LIMIT 1', function(err, rows, fields){
																					if (err) throw err;
																					connection.query('UPDATE dungeon_status SET room_id = room_id+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																						if (err) throw err;
																						bot.sendMessage(message.chat.id, "Hai preso una scorciatoia!", dBack);
																					});				
																				});
																			}
																		});
																	}
																}
															});
														}else if (answer.text == "Tipo 2: Rivelazione"){
															bot.sendMessage(message.chat.id, "Puoi rivelare le stanze utilizzando una Chiave Tipo 2, procedi?", dYesNo).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if (answer.text.toLowerCase() == "si"){
																		connection.query('SELECT id FROM inventory WHERE item_id = 605 AND player_id = ' + player_id, function(err, rows, fields){
																			if (err) throw err;
																			if (Object.keys(rows).length == 0){
																				bot.sendMessage(message.chat.id, "Non hai abbastanza Chiavi Tipo 2", dBack);
																			}else{
																				connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 605 LIMIT 1', function(err, rows, fields){
																					if (err) throw err;
																					var text = "Scelta stanza successiva:\n";
																					var i = 0;
																					var d = 0;
																					var t = "";
																					console.log(dir_top, dir_right, dir_left);
																					while (i < 3){
																						if (i == 0){
																							d = dir_top;
																							t = "Avanti";
																						}else if (i == 1){
																							d = dir_right;
																							t = "Destra";
																						}else if (i == 2){
																							d = dir_left;
																							t = "Sinistra";
																						}
																						if (d > 10){
																							text += "*" + t + ":* Mostro\n";
																						}else if (d == 1){
																							text += "*" + t + ":* Scrigno\n";
																						}else if (d == 2){
																							text += "*" + t + ":* Monete\n";
																						}else if (d == 3){
																							text += "*" + t + ":* Trappola\n";
																						}else if (d == 4){
																							text += "*" + t + ":* Viandante\n";
																						}else if (d == 5){
																							text += "*" + t + ":* Leve\n";
																						}else if (d == 6){
																							text += "*" + t + ":* Persona in pericolo\n";
																						}else if (d == 7){
																							text += "*" + t + ":* Vecchina\n";
																						}else if (d == 8){
																							text += "*" + t + ":* Pulsantiera\n";
																						}else if (d == 9){
																							text += "*" + t + ":* Stanza divisa in due\n";
																						}else if (d == 10){
																							text += "*" + t + ":* Spada o bottino\n";
																						}else if (d == 0){
																							text += "*" + t + ":* Fontana di Mana\n";
																						}else if (d == -1){
																							text += "*" + t + ":* Fessura nel Muro\n";
																						}else if (d == -2){
																							text += "*" + t + ":* Ascia Gigante\n";
																						}else if (d == -3){
																							text += "*" + t + ":* Gabbia Saggia\n";
																						}else if (d == -4){
																							text += "*" + t + ":* Predone del Deserto\n";
																						}else if (d == -5){
																							text += "*" + t + ":* Stanza della Meditazione\n";
																						}else if (d == -6){
																							text += "*" + t + ":* I Desideri\n";
																						}else if (d == -7){
																							text += "*" + t + ":* Il Drago del Soldato\n";
																						}else if (d == -8){
																							text += "*" + t + ":* Stanza Vuota\n";
																						}else if (d == -9){
																							text += "*" + t + ":* Il Marinaio con il Dado\n";
																						}else if (d == -10){
																							text += "*" + t + ":* Le Due Porte\n";
																						}else if (d == -11){
																							text += "*" + t + ":* Pozzo Ricco\n";
																						}
																						i++;
																					}

																					bot.sendMessage(message.chat.id, text, dBack);
																				});
																			}
																		});
																	}
																}
															});
														}
													};
												});
												return;
											}else if (answer.text == "Scappa"){
												bot.sendMessage(message.chat.id, "Sicuro di voler uscire dal dungeon? Se possiedi un Kit Fuga lo consumerai e non dovrai attendere prima di rientrare. In ogni caso perderai 1 punto rango.", dYesNo).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text.toLowerCase() == "si"){
															connection.query('SELECT * FROM inventory WHERE item_id = 616 AND player_id = ' + player_id, function (err, rows, fields){
																if (err) throw err;
																var extra = "";
																if (Object.keys(rows).length > 0){
																	connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 616 LIMIT 1', function (err, rows, fields) {
																		if (err) throw err;
																	});
																	extra = " scappando con un Kit Fuga!";
																}else{
																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																if (player_rank > 0){
																	connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																}
																connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai deciso di rinunciare al dungeon" + extra, back);
																});
															});
														}
													}
												});
												return;
											}else if (answer.text == "â˜ ï¸"){
												connection.query('SELECT name, COUNT(name) As num FROM item, inventory WHERE item.name LIKE "Pass%" AND inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' GROUP BY item.name', function (err, rows, fields){
													if (err) throw err;

													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "Non possiedi nessun pass.", dBack);
														return;
													}

													var iKeys = [];
													for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
														iKeys.push([rows[i].name + " (" + rows[i].num + ")"]);
													}
													iKeys.push(["Torna al dungeon"]);

													var dPass = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															one_time_keyboard: true,
															"keyboard": iKeys
														}
													};

													bot.sendMessage(message.chat.id, "Puoi utilizzare un *Pass* per chiedere aiuto ad un tuo compagno di team (di pari rinascita) e farlo entrare nel dungeon al posto tuo, il Pass *Bronzo* ti " +
																	"permette di chiedere aiuto solo quando disponi del 10% di vita, il Pass *Argento* del 50% mentre " +
																	"il Pass *Oro* in qualsiasi momento", dPass).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {

															if (answer.text != "Torna al dungeon"){
																var passName = answer.text.substring(0, answer.text.indexOf("(")-1);

																connection.query('SELECT name, item.id FROM item, inventory WHERE item.name = "' + passName + '" AND inventory.item_id = item.id AND inventory.player_id = ' + player_id, function (err, rows, fields){
																	if (err) throw err;
																	if (Object.keys(rows).length == 0){
																		bot.sendMessage(message.chat.id, "Non possiedi il pass selezionato.", dBack);
																		return;
																	}else{

																		var passId = rows[0].id;

																		if (passId == 608){
																			if (player_life > (player_total_life/100)*10){
																				bot.sendMessage(message.chat.id, "Hai troppa salute per utilizzare questo tipo di pass", dBack);
																				return;
																			}
																		}else if (passId == 609){
																			if (player_life > (player_total_life/100)*50){
																				bot.sendMessage(message.chat.id, "Hai troppa salute per utilizzare questo tipo di pass", dBack);
																				return;
																			}
																		}else if (passId == 610){
																			//Okay
																		}else{
																			bot.sendMessage(message.chat.id, "Pass non valido", dBack);
																			return;
																		}

																		connection.query('SELECT team_id FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields){
																			if (err) throw err;
																			var team_id = rows[0].team_id;
																			if (Object.keys(rows).length == 0){
																				bot.sendMessage(message.chat.id, "Devi essere in un team per utilizzare questa funzionalitÃ .", dBack);
																				return;
																			}else{
																				connection.query('SELECT nickname FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + rows[0].team_id + ' AND player_id != ' + player_id, function (err, rows, fields){
																					if (err) throw err;
																					if (Object.keys(rows).length == 0){
																						bot.sendMessage(message.chat.id, "Nessun compagno di team disponibile.", dBack);
																						return;
																					}else{
																						var iKeys2 = [];
																						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																							iKeys2.push([rows[i].nickname]);
																						}
																						iKeys2.push(["Torna al dungeon"]);

																						var dTeam = {
																							parse_mode: "Markdown",
																							reply_markup: {
																								resize_keyboard: true,
																								one_time_keyboard: true,
																								"keyboard": iKeys2
																							}
																						};

																						bot.sendMessage(message.chat.id, "Seleziona il compagno di team con cui scambiarti, ricorda che questo utente non deve essere in un dungeon.", dTeam).then(function() {
																							answerCallbacks[message.chat.id] = function(answer) {
																								connection.query('SELECT nickname, dungeon_time, player.reborn, player.id, player.chat_id FROM team_player, player WHERE player.nickname = "' + answer.text + '" AND player.id = team_player.player_id AND team_id = ' + team_id + ' AND player_id != ' + player_id, function (err, rows, fields){
																									if (err) throw err;
																									if (Object.keys(rows).length == 0){
																										bot.sendMessage(message.chat.id, "Utente non valido.", dBack);
																										return;
																									}else{
																										var new_playerid = rows[0].id;
																										var chat_id = rows[0].chat_id;
																										var pass_reborn = rows[0].reborn;

																										if (pass_reborn < player_reborn){
																											bot.sendMessage(message.chat.id, "Puoi usare il pass solo verso utenti con rinascita pari o superiore", dBack);
																											return;		
																										}

																										if (rows[0].dungeon_time != null){
																											bot.sendMessage(message.chat.id, "L'utente Ã¨ in attesa dungeon", dBack);
																											return;
																										}

																										connection.query('SELECT name, item.id FROM item, inventory WHERE item.name = "' + passName + '" AND inventory.item_id = item.id AND inventory.player_id = ' + player_id, function (err, rows, fields){
																											if (err) throw err;
																											if (Object.keys(rows).length == 0){
																												bot.sendMessage(message.chat.id, "Non possiedi il pass selezionato.", dBack);
																												return;
																											}

																											connection.query('SELECT id FROM dungeon_status WHERE player_id = ' + new_playerid, function (err, rows, fields) {
																												if (err) throw err;
																												if (Object.keys(rows).length == 0){
																													connection.query('DELETE FROM inventory WHERE item_id = ' + passId + ' AND player_id = ' + player_id + ' LIMIT 1', function (err, rows, fields){
																														if (err) throw err;
																													});
																													connection.query('UPDATE dungeon_status SET pass = ' + player_id + ', player_id = ' + new_playerid + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																														if (err) throw err;

																														var d = new Date();
																														d.setHours(d.getHours() + wait_dungeon);
																														var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																														connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																															if (err) throw err;
																															bot.sendMessage(message.chat.id, "Hai completato lo scambio con il compagno di team!", back);
																															bot.sendMessage(chat_id, message.from.username.replace(new RegExp("_", "g"), " ") + " ha richiesto lo scambio con te nel dungeon!", dBack);
																															setAchievement(message.chat.id, player_id, 46, 1);
																														});
																													});
																												}else{
																													bot.sendMessage(message.chat.id, "L'utente selezionato Ã¨ attualmente in un dungeon", dBack);
																												}
																											});
																										});
																									}
																								});
																							};
																						});
																					}
																				});
																			}
																		});
																	}
																});
															}
														};
													});
												});
												return;
											}else if (answer.text == "Prosegui"){
												//Salta sotto
											}else if (last_dir == null){
												return;
											}

											if (last_dir != null){
												dir = last_dir;
											}

											var d = new Date();
											var sec = wait_room;

											if (abBonus > 0){
												sec -= abBonus;
											}
											//	if (crazyMode == 0){
											if ((player_class_id == 3) && (player_reborn == 3)){
												sec = sec-120;
											}
											if ((player_class_id == 9) && (player_reborn > 1)){
												sec = sec-120;
											}
											if ((player_class_id == 9) && (player_reborn == 5)){
												sec = sec-180;
											}
											if ((player_class_id == 3) && (player_reborn >= 4)){
												sec = sec-300;
											}
											//	}
											d.setSeconds(d.getSeconds() + sec);

											var room_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
											var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

											connection.query('UPDATE dungeon_status SET last_dir = ' + dir + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
											});

											if (dir > 10){
												var monsterLev = dir-10;

												if (nightMode == 1){
													monsterLev += 5;
													console.log("MonsterLev: " + monsterLev);
												}

												connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields){
													if (err) throw err;
													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "Errore selezione mostro: " + monsterLev, back);
														return;
													}
													connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields){
														if (err) throw err;
													});
													bot.sendMessage(message.chat.id, "Incontri un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															if (answer.text == "Scappa"){
																bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function() {
																	answerCallbacks[message.chat.id] = function(answer) {
																		if (answer.text.toLowerCase() == "si"){

																			var rand = Math.random()*100;
																			if (rand < 50){
																				var dmg = Math.round(player_total_life*20/100);
																			}else{
																				var dmg = Math.round(player_total_life*30/100);
																			}

																			var exText = "";

																			connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});

																			if (player_life - dmg <= 0){
																				exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																				var d = new Date();
																				d.setHours(d.getHours() + wait_dungeon_long);
																				var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																				connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;
																				});
																				connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;
																				});
																				connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																					if (err) throw err;
																				});
																				if (player_rank > 0){
																					connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																						if (err) throw err;
																					});
																				}
																			}else{
																				exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																				var d = new Date();
																				d.setHours(d.getHours() + (wait_dungeon-1));
																				var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																				connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																			connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																			bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																		}
																	}
																});
															}
														};
													});
												});
											}else if (dir == 1){
												bot.sendMessage(message.chat.id, "Nella stanza sembra esserci uno *scrigno* pronto per essere aperto, cosa fai?", dChest).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Prendi"){
															var rand = Math.round((Math.random()*99)+1);
															var rand2 = Math.round((Math.random()*99)+1);

															if (rand2 < 70){
																var chest_id = 0;
																if (rand <= 60){				//60%
																	chest_id = 3;
																}else if ((rand > 60) && (rand <= 80)){		//20%
																	chest_id = 4;
																}else if ((rand > 80) && (rand <= 98)){	//10%
																	chest_id = 5;
																}else{
																	chest_id = 0;
																}

																if (chest_id > 0){
																	connection.query('SELECT name FROM chest WHERE id = ' + chest_id, function (err, rows, fields){
																		if (err) throw err;
																		var chestName = rows[0].name;
																		connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + player_id + ',' + chest_id + ')', function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai trovato uno *" + chestName + "*!", dNext);
																		});
																	});
																}else{
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',604)', function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Aprendo uno strano scrigno hai trovato una *Chiave Tipo 1*!", dNext);
																	});
																}
															}else{
																var monsterLev = Math.round(Math.random()*Math.round(room_num/2)+Math.round(room_num/2));

																connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields){
																	if (err) throw err;
																	if (Object.keys(rows).length == 0){
																		bot.sendMessage(message.chat.id, "Errore selezione mostro: " + monsterLev, back);
																		return;
																	}
																	connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields){
																		if (err) throw err;
																	});
																	bot.sendMessage(message.chat.id, "Hai trovato uno Scrigno! Ma appena lo tocchi esso assume le sembianze di un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function() {
																		answerCallbacks[message.chat.id] = function(answer) {
																			if (answer.text == "Scappa"){
																				bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function() {
																					answerCallbacks[message.chat.id] = function(answer) {
																						if (answer.text.toLowerCase() == "si"){

																							var rand = Math.random()*100;
																							if (rand < 50){
																								var dmg = Math.round(player_total_life*20/100);
																							}else{
																								var dmg = Math.round(player_total_life*30/100);
																							}

																							var exText = "";

																							connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							if (player_life - dmg <= 0){
																								exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																								var d = new Date();
																								d.setHours(d.getHours() + wait_dungeon_long);
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																									if (err) throw err;
																								});
																								if (player_rank > 0){
																									connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																							}else{
																								exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																								var d = new Date();
																								d.setHours(d.getHours() + (wait_dungeon-1));
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																							connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																								if (err) throw err;
																							});
																							bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																						}
																					}
																				});
																			}
																		};
																	});
																});
																connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																return;
															}
														}else if (answer.text == "Ignora"){
															bot.sendMessage(message.chat.id, "Hai ignorato lo Scrigno", dNext);
														}else{
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
													}
												});	
											}else if (dir == 2){
												bot.sendMessage(message.chat.id, "Al centro della stanza vedi un mucchietto di monete, cosa fai?", dChest).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Prendi"){
															if (player_rank == 0){
																player_rank = 1;
															}
															var rand = Math.round(Math.random()*(player_rank*100))+(player_rank*100);
															connection.query('UPDATE player SET money = money+' + rand + ' WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai ricevuto *" + rand + "* Â§!", dNext);
															});
														}else{
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
													}
												});	
											}else if (dir == 3){
												var dmg = Math.round(Math.random()*(player_life/10*2)+1);
												connection.query('UPDATE player SET life = life - ' + dmg + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;

													var dText = 	[
														"Camminando per raggiungere la prossima stanza, una trappola per orsi ti ha ferito la gamba, hai perso " + dmg + " hp!",
														"Percorrendo un corridoio scivoli su una pozzanghera giallognola e tiri una testata contro un muro in pietra, perdi " + dmg + " hp!",
														"Uno strano pulsante rosso come un pomodoro ti incuriosisce, lo premi e ti cade addosso un pietrone, facendoti perdere " + dmg + " hp!",
														"Vedi un Nano della terra di Grumpi e ti chiedi come faccia a trovarsi in un luogo del genere, girandosi si rivela essere un goblin che ti colpisce togliendoti " + dmg + " hp!"
													];
													var len = parseInt(Object.keys(dText).length)-1;
													var index = Math.round(Math.random()*len);

													text = dText[index];

													bot.sendMessage(message.chat.id, text, dNext);
												});
												connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
												connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
											}else if (dir == 4){
												var iKeys = [];
												var items = [];
												var prices = [];

												var text = "Nella stanza incontri un viandante, ti propone alcuni oggetti a buon prezzo, puoi acquistarne uno oppure ignorarlo e procedere.\n";

												connection.query(	'SELECT I.id As item1id, DM.price_1 As price1, DM.price_2 As price2, DM.price_3 As price3, I.value As item1val, I.name As item1n, I2.id As item2id, I2.value As item2val, I2.name As item2n, I3.id As item3id, I3.value As item3val, I3.name As item3n ' +
																 'FROM dungeon_market DM INNER JOIN item I ON DM.item_1 = I.id INNER JOIN item I2 ON DM.item_2 = I2.id INNER JOIN item I3 ON DM.item_3 = I3.id ' +
																 'WHERE DM.dungeon_id = ' + dungeon_id + ' AND DM.room_id = ' + room_id, function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0){
														connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Errore selezione oggetti mercato", dNext);
														});
														return;
													}

													var multi = 15;
													var newprice = 0;
													if (rows[0].price1 == 0){
														var multi = 15;
														text += "\n> " + rows[0].item1n + " (" + (rows[0].item1val*multi) + " Â§)";
														text += "\n> " + rows[0].item2n + " (" + (rows[0].item2val*multi) + " Â§)";
														text += "\n> " + rows[0].item3n + " (" + (rows[0].item3val*multi) + " Â§)";
													}else{
														newprice = 1;
														text += "\n> " + rows[0].item1n + " (" + (rows[0].price1) + " Â§)";
														text += "\n> " + rows[0].item2n + " (" + (rows[0].price2) + " Â§)";
														text += "\n> " + rows[0].item3n + " (" + (rows[0].price3) + " Â§)";
													}
													iKeys.push(["Accetta Oggetto 1"]);
													iKeys.push(["Accetta Oggetto 2"]);
													iKeys.push(["Accetta Oggetto 3"]);
													items.push(rows[0].item1id);
													items.push(rows[0].item2id);
													items.push(rows[0].item3id);
													prices.push(rows[0].price1);
													prices.push(rows[0].price2);
													prices.push(rows[0].price3);

													iKeys.push(["Ignora"]);
													iKeys.push(["Torna al menu"]);

													var dItems = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															one_time_keyboard: true,
															"keyboard": iKeys
														}
													};

													bot.sendMessage(message.chat.id, text, dItems).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															var ogg = answer.text;
															if (ogg == "Ignora"){
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Decidi di ignorare il viandante e prosegui", dNext);
																	});
																});
																return;
															}else if (ogg == "Torna al menu"){
																return;
															}else{
																var itemN = parseInt(ogg.substring(Object.keys(ogg).length-1));

																if ((itemN > 3) || (itemN < 1)){
																	bot.sendMessage(message.chat.id, "Il viandante non possiede questo oggetto", back);
																	return;
																}

																var item_id = items[itemN-1];
																var item_price = prices[itemN-1];

																//console.log(items, prices, item_id, item_price, newprice);

																if (item_id == undefined){
																	bot.sendMessage(message.chat.id, "Il viandante non possiede questo oggetto", back);
																	return;
																}
																if (item_price == undefined){
																	bot.sendMessage(message.chat.id, "Il viandante non possiede questo oggetto", back);
																	return;
																}

																connection.query('SELECT id, name, value FROM item WHERE id = ' + item_id, function(err, rows, fields) {
																	if (err) throw err;

																	if (newprice == 0){
																		item_price = rows[0].value*multi;
																	}

																	if (player_money - item_price < 0){
																		bot.sendMessage(message.chat.id, "Non hai abbastanza monete", back);
																		return;
																	}

																	console.log("PRICE: " + item_price);

																	bot.sendMessage(message.chat.id, "Acquistare " + rows[0].name + " per " + item_price + " Â§?", dYesNo).then(function() {
																		answerCallbacks[message.chat.id] = function(answer) {
																			if (answer.text.toLowerCase() == "si"){
																				connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + item_id + ')', function (err, rows, fields) {
																					if (err) throw err;
																					connection.query('UPDATE player SET money = money-' + item_price + ' WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;

																						connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																							if (err) throw err;
																						});

																						connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																							if (err) throw err;
																						});

																						bot.sendMessage(message.chat.id, "Acquisto completato!", dNext);
																					});
																				});
																			}
																		}
																	});
																});
															}
														}
													});
												});
											}else if (dir == 5){
												var rand = Math.round(Math.random()*100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Sinistra","Centro","Destra"],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Al centro della stanza ci sono 3 leve, quale spingi?", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if ((answer.text == "Sinistra") || (answer.text == "Centro") || (answer.text == "Destra")){
															if (rand <= 50){
																if (room_id > 2){
																	room_id--;
																	bot.sendMessage(message.chat.id, "Spingendo una leva si Ã¨ aperto un varco sotto di te! Torni alla stanza precedente.", dNext);
																}else{
																	bot.sendMessage(message.chat.id, "Spingendo una leva senti degli strani rumori, ma non succede nulla!", dNext);	
																}
															}else if ((rand > 50) && (rand <= 90)){
																room_id++;
																bot.sendMessage(message.chat.id, "Spingendo una leva senti degli strani rumori, e si apre la porta della stanza!", dNext);
															}else if (rand > 90){
																room_id += 2;
																bot.sendMessage(message.chat.id, "Spingendo una leva si apre un varco sul fianco della stanza, Ã¨ una scorciatoia che ti permette di avanzare di due stanze!", dNext);														
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = ' + room_id + ', last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});	
														}else{
															return;
														}
													}
												});
											}else if (dir == 6){
												var dText = 	[
													"una ragazza che sembra essere in difficoltÃ ",
													"un bambino che piange",
													"un uomo ferito e sanguinante",
													"una donna impaurita",
													"un anziano dolorante"
												];
												var len = parseInt(Object.keys(dText).length)-1;
												var index = Math.round(Math.random()*len);

												text = dText[index];

												bot.sendMessage(message.chat.id, "Appena entrato nella stanza vedi nell'angolo " + text + ", cosa fai?", dPeople).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Aiuta"){
															var rand = Math.random()*100;
															if (rand < 50){
																var monsterLev = Math.round(Math.random()*Math.round(room_num/2)+Math.round(room_num/2));

																connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields){
																	if (err) throw err;
																	if (Object.keys(rows).length == 0){
																		bot.sendMessage(message.chat.id, "Errore selezione mostro", back);
																		return;
																	}
																	connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields){
																		if (err) throw err;
																	});

																	bot.sendMessage(message.chat.id, "Decidi di toccare la persona davanti a te, ma questa si gira e sembra essere un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function() {
																		answerCallbacks[message.chat.id] = function(answer) {
																			if (answer.text == "Scappa"){
																				bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function() {
																					answerCallbacks[message.chat.id] = function(answer) {
																						if (answer.text.toLowerCase() == "si"){

																							var rand = Math.random()*100;
																							if (rand < 50){
																								var dmg = Math.round(player_total_life*20/100);
																							}else{
																								var dmg = Math.round(player_total_life*30/100);
																							}

																							var exText = "";

																							connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							if (player_life - dmg <= 0){
																								exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																								var d = new Date();
																								d.setHours(d.getHours() + wait_dungeon_long);
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																									if (err) throw err;
																								});
																								if (player_rank > 0){
																									connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																							}else{
																								exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																								var d = new Date();
																								d.setHours(d.getHours() + (wait_dungeon-1));
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																							connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																								if (err) throw err;
																							});
																							bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																						}
																					}
																				});
																			};
																		};
																	});
																});
																connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																return; // Non cancellare
															}else{
																if (rand > 90){
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',608)', function (err, rows, fields){
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Decidi di toccare la persona davanti a te, si gira e ti ringrazia per averla trovata, regalandoti un *Pass Bronzo*!", dNext);
																	});
																}else{
																	connection.query('SELECT id, name FROM item WHERE rarity = "R" AND craftable = 0 ORDER BY RAND()', function (err, rows, fields){
																		var itemName = rows[0].name;
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].id + ')', function (err, rows, fields){
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Decidi di toccare la persona davanti a te, si gira e ti ringrazia per averla trovata, regalandoti un *" + itemName + "*!", dNext);
																		});
																	});
																}
															}
														}else if (answer.text == "Ignora"){
															bot.sendMessage(message.chat.id, "Hai ignorato la persona", dNext);
														}else{
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});

														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
													};
												});										
											}else if (dir == 7){
												var dText = 	[
													"Un'anziana signora in lontananza ti chiama",
													"Una vecchina poco affidabile in lontananza attira la tua attenzione"
												];
												var len = parseInt(Object.keys(dText).length)-1;
												var index = Math.round(Math.random()*len);

												text = dText[index];

												bot.sendMessage(message.chat.id, "Aprendo la porta ti ritrovi in un ambiente aperto, con alberi e liane che ricoprono ogni cosa. " + text + ", cosa fai?", dPotions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Segui la Vecchia"){
															var rand = Math.random()*100;

															if (rand < 60){
																var potId = 94;
																var potN = "Pozione Grande";

																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + potId + ')', function(err, rows, fields){
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "La vecchina ha preparato una Pozione, e decide di regalartene un po' per aver avuto fiducia in lei. Ottieni cosÃ¬ *" + potN + "*", dNext);
																});
															}else{
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '", last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "La vecchina ha preparato una Pozione, e decidi di provarla, ma appena bevuta ti addormenti, al tuo risveglio sei nuovamente davanti alle 3 porte che ti avevano condotto in questa foresta.", dNext);
																});
																return; //NON CANCELLARE
															}	
														}else if (answer.text == "Ignora"){
															bot.sendMessage(message.chat.id, "Hai ignorato la Vecchia", dNext);
														}else{
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
													};
												});
											}else if (dir == 8){
												var type = 0;
												var d = new Date();
												var rand = Math.round(d.getHours()/4) % 2;

												if (rand == 1){
													type = 1;
													text = "Appena aperta la porta della stanza, un caldo esagerato ti avvolge, compare al centro una pulsantiera, probabilmente uno di quei bottoni potrebbe aprire la porta successiva.\n\nSalute: " + player_life + " hp";
												}else if (rand == 0){
													type = 2;
													text = "Appena aperta la porta della stanza, un freddo polare ti avvolge, appare una pulsantiera congelata, probabilmente uno di quei bottoni potrebbe aprire la porta successiva.\n\nSalute: " + player_life + " hp";
												}

												if ((param == null) || (param == undefined)){
													var randNum = Math.round(Math.random()*5+1);
													connection.query('UPDATE dungeon_status SET param = "' + randNum + '" WHERE player_id = ' + player_id, function (err, rows, fields){
														if (err) throw err;
													});
													param = randNum;
												}

												bot.sendMessage(message.chat.id, text, dButtons).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {

														if (answer.text == "Torna al menu"){
															return;
														}

														if (answer.text == "Scappa"){ 
															bot.sendMessage(message.chat.id, "Sicuro di voler uscire dal dungeon? Se possiedi un Kit Fuga lo consumerai e non dovrai attendere prima di rientrare. In ogni caso perderai 1 punto rango.", dYesNo).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if (answer.text.toLowerCase() == "si"){
																		connection.query('SELECT * FROM inventory WHERE item_id = 616 AND player_id = ' + player_id, function (err, rows, fields){
																			if (err) throw err;

																			var extra = "";
																			if (Object.keys(rows).length > 0){
																				connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 616 LIMIT 1', function (err, rows, fields) {
																					if (err) throw err;
																				});
																				extra = " scappando con un Kit Fuga!";
																			}else{
																				var d = new Date();
																				d.setHours(d.getHours() + wait_dungeon_long);
																				var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																				connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																			if (player_rank > 0){
																				connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																			connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(message.chat.id, "Hai deciso di rinunciare al dungeon" + extra, back);
																			});
																		});
																	}
																}
															});
															return;
														}

														if ((parseInt(answer.text) < 1 ) || (parseInt(answer.text > 6))){
															bot.sendMessage(message.chat.id,"Pulsante non valido, riprova", dBack);
															return;
														}else if ((parseInt(answer.text) >= 1 ) || (parseInt(answer.text <= 6))){

															var rand = Math.random()*200;

															if (parseInt(answer.text) != param){

																var damage = Math.round(Math.random()*(player_total_life/15)+(player_total_life/15));
																damage = Math.round(damage/2);

																connection.query('UPDATE player SET life = life - ' + damage + ' WHERE id = ' + player_id, function (err, rows, fields){
																	if (err) throw err;

																	var randKey = Math.random()*100;
																	if (randKey < 3){
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',605)', function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Si apre una piastrella del muro dal quale cade una *Chiave Tipo 2*!", dNext);
																		});
																	}

																	if (type == 1){
																		bot.sendMessage(message.chat.id, "Hai sbagliato pulsante! Il calore ti provoca una perdita pari a " + damage + " hp!", dNext);
																	}else if (type == 2){
																		bot.sendMessage(message.chat.id, "Hai sbagliato pulsante! Il gelo ti provoca una perdita pari a " + damage + " hp!", dNext);
																	}
																});

																if ((answer.text == (param/2)) && (rand < 1) && (player_reborn >= 3)){
																	connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',598)', function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Si apre una crepa nella parete, da cui esce un soffio di vento ottieni cosÃ¬ un *Soffio di Morte*!", mark);
																	});
																}

																if (player_life-damage <= 0){
																	bot.sendMessage(message.chat.id, "Sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.", back);

																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	if (player_rank > 0){
																		connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																}
															}else{
																if (rand < 5){
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',609)', function (err, rows, fields){
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai trovato il pulsante corretto! Sul soffitto si apre una botola dalla quale vedi scendere un foglietto, ottieni cosÃ¬ un *Pass Argento*!", dNext);	
																	});
																}else{
																	bot.sendMessage(message.chat.id, "Hai trovato il pulsante corretto! Prosegui alla prossima stanza.", dNext);
																}
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET param = NULL, room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});		
															};
														};
													};
												});
											}else if (dir == 9){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["PiÃ¹ Raro","Meno Raro"],["Ignora"]]
													}
												};

												var rand = Math.random()*100;

												bot.sendMessage(message.chat.id, "Raggiungi una stanza suddivisa in due, vedi un oggetto per lato, dove ti dirigi?" , dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if ((answer.text == "PiÃ¹ Raro") || (answer.text == "Meno Raro")){

															var monsterLev = room_num;
															var rarity = "";

															if (answer.text == "PiÃ¹ Raro"){
																if (rand > 30){
																	rarity = "UR";
																}else{
																	rarity = "L";
																}
															}else if (answer.text == "Meno Raro"){
																if (rand > 50){
																	rarity = "R";
																}else{
																	rarity = "NC";
																}
																monsterLev -= 5;
															}

															connection.query('SELECT name, id FROM item WHERE rarity = "' + rarity + '" AND craftable = 0 ORDER BY RAND()', function (err, rows, fields){
																if (err) throw err;
																var itemName = rows[0].name;
																var itemId = rows[0].id;

																connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields){
																	if (err) throw err;
																	if (Object.keys(rows).length == 0){
																		bot.sendMessage(message.chat.id, "Errore selezione mostro", back);
																		return;
																	}
																	connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields){
																		if (err) throw err;
																	});
																	var mName = rows[0].name;
																	var mLevel = rows[0].level;
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + itemId + ')', function (err, rows, fields) {
																		if (err) throw err;
																		var text = "Ti avvicini all'oggetto con calma, scopri che si tratta di *" + itemName + "*, ma appena lo prendi, appare di fronte a te un";
																		bot.sendMessage(message.chat.id, text + " *" + mName + "* di livello *" + mLevel + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function() {
																			answerCallbacks[message.chat.id] = function(answer) {
																				if (answer.text == "Scappa"){
																					bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function() {
																						answerCallbacks[message.chat.id] = function(answer) {
																							if (answer.text.toLowerCase() == "si"){

																								var rand = Math.random()*100;
																								if (rand < 50){
																									var dmg = Math.round(player_total_life*20/100);
																								}else{
																									var dmg = Math.round(player_total_life*30/100);
																								}

																								var exText = "";

																								connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});

																								if (player_life - dmg <= 0){
																									exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																									var d = new Date();
																									d.setHours(d.getHours() + wait_dungeon_long);
																									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																									connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																										if (err) throw err;
																									});
																									connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																										if (err) throw err;
																									});
																									if (player_rank > 0){
																										connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																											if (err) throw err;
																										});
																									}
																								}else{
																									exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																									var d = new Date();
																									d.setHours(d.getHours() + (wait_dungeon-1));
																									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																									connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																								connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																									if (err) throw err;
																								});
																								bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																							}
																						}
																					});
																				}
																			};
																		});
																	});
																});
															});
															connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															return;
														}else if (answer.text == "Ignora"){
															bot.sendMessage(message.chat.id, "Hai ignorato gli oggetti", dNext);
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}else{
															return;
														}
													}
												});
											}else if (dir == 10){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Accumula Monete","Estrai Spada"],["Torna al menu"]]
													}
												};

												if ((param == null) || (param == undefined)){
													param = "0;0";
													connection.query('UPDATE dungeon_status SET param = "' + param + '" WHERE player_id = ' + player_id, function (err, rows, fields){
														if (err) throw err;
													});
												}

												var param_arr = param.split(";");
												var acc_money = param_arr[0];										
												var acc_life = param_arr[1];

												bot.sendMessage(message.chat.id, "Entri in una stanza piena d'oro luccicante e una spada conficcata nel muro, puoi decidere di prendere oro ma un messaggio su un cartello raccomanda di non essere troppo avido, cosa fai?\nFin ora hai accumulato " + acc_money + " Â§.", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if ((answer.text == "Accumula Monete") || (answer.text == "Estrai Spada")){

															var damage = Math.round(player_total_life/100*acc_life);

															if (answer.text == "Accumula Monete"){
																if (player_rank == 0){
																	player_rank = 1;
																}
																var min = player_rank*100;
																var max = player_rank*90;
																var rand = Math.round(Math.random()*(min))+(max);
																acc_money = parseInt(acc_money)+rand;

																if (acc_life == 90){
																	bot.sendMessage(message.chat.id, "Non ci sono piÃ¹ monete nella stanza!", dNext);
																	return;
																}

																var randKey = Math.random()*100;
																if (randKey < 1){
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',616)', function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "In mezzo ai mucchi trovi un *Kit Fuga*!", dNext);
																	});
																}

																if (player_life - damage <= 0){
																	bot.sendMessage(message.chat.id, "Sei troppo stanco per riuscire a portare altre monete!", dNext);
																	return;
																}

																acc_life = parseInt(acc_life)+10;
																param = acc_money + ";" + acc_life;

																connection.query('UPDATE dungeon_status SET param = "' + param + '" WHERE player_id = ' + player_id, function (err, rows, fields){
																	if (err) throw err;
																});

																bot.sendMessage(message.chat.id, "Hai deciso di accumulare altre monete, raggiungi cosÃ¬ un bottino di " + acc_money + " Â§", dNext);
															}else if (answer.text == "Estrai Spada"){

																if (player_life - damage <= 0){
																	connection.query('UPDATE player SET life = life - ' + damage + ' WHERE id = ' + player_id, function (err, rows, fields){
																		if (err) throw err;

																		var d = new Date();
																		d.setHours(d.getHours() + wait_dungeon_long);
																		var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																		connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																			if (err) throw err;
																		});

																		bot.sendMessage(message.chat.id, "La porta si apre, ma un dolore lancinante al petto ti fa perdere i sensi, vieni cosÃ¬ portato fuori dal dungeon in orribili condizioni.", back);
																	});
																	return;
																}

																connection.query('UPDATE player SET money = money + ' + acc_money + ', life = life - ' + damage + ' WHERE id = ' + player_id, function (err, rows, fields){
																	if (err) throw err;
																	if (acc_money == 0){
																		bot.sendMessage(message.chat.id, "La spada provoca un piccolo terremoto e si apre la porta! Immediatamente perÃ² senti una voce spiritica risuonare nell'aria.\nSi apre la porta e prosegui senza nessuna moneta!", dNext);
																	}else{
																		bot.sendMessage(message.chat.id, "La spada provoca un piccolo terremoto e si apre la porta! Immediatamente perÃ² senti una voce spiritica risuonare nell'aria e un dolore lancinante al petto.\nSi apre la porta e ottieni *" + acc_money + "* Â§, ma perdi *" + damage + "* hp", dNext);
																	}
																});

																connection.query('UPDATE dungeon_status SET param = NULL, room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
															}
														}else{
															return;
														}
													};
												});
											}else if (dir == 0){
												var rand = Math.round(Math.random()*100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Esamina","Ignora"],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Appena entrato nella stanza noti subito una strana fontana situata nel centro, cosa fai?", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Esamina"){
															connection.query('SELECT COUNT(*) As cnt FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;

																var color = "";
																var type = 0;
																if (rows[0].cnt > 0){
																	if (rand <= 20){
																		color = "Rosso";
																		type = 3;
																	}else if ((rand > 20) && (rand <= 40)){
																		color = "Blu";
																		type = 1;
																	}else if ((rand > 40) && (rand <= 60)){
																		color = "Giallo";
																		type = 2;
																	}
																}
																if (color != ""){
																	connection.query('UPDATE event_mana_status SET mana_' + type + ' = mana_' + type + '+100 WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Ti avvicini alla fontana e vedi che l'acqua ha uno strano colore, la esamini meglio ed ottieni 100 Mana " + color + "!", dNext);
																	});
																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});	
																}else{
																	var monsterLev = Math.round(Math.random()*Math.round(room_num/2)+Math.round(room_num/2));

																	connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields){
																		if (err) throw err;
																		if (Object.keys(rows).length == 0){
																			bot.sendMessage(message.chat.id, "Errore selezione mostro: " + monsterLev, back);
																			return;
																		}
																		connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields){
																			if (err) throw err;
																		});
																		bot.sendMessage(message.chat.id, "Ti avvicini alla fontana per esaminarla meglio, appena provi a toccare l'acqua dal suo interno esce un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function() {
																			answerCallbacks[message.chat.id] = function(answer) {
																				if (answer.text == "Scappa"){
																					bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function() {
																						answerCallbacks[message.chat.id] = function(answer) {
																							if (answer.text.toLowerCase() == "si"){

																								var rand = Math.random()*100;
																								if (rand < 50){
																									var dmg = Math.round(player_total_life*20/100);
																								}else{
																									var dmg = Math.round(player_total_life*30/100);
																								}

																								var exText = "";

																								connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});

																								if (player_life - dmg <= 0){
																									exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																									var d = new Date();
																									d.setHours(d.getHours() + wait_dungeon_long);
																									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																									connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																										if (err) throw err;
																									});
																									connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																										if (err) throw err;
																									});
																									if (player_rank > 0){
																										connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																											if (err) throw err;
																										});
																									}
																								}else{
																									exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																									var d = new Date();
																									d.setHours(d.getHours() + (wait_dungeon-1));
																									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																									connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																								connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																									if (err) throw err;
																								});
																								bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																							}
																						}
																					});
																				}
																			};
																		});
																	});
																}
															});
														}else if (answer.text == "Ignora"){
															bot.sendMessage(message.chat.id, "Hai ignorato la fontana", dNext);
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});	
														}else{
															return;
														}
													}
												});
											}else if (dir == -1){
												var rand = Math.round(Math.random()*100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Inserisci Monete"],["Inserisci Gettone"],["Sfonda il Muro"],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Questa stanza Ã¨ vuota, c'Ã¨ solo una piccola fessura sul muro di fronte, ha la forma di una monetina. E scorgi una sagoma di un portone subito a fianco. Cosa fai?", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Inserisci Monete"){
															connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																var money = Math.round(rows[0].money*0.05);
																if (money > 5000){
																	money = 5000;
																}
																connection.query('UPDATE player SET money = money - ' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Scegli di inserire nella fessura " + money + " Â§, il portone ti ringrazia con una voce inquietante, e si apre lentamente, cosÃ¬ da aprire la strada per la stanza seguente.", dNext);
																});
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});	
															});
														}else if (answer.text == "Inserisci Gettone"){
															connection.query('SELECT token FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;

																if (rows[0].token < 1){
																	bot.sendMessage(message.chat.id, "Non hai nessun gettone!", dNext);
																	return;
																}

																connection.query('UPDATE player SET token = token - 1 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Scegli di inserire nella fessura 1 Gettone, il portone ti ringrazia con una voce inquietante, e si apre lentamente per la stanza seguente.", dNext);
																});
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});	
															});
														}else if (answer.text == "Sfonda il Muro"){
															connection.query('SELECT total_life FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																var life = Math.round(rows[0].total_life*0.2);
																if (player_life-life <= 0){

																	connection.query('UPDATE player SET life = life - ' + life + ' WHERE id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Scegli di tirare giÃ¹ il portone a spallate, perdi cosÃ¬ " + life + " hp, ma riesci ad aprire la strada per la stanza seguente.", dNext);
																	});

																	bot.sendMessage(message.chat.id, "Tirando spallate troppo forti hai perso i sensi e quindi portato fuori dal dungeon", back);

																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																}else{
																	connection.query('UPDATE player SET life = life - ' + life + ' WHERE id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Scegli di tirare giÃ¹ il portone a spallate, perdi cosÃ¬ " + life + " hp, ma riesci ad aprire la strada per la stanza seguente.", dNext);
																	});
																}
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});	
															});
														}else{
															return;
														}
													}
												});
											}else if (dir == -2){
												var rand = Math.round(Math.random()*100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Procedi"],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Un cartello con un punto esclamativo ti preoccupa, al centro della stanza c'Ã¨ un taglio che la percorre per tutta la sua larghezza, l'unica alternativa Ã¨ procedere.", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Procedi"){
															connection.query('SELECT life FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																var life = Math.round(rows[0].life/2);
																var rand = Math.random()*100;

																connection.query('SELECT level FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;

																	var lev = 0;
																	if (Object.keys(rows).length > 0){
																		if (lev > 90)
																			lev = 90;
																		lev = rows[0].level;
																	}

																	if (lev >= rand){
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',72)', function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Come avanzi di due passi scatta un meccanismo e un'ascia gigantesca ti precipita addosso, fortunatamente il tuo drago riesce a difenderti bloccandola completamente e vicino alla porta trovi un sacchettino contenente una Pietra Cuore Leggendario!", dNext);
																		});
																	}else{
																		connection.query('UPDATE player SET life = life - ' + life + ' WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Come avanzi di due passi scatta un meccanismo e un'ascia gigantesca ti precipita addosso, il tuo drago si precipita in tua difesa ma non Ã¨ abbastanza forte, l'ascia ti prende in pieno e perdi metÃ  della tua salute!", dNext);
																		});
																	}
																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});	
																});
															});
														}else{
															return;
														}
													}
												});
											}else if (dir == -3){
												var dOptions = {
													parse_mode: "HTML",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Fai un Tentativo"],["Torna al menu"]]
													}
												};

												connection.query('SELECT name FROM item ORDER BY RAND()', function (err, rows, fields){
													if (err) throw err;
													var newWord = rows[0].name;
													var word = "";

													if ((param == null) || (param == undefined)){
														connection.query('UPDATE dungeon_status SET param = "' + newWord + '" WHERE player_id = ' + player_id, function (err, rows, fields){
															if (err) throw err;
														});
														param = newWord;
													}

													word = param;

													var word2 = word.replace(new RegExp(" ", 'g'),"#");
													var len = Object.keys(word).length;
													var final = word2.charAt(0) + " ";
													for (var i=1;i<len-1;i++) {
														if (word2.charAt(i) == "#"){
															final += "- ";
														}else{
															final += "_ ";
														}
													}
													final += word2.charAt(len-1);

													bot.sendMessage(message.chat.id, "Attenzione! Appena messo piede nella stanza, senti tremare il pavimento ed una gabbia ti circonda lentamente, sul muro appaiono due lettere, la prima e l'ultima di una parola di Lootia:\n" + final + "\nPuoi fare un tentativo per cercare di fuggire.", dOptions).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															if (answer.text == "Fai un Tentativo"){
																bot.sendMessage(message.chat.id, "Inserisci la parola che pensi che sia corrispondente ai segni sul muro", back).then(function() {
																	answerCallbacks[message.chat.id] = function(answer) {
																		if (answer.text == "Torna al menu"){
																			return;
																		}else if (answer.text.toLowerCase() == word.toLowerCase()){
																			connection.query('UPDATE dungeon_status SET param = NULL WHERE player_id = ' + player_id, function (err, rows, fields){
																				if (err) throw err;
																				bot.sendMessage(message.chat.id, "Hai indovinato l'oggetto! Il pavimento torna alla sua posizione di partenza e puoi proseguire", dNext);
																			});
																			connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																		}else{
																			connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(message.chat.id, "Purtroppo l'oggetto non Ã¨ corretto, sei costretto ad aspettare un po' di tempo per riprovare", dNext);
																			});
																			return;
																		}
																	};
																});
															}else{
																return;
															}
														}
													});
												});
											}else if (dir == -4){
												var iKeys = [];

												var text = "Nella stanza incontri un predone del deserto dall'aria docile, ti propone uno scambio, puoi accettarlo o ignorarlo e procedere.\n";

												connection.query('SELECT I.id As item1id, I.name As item1n, I2.id As item2id, I2.name As item2n ' +
																 'FROM dungeon_trade DT INNER JOIN item I ON DT.item_1 = I.id INNER JOIN item I2 ON DT.item_2 = I2.id ' +
																 'WHERE DT.dungeon_id = ' + dungeon_id + ' AND DT.room_id = ' + room_id, function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0){
														connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Errore selezione oggetti mercato", dNext);
														});
														return;
													}
													text += "Ti offre *" + rows[0].item1n + "* in cambio del tuo *" + rows[0].item2n + "*";

													iKeys.push(["Accetta"]);
													var item1id = rows[0].item1id;
													var item2id = rows[0].item2id;

													iKeys.push(["Ignora"]);
													iKeys.push(["Torna al menu"]);

													var dItems = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															one_time_keyboard: true,
															"keyboard": iKeys
														}
													};

													bot.sendMessage(message.chat.id, text, dItems).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															var ogg = answer.text;
															if (ogg == "Ignora"){
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Decidi di ignorare il predone e prosegui", dNext);
																	});
																});
																return;
															}else if (ogg == "Torna al menu"){
																return;
															}else{
																bot.sendMessage(message.chat.id, "Sicuro di voler accettare lo scambio?", dYesNo).then(function() {
																	answerCallbacks[message.chat.id] = function(answer) {
																		if (answer.text.toLowerCase() == "si"){

																			connection.query('SELECT COUNT(id) As cnt FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + item2id, function(err, rows, fields) {
																				if (err) throw err;

																				if (rows[0].cnt < 1){
																					bot.sendMessage(message.chat.id, "Non possiedi l'oggetto richiesto", back);
																					return;
																				}

																				connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + item1id + ')', function (err, rows, fields) {
																					if (err) throw err;
																					connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + item2id + ' LIMIT 1', function (err, rows, fields) {
																						if (err) throw err;

																						connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																							if (err) throw err;
																						});

																						connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																							if (err) throw err;
																						});

																						bot.sendMessage(message.chat.id, "Scambio effettuato!", dNext);
																					});
																				});
																			});
																		}
																	}
																});

															}
														}
													});
												});
											}else if (dir == -5){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Medita"],["Termina Meditazione"],["Torna al menu"]]
													}
												};

												if (param == null)
													param = 0;

												bot.sendMessage(message.chat.id, "Raggiungi una stanza con un'incisione profonda: Stanza della Meditazione, cosa vuoi fare?\nFin ora hai meditato " + param + " volte", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Medita"){
															if (param > 6){
																bot.sendMessage(message.chat.id, "Non puoi meditare troppo a lungo", dNext);
																return;
															}
															if (param == 0){
																connection.query('UPDATE dungeon_status SET param = 1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
															}else{
																connection.query('UPDATE dungeon_status SET param = param+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
															}

															var rand = Math.random()*100;
															if (rand < 3){
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',610)', function (err, rows, fields){
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Per l'altissimo livello di meditazione hai ottenuto un *Pass Oro*!", mark);
																});
															}

															var d = new Date();
															d.setMinutes(d.getMinutes()+30+(param*10));
															var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
															var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

															connection.query('UPDATE dungeon_status SET room_time = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai iniziato a meditare, finirai alle " + short_date, dNext);
															});
															return;
														}else if (answer.text == "Termina Meditazione"){
															if (param == null){
																bot.sendMessage(message.chat.id, "Non hai meditato quindi non hai ricevuto nulla", dNext);
															}else{
																var rand = Math.random()*100;
																if (rand < 30){
																	for (var i = 0, len = param; i < len; i++) {
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',70)', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																	bot.sendMessage(message.chat.id, "Per la meditazione prolungata, il saggio della montagna ti premia con " + param + "x Pietra Anima Preziosa!", dNext);
																}else if (rand < 60){
																	for (var i = 0, len = param; i < len; i++) {
																		connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + player_id + ',3)', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																	bot.sendMessage(message.chat.id, "Per la meditazione prolungata, il saggio della montagna ti premia con " + param + "x Scrigni Preziosi!", dNext);
																}else if (rand < 80){
																	for (var i = 0, len = param; i < len; i++) {
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',646)', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																	bot.sendMessage(message.chat.id, "Per la meditazione prolungata, il saggio della montagna ti premia con " + param + "x Polvere!", dNext);
																}else if (rand < 100){
																	for (var i = 0, len = param; i < len; i++) {
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',1)', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																	bot.sendMessage(message.chat.id, "Per la meditazione prolungata, il saggio della montagna ti premia con " + param + "x Carta!", dNext);
																}
															}

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET param = NULL, room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}else{
															return;
														}
													}
												});
											}else if (dir == -6){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Tornare in piena salute"],["Avere uno zaino pieno zeppo"],["Essere ricco sfondato"],["Completare il dungeon velocemente"],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Davanti a te si erge un portale completamente rosso, una voce rimbomba dal tuo interno: esprimi un desiderio avventuriero! 'Vorrei...'", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														var rand = Math.random()*100;
														if (answer.text == "Tornare in piena salute"){
															if (rand < 40){
																connection.query('UPDATE player SET life = total_life WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Hai recuperato tutti gli hp!", dNext);
																});
															}else{
																connection.query('UPDATE player SET life = 1 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Ti rimane 1 solo hp!", dNext);
																});
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}else if (answer.text == "Avere uno zaino pieno zeppo"){
															if (rand < 40){
																connection.query('SELECT item.id, item.name FROM item, inventory WHERE item.id = inventory.item_id AND rarity IN ("C","NC","R","UR","L","E") AND player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	var name = rows[0].name;
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].id + ')', function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Hai ottenuto " + name + "!", dNext);
																	});
																});
															}else{
																connection.query('SELECT item.id, item.name FROM item, inventory WHERE item.id = inventory.item_id AND rarity IN ("C","NC","R","UR","L","E") AND player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	if (Object.keys(rows).length == 0){
																		bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Avendo lo zaino vuoto perÃ² non hai perso nulla!", dNext);
																	}else{
																		var name = rows[0].name;
																		connection.query('DELETE FROM inventory WHERE item_id = ' + rows[0].id + ' AND player_id = ' + player_id + ' LIMIT 1', function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Hai perso " + name + "!", dNext);
																		});
																	}
																});
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}else if (answer.text == "Essere ricco sfondato"){
															if (player_rank == 0)
																player_rank = 1;
															var money = 30*player_rank;
															if (rand < 40){
																connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Hai ottenuto " + money + " Â§!", dNext);
																});
															}else{
																connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	if (rows[0].money < money)
																		money = rows[0].money;
																	connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Hai perso " + money + " Â§!", dNext);
																	});
																});
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});	
														}else if (answer.text == "Completare il dungeon velocemente"){
															if (rand < 40){
																room_id += 2;
																bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Avanzi di due stanze!", dNext);
															}else{
																if (room_id < 3){
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Essendo all'inizio del dungeon vieni sbalzato fuori!", back);

																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																}else{
																	room_id -= 2;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Retrocedi di due stanze!", dNext);
																}
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = ' + room_id + ', last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});	
														}else{
															return;
														}
													};
												});
											}else if (dir == -7){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Attacca con il Drago"],["Ignora"],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Entri nella stanza e per sbaglio pesti una mattonella leggermente rovinata, il muro si apre ed esce l'immenso drago di LastSoldier95, cosa fai?", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Attacca con il Drago"){

															var rand = Math.random();
															connection.query('SELECT level FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;

																if (Object.keys(rows).length == 0){
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',71)', function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Colpendo il drago scopri che si tratta in realtÃ  di un peluche, ma comunque ottieni una Pietra Anima Preziosa!", dNext);
																	});
																}else{
																	if (rows[0].level > rand){
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',72)', function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il tuo drago riesce a sconfiggere Eragon, passi accanto al cadavere e prendi velocemente una Pietra Cuore Leggendario dal suo nascondiglio!", dNext);
																		});
																	}else if (rand < 60){
																		connection.query('UPDATE dragon SET exp = exp-5 FROM drago WHERE player_id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il tuo drago viene spazzato via dal grande Eragon, e cosÃ¬ perde 5 punti esperienza!", dNext);
																		});
																	}
																};
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});	
															});
														}else if (answer.text == "Ignora"){
															bot.sendMessage(message.chat.id, "Corri velocemente verso l'uscita e passi alla stanza successiva", dNext);
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});	
														}else{
															return;
														}
													};
												});
											}else if (dir == -8){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["..."],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Entri in una stanza apparentemente vuota, cosa fai?", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "..."){
															var rand = Math.random()*200;
															var text = "";

															if (rand < 50){
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',93)', function(err, rows, fields) {
																	if (err) throw err;
																});
																text = "qualcosa che in effetti potrebbe farti sentire meglio";
															}else if (rand < 100){
																connection.query('UPDATE player SET token = token+1 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																text = "qualcosa che forse ti farebbe sentire piÃ¹ fortunato";
															}else if (rand < 150){
																connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																text = "qualcosa che luccica e riflette la luce in modo incredibile";
															}else if (rand < 199){
																connection.query('UPDATE player SET exp = exp+10 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																text = "qualcosa che ti fa sentire un po' piÃ¹ esperto di prima";
															}else{
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',200)', function(err, rows, fields) {
																	if (err) throw err;
																});
																text = "qualcosa che ti provoca un brivido nella schiena";
															}

															bot.sendMessage(message.chat.id, "Succede qualcosa, " + text + ", procedi alla prossima stanza con aria interrogativa...", dNext);

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}
													};
												});
											}else if (dir == -9){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Punta"],["Ignora"],["Torna al menu"]]
													}
												};

												var dOptions2 = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Gioca"],["Torna al menu"]]
													}
												};

												if (param != null){

													var id = param.split(":");

													connection.query('SELECT name FROM item WHERE id = ' + id[0], function (err, rows, fields){
														if (err) throw err;

														var name1 = rows[0].name; //player

														connection.query('SELECT name FROM item WHERE id = ' + id[1], function (err, rows, fields){
															if (err) throw err;

															var name2 = rows[0].name; //marinaio

															bot.sendMessage(message.chat.id, "Il marinaio aspetta il tuo turno avendo puntato *" + name2 + "*, mentre tu hai puntato *" + name1 + "* procedi?", dOptions2).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if (answer.text == "Gioca"){
																		bot.sendMessage(message.chat.id, "Inserisci un numero da 1 a 6 e lancia il dado, il vincitore sarÃ  colui che si avvicinerÃ  di piÃ¹ al risultato del dado", back).then(function() {
																			answerCallbacks[message.chat.id] = function(answer) {
																				if (answer.text == "Torna al menu"){
																					return;
																				}else{
																					var num1 = Math.round(parseInt(answer.text));
																					if ((num1 < 1) || (num1 > 6) || (isNaN(num1))){
																						bot.sendMessage(message.chat.id, "Il dado ha solo numeri da 1 a 6...", dBack);
																						return;
																					}
																					var num2 = Math.round(Math.random()*5+1);
																					var dado = Math.round(Math.random()*5+1);

																					var vic1 = Math.abs(dado-num1);
																					var vic2 = Math.abs(dado-num2);

																					var text = "Tu hai scelto il *" + num1 + "*\nIl marinaio ha scelto il *" + num2 + "*\n\nSul dado Ã¨ uscito il... *" + dado + "*!";
																					if (vic1 < vic2){
																						bot.sendMessage(message.chat.id, text + "\n\nHai VINTO!", dNext);
																						connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + id[0] + ')', function(err, rows, fields) {
																							if (err) throw err;
																						});
																						connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + id[1] + ')', function(err, rows, fields) {
																							if (err) throw err;
																						});
																					}else if (vic1 == vic2){
																						connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + id[0] + ')', function(err, rows, fields) {
																							if (err) throw err;
																						});
																						bot.sendMessage(message.chat.id, text + "\n\nPARITA'!", dNext);
																					}else{
																						bot.sendMessage(message.chat.id, text + "\n\nHai PERSO!", dNext);
																					}
																					connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																						if (err) throw err;
																					});
																					connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL, param = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																						if (err) throw err;
																					});
																				}
																			};
																		});
																	}
																}
															});
														});
													});
												}else{
													bot.sendMessage(message.chat.id, "Nella stanza incontri un marinaio con aria furba, ti propone una partita ai dadi, il vincitore otterrÃ  l'oggetto dell'avversario, vuoi partecipare?", dOptions).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															if (answer.text == "Punta"){
																bot.sendMessage(message.chat.id, "Inserisci il nome dell'oggetto da puntare, solo oggetti base e raritÃ  fino alla L", back).then(function() {
																	answerCallbacks[message.chat.id] = function(answer) {
																		if (answer.text == "Torna al menu"){
																			return;
																		}else{
																			connection.query('SELECT item.id, item.rarity, item.name FROM item, inventory WHERE item.id = inventory.item_id AND player_id = ' + player_id + ' AND name = "' + answer.text + '" AND craftable = 0 AND item.rarity IN ("C","NC","R","UR","L")', function (err, rows, fields){
																				if (err) throw err;
																				if (Object.keys(rows).length == 0){
																					bot.sendMessage(message.chat.id, "L'oggetto inserito non Ã¨ valido", back);
																					return;
																				}

																				var id1 = rows[0].id;
																				var name1 = rows[0].name;
																				var rar = rows[0].rarity;

																				connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + id1 + ' LIMIT 1', function (err, rows, fields){
																					if (err) throw err;
																					connection.query('SELECT id, name FROM item WHERE craftable = 0 AND item.rarity = "' + rar + '" AND id != ' + id1 + ' ORDER BY RAND()', function (err, rows, fields){
																						if (err) throw err;

																						var id2 = rows[0].id;
																						var name2 = rows[0].name;

																						param = id1 + ":" + id2;

																						connection.query('UPDATE dungeon_status SET param = "' + param + '" WHERE player_id = ' + player_id, function (err, rows, fields){
																							if (err) throw err;
																						});
																						bot.sendMessage(message.chat.id, "Hai puntato il tuo oggetto", dNext);
																					});

																				});
																			});
																		}
																	};
																});
															}else if (answer.text == "Ignora"){
																bot.sendMessage(message.chat.id, "Ringrazia il marinaio dell'offerta e passi alla stanza successiva", dNext);
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
															}
														}
													});
												}
											}else if (dir == -10){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Porta Normale"],["Porta Misteriosa"],["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Oltrepassando la porta ti trovi davanti ad altre due porte, una con un'aria familiare, l'altra con un grosso punto interrogativo scolpito sopra, quale apri?", dOptions).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text == "Porta Normale"){

															bot.sendMessage(message.chat.id, "Scegli la solita porta arrugginita e procedi alla stanza successiva", dNext);

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}else if (answer.text == "Porta Misteriosa"){
															connection.query('SELECT room_id FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;

																var room_id = parseInt(rows[0].room_id);

																connection.query('SELECT rooms FROM dungeon_list WHERE id = ' + dungeon_id, function(err, rows, fields) {
																	if (err) throw err;
																	var rooms = rows[0].rooms;

																	var min = room_id-10;
																	var max = room_id+10;

																	if (min < 0){
																		min = 1;
																	}
																	if (max > rooms){
																		max = rooms;
																	}

																	var room = Math.round(getRandomArbitrary(min, max));

																	bot.sendMessage(message.chat.id, "Apri lentamente la porta e la attraversi, ritrovandoti alla stanza numero *" + room + "* del dungeon!", dNext);

																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = ' + room + ', last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																});
															});
														}
													};
												});
											}else if (dir == -11){
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Butta una monetina"],["Prova a raccoglierle"],["Torna al menu"]]
													}
												};

												connection.query('SELECT amount FROM dungeon_well WHERE dungeon_id = ' + dungeon_id, function(err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "Vedi un pozzo in lontananza, ma Ã¨ diroccato e non puoi far altro che proseguire", dNext);
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
														});
														return;
													}

													var stored_money = rows[0].amount;

													bot.sendMessage(message.chat.id, "Una luce esagerata ti avvolge, esci in un piccolo spiazzo di prato con un pozzo al centro ed uno schermino appoggiato sopra, puoi buttare una monetina al suo interno, sembra l'unico modo per proseguire, oppure puoi cercare di raccogliere tutto il malloppo.\n\nLo schermino segna: " + stored_money + " Â§", dOptions).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															if (answer.text == "Butta una monetina"){
																var min = player_rank*10;
																bot.sendMessage(message.chat.id, "Inserisci la quantitÃ  di monetine da buttare nel pozzo, minimo " + min + " Â§", dBack).then(function() {
																	answerCallbacks[message.chat.id] = function(answer) {
																		if ((answer.text != "Torna al menu") && (answer.text != "Torna al dungeon")) {
																			var money = Math.round(parseInt(answer.text));

																			if (money < min){
																				bot.sendMessage(message.chat.id, "Minimo " + min + " Â§!", dBack);
																				return;
																			}

																			connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																				var mymoney = rows[0].money;

																				if (mymoney < money){
																					bot.sendMessage(message.chat.id, "Non hai cosÃ¬ tante monetine...", dBack);
																					return;
																				}

																				connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;
																					bot.sendMessage(message.chat.id, "Hai gettato nel pozzo *" + money + "* monetine!\nOra prosegui alla prossima stanza", dNext);

																					connection.query('UPDATE dungeon_well SET amount = amount+' + money + ' WHERE dungeon_id = ' + dungeon_id, function(err, rows, fields) {
																						if (err) throw err;
																					});
																					connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																						if (err) throw err;
																					});
																					connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																						if (err) throw err;
																					});
																				});
																			});
																		}
																	};
																});
															}else if (answer.text == "Prova a raccoglierle"){
																var rand = Math.random()*100;

																if (stored_money == 0){
																	bot.sendMessage(message.chat.id, "Il pozzo Ã¨ vuoto, Ã¨ inutile cercare di prendere qualcosa", dBack);
																	return;
																}

																connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;

																	var mymoney = rows[0].money;
																	if (mymoney < Math.round(stored_money/2)){
																		bot.sendMessage(message.chat.id, "Il pozzo Ã¨ troppo alto per te! Non puoi farcela, procedi in altro modo", dBack);
																		return;
																	}

																	if (rand < 40){
																		connection.query('UPDATE player SET money = money+' + stored_money + ' WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Sei tornato tutto intero con un sacchettino contenente *" + stored_money + "* monetine!\nOra prosegui alla prossima stanza", dNext);
																		});
																		connection.query('UPDATE dungeon_well SET amount = 0 WHERE dungeon_id = ' + dungeon_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}else{
																		connection.query('UPDATE player SET money = money-' + Math.round(stored_money/2) + ' WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Purtroppo sei caduto nel pozzo e per ritirarti su ti sono cadute delle monetine, ne hai perse quindi *" + Math.round(stored_money/2) + "*!\nOra prosegui alla prossima stanza", dNext);
																		});
																		connection.query('UPDATE dungeon_well SET amount = amount+' + Math.round(stored_money/2) + ' WHERE dungeon_id = ' + dungeon_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																	});
																});
															}
														}
													});
												});
											}else{
												bot.sendMessage(message.chat.id, "Direzione non valida, segnala a @fenix45 questo valore: " + dir, dBack);
											}
										}
									});
								});
							});
						};
					});
				}
			});
		});
	});
});

function findMissing(numArray){
	var missing = 0;
	for(var i = 1; i < numArray.length; i++) {
		if(numArray[i] - numArray[i-1] != 1) {
			missing = numArray[i];
			console.log("MISSING: " + parseInt(parseInt(missing)-1));
			return parseInt(parseInt(missing)-1);
		};
	};
};

bot.onText(/attacca$|^Lancia ([a-zA-Z ]+) ([0-9]+)/i, function(message, match) {

	var dYesNo = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Si"],["Torna al dungeon"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back);
			return;
		}

		var player_id = rows[0].id;
		var player_weapon_id = rows[0].weapon_id;
		var player_weapon2_id = rows[0].weapon2_id;
		var player_weapon3_id = rows[0].weapon3_id;
		var reborn = rows[0].reborn;
		var class_id = rows[0].class;
		var player_paralyzed = rows[0].paralyzed;

		var critical = parseInt(rows[0].weapon_crit);
		var critical_armor = parseInt(rows[0].weapon2_crit);
		var critical_shield = parseInt(rows[0].weapon3_crit);
		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;

		if ((boost_mission == 0) && (boost_id != 0)){
			connection.query('UPDATE player SET boost_id = 0 WHERE id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});
		}

		if (charm_id == 404){
			critical += 6;
		}
		if (charm_id == 493){
			critical += 2;
		}
		if (charm_id == 494){
			critical += 4;
		}
		if (charm_id == 495){
			critical_armor += 3;
		}
		if (charm_id == 496){
			critical_shield += 3;
		}
		if ((class_id == 2) && (reborn == 3)){
			critical_armor += 5;
		}
		if ((class_id == 2) && (reborn >= 4)){
			critical_armor += 5;
			critical_shield += 5;
		}
		if ((class_id == 4) && (reborn == 3)){
			critical += 2;
		}
		if ((class_id == 4) && (reborn >= 4)){
			critical += 7;
			critical_armor += 7;
			critical_shield += 7;
		}
		if ((class_id == 5) && (reborn == 3)){
			critical_shield += 3;
		}
		if ((class_id == 5) && (reborn >= 4)){
			critical_shield += 5;
		}
		if ((class_id == 6) && (reborn == 3)){
			critical_armor += 2;
		}
		if ((class_id == 6) && (reborn == 3)){
			critical_shield += 2;
		}
		if ((class_id == 6) && (reborn >= 4)){
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn >= 4)){
			critical_shield += 7;
		}
		if ((class_id == 6) && (reborn == 5)){
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn == 5)){
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 3)){
			critical_shield += 5;
		}
		if ((class_id == 8) && (reborn >= 4)){
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 5)){
			critical += 7;
		}
		if ((class_id == 9) && (reborn == 3)){
			critical += 2;
			critical_shield += 2;
		}
		if ((class_id == 9) && (reborn >= 4)){
			critical += 7;
			critical_shield += 7;
		}

		var danno = Math.round(Math.random()*(rows[0].exp/15+rows[0].weapon)+rows[0].weapon);
		danno += rows[0].weapon_enchant;

		var charm_id = rows[0].charm_id;
		var player_exp = rows[0].exp;
		var player_life = rows[0].life;
		var player_total_life = rows[0].total_life;
		var rank = rows[0].rank;
		var automagic1 = rows[0].weapon_enchant_bonus;

		if (player_life <= 0){
			bot.sendMessage(message.chat.id, "Non puoi combattere da morto!", back);
			return;
		}

		if (charm_id == 62){
			danno = danno+5;
		}else if (charm_id == 184){
			danno = danno+15;
		}else if (charm_id == 188){
			danno = danno+20;
		}
		var bonus = 0;
		if (rows[0].weapon2 < 0){
			var bonus = Math.abs(rows[0].weapon2)+Math.abs(rows[0].weapon3)+rows[0].weapon3_enchant+rows[0].weapon2_enchant;
			bonus = Math.round(Math.random()*((rows[0].exp/10+bonus)/2)+bonus);
		}

		danno = parseInt(danno);
		bonus = parseInt(bonus);

		var critical_rand = Math.round(Math.random()*100)+1;
		var crit_bool = 0;
		var crit_txt = "";

		if (crazyMode == 1){
			danno = danno*2;
		}

		var magic = 0;
		var magicId = 0;
		var magicPow = 0;

		if (message.text.indexOf("Lancia") != -1){
			if (rows[0].magic_to == 2){
				//match[1] = match[1].slice(0, -1);
				if (match[1] == "Furia dei Mari"){
					magic = 1;
				}else if (match[1] == "Tempesta Folgorante"){
					magic = 2;
				}else if (match[1] == "Impeto di Fiamme"){
					magic = 3;
				}else if (match[1] == "Ira Astrale"){
					magic = 4;
				}
			}else{
				return;
			}
		}

		if (rows[0].dungeon_time != null){
			var d = new Date(rows[0].dungeon_time);
			var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

			bot.sendMessage(message.chat.id, "Puoi tornare nei dungeon alle " + short_date, back);
			return;
		}

		var pow = 0;
		if (match[2] != undefined){
			pow = match[2];
		}

		var magicDouble = 0;
		connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 10', function(err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0){
				abBonus = parseInt(rows[0].ability_level)*2;
			}

			connection.query('SELECT type, id, power, quantity FROM magic WHERE player_id = ' + player_id + ' AND power = ' + pow + ' AND type = ' + magic, function(err, rows, fields) {
				if (err) throw err;

				if (magic != 0){
					if (Object.keys(rows).length > 0){
						if (rows[0].quantity == 0){
							bot.sendMessage(message.chat.id, "Hai terminato gli utilizzi dell'incantesimo selezionato!", bossKb);
							return;
						}else{
							magicId = rows[0].id;
							magicPow = rows[0].power;

							var rand = Math.random()*100;
							if ((class_id == 4) && ((magic == 3) || (magic == 4)) && (reborn == 5)){
								abBonus += 25;
							}
							if (rand < abBonus){
								magicPow = magicPow*2;
								magicDouble = 1;
							}
						}
					}else{
						bot.sendMessage(message.chat.id, "Non possiedi l'incantesimo selezionato!", bossKb);
						return;
					}
				}

				var automagic = 0;

				if (magic == 0){
					var magicrand = Math.random()*100;
					if (magicrand < 2){
						if (player_weapon_id == 630){
							magic = 2;
							automagic = 1;
							magicPow = 50;
						}else if (player_weapon_id == 631){
							magic = 3;
							automagic = 1;
							magicPow = 50;
						}else if (player_weapon_id == 632){
							magic = 1;
							automagic = 1;
							magicPow = 50;
						}
					}
					if (magicrand < 5){
						if (player_weapon_id == 638){
							magic = 2;
							automagic = 1;
							magicPow = 150;					
						}else if (player_weapon_id == 639){
							magic = 3;
							automagic = 1;
							magicPow = 150;
						}else if (player_weapon_id == 640){
							magic = 1;
							automagic = 1;
							magicPow = 150;
						}
					}
					if ((magicrand > 80) && (automagic1 == 1)){
						var magicrand2 = Math.random()*100;
						if (magicrand2 < 30){
							magic = 1;
							automagic = 1;
							magicPow = 50;
						}else if (magicrand2 < 60){
							magic = 2;
							automagic = 1;
							magicPow = 100;
						}else{
							magic = 3;
							automagic = 1;
							magicPow = 50;
						}
					}
				}

				if (magicDouble == 0){
					if ((class_id == 2) && (reborn == 3)){
						magicPow += magicPow*0.1;
					}
					if ((class_id == 2) && (reborn >= 4)){
						magicPow += magicPow*0.25;
					}
					if ((class_id == 2) && (reborn == 5)){
						magicPow += magicPow*0.25;
					}
					if ((class_id == 3) && (reborn == 5)){
						magicPow += magicPow*0.3;
					}
				}

				connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 1', function(err, rows, fields) {
					if (err) throw err;

					var abBonus = 0;
					if (Object.keys(rows).length > 0){
						abBonus = rows[0].ability_level;
						critical += abBonus;
						critical_armor += abBonus;
						critical_shield += abBonus;
					}

					connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 3', function(err, rows, fields) {
						if (err) throw err;

						var abBonus2 = 0;
						if (Object.keys(rows).length > 0){
							abBonus2 = parseInt(rows[0].ability_level)*30;
						}

						connection.query('SELECT damage, critical, defense, claws, saddle FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length > 0){
								if ((class_id == 7) && (reborn > 1)){
									rows[0].claws += rows[0].claws*0.5;
								}
								if ((class_id == 7) && (reborn > 1)){
									rows[0].saddle += rows[0].saddle*0.5;
								}
								if ((class_id == 7) && (reborn >= 4)){
									rows[0].damage += rows[0].damage*0.5;
								}
								if ((class_id == 7) && (reborn >= 4)){
									rows[0].defense += rows[0].defense*0.5;
								}
								danno += parseInt(rows[0].damage);
								danno += parseInt(rows[0].claws);
								bonus += parseInt(rows[0].defense);
								bonus += parseInt(rows[0].saddle);
								var dragon_crit = rows[0].critical;
								if ((class_id == 7) && (reborn == 3)){
									dragon_crit += 5;
								}
								if ((class_id == 7) && (reborn >= 4)){
									dragon_crit += 7;
								}
								if ((class_id == 7) && (reborn == 5)){
									critical += dragon_crit/2;
								}
							}

							if ((class_id == 8) && (reborn > 1)){
								danno += danno*0.1;
							}
							if ((class_id == 8) && (reborn == 5)){
								danno += danno*0.1;
							}
							if ((class_id == 8) && ((reborn == 3) || (reborn >= 4))){
								danno += danno*0.07;
							}

							connection.query('SELECT * FROM dungeon_status WHERE player_id = ' + player_id + ' AND monster_id != 0', function(err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "Non sei in combattimento contro un mostro!", back);
									return;
								}

								var monster_id = rows[0].monster_id;
								var monster_life = rows[0].monster_life;
								var boss_battle = rows[0].boss_battle;
								var room_id = rows[0].room_id;
								var dungeon_id = rows[0].dungeon_id;
								var pass_id = rows[0].pass;

								var paralyzed = rows[0].monster_paralyzed;
								var critic = rows[0].monster_critic;

								connection.query('SELECT * FROM dungeon_monsters WHERE id = ' + monster_id, function(err, rows, fields) {
									if (err) throw err;

									var monster_name = rows[0].name;
									var monster_total_life = rows[0].life;
									var monster_level = rows[0].level;
									var weapon_id = rows[0].weapon_id;
									var weapon2_id = rows[0].weapon2_id;
									var weapon3_id = rows[0].weapon3_id;

									connection.query('SELECT name, power, critical FROM item WHERE id = ' + weapon_id, function(err, rows, fields) {
										if (err) throw err;

										var weapon_dmg = rows[0].power;
										var weapon_name = rows[0].name + " (+" + rows[0].power + ")";

										connection.query('SELECT name, power_armor, critical FROM item WHERE id = ' + weapon2_id, function(err, rows, fields) {
											if (err) throw err;

											var weapon2_name = "-";
											var weapon2_dmg = 0;
											var en_crit2 = 0;
											if (Object.keys(rows).length > 0){
												weapon2_dmg = rows[0].power_armor;
												weapon2_name = rows[0].name + " (" + rows[0].power_armor + ")";
												en_crit2 = rows[0].critical;
											}

											connection.query('SELECT name, power_shield, critical FROM item WHERE id = ' + weapon3_id, function(err, rows, fields) {
												if (err) throw err;

												var weapon3_name = "-";
												var weapon3_dmg = 0;
												var en_crit3 = 0;
												if (Object.keys(rows).length > 0){
													weapon3_dmg = rows[0].power_shield;
													weapon3_name = rows[0].name + " (" + rows[0].power_shield + ")";
													en_crit3 = rows[0].critical;
												}

												var dBattleM = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Attacca " + monster_name],["Incantesimi"],["Scappa","âš’","Torna al dungeon"]]
													}
												};

												var dNext = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Prosegui il dungeon"],["Torna al menu"]]
													}
												};

												var dBattle = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Attacca"],["Torna al menu"]]
													}
												};

												var status = "Normale";

												if (paralyzed > 0){
													status = "Paralizzato (" + (paralyzed-1) + " turni)";
												}
												if (critic > 0){
													status = "Vulnerabile (" + critic + " turni)";
												}

												bot.sendMessage(message.chat.id,"*" + monster_name + "*\nStato: " + status + "\nSalute: " + monster_life + "/" + monster_total_life + "\n" +
																"Arma: " + weapon_name + "\n" +
																"Armatura: " + weapon2_name + "\n" +
																"Scudo: " + weapon3_name + "\n" +
																"\nLa tua salute: " + player_life + " hp", dBattleM).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {

														if (answer.text == "Scappa"){
															bot.sendMessage(message.chat.id, "Sicuro di voler uscire dal dungeon?", dYesNo).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if (answer.text.toLowerCase() == "si"){

																		var rand = Math.random()*100;
																		if (rand < 50){
																			var dmg = Math.round(player_total_life*50/100);
																		}else{
																			var dmg = Math.round(player_total_life*40/100);
																		}

																		var exText = "";

																		connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});

																		if (player_life - dmg <= 0){
																			exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																			var d = new Date();
																			d.setHours(d.getHours() + wait_dungeon_long);
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																			if (rank > 0){
																				connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																			connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}else{
																			exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																			var d = new Date();
																			d.setHours(d.getHours() + (wait_dungeon-1));
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																		connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																		bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																	}
																}
															});
															return;
														}
														if (answer.text.indexOf("Attacca") == -1){
															return;
														}

														if (paralyzed > 0){
															connection.query('UPDATE dungeon_status SET monster_paralyzed = monster_paralyzed-1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}
														if (critic > 0){
															connection.query('UPDATE dungeon_status SET monster_critic = monster_critic-1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														}

														if (magic != 0){
															setAchievement(message.chat.id, player_id, 6, 1);
														}

														var meParalyzed = 0;
														if (player_paralyzed > 0){
															connection.query('UPDATE player SET paralyzed = paralyzed-1 WHERE id = ' + player_id, function(err, rows, fields){
																if (err) throw err;
															});
															meParalyzed = 1;
															danno = 0;
														}

														if ((magic == 2) && (meParalyzed == 0)){
															var turn = 0;
															turn = Math.floor(magicPow/100)+1;
															var r = Math.random()*100;
															if ((automagic == 1) && (r < 50))
																turn++;
															connection.query('UPDATE dungeon_status SET monster_paralyzed = ' + turn + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																if (magicDouble == 1){
																	bot.sendMessage(message.chat.id, "Il mostro Ã¨ stato paralizzato per " + turn + " turni (x2)!");
																}else{
																	bot.sendMessage(message.chat.id, "Il mostro Ã¨ stato paralizzato per " + turn + " turni!");
																}
															});
														}

														if ((magic == 4) && (meParalyzed == 0)){
															var turn = 0;
															turn = Math.floor(magicPow/100)+1;
															connection.query('UPDATE dungeon_status SET monster_critic = ' + turn + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																if (magicDouble == 1){
																	bot.sendMessage(message.chat.id, "Il mostro Ã¨ vulnerabile ai colpi critici per " + turn + " turni (x2)!");
																}else{
																	bot.sendMessage(message.chat.id, "Il mostro Ã¨ vulnerabile ai colpi critici per " + turn + " turni!");
																}
															});
														}

														if ((magic != 0) && (automagic == 0) && (meParalyzed == 0)){
															connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields){
																if (err) throw err;
																//console.log("Magia con ID " + magicId + " utilizzata");
															});
														}

														connection.query('SELECT * FROM dungeon_status WHERE player_id = ' + player_id + ' AND monster_id != 0', function(err, rows, fields) {
															if (err) throw err;

															paralyzed = rows[0].monster_paralyzed;
															critic = rows[0].monster_critic;

															if (critic != 0){
																critical = 80;
															}

															if ((critical_rand <= critical) && (meParalyzed == 0)){
																danno = danno*2;
																crit_bool = 1;
																setAchievement(message.chat.id, player_id, 33, 1);
																crit_txt = " CRITICI";
															}

															var magic_txt = "";
															if ((magic == 3) && (meParalyzed == 0)){
																var prop = 100*magicPow/200;
																danno = danno*(prop/15);
																if (magicDouble == 1){
																	magic_txt = " con un incantesimo (x2)";
																}else{
																	magic_txt = " con un incantesimo";
																}
															}

															var magic_txt2 = "";
															var extra_bonus = 0;
															if ((magic == 1) && (meParalyzed == 0)){
																var prop = 100*magicPow/200;
																extra_bonus = bonus*(prop/5);
																if (magicDouble == 1){
																	magic_txt2 = ", assorbito grazie ad un incantesimo (x2)";
																}else{
																	magic_txt2 = ", assorbito grazie ad un incantesimo";
																}
															}

															var damage = 0;
															var min = (monster_level*7)+weapon_dmg;
															var max = min*1.5;
															damage = Math.round(Math.random()*max+min)-bonus;
															var heal = Math.round(Math.abs(player_total_life*0.1-damage));
															damage = damage-extra_bonus;

															//console.log(damage, min, max);

															var critical_rand2 = Math.round(Math.random()*100)+1;
															var crit_txt2 = "";

															if ((critical_rand2 <= critical_armor) && (meParalyzed == 0)){
																damage = damage/1.5;
																damage = damage/1.5;
																crit_txt2 = ", ridotti grazie alla tua corazza";
																setAchievement(message.chat.id, player_id, 31, 1);
															}

															if (charm_id == 63){
																damage = damage-5;
															}else if (charm_id == 186){
																damage = damage-15;
															}else if (charm_id == 189){
																damage = damage-20;
															}

															if ((class_id == 2) && (reborn > 1)){
																damage += damage*0.05;
															}
															if ((class_id == 6) && (reborn > 1)){
																damage -= damage*0.15;
															}
															if ((class_id == 8) && (reborn > 1)){
																damage += damage*0.1;
															}
															if ((class_id == 8) && (reborn == 5)){
																damage += damage*0.1;
															}
															if ((class_id == 8) && ((reborn == 3) || (reborn >= 4))){
																damage += damage*0.07;
															}
															if ((class_id == 9) && (reborn > 1)){
																damage += damage*0.1;
															}

															damage = Math.round(damage);

															if (damage <= 0){
																damage = 0;
															}

															var critical_rand3 = Math.round(Math.random()*100)+1;
															if ((critical_rand3 <= critical_shield) && (meParalyzed == 0)){
																damage = 0;
															}

															danno = danno-(Math.abs(weapon2_dmg)+Math.abs(weapon3_dmg));

															var enemy_magic = "";
															var enemy_magicRand = Math.random()*100;
															var heal_enemy = 0;
															if (monster_level >= 50){
																if ((monster_level-49) > enemy_magicRand){
																	var rand = Math.random()*100;


																	if (rand < 30){
																		var r = 100;
																		rand = Math.random()*100;
																		if (player_weapon3_id == 672){
																			r = 70;
																		}
																		if (r >= rand){
																			enemy_magic = "Impeto di Fiamme";
																			damage = damage*4;
																		}
																	}else if (rand < 60){
																		var r = 100;
																		rand = Math.random()*100;
																		if (player_weapon3_id == 673){
																			r = 70;
																		}
																		if (r >= rand){
																			enemy_magic = "Furia dei Mari";
																			heal_enemy = Math.round(Math.abs(monster_total_life*0.1-danno));
																			if (monster_life+heal_enemy > monster_total_life){
																				heal_enemy = monster_total_life-monster_life;
																			}
																			if (heal_enemy < 0)
																				heal_enemy = Math.abs(heal_enemy);
																			if (heal_enemy > 50000){
																				heal_enemy = 50000;
																			}
																			connection.query('UPDATE dungeon_status SET monster_life = monster_life+' + heal_enemy + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																	}else{
																		var r = 100;
																		rand = Math.random()*100;
																		if (player_weapon3_id == 671){
																			r = 70;
																		}
																		if (r >= rand){
																			enemy_magic = "Tempesta Folgorante";
																			connection.query('UPDATE player SET paralyzed = 2 WHERE id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																	}
																}
															}

															var multi = Math.round(Math.floor(player_exp/10)/10);
															if (multi >= 3){
																danno = danno*3;
																damage = damage*3;
															}else{
																danno = danno*multi;
																danno = danno*multi;
															}

															if ((boost_mission > 0) && (boost_id == 6)){
																connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
																danno = danno*2;
															}

															var en_rand = Math.random()*100;
															var crit_en2 = "";
															if (en_rand <= en_crit2){
																danno = danno/2;
																crit_en2 = ", ridotti a causa della sua corazza";
															}

															en_rand = Math.random()*100;
															if (en_rand <= en_crit3){
																danno = 0;
															}

															danno = Math.round(danno);

															var lifesum = monster_life - danno;
															if (lifesum <= 0){
																connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0, room_id = room_id+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;

																	var chest_id = Math.ceil(room_id/10);
																	var money = 0;
																	var moneyText = "";
																	var rand = Math.random()*100;
																	var exp = 1;

																	if (chest_id >= 4){
																		chest_id = 4;
																	}

																	money = Math.round(Math.random()*(room_id*10)+100+(rank*2));
																	var now = new Date();
																	if (now.getHours() < 6){
																		money = money*2;
																	}
																	moneyText = ", " + money + " Â§";

																	if (rand < 30){
																		chest_id++;
																	}
																	if (boss_battle == 1){
																		chest_id++;
																		//	exp += 1;
																	}

																	connection.query('SELECT name FROM chest WHERE id = ' + chest_id, function(err, rows, fields) {
																		if (err) throw err;
																		var chestName = rows[0].name;
																		connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + player_id + ',' + chest_id + ')', function (err, rows, fields) {
																			if (err) throw err;

																			bot.sendMessage(message.chat.id, "Hai ucciso il mostro, infliggendo " + danno + " danni, ottenuto *" + exp + " exp*" + moneyText + " ed uno *" + chestName + "*!", dNext);

																			setAchievement(message.chat.id, player_id, 3, 1);

																			if (boss_battle == 1){
																				connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;

																					var rankPoint = 1;
																					if (luckyMode == 1){
																						var rand = Math.random()*100;
																						if (rand < 50){
																							rankPoint = 2;
																						}else{
																							rankPoint = 0;
																						}
																					}

																					var refill = "";
																					if (player_life < player_total_life/2){
																						connection.query('UPDATE player SET life = ROUND(total_life/2,0) WHERE id = ' + player_id, function(err, rows, fields){
																							if (err) throw err;
																						});
																						refill = "Inoltre la tua salute Ã¨ stata ricaricata fino al 50%!";
																					}
																					setAchievement(message.chat.id, player_id, 26, 1);
																					setAchievementProgress(player_id, 3);
																					bot.sendMessage(message.chat.id, "Hai completato il dungeon! Hai ottenuto " + rankPoint + " punto rango!\n" + refill, back);

																					if (pass_id != 0){
																						connection.query('SELECT chat_id FROM player WHERE id = ' + pass_id, function (err, rows, fields){
																							if (err) throw err;
																							bot.sendMessage(rows[0].chat_id, "Il tuo compagno ha completato il dungeon ed hai ottenuto " + rankPoint + " punti rango!");
																							connection.query('UPDATE player SET rank = rank+' + rankPoint + ' WHERE id = ' + pass_id, function (err, rows, fields){
																								if (err) throw err;
																							});
																						});
																					}

																					var rand = Math.round(Math.random()*100);
																					if ((rand <= 5) && (rank > 20)){
																						connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',618)', function(err, rows, fields) {
																							if (err) throw err;
																							bot.sendMessage(message.chat.id, "Sul pavimento appena fuori dal dungeon hai trovato una *Capsula di Prelevazione Tipo B*! Che fortuna!", mark);
																						});
																					}

																					var d = new Date();
																					d.setHours(d.getHours() + wait_dungeon);
																					var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																					connection.query('UPDATE player SET dungeon_count = dungeon_count+1, dungeon_time = "' + long_date + '", rank = rank+' + rankPoint + ' WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});

																					connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																				});
																			}

																			var d = new Date();
																			var sec = wait_room;

																			if (abBonus2 > 0){
																				sec -= abBonus2;
																			}
																			//	if (crazyMode == 0){
																			if ((class_id == 3) && (reborn == 3)){
																				sec = sec-120;
																			}
																			if ((class_id == 9) && (reborn > 1)){
																				sec = sec-120;
																			}
																			if ((class_id == 9) && (reborn == 5)){
																				sec = sec-180;
																			}
																			if ((class_id == 3) && (reborn >= 4)){
																				sec = sec-300;
																			}
																			//	}
																			d.setSeconds(d.getSeconds() + sec);

																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																			connection.query('UPDATE dungeon_status SET room_time = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});

																			connection.query('UPDATE player SET exp = exp+' + exp + ', money = money+' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		});
																	});
																});
																return;
															}else{

																if (meParalyzed == 0){
																	if (danno == 0){
																		bot.sendMessage(message.chat.id, "Il mostro ha evitato il tuo colpo!");
																	}else{
																		bot.sendMessage(message.chat.id, "Hai colpito il mostro e hai inferto *" + danno + "* danni" + crit_txt + magic_txt + crit_en2 + "!", mark);
																	}
																}else if (meParalyzed == 1){
																	if ((player_paralyzed-1) != 0){
																		bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il mostro, sei ancora paralizzato per " + (player_paralyzed-1) + " turni");
																	}else{
																		bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il mostro, e ora non sei piÃ¹ paralizzato");
																	}
																}
																connection.query('UPDATE dungeon_status SET monster_life = ' + lifesum + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
															}

															if (paralyzed > 0){
																bot.sendMessage(message.chat.id, "Il mostro Ã¨ paralizzato!", dBattle);
																return;
															}

															var extra = "";
															if (enemy_magic != ""){
																extra = "ha lanciato *" + enemy_magic + "* e ";
																if (heal_enemy != 0){
																	extra += " recuperato " + heal_enemy + " hp";
																}
															}

															var mylifesum = player_life - damage;
															if (mylifesum <= 0){
																connection.query('UPDATE player SET life = life-' + damage + ' WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;

																		if (extra != ""){
																			bot.sendMessage(message.chat.id, "Il mostro " + extra + " e ti ha ucciso, vieni riportato all'entrata del dungeon.\nIl tuo rango viene ridotto.", back);
																		}else{
																			bot.sendMessage(message.chat.id, "Sei stato ucciso dal mostro, vieni riportato all'entrata del dungeon.\nIl tuo rango viene ridotto.", back);
																		}

																		var d = new Date();
																		d.setHours(d.getHours() + wait_dungeon_long);
																		var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																		connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields){
																			if (err) throw err;
																		});
																		connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																		});

																		if (rank > 0){
																			connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function(err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																	});
																});
																return;
															}else{
																var text2 = " hai perso *" + damage + "* hp" + crit_txt2 + "!";
																connection.query('UPDATE player SET life = life-' + damage + ' WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	if (magic_txt2 != ""){
																		connection.query('UPDATE player SET life = life+' + heal + ' WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			calcLife(message);
																			console.log("Ricarica salute: " + heal);
																		});
																		if (magicDouble == 1){
																			magic_txt2 += " (+" + heal + " hp - x2)";
																		}else{
																			magic_txt2 += " (+" + heal + " hp)";
																		}
																	}

																	if (damage == 0){
																		if (extra != ""){
																			bot.sendMessage(message.chat.id, "Il mostro " + extra + ", ma il suo attacco successivo ha colpito a vuoto" + magic_txt2 + "!", dBattle);
																		}else{
																			bot.sendMessage(message.chat.id, "Il mostro ha colpito a vuoto" + magic_txt2 + "!", dBattle);
																		}
																	}else{
																		bot.sendMessage(message.chat.id, "Il mostro " + extra + "ti ha ferito," + text2 + magic_txt2, dBattle);
																	}
																});
															}
														});	
													};
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});	
});

bot.onText(/cassa rinascita|torna alla cassa/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var exp = rows[0].exp;

		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Torna alla cassa"]]
			}
		};

		var kbConf = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Conferma"],["Torna alla cassa"]]
			}
		};

		connection.query('SELECT rarity.shortname FROM reborn_chest_status, rarity WHERE rarity.id = rarity_id AND player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			var saved = "";
			if (Object.keys(rows).length > 0){
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					saved = saved + rows[i].shortname + " ";
				}
			}else{
				saved = "Nessuna";
			}

			if ((reborn != 1) && (exp < 50)){
				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Recupera RaritÃ  C","Recupera RaritÃ  NC"],["Recupera RaritÃ  R","Recupera RaritÃ  UR"],["Recupera RaritÃ  L","Recupera RaritÃ  E"],["Torna al menu"]]
					}
				};
				bot.sendMessage(message.chat.id, 	"A questo livello puoi solamente ritirare oggetti dalla Cassa Rinascita, seleziona la raritÃ ." +
								"\n\n*RaritÃ  salvate*: " + saved, kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text.indexOf("Recupera RaritÃ ") != -1){
							var split = answer.text.split(" ");
							if ((split[2] == "C") || (split[2] == "NC") || (split[2] == "R") || (split[2] == "UR") || (split[2] == "L") || (split[2] == "E")){
								var rarity = split[2];
								connection.query('SELECT id FROM rarity WHERE shortname = "' + rarity + '"', function(err, rows, fields) {
									if (err) throw err;

									var rarity_id = rows[0].id;
									connection.query('SELECT * FROM reborn_chest_status WHERE player_id = ' + player_id + ' AND rarity_id = ' + rarity_id,  function(err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "Questa raritÃ  non Ã¨ salvata", kbBack);
											return;
										}
										var rnext = 0;
										rnext = parseInt(rows[0].reborn)+parseInt(1);
										if (rnext != reborn){
											bot.sendMessage(message.chat.id, "Non puoi ritirare a questo livello rinascita", kbBack);
											return;
										}

										var parent_id = rows[0].id;

										connection.query('SELECT item_id FROM reborn_chest WHERE parent_id = ' + parent_id, function(err, rows, fields) {
											if (err) throw err;
											if (Object.keys(rows).length == 0){
												bot.sendMessage(message.chat.id, "Non ho trovato oggetti salvati di quella raritÃ ", kbBack);
												return;
											}
											var c = 0;
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[i].item_id + ')', function(err, rows, fields) {
													if (err) throw err;
												});
												//console.log("RECOVER " + rarity + " " + rows[i].item_id);
												c++;
											}
											connection.query('DELETE FROM reborn_chest WHERE parent_id = ' + parent_id, function(err, rows, fields) {
												if (err) throw err;
												connection.query('DELETE FROM reborn_chest_status WHERE id = ' + parent_id, function (err, rows, fields){
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai ritirato " + c + " oggetti di raritÃ  " + rarity + "!", kbBack);
												});
											});
										});
									});
								});
							}else{
								bot.sendMessage(message.chat.id, "RaritÃ  non valida", back);
							}
						}
					};
				});

				return;
			}

			if (reborn == 1){
				if (exp < 1000){
					bot.sendMessage(message.chat.id, "Raggiungi il livello 100 per accedere alla cassa rinascita.", back);
					return;
				}
			}else if (reborn == 2){
				if (exp < 1500){
					bot.sendMessage(message.chat.id, "Raggiungi il livello 150 per accedere alla cassa rinascita.", back);
					return;
				}
			}else if (reborn == 3){
				if (exp < 2000){
					bot.sendMessage(message.chat.id, "Raggiungi il livello 200 per accedere alla cassa rinascita.", back);
					return;
				}
			}else if (reborn == 4){
				if (exp < 3000){
					bot.sendMessage(message.chat.id, "Raggiungi il livello 300 per accedere alla cassa rinascita.", back);
					return;
				}else if (exp == 3000){
					bot.sendMessage(message.chat.id, "Per questa rinascita non Ã¨ necessaria la cassa.", back);
					return;					
				}
			}else if (reborn == 5){
				bot.sendMessage(message.chat.id, "Hai raggiunto il massimo livello di rinascita, non puoi accedere.", back);
				return;			
			}

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Salva RaritÃ  C","Salva RaritÃ  NC"],["Salva RaritÃ  R","Salva RaritÃ  UR"],["Salva RaritÃ  L","Salva RaritÃ  E"],["Torna al menu"]]
				}
			};

			bot.sendMessage(message.chat.id, 	"La *Cassa Rinascita* ti serve per salvare gli oggetti al prezzo di alcune gemme (piÃ¹ bassa la raritÃ , piÃ¹ gemme richieste).\n*ATTENZIONE*\nDopo aver depositato una raritÃ  hai 24 ore per ritirarla, altrimenti verrÃ  eliminata totalmente, puoi depositarla solo una volta. Inoltre puoi ritirare gli oggetti solo fino al livello 5 dopo la rinascita. Quale raritÃ  vuoi salvare?" +
							"\n\n*RaritÃ  salvate*: " + saved, kb).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text.indexOf("Salva RaritÃ ") != -1){
						var split = answer.text.split(" ");
						if ((split[2] == "C") || (split[2] == "NC") || (split[2] == "R") || (split[2] == "UR") || (split[2] == "L") || (split[2] == "E")){

							var rarity = split[2].trim();

							connection.query('SELECT id FROM rarity WHERE shortname = "' + rarity + '"', function(err, rows, fields) {
								if (err) throw err;

								var rarity_id = rows[0].id;
								var gems = 0;	

								if (rarity_id >= 5){
									gems = 0;
								}else if (rarity_id >= 3){
									gems = 1;
								}else{
									gems = 1;
								}

								connection.query('SELECT * FROM reborn_chest_status WHERE rarity_id = ' + rarity_id + ' AND player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length > 0){
										bot.sendMessage(message.chat.id, "Questa raritÃ  Ã¨ giÃ  salvata", kbBack);
										return;
									}

									connection.query('SELECT COUNT(*) As cnt FROM inventory_rarity WHERE rarity_id = ' + rarity_id + ' AND player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;

										var cnt = rows[0].cnt;

										bot.sendMessage(message.chat.id, "Stai per salvare la raritÃ  " + rarity + " che consiste in " + cnt + " oggetti al prezzo di " + gems + " gemme, continuare?", kbConf).then(function() {
											answerCallbacks[message.chat.id] = function(answer) {
												if (answer.text.toLowerCase() == "conferma"){
													connection.query('SELECT gems FROM player WHERE id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
														if (rows[0].gems < gems){
															bot.sendMessage(message.chat.id, "Non hai abbastanza gemme", kbBack);
															return;
														}
														connection.query('UPDATE player SET gems = gems-' + gems + ' WHERE id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;

															var d = new Date();
															d.setHours(d.getHours()+24);
															var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
															var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

															connection.query('INSERT INTO reborn_chest_status (player_id, rarity_id, reborn, time_end) VALUES (' + player_id + ',' + rarity_id + ',' + reborn + ',"' + long_date + '")', function(err, rows, fields) {
																if (err) throw err;

																connection.query('SELECT id FROM reborn_chest_status WHERE player_id = ' + player_id + ' AND rarity_id = ' + rarity_id, function(err, rows, fields) {
																	if (err) throw err;

																	var parent_id = rows[0].id;

																	connection.query('SELECT item_id FROM inventory_rarity WHERE rarity_id = ' + rarity_id + ' AND player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;
																		var c = 0;
																		if (Object.keys(rows).length > 0){
																			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																				connection.query('INSERT INTO reborn_chest (player_id, item_id, parent_id) VALUES (' + player_id + ',' + rows[i].item_id + ',' + parent_id + ')', function(err, rows, fields) {
																					if (err) throw err;
																				});
																				console.log("INSERT " + rarity + " " + rows[i].item_id);
																				c++;
																			}
																		}
																		connection.query('DELETE inventory FROM inventory, item, rarity WHERE inventory.item_id = item.id AND item.rarity = rarity.shortname AND rarity.id = ' + rarity_id + ' AND player_id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai depositato " + c + " oggetti di raritÃ  " + rarity + "!\nHai tempo fino alle " + short_date + " di domani per recuperarle!", kbBack);
																		});
																	});
																});
															});
														});
													});
												}
											};
										});	
									});
								});
							});
						}else{
							bot.sendMessage(message.chat.id, "RaritÃ  non valida", kbBack);
						}
					}
				};
			});
		});
	});	
});

bot.onText(/rinasci/i, function(message) {

	if (message.text.toLowerCase() == "cassa rinascita"){
		return;
	}

	if (message.text.indexOf("Rinascita") != -1){
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var maxlev = 150;

		if (reborn == 1){
			maxlev = 150;
			if (rows[0].exp < 1000){
				bot.sendMessage(message.chat.id, "Raggiungi il livello 100 per accedere alla rinascita.", back);
				return;
			}
		}else if (reborn == 2){
			maxlev = 200;
			if (rows[0].exp < 1500){
				bot.sendMessage(message.chat.id, "Raggiungi il livello 150 per accedere alla rinascita.", back);
				return;
			}
		}else if (reborn == 3){
			maxlev = 300;
			if (rows[0].exp < 2000){
				bot.sendMessage(message.chat.id, "Raggiungi il livello 200 per accedere alla rinascita.", back);
				return;
			}
		}else if (reborn == 4){
			maxlev = 1000;
			if (rows[0].exp < 3000){
				bot.sendMessage(message.chat.id, "Raggiungi il livello 300 per accedere alla rinascita.", back);
				return;
			}
		}else{
			bot.sendMessage(message.chat.id, "Hai raggiunto il massimo livello di rinascita.", back);
			return;			
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Avvia Rinascita " + reborn],["Cassa Rinascita"],["Torna al menu"]]
			}
		};

		var text = "Vuoi rinascere?\nIl tuo personaggio perderÃ  exp, zaino, usa /faq nel @xxxplusbot per informazioni dettagliate. Riceverai il simbolo di rinascita nelle informazioni del tuo account, inoltre un premio in Â§ e una grande quantitÃ  di Scrigni per ricominciare a creare oggetti!\nDopo la rinascita il livello massimo sarÃ  " + maxlev + "!";

		if (reborn == 4){
			text = "Vuoi rinascere?\nIl tuo personaggio stavolta non perderÃ  nulla, riceverai il simbolo speciale e il massimo livello sarÃ  il 1000. Tuttavia per iniziare la rinascita ti servono almeno due Artefatti!\nProcedi?";
		}

		bot.sendMessage(message.chat.id, text, kb).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				var resp = answer.text;
				if (resp == "Avvia Rinascita " + reborn){
					if (reborn == 1){
						var money = 250000;
						var reborn_val = 2;
						var chest1 = 30;
						var chest2 = 25;
						var chest3 = 20;
						var chest4 = 15;
						var chest5 = 10;
						var chest6 = 5;
						var chest7 = 1;

						connection.query('SELECT * FROM referral_list WHERE new_player = ' + player_id, function (err, rows, fields){
							if (err) throw err;
							if (Object.keys(rows).length > 0){
								connection.query('SELECT chat_id, id FROM player WHERE id = ' + rows[0].player_id, function (err, rows, fields){
									if (err) throw err;
									var chat_id = rows[0].chat_id;
									connection.query('UPDATE player SET gems = gems+1, money = money+100000 WHERE id = ' + rows[0].id, function (err, rows, fields){
										if (err) throw err;
										bot.sendMessage(chat_id, "L'utente " + message.from.username + " che hai invitato ha appena raggiunto la Rinascita 1! Hai ottenuto cosÃ¬ una Gemma e 100.000 Â§!");
									});
								});
							}
						});

					}else if (reborn == 2){
						var money = 500000;
						var reborn_val = 3;
						var chest1 = 50;
						var chest2 = 45;
						var chest3 = 35;
						var chest4 = 30;
						var chest5 = 20;
						var chest6 = 10;
						var chest7 = 1;
					}else if (reborn == 3){
						var money = 750000;
						var reborn_val = 4;
						var chest1 = 100;
						var chest2 = 70;
						var chest3 = 60;
						var chest4 = 50;
						var chest5 = 40;
						var chest6 = 20;
						var chest7 = 2;
					}else if (reborn == 4){
						var reborn_val = 5;

						connection.query('SELECT COUNT(id) As num FROM artifacts WHERE player_id = ' + player_id, function (err, rows, fields){
							if (err) throw err;

							if (rows[0].num < 2){
								bot.sendMessage(message.chat.id, "Devi prima ottenere almeno due artefatti!", back);
								return;
							}

							connection.query('UPDATE player SET exp = 1, life = 100, total_life = 100, mission_auto_id = 1, heist_count = 0, reborn = ' + reborn_val + ' WHERE id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai completato l'ultima rinascita! Ma la strada Ã¨ ancora lunga!", back);
							});
						});
						return;
					}else{
						bot.sendMessage(message.chat.id, "Rinascita non valida!", back);
						return;
					}

					connection.query('UPDATE player SET exp = 1, life = 100, total_life = 100, money = ' + money + ', mission_auto_id = 1, heist_count = 0, reborn = ' + reborn_val + ' WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						console.log("Player resettato e soldi consegnati");
						connection.query('DELETE inventory FROM inventory, item WHERE inventory.item_id = item.id AND rarity != "H" AND rarity != "U" AND rarity != "UE" AND rarity != "X" AND rarity != "S" AND player_id=' + player_id, function(err, rows, fields) {
							if (err) throw err;
							console.log("Inventario svuotato");
							connection.query('DELETE FROM inventory_chest WHERE player_id=' + player_id, function(err, rows, fields) {
								if (err) throw err;
								console.log("Inventario scrigni svuotato");
								for (var i = 0; i < chest1; i++) {
									connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',1)', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Scrigni C consegnati");
								for (var i = 0; i < chest2; i++) {
									connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',2)', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Scrigni NC consegnati");
								for (var i = 0; i < chest3; i++) {
									connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',3)', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Scrigni R consegnati");
								for (var i = 0; i < chest4; i++) {
									connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',4)', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Scrigni UR consegnati");
								for (var i = 0; i < chest5; i++) {
									connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',5)', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Scrigni L consegnati");
								for (var i = 0; i < chest6; i++) {
									connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',6)', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Scrigni E consegnati");
								for (var i = 0; i < chest7; i++) {
									connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',7)', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Scrigni U consegnati");
								bot.sendMessage(message.chat.id, "Complimenti, " + message.from.username + "!\n" +
												"Hai completato la rinascita " + reborn + " e hai ottenuto:\n" + 
												chest1 + " Scrigni di Legno\n" +
												chest2 + " Scrigni di Ferro\n" +
												chest3 + " Scrigni Preziosi\n" +
												chest4 + " Scrigni di Diamante\n" +
												chest5 + " Scrigni Leggendari\n" +
												chest6 + " Scrigni Epici\n" +
												chest7 + " Scrigni Capsula\n" +
												"Oltre a " + money + " Â§\n" +
												"Ed ora continua la tua incredibile avventura! Buon game!", back_html);
								console.log("Finito :)");
							});
						});
					});
				}
			};
		});
	});
});

bot.onText(/reincarnazione/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var hide_btn = "";

		if (rows[0].hide_rein == 1){
			hide_btn = "Mostra Pulsante";
		}else{
			hide_btn = "Nascondi Pulsante";
		}

		if (reborn < 5){
			if (rows[0].exp < 10000){
				bot.sendMessage(message.chat.id, "Raggiungi il livello 1000 R4 per accedere alla reincarnazione.", back);
				return;
			}
		}

		connection.query('SELECT COUNT(item_id) As cnt FROM artifacts WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (rows[0].cnt < 5){
				bot.sendMessage(message.chat.id, "Devi possedere tutti e 5 gli artefatti per procedere.", back);
				return;
			}

			connection.query('SELECT * FROM reincarnation WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				var rein = 0;
				if (Object.keys(rows).length == 0){
					connection.query('INSERT INTO reincarnation (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
						if (err) throw err;
					});
				}else{
					rein = parseInt(rows[0].rein);
				}

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Avvia Reincarnazione " + (rein+1)],[hide_btn],["Torna al menu"]]
					}
				};

				if (message.from.username != "fenix45"){
					bot.sendMessage(message.chat.id, "La reincarnazione non Ã¨ ancora pronta ðŸ‘€", back);
					return;
				}

				var text = "Vuoi procedere alla *Reincarnazione*?\nIl tuo personaggio verrÃ  resettato completamente ma otterrai *5 Punti Anima* per accedere ai bonus esclusivi che dureranno per sempre!";
				bot.sendMessage(message.chat.id, text, kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						var resp = answer.text;
						if (resp == "Avvia Reincarnazione " + (rein+1)){
							bot.sendMessage(message.chat.id, "Sei veramente sicuro? Questa azione Ã¨ irreversibile", yesno).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text.toLowerCase() == "si"){

										return;		//WARNING

										connection.query('UPDATE player SET exp = 0, reborn = 0 WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM ability WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM artifacts WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM boss_damage WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM inventory_chest WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM contest WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM heist WHERE from_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM heist_progress WHERE from_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM magic WHERE from_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});


									}
								};
							});
						}else if ((resp == "Nascondi Pulsante") || (resp == "Mostra Pulsante")){
							if (resp == "Nascondi Pulsante"){
								connection.query('UPDATE player SET hide_rein = 1 WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il pulsante Ã¨ stato nascosto dal menu, per mostrarlo nuovamente scrivi 'Reincarnazione'", back);
								});
							}else{
								connection.query('UPDATE player SET hide_rein = 0 WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il pulsante Ã¨ stato reso nuovamente visibile nel menu", back);
								});
							}
						}
					}
				});
			});
		});
	});
});

bot.onText(/link invito/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		code = "*Il tuo codice invito*: https://telegram.me/xxxgamebot?start=" + rows[0].invite_code;
		bot.sendMessage(message.chat.id, code, no_preview_back);
	});
});

bot.onText(/Ritorna/i, function(message) {
	connection.query('SELECT holiday, travel_id, travel_time_end, cave_id, cave_time_end FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var travel_time_end = rows[0].travel_time_end;
		var cave_time_end = rows[0].cave_time_end;

		if ((rows[0].travel_id == 0) && (rows[0].cave_id == 0)){
			bot.sendMessage(message.chat.id, "Non sei in viaggio.", back);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		bot.sendMessage(message.chat.id, "Sicuro di voler annullare il viaggio?", yesno).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text.toLowerCase() == "si"){
					if (rows[0].travel_id != 0){
						connection.query('SELECT duration FROM travel WHERE id = ' + rows[0].travel_id, function(err, rows, fields) {
							if (err) throw err;
							connection.query('UPDATE player SET travel_id = 0, travel_time_end = NULL, exp = exp-1 WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Sei rientrato dal viaggio senza averlo completato.", back);
							});
						});
					}else if (rows[0].cave_id != 0){
						connection.query('SELECT duration FROM cave WHERE id = ' + rows[0].cave_id, function(err, rows, fields) {
							if (err) throw err;
							connection.query('UPDATE player SET cave_id = 0, cave_time_end = NULL, exp = exp-1 WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Sei rientrato dal viaggio cava senza averlo completato.", back);
							});
						});
					}
				}
			};
		});
	});
});

bot.onText(/Termina subito/i, function(message) {
	connection.query('SELECT holiday, gems, mission_id, mission_time_end, id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var mission_time_end = rows[0].mission_time_end;
		var player_id = rows[0].id;

		if (rows[0].mission_id == 0){
			bot.sendMessage(message.chat.id, "Non sei in missione.", back);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		bot.sendMessage(message.chat.id, "Sicuro di voler terminare subito la missione?\nConsumerai una ðŸ’Ž ", yesno).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text.toLowerCase() == "si"){
					if (rows[0].gems < 1){
						bot.sendMessage(message.chat.id, "Non hai abbastanza gemme.", back);
						return;
					}

					setAchievement(message.chat.id, player_id, 24, 1);

					var d2 = new Date();
					var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth()+1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

					connection.query('UPDATE player SET gems = gems-1, mission_time_end = "' + long_date + '" WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Fatto! Attendi qualche secondo per ricevere il premio.", back);
					});
				}
			};
		});
	});
});

bot.onText(/Completa immediatamente/i, function(message) {
	connection.query('SELECT holiday, gems, id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var gems = rows[0].gems;

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		connection.query('SELECT id FROM heist WHERE from_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non hai un ispezione in corso", back);
				return;
			}

			bot.sendMessage(message.chat.id, "Sicuro di voler terminare subito l'ispezione?\nConsumerai due ðŸ’Ž ", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text.toLowerCase() == "si"){
						if (gems < 2){
							bot.sendMessage(message.chat.id, "Non hai abbastanza gemme.", back);
							return;
						}

						var d2 = new Date();
						var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth()+1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

						connection.query('UPDATE heist SET datetime = "' + long_date + '" WHERE from_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							connection.query('UPDATE player SET gems = gems-2 WHERE id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Fatto! Attendi qualche secondo per conoscere il risultato.", back);
							});
						});
					}
				};
			});
		});
	});
});

bot.onText(/Scomponi/i, function(message) {
	connection.query('SELECT id, exp, reborn, holiday, gems, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var exp = rows[0].exp;
		var gems = rows[0].gems;
		var reborn = rows[0].reborn;

		if ((Math.floor(exp/10) < 50) && (reborn == 1)){
			bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ troppo basso", back);
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Niente"]]
			}
		};

		bot.sendMessage(message.chat.id, "Puoi scomporre un oggetto nei suoi oggetti di creazione utilizzando una ðŸ’Ž OLTRE A 50 exp, perderai anche i punti creazione. Scrivi il nome completo dell'oggetto da scomporre.", kb).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text == "Niente"){
					return;
				}else{
					var ogg = answer.text.trim();

					connection.query('SELECT item.id, item.rarity, item.craftable FROM item, inventory WHERE item.id = inventory.item_id AND inventory.player_id = ' + player_id + ' AND item.name = "' + ogg + '"', function(err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0){			
							bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato", back);
							return;
						}

						if (rows[0].craftable == 0){
							bot.sendMessage(message.chat.id, "L'oggetto selezionato non Ã¨ creabile", back);
							return;
						}

						bot.sendMessage(message.chat.id, "Sei sicuro? Consumerai una gemma e 50 punti exp", yesno).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Torna al menu"){
									return;
								}else if (answer.text.toLowerCase() == "si"){
									connection.query('SELECT item.id, item.rarity, item.craftable FROM item, inventory WHERE item.id = inventory.item_id AND inventory.player_id = ' + player_id + ' AND item.name = "' + ogg + '"', function(err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length == 0){			
											bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato", back);
											return;
										}

										var material_result = rows[0].id;
										var rarity = rows[0].rarity;

										if ((exp < 50) || (gems < 1)){
											bot.sendMessage(message.chat.id, "Non hai abbastanza esperienza o gemme", back);
											return;
										}else{
											connection.query('UPDATE player SET exp = exp-50, gems = gems-1 WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
											});
										}

										connection.query('SELECT material_1, material_2, material_3 FROM craft WHERE material_result = ' + material_result, function(err, rows, fields) {
											if (err) throw err;

											connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].material_1 + ')', function(err, rows, fields) {
												if (err) throw err;
											});
											connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].material_2 + ')', function(err, rows, fields) {
												if (err) throw err;
											});
											connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].material_3 + ')', function(err, rows, fields) {
												if (err) throw err;
											});

											connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + material_result + ' LIMIT 1', function(err, rows, fields) {
												if (err) throw err;
											});

											var craftexp = 0;

											if (rarity == "L"){
												craftexp = 3;
											}else if (rarity == "UR"){
												craftexp = 2;
											}else if (rarity == "E"){
												craftexp = 5;
											}else if (rarity == "X"){
												craftexp = 50;
											}else if (rarity == "UE"){
												craftexp = 25;
											}

											setAchievement(message.chat.id, player_id, 25, 1);

											connection.query('UPDATE player SET craft_count = craft_count-' + craftexp + ' WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai scomposto l'oggetto!", back);
											});
										});
									});
								}
							}
						});
					});
				}
			};
		});
	});	
});

bot.onText(/^Incanta/i, function(message) {

	if (message.text == "Incantaspade"){
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var gems = rows[0].gems;
		var w1 = parseInt(rows[0].weapon);
		var w2 = parseInt(rows[0].weapon2);
		var w3 = parseInt(rows[0].weapon3);
		var t1 = rows[0].weapon_enchant_end;
		var t2 = rows[0].weapon2_enchant_end;
		var t3 = rows[0].weapon3_enchant_end;

		if ((message.text.indexOf("Arma") != -1) || (message.text.indexOf("Armatura") != -1) || (message.text.indexOf("Scudo") != -1)){
			connection.query('SELECT item.name, item.rarity, COUNT(item.name) As num FROM player, inventory, item WHERE player.id = inventory.player_id AND item.rarity IN ("UR","L","E") AND inventory.item_id = item.id AND item.name LIKE "Runa%" AND player.id = ' + player_id + ' GROUP BY item.name', function(err, rows, fields) {
				if (err) throw err;

				var iKeys = [];

				if (Object.keys(rows).length > 0){
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						iKeys.push([rows[i].name + " (" + rows[i].rarity + ", " + rows[i].num + ")"]);
					}
				}

				iKeys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				var type = message.text.substring(message.text.indexOf(" ")+1);
				var text = "";
				var w_dmg = 0;
				var w_enc = 0;

				if (type == "Arma"){
					text = "dell'arma";
					w_dmg = w1;
					if (t1 != null){
						var d = new Date(t1);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
						bot.sendMessage(message.chat.id, "L'incantamento su questo oggetto Ã¨ ancora efficace fino alle " + short_date, back);
						return;
					}
				}
				if (type == "Armatura"){
					text = "dell'armatura";
					w_dmg = w2;
					if (t2 != null){
						var d = new Date(t2);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
						bot.sendMessage(message.chat.id, "L'incantamento su questo oggetto Ã¨ ancora efficace fino alle " + short_date, back);
						return;
					}
				}
				if (type == "Scudo"){
					text = "dello scudo";
					w_dmg = w3;
					if (t3 != null){
						var d = new Date(t3);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
						bot.sendMessage(message.chat.id, "L'incantamento su questo oggetto Ã¨ ancora efficace fino alle " + short_date, back);
						return;
					}
				}

				var kb2 = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Gemma"],["Runa"],["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Il valore attuale " + text + " Ã¨ *" + w_dmg + "*, puoi aumentarne temporaneamente il valore e attribuirle l'abilitÃ  di lancio incantesimi." +
								"\nL'effetto dell'incantamento durerÃ  48 ore\n" +
								"Vuoi utilizzare una gemma oppure una runa?", kb2).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {

						if (answer.text == "Torna al menu"){
							return;
						}else if (answer.text == "Runa"){
							bot.sendMessage(message.chat.id, "Quale Runa vuoi utilizzare?", kb).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {

									var runa = "";
									var pos = answer.text.indexOf("(");
									if (pos != -1){
										runa = answer.text.substr(0, pos-1);
									}

									connection.query('SELECT item.name, item.id, item.rarity FROM player, inventory, item WHERE player.id = inventory.player_id AND inventory.item_id = item.id AND item.name = "' + runa + '" AND player.id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "Non possiedi abbastanza Rune!", back);
											return;
										}

										var rand = 0;
										if (rows[0].rarity == "UR"){
											rand = Math.random()*5+5;	//5-10
										}else if (rows[0].rarity == "L"){
											rand = Math.random()*5+10;	//10-15
										}else if (rows[0].rarity == "E"){
											rand = Math.random()*5+20;	//20-25
										}else{
											bot.sendMessage(message.chat.id, "Non possiedi la Runa selezionata!", back);
											return;
										}

										rand = Math.round(rand);
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + rows[0].id + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;

											setAchievement(message.chat.id, player_id, 23, 1);

											var d = new Date();
											d.setHours(d.getHours()+48);
											var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
											var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();

											var extra = "";
											extra = ", inoltre ora puÃ² lanciare incantesimi!";
											extra += "\nL'effetto terminerÃ  alle " + short_date;

											if (type == "Arma"){
												connection.query('UPDATE player SET weapon_enchant_bonus = 1 WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
												connection.query('UPDATE player SET weapon_enchant_end = "' + long_date + '", weapon_enchant = weapon_enchant + ' + rand + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Il valore incantamento arma Ã¨ aumentato di *" + rand + "*" + extra, back);
												});
											}else if (type == "Armatura"){
												connection.query('UPDATE player SET weapon2_enchant_bonus = 1 WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
												connection.query('UPDATE player SET weapon2_enchant_end = "' + long_date + '", weapon2_enchant = weapon2_enchant + ' + rand + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Il valore incantamento armatura Ã¨ aumentato di *" + rand + "*" + extra, back);
												});
											}else if (type == "Scudo"){
												connection.query('UPDATE player SET weapon3_enchant_bonus = 1 WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
												connection.query('UPDATE player SET weapon3_enchant_end = "' + long_date + '", weapon3_enchant = weapon3_enchant + ' + rand + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Il valore incantamento scudo Ã¨ aumentato di *" + rand + "*" + extra, back);
												});
											}
										});
									});
								};
							});

						}else if (answer.text == "Gemma"){
							if (gems < 1){
								bot.sendMessage(message.chat.id, "Non possiedi gemme", kb);
								return;
							}else{
								connection.query('UPDATE player SET gems = gems-1 WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
							}
							var rand = 0;
							rand = Math.random()*5+25;	//5-30

							rand = Math.round(rand);

							setAchievement(message.chat.id, player_id, 23, 1);

							var d = new Date();
							d.setHours(d.getHours()+48);
							var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
							var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

							var extra = "";
							extra = ", inoltre ora puÃ² lanciare incantesimi!";
							extra += "\nL'effetto terminerÃ  alle " + short_date;

							if (type == "Arma"){
								connection.query('UPDATE player SET weapon_enchant_bonus = 1 WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE player SET weapon_enchant_end = "' + long_date + '", weapon_enchant = weapon_enchant + ' + rand + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il valore incantamento arma Ã¨ aumentato di *" + rand + "*" + extra, back);
								});
							}else if (type == "Armatura"){
								connection.query('UPDATE player SET weapon2_enchant_bonus = 1 WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE player SET weapon2_enchant_end = "' + long_date + '", weapon2_enchant = weapon2_enchant + ' + rand + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il valore incantamento armatura Ã¨ aumentato di *" + rand + "*" + extra, back);
								});
							}else if (type == "Scudo"){
								connection.query('UPDATE player SET weapon3_enchant_bonus = 1 WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE player SET weapon3_enchant_end = "' + long_date + '", weapon3_enchant = weapon3_enchant + ' + rand + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il valore incantamento scudo Ã¨ aumentato di *" + rand + "*" + extra, back);
								});
							}
						}
					}
				});
			});
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Incanta Arma","Incanta Armatura","Incanta Scudo"],["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, "Per incantare un oggetto dell'equipaggiamento ti serve una Runa oppure una Gemma, aumenterai il valore dell'oggetto e la probabilitÃ  di lanciare incantesimi.", kb);
	});
});

bot.onText(/fai nascere il drago|accudisci drago|nutri ancora|^Drago/i, function(message) {
	connection.query('SELECT holiday, id, exp, charm_id, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var exp = rows[0].exp;

		helpMsg(message.chat.id, player_id, 5);

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length <= 0){
				// Non possiede ancora il drago

				if (exp < 100){
					bot.sendMessage(message.chat.id, "Devi aver raggiunto 100 exp per far nascere il drago.", back);
					return;
				}

				var dragon = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Dai un nome al drago!"],["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Vuoi far nascere il drago?\nIl drago Ã¨ utile in varie situazioni:\n- Ti aiuta nelle lotte contro i boss\n- Riduce i tempi dei viaggi\n- Incrementa la protezione del tuo rifugio\n- Consente di produrre bevande per le missioni o i viaggi\n\nTi serviranno le seguenti pietre:\n> Pietra Anima di Legno\n> Pietra Anima di Ferro\n> Pietra Anima Preziosa\n> Pietra Cuore di Diamante\n> Pietra Cuore Leggendario\n> Pietra Spirito Epico\nSi possono trovare nelle cave dei viaggi (dal livello 10).", dragon);
			}else{
				var dragon_lev = rows[0].level;
				var dragon_exp = rows[0].exp;
				var dragon_evolved = rows[0].evolved;
				var dragon_claws = rows[0].claws;
				var dragon_saddle = rows[0].saddle;
				var dragon_saddle_id = rows[0].saddle_id;
				var dragon_claws_id = rows[0].claws_id;
				var dragon_type = rows[0].type;

				var dragon_claws_name = "";
				var dragon_saddle_name = "";

				connection.query('SELECT name FROM item WHERE id = ' + dragon_claws_id, function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						dragon_claws_name = rows[0].name;
					}
					connection.query('SELECT name FROM item WHERE id = ' + dragon_saddle_id, function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0){
							dragon_saddle_name = rows[0].name;
						}

						connection.query('SELECT item.name, COUNT(item.name) As Num FROM item, inventory, player WHERE player.id = ' + player_id  + ' AND item.id = inventory.item_id AND player.id = inventory.player_id AND item.name LIKE "Pietra%" AND item.rarity = "S" GROUP BY item.name ORDER BY item.id', function(err, rows, fields) {
							if (err) throw err;
							var iKeys = [];
							var noStone = "";
							if (Object.keys(rows).length > 0){
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									iKeys.push(["Dai " + rows[i].name + " (" + rows[i].Num + ")"]);
								}
								iKeys.push(["Dai tutte"]);
							}else{
								noStone = "\nNon hai pietre per far crescere il drago";
							}

							iKeys.push(["Potenzia Drago","Stacca Potenziamento"]);
							if ((dragon_lev == 100) && (dragon_evolved == 0)){
								iKeys.push(["Scaglia Evolutiva"]);
							}
							iKeys.push(["Rinomina Drago","Bevande","Cambia Tipo"]);
							iKeys.push(["Torna al menu"]);

							var kb = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									one_time_keyboard: true,
									"keyboard": iKeys
								}
							};

							var claws_text = "";
							if (dragon_claws > 0){
								claws_text = "\n" + dragon_claws_name + " +" + dragon_claws;
							}
							var saddle_text = "";
							if (dragon_saddle > 0){
								saddle_text = "\n" + dragon_saddle_name + " +" + dragon_saddle;
							}

							var necess = 70;
							var lev = ((dragon_exp)/necess).toFixed(2);

							if (dragon_evolved == 0){
								if ((lev == "100") || (lev == "100.00")){
									lev = "100.00";
								}
							}else{
								if ((lev == "200") || (lev == "200.00")){
									lev = "200.00";
								}
							}
							var dPerc = (lev+"").split(".")[1];
							lev = parseFloat(lev)+1;
							var dLev = (lev+"").split(".")[0];

							var bonustext = "";

							if ((dragon_saddle_id == 213) && (dragon_claws_id == 207)){
								bonustext = "\nSet Infernale equipaggiato!";
							}else if ((dragon_saddle_id == 214) && (dragon_claws_id == 208)){
								bonustext = "\nSet Glaciale equipaggiato!";
							}else if ((dragon_saddle_id == 215) && (dragon_claws_id == 209)){
								bonustext = "\nSet Oscuro equipaggiato!";
							}else if ((dragon_saddle_id == 216) && (dragon_claws_id == 210)){
								bonustext = "\nSet Celeste equipaggiato!";
							}else if ((dragon_saddle_id == 217) && (dragon_claws_id == 211)){
								bonustext = "\nSet Abissale equipaggiato!";
							}else if ((dragon_saddle_id == 218) && (dragon_claws_id == 212)){
								bonustext = "\nSet delle Vette equipaggiato!";
							}

							bot.sendMessage(message.chat.id, "Cosa vuoi fare con il tuo drago? Si trova al " + dPerc + "% del livello " + dragon_lev + claws_text + saddle_text + bonustext + noStone, kb).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Scaglia Evolutiva"){

										if (dragon_evolved == 1){
											bot.sendMessage(message.chat.id, "Il tuo drago Ã¨ giÃ  stato evoluto", back);
											return;
										}

										bot.sendMessage(message.chat.id, "La Scaglia Evolutiva consente di aumentare il livello massimo del tuo drago, vuoi utilizzarla?", yesno).then(function() {
											answerCallbacks[message.chat.id] = function(answer) {
												if (answer.text.toLowerCase() == "si"){
													connection.query('SELECT item_id FROM inventory WHERE item_id = 649 AND player_id=' + player_id, function(err, rows, fields) {
														if (err) throw err;
														if (Object.keys(rows).length < 1){
															bot.sendMessage(message.chat.id, "Non possiedi la Scaglia Evolutiva", back);
															return;
														}
														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 649 LIMIT 1', function(err, rows, fields) {
															if (err) throw err;
															connection.query('UPDATE dragon SET evolved = 1 WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Il tuo drago si Ã¨ evoluto e puÃ² superare il suo livello massimo!", back);
															});
														});
													});
												}
											};
										});
									}
								};
							});
						});
					});
				});
			}
		});
	});
});

bot.onText(/Dai un nome al drago/i, function(message) {
	connection.query('SELECT id, holiday, exp, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var exp = rows[0].exp;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length <= 0){

				if (exp < 100){
					bot.sendMessage(message.chat.id, "Devi aver raggiunto 100 exp per far nascere il drago.", back);
					return;
				}

				connection.query('SELECT * FROM inventory WHERE player_id = ' + player_id + ' AND item_id IN (68, 69, 70, 71, 72, 73) GROUP BY item_id', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length >= 6){
						var d = new Date();
						var rand = Math.round(d.getHours()/4);
						var type = "";
						if (rand == 1){
							type = "delle Montagne";
						}else if (rand == 2){
							type = "dei Cieli";
						}else if (rand == 3){
							type = "Infernale";
						}else if (rand == 4){
							type = "dell'OscuritÃ ";
						}else if (rand == 5){
							type = "dei Mari";
						}else{
							type = "dei Ghiacci";
						}

						bot.sendMessage(message.chat.id, "Il drago " + type + " Ã¨ nato!\nCome vorresti chiamarlo?", back).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								var name = answer.text.trim();

								if (name == "Torna al menu"){
									return;
								}

								if ((name == "Si") || (name == "") || (name.indexOf("_") != -1)){
									bot.sendMessage(message.chat.id, "Il nome inserito non Ã¨ valido, riprova.", back);
									return;
								}

								if (re2.test(name) == false){
									bot.sendMessage(message.chat.id, "I simboli non sono consentiti.", back);
									return;	
								}

								for (var i = 1, len = 7; i < len; i++) {
									connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + (67+i) + ' LIMIT 1', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								connection.query('INSERT INTO `dragon`(`id`, `player_id`, `name`, `exp`, `level`, `damage`, `defense`, `type`) VALUES (DEFAULT,' + player_id + ',"' + name + '",0,1,1,1,"' + type + '")', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Complimenti, Ã¨ nato *" + name + "*, puoi nutrirlo per farlo crescere e trarne vantaggi!", back);
								});
							};
						});
					}else{
						bot.sendMessage(message.chat.id, "Non hai abbastanza pietre per far nascere il drago!",back);
					}
				});
			}else{
				bot.sendMessage(message.chat.id, "Possiedi giÃ  il drago!", back);
				return;
			}
		});
	});
});

bot.onText(/^bevande/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;

			if (rows[0].boost_time != null){
				var boost_time = new Date(rows[0].boost_time);
				var now = new Date();

				if (boost_time < now){
					var boost_id = rows[0].boost_id;
					if (boost_id == 0){
						boost_id = Math.round(Math.random()*6+1);
						connection.query('UPDATE dragon SET boost_id = ' + boost_id + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});
					}
					var itemId = 0;
					var m = 3;
					if (boost_id == 1){
						itemId = 48;
					}else if (boost_id == 2){
						itemId = 601;
					}else if (boost_id == 3){
						itemId = 613;
					}else if (boost_id == 4){
						itemId = 617;
						m = 2;
					}else if (boost_id == 5){
						itemId = 642;
					}else if (boost_id == 6){
						itemId = 265;
					}else if (boost_id == 7){
						itemId = 650;
					}else{
						bot.sendMessage(message.chat.id, "Bevanda non valida", back);
						return;
					}

					var kb2 = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Attiva","Scarta"],["Torna al menu"]]
						}
					};

					connection.query('SELECT name FROM item WHERE id = ' + itemId, function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "La *" + rows[0].name + "* Ã¨ pronta, cosa vuoi fare? Attivandola andrÃ  a rimpiazzare la bevanda eventualmente attiva", kb2).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Attiva"){
									connection.query('UPDATE player SET boost_id = ' + boost_id + ', boost_mission = ' + m + ' WHERE id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										connection.query('UPDATE dragon SET boost_id = 0, boost_time = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Bevanda attivata!", back);
										});
									});
								}else if (answer.text == "Scarta"){
									connection.query('UPDATE dragon SET boost_id = 0, boost_time = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Bevanda scartata!", back);
									});
								}
							};
						});
					});
				}else{
					var short_date = addZero(boost_time.getHours()) + ':' + addZero(boost_time.getMinutes()) + ':' + addZero(boost_time.getSeconds());
					bot.sendMessage(message.chat.id, "La bevanda Ã¨ ancora in produzione, attendi fino alle " + short_date, back);
				}
				return;
			}

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Inizia Produzione"],["Torna al menu"]]
				}
			};

			bot.sendMessage(message.chat.id, "Puoi far produrre una bevanda casuale al drago, ci impiegherÃ  24 ore e ti costerÃ  una Pietra Spirito Epico", kb).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "Inizia Produzione"){

						connection.query('SELECT id FROM inventory WHERE item_id = 73 AND player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Non hai nessuna Pietra Spirito Epico da consumare!", back);
								return;
							}

							var d = new Date();
							d.setHours(d.getHours()+24);
							var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
							var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

							connection.query('UPDATE dragon SET boost_time = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Produzione iniziata, dovrai attendere fino alle " + short_date + " di domani, poi torna a recuperare la bevanda", back);
							});
							connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 73 LIMIT 1', function(err, rows, fields) {
								if (err) throw err;
							});
							setAchievement(message.chat.id, player_id, 38, 1);
						});
					}
				};
			});
		});
	});
});

bot.onText(/stacca /i, function(message) {
	var action = message.text.substring(message.text.indexOf(" ")+1);

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;				
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			var necess = 70;
			var lev = ((dragon_exp)/necess).toFixed(2);
			if ((lev == "100") || (lev == "100.00")){
				lev = "100.00";
			}
			var dPerc = (lev+"").split(".")[1];
			lev = parseFloat(lev)+1;
			var dLev = (lev+"").split(".")[0];

			if ((action == "Sella") || (action == "Artigli")){

				bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						var resp = answer.text;
						if (resp.toLowerCase() != "si"){
							return;
						}

						if (action == "Sella"){
							if (dragon_saddle_id != 0){
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + dragon_saddle_id + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Hai rimosso l'equipaggiamento sella dal drago.", back);
								});

								connection.query('UPDATE dragon SET damage = ' + dLev + ', defense = ' + Math.floor(dLev/2) + ', saddle_id = 0, saddle = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
							}else{
								bot.sendMessage(message.chat.id, "La sella non Ã¨ equipaggiata.", back);
							}
						}
						if (action == "Artigli"){
							if (dragon_claws_id != 0){
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + dragon_claws_id + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Hai rimosso l'equipaggiamento artigli dal drago.", back);
								});

								connection.query('UPDATE dragon SET damage = ' + dLev + ', defense = ' + Math.floor(dLev/2) + ', claws_id = 0, claws = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
							}else{
								bot.sendMessage(message.chat.id, "Gli artigli non sono equipaggiati.", back);
							}
						}
					};
				});
				return;
			}

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Stacca Artigli"],["Stacca Sella"],["Torna al menu"]]
				}
			};

			bot.sendMessage(message.chat.id, "Quale oggetto vuoi staccare dal drago?", kb);
		});
	});
});

bot.onText(/cambia tipo/i, function(message) {
	var tipo = message.text.substring(message.text.indexOf(":")+2);

	//console.log(tipo);

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;				
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			if ((dragon_saddle_id != 0) || (dragon_claws_id != 0)){
				bot.sendMessage(message.chat.id, "Prima di cambiare tipo al drago devi rimuovere tutti i suoi equipaggiamenti.", back);
				return;
			}

			var kbD = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["dei Mari"],["dei Ghiacci"],["Infernale"],["dei Cieli"],["delle Montagne"],["dell'OscuritÃ "],["Torna al menu"]]
				}
			};

			bot.sendMessage(message.chat.id, "Inserisci il nuovo tipo del drago, verrÃ  consumato un Mutaforma e *il suo livello verrÃ  azzerato*.", kbD).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var newtype = answer.text;

					connection.query('SELECT * FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 219', function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length == 0){
							bot.sendMessage(message.chat.id, "Ti serve il Mutaforma per cambiare tipo al drago.", back);
							return;
						}

						if ((newtype == "") || (newtype == "Torna al menu") || (newtype == "Cambia Tipo")){
							bot.sendMessage(message.chat.id, "Tipo non valido!", back);
							return;
						}
						if ((newtype != "dei Mari") && (newtype != "dei Ghiacci") && (newtype != "Infernale") && (newtype != "dei Cieli") && (newtype != "delle Montagne") && (newtype != "dell'OscuritÃ ")){
							bot.sendMessage(message.chat.id, "Tipo non valido!", back);
							return;
						}

						connection.query('UPDATE dragon SET exp = 0, level = 0, type = "' + newtype + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							connection.query('DELETE FROM inventory WHERE item_id = 219 AND player_id = ' + player_id + ' LIMIT 1', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai cambiato tipo al drago!", back);
							});
						});
					});
				};
			});
		});
	});
});

bot.onText(/rinomina drago/i, function(message) {
	var name = message.text.substring(message.text.indexOf(":")+1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;				
			}
			bot.sendMessage(message.chat.id, "Inserisci il nuovo nome del drago, verrÃ  consumato un Rinominatore.", back).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var newname = answer.text;

					connection.query('SELECT * FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 199', function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length == 0){
							bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per rinominare il drago.", back);
							return;
						}

						if ((newname == "") || (newname == "Torna al menu") || (newname == "Rinomina")){
							bot.sendMessage(message.chat.id, "Nome non valido!", back);
							return;
						}

						if (re2.test(newname) == false){
							bot.sendMessage(message.chat.id, "I simboli non sono consentiti.", back);
							return;	
						}

						connection.query('UPDATE dragon SET name = "' + newname.trim() + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});
						connection.query('DELETE FROM inventory WHERE item_id = 199 AND player_id = ' + player_id + ' LIMIT 1', function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Hai rinominato il drago!", back);
						});		
					});
				};
			});
		});
	});
});

bot.onText(/cambia nome/i, function(message) {
	var name = message.text.substring(message.text.indexOf(":")+1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;
		var player_id = rows[0].id;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = player_id;

				if (rows[0].role == 1){
					isAdmin = 1;
				}

				if (isAdmin == 0){
					bot.sendMessage(message.chat.id, "Devi essere amministratore per rinominare il team.", back);
					return;
				}

				connection.query('SELECT * FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 199', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per rinominare il team.", back);
						return;
					}

					bot.sendMessage(message.chat.id, "Inserisci il nuovo nome del team, verrÃ  consumato un Rinominatore.", back).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var newname = answer.text;

							connection.query('SELECT * FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 199', function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per rinominare il team.", back);
									return;
								}

								if ((newname == "") || (newname == "Torna al menu") || (newname == "Rinomina")){
									bot.sendMessage(message.chat.id, "Nome non valido!", back);
									return;
								}

								if (re2.test(newname) == false){
									bot.sendMessage(message.chat.id, "I simboli non sono consentiti.", back);
									return;	
								}
								connection.query('UPDATE team SET name = "' + newname.trim() + '" WHERE id = ' + team_id, function(err, rows, fields) {
									if (err) throw err;
								});
								connection.query('DELETE FROM inventory WHERE item_id = 199 AND player_id = ' + player_id + ' LIMIT 1', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Hai rinominato il team!", back);
								});		
							});		
						};
					});
				});
			});
		});
	});
});


bot.onText(/dai pietra/i, function(message) {
	var foodmore = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Nutri Ancora"],["Torna al menu"]]
		}
	};

	/*
	if (message.from.username != "fenix45"){
		bot.sendMessage(message.chat.id, "Manutenzione", back);
		return;
	}
	*/

	var pietra = message.text.substring(message.text.indexOf(" ")+1);
	var necess = 70;
	//console.log(pietra);

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var charm_id = rows[0].charm_id;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;				
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_evolved = rows[0].evolved;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			if (dragon_evolved == 0){
				if (dragon_lev >= 100){
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			}else{
				if (dragon_lev >= 200){
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			}

			var pos = pietra.indexOf("(");
			if (pos != -1){
				pietra = pietra.substr(0, pos-1);
			}

			connection.query('SELECT COUNT(item.id) As cnt, item.id FROM item, inventory, player WHERE player.id = ' + player_id + ' AND item.id = inventory.item_id AND player.id = inventory.player_id AND item.name = "' + pietra + '" AND item.rarity = "S" GROUP BY item.name', function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Non possiedi questa pietra.", back);
					return;
				}

				var cnt = rows[0].cnt;
				var stoneId = rows[0].id;

				cnt = cnt.toString();

				if (cnt > 1){
					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["1"],[cnt],["Torna al menu"]]
						}
					};
				}else{
					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["1"],["Torna al menu"]]
						}
					};
				}

				bot.sendMessage(message.chat.id, "Quante pietre vuoi utilizzare?", kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text != "Torna al menu"){

							var qnt = answer.text;

							if ((qnt < 1) || (re.test(qnt) == false)){
								bot.sendMessage(message.chat.id, "QuantitÃ  non valida", foodmore);
								return;
							}

							connection.query('SELECT id FROM inventory WHERE item_id = "' + stoneId + '" AND player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;

								qnt = parseInt(qnt);

								if (Object.keys(rows).length < qnt){
									bot.sendMessage(message.chat.id, "Non possiedi abbastanza pietre.", foodmore);
									return;
								}

								var val = stoneId-67;

								val = val*qnt;

								var lev = ((dragon_exp+val)/necess).toFixed(2);
								if (dragon_evolved == 0){
									if ((lev == "100") || (lev == "100.00")){
										lev = "100.00";
									}
								}else{
									if ((lev == "200") || (lev == "200.00")){
										lev = "200.00";
									}
								}
								var perc = (lev+"").split(".")[1];
								lev = parseFloat(lev)+1;

								var lev_int = parseInt((lev+"").split(".")[0]);

								if (dragon_evolved == 0){
									if (lev_int > 100){
										bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 100", foodmore);
										return;
									}
								}else{
									if (lev_int > 200){
										bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 200", foodmore);
										return;
									}
								}

								var damage = 0;
								var defense = 0;
								var critical = 0;
								if ((dragon_saddle_id == 213) && (dragon_claws_id == 207)){
									damage = 25;
								}else if ((dragon_saddle_id == 214) && (dragon_claws_id == 208)){
									defense = 25;
								}else if ((dragon_saddle_id == 215) && (dragon_claws_id == 209)){
									damage = 15;
									defense = 10;
									critical = 5;
								}else if ((dragon_saddle_id == 216) && (dragon_claws_id == 210)){
									defense = 15;
									damage = 10;
									critical = 5;
								}else if ((dragon_saddle_id == 217) && (dragon_claws_id == 211)){
									damage = 10;
									defense = 5;
									critical = 10;
								}else if ((dragon_saddle_id == 218) && (dragon_claws_id == 212)){
									damage = 5;
									defense = 10;
									critical = 10;
								}

								connection.query('UPDATE dragon SET exp=exp+' + val + ', level = ' + lev_int + ', critical = ' + critical +' ,damage = ' + (lev_int+damage) + ', defense = ' + (Math.floor(lev_int/2)+defense) + ' WHERE player_id=' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il drago si trova al " + perc + "% del livello " + (lev+"").split(".")[0] + ".", foodmore);
								});

								connection.query('DELETE FROM inventory WHERE player_id=' + player_id + ' AND item_id = ' + stoneId + ' LIMIT ' + qnt, function(err, rows, fields) {
									if (err) throw err;
								});

								setAchievement(message.chat.id, player_id, 4, val);
							});
						};
					};
				});
			});
		});
	});
});

bot.onText(/dai tutte/i, function(message) {

	var foodmore = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Nutri Ancora"],["Torna al menu"]]
		}
	};

	var necess = 70;

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var charm_id = rows[0].charm_id;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;				
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_evolved = rows[0].evolved;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			if (dragon_evolved == 0){
				if (dragon_lev >= 100){
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			}else{
				if (dragon_lev >= 200){
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			}

			bot.sendMessage(message.chat.id, "Sei sicuro?", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text.toLowerCase() == "si"){

						connection.query('SELECT item.name, item.id FROM item, inventory, player WHERE player.id = ' + player_id  + ' AND item.id = inventory.item_id AND player.id = inventory.player_id AND item.name LIKE "Pietra%" AND item.rarity = "S"', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length > 0){
								var val = 0;

								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									val += rows[i].id-67;
								}

								var lev = ((dragon_exp+val)/necess).toFixed(2);
								if (dragon_evolved == 0){
									if ((lev == "100") || (lev == "100.00")){
										lev = "100.00";
									}
								}else{
									if ((lev == "200") || (lev == "200.00")){
										lev = "200.00";
									}
								}
								var perc = (lev+"").split(".")[1];
								lev = parseFloat(lev)+1;

								var lev_int = parseInt((lev+"").split(".")[0]);

								if (dragon_evolved == 0){
									if (lev_int > 100){
										bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 100", foodmore);
										return;
									}
								}else{
									if (lev_int > 200){
										bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 200", foodmore);
										return;
									}
								}

								var damage = 0;
								var defense = 0;
								var critical = 0;
								if ((dragon_saddle_id == 213) && (dragon_claws_id == 207)){
									damage = 25;
								}else if ((dragon_saddle_id == 214) && (dragon_claws_id == 208)){
									defense = 25;
								}else if ((dragon_saddle_id == 215) && (dragon_claws_id == 209)){
									damage = 15;
									defense = 10;
									critical = 5;
								}else if ((dragon_saddle_id == 216) && (dragon_claws_id == 210)){
									defense = 15;
									damage = 10;
									critical = 5;
								}else if ((dragon_saddle_id == 217) && (dragon_claws_id == 211)){
									damage = 10;
									defense = 5;
									critical = 10;
								}else if ((dragon_saddle_id == 218) && (dragon_claws_id == 212)){
									damage = 5;
									defense = 10;
									critical = 10;
								}

								connection.query('UPDATE dragon SET exp=exp+' + val + ', level = ' + lev_int + ', critical = ' + critical + ', damage = ' + (lev_int+damage) + ', defense = ' + (Math.floor(lev_int/2)+defense) + ' WHERE player_id=' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il drago si trova al " + perc + "% del livello " + (lev+"").split(".")[0] + ".", foodmore);
								});

								connection.query('DELETE inventory.* FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id=' + player_id + ' AND item.rarity = "S" AND item.name LIKE "Pietra%"', function(err, rows, fields) {
									if (err) throw err;
								});

								setAchievement(message.chat.id, player_id, 4, val);
							}else{
								bot.sendMessage(message.chat.id, "Non hai nessuna pietra nello zaino.", back);
								return;
							}
						});
					};
				};
			});
		});
	});
});

bot.onText(/potenzia con/i, function(message) {
	var equip = message.text.substring(message.text.indexOf("con")+4);
	if ((equip == "") || (equip == " ")){
		return;
	}

	//console.log(equip);

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;				
			}

			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			var pos = equip.indexOf("(");
			if (pos != -1){
				equip = equip.substr(0, pos-1);
			}
			connection.query('SELECT item.dragon_power, item.id FROM item, inventory, player WHERE player.id = ' + player_id  + ' AND item.id = inventory.item_id AND player.id = inventory.player_id AND item.name = "' + equip + '"', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato.", back);
					return;
				}

				bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						var resp = answer.text;
						if (resp.toLowerCase() != "si"){
							return;
						}


						var itemid = rows[0].id;
						var dragon_power = rows[0].dragon_power;

						var type = [];
						var this_type = "";
						type.push("Infernal");
						type.push("Oscur");
						type.push("Glacial");
						type.push("Celest");
						type.push("Abissal");
						type.push("delle Vett");

						if (dragon_type == "Infernale"){
							this_type = "Infernal";
						}else if (dragon_type == "dei Ghiacci"){
							this_type = "Glacial";
						}else if (dragon_type == "dell'OscuritÃ "){
							this_type = "Oscur";
						}else if (dragon_type == "dei Cieli"){
							this_type = "Celest";
						}else if (dragon_type == "dei Mari"){
							this_type = "Abissal";
						}else if (dragon_type == "delle Montagne"){
							this_type = "delle Vett";
						}else{
							console.log("Errore tipo drago");
						}

						var typeString = equip.substring(equip.indexOf(" ")+1);
						typeString = typeString.slice(0,-1);
						var isSet = 0;
						var setText = "";

						//console.log(typeString, type.indexOf(typeString));

						if (type.indexOf(typeString) != -1){
							if (typeString == this_type){
								isSet = 1;
								setText = "\nQuesto oggetto fa parte di un set, equipaggia anche l'altro per ottenere ulteriori benefici";
							}else{
								bot.sendMessage(message.chat.id, "Questo oggetto puÃ² solo essere equipaggiato al tipo del drago corrispondente", back);
								return;
							}
						}

						connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemid, function(err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato.", back);
								return;
							}

							if (dragon_power > 0){
								connection.query('SELECT claws_id, saddle_id FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									if (rows[0].claws_id != 0){
										bot.sendMessage(message.chat.id, "Stacca prima l'equipaggiamento attuale.", back);
										return;
									}

									var damage = 0;
									var defense = 0;
									var critical = 0;
									if (isSet == 1){
										if (dragon_saddle_id == 213){
											damage = 25;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno!", back);
										}else if (dragon_saddle_id == 214){
											defense = 25;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + defense + " difesa!", back);
										}else if (dragon_saddle_id == 215){
											damage = 15;
											defense = 10;
											critical = 5;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defense + " difesa e " + critical + "% critico!", back);
										}else if (dragon_saddle_id == 216){
											defense = 15;
											damage = 10;
											critical = 5;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defense + " difesa e " + critical + "% critico!", back);
										}else if (dragon_saddle_id == 217){
											damage = 10;
											defense = 5;
											critical = 10;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno, +" + defense + " difesa e " + critical + "% critico!", back);
										}else if (dragon_saddle_id == 218){
											damage = 5;
											defense = 10;
											critical = 10;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defense + " difesa e " + critical + "% critico!", back);
										}
									}

									connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemid + ' LIMIT 1', function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Artigli equipaggiati!" + setText, back);
									});

									connection.query('UPDATE dragon SET claws_id = ' + itemid + ', critical = ' + critical + ', defense = defense + ' + defense + ', damage = damage + ' + damage + ', claws = ' + dragon_power + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});
								});
							}else if (dragon_power < 0){
								connection.query('SELECT claws_id, saddle_id FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									if (rows[0].saddle_id != 0){
										bot.sendMessage(message.chat.id, "Stacca prima l'equipaggiamento attuale.", back);
										return;
									}
									var damage = 0;
									var defense = 0;
									var critical = 0;

									if (isSet == 1){
										if (dragon_claws_id == 207){
											damage = 25;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno!", back);
										}else if (dragon_claws_id == 208){
											defense = 25;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + defense + " difesa!", back);
										}else if (dragon_claws_id == 209){
											damage = 15;
											defense = 10;
											critical = 5;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defense + " difesa e " + critical + "% critico!", back);
										}else if (dragon_claws_id == 210){
											defense = 15;
											damage = 10;
											critical = 5;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defense + " difesa e " + critical + "% critico!", back);
										}else if (dragon_claws_id == 211){
											damage = 10;
											defense = 5;
											critical = 10;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno, +" + defense + " difesa e " + critical + "% critico!", back);
										}else if (dragon_claws_id == 212){
											damage = 5;
											defense = 10;
											critical = 10;
											bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defense + " difesa e " + critical + "% critico!", back);
										}
									}

									connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemid + ' LIMIT 1', function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Sella equipaggiata!" + setText, back);
									});

									connection.query('UPDATE dragon SET damage = damage + ' + damage + ', critical = ' + critical + ', defense = defense + ' + defense + ', saddle_id = ' + itemid + ', saddle = ' + Math.abs(dragon_power) + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});
								});
							}
						});
					};
				});
			});
		});
	});
});

bot.onText(/potenzia drago/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {	
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;				
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			connection.query('SELECT item.name, item.dragon_power FROM item, inventory WHERE inventory.player_id = ' + player_id  + ' AND item.id = inventory.item_id AND item.dragon_power <> 0', function(err, rows, fields) {
				if (err) throw err;
				var Keys = [];

				if (Object.keys(rows).length > 0){
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].dragon_power > 0){
							Keys.push(["Potenzia con " + rows[i].name + " (+" + rows[i].dragon_power + " attacco)"]);
						}else{
							Keys.push(["Potenzia con " + rows[i].name + " (+" + Math.abs(rows[i].dragon_power) + " difesa)"]);
						}
					}
				}else{
					bot.sendMessage(message.chat.id, "Non hai equipaggiabili per il drago.", back);
					return;
				}

				Keys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": Keys
					}
				};

				bot.sendMessage(message.chat.id, "Quale oggetto vuoi equipaggiare al drago? Una volta equipaggiato l'oggetto scomparirÃ  dall'inventario.", kb);
			});
		});
	});
});

bot.onText(/team/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		helpMsg(message.chat.id, player_id, 4);

		var new_price = 5000;
		var price_drop = 0;
		var price_drop_msg = "";
		var n = new Date().getDay()
		var n2 = new Date().getDate();

		if (rows[0].team_time != null){
			var d2 = new Date(rows[0].team_time);
			var short_date = addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + short_date + " di tre giorni successivi all'uscita.", back);
			return;
		}

		if (n == 0){
			price_drop = 1;
			new_price = 3500;
			price_drop_msg = "*SOLO OGGI* ";
		}

		connection.query('SELECT team.id As team_id, name FROM team, team_player WHERE team.id = team_player.team_id AND player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [['Fonda nuovo'],['Entra in uno esistente'],['Liste Membri','Hall of Fame'],['Torna al menu']]
					}
				};

				bot.sendMessage(message.chat.id, "I Team sono dei gruppi di battaglia utili negli scontri contro i boss, puoi crearlo (" + price_drop_msg + "ti costerÃ  " + new_price + " Â§) oppure entrare in uno giÃ  esistente", kb);
			}else{
				var team_id = rows[0].team_id;
				connection.query('SELECT T2.name, T2.players FROM team T1 JOIN team T2 ON T1.child_team = T2.id WHERE T1.id = ' + team_id, function (err, rows, fields){
					if (err) throw err;

					var childName = "";
					var childPlayers = 0;
					if (Object.keys(rows).length > 0){
						childName = rows[0].name;
						childPlayers = rows[0].players;
					}

					connection.query('SELECT T2.name, T2.players FROM team T1 JOIN team T2 ON T1.id = T2.id WHERE T1.child_team = ' + team_id, function (err, rows, fields){
						if (err) throw err;

						var motherName = "";
						var motherPlayers = 0;
						if (Object.keys(rows).length > 0){
							motherName = rows[0].name;
							motherPlayers = rows[0].players;
						}

						connection.query('SELECT team_player.role, team_player.player_id, player.nickname FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
							if (err) throw err;

							var isAdmin = 0;
							var adminId = 0;

							if (rows[0].role == 1){
								isAdmin = 1;
							}

							connection.query('SELECT player.id, player.nickname FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + team_id + ' AND role = 1', function (err, rows, fields){
								if (err) throw err;

								if (Object.keys(rows).length == 0){
									connection.query('UPDATE team_player SET role = 1 WHERE team_id = ' + team_id + ' AND player_id = ' + player_id,  function (err, rows, fields){
										if (err) throw err;
									});
									adminName = message.from.username.replace(new RegExp("_", "g"), " ");
									adminId = player_id;
								}else{
									adminName = rows[0].nickname.replace(new RegExp("_", "g"), " ");
									adminId = rows[0].id;
								}

								connection.query('SELECT boss_id FROM team_player, player WHERE player.id = player_id AND team_id = ' + team_id + ' AND role = 1', function(err, rows, fields) {
									if (err) throw err;

									var admin_boss_id = rows[0].boss_id;

									connection.query('SELECT team_player.player_id, boss_damage.boss_id, SUM(damage) As dmg, COUNT(damage) As dmg_cnt FROM boss_damage RIGHT JOIN team_player ON team_player.player_id = boss_damage.player_id WHERE team_player.team_id = ' + team_id + ' AND (boss_damage.boss_id = ' + admin_boss_id + ' OR boss_damage.boss_id IS NULL) GROUP BY team_player.player_id ORDER BY team_player.role DESC, team_player.id', function(err, rows, fields) {
										if (err) throw err;

										var list_dmg = [];
										var list_dmg_cnt = [];

										if (Object.keys(rows).length > 0){
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												list_dmg[rows[i].player_id] = rows[i].dmg;
												list_dmg_cnt[rows[i].player_id] = rows[i].dmg_cnt;
											}
										}
										//console.log(Object.keys(rows).length);
										//console.log(list_dmg);
										//console.log(list_dmg_cnt);

										connection.query('SELECT team.kill_num1, team.kill_num2, class.name As class_name, team_player.*, last_command.time, team.craft_count As team_craft, (SELECT COUNT(*) FROM team_player WHERE team_id = ' + team_id + ') As cnt, player.id As player_id, player.rank, player.weapon, player.mission_time_end, player.travel_time_end, player.cave_time_end, player.holiday, player.ability, player.reborn, player.nickname, player.craft_count, player.life, player.total_life, player.exp, team.name, team.players, team.details, team.max_players, team.boss_count, team.level, team.closed, SUM(boss_damage.damage) As dmg, COUNT(boss_damage.damage) As dmg_cnt ' +
														 'FROM last_command, `team_player` LEFT JOIN boss_damage ON boss_damage.player_id = team_player.player_id, player, team, class ' +
														 'WHERE player.class = class.id AND team.id = team_player.team_id AND team_player.player_id = player.id AND team_player.team_id = ' + team_id + ' AND player.account_id = last_command.account_id GROUP BY nickname ORDER BY team_player.role DESC, team_player.id', function(err, rows, fields) {
											if (err) throw err;
											var iKeys = [];
											var teamName = rows[0].name;
											var closed = rows[0].closed;
											var details = rows[0].details;
											var team_craft = rows[0].team_craft;

											var num_members = rows[0].cnt;
											connection.query('UPDATE team SET players = ' + num_members + ' WHERE id = ' + team_id, function(err, rows, fields) {
												if (err) throw err;
											});

											if (rows[0].max_players == 19){
												connection.query('UPDATE team SET max_players = 20 WHERE id = ' + team_id, function(err, rows, fields) {
													if (err) throw err;
												});
											}

											var user_text = "\n\n<b>Membri:</b>\n";
											var user_text2 = "";

											var stars = "";
											var lev = 0;
											var player_atk = 0;
											var weapon_d = 0;
											var dragon_claws = 0;
											var act = "";
											var d = new Date();
											var long_date = "";
											var last = "";
											var suspended = "";
											var nickname = "";
											var class_name = "";
											var life = 0;
											var total_life = 0;
											var craft_count = 0;
											var ability = 0;
											var dmg = 0;
											var dmg_cnt = 0;
											var dmg2 = 0;
											var dmg_cnt2 = 0;
											var base_text = "";

											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												if (rows[i].dmg == null){
													rows[i].dmg = 0;
												}
												stars = "";
												if (rows[i].reborn >= 2){
													stars = rebSym(rows[i].reborn);
												}

												lev = Math.floor(rows[i].exp/10);
												weapon_d = parseInt(rows[i].weapon);
												dragon_claws = 0;
												player_atk = (lev+weapon_d) + " - " + ((lev+weapon_d)+(weapon_d+dragon_claws));

												if (rows[i].mission_time_end != null){
													d = new Date(rows[i].mission_time_end);
													long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();
													act = "Missione (" + long_date + ")";
												}else if (rows[i].travel_time_end != null){
													d = new Date(rows[i].travel_time_end);
													long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();
													act = "Viaggio (" + long_date + ")";
												}else if (rows[i].cave_time_end != null){
													d = new Date(rows[i].cave_time_end);
													long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();
													act = "Cava (" + long_date + ")";
												}else if (rows[i].holiday == 1){
													act = "Vacanza";
												}else{
													act = "-";
												}

												if (rows[i].role == 0){
													d = new Date(rows[i].time);
													last = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();
												}else{
													last = "Nascosto";
												}

												if (rows[i].suspended == 1){
													suspended = " Sospeso";
												}else{
													suspended = "";
												}

												var act_line = "";
												if ((act != "-") || (suspended != "")){
													act_line = "AttivitÃ : " + act + suspended + "\n";
												}

												nickname = rows[i].nickname;
												class_name = rows[i].class_name;
												life = rows[i].life;
												total_life = rows[i].total_life;
												craft_count = rows[i].craft_count;
												ability = rows[i].ability;
												dmg = rows[i].dmg;
												dmg_cnt = rows[i].dmg_cnt;
												rank = rows[i].rank;

												if (list_dmg[rows[i].player_id] == undefined){
													dmg2 = 0;
													dmg_cnt2 = 0;
												}else{
													dmg2 = list_dmg[rows[i].player_id];
													dmg_cnt2 = list_dmg_cnt[rows[i].player_id];
												}

												if (dmg2 == null){
													dmg2 = 0;
												}

												base_text = "<i>" + nickname + "</i> "  + stars + " \n" +
													class_name + " livello " + lev + "\n" +
													act_line +
													"Ultimo accesso: " + last + "\n" +
													"Danno base: " + player_atk + "\n" +
													"Salute: " + life + "/" + total_life + " hp\n" + 
													"Creazioni/AbilitÃ /Rango: " + craft_count + " pnt/" + ability + " pnt/" + rank + "\n" +
													"Danni scalata: " + dmg + " dmg/" + dmg_cnt + " colpi\n" +
													"Danni boss attuale: " + dmg2 + " dmg/" + dmg_cnt2 + " colpi\n\n";

												if (i < 10){
													user_text += base_text;
												}else{
													user_text2 += base_text;
												}
											}

											if (isAdmin == 1){
												// ADMIN

												iKeys.push(["Potenzia"]);
												iKeys.push(["Cambia Admin","Cambia Nome"]);
												iKeys.push(["Sciogli","Espelli","Sospendi"]);
												iKeys.push(["Hall of Fame","Liste Membri"]);
												iKeys.push(["Accademia"]);
												if (closed == 1){
													iKeys.push(["Tipo: Chiuso"]);
												}else{
													iKeys.push(["Tipo: Aperto"]);
												}

												if (details == 1){
													iKeys.push(["Dettagli: Non Visibili"]);
												}else{
													iKeys.push(["Dettagli: Visibili"]);
												}

												iKeys.push(["Torna al menu"]);
											}else{
												// UTENTE
												iKeys.push(["Hall of Fame","Notifiche"]);
												iKeys.push(["Liste Membri","Lascia"]);
												if (childName != ""){
													iKeys.push(["Trasferimento all'Accademia"]);
												}
												if (motherName != ""){
													iKeys.push(["Trasferimento al Principale"]);
												}
												iKeys.push(["Torna al menu"]);
											}

											var kb = {
												parse_mode: "HTML",
												reply_markup: {
													resize_keyboard: true,
													one_time_keyboard: true,
													"keyboard": iKeys
												}
											};

											var level = rows[0].level;
											var bonus = rows[0].players*100;

											var text = "Bentornato nel team <b>" + teamName + "</b>!\n";
											text += "Membri: " + rows[0].players + "/" + rows[0].max_players + " (+" + bonus + " Â§)\n";
											text += "Boss uccisi: " + rows[0].boss_count + ", punti creazione: " + formatNumber(team_craft) + "\n";
											text += "Scalate: " + rows[0].kill_num1 + " parziali, " + rows[0].kill_num2 + " complete\n";
											if (isAdmin == 1){
												text += "Usa '/messaggio testo' per inviare un messaggio al team";
											}else{
												text += "L'amministratore Ã¨ " + adminName;
											}
											if (childName != ""){
												text += "\nTeam Accademia: " + childName;
												text += ", fornisce +" + Math.round((childPlayers*100)/2) + " Â§";
											}
											if (motherName != ""){
												text += "\nTeam Madre: " + motherName;
											}
											var extra = 0;
											if ((isAdmin == 1) || (details == 1)){
												text += user_text;
												extra = 1;
											}

											bot.sendMessage(message.chat.id, text, kb);
											if ((rows[0].players >= 11) && (extra == 1)){
												setTimeout(function() {
													bot.sendMessage(message.chat.id, user_text2, kb);
												}, 500);
											}
										});
									});
								});
							});
						});
					});
				});
			}
		});
	});
});

bot.onText(/Liste membri/i, function(message) {
	var keynull = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Nessuno"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;

		bot.sendMessage(message.chat.id, "Inserisci il nome del team da cercare, anche parziale. Per una ricerca precisa aggiungi l'asterisco al fondo.", keynull).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if ((answer.text != "Torna al menu") && (answer.text != "Nessuno")){

					var query = 'LIKE "%' + answer.text + '%"';
					if (answer.text.indexOf("*") != -1){
						answer.text = answer.text.replace("*","");
						query = '= "' + answer.text + '"';
					}

					connection.query('SELECT * FROM team WHERE name ' + query, function(err, rows, fields) {
						if (err) throw err;

						var search1 = Object.keys(rows).length;
						var res1 = rows;

						var terms = "";
						if (search1 > 1){
							terms += "\n\n";
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								terms += rows[i].name + "\n";
							}
						}

						connection.query('SELECT * FROM team WHERE name LIKE "' + answer.text + '"', function(err, rows, fields) {
							if (err) throw err;

							var search2 = Object.keys(rows).length;
							var res2 = rows;

							if ((search1 == 0) && (search2 == 0)){
								bot.sendMessage(message.chat.id, "Il team che hai richiesto non esiste", team);
								return;
							}
							if ((search1 > 1) && (search2 == 0)){
								bot.sendMessage(message.chat.id, "Troppi risultati, riprova con termini di ricerca piÃ¹ precisi" + terms, team);
								return;
							}

							if (search1 == 1){
								rows = res1;
							}else{
								rows = res2;
							}

							var text = "Il team <b>" + rows[0].name + "</b> ha ucciso " + rows[0].boss_count + " boss\n\n";
							connection.query('SELECT player.nickname, player.reborn, player.exp FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + rows[0].id, function(err, rows, fields) {
								if (err) throw err;
								var stars = "";
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									text += rows[i].nickname + " " + rebSym(rows[i].reborn) + " (" + Math.floor(rows[i].exp/10) + ")\n";
								}
								bot.sendMessage(message.chat.id, text, team_html);
							});
						});
					});
				}
			}
		});
	});	
});

bot.onText(/Fonda nuovo/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		var new_price = 5000;
		var price_drop = 0;
		var price_drop_msg = "";
		var n = new Date().getDay()
		var n2 = new Date().getDate();

		if (rows[0].team_time != null){
			var d2 = new Date(rows[0].team_time);
			var short_date = addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + short_date + " di tre giorni successivi all'uscita.", back);
			return;
		}

		if (n == 0){
			price_drop = 1;
			new_price = 3500;
			price_drop_msg = "*SOLO OGGI* ";
		}

		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				bot.sendMessage(message.chat.id, "Sei giÃ  in un team!", team);
				return;
			}

			if (money < new_price){
				bot.sendMessage(message.chat.id, "Non hai abbastanza soldi.", back);
				return;
			}

			bot.sendMessage(message.chat.id, "Scegli un nome per il tuo Team, ma fai attenzione non potrai cambiarlo. Inoltre non usare simboli ne la parola 'Team'.", mark).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var name = answer.text.trim();

					if ((name.indexOf("Team") != -1) || (name.indexOf("team") != -1) || (name == "") || (name.indexOf("_") != -1) || (name.indexOf("*") != -1) || (name.toLowerCase() == "Torna al menu")){
						bot.sendMessage(message.chat.id, "Nome non valido.", back);
						return;						
					}

					if (re2.test(name) == false){
						bot.sendMessage(message.chat.id, "I simboli non sono consentiti.", back);
						return;	
					}

					connection.query('SELECT * FROM team WHERE name = "' + name + '"', function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length == 0){
							connection.query('INSERT INTO `team`(`id`, `name`, `players`, `max_players`) VALUES (DEFAULT,"' + name + '",1,3)', function(err, rows, fields) {
								if (err) throw err;
								connection.query('UPDATE player SET money = money - ' + new_price + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Team " + name + " creato! Puoi ospitare 3 membri totali compreso te, torna su questa pagina per gestire il team e potenziarlo.", team);
								});
								connection.query('SELECT id FROM team WHERE name = "' + name + '"', function(err, rows, fields) {
									if (err) throw err;
									connection.query('INSERT INTO `team_player`(`id`, `player_id`, `team_id`) VALUES (DEFAULT,' + player_id + ',' + rows[0].id + ')', function(err, rows, fields) {
										if (err) throw err;
										console.log("Admin aggiunto");
									});
									spawnTeamBoss(rows[0].id);
								});								
							});
						}else{
							bot.sendMessage(message.chat.id, "Il nome che hai inserito esiste giÃ , riprova.", team);
							return;
						}
					});
				};
			});			
		});
	});
});

bot.onText(/Entra in uno esistente|Pagina (.+)/i, function(message, match) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (rows[0].team_time != null){
			var d2 = new Date(rows[0].team_time);
			var short_date = addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + short_date + " di tre giorni successivi all'uscita.", back);
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		if (rows[0].team_time != null){
			var d2 = new Date(rows[0].team_time);
			var short_date = addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + short_date + " di tre giorni successivi all'uscita.", back);
			return;
		}

		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				bot.sendMessage(message.chat.id, "Sei giÃ  in un team!", team);
				return;
			}
			var iKeys = [];

			var thisPage = 1;
			var limMin = 0;
			var limMax = 100;
			if (match[1] != undefined){
				thisPage = match[1];
				limMin = 100*(thisPage-1);
				limMax = 100*thisPage;
			}

			connection.query('SELECT * FROM team WHERE closed = 0 AND players < max_players ORDER BY name LIMIT ' + limMin + ', ' + limMax, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Non ci sono piÃ¹ team disponibili o hanno raggiunto il limite di membri.", back);
					return;
				}

				var closed_text = "";

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].closed == 1){
						closed_text = "Chiuso";
					}else{
						closed_text = "Aperto";
					}
					iKeys.push(["Entra in " + rows[i].name + " (" + rows[i].players + "/" + rows[i].max_players + ")"]);
				};

				if (Object.keys(rows).length == 100){
					iKeys.push(["Pagina " + (thisPage+1)]);
				}
				iKeys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				bot.sendMessage(message.chat.id, "Seleziona il team al quale desideri unirti.", kb);
			});
		});
	});
});

bot.onText(/Hall of Fame/i, function(message) {
	connection.query('SELECT team.name FROM team, team_player WHERE team.id = team_player.team_id AND team_player.player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function(err, rows, fields) {
		if (err) throw err;

		var myTeam = 0;

		if (Object.keys(rows).length > 0){
			myTeam = rows[0].name;
		}

		connection.query('SELECT name As name, (craft_count+(boss_count*(SELECT COUNT(*) FROM team_player WHERE team_id = T.id))) As pnt FROM team T WHERE name != "Number Zero" GROUP BY id ORDER BY pnt DESC', function(err, rows, fields){
			if (err) throw err;
			var text = "Classifica Team:\n";
			var c = 1;
			var mypos = "";
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				if (c <= 15){
					text += c + "Â° " + rows[i].name + " (" + formatNumber(Math.floor(rows[i].pnt)) + " pnt )\n";
				}
				if (myTeam != 0){
					if (rows[i].name == myTeam){
						mypos = "\nIl tuo team:\n";
						mypos += c + "Â° " + rows[i].name + " (" + formatNumber(Math.floor(rows[i].pnt)) + " pnt )";
					}
				}
				c++;
			}
			bot.sendMessage(message.chat.id, text + mypos, team);
		});
	});
});

bot.onText(/Dettagli: |Dettagli: /i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					var closed = rows[0].closed;
					var details = rows[0].details;

					if (isAdmin == 0){
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}
					if (details == 1){
						connection.query('UPDATE team SET details = 0 WHERE id = ' + team_id, function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Ora i membri non visualizzano piÃ¹ la lista dei membri.", team);
						});
					}else{
						connection.query('UPDATE team SET details = 1 WHERE id = ' + team_id, function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Ora i membri possono visualizzare la lista dei membri.", team);
						});
					}					
				});
			});
		});
	});
});

bot.onText(/Tipo: Aperto|Tipo: Chiuso/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					var closed = rows[0].closed;
					var details = rows[0].details;

					if (isAdmin == 0){
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}

					if (closed == 1){
						connection.query('UPDATE team SET closed = 0 WHERE id = ' + team_id, function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Il team Ã¨ stato impostato su Aperto, gli utenti possono accedere liberamente.", team);
						});
					}else{
						connection.query('UPDATE team SET closed = 1 WHERE id = ' + team_id, function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Il team Ã¨ stato impostato su Chiuso, nessun utente puÃ² accedere.", team);
						});
					}
				});
			});
		});
	});
});

bot.onText(/Espelli/i, function(message) {
	var player = message.text.substring(message.text.indexOf(" ")+1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_player.role = 0 AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}

			var iKeys = [];
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push(["Espelli " + rows[i].nickname]);
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					if (isAdmin == 0){
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}

					if ((player != "") && (player != " ") && (message.text.indexOf(" ") != -1)){
						connection.query('SELECT chat_id, player.id FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Non ho trovato il giocatore selezionato.", team);
								return;
							}
							var chat_id = rows[0].chat_id;
							var playerId = rows[0].id;

							if (player_id == playerId){
								bot.sendMessage(message.chat.id, "Non puoi espellere te stesso", team);
								return;
							}

							connection.query('DELETE FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + playerId + ' LIMIT 1', function(err, rows, fields) {
								if (err) throw err;
								connection.query('UPDATE team SET players = players-1 WHERE id = ' + team_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, player.replace(new RegExp("_", "g"), " ") + " Ã¨ stato cacciato dal team!", team);
									bot.sendMessage(chat_id, "Sei stato cacciato dal team!");
								});

								var d2 = new Date();
								d2.setHours(d2.getHours() + 72);
								var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth()+1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

								connection.query('UPDATE player SET boss_id = 0, team_time = "' + long_date + '" WHERE id = ' + playerId, function(err, rows, fields) {
									if (err) throw err;
								});
							});
						});
						return;
					}

					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					bot.sendMessage(message.chat.id, "Chi vuoi cacciare dal team?", kb);
				});
			});
		});
	});
});

bot.onText(/Esplorazioni/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_player.role = 0 AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", back);
				return;
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT player_id FROM travel_team WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0){
					bot.sendMessage(message.chat.id, "Sei giÃ  in esplorazione", back);
					return;
				}

				connection.query('SELECT name FROM travel WHERE id < 4', function(err, rows, fields) {
					if (err) throw err;

					var iKeys = [];
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						iKeys.push([rows[i].name]);
					}
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};
					var kbBack = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Torna alle esplorazioni"],["Torna al menu"]]
						}
					};				
					var kbConf = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Continua"],["Torna alle esplorazioni"]]
						}
					};

					var sql = 	'SELECT player.nickname, player.id FROM team_player, player ' +
						'WHERE player.travel_team_id != 0 AND player.travel_id != 0 AND player.mission_id != 0 AND player.holiday != 0 AND player.cave_id != 0 AND player.id = team_player.player_id AND team_id = ' + team_id;

					connection.query(sql, function(err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length < 2){
							bot.sendMessage(message.chat.id, "Non ci sono abbastanza membri liberi per iniziare un esplorazione", back);
							return;
						}

						var members = "";
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							members += "> " + rows[i].nickname + "\n";
						}

						bot.sendMessage(message.chat.id, "*Esplorazioni di Team*\nPuoi iniziare una missione di team impostando i membri in base al tipo di missione, alla fine otterrai un report con il risultato dell'esplorazione", kb).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Torna al menu"){
									return;
								}
								connection.query('SELECT id, players, team_boost, description_team, duration_team, name FROM travel WHERE name = "' + answer.text + '" AND id < 4', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Esplorazione non valida", kbBack);
										return;
									}
									var travel_id = rows[0].id;
									var duration = rows[0].duration_team;
									var desc = rows[0].description_team;

									bot.sendMessage(message.chat.id, "*" + rows[0].name + "*\n" + desc + "\nL'esplorazione durerÃ  " + duration + " ore, dovrai selezionare " + rows[0].players + " compagni e offre un boost " + rows[0].team_boost, kbConf).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text == "Continua"){
												bot.sendMessage(message.chat.id, "Specifica i membri che vuoi coinvolgere separandoli con una virgola, al momento sembra che siano liberi:\n\n" + members).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text.indexOf(",") != -1){
															var memList = answer.text.split(",");
															var numMem = Object.keys(memList).length;
															var memListSql = "";

															for (var i = 0, len = numMem; i < len; i++) {
																memListSql += "'" + memList[i] + "'";
																if (i < len-1){
																	memListSql += ",";
																}
															}
															console.log(memListSql);

															connection.query("SELECT MAX(id) As maxid FROM travel_team_status", function(err, rows, fields) {
																if (err) throw err;

																var status_id = 0;
																if (Object.keys(rows).length > 0){
																	status_id = rows[0].maxid;
																}

																status_id = parseInt(status_id)+1;

																connection.query(sql + " AND player.nickname IN (" + memListSql + ")", function(err, rows, fields) {
																	if (err) throw err;
																	if (Object.keys(rows).length < numMem){
																		bot.sendMessage(message.chat.id, "Controlla di aver inserito dei nickname validi", kbBack);
																		return;
																	}

																	for (var i = 0, len = numMem; i < len; i++) {
																		connection.query("UPDATE player SET travel_team_id = " + travel_id + " WHERE id = " + rows[i].id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query("INSERT INTO travel_team (status_id, player_id, team_id, travel_id) VALUES (" + status_id + "," + rows[i].id + "," + team_id + "," + travel_id + ")", function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}

																	var d = new Date();
																	d.setHours(d.getHours() + duration);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	var short_date = addZero(newDate.getDate()) + "/" + addZero(newDate.getMonth()+1) + "/" + newDate.getFullYear() + " alle " + addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());

																	connection.query("INSERT INTO travel_team_status (id, time_end) VALUES (" + status_id + ",'" + long_date + "')", function(err, rows, fields) {
																		if (err) throw err;
																	});

																	bot.sendMessage(message.chat.id, "L'esplorazione terminerÃ  il " + short_date, back);
																});
															});
														}
													}
												});
											}
										};
									});
								});
							};
						});
					});
				});
			});
		});
	});	
});

bot.onText(/Sospendi/i, function(message) {
	var player = message.text.substring(message.text.indexOf(" ")+1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_player.role = 0 AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}

			var iKeys = [];
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push(["Sospendi " + rows[i].nickname]);
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					if (isAdmin == 0){
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}

					if ((player != "") && (player != " ") && (message.text.indexOf(" ") != -1)){
						connection.query('SELECT chat_id, player.id, team_player.suspended FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Non ho trovato il giocatore selezionato.", team);
								return;
							}
							var chat_id = rows[0].chat_id;
							var playerId = rows[0].id;

							if (player_id == playerId){
								bot.sendMessage(message.chat.id, "Non puoi sospendere te stesso", team);
								return;
							}

							var s = 0;
							if (rows[0].suspended == 0){
								s = 1;
							}

							connection.query('UPDATE team_player SET suspended = ' + s + ' WHERE player_id = ' + playerId, function (err, rows, fields){
								if (err) throw err;
								if (s == 1){
									bot.sendMessage(message.chat.id, player.replace(new RegExp("_", "g"), " ") + " Ã¨ stato sospeso dal team!", team);
									bot.sendMessage(chat_id, "Sei stato sospeso dal team!");
								}else{
									bot.sendMessage(message.chat.id, player.replace(new RegExp("_", "g"), " ") + " non Ã¨ piÃ¹ sospeso dal team!", team);
									bot.sendMessage(chat_id, "Non sei piÃ¹ sospeso dal team!");									
								}
							});
						});
						return;
					}

					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					bot.sendMessage(message.chat.id, "Chi vuoi sospendere dal team? L'utente non riceverÃ  premi dalle uccisioni dei boss", kb);
				});
			});
		});
	});
});

bot.onText(/^Accademia/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;

					var now = new Date();

					if (rows[0].child_time != null){
						var d = new Date(rows[0].child_time);
						if (d > now){
							var long_date = addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear() + " alle " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

							bot.sendMessage(message.chat.id, "Prima di cambiare accademia devi aspettare fino al " + long_date, team);
							return;
						}
					}

					if (rows[0].child_team != 0){
						bot.sendMessage(message.chat.id, "Questo team Ã¨ giÃ  collegato ad un'accademia, se continui andrai a rimpiazzarla", team);
					}

					var teamName = rows[0].name;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Scollega"],["Annulla"]]
						}
					};

					if (isAdmin == 0){
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}

					bot.sendMessage(message.chat.id, "Collegare un accademia a questo team aumenterÃ  il premio per uccisione boss. Inserisci il nome completo del team da rendere accademia di questo.\nNota: Inizierai a ottenere bonus solo se l'accademia Ã¨ almeno al livello 5, lo stesso nell'altro senso\nNon potrai cambiare accademia per una settimana", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text == "Scollega"){
								connection.query('UPDATE team SET child_team = 0 WHERE child_team = ' + team_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il tuo team non Ã¨ piÃ¹ un'accademia", team);
								});
								return;
							}
							if ((answer.text != "Annulla") && (answer.text != "Torna al menu")){
								connection.query('SELECT * FROM team WHERE name = "' + answer.text + '"', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Questo team non esiste", team);
										return;
									}

									var teamName2 = rows[0].name;

									if (team_id == rows[0].id){
										bot.sendMessage(message.chat.id, "Lo stesso team non puÃ² essere sia madre che accademia di se stesso", team);
										return;
									}

									var d = new Date();
									d.setDate(d.getDate() + 7);
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

									connection.query('UPDATE team SET child_team = ' + rows[0].id + ', child_time = "' + long_date + '" WHERE id = ' + team_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, teamName2 + " Ã¨ ora accademia di " + teamName + "!", team);
									});
								});
							};
						};
					});
				});
			});
		});
	});
});

bot.onText(/^\/names (.+)/i, function(message, match){
	var split = message.text.split(" ");

	bot.sendMessage(message.chat.id, split[1] + " <-> " + split[2] + "\nSimilaritÃ : " + similarWord.get(split[1], split[2]) + "\nDeve essere maggiore della lunghezza del nome accademia", back);
});

bot.onText(/Trasferimento all'Accademia/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;

					var childId = rows[0].child_team;

					if (childId == 0){
						bot.sendMessage(message.chat.id, "Questo team non possiede un'accademia", team);
						return;
					}

					var teamName = rows[0].name;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Si"],["Torna al Team"]]
						}
					};

					if (crazyMode == 1){
						bot.sendMessage(message.chat.id, "Durante l'evento folle non puoi trasferirti!", team);
						return;
					}

					if (isAdmin == 1){
						bot.sendMessage(message.chat.id, "Passa il potere a qualcun'altro prima di trasferirti!", team);
						return;
					}

					connection.query('SELECT players, max_players FROM team WHERE id = ' + childId, function(err, rows, fields) {
						if (err) throw err;

						if (rows[0].players >= rows[0].max_players){
							bot.sendMessage(message.chat.id, "Il team Ã¨ pieno!", team);
							return;
						}

						bot.sendMessage(message.chat.id, "Sicuro di volerti trasferire nell'accademia?", kb).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text.toLowerCase() == "si"){

									var d2 = new Date();
									d2.setHours(d2.getHours() + 48);
									var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth()+1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

									connection.query('UPDATE player SET boss_time = "' + long_date + '", boss_id = 0 WHERE id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});

									connection.query('SELECT player_id FROM team_player WHERE team_id = ' + team_id + ' AND role = 1', function(err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(rows[0].chat_id, message.from.username + " si Ã¨ trasferito in accademia!");
										});
									});

									connection.query('SELECT player_id FROM team_player WHERE team_id = ' + childId + ' AND role = 1', function(err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(rows[0].chat_id, message.from.username + " si Ã¨ trasferito dal team madre!");
										});
									});

									connection.query('UPDATE team_player SET kill_streak = 0, team_id = ' + childId + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Ti sei trasferito nell'accademia!", team);
									});
								};
							};
						});
					});
				});
			});
		});
	});
});
bot.onText(/Trasferimento al Principale/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE child_team = ' + team_id, function(err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Questo team non possiede un team madre", team);
						return;
					}

					var motherId = rows[0].id;
					var teamName = rows[0].name;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Si"],["Torna al Team"]]
						}
					};

					if (crazyMode == 1){
						bot.sendMessage(message.chat.id, "Durante l'evento folle non puoi trasferirti!", team);
						return;
					}

					if (isAdmin == 1){
						bot.sendMessage(message.chat.id, "Passa il potere a qualcun'altro prima di trasferirti!", team);
						return;
					}

					connection.query('SELECT players, max_players FROM team WHERE id = ' + motherId, function(err, rows, fields) {
						if (err) throw err;

						if (rows[0].players >= rows[0].max_players){
							bot.sendMessage(message.chat.id, "Il team Ã¨ pieno!", team);
							return;
						}

						bot.sendMessage(message.chat.id, "Sicuro di volerti trasferire nel team madre", kb).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text.toLowerCase() == "si"){

									var d2 = new Date();
									d2.setHours(d2.getHours() + 48);
									var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth()+1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

									connection.query('UPDATE player SET boss_time = "' + long_date + '", boss_id = 0 WHERE id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});

									connection.query('SELECT player_id FROM team_player WHERE team_id = ' + team_id + ' AND role = 1', function(err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(rows[0].chat_id, message.from.username + " si Ã¨ trasferito in team madre!");
										});
									});

									connection.query('SELECT player_id FROM team_player WHERE team_id = ' + motherId + ' AND role = 1', function(err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(rows[0].chat_id, message.from.username + " si Ã¨ trasferito dall'accademia!");
										});
									});

									connection.query('UPDATE team_player SET kill_streak = 0, team_id = ' + motherId + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Ti sei trasferito nel team madre!", team);
									});
								};
							};
						});
					});
				});
			});
		});
	});
});

bot.onText(/Lascia$/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ' LIMIT 1) ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
				if (err) throw err;
				var level = rows[0].level;

				bot.sendMessage(message.chat.id, "Sei sicuro di voler uscire dal team?", conf).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						var action = answer.text;
						if (action == "Torna al Team"){
							return;
						}else if (action == "Conferma"){	
							connection.query('SELECT player.chat_id FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND role = 1', function(err, rows, fields) {
								if (err) throw err;
								var chat_id = rows[0].chat_id;
								connection.query('DELETE FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id + ' LIMIT 1', function(err, rows, fields) {
									if (err) throw err;
									connection.query('UPDATE team SET players = players-1 WHERE id = ' + team_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Sei uscito dal team! Per 72 ore non puoi entrare o creare un altro team!", back);
										bot.sendMessage(chat_id, message.from.username + " Ã¨ uscito dal team!");
									});

									var d2 = new Date();
									d2.setHours(d2.getHours() + 72);
									var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth()+1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

									connection.query('UPDATE player SET boss_id = 0, team_time = "' + long_date + '" WHERE id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});
								});
							});
						}
					};
				});
			});
		});
	});
});

bot.onText(/Notifiche$/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ' LIMIT 1) ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT notification FROM team_player WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
				var notify = rows[0].notification;

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;

					bot.sendMessage(message.chat.id, "Cambiare l'impostazione notifiche da parte del team?", conf).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var action = answer.text;
							if (action == "Torna al Team"){
								return;
							}else if (action == "Conferma"){
								if (notify == 1){
									notify = 0;
								}else{
									notify = 1;
								}
								connection.query('UPDATE team_player SET notification = ' + notify + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									if (notify == 0){
										bot.sendMessage(message.chat.id, "Hai disattivato le notifiche team!", back);
									}else{
										bot.sendMessage(message.chat.id, "Hai attivato le notifiche team!", back);
									}
								});
							}
						};
					});
				});
			});
		});
	});
});

bot.onText(/Sciogli/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					if (isAdmin == 1){

						bot.sendMessage(message.chat.id, "Sei sicuro di voler eliminare il team?", conf).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								var action = answer.text;
								if (action == "Conferma"){
									connection.query('SELECT * FROM team_player WHERE team_id = ' + team_id, function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 1){
											connection.query('DELETE FROM team_player WHERE team_id = ' + team_id, function(err, rows, fields) {
												if (err) throw err;
												connection.query('DELETE FROM team WHERE id = ' + team_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Team eliminato! Non puoi crearlo o accedere ad un altro team prima che siano passate 72 ore!", back);
													return;
												});
											});
											var d2 = new Date();
											d2.setHours(d2.getHours() + 72);
											var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth()+1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

											connection.query('UPDATE player SET boss_id = 0, team_time = "' + long_date + '" WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
											});
											connection.query('DELETE FROM boss_team WHERE team_id = ' + team_id, function(err, rows, fields) {
												if (err) throw err;
											});											
										}else{
											bot.sendMessage(message.chat.id, "Devi prima espellere tutti i membri del team!", team);
											return;
										}
									});
								}
							};
						});
					}else{
						bot.sendMessage(message.chat.id, "Questa operazione Ã¨ consentita solo all'amministratore.", back);
						return;
					}	
				});
			});
		});
	});
});

bot.onText(/cambia admin/i, function(message) {

	var player = message.text.substring(message.text.indexOf(":")+2);

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					if (isAdmin == 1){
						var iKeys = [];

						connection.query('SELECT player.nickname FROM `team_player`, player WHERE team_player.player_id = player.id AND team_id = ' + team_id, function(err, rows, fields) {
							if (err) throw err;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								if (rows[i].nickname != message.from.username){
									iKeys.push(["Cambia admin: " + rows[i].nickname]);										
								}
							}

							if ((player != "") && (player != " ") && (message.text.indexOf(":") != -1)){
								connection.query('SELECT player.nickname FROM `team_player`, player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length > 0){
										connection.query('SELECT id FROM player WHERE nickname = "' + player + '"', function(err, rows, fields) {
											if (err) throw err;
											var newAdmin = rows[0].id;
											connection.query('UPDATE team_player SET role = 0 WHERE player_id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
											});
											connection.query('UPDATE team_player SET role = 1 WHERE player_id = ' + newAdmin, function(err, rows, fields) {
												if (err) throw err;
											});
											bot.sendMessage(message.chat.id, "Cambio admin completato!", back);
										});
									}else{
										bot.sendMessage(message.chat.id, "Questo giocatore non Ã¨ valido.", back);
										return;
									}
								});
								return;
							}


							var kb = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									one_time_keyboard: true,
									"keyboard": iKeys
								}
							};

							bot.sendMessage(message.chat.id, "Chi vuoi eleggere amministratore al posto tuo?", kb);
						});
					}else{
						bot.sendMessage(message.chat.id, "Questa operazione Ã¨ consentita solo all'amministratore.", back);
						return;	
					}
				});
			});
		});
	});
});

bot.onText(/^potenzia$/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields){
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1){
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;

					if (isAdmin == 1){
						if (level >= 9){
							bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del Team.", team);
							return;
						}

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": [['Conferma'],['Torna al Team']]
							}
						};

						var price = 4000;
						if (level+1 < 2){
							price = 8000;
						}else if (level+1 < 4){
							price = 10000;
						}else if (level+1 < 6){
							price = 15000;
						}else if (level+1 < 7){
							price = 20000;
						}else if (level+1 < 8){
							price = 30000;
						}else{
							price = 50000;
						}

						bot.sendMessage(message.chat.id, "Il potenziamento al livello " + (level+1) + " ti costerÃ  " + price + " Â§ e aumenterÃ  lo spazio per i membri del team", kb).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								var action = answer.text;
								if (action == "Conferma"){
									if (money < price){
										bot.sendMessage(message.chat.id, "Non hai abbastanza monete.", team);
										return;
									}
									var upd = 2;
									if (level == 8){
										upd = 3;
									}
									connection.query('UPDATE team SET level = level+1, max_players = max_players+' + upd + ' WHERE id = ' + team_id, function(err, rows, fields) {
										if (err) throw err;
										connection.query('UPDATE player SET money=money-' + price + ' WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
											connection.query('SELECT level, max_players FROM team WHERE id = ' + team_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Potenziamento al livello " + rows[0].level + " completato, ora puÃ² ospitare un massimo di " + rows[0].max_players + " membri", team);
											});
										});
									});
								}
							};
						});
					}else{
						bot.sendMessage(message.chat.id, "Questa operazione Ã¨ consentita solo all'amministratore.", back);
						return;
					}
				});
			});
		});
	});
});

bot.onText(/Entra in(?! uno esistente)/i, function(message) {
	var name = message.text.substring(message.text.indexOf("in")+3, message.text.lenght);

	if (name == "Torna al menu"){
		return;
	}

	var pos = name.indexOf("(");
	if (pos != -1){
		name = name.substr(0, pos-1);
	}

	if (name == "uno esistente"){
		return;
	}

	connection.query('SELECT id, team_time, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (rows[0].team_time != null){
			var d2 = new Date(rows[0].team_time);
			var short_date = addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + short_date + " di tre giorni successivi all'uscita.", back);
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM `team_player` where player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				bot.sendMessage(message.chat.id, "Sei giÃ  in un team.", back);
				return;
			}

			connection.query('SELECT * FROM team WHERE name = "' + name + '"', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0){
					if (rows[0].players < rows[0].max_players){
						var team_id = rows[0].id;
						var team_name = rows[0].name;
						if (rows[0].closed == 1){
							bot.sendMessage(message.chat.id, "Non puoi entrare in un team che non accetta altri membri.", back);
							return;
						}

						bot.sendMessage(message.chat.id, "Sicuro di voler entrare nel team " + team_name + "?", yesno).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text.toLowerCase() == "si"){
									connection.query('INSERT INTO `team_player`(`id`, `player_id`, `team_id`) VALUES (DEFAULT,' + player_id + ',' + team_id + ')', function(err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT player_id FROM team_player WHERE team_id = ' + team_id + ' AND role = 1', function(err, rows, fields) {
											if (err) throw err;
											connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(rows[0].chat_id, message.from.username + " Ã¨ entrato nel tuo team!");
											});
										});
										bot.sendMessage(message.chat.id, "Sei entrato nel team " + name + "!", team);
										return;
									});
									connection.query('UPDATE team SET players = players+1 WHERE id = ' + team_id, function(err, rows, fields) {
										if (err) throw err;
									});
								};
							};
						});
					}else{
						bot.sendMessage(message.chat.id, "Il team specificato Ã¨ pieno, chiedi al fondatore di potenziarlo per aumentare gli slot.", back);
						return;
					}
				}else{
					bot.sendMessage(message.chat.id, "Il team che hai richiesto non esiste.", back);
					return;
				}
			});
		});
	});
});

function spawnTeamBoss(team_id){
	connection.query('SELECT * FROM boss', function(err, rows, fields) {
		if (err) throw err;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			if (rows[i].id == 1){
				connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',1,' + team_id + ')', function(err, rows, fields) {
					if (err) throw err;
				});
			}else{
				connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',0,' + team_id + ')', function(err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
}

bot.onText(/^Robot/i, function(message) {
	if ((eventRobot == 0) && (message.from.username != "fenix45")){
		return;
	}

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;

		var kb = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Continua"],["Torna al menu"]]
			}
		};

		connection.query('SELECT player_id, phase FROM event_robot_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO event_robot_status (player_id, phase) VALUES (' + player_id + ',1)', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "intro", kb);
				});
			}else{
				connection.query('SELECT * FROM event_robot_list WHERE id = ' + rows[0].phase, function(err, rows, fields) {
					if (err) throw err;

					var next = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [[rows[0].r1],[rows[0].r2],[rows[0].r3],["Torna al menu"]]
						}
					};

					var text = rows[0].text;

					bot.sendMessage(message.chat.id, text.replace(new RegExp("%player%", "g"), message.from.username), next).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text != "Torna al menu"){
								var sel = 0;
								if (answer.text == rows[0].r1){
									sel = rows[0].p1;
								}else if (answer.text == rows[0].r2){
									sel = rows[0].p2;
								}else if (answer.text == rows[0].r3){
									sel = rows[0].p3;
								}else{
									return;
								}
								connection.query('UPDATE event_robot_status SET phase = ' + sel + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
							};
						};
					});
				});
			}
		});
	});
});

bot.onText(/^Villa|Torna alla Villa|Entra nella Villa/i, function(message) {
	if (message.from.username != "fenix45"){
		if (villa == 0){
			bot.sendMessage(message.chat.id, "L'evento Ã¨ terminato! Grazie per aver partecipato :D", back);
			return;
		}
	}

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Invia una Cassa ðŸ“¦"],["Chiedi ðŸ’Ž a fenix45!"],["Torna al menu"]]
		}
	};
	
	var kb1 = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Entra nella Villa ðŸ°"],["Torna al menu"]]
		}
	};

	var kb2 = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna alla Villa"],["Torna al menu"]]
		}
	};

	var kb3 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Chiedi a fenix45!"],["Torna alla Villa"],["Torna al menu"]]
		}
	};

	connection.query('SELECT id, token, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var token = rows[0].token;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		connection.query('SELECT COUNT(*) As cnt, (SELECT COUNT(*) FROM event_villa_gift WHERE from_id = ' + player_id + ') As mycnt FROM event_villa_gift', function(err, rows, fields) {
			if (err) throw err;

			var count = rows[0].cnt;
			var mycount = rows[0].mycnt;

			connection.query('SELECT player_id, points FROM event_villa_status WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0){
					connection.query('UPDATE `player` SET `boost_id`=1,`boost_mission` = 6 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						connection.query('INSERT INTO event_villa_status (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Benvenuto nella *Villa di LastSoldier95* ðŸ°!\nDurante questa settimana, questo facoltoso cavaliere ti premierÃ  per il completamento di *piÃ¹ missioni possibili*, piÃ¹ missioni verranno completate, piÃ¹ il padrone di casa sarÃ  soddisfatto.\nTi suggerisce anche un modo per coinvolgere piÃ¹ avventurieri possibili regalando loro *Casse Misteriose*!\nImmediatamente egli ti assegna una Bevanda Energetica Plus per partire con piÃ¹ carica e ti augura buona fortuna!", kb1);
						});
					});
					return;
				}

				var gift = Math.floor(rows[0].points/5);

				var text = "Benvenuto nella *Villa di LastSoldier95* ðŸ°!\nSvolgi missioni da questo momento ed ogni 5 punti otterrai la possibilitÃ  di inviare una *Cassa Misteriosa* ðŸ“¦ ad un altro avventuriero! Inoltre, Ã¨ possibile chiedere al sommo *fenix45* di donarvi una ðŸ’Ž in cambio di un ðŸŒ, attenzione perÃ², non sempre riesce a procurarsela!\n\nHai a disposizione *" + gift + "* Casse da inviare\nFin ora sono state inviate *" + count + "* Casse, *" + mycount + "* da parte tua";
				bot.sendMessage(message.chat.id, text, kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text.indexOf("Cassa") != -1){

							if (gift <= 0){
								bot.sendMessage(message.chat.id, "Non hai Casse a disposizione! Svolgi missioni per ottenere punti!", kb2);
								return;
							}

							bot.sendMessage(message.chat.id, "A chi vuoi inviare la Cassa? Puoi inviarne solamente due per persona! Scrivi il suo nome utente").then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									var nick = answer.text.replace("@","");
									connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + nick + '"', function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "Il nome utente inserito non esiste!", kb2);
											return;
										}
										var player_id2 = rows[0].id;
										var chat_id = rows[0].chat_id;

										if (player_id2 == player_id){
											bot.sendMessage(message.chat.id, "Quanto Ã¨ orribile inviare un dono a se stessi?! Daiii!", kb2);
											return;
										}

										if (player_id != 6889){
											if (player_id2 == 1){
												bot.sendMessage(message.chat.id, "Grazie per il pensiero ma il sommo ha giÃ  tutto â¤ï¸ ", kb2);
												return;
											}
										}

										connection.query('SELECT * FROM event_villa_gift WHERE from_id = ' + player_id + ' AND to_id = ' + player_id2, function (err, rows, fields){
											if (err) throw err;

											if (Object.keys(rows).length > 1){
												bot.sendMessage(message.chat.id, "Non puoi inviare piÃ¹ di due regali alla stessa persona!", kb2);
												return;
											}

											connection.query('UPDATE event_villa_status SET points = points-5 WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
											});
											connection.query('SELECT id, name FROM item WHERE rarity NOT IN ("C","U","A","X","NC","S","H","IN") AND craftable = 0 ORDER BY RAND()', function (err, rows, fields){
												if (err) throw err;

												var item_id = rows[0].id;
												var item_name = rows[0].name;

												connection.query('INSERT INTO event_villa_gift (from_id, to_id, item_id) VALUES (' + player_id + ',' + player_id2 + ',' + item_id + ')', function (err, rows, fields){
													if (err) throw err;
												});
												connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id2 + ',' + item_id + ')', function (err, rows, fields){
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai inviato una Cassa Misteriosa a <b>" + nick + "</b>!", kb2);
													bot.sendMessage(chat_id, "Hai ricevuto una Cassa Misteriosa contenente <b>" + item_name + "</b> da <b>" + message.from.username + "</b>!", html);
												});
											});
										});
									});
								};
							});
						}else if (answer.text.indexOf("fenix45") != -1){
							bot.sendMessage(message.chat.id, "Chiedi a fenix45 di provare a convertire una gemma in cambio di un gettone?", kb3).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Chiedi a fenix45!"){
										bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function() {
											answerCallbacks[message.chat.id] = function(answer) {
												if (answer.text.toLowerCase() == "si"){
													if (token <= 0){
														bot.sendMessage(message.chat.id, "Non hai abbastanza gettoni!", kb2);
														return;
													}else{
														connection.query('UPDATE player SET token = token-1 WHERE id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															var rand = Math.random()*100;
															if (rand < 30){
																connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "fenix45 Ã¨ riuscito a nel suo rituale! Hai ottenuto quindi una Gemma ðŸ’Ž !", kb2);
																});
															}else{
																bot.sendMessage(message.chat.id, "fenix45 ha fallito il rituale! E il tuo gettone Ã¨ perso...", kb2);
															}
														});
													}
												}
											}
										});
									}
								}
							});
						}
					};
				});
			});
		});
	});
});

bot.onText(/Casa Stregata/i, function(message) {
	var kbEnd = {
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Calderone"],["Torna al menu"]]
		}
	};

	if (halloween == 0){
		connection.query('SELECT nickname, trick_count FROM `event_halloween_status`, player WHERE player.id = player_id ORDER BY trick_count DESC', function(err, rows, fields) {
			if (err) throw err;

			var text = "Classifica dolcetto/scherzetto su " + Object.keys(rows).length + " partecipanti:\n";
			var mypos = "\nLa mia posizione:\n";
			var c = 1;
			if (Object.keys(rows).length > 0){
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (c <= 30){
						text += c + "Â° " + rows[i].nickname + " (" + rows[i].trick_count + ")\n";
					}
					if (rows[i].nickname == message.from.username){
						mypos += c + "Â° " + rows[i].nickname + " (" + rows[i].trick_count + ")";
					}
					c++;
				}
			}
			mypos += "\n\nA breve verranno rimossi tutti gli oggetti BASE dell'evento, quindi dolci usciti dal calderone e Zucche Complete rimarranno. Grazie per aver partecipato!";
			bot.sendMessage(message.chat.id, text + mypos, kbEnd);
		});
		return;
	}

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Esplorazione della Zucca"],["Dolcetto o Scherzetto"],["Calderone"],["Il Fantasma di Lootville ðŸ’Ž "],["Torna al menu"]]
		}
	};

	var kbBack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna alla Casa Stregata"],["Torna al menu"]]
		}
	};

	var kb2 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["A caso"],["Torna alla Casa Stregata"]]
		}
	};

	var kb3 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Chiedi di forgiare una Gemma"],["Torna alla Casa Stregata"]]
		}
	};


	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var token = rows[0].token;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		connection.query('SELECT * FROM event_halloween_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO `event_halloween_status`(`id`, `player_id`) VALUES (DEFAULT,' + player_id + ')', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Benvenuto nell'evento di Halloween, trova caramelle, pezzetti di zucca, parla con fantasmi e forma utili consumabili. Di notte le esplorazioni si fanno piÃ¹ interessanti! Comincia subito!", kbBack);
				});
				return;
			}

			var mission_type = rows[0].mission_type;
			var trick = rows[0].trick_count;
			var trick_time = rows[0].trick_time;

			var plur = "e";
			if (trick == 1){
				plur = "a";
			}

			bot.sendMessage(message.chat.id, "Benvenuto nella Casa Stregata ðŸ‘» , l'evento di Halloween! ðŸŽƒ \nEcco cosa puoi fare qui:\n> Intraprendere esplorazioni e trovare oggetti come Caramelle o Pezzetti di Zucca\n> Bussare a casa di un giocatore e chiedere Dolcetto o Scherzetto\n> Buttare dolci nel calderone e formare qualcosa di interessante!\n> Chiedere al Fantasma di forgiare per te una Gemma\nFin ora hai bussato a *" + trick + "* port" + plur + "!", kb).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "Esplorazione della Zucca"){
						if (mission_type != 0){
							bot.sendMessage(message.chat.id, "Stai giÃ  esplorando una zona!", kbBack);
							return;
						}

						var titles = [	"Lo Spaventapasseri",
									  "La Zucca Maligna",
									  "Fantasmi nei Vicoli",
									  "Gara tra Streghe",
									  "Un Poker Misterioso",
									  "Zucca Esplosiva"
									 ];

						var text = [	"Ho sentito alcune voci su uno spaventapasseri che sta terrorizzando il villaggio, potresti andare a controllare? Magari scopri qualcosa di interessante.",
									"Una Zucca completamente brillante sta rotolando giÃ¹ dalla collina infastidendo tutta la popolazione! Devi fermarla!",
									"Qualcuno ha segnalato la possibilitÃ  di fantasmi che preparano gustosi pranzi a base di zucca nei vicoli del villaggio, stanno rovinando l'economia della cittÃ ! Fai qualcosa!",
									"Hai sentito di una possibile gara tra streghe che si terrebbe oggi nei cieli del villaggio, ma entrambe poco esperte si stampano contro un albero e devi andarle a recuperare",
									"Due ragazzi vestiti da fantasmi stanno giocando a poker, quando arriva uno scheletro che sembra quasi vero, cosÃ¬ vero che lo Ã¨ sul serio! Fai qualcosa!",
									"Senti un rumore nel cielo, e ti accorgi solo dopo qualche secondo che si tratta di una zucca gigante! Speri di riuscire a raccoglierne un pezzetto, potebbe essere utile."
								   ];

						var time = [65,85,60,55,55,70];
						var rand = Math.round(Math.random()*(Object.keys(titles).length-1));

						var d = new Date();
						d.setMinutes(d.getMinutes() + time[rand]);
						var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

						bot.sendMessage(message.chat.id, "*" + titles[rand] + "*\n" + text[rand] + "\nQuesta ricerca durerÃ  _" + time[rand] + "_ minuti", kbBack);

						connection.query('UPDATE event_halloween_status SET mission_type = 1, time_end = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});
					}else if (answer.text == "Dolcetto o Scherzetto"){
						var now = new Date();
						var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

						if (trick_time > long_date){
							bot.sendMessage(message.chat.id, "Devi riposarti per 60 minuti prima di cercare un'altra casa dove bussare!", kbBack);
							return;
						}

						bot.sendMessage(message.chat.id, "Puoi andare a bussare alla casa di un giocatore a tua scelta e chiedergli un dolcetto, oppure donarne uno! Scrivi il nome del giocatore che vuoi andare a trovare.", kb2).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								var sql = ' AND nickname = "' + answer.text.replace("@","").trim() + '"';

								if (answer.text == "Torna alla Casa Stregata"){
									return;
								}else if (answer.text == "A caso"){
									sql = ' AND player_id != ' + player_id + ' ORDER BY RAND()';
								}

								connection.query('SELECT player_id, nickname, item_id, name, rarity FROM inventory_rarity WHERE craftable = 0 AND rarity = "H" AND player_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Non puoi uscire di casa senza dolcetti!", kbBack);
										return;
									}
									var myItem = rows[0].item_id;
									var myItemName = rows[0].name;

									connection.query('SELECT player_id, chat_id, nickname, item_id, name, rarity FROM inventory_rarity WHERE craftable = 0 AND rarity = "H"' + sql, function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "Questo giocatore non possiede nessun dolcetto, oppure non c'Ã¨ nessun giocatore disponibile!", kbBack);
											return;
										}
										var rand = Math.round(Math.random()*100);
										if (rand < 50){
											connection.query('UPDATE inventory SET player_id = ' + player_id + ' WHERE player_id = ' + rows[0].player_id + ' AND item_id = ' + rows[0].item_id + ' LIMIT 1', function (err, rows, fields) {
												if (err) throw err;
											});
											console.log("Dolcetto per " + message.from.username + " (" + player_id + ") - " + rows[0].name);
											bot.sendMessage(message.chat.id, "Bussi alla porta... " + rows[0].nickname.replace(new RegExp("_", "g"), " ") + " ti apre e chiedi 'Dolcetto o Scherzetto?'\nCon un sorriso ti consegna *" + rows[0].name + "* che riponi nel tuo zainetto!", kbBack);
											if (answer.text == "A caso"){
												bot.sendMessage(rows[0].chat_id, "Qualcuno ha bussato alla tua porta per Halloween, hai deciso di consegnare *" + rows[0].name + "*!", mark);
											}else{
												bot.sendMessage(rows[0].chat_id, message.from.username.replace(new RegExp("_", "g"), " ") + " ha bussato alla tua porta per Halloween, hai deciso di consegnare *" + rows[0].name + "*!", mark);												
											}
										}else{
											connection.query('UPDATE inventory SET player_id = ' + rows[0].player_id + ' WHERE player_id = ' + player_id + ' AND item_id = ' + myItem + ' LIMIT 1', function (err, rows, fields) {
												if (err) throw err;
											});
											console.log("Scherzetto per " + message.from.username + " (" + player_id + ") - " + myItemName);
											bot.sendMessage(message.chat.id, "Bussi alla porta... " + rows[0].nickname + " ti apre e chiedi 'Dolcetto o Scherzetto?'\nCon un sorriso maligno esce dalla porta con una zucca in testa, ti spaventi e sei costretto a lasciargli *" + myItemName + "*!", kbBack);
											if (answer.text == "A caso"){
												bot.sendMessage(rows[0].chat_id, "Qualcuno ha bussato alla tua porta per Halloween, ma l'hai mandato via e ottenuto *" + rows[0].name + "*!", mark);
											}else{
												bot.sendMessage(rows[0].chat_id, message.from.username.replace(new RegExp("_", "g"), " ") + " ha bussato alla tua porta per Halloween, ma l'hai mandato via e ottenuto *" + rows[0].name + "*!", mark);
											}
										}
										var d = new Date();
										d.setMinutes(d.getMinutes() + 60);
										var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

										connection.query('UPDATE event_halloween_status SET trick_count = trick_count + 1, trick_time = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
									});
								});
							};
						});
					}else if (answer.text.indexOf("Fantasma") != -1){
						bot.sendMessage(message.chat.id, "Il Fantasma di Lootville Ã¨ in grado, con i suoi poteri, di forgiare gemme ðŸ’Ž in cambio di gettoni. Vuoi chiedere il suo intervento?", kb3).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Chiedi di forgiare una Gemma"){
									bot.sendMessage(message.chat.id, "Forgiare una gemma richiede un gettone ma non per forza la conversione puÃ² riuscire, sicuro di continuare?", yesno).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){
												if (token < 1){
													bot.sendMessage(message.chat.id, "Non hai abbastanza gettoni!", kbBack);
													return;
												}else{
													connection.query('UPDATE player SET token = token-1 WHERE id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
														var rand = Math.random()*100;
														if (rand < 10){
															connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Il fantasma ha provato a forgiare la gemma ed Ã¨ riuscito! Hai ottenuto quindi una Gemma ðŸ’Ž !", kbBack);
															});
														}else{
															bot.sendMessage(message.chat.id, "Il fantasma ha provato a forgiare la gemma ma purtroppo non Ã¨ riuscito! E il tuo gettone non esiste piÃ¹...", kbBack);
														}
													});
												}
											}
										}
									});
								}
							}
						});
					}
				};
			});
		});
	});
});

bot.onText(/Calderone/i, function(message) {

	if (halloween == 0){
		return;
	}

	var kbBack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna al Calderone"],["Torna alla Casa Stregata"],["Torna al menu"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var iKeys = [];

		connection.query('SELECT * FROM event_halloween_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				return;
			}

			var status = rows[0].cauldron;
			var color = "bianco";

			if (status < 2500){
				color = "bianco";
			}else if (status < 5000){
				color = "verde";
			}else if (status < 10000){
				color = "rosso";
			}else if (status < 15000){
				color = "blu";
			}else if (status => 15000){
				color = "argento";
			}

			connection.query('SELECT item.name, count(item.name) As num FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND item.rarity = "H" GROUP BY item.name', function(err, rows, fields) {
				if (err) throw err;

				iKeys.push(["Forma Zucca Completa ðŸŽƒ"]);

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					iKeys.push([rows[i].name + " (" + rows[i].num + ")"]);
				}

				iKeys.push(["Procedi con la Miscela"]);
				iKeys.push(["Torna alla Casa Stregata"]);

				var kb3 = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				bot.sendMessage(message.chat.id, "Butta nel calderone tutti i dolci che hai trovato per tirare fuori qualcosa di MAGICO!\nUsa l'apposita opzione per unire invece tutti i pezzi di zucca ðŸŽƒ \nIl contenuto del Calderone sembra tendente al colore " + color, kb3).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {

						if (answer.text == "Torna alla Casa Stregata"){
							return;
						}else if (answer.text.indexOf("Forma") != -1){
							connection.query('SELECT COUNT(distinct item_id) As num FROM inventory WHERE item_id IN (578,579,580,581,582,583,584,585,586) AND player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "Non possiedi nessun oggetto per la zucca completa!", kbBack);
									return;
								}

								if (rows[0].num == 9){
									for (i = 578; i < 587; i++){
										console.log("cancellato per zucca: " + i);
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + i + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
										});
									}
									connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ', 593)', function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Sei riuscito ad unire tutti i pezzi della zucca e formare *Zucca Completa*!", kbBack);
									});
								}else{
									bot.sendMessage(message.chat.id, "Non possiedi tutti i pezzi della zucca!", kbBack);
								}
							});
						}else if (answer.text.indexOf("Procedi") != -1){
							if (status < 2501){
								bot.sendMessage(message.chat.id, "Non ci sono abbastanza ingredienti nel calderone!", kbBack);
								return;
							}

							connection.query('SELECT name, id FROM item WHERE id IN (594,595,596,597) ORDER BY id', function(err, rows, fields){
								if (err) throw err;

								var itemId = 0;
								var itemName = "";
								if ((status < 5000) && (status > 2500)){
									itemId = rows[0].id;
									itemName = rows[0].name;
								}else if (status < 10000){
									itemId = rows[1].id;
									itemName = rows[1].name;
								}else if (status < 15000){
									itemId = rows[2].id;
									itemName = rows[2].name;
								}else if (status >= 15000){
									itemId = rows[3].id;
									itemName = rows[3].name;
								}

								console.log("Calderone: " + itemName);

								connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ', ' + itemId + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Mescolando per lungo tempo sei riuscito a produrre *" + itemName + "*!", kbBack);
								});

								connection.query('UPDATE event_halloween_status SET cauldron = 0 WHERE player_id = ' + player_id, function(err, rows, fields){
									if (err) throw err;
								});
							});
						}else{
							var ogg = "";
							var pos = answer.text.indexOf("(");
							if (pos != -1){
								ogg = answer.text.substring(0,pos);
							}

							if (status > 31000){
								bot.sendMessage(message.chat.id, "Il calderone Ã¨ troppo pieno, c'Ã¨ il rischio che strabordi. Non puoi aggiungere nulla senza prima crearne qualcosa!", kbBack);
								return;
							}

							console.log(ogg);
							connection.query('SELECT item.value, item.id FROM item, inventory WHERE item.id = inventory.item_id AND inventory.player_id = ' + player_id + ' AND item.name = "' + ogg + '"', function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato", kbBack);
									return;
								}
								var item_id = rows[0].id;
								connection.query('UPDATE event_halloween_status SET cauldron = cauldron + ' + rows[0].value + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + item_id + ' LIMIT 1', function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai buttato l'oggetto nel calderone!", kbBack);
									});
								});
							});
						};

					};
				});
			});
		});
	});
});

bot.onText(/eventi/i, function(message) {

	var text = 	"*Lista Eventi:\n\n*" +
		"> *Storia Interattiva* - 1 Settimana\n" +
		"> *Arena dei Draghi* - Weekend\n" +
		"> *Lootteria* - Weekend\n" +
		"> *Weekend della Follia* - Weekend\n" +
		"> *Weekend della Fortuna* - Weekend\n" +
		"> *Miniere di Mana* - GiovedÃ¬/VenerdÃ¬ \n" +
		"> *Il Ricercato* - Weekend\n" +
		"> *Crafting Festival* - Weekend\n" +
		"> *Itinerario Propizio* - Weekend\n" +
		"> *Generatore di Polvere* - LunedÃ¬/MartedÃ¬\n" +
		"> *Villa di LastSoldier95* - 3-5 Giorni\n" +

		"\nGli eventi vengono modificati di volta in volta per essere migliorati, e non avvengono per forza in questo ordine!\n" +
		"Per partecipare compariranno gli appositi pulsanti nel menÃ¹.";

	bot.sendMessage(message.chat.id, text, back);
});

bot.onText(/festival/i, function(message) {

	if (eventFestival == 0){
		bot.sendMessage(message.chat.id, "Evento non disponibile!", back);
		return;
	}

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back);
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM event_crafting_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Entra nel festival"],["Torna al menu"]]
				}
			};

			var rKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Aggiorna festival"],["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO event_crafting_status (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "*Benvenuto nel Crafting Festival!*\nIn questo evento ogni 2 ore viene selezionato un oggetto da creare, e chi lo crea riceverÃ  un premio! Inoltre piÃ¹ volte l'oggetto viene creato, piÃ¹ salirÃ  il suo valore. Preparati a consumare fino all'ultimo pezzettino di legno del tuo zaino, buon crafting!", eventKb);
					return;
				});
			}else{
				connection.query('SELECT event_crafting_item.cnt, event_crafting_item.price, event_crafting_item.time, item.name, item.rarity FROM event_crafting_item, item WHERE item.id = event_crafting_item.item_id ORDER BY event_crafting_item.id DESC LIMIT 1', function(err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Non Ã¨ disponibile ancora nessun oggetto da creare", rKb);
					}else{
						var d = new Date(rows[0].time);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

						var plur = "e";
						if (rows[0].cnt == 1){
							plur = "a";
						}

						bot.sendMessage(message.chat.id, "L'oggetto da creare Ã¨:\n\n*" + rows[0].name + " (" + rows[0].rarity + ")* per *" + rows[0].price + " Â§*\n\nCreato " + rows[0].cnt + " volt" + plur + ", verrÃ  aggiornato alle *" + short_date + "*!", rKb);
					}
				});
			}
		});
	});
});

bot.onText(/Miniere di Mana|Raccolta/i, function(message) {
	if (eventMana == 0){
		bot.sendMessage(message.chat.id, "L'evento non Ã¨ disponibile oggi!", back);
		return;
	}

	var back2 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Sintesi"],["Torna al menu"]]
		}
	};

	connection.query('SELECT id, class, reborn, holiday, account_id, travel_id, cave_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back);
			return;
		}

		if (rows[0].cave_id != 0){
			bot.sendMessage(message.chat.id, "Non puoi raccogliere mana mentre sei in cava", back2);
			return;
		}
		if (rows[0].travel_id != 0){
			bot.sendMessage(message.chat.id, "Non puoi raccogliere mana mentre sei in viaggio", back2);
			return;
		}

		var player_id = rows[0].id;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		var mBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Torna alla Raccolta"],["Torna al menu"]]
			}
		};

		var mYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Si"],["Torna alla Raccolta"],["Torna al menu"]]
			}
		};
		var mYesNo2 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Si"],["Sintesi"],["Torna al menu"]]
			}
		};

		connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Inizia Raccolta"],["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO event_mana_status (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Ti sei iscritto alla comunitÃ  di estrattori di mana!\nQuesto evento Ã¨ l'unica possibilitÃ  di recuperare mana allo scopo di sintetizzare incantesimi, inizia a estrarre mana da una miniera e poi raccogli quando sei soddisfatto.", eventKb);
					return;
				});
			}else{
				if (rows[0].zone_id != 0){
					var time_start = new Date(rows[0].time_start);
					var time_creation = time_start.setHours(time_start.getHours());
					var now = new Date();
					var diff = Math.round(((now - time_creation)/1000)/60);	
					diff = Math.abs(diff);

					connection.query('SELECT * FROM event_mana_zone WHERE id = ' + rows[0].zone_id, function(err, rows, fields) {
						if (err) throw err;

						var rate = rows[0].rate;
						var name = rows[0].mana_name;
						var type = rows[0].type;
						var quantity = Math.floor(diff/60*rate);

						if ((class_id == 2) && (reborn > 1)){
							quantity += quantity*0.3;
						}
						if ((class_id == 3) && (type == 2) && (reborn > 1)){
							quantity += quantity*0.5;
						}
						if ((class_id == 3) && (type != 2) && (reborn > 1)){
							quantity -= quantity*0.2;
						}
						if ((class_id == 4) && (type == 3) && (reborn > 1)){
							quantity += quantity*0.5;
						}
						if ((class_id == 4) && (type != 3) && (reborn > 1)){
							quantity -= quantity*0.2;
						}
						if ((class_id == 5) && (type == 1) && (reborn > 1)){
							quantity += quantity*1;
						}
						if ((class_id == 5) && (type != 1) && (reborn > 1)){
							quantity -= quantity*0.1;
						}
						if ((class_id == 6) && (reborn > 1)){
							quantity -= quantity*0.1;
						}

						connection.query('SELECT mana.name, chat_id, nickname, player_id, rate, type, ROUND(TIMESTAMPDIFF(MINUTE,time_start,NOW())/60*rate,0) As quantity FROM event_mana_status, event_mana_zone, player, mana WHERE mana.id = event_mana_zone.type AND player.id = player_id AND event_mana_status.time_start IS NOT NULL AND event_mana_status.zone_id = event_mana_zone.id AND player.id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;

							//console.log(quantity + " - " + rows[0].quantity);

							//quantity = rows[0].quantity;
							quantity = Math.floor(quantity);

							bot.sendMessage(message.chat.id, 	"Attualmente stai estraendo da una miniera, vuoi interrompere e ottenere " + quantity + " Mana " + name + "?", mYesNo2).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text.toLowerCase() == "si"){
										connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;

											if (rows[0].zone_id == 0){
												bot.sendMessage(message.chat.id, "Attualmente non stai estraendo", mBack);
												return;
											}

											var mana_type = 'mana_' + type;
											connection.query('UPDATE event_mana_status SET ' + mana_type + ' = ' + mana_type + ' + ' + quantity + ', zone_id = 0, time_start = NULL WHERE player_id = ' + player_id, function (err, rows, fields){
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai ricevuto " + quantity + " Mana " + name + "!", mBack);
											});
										});
									}
								};
							});
						});
					});

					return;
				}

				var text = 	"Blu: " + rows[0].mana_1 + "\n" +
					"Giallo: " + rows[0].mana_2 + "\n" +
					"Rosso: " + rows[0].mana_3;

				connection.query('SELECT * FROM event_mana_zone', function(err, rows, fields) {
					if (err) throw err;

					var iKeys = [];
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						iKeys.push([rows[i].name + " (" + rows[i].mana_name + " " + rows[i].rate + "/ora)"]);
					}

					iKeys.push(["Sintesi"]);
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona la miniera dalla quale iniziare a estrarre mana.\nAl momento possiedi:\n" + text + "\nAvrai possibilitÃ  di estrarre ogni giovedÃ¬ e venerdÃ¬ della settimana", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if ((answer.text == "Torna al menu") || (answer.text == "Sintesi")){
								return;
							}

							var zone = answer.text.substring(0, answer.text.indexOf("(")-1);

							connection.query('SELECT * FROM event_mana_zone WHERE name = "' + zone + '"', function(err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "Miniera non valida", mBack);
									return;
								}

								var zone_id = rows[0].id;

								bot.sendMessage(message.chat.id, "Iniziare l'estrazione nella " + zone + "?", mYesNo).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {
										if (answer.text.toLowerCase() == "si"){

											var d = new Date();
											if ((d.getDay() != 4) && (d.getDay() != 5)){
												bot.sendMessage(message.chat.id, "Non puoi estrarre oggi", back);
												return;
											}

											var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

											connection.query('UPDATE event_mana_status SET time_start = "' + long_date + '", zone_id = ' + zone_id + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Estrazione iniziata, torna qui tra qualche ora per concluderla e ricevere ciÃ² che hai estratto", mBack);
											});
										}
									};
								});
							});
						};
					});
				});
			}
		});
	});
});

bot.onText(/Generatore di Polvere/i, function(message) {

	/*
	if (message.from.username != "fenix45"){
		bot.sendMessage(message.chat.id, "Il Generatore Ã¨ quasi pronto ðŸ”¥", back);
		return;
	}
	*/

	if (eventDust == 0){
		bot.sendMessage(message.chat.id, "L'evento non Ã¨ disponibile oggi!", back);
		return;
	}

	connection.query('SELECT id, class, reborn, holiday, account_id, travel_id, cave_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back);
			return;
		}

		if (rows[0].cave_id != 0){
			bot.sendMessage(message.chat.id, "Non puoi raccogliere polvere mentre sei in cava", back);
			return;
		}
		if (rows[0].travel_id != 0){
			bot.sendMessage(message.chat.id, "Non puoi raccogliere polvere mentre sei in viaggio", back);
			return;
		}

		var player_id = rows[0].id;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		var gBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Torna al Generatore di Polvere"],["Torna al menu"]]
			}
		};

		var gYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Si"],["Torna al Generatore di Polvere"]]
			}
		};

		var eventKb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Vai al Generatore di Polvere"],["Torna al menu"]]
			}
		};

		var eventKb2 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Aziona Generatore"],["Aumenta Deposito","Utilizza Polvere"],["Scaglia Evolutiva"],["Torna al menu"]]
			}
		};

		var eventKb3 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Ritira","Spegni"],["Torna al menu"]]
			}
		};

		connection.query('SELECT * FROM event_dust_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO event_dust_status (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai ricevuto il tuo Generatore di Polvere!\nPotrai utilizzare la polvere prodotta per generare un oggetto a tua scelta, Ã¨ disponibile ogni lunedÃ¬ e martedÃ¬!", eventKb);
					return;
				});
			}else{
				var max_qnt = parseInt(rows[0].max_qnt);
				var qnt = parseInt(rows[0].qnt);

				if (rows[0].extracting == 1){
					var generated = rows[0].generated;
					var updateTime = rows[0].last_update;
					bot.sendMessage(message.chat.id, "Hai generato fin ora " + generated + "/" + max_qnt + " unitÃ  di polvere, vuoi spegnere il generatore o ritirarla?\n\nUltima attivitÃ : " + toDate("it",updateTime), eventKb3).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text == "Torna al menu"){
								return;
							}
							if (answer.text == "Ritira"){
								connection.query('SELECT generated FROM event_dust_status WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									for (var i = 0, len = rows[0].generated; i < len; i++) {
										connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',646)', function(err, rows, fields) {
											if (err) throw err;
										});
									}
									var d = new Date();
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
									connection.query('UPDATE event_dust_status SET generated = 0, notified = 0, last_update = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});
									bot.sendMessage(message.chat.id, "Hai ottenuto " + rows[0].generated + "x Polvere!", gBack);
								});
							}else if (answer.text == "Spegni"){
								connection.query('UPDATE event_dust_status SET extracting = 0, last_update = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Hai spento il generatore", gBack);
								});
							}
						};
					});
				}else{
					connection.query('SELECT COUNT(id) As qnt FROM inventory WHERE item_id = 646 AND player_id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;

						var unit = rows[0].qnt;

						bot.sendMessage(message.chat.id, "*Gestione Generatore*\n\nProdurrai " + qnt + "x Polvere/ora e il deposito ti consente massimo " + max_qnt + " unitÃ \n" +
										"Al momento possiedi " + unit + " unitÃ  nello zaino", eventKb2).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Torna al menu"){
									return;
								}
								if (answer.text == "Aziona Generatore"){
									var d = new Date();
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
									connection.query('UPDATE event_dust_status SET extracting = 1, last_update = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Generatore azionato! Torna tra un po' di tempo per ritirare la polvere prodotta!", back);
									});
								}else if (answer.text == "Aumenta Deposito"){
									if (max_qnt >= 50){
										bot.sendMessage(message.chat.id, "Il deposito del generatore Ã¨ giÃ  potenziato al massimo", gBack);
										return;
									}

									bot.sendMessage(message.chat.id, "Aggiungere 2 unitÃ  al tuo deposito ti costerÃ  50.000 Â§, procedi?", gYesNo).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){
												connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													if (rows[0].money < 50000){
														bot.sendMessage(message.chat.id, "Non hai abbastanza monete", gBack);
														return;
													}
													connection.query('UPDATE player SET money = money-50000 WHERE id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
														connection.query('UPDATE event_dust_status SET max_qnt = max_qnt + 2 WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Hai potenziato il deposito e hai raggiunto " + (max_qnt+2) + " unitÃ  di spazio disponibile!", gBack);
														});
													});
												});
											}
										}
									});
								}else if (answer.text == "Utilizza Polvere"){
									connection.query('SELECT COUNT(id) As qnt FROM inventory WHERE item_id = 646 AND player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;

										if (rows[0].qnt == 0){
											bot.sendMessage(message.chat.id, "Non hai Polvere da utilizzare", gBack);
											return;
										}

										var rar1 = 22;
										var rar2 = 45;
										var rar3 = 55;
										var rar4 = 65;

										bot.sendMessage(message.chat.id, "Puoi creare un oggetto utilizzando la Polvere (ad esclusione degli equipaggiamenti):\n" +
														"Raro -> " + rar1 + "\n" +
														"Ultra Raro -> " + rar2 + "\n" +
														"Leggendario -> " + rar3 + "\n" +
														"Epico -> " + rar4 + "\n" +
														"Se l'oggetto Ã¨ craftato, richiederÃ  il *doppio* della polvere + una quantitÃ  dipendente dal valore\n\n" +
														"Inserisci il nome dell'oggetto, al momento c'Ã¨ una piccolissima probabilitÃ  di fallimento nella creazione.", gBack).then(function() {
											answerCallbacks[message.chat.id] = function(answer) {
												if (answer.text.indexOf("Torna al") != -1){
													return;
												}
												connection.query('SELECT id, estimate, craftable, rarity, name FROM item WHERE rarity IN ("R","UR","L","E") AND power = 0 AND power_shield = 0 AND power_armor = 0 AND dragon_power = 0 AND name = "' + answer.text + '"', function(err, rows, fields) {
													if (err) throw err;
													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "L'oggetto non esiste o la raritÃ  non Ã¨ consentita", gBack);
														return;
													}
													var itemId = rows[0].id;
													var itemName = rows[0].name;
													var rarity = rows[0].rarity;
													var craft = rows[0].craftable;
													var estimate = rows[0].estimate;

													var nec = 0;

													if (rarity == "R"){
														nec = rar1;
													}else if (rarity == "UR"){
														nec = rar2;
													}else if (rarity == "L"){
														nec = rar3;
													}else if (rarity == "E"){
														nec = rar4;
													}
													if (craft == 1){
														nec = nec*2;
														nec += Math.round(estimate/10000);
													}

													bot.sendMessage(message.chat.id, "Sicuro di voler generare l'oggetto *" + itemName + "* (" + rarity + ")?\nTi costerÃ  *" + nec + "* unitÃ  di Polvere", gYesNo).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {
															if (answer.text.toLowerCase() == "si"){
																connection.query('SELECT COUNT(id) As qnt FROM inventory WHERE item_id = 646 AND player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;

																	if (rows[0].qnt < nec){
																		bot.sendMessage(message.chat.id, "Non hai abbastanza Polvere per generare questo oggetto, " + rows[0].qnt + "/" + nec, gBack);
																		return;
																	}

																	var rand = Math.random()*100;

																	if (rand > 5){
																		connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 646 LIMIT ' + nec, function(err, rows, fields) {
																			if (err) throw err;
																			connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + itemId + ')', function(err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(message.chat.id, "L'oggetto " + itemName + " (" + rarity + ") Ã¨ stato generato con successo!", gBack);
																			});
																		});
																		console.log("Oggetto generato: " + itemName + " per " + message.from.username);
																		setAchievement(message.chat.id, player_id, 48, 1);
																	}else{
																		connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 646 LIMIT ' + nec, function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Dannazione! La generazione Ã¨ fallita e hai perso la polvere necessaria, che sfortuna!", gBack);
																		});
																		console.log("Oggetto generato fallito per " + message.from.username);
																	}
																});
															};
														};
													});
												});
											}
										});
									});
								}else if (answer.text == "Scaglia Evolutiva"){
									if (reborn < 4){
										bot.sendMessage(message.chat.id, "Devi essere almeno Rinascita 3 per creare questo oggetto", gBack);
										return;
									}
									bot.sendMessage(message.chat.id, "Per creare questo particolare oggetto, *estremamente raro* ti servirÃ :\n> 200 Polvere\n> 5000 Mana per tipo\nProcedi?",gYesNo).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){									
												connection.query('SELECT COUNT(id) As qnt FROM inventory WHERE item_id = 646 AND player_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;

													if (rows[0].qnt < 200){
														bot.sendMessage(message.chat.id, "Non hai abbastanza Polvere", gBack);
														return;
													}
													connection.query('SELECT mana_1, mana_2, mana_3 FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;

														if ((rows[0].mana_1 < 5000) || (rows[0].mana_1 < 5000) || (rows[0].mana_1 < 5000)){
															bot.sendMessage(message.chat.id, "Non hai abbastanza Mana", gBack);
															return;
														}

														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 646 LIMIT 200', function(err, rows, fields) {
															if (err) throw err;
															connection.query('UPDATE event_mana_status SET mana_1 = mana_1 - 5000, mana_2 = mana_2 - 5000, mana_3 = mana_3 - 5000 WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ', 649)', function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Dalle Polveri e dal potere Magico, si innalza un oggetto curioso: Ã¨ una *Scaglia Evolutiva*!", gBack);
																});
															});
														});
													});	
												});
											}
										}
									});
								}
							};
						});
					});
				}
			}
		});
	});
});

bot.onText(/^Sintesi|Torna alla Sintesi/i, function(message) {
	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;	

		connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi alcuna riserva di mana", back)
				return;
			}

			var mana_1 = rows[0].mana_1;
			var mana_2 = rows[0].mana_2;
			var mana_3 = rows[0].mana_3;

			var text = 	"Blu: " + mana_1 + "\n" +
				"Giallo: " + mana_2 + "\n" +
				"Rosso: " + mana_3;

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Inizia Sintesi"],["Sintetizza Materiali Finali"],["Torna al menu"]]
				}
			};

			var kbBack = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna alla Sintesi"],["Torna al menu"]]
				}
			};

			var kbYesNo = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Si"],["Torna alla Sintesi"]]
				}
			};

			var kb2 = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["0","10","20"],["50","100","200"],["Annulla"]]
				}
			};

			connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 13', function(err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				if (Object.keys(rows).length > 0){
					abBonus = rows[0].ability_level*10;
				}
				var maxUnit = 200;
				maxUnit += abBonus;

				bot.sendMessage(message.chat.id, "*Le tue riserve di mana:*\n\n" + text, kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text == "Torna al menu"){
							return;
						}

						if (answer.text == "Sintetizza Materiali Finali"){
							connection.query('SELECT name FROM item WHERE id IN (623, 624, 625, 635, 636, 637)', function (err, rows, fields){
								if (err) throw err;

								var iKeys = [];

								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									iKeys.push([rows[i].name]);
								}

								iKeys.push(["Torna alla Sintesi"]);
								var kb_f = {
									parse_mode: "Markdown",
									reply_markup: {
										resize_keyboard: true,
										one_time_keyboard: true,
										"keyboard": iKeys
									}
								};
								bot.sendMessage(message.chat.id, "Questa sezione Ã¨ riservata alla sintesi dei componenti finali per le armi, seleziona il componente da sintetizzare", kb_f).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {
										if (answer.text == "Torna alla Sintesi"){
											return;
										}
										connection.query('SELECT name, id, value FROM item WHERE id IN (623, 624, 625, 635, 636, 637) AND name = "' + answer.text + '"', function (err, rows, fields){
											if (err) throw err;
											if (Object.keys(rows).length > 0){
												var qnt = 0;
												var type = 0;
												var itemId = rows[0].id;
												var itemName = rows[0].name;
												var name = "";
												if (rows[0].value == 25000){
													qnt = 2500;
												}else if (rows[0].value == 100000){
													qnt = 5000;
												}
												if ((rows[0].id == 623) || (rows[0].id == 635)){
													type = 2;
													name = "Giallo";
												}else if ((rows[0].id == 624) || (rows[0].id == 636)){
													type = 3;
													name = "Rosso";
												}else if ((rows[0].id == 625) || (rows[0].id == 637)){
													type = 1;
													name = "Blu";
												}else{
													bot.sendMessage(message.chat.id, "Errore", kbBack);
													return;
												}
												bot.sendMessage(message.chat.id, "Sintetizzare questo oggetto richiederÃ  " + qnt + " Mana " + name + ", continuare?", kbYesNo).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text.toLowerCase() == "si"){
															if (type == 1){
																if (mana_1 < qnt){
																	bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Blu", kbBack);
																	return;
																}
															}else if (type == 2){
																if (mana_2 < qnt){
																	bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Giallo", kbBack);
																	return;
																}
															}else if (type == 3){
																if (mana_3 < qnt){
																	bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Rosso", kbBack);
																	return;
																}
															}

															connection.query('UPDATE event_mana_status SET mana_' + type + ' = mana_' + type + ' - ' + qnt + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + itemId + ')', function (err, rows, fields){
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai sintetizzato " + itemName + "!", kbBack);
																});
															});
														}
													}
												});
											}else{
												bot.sendMessage(message.chat.id, "Oggetto non valido", kbBack);
											}
										});
									}
								});
							});
							return;
						}

						bot.sendMessage(message.chat.id, 	"Puoi sintetizzare un incantesimo utilizzando qualsiasi quantitÃ  di mana per tipo, per un massimo di " + maxUnit + " unitÃ  complessive, piÃ¹ Ã¨ alto il valore, piÃ¹ sarÃ  efficace l'incantesimo\n" +
										"Ogni incantesimo ha una durata pari a 3 utilizzi, indipendentemente dalla sua potenza, puoi possedere solamente 5 incantesimi contemporaneamente\n" +
										"Quanto Mana Blu vuoi utilizzare? Ne possiedi *" + mana_1 + "* unitÃ , puoi anche scrivere il numero manualmente", kb2).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Annulla"){
									return;
								}

								connection.query('SELECT COUNT(*) As cnt FROM magic WHERE player_id = ' + player_id, function (err, rows, fields){
									if (err) throw err;

									if (rows[0].cnt >= 5){
										bot.sendMessage(message.chat.id, "Non puoi sintetizzare altre magie prima di averle consumate", kbBack);
										return;
									}

									var m1 = parseInt(answer.text);
									if ( (isNaN(m1)) || (m1 < 0) || (re.test(m1) == false)){
										bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbBack);
										return;
									}

									if (m1 > mana_1){
										bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", kbBack);
										return;
									}

									bot.sendMessage(message.chat.id, "Quanto Mana Giallo vuoi utilizzare? Ne possiedi *" + mana_2 + "* unitÃ , puoi anche scrivere il numero manualmente", kb2).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text == "Annulla"){
												return;
											}
											var m2 = parseInt(answer.text);
											if (isNaN(m2) || (m2 < 0) || (re.test(m2) == false)){
												bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbBack);
												return;
											}

											if (m2 > mana_2){
												bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", kbBack);
												return;
											}

											bot.sendMessage(message.chat.id, "Quanto Mana Rosso vuoi utilizzare? Ne possiedi *" + mana_3 + "* unitÃ , puoi anche scrivere il numero manualmente", kb2).then(function() {
												answerCallbacks[message.chat.id] = function(answer) {
													if (answer.text == "Annulla"){
														return;
													}
													var m3 = parseInt(answer.text);
													if (isNaN(m3) || (m3 < 0) || (re.test(m3) == false)){
														bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbBack);
														return;
													}

													if (m3 > mana_3){
														bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", kbBack);
														return;
													}

													bot.sendMessage(message.chat.id, "Iniziare la sintesi utilizzando le unitÃ  selezionate?", yesno).then(function() {
														answerCallbacks[message.chat.id] = function(answer) {

															if (answer.text.toLowerCase() == "si"){
																connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;

																	if (m1 > rows[0].mana_1){
																		bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Blu", kbBack);
																		return;
																	}
																	if (m2 > rows[0].mana_2){
																		bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Giallo", kbBack);
																		return;
																	}
																	if (m3 > rows[0].mana_3){
																		bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Rosso", kbBack);
																		return;
																	}

																	m1 = parseInt(m1);
																	m2 = parseInt(m2);
																	m3 = parseInt(m3);
																	var power = m1+m2+m3;

																	if (power > maxUnit){
																		bot.sendMessage(message.chat.id, "Il valore complessivo di Mana non puÃ² superare i " + maxUnit + " punti, ora Ã¨ pari a " + power, kbBack);
																		return;
																	}
																	if (power < 50){
																		bot.sendMessage(message.chat.id, "Minimo 50 di potenza, ora " + power, kbBack);
																		return;
																	}


																	var type = 0;
																	var quantity = 3;
																	var magic_name = "";

																	if ((m1 == m2) && (m2 == m3) && (m1 == m3)){
																		type = 4;
																		magic_name = "Ira Astrale";
																	}else if ((m1 >= m2) && (m1 >= m3)){
																		type = 1;
																		magic_name = "Furia dei Mari";
																	}else if ((m2 >= m1) && (m2 >= m3)){
																		type = 2;
																		magic_name = "Tempesta Folgorante";
																	}else if ((m3 >= m1) && (m3 >= m2)){
																		type = 3;
																		magic_name = "Impeto di Fiamme";
																	}else{
																		bot.sendMessage(message.chat.id, "Configurazione non valida, riprova", mBack);
																		return;
																	}

																	connection.query('UPDATE event_mana_status SET mana_1 = mana_1 - ' + m1 + ', mana_2 = mana_2 - ' + m2 + ', mana_3 = mana_3 - ' + m3 + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
																		if (err) throw err;

																		connection.query('INSERT INTO magic (player_id, type, power, quantity) VALUES (' + player_id + ',' + type + ',' + power + ',' + quantity + ')', function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai sintetizzato *" + magic_name + " " + power + "*!", kbBack);
																			setAchievement(message.chat.id, player_id, 28, 1);
																		});
																	});
																});
															};
														};
													});
												};
											});
										};
									});
								});
							};
						});
					};
				});
			});
		});
	});
});

bot.onText(/il gigante uruku|evento/i, function(message) {

	if (eventGiant == 0){
		//return
	}

	if (message.from.username != "fenix45"){
		return;
	}

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM event_giant_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Vai all'Evento"],["Torna al menu"]]
				}
			};

			var kb = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna al menu"]]
				}
			};

			var rBack = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna al Ricercato"],["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO event_giant_status (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Benvenuto nell'Arena del temibile *Gigante Uruku*!\nIn questa battaglia tutti dovranno unire le proprie forze per uccidere il gigante, quest'essere tiene delle sacche sui fianchi che una volta colpite rilasciano monete, oggetti, scrigni o oggetti spieciali, colpiscilo il piÃ¹ possibile per ottenerle!", eventKb);
				});
			}else{
				//...
			}
		});
	});
});

bot.onText(/ricercato|evento/i, function(message) {

	if (wanted == 0){
		return;
	}

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM event_wanted_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Vai all'Evento"],["Torna al menu"]]
				}
			};

			var kb = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna al menu"]]
				}
			};

			var rBack = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna al Ricercato"],["Torna al menu"]]
				}
			};

			var banned_join = banlist_id.join();

			if (Object.keys(rows).length == 0){
				connection.query('SELECT nickname, from_id, COUNT(from_id) FROM heist_history, player, event_wanted_status WHERE account_id NOT IN (' + banned_join + ') AND fail = 0 AND event_wanted_status.player_id = player.id AND player.id = heist_history.from_id AND player.id != ' + player_id + ' AND time between DATE_SUB(now(),INTERVAL 2 MONTH) AND NOW() GROUP BY from_id ORDER BY COUNT(from_id) DESC LIMIT 200', function(err, rows, fields) {
					if (err) throw err;

					var len = Object.keys(rows).length;
					var rand = Math.round(Math.random()*len);

					var sel = rows[rand].from_id;

					connection.query('INSERT INTO event_wanted_status (player_id, wanted_id) VALUES (' + player_id + ',' + sel + ')', function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Benvenuto nell'*Evento Ricercato*!\nTi Ã¨ stato assegnato un fuorilegge che dovrai stanare irrompendo nel suo rifugio, potrai ottenere grosse taglie in caso di successo, forza!\nAlla fine visualizzerai una classifica quindi cerca di vincerne il piÃ¹ possibile!\nLe ispezioni al ricercato sono molto veloci, in piÃ¹ solo in questo weekend i tempi generali di ispezione sono ridotti!", eventKb);
					});
				});
			}else{
				connection.query('SELECT E.wanted_id, E.heist_win, E.heist_lost, E.heist_win_2, E.heist_lost_2, player.nickname, player.id, player.ability, player.house_id FROM event_wanted_status E, player WHERE E.wanted_id = player.id AND E.player_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0){
						connection.query('SELECT nickname, from_id, COUNT(from_id) FROM heist_history, player, event_wanted_status WHERE account_id NOT IN (' + banned_join + ') AND fail = 0 AND event_wanted_status.player_id = player.id AND player.id = heist_history.from_id AND player.id != ' + player_id + ' AND time between DATE_SUB(now(),INTERVAL 2 MONTH) AND NOW() GROUP BY from_id ORDER BY COUNT(from_id) DESC LIMIT 200', function(err, rows, fields) {
							if (err) throw err;

							var len = Object.keys(rows).length;
							var rand = Math.round(Math.random()*len);

							var sel = rows[rand].from_id;
							connection.query('UPDATE event_wanted_status SET wanted_id = ' + sel + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Il tuo ricercato non Ã¨ ancora disponibile, torna tra qualche secondo!", back);
							});
						});
						return;
					}

					var win = rows[0].heist_win;
					var lost = rows[0].heist_lost;
					var win2 = rows[0].heist_win_2;
					var lost2 = rows[0].heist_lost_2;

					var nick = rows[0].nickname;
					var ab = rows[0].ability;
					var house = rows[0].house_id;

					connection.query('SELECT heist_win_2 FROM event_wanted_status WHERE player_id = ' + rows[0].wanted_id, function(err, rows, fields) {
						if (err) throw err;

						var value1 = ((parseInt(win2)*100)+1000);
						var value2 = ((parseInt(rows[0].heist_win_2)*100)+1000)
						if (value1 > 10000){
							value1 = 10000;
						}
						if (value2 > 10000){
							value2 = 10000;
						}

						var text = 	"<b>Il tuo status da ricercato</b>:\nVittorie/Sconfitte: " + win + " / " + lost + "\nSubite/Respinte: " + lost2 + " / " + win2 + "\nLa tua taglia: " +
							value1 + " Â§\n\n" +
							"ðŸ‘º Il ricercato Ã¨ <b>" + nick + "</b> con abilitÃ  " + ab + " ed un rifugio al livello " + house + "!\n" +
							"Ispeziona il suo rifugio per catturarlo e ottenere la taglia!\nTaglia attuale: " + value2 + " Â§";
						var kb2 = {
							parse_mode: "HTML",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": [["Ispeziona: " + nick],["I piÃ¹ pericolosi"],["Torna al menu"]]
							}
						};
						bot.sendMessage(message.chat.id, text, kb2).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text.toLowerCase().indexOf("pericolosi") != -1){
									connection.query('SELECT nickname, event_wanted_status.heist_win FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_win DESC LIMIT 5', function(err, rows, fields) {
										if (err) throw err;
										var text = "Utenti che hanno catturato piÃ¹ ricercati:\n";
										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											text += "> " + rows[i].nickname + " (" + rows[i].heist_win + ")	\n";
										};
										connection.query('SELECT nickname, event_wanted_status.heist_lost FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_lost DESC LIMIT 5', function(err, rows, fields) {
											if (err) throw err;
											text += "\nUtenti che hanno fallito piÃ¹ volte:\n";
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												text += "> " + rows[i].nickname + " (" + rows[i].heist_lost + ") \n";
											};

											connection.query('SELECT nickname, event_wanted_status.heist_win_2 FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_win_2 DESC LIMIT 5', function(err, rows, fields) {
												if (err) throw err;
												text += "\nUtenti che hanno subito e vinto piÃ¹ tentativi:\n";
												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													text += "> " + rows[i].nickname + " (" + rows[i].heist_win_2 + ") \n";
												};					
												connection.query('SELECT nickname, event_wanted_status.heist_lost_2 FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_lost_2 DESC LIMIT 5', function(err, rows, fields) {
													if (err) throw err;
													text += "\nUtenti che hanno subito e perso piÃ¹ tentativi:\n";
													for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
														text += "> " + rows[i].nickname + " (" + rows[i].heist_lost_2 + ") \n";
													};					
													bot.sendMessage(message.chat.id, text, rBack);
												});
											});
										});	
									});
								}
							};
						});
					});
				});
			}
		});
	});
});

bot.onText(/Il Tesoro di Arthur|Evento/i, function(message) {

	return;
	if (eventStory == 0){
		if (message.from.username != "fenix45"){
			bot.sendMessage(message.chat.id, "L'evento sarÃ  disponibile a breve!", back);
			return;
		}
	}

	connection.query('SELECT id, holiday, account_id, mission_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = rows[0].account_id.toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM mission_event_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Vai all'Evento"],["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0){
				// Prima volta

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Iscriviti al Registro"],["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Benvenuto nella Storia Interattiva!\nQuesto evento Ã¨ composto da missioni che sono collegate fra di loro con scelte che dovrai intraprendere, a seconda del percorso comporrai una storia diversa e arriverai ad un finale diverso, con un premio diverso.\n\nTuttavia Ã¨ possibile completare il percorso solamente una volta, e l'evento ha una durata limitata. Quando vuoi iniziare clicca sul pulsante Iscriviti al Registro. Buon divertimento!\n\n_Questo evento Ã¨ il primo di due parti_", kb);
			}else{
				if (rows[0].mission_end != null){
					var d = new Date(rows[0].mission_end);
					var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
					bot.sendMessage(message.chat.id, "Stai svolgendo una missione dell'evento fino alle " + short_date, back);
					return;
				}

				var choice_id = rows[0].choice_id;
				var mission_time = rows[0].mission_time;
				var mission_id = rows[0].mission_id;
				var flag = rows[0].flag;

				var pos = rows[0].pos;
				var neg = rows[0].neg;

				var event_end = rows[0].event_end;
				var var_end = rows[0].var_end;

				if (event_end == 0){
					if (choice_id >= 200){
						bot.sendMessage(message.chat.id, "Riscattare la ricompensa?", yesno).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text.toLowerCase() == "si"){

									var text = "";
									var chest = 0;
									var num = 0;
									var end_exp = 0;

									if ((pos != 0) && (neg != 0)){
										if (pos > neg){
											if (pos < 5){
												num = 5;
												end_exp = 10;
											}else if (pos <= 10){
												num = 7;
												end_exp = 10;
											}else if (pos > 10){
												epic = 10;
												end_exp = 10;
											}
										}else{
											if (neg < 5){
												num = 3;
												end_exp = 15;
											}else if (pos <= 10){
												num = 5;
												end_exp = 25;
											}else if (pos > 10){
												num = 7;
												end_exp = 40;
											}
										}
										chest = 6;
										text = "Hai ricevuto *" + num + " Scrigni Epici* e *" + end_exp + " exp*!";
									}else{
										if (var_end != 1){
											if (var_end == 6){
												text = "Purtroppo ti hanno distrutto il solo modo per trovare il tesoro e non hai ottenuto ricompense.";
											}
											if (var_end == 8){
												chest = 4;
												num = 3;
												text = "Ricevi 3 Scrigni di Diamante!";
											}
											if ((var_end == 11) || (var_end == 13) || (var_end == 14)){
												chest = 5;
												num = 3;
												text = "Ti restano soltanto gli scrigni che hai in soffitta, ottieni quindi 3 Scrigni Leggendari!";
											}
											if (var_end == 25){
												chest = 6;
												num = 3;
												text = "All'interno della stanza trovi 3 Scrigni Epici!";
											}
											if (var_end == 26){
												connection.query('UPDATE player SET life = total_life*0.1 WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
												text = "Fortunatamente non sei morto, ma torni al tuo rifugio con il 10% dei tuoi hp.";
											}
										}	
									}

									for (var i = 0; i < num; i++) {
										connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES(' + player_id + ',' + chest + ')', function(err, rows, fields) {
											if (err) throw err;
										});
									}
									connection.query('UPDATE mission_event_status SET event_end = 1 WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});
									connection.query('UPDATE player SET exp = exp + ' + end_exp + ' WHERE id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});
									connection.query('SELECT COUNT(*) As num FROM `mission_event_status` WHERE event_end = 1', function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Evento completato!\n*" + text + "*\nUn enorme grazie per aver partecipato!\nSei l'utente numero " + rows[0].num + " ad aver completato l'evento.\nSi ringrazia @AlexCortinovis per aver ideato la storia e mi raccomando, se avete idee proponetele e magari la prossima storia sarÃ  ideata da voi!\nCi vediamo al prossimo!", back);
									});
								}
							}
						});
						return;
					}
				}else if (event_end == 1){
					bot.sendMessage(message.chat.id, "Hai giÃ  riscattato le ricompense dell'evento!", back);
					return;
				}

				connection.query('SELECT * FROM mission_event_choice WHERE id = ' + choice_id, function(err, rows, fields) {
					if (err) throw err;
					console.log("Scelta: " + choice_id);

					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Si Ã¨ verificato un errore, contatta l'admin indicando questo codice: " + choice_id + "!", back);
						return;
					}

					var text = rows[0].text;
					text = text.replace(new RegExp("%player%", "g"), message.from.username.replace(new RegExp("_", "g"), " "));

					var var1 = "";
					var var2 = "";
					var var3 = "";

					if ((rows[0].text1 == undefined) || (rows[0].text1 == "")){
						rows[0].text1 = "1. Favoloso!";
						rows[0].text2 = "2. CosÃ¬ cosÃ¬";
						rows[0].text3 = "3. Non mi Ã¨ piaciuto";

						connection.query('UPDATE mission_event_status SET choice_id = 200, var_end = ' + choice_id + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});

						text += "\n\nLascia un voto, e procedi per ottenere la tua ricompensa!";
					}

					var c1 = rows[0].text1;
					var c2 = rows[0].text2;
					var c3 = rows[0].text3;

					var eventChoice = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [[c1],[c2],[c3],["Torna al menu"]]
						}
					};

					// RIMUOVERE NEI PROSSIMI EVENTI!

					if ((choice_id == 9) && (flag == 0)){
						connection.query('UPDATE player SET money = money-10000 WHERE id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});
						connection.query('UPDATE mission_event_status SET flag = 1 WHERE player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});
					}

					bot.sendMessage(message.chat.id, text, eventChoice);
				});
			}
		});
	});	
});

bot.onText(/^Iscriviti al Registro$/i, function(message) {

	if (eventStory == 0){
		if ((message.from.username != "fenix45") && (message.from.username != "LastSoldier95")){
			return;
		}
	}

	var eventKb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Vai all'evento"],["Torna al menu"]]
		}
	};

	connection.query('SELECT mission_id, id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		connection.query('SELECT * FROM mission_event_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO mission_event_status (player_id,choice_id,mission_end) VALUES (' + player_id + ',1,NULL)', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Sei stato aggiunto al registro eventi!", eventKb);
					return;
				});
			}else{
				bot.sendMessage(message.chat.id, "Sei giÃ  stato aggiunto al registro eventi!", eventKb);
			}
		});
	});
});

bot.onText(/[1-9][.] [a-z1-9\s]+/i, function(message) {

	if (eventStory == 0){
		if ((message.from.username != "fenix45") && (message.from.username != "LastSoldier95")){
			return;
		}
	}

	var num = parseInt(message.text.charAt(0));
	var choice = message.text.substring(message.text.indexOf(" ")+1, message.text.lenght);

	connection.query('SELECT id, mission_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		connection.query('SELECT * FROM mission_event_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non ti sei ancora iscritto al registro eventi!", back);
				return;
			}
			var choice_id = rows[0].choice_id;
			var epic = 0;
			var event_end = rows[0].event_end;

			console.log("choice_id = " + choice_id);

			if (event_end == 0){
				if (choice_id >= 200){
					var eventKb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Riscatta ricompensa evento"],["Torna al menu"]]
						}
					};

					connection.query('UPDATE mission_event_status SET vote = "' + choice + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
					});

					bot.sendMessage(message.chat.id, "Evento completato! Torna all'evento per ricevere la ricompensa!", eventKb);
					return;
				}
			}else if (event_end == 1){
				bot.sendMessage(message.chat.id, "Hai giÃ  riscattato le ricompense dell'evento!", back);
				return;
			}

			connection.query('SELECT * FROM mission_event_choice WHERE id = ' + choice_id + ' AND (text1 LIKE "%' + choice + '" OR text2 LIKE "%' + choice + '" OR text3 LIKE "%' + choice + '")', function(err, rows, fields) {
				if (err) throw err;
				console.log("Scelta: " + num);

				var nextMission = 0;

				if (Object.keys(rows).length > 0){
					if (num == 1){
						nextMission = rows[0].to_mission1;
					}else if (num == 2){
						nextMission = rows[0].to_mission2;
					}else if (num == 3){
						nextMission = rows[0].to_mission3;
					}else{
						bot.sendMessage(message.chat.id, "Errore, la corrispondenza della scelta non Ã¨ stata trovata", back);
						return;
					}

					connection.query('SELECT * FROM mission_event_text WHERE id = ' + nextMission, function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0){
							var text = "*" + rows[0].title + "*\n";
							text += rows[0].text + "\n";
							text += "Questa parte di storia durerÃ  *" + toTime(rows[0].duration) + "*";

							var d = new Date();
							d.setSeconds(d.getSeconds() + rows[0].duration);
							var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

							var pos = rows[0].pos;
							var neg = rows[0].neg;

							connection.query('UPDATE mission_event_status SET pos = pos + ' + pos + ', neg = neg + ' + neg + ', mission_id = ' + rows[0].id + ', mission_end = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, text, back);
							});
						}
					});
				}else{
					bot.sendMessage(message.chat.id, "Scelta non valida", back);
					return;
				}
			});
		});
	});
});

function randomChest(){
	var rand = Math.round((Math.random()*100)+1);

	var chest1 = 100;
	var chest2 = 70;
	var chest3 = 50;
	var chest4 = 20;
	var chest5 = 10;
	var chest6 = 3;

	if (rand <= chest6){
		var rarity = 6;
	}else if (rand <= chest5){
		var rarity = 5;
	}else if (rand <= chest4){
		var rarity = 4;
	}else if (rand <= chest3){
		var rarity = 3;
	}else if (rand <= chest2){
		var rarity = 2;
	}else if (rand <= chest1){
		var rarity = 1;
	}

	return rarity;
}

bot.onText(/mercato/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].market_ban == 1){
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		helpMsg(message.chat.id, rows[0].id, 7);

		var iKeys = [];

		iKeys.push(["Cronologia","Regala un oggetto"]);
		iKeys.push(["Offerte Giornaliere"]);
		iKeys.push(["Torna al menu"]);

		var kb = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": iKeys
			}
		};

		bot.sendMessage(message.chat.id,"Benvenuto nel mercato, cosa vorresti fare?\n" +
						"Entra nel gruppo <a href='https://t.me/joinchat/AAAAAD90ErjYnm3AMk5QLw'>Mercato</a> per commerciare liberamente con gli altri utenti!", kb);
	});
});

bot.onText(/Offerte Giornaliere|Mercante$/i, function(message) {

	var price_drop = 0;
	var price_drop_msg = "";
	var n = new Date().getDay()
	var n2 = new Date().getDate();

	if (n == 0){
		if (n2 < 10){
			sconto = 20;
		}
		price_drop = 1;
		price_drop_msg = "*Oggi il prezzo Ã¨ ridotto del " + sconto + "%!*\n";
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;		

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}
		if (rows[0].market_ban == 1){
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		var player_id = rows[0].id;

		if (rows[0].market_pack == 1){
			bot.sendMessage(message.chat.id, "Oggi hai giÃ  acquistato un pacchetto, torna domani", back);
			return;
		}

		connection.query('SELECT rarity.name, SUM(price) As tot FROM market_pack, rarity WHERE market_pack.pack_id = rarity.id GROUP BY pack_id', function(err, rows, fields) {
			if (err) throw err;

			var iKeys = [];
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push(["Pacchetto " + rows[i].name + " (" + formatNumber(rows[i].tot) + " Â§)"]);
			}
			iKeys.push(["Torna al menu"]);

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			bot.sendMessage(message.chat.id, price_drop_msg + "Il *Mercante Pazzo* oggi offre alcuni pacchetti dall'aspetto interessante, selezionali per vedere il loro contenuto, ma attenzione, puoi acquistare solamente un pacchetto al giorno!", kb).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "Torna al menu"){
						return;
					}
					var reg3 = /Pacchetto (.+) \(/i;
					var rarity = answer.text.match(reg3);

					if (rarity[1] == undefined){
						return;
					}
					connection.query('SELECT pack_id, SUM(price) As tot FROM market_pack, rarity WHERE market_pack.pack_id = rarity.id AND rarity.name = "' + rarity[1] + '"', function(err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0){
							bot.sendMessage(message.chat.id, "Pacchetto non valido", back);
							return;
						}
						if (rows[0].tot == null){
							bot.sendMessage(message.chat.id, "Pacchetto non valido", back);
							return;
						}

						var pack_id = rows[0].pack_id;
						var price = rows[0].tot;

						connection.query('SELECT pack_id, item.name, item.id, price FROM market_pack, item WHERE market_pack.item_id = item.id AND pack_id = ' + pack_id, function(err, rows, fields) {
							if (err) throw err;
							var text = "Oggetti contenuti nel pacchetto:\n";
							var items = [];
							var prices = [];
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								text += "> " + rows[i].name + "\n";
								items.push(rows[i].id);
								if (price_drop == 1){
									prices.push(Math.round(rows[i].price-(rows[i].price/100*sconto)));
								}else{
									prices.push(rows[i].price);
								}
							}
							if (price_drop == 1){
								price = Math.round(price-(price/100*sconto));
							}
							text += "\nAl prezzo di: *" + formatNumber(price) + "* Â§";

							var kb2 = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									one_time_keyboard: true,
									"keyboard": [["Accetta"],["Torna dal mercante"],["Torna al menu"]]
								}
							};
							bot.sendMessage(message.chat.id, text + "\n\nAcquisti il pacchetto?", kb2).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Accetta"){
										connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
											if (rows[0].money < price){
												bot.sendMessage(message.chat.id, "Non hai abbatanza monete!", back);
												return;
											}
											connection.query('UPDATE player SET market_pack = 1, money = money - ' + price + ' WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												var d = new Date();
												var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
												for (var i = 0, len = Object.keys(items).length; i < len; i++) {
													connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + items[i] + ')', function(err, rows, fields) {
														if (err) throw err;
													});
													connection.query('INSERT INTO market_direct_history (item_id, price, time, from_id, to_id, buyer, type) VALUES (' + items[i] + ',' + prices[i] + ',"' + long_date + '",' + player_id + ',0,"Pacchetto",4)', function(err, rows, fields) {
														if (err) throw err;
													});
												}
												bot.sendMessage(message.chat.id, "Acquisto pacchetto *" + rarity[1] + "* completato! Hai speso *" + price + "* Â§!", back);
												//console.log("Pacchetto acquistato");
												setAchievement(message.chat.id, player_id, 45, 1);
											});
										});
									}
								}
							});
						});
					});
				};
			});
		});
	});	
});

bot.onText(/Regala un oggetto$/, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}
		if (rows[0].market_ban == 1){
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM market_gift WHERE player_id = ' + player_id + ' ORDER BY time DESC', function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length > 0){
				var d = new Date(rows[0].time);
				var now = new Date();
				var diff = Math.round(((now - d)/1000)/60/60);	//in ore
				diff = Math.abs(diff);

				console.log(diff);
				if (diff < 24*3){
					d.setDate(d.getDate() + 3);
					var long_date = addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear() + " alle " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

					bot.sendMessage(message.chat.id, "Prima di regalare ancora devi aspettare fino al " + long_date, back);
					return;
				}	
			}

			bot.sendMessage(message.chat.id, "Inserisci il nickname del giocatore al quale regalare l'oggetto, puoi farlo solamente una volta ogni 3 giorni", back).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "Torna al menu"){
						return;
					}

					var user = answer.text.replace("@","").trim();

					connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + user + '"', function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length == 0){
							bot.sendMessage(message.chat.id, "Il giocatore specificato non esiste", back);
							return;
						}
						var player_id2 = rows[0].id;
						var chat_id2 = rows[0].chat_id;

						bot.sendMessage(message.chat.id, "Inserisci il nome dell'oggetto", back).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Torna al menu"){
									return;
								}
								var itemName = answer.text;
								connection.query('SELECT id, name, allow_sell FROM item WHERE name = "' + itemName + '"', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste", back);
										return;
									}
									if (rows[0].allow_sell == 0){
										bot.sendMessage(message.chat.id, "L'oggetto specificato non puÃ² essere regalato", back);
										return;
									}

									var itemId = rows[0].id;
									itemName = rows[0].name;
									connection.query('SELECT id FROM inventory WHERE item_id = ' + itemId + ' AND player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "L'oggetto specificato non Ã¨ presente nel tuo inventario", back);
											return;
										}

										bot.sendMessage(message.chat.id, "Inserisci il messaggio da inviare (senza andare a capo o caratteri strani)", back).then(function() {
											answerCallbacks[message.chat.id] = function(answer) {
												if (answer.text == "Torna al menu"){
													return;
												}
												var msg = answer.text;

												bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {
														if (answer.text.toLowerCase() == "si"){
															connection.query('SELECT id FROM inventory WHERE item_id = ' + itemId + ' AND player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
																if (Object.keys(rows).length == 0){
																	bot.sendMessage(message.chat.id, "L'oggetto specificato non Ã¨ presente nel tuo inventario", back);
																	return;
																}

																setAchievement(message.chat.id, player_id, 36, 1);

																var d = new Date();
																var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																connection.query('INSERT INTO market_gift (player_id, to_id, item_id, time) VALUES (' + player_id + ',' + player_id2 + ',' + itemId + ',"' + long_date + '")', function (err, rows, fields){
																	if (err) throw err;
																});

																connection.query('UPDATE inventory SET player_id = ' + player_id2 + ' WHERE player_id = ' + player_id + ' AND item_id = ' + itemId + ' LIMIT 1', function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Regalo inviato!", back);
																	bot.sendMessage(chat_id2, "Hai ricevuto <b>" + itemName + "</b> da <b>" + message.from.username + "</b>, e ti scrive:\n<i>" + msg + "</i>", html);
																});
															});
														}
													}
												});
											};
										});
									});
								});
							}
						});
					});
				}
			});
		});
	});
});

bot.onText(/cron (.+)/i, function(message, match) {

	if (message.from.username != "fenix45"){
		return;
	}

	connection.query('SELECT id FROM player WHERE nickname = "' + match[1] + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		connection.query('SELECT item.name, M.price, M.type, time, from_id, to_id, P1.nickname As from_nick, P2.nickname As to_nick FROM market_direct_history M INNER JOIN player P1 ON P1.id = M.from_id INNER JOIN player P2 ON P2.id = M.to_id, item WHERE item.id = M.item_id AND (from_id = ' + player_id + ' OR to_id = ' + player_id + ') ORDER BY M.id DESC LIMIT 50', function(err, rows, fields) {
			if (err) throw err;

			var text = "*Cronologia vendite utente*\n\n";
			var long_date;
			var d;

			var tipo = "";

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				d = new Date(rows[i].time);
				long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1);

				if (rows[i].type == 1){
					tipo = "Mercato";
				}else if (rows[i].type == 2){
					tipo = "Negozi";
				}else{
					tipo = "?";
				}

				if (rows[i].from_id == player_id){
					text += ">> *" + rows[i].name + "* a " + rows[i].price + " Â§ a " + rows[i].to_nick.replace(new RegExp("_", "g"), " ") + " " + long_date + " (" + tipo + ")\n";
				}else if (rows[i].to_id == player_id){
					text += "<< *" + rows[i].name + "* a " + rows[i].price + " Â§ da " + rows[i].from_nick.replace(new RegExp("_", "g"), " ") + " " + long_date + " (" + tipo + ")\n";
				}
			}
			bot.sendMessage(message.chat.id, text, mark);
		});
	});
});

bot.onText(/cronologia/i, function(message) {
	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		connection.query('SELECT item.name, M.price, M.type, time, from_id, to_id, P1.nickname As from_nick, P2.nickname As to_nick FROM market_direct_history M INNER JOIN player P1 ON P1.id = M.from_id INNER JOIN player P2 ON P2.id = M.to_id, item WHERE item.id = M.item_id AND (from_id = ' + player_id + ' OR to_id = ' + player_id + ') ORDER BY M.id DESC LIMIT 50', function(err, rows, fields) {
			if (err) throw err;

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna al Mercato"],["Torna al menu"]]
				}
			};

			var text = "*Cronologia vendite personali*\n\n";
			var long_date;
			var d;
			var tipo = "";

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				d = new Date(rows[i].time);
				long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1);

				if (rows[i].type == 1){
					tipo = "Mercato";
				}else if (rows[i].type == 2){
					tipo = "Negozi";
				}else{
					tipo = "?";
				}

				if (rows[i].from_id == player_id){
					text += ">> *" + rows[i].name + "* a " + rows[i].price + " Â§ a " + rows[i].to_nick.replace(new RegExp("_", "g"), " ") + " - " + long_date + " (" + tipo + ")\n";
				}else if (rows[i].to_id == player_id){
					text += "<< *" + rows[i].name + "* a " + rows[i].price + " Â§ da " + rows[i].from_nick.replace(new RegExp("_", "g"), " ") + " - " + long_date + " (" + tipo + ")\n";
				}
			}
			bot.sendMessage(message.chat.id, text, kb);
		});
	});
});

bot.onText(/^cerca/i, function(message) {

	if (message.text.toLowerCase().indexOf("ricercato") != -1){
		return;
	}

	if (message.text.indexOf(" ") != -1){
		var oggetto = message.text.substring(message.text.indexOf(" ")+1);
		if ((oggetto == "Ancora") || (oggetto == "ðŸ”Ž")){
			cerca(message);
			return;
		}

		connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
			if (err) throw err;
			var player_id = rows[0].id;

			cercaTermine(message, oggetto, player_id);
		});
	}else{
		cerca(message);
	}
});

bot.onText(/Torna a /i, function(message) {
	var oggetto = message.text.substring(getPosition(message.text," ",2)+1);

	if (oggetto == "Crea"){
		return;
	}

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		cercaTermine(message, oggetto, player_id);
	});
});

function cercaTermine(message, param, player_id){

	var search = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Cerca Ancora"],["Torna al menu"]]
		}
	};
	var now = new Date();
	var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

	connection.query('INSERT INTO search_history (player_id, term, time) VALUES (' + player_id + ',"' + param + '","' + long_date + '")', function(err, rows, fields) {
		if (err) throw err;
	});

	connection.query('SELECT id, term FROM search_history WHERE player_id = ' + player_id + ' ORDER BY id DESC LIMIT 2', function(err, rows, fields) {
		if (err) throw err;

		var prev = 0;
		var prevtxt = "";
		if (Object.keys(rows).length == 2){
			//	console.log("Ricerca precedente: " + rows[1].term);
			prevtxt = "Torna a " + rows[1].term;
			prev = 1;
		}

		connection.query('SELECT * FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var lev = Math.floor(rows[0].exp/10);

			var weapon1 = rows[0].weapon_id;
			var weapon2 = rows[0].weapon2_id;
			var weapon3 = rows[0].weapon3_id;
			var weapon4 = rows[0].charm_id;

			if ((Object.keys(param).length <= 4) && ( (param.startsWith("C") || param.startsWith("NC") || param.startsWith("R") || param.startsWith("UR") || param.startsWith("L") || param.startsWith("E") || param.startsWith("S") || param.startsWith("UE") || param.startsWith("U") || param.startsWith("X")) )){

				var craftable = -1;
				var extra = "";
				var extra_txt = "";
				if (param.indexOf(" ") != -1){
					craftable = param.substring(Object.keys(param).length-1, Object.keys(param).length);
					extra = " AND craftable = " + craftable;
					if (craftable == 1){
						extra_txt = " creabili";
					}else{
						extra_txt = " base"
					}
					param = param.slice(0, -2);
				}

				connection.query('SELECT name, rarity FROM item WHERE rarity = "' + param + '"' + extra + ' ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per raritÃ  '" + param + "'" + extra_txt + ":\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name + " (" + rows[0].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}else{
						bot.sendMessage(message.chat.id, "Non ci sono oggetti creabili con quel livello di raritÃ .", search);
					}
				});
				return;
			}

			if (param == "Armi"){
				connection.query('SELECT name, rarity, power FROM item WHERE power > 0 ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].name.indexOf("Necrolama") != -1){
								rows[i].power = Math.round(50+(lev/2));
							}
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")   +" + rows[i].power + "\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}
			if (param == "Armature"){
				connection.query('SELECT name, rarity, power_armor FROM item WHERE power_armor < 0 ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].name == "Corazza Necro"){
								rows[i].power_armor = Math.round(25+(lev/2));
								rows[i].power_armor = -Math.abs(rows[i].power_armor);
							}

							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")   " + rows[i].power_armor + "\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}
			if (param == "Scudi"){
				connection.query('SELECT name, rarity, power_shield FROM item WHERE power_shield < 0 ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].name.indexOf("Scudo Necro") != -1){
								rows[i].power_shield = Math.round(20+(lev/2));
								rows[i].power_shield = -Math.abs(rows[i].power_shield);
							}

							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")   " + rows[i].power_shield + "\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}
			if (param == "Drago"){
				connection.query('SELECT name, rarity FROM item WHERE dragon_power <> 0 ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name  + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}

			if (param == "Talismani"){
				connection.query('SELECT name, rarity FROM item WHERE name LIKE "Talismano%" ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name  + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}

			if (param == "Consumabili"){
				connection.query('SELECT name, rarity FROM item WHERE category IN (1,4) ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);					
					}
				});
				return;
			}

			if (param == "Rifugio"){
				connection.query('SELECT name, rarity FROM item WHERE category IN (5) ORDER BY name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Torna a Crea"]);				
						iKeys.push(["Cerca Ancora"]);
						if (prev == 1){
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);					
					}
				});
				return;
			}

			var query = 'LIKE "%' + param + '%"';
			if (param.indexOf("*") != -1){
				param = param.replace("*", "");
				query = ' = "' + param + '"';
			}

			connection.query('SELECT * FROM item WHERE name ' + query, function(err, rows, fields) {
				if (err) throw err;
				var result = 0;

				var bottext = "Risultati per '" + param + "':\n";
				if (Object.keys(rows).length > 0){
					var iKeys = [];

					var key = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					var itemsArr = [];
					var j = 0;
					var found = 0;
					var name = "";

					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {

						name = rows[i].name;
						//console.log("Name: " + name);

						if (name != ""){
							if (len == 1){
								bottext = bottext + "\n_" + name + "_\n";
							}else{
								bottext = bottext + name + " (" + rows[i].rarity + ")\n";
							}

							j = 0;
							found = 0;

							itemsArr.push([name.toLowerCase()]);

							while (j < Object.keys(itemsArr).length){
								if (found == 0){
									if (itemsArr[j].indexOf(param.toLowerCase()) > -1){
										found = 1;
									}else{
										found = 0;
									}
								}
								j++;
							}

							if (found == 0){
								iKeys.push(["Cerca " + name]);
							}else if (found == 1){
								iKeys.push(["Cerca *" + name]);
							}
						}
					}

					iKeys.push(["Cerca Ancora"]);
					iKeys.push(["Torna a Crea"]);				
					if (prev == 1){
						iKeys.push([prevtxt]);
					}
					iKeys.push(["Torna al menu"]);

					if (Object.keys(rows).length == 1){

						if (rows[0].searchable == 0){
							bot.sendMessage(message.chat.id, "Le informazioni su questo oggetto sono nascoste ðŸ‘€ ", search);
							return;
						}

						setAchievement(message.chat.id, player_id, 22, 1);

						var name = rows[0].name;
						var power = 0;
						var crit = rows[0].critical;
						var rarity = rows[0].rarity;
						var level_nec = 0;
						var item_id = rows[0].id;

						if (rows[0].power != 0){
							if (crit > 0){
								power = rows[0].power + " (Arma), Probab. x2: " + crit + "%";
							}else{
								power = rows[0].power + " (Arma)";
							}
						}else if (rows[0].power_armor != 0){
							if (crit > 0){
								power = rows[0].power_armor + " (Armatura), Probab. /2: " + crit + "%";
							}else{
								power = rows[0].power_armor + " (Armatura)";
							}
						}else if (rows[0].power_sheld != 0){
							if (crit > 0){
								power = rows[0].power_shield + " (Scudo), Probab. annull: " + crit + "%";
							}else{
								power = rows[0].power_shield + " (Scudo)";
							}
						}
						if (rarity == "UR"){
							level_nec = "15";
						}else if (rarity == "L"){
							level_nec = "30";
						}else if (rarity == "E"){
							level_nec = "50";
						}else if (rarity == "UE"){
							level_nec = "60";
						}

						var price = formatNumber(rows[0].value);
						var dragon_power = rows[0].dragon_power;
						var reborn = rows[0].reborn;
						var category = rows[0].category;
						var est = rows[0].estimate;
						var consumable = rows[0].cons;
						var sellable = rows[0].allow_sell;

						var cons = "No";
						var cons_pnt = "";
						if (consumable == 1){
							cons = "Si";
							if (rows[0].id == 92){
								cons_pnt = " - Vita: 5%";
							}else if (rows[0].id == 93){
								cons_pnt = " - Vita: 10%";
							}else if (rows[0].id == 94){
								cons_pnt = " - Vita: 20%";
							}

							if (rows[0].id == 7){
								cons_pnt = " - Danno: 100-300";
							}else if (rows[0].id == 17){
								cons_pnt = " - Danno: 500";
							}else if (rows[0].id == 95){
								cons_pnt = " - Danno: 600";
							}else if (rows[0].id == 38){
								cons_pnt = " - Danno: 3000-7000";
							}else if (rows[0].id == 106){
								cons_pnt = " - Danno: 900-1000";						
							}else if (rows[0].id == 107){
								cons_pnt = " - Danno: 3500-4000";
							}else if (rows[0].id == 108){
								cons_pnt = " - Danno: 7000-8000";
							}
						}

						if (category == 2){
							tal = "*Potere Talismano*: " + rows[0].description;
						}

						var desc = "";
						if (rows[0].description != null){
							if ((category == 3) || (category == 2)){
								desc = "*Potere Oggetto*: " + rows[0].description;
							}else{
								desc = "*Descrizione*: " + rows[0].description;							
							}
						}

						stars = "Nessuna";
						if (reborn >= 2){
							stars = rebSym(reborn);
						}

						var extra = "";

						if ((rows[0].power != 0) || (rows[0].power_armor != 0) || (rows[0].power_shield)){
							if (name.indexOf("Necrolama") != -1){
								power = Math.round(50+(lev/2));
								extra = ", Probab. x2: " + crit + "%";
							}else if (name == "Corazza Necro"){
								power = Math.round(25+(lev/2));
								power = -Math.abs(power);
								extra = ", Probab. /2: " + crit + "%";
							}else if (name.indexOf("Scudo Necro") != -1){
								power = Math.round(20+(lev/2));
								power = -Math.abs(power);
								extra = ", Probab. annull: " + crit + "%";							
							}
							bottext += "\n*Giocatore*: " + power + extra;
							if ((level_nec != 0) && (reborn == 1)){
								bottext += "\n*Livello richiesto*: " + level_nec;
							}
						}
						bottext += "\n*Rinascita richiesta*: " + stars;
						if (dragon_power != 0){
							bottext += "\n*Drago*: " + dragon_power;
						}
						bottext += "\n*RaritÃ *: " + rarity + " (" + price + " Â§)";
						bottext += "\n*Consumabile*: " + cons + cons_pnt;

						if (est == 0){
							connection.query('SELECT price FROM market_direct_history WHERE time BETWEEN date_sub(NOW(),INTERVAL 2 WEEK) AND NOW() AND price != (SELECT value FROM item WHERE id = ' + item_id + ') AND item_id = ' + item_id, function (err, rows, fields){
								if (err) throw err;
								var price = 0;
								var arr = [];
								if (Object.keys(rows).length > 0){
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										arr.push(rows[i].price);
									}
									price = estimate(arr);
									connection.query('UPDATE item SET estimate = ' + price + ' WHERE id = ' + item_id, function(err, rows, fields) {
										if (err) throw err;
									});
								}
							});
						}

						connection.query('SELECT COUNT(*) As num FROM inventory WHERE item_id = ' + item_id + ' AND player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;

							var poss = rows[0].num;

							connection.query('SELECT (SELECT COUNT(*) FROM player) As player, count(distinct(nickname)) As cnt FROM `inventory_rarity` where item_id = ' + item_id, function(err, rows, fields) {
								if (err) throw err;

								bottext += "\n*Posseduti*: " + poss + " (" + Math.round((rows[0].cnt/rows[0].player)*100) + "%)";
								if (sellable == 0){
									bottext += "\nQuesto oggetto non puÃ² essere venduto nel mercato";
								}
								if ((desc != "") && (desc != null)){
									bottext += "\n" + desc;
								}
								//bottext += "\n";

								connection.query('SELECT material_result FROM craft, item WHERE craft.material_result = item.id AND item.name = "' + name + '"', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										connection.query('SELECT id FROM item WHERE  item.name="' + name + '"', function(err, rows, fields) {
											if (err) throw err;
											result = rows[0].id;
											connection.query('SELECT craft.*, item.name, item.rarity FROM `craft`, item where material_result = item.id AND ((material_1 = ' + result + ' AND material_2 = ' + result + ' AND material_3 = ' + result + ') OR (material_1 = ' + result + ' AND material_2 = ' + result + ') OR (material_1 = ' + result + ' AND material_3 = ' + result + ') OR (material_2 = ' + result + ' AND material_3 = ' + result + ') OR material_1 = ' + result + ' OR material_2 = ' + result + ' OR material_3 = ' + result + ')', function(err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length > 0){
													bottext = bottext + "\n\nCon questo oggetto puoi creare:\n";

													var iKeys2 = [];

													var kb2 = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															one_time_keyboard: true,
															"keyboard": iKeys2
														}
													};

													for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
														if (rows[i].name != ""){
															bottext = bottext + "> " + rows[i].name + " (" + rows[i].rarity + ")\n";
															if (rows[i].name.indexOf(" ") != -1){
																iKeys2.push(["Cerca " + rows[i].name]);
															}else{
																iKeys2.push(["Cerca *" + rows[i].name]);
															}
														}
													}

													iKeys2.push(["Cerca Ancora"]);
													iKeys2.push(["Torna a Crea"]);				
													if (prev == 1){
														iKeys2.push([prevtxt]);
													}
													iKeys2.push(["Torna al menu"]);

													bot.sendMessage(message.chat.id, bottext, kb2);
												}else{
													bot.sendMessage(message.chat.id, bottext, search);
												}
											});
										});
										return;
									}
									result = rows[0].material_result;

									connection.query('SELECT claws_id, saddle_id FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;

										var claws_id = 999;
										var saddle_id = 999;

										if (Object.keys(rows).length > 0){
											claws_id = rows[0].claws_id;
											saddle_id = rows[0].saddle_id;
										}

										var mat1 = "";
										var mat1id = "";
										var mat1p = "";
										var mat1r = "";
										var mat1q = "";
										var mat1ex = "";

										var mat2 = "";
										var mat2id = "";
										var mat2p = "";
										var mat2r = "";
										var mat2q = "";
										var mat2ex = "";

										var mat3 = "";
										var mat3id = "";
										var mat3p = "";
										var mat3r = "";
										var mat3q = "";
										var mat3ex = "";

										var mat4 = "";
										var mat4id = "";
										var mat4p = "";
										var mat4r = "";
										var mat4q = "";
										var mat4ex = "";

										connection.query('SELECT item.id, item.name, item.craftable, item.rarity FROM craft, item WHERE craft.material_1 = item.id AND craft.material_result=' + result, function(err, rows, fields) {
											if (err) throw err;
											mat1 = rows[0].name;
											if (rows[0].craftable == 1){
												mat1p = rows[0].name;
											}else{
												mat1p = "*" + rows[0].name + "*";
											}
											mat1id = rows[0].id;
											mat1r = rows[0].rarity;
											connection.query('SELECT item.id, item.name, item.craftable, item.rarity FROM craft, item WHERE craft.material_2 = item.id AND craft.material_result=' + result, function(err, rows, fields) {
												if (err) throw err;
												mat2 = rows[0].name;
												if (rows[0].craftable == 1){
													mat2p = rows[0].name;
												}else{
													mat2p = "*" + rows[0].name + "*";
												}
												mat2id = rows[0].id;
												mat2r = rows[0].rarity;
												connection.query('SELECT item.id, item.name, item.craftable, item.rarity FROM craft, item WHERE craft.material_3 = item.id AND craft.material_result=' + result, function(err, rows, fields) {
													if (err) throw err;
													mat3 = rows[0].name;
													if (rows[0].craftable == 1){
														mat3p = rows[0].name;
													}else{
														mat3p = "*" + rows[0].name + "*";
													}
													mat3id = rows[0].id;
													mat3r = rows[0].rarity;
													connection.query('SELECT COUNT(*) As num FROM item, inventory WHERE item.id = inventory.item_id AND item.name = "' + mat1 + '" AND inventory.player_id=' + player_id, function(err, rows, fields) {
														if (err) throw err;
														if (rows[0].num > 0){
															mat1ex = "â˜‘ï¸ ";
														}else if ((mat1id == weapon1) || (mat1id == weapon2) || (mat1id == weapon3) || (mat1id == weapon4)){
															mat1ex = "ðŸ—¡";
														}else if ((mat1id == claws_id) || (mat1id == saddle_id)){
															mat1ex = "ðŸ‰";
														}	
														mat1q = rows[0].num;
														connection.query('SELECT COUNT(*) As num FROM item, inventory WHERE item.id = inventory.item_id AND item.name = "' + mat2 + '" AND inventory.player_id=' + player_id, function(err, rows, fields) {
															if (err) throw err;
															if (rows[0].num > 0){
																mat2ex = "â˜‘ï¸ ";
															}else if ((mat2id == weapon1) || (mat2id == weapon2) || (mat2id == weapon3) || (mat2id == weapon4)){
																mat2ex = "ðŸ—¡";
															}else if ((mat2id == claws_id) || (mat2id == saddle_id)){
																mat2ex = "ðŸ‰";
															}	
															mat2q = rows[0].num;
															connection.query('SELECT COUNT(*) As num FROM item, inventory WHERE item.id = inventory.item_id AND item.name = "' + mat3 + '" AND inventory.player_id=' + player_id, function(err, rows, fields) {
																if (err) throw err;
																if (rows[0].num > 0){
																	mat3ex = "â˜‘ï¸ ";
																}else if ((mat3id == weapon1) || (mat3id == weapon2) || (mat3id == weapon3) || (mat3id == weapon4)){
																	mat3ex = "ðŸ—¡";
																}else if ((mat3id == claws_id) || (mat3id == saddle_id)){
																	mat3ex = "ðŸ‰";
																}	
																mat3q = rows[0].num;

																bottext = bottext + "\n\nMateriali necessari:\n> " + mat1p + " (" + mat1r + ", " + mat1q + ") " + mat1ex + "\n> " + mat2p + " (" + mat2r + ", " + mat2q + ") " + mat2ex + "\n> " + mat3p + " (" + mat3r + ", " + mat3q + ") " + mat3ex;

																connection.query('SELECT craft.*, item.name, item.rarity FROM `craft`, item where material_result = item.id AND ((material_1 = ' + result + ' AND material_2 = ' + result + ' AND material_3 = ' + result + ') OR (material_1 = ' + result + ' AND material_2 = ' + result + ') OR (material_1 = ' + result + ' AND material_3 = ' + result + ') OR (material_2 = ' + result + ' AND material_3 = ' + result + ') OR material_1 = ' + result + ' OR material_2 = ' + result + ' OR material_3 = ' + result + ')', function(err, rows, fields) {
																	if (err) throw err;

																	var iKeys3 = [];

																	iKeys3.push(["Crea " + name]);

																	if (mat1.indexOf(" ") != -1){
																		iKeys3.push(["Cerca " + mat1]);
																	}else{
																		iKeys3.push(["Cerca *" + mat1]);
																	}
																	if (mat2.indexOf(" ") != -1){
																		iKeys3.push(["Cerca " + mat2]);
																	}else{
																		iKeys3.push(["Cerca *" + mat2]);
																	}
																	if (mat3.indexOf(" ") != -1){
																		iKeys3.push(["Cerca " + mat3]);
																	}else{
																		iKeys3.push(["Cerca *" + mat3]);
																	}

																	var kb = {
																		parse_mode: "Markdown",
																		reply_markup: {
																			resize_keyboard: true,
																			one_time_keyboard: true,
																			"keyboard": iKeys3
																		}
																	};

																	if (Object.keys(rows).length > 0){
																		bottext = bottext + "\n\nCon questo oggetto puoi creare:\n";
																		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																			bottext = bottext + "> " + rows[i].name + " (" + rows[i].rarity + ")\n";
																			if (rows[i].name.indexOf(" ") != -1){
																				iKeys3.push(["Cerca " + rows[i].name]);
																			}else{
																				iKeys3.push(["Cerca *" + rows[i].name]);
																			}
																		}

																		iKeys3.push(["Cerca Ancora"]);
																		iKeys3.push(["Torna a Crea"]);
																		if (prev == 1){
																			iKeys3.push([prevtxt]);
																		}
																		iKeys3.push(["Torna al menu"]);
																		bot.sendMessage(message.chat.id, bottext, kb);
																	}else{
																		iKeys3.push(["Cerca Ancora"]);
																		iKeys3.push(["Torna a Crea"]);				
																		if (prev == 1){
																			iKeys3.push([prevtxt]);
																		}
																		iKeys3.push(["Torna al menu"]);
																		bot.sendMessage(message.chat.id, bottext, kb);
																	}
																});
															});
														});
													});
												});
											});
										});
									});
								});
							});
						});
					}else{
						if (Object.keys(bottext).length > 4000){
							bottext = "La ricerca ha prodotto troppi risultati, prova a restringere il campo";
							bot.sendMessage(message.chat.id, bottext, search);
						}else{
							bot.sendMessage(message.chat.id, bottext, key);
						}
					}
				}else{
					bot.sendMessage(message.chat.id, "Nessun risultato, riprova con una parola chiave diversa. Se cerchi il nome preciso dell\'oggetto visualizzerai anche gli oggetti necessari per crearlo.", search);
				}
			});
		});
	});
}

bot.onText(/lista ricerche/i, function(message) {
	connection.query('SELECT id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		connection.query('SELECT term FROM search_history WHERE player_id = ' + player_id + ' ORDER BY id DESC LIMIT 100', function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length > 0){
				var iKeys = [];
				for (var i = 0, len = Object.keys(rows).length-1; i < len; i++) {
					iKeys.push(["Cerca " + rows[i].term]);
				}
				iKeys.push(["Torna al menu"]);

				var kb = {
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				bot.sendMessage(message.chat.id, "Seleziona la ricerca precedente", kb);
			}else{
				bot.sendMessage(message.chat.id, "Nessuna cronologia presente", back);
			}
		});
	});
});

function cerca(message){
	connection.query('SELECT id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var iKeys = [["Cerca Armi"],["Cerca Armature","Cerca Scudi"],["Cerca Talismani","Cerca Drago"],["Cerca Consumabili","Cerca Rifugio"],["Cerca C","Cerca NC"],["Cerca R","Cerca UR"],["Cerca L","Cerca E"],["Cerca UE","Cerca S"],["Cerca U","Cerca X"],["Lista Ricerche"],["Torna al menu"]];

		var kb = {
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": iKeys
			}
		};

		bot.sendMessage(message.chat.id, "Cosa vuoi cercare?\nPuoi cercare per raritÃ  o categoria o scrivere Cerca NomeOggetto da qualsiasi schermata del bot. Per forzare la ricerca di un oggetto preciso scrivi Cerca *NomeOggetto", kb);
	});
};

bot.onText(/alchimia/i, function(message) {

	var alchemy = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [['Sintesi'],['Incanta ðŸ’Ž ','Scomponi ðŸ’Ž '],['Torna allo zaino'],['Torna al menu']]
		}		
	}

	bot.sendMessage(message.chat.id, "Quale operazione vuoi effettuare?", alchemy);
});

bot.onText(/zaino/i, function(message) {

	if (message.text == "Avere uno zaino pieno zeppo"){
		return;
	}

	var backpack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [['Solo C','Solo NC','Solo R'],['Solo UR','Solo L','Solo E'],['Solo UE','Solo U','Solo S'],['Solo I','Pozioni'],['Equipaggia','Set','Rimuovi'],['Mercato','Alchimia ðŸ’Ž'],['Torna al menu']]
		}
	};

	var backpackB = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna allo Zaino"],["Torna al menu"]]
		}
	};

	connection.query('SELECT id, holiday, total_life, life, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Account non trovato, contatta @fenix45 per segnalare");
			return;
		}

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var bottext = message.from.username.replace(new RegExp("_", "g"), " ") + ", ecco il contenuto del tuo zaino:\n\n";
		var player_total_life = rows[0].total_life;
		var player_life = rows[0].life;

		connection.query('SELECT nickname, COUNT(DISTINCT name) As crafted, (SELECT COUNT(*) FROM item) As total FROM `inventory_rarity` WHERE nickname = "' + message.from.username + '" GROUP BY nickname', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				bottext = bottext + "*Oggetti posseduti:* " + rows[0].crafted + " su " + rows[0].total + "\n\n";
			}
			connection.query('SELECT chest.name As name, COUNT(chest.name) As num FROM inventory_chest, chest WHERE player_id=' + player_id + ' AND chest.id = inventory_chest.chest_id GROUP BY chest.name ORDER BY chest.id', function(err, rows, fields) {
				if (err) throw err;
				bottext = bottext + "*Scrigni:*\n";
				if (Object.keys(rows).length > 0){
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						bottext = bottext + "> " + rows[i].name + " (" + rows[i].num + ")\n";
					}
				}else{
					bottext = bottext + "Nessuno scrigno disponibile\n";
				}

				bottext = bottext + "\n";

				connection.query('SELECT type, power, quantity FROM magic WHERE player_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length > 0){
						bottext = bottext + "*Incantesimi:*\n";
						var n = "";
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].type == 1){
								n = "Furia dei Mari";
							}else if (rows[i].type == 2){
								n = "Tempesta Folgorante";
							}else if (rows[i].type == 3){
								n = "Impeto di Fiamme";
							}else if (rows[i].type == 4){
								n = "Ira Astrale";
							}
							bottext = bottext + "> " + n + " " + rows[i].power + " (" + rows[i].quantity + ")\n";
						}
						bottext = bottext + "\n";
					}

					connection.query('SELECT inventory.player_id, item.craftable, item.name, rarity.id, rarity.name As rname, COUNT(item.name) As num FROM `inventory`, item, rarity WHERE player_id = ' + player_id + ' AND rarity.shortname = item.rarity AND inventory.item_id = item.id GROUP BY item.name ORDER BY rarity.id DESC, item.name ASC', function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0){
							var i = 0;

							var raritypre = rows[0].id;
							bottext = bottext + "*" + rows[0].rname + "*:\n";

							for (i = 0, len = Object.keys(rows).length; i < len; i++) {

								if (rows[i].id != raritypre){
									bottext = bottext + "\n*" + rows[i].rname + "*:\n";
								}
								if (rows[i].craftable == 0){
									rows[i].name = "*" + rows[i].name + "*";
								}
								bottext = bottext + "> " + rows[i].name + " (" + rows[i].num + ")\n";
								raritypre = rows[i].id;
							}
						}else{
							bottext = bottext + "Nessun oggetto disponibile\n";
						}

						if (Object.keys(bottext).length > 4000){
							var arr = bottext.split("\n");
							var text = "";
							for (var i = 0, len = Object.keys(arr).length; i < len; i++) {
								text += arr[i] + "\n";
								if ((Object.keys(text).length+Object.keys(arr[i]).length) >= 4000){
									bot.sendMessage(message.chat.id, text, backpack);
									text = "";
								}
							}
							if (text != ""){
								setTimeout(function() {
									bot.sendMessage(message.chat.id, text, backpack);
								}, 500);
							}
						}else{
							bot.sendMessage(message.chat.id, bottext, backpack);
						}
					});
				});
			});
		});
	});
});

bot.onText(/^set$|torna ai set|^Imposta (.+)/i, function(message) {

	//	if ((message.from.username != "Gaius87") && (message.from.username != "fenix45")){
	//		bot.sendMessage(message.chat.id, "A breve", back);
	//		return;
	//	}

	if (message.text == "Nuovo Set"){
		return;
	}

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var setBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Torna ai set"],["Torna al menu"]]
			}
		};

		var setYesno = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Si"],["Elimina"],["Torna ai set"],["Torna al menu"]]
			}
		};

		if (message.text.toLowerCase().indexOf("imposta") != -1){

			if (message.text.indexOf("(") != -1){
				message.text = message.text.substring(0, message.text.indexOf("("));
			}

			var reg = /Imposta (.+)/i;
			var found = message.text.match(reg);
			var set = found[1];

			connection.query('SELECT id FROM set_list WHERE name = "' + set + '" AND player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Set non valido", setBack);
					return;
				}

				var setId = rows[0].id;

				connection.query('SELECT S.id, S.name, I1.name As weapon, I1.id As wId, I1.power As power1, I1.critical As crit1, I2.name As armor, I2.id As aId, I2.power_armor As power2, I2.critical As crit2, I3.name As shield, I3.id As sId, I3.power_shield As power3, I3.critical As crit3, I4.name As charm, I4.id As cId FROM set_list S LEFT JOIN item I1 ON I1.id = S.item_weapon LEFT JOIN item I2 ON I2.id = S.item_armor LEFT JOIN item I3 ON I3.id = S.item_shield LEFT JOIN item I4 ON I4.id = S.item_charm WHERE S.id = ' + setId, function(err, rows, fields) {
					if (err) throw err;

					var setId = rows[0].id;
					var text = "Set *" + rows[0].name + "* (" + setId + ")\n\n";

					if (rows[0].weapon != null){
						text += "Arma: " + rows[0].weapon + "\n";
					}
					if (rows[0].armor != null){
						text += "Armatura: " + rows[0].armor + "\n";
					}
					if (rows[0].shield != null){
						text += "Scudo: " + rows[0].shield + "\n";
					}
					if (rows[0].charm != null){
						text += "Talismano: " + rows[0].charm + "\n";
					}

					var wName = rows[0].weapon;
					var aName = rows[0].armor;
					var sName = rows[0].shield;
					var cName = rows[0].charm;

					var wId = rows[0].wId;
					var aId = rows[0].aId;
					var sId = rows[0].sId;
					var cId = rows[0].cId;

					var pow1 = rows[0].power1;
					var pow2 = rows[0].power2;
					var pow3 = rows[0].power3;

					var crit1 = rows[0].crit1;
					var crit2 = rows[0].crit2;
					var crit3 = rows[0].crit3;

					bot.sendMessage(message.chat.id, text + "\nConfermi il set?", setYesno).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text.toLowerCase() == "si"){
								connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + wId, function(err, rows, fields) {
									if (err) throw err;
									if ((Object.keys(rows).length == 0) && (wName != null)){
										bot.sendMessage(message.chat.id, "Non possiedi " + wName, setBack);
										return;
									}
									connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + aId, function(err, rows, fields) {
										if (err) throw err;
										if ((Object.keys(rows).length == 0) && (aName != null)){
											bot.sendMessage(message.chat.id, "Non possiedi " + aName, setBack);
											return;
										}
										connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + sId, function(err, rows, fields) {
											if (err) throw err;
											if ((Object.keys(rows).length == 0) && (sName != null)){
												bot.sendMessage(message.chat.id, "Non possiedi " + sName, setBack);
												return;
											}
											connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + cId, function(err, rows, fields) {
												if (err) throw err;
												if ((Object.keys(rows).length == 0) && (cName != null)){
													bot.sendMessage(message.chat.id, "Non possiedi " + cName, setBack);
													return;
												}

												connection.query('SELECT weapon_id, weapon2_id, weapon3_id, charm_id FROM player WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;

													if (wId != null){
														if (rows[0].weapon_id != 0){
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].weapon_id + ')', function(err, rows, fields) {
																if (err) throw err;
															});
														}
													}
													if (aId != null){
														if (rows[0].weapon2_id != 0){
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].weapon2_id + ')', function(err, rows, fields) {
																if (err) throw err;
															});
														}
													}
													if (sId != null){
														if (rows[0].weapon3_id != 0){
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].weapon3_id + ')', function(err, rows, fields) {
																if (err) throw err;
															});
														}
													}
													if (cId != null){
														if (rows[0].charm_id != 0){
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].charm_id + ')', function(err, rows, fields) {
																if (err) throw err;
															});
														}
													}

													connection.query('SELECT weapon, weapon_id, weapon_crit, weapon2, weapon2_id, weapon2_crit, weapon3, weapon3_id, weapon3_crit, charm_id FROM player WHERE id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;

														if (wId == null){
															wId = rows[0].weapon_id;
														}else{
															connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + wId + ' LIMIT 1', function(err, rows, fields) {
																if (err) throw err;
															});
														}
														if (aId == null){
															aId = rows[0].weapon2_id;
														}else{
															connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + aId + ' LIMIT 1', function(err, rows, fields) {
																if (err) throw err;
															});
														}
														if (sId == null){
															sId = rows[0].weapon3_id;
														}else{
															connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + sId + ' LIMIT 1', function(err, rows, fields) {
																if (err) throw err;
															});
														}
														if (cId == null){
															cId = rows[0].charm_id;
														}else{
															connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + cId + ' LIMIT 1', function(err, rows, fields) {
																if (err) throw err;
															});
														}

														if (pow1 == null){
															pow1 = rows[0].weapon;
														}
														if (pow2 == null){
															pow2 = rows[0].weapon2;
														}
														if (pow3 == null){
															pow3 = rows[0].weapon3;
														}

														if (crit1 == null){
															crit1 = rows[0].weapon_crit;
														}
														if (crit2 == null){
															crit2 = rows[0].weapon2_crit;
														}
														if (crit3 == null){
															crit3 = rows[0].weapon3_crit;
														}

														connection.query('UPDATE player SET weapon_id = '+wId+', weapon = '+pow1+', weapon_crit = '+crit1+', ' +
																		 'weapon2_id = '+aId+', weapon2 = '+pow2+', weapon2_crit = '+crit2+', ' +
																		 'weapon3_id = '+sId+', weapon3 = '+pow3+', weapon3_crit = '+crit3+', ' +
																		 'charm_id = '+cId+' WHERE id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Set equipaggiato!", setBack);
														});
													});
												});
											});
										});
									});
								});
							}else if (answer.text == "Elimina"){
								connection.query('DELETE FROM set_list WHERE id = ' + setId, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Set eliminato!", setBack);
								});
							}
						};
					});
				});
			});
			return;
		};


		connection.query('SELECT name, quantity FROM set_list WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			iKeys = [];
			if (Object.keys(rows).length > 0){
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					iKeys.push(["Imposta " + rows[i].name + " (" + rows[i].quantity + " oggetti)"]);
				}
			}
			iKeys.push(["Nuovo Set","Carica Set"]);
			iKeys.push(["Torna al menu"]);

			var setList = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			bot.sendMessage(message.chat.id, "Imposta o modifica un set di equipaggiamento", setList).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var resp = answer.text.toLowerCase();
					if (resp.indexOf("imposta") != -1){

						/*
						var reg = /Imposta (.+) \(/i;
						var found = resp.match(reg);
						var set = found[1];

						connection.query('SELECT id FROM set_list WHERE name = "' + set + '" AND player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Set non valido", setBack);
								return;
							}

							var setId = rows[0].id;

							connection.query('SELECT S.id, S.name, I1.name As weapon, I1.id As wId, I1.power As power1, I1.critical As crit1, I2.name As armor, I2.id As aId, I2.power_armor As power2, I2.critical As crit2, I3.name As shield, I3.id As sId, I3.power_shield As power3, I3.critical As crit3, I4.name As charm, I4.id As cId FROM set_list S LEFT JOIN item I1 ON I1.id = S.item_weapon LEFT JOIN item I2 ON I2.id = S.item_armor LEFT JOIN item I3 ON I3.id = S.item_shield LEFT JOIN item I4 ON I4.id = S.item_charm WHERE S.id = ' + setId, function(err, rows, fields) {
								if (err) throw err;

								var setId = rows[0].id;
								var text = "Set *" + rows[0].name + "* (" + setId + ")\n\n";

								if (rows[0].weapon != null){
									text += "Arma: " + rows[0].weapon + "\n";
								}
								if (rows[0].armor != null){
									text += "Armatura: " + rows[0].armor + "\n";
								}
								if (rows[0].shield != null){
									text += "Scudo: " + rows[0].shield + "\n";
								}
								if (rows[0].charm != null){
									text += "Talismano: " + rows[0].charm + "\n";
								}

								var wName = rows[0].weapon;
								var aName = rows[0].armor;
								var sName = rows[0].shield;
								var cName = rows[0].charm;

								var wId = rows[0].wId;
								var aId = rows[0].aId;
								var sId = rows[0].sId;
								var cId = rows[0].cId;

								var pow1 = rows[0].power1;
								var pow2 = rows[0].power2;
								var pow3 = rows[0].power3;

								var crit1 = rows[0].crit1;
								var crit2 = rows[0].crit2;
								var crit3 = rows[0].crit3;

								bot.sendMessage(message.chat.id, text + "\nConfermi il set?", setYesno).then(function() {
					                                answerCallbacks[message.chat.id] = function(answer) {
										if (answer.text.toLowerCase() == "si"){
											connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + wId, function(err, rows, fields) {
												if (err) throw err;
												if ((Object.keys(rows).length == 0) && (wName != null)){
													bot.sendMessage(message.chat.id, "Non possiedi " + wName, setBack);
													return;
												}
												connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + aId, function(err, rows, fields) {
													if (err) throw err;
													if ((Object.keys(rows).length == 0) && (aName != null)){
														bot.sendMessage(message.chat.id, "Non possiedi " + aName, setBack);
														return;
													}
													connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + sId, function(err, rows, fields) {
														if (err) throw err;
														if ((Object.keys(rows).length == 0) && (sName != null)){
															bot.sendMessage(message.chat.id, "Non possiedi " + sName, setBack);
															return;
														}
														connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + cId, function(err, rows, fields) {
															if (err) throw err;
															if ((Object.keys(rows).length == 0) && (cName != null)){
																bot.sendMessage(message.chat.id, "Non possiedi " + cName, setBack);
																return;
															}

															connection.query('SELECT weapon_id, weapon2_id, weapon3_id, charm_id FROM player WHERE id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;

																if (wId != null){
																	if (rows[0].weapon_id != 0){
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].weapon_id + ')', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																}
																if (aId != null){
																	if (rows[0].weapon2_id != 0){
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].weapon2_id + ')', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																}
																if (sId != null){
																	if (rows[0].weapon3_id != 0){
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].weapon3_id + ')', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																}
																if (cId != null){
																	if (rows[0].charm_id != 0){
																		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].charm_id + ')', function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																}

												connection.query('SELECT weapon, weapon_id, weapon_crit, weapon2, weapon2_id, weapon2_crit, weapon3, weapon3_id, weapon3_crit, charm_id FROM player WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;

													if (wId == null){
														wId = rows[0].weapon_id;
													}else{
														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + wId + ' LIMIT 1', function(err, rows, fields) {
															if (err) throw err;
														});
													}
													if (aId == null){
														aId = rows[0].weapon2_id;
													}else{
														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + aId + ' LIMIT 1', function(err, rows, fields) {
															if (err) throw err;
														});
													}
													if (sId == null){
														sId = rows[0].weapon3_id;
													}else{
														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + sId + ' LIMIT 1', function(err, rows, fields) {
															if (err) throw err;
														});
													}
													if (cId == null){
														cId = rows[0].charm_id;
													}else{
														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + cId + ' LIMIT 1', function(err, rows, fields) {
															if (err) throw err;
														});
													}

													if (pow1 == null){
														pow1 = rows[0].weapon;
													}
													if (pow2 == null){
														pow2 = rows[0].weapon2;
													}
													if (pow3 == null){
														pow3 = rows[0].weapon3;
													}

													if (crit1 == null){
														crit1 = rows[0].weapon_crit;
													}
													if (crit2 == null){
														crit2 = rows[0].weapon2_crit;
													}
													if (crit3 == null){
														crit3 = rows[0].weapon3_crit;
													}

													connection.query('UPDATE player SET weapon_id = '+wId+', weapon = '+pow1+', weapon_crit = '+crit1+', ' +
															'weapon2_id = '+aId+', weapon2 = '+pow2+', weapon2_crit = '+crit2+', ' +
															'weapon3_id = '+sId+', weapon3 = '+pow3+', weapon3_crit = '+crit3+', ' +
															'charm_id = '+cId+' WHERE id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
																bot.sendMessage(message.chat.id, "Set equipaggiato!", setBack);
													});
																});
															});
														});
													});
												});
											});
										}else if (answer.text == "Elimina"){
											connection.query('DELETE FROM set_list WHERE id = ' + setId, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Set eliminato!", setBack);
											});
										}
									};
								});
							});
						});
						*/
					}else if (resp == "nuovo set"){
						bot.sendMessage(message.chat.id, "Aggiungi un nuovo set utilizzando questo formato:\nNOMESET: ARMA,ARMATURA,SCUDO,TALISMANO\n" +
										"_Esempio:_ Guerriero: Spada Antimateria,Armatura Nova,Scudo Statico,Talismano Guerriero\n" +
										"Se salti un campo, verrÃ  mantenuto l'oggetto attuale equipaggiato\n" +
										"_Esempio:_ Contadino: Coltello a Baionetta,Protezione di Stoffa,,Talismano della Forza", setBack).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								var resp = answer.text;

								if ((resp == "Torna al menu") || (resp == "Torna ai set")){
									return;
								}

								var reg = new RegExp("([a-zA-Z0-9 ]+): *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*)");
								var reg2 = /([a-zA-Z0-9 ]+): *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*)/i;
								if (reg.test(resp) == false){
									bot.sendMessage(message.chat.id, "Sintassi non valida, riprova", setBack);
									return;
								}

								var found = resp.match(reg);

								console.log(found);

								if (found == null){
									bot.sendMessage(message.chat.id, "Errore di sintassi, riprova", setBack);
									return;
								}

								var title = found[1].trim();
								var weapon1 = found[2].trim();
								var weapon2 = found[3].trim();
								var weapon3 = found[4].trim();
								var weapon4 = found[5].trim();

								var text = "Set *" + title + "*:\n";

								if (weapon1 != ""){
									text += weapon1;
								}
								if (weapon2 != ""){
									text += weapon2;
								}
								if (weapon3 != ""){
									text += weapon3;
								}
								if (weapon4 != ""){
									text += weapon4;
								}

								var w1 = null;
								var w2 = null;
								var w3 = null;
								var w4 = null;
								var qnt = 0;

								connection.query('SELECT name FROM set_list WHERE name = "' + title + '" AND player_id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length > 0){
										bot.sendMessage(message.chat.id, "Non puoi utilizzare due nomi uguali", setBack);
										return;
									}

									connection.query('SELECT id FROM item WHERE name = "' + weapon1 + '" AND power > 0', function(err, rows, fields) {
										if (err) throw err;
										if ((Object.keys(rows).length == 0) && (weapon1 != "")){
											bot.sendMessage(message.chat.id, "L'arma non Ã¨ valida", setBack);
											return;
										}else if (weapon1 == ""){
											w1 = 0;
										}else{
											w1 = rows[0].id;
											qnt++;
										}
										connection.query('SELECT id FROM item WHERE name = "' + weapon2 + '" AND power_armor < 0', function(err, rows, fields) {
											if (err) throw err;
											if ((Object.keys(rows).length == 0) && (weapon2 != "")){
												bot.sendMessage(message.chat.id, "L'armatura non Ã¨ valida", setBack);
												return;
											}else if (weapon2 == ""){
												w2 = 0;
											}else{
												w2 = rows[0].id;
												qnt++;
											}
											connection.query('SELECT id FROM item WHERE name = "' + weapon3 + '" AND power_shield < 0', function(err, rows, fields) {
												if (err) throw err;
												if ((Object.keys(rows).length == 0) && (weapon3 != "")){
													bot.sendMessage(message.chat.id, "Lo scudo non Ã¨ valido", setBack);
													return;
												}else if (weapon3 == ""){
													w3 = 0;
												}else{
													w3 = rows[0].id;
													qnt++;
												}
												connection.query('SELECT id FROM item WHERE name = "' + weapon4 + '" AND name LIKE "Talismano%"', function(err, rows, fields) {
													if (err) throw err;
													if ((Object.keys(rows).length == 0) && (weapon4 != "")){
														bot.sendMessage(message.chat.id, "Il talismano non Ã¨ valido", setBack);
														return;
													}else if (weapon4 == ""){
														w4 = 0;
													}else{
														w4 = rows[0].id;
														qnt++;
													}

													connection.query('INSERT INTO set_list (player_id, quantity, name, item_weapon, item_armor, item_shield, item_charm) ' +
																	 'VALUES (' + player_id + ',' + qnt + ',"' + title + '",' + w1 + ',' + w2 + ',' + w3 + ',' + w4 + ')', function(err, rows, fields) {
														if (err) throw err;
														connection.query('SELECT MAX(id) As maxid FROM set_list WHERE player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Set *" + title + "* creato! (Codice importazione: " + rows[0].maxid + ")", setBack);
														});
													});
												});
											});
										});
									});
								});
							}
						});
					}else if (resp == "carica set"){
						bot.sendMessage(message.chat.id, "Inserisci il codice del set da importare", setBack).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Torna al set"){
									return;
								}	
								var code = parseInt(answer.text);

								if (isNaN(code)){
									bot.sendMessage(message.chat.id, "Questo codice set non esiste", setBack);
									return;
								}

								connection.query('SELECT * FROM set_list WHERE id = ' + code, function(err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Questo codice set non esiste", setBack);
										return;
									}

									var title = rows[0].name;

									connection.query('INSERT INTO set_list (player_id, quantity, name, item_weapon, item_armor, item_shield, item_charm) ' +
													 'VALUES (' + player_id + ',' + rows[0].quantity + ',"' + rows[0].name + '",' + rows[0].item_weapon + ',' + rows[0].item_armor + ',' + rows[0].item_shield + ',' + rows[0].item_charm + ')', function(err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT MAX(id) As maxid FROM set_list WHERE player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Set *" + title + "* importato! (Codice condivisione: " + rows[0].maxid + ")", setBack);
										});
									});
								});		
							}
						});
					}
				}
			});
		});	
	});
});

bot.onText(/^solo (.+)/i, function(message) {

	var backPack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna allo Zaino"],["Torna al menu"]]
		}
	};

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var soloRarity = message.text.substring(message.text.indexOf(" ")+1);
		var text = "";

		if (soloRarity.toLowerCase() == "i"){
			connection.query('SELECT type, power, quantity FROM magic WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0){
					text = "*Incantesimi:*\n\n";
					var n = "";
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].type == 1){
							n = "Furia dei Mari";
						}else if (rows[i].type == 2){
							n = "Tempesta Folgorante";
						}else if (rows[i].type == 3){
							n = "Impeto di Fiamme";
						}else if (rows[i].type == 4){
							n = "Ira Astrale";
						}
						text = text + "> " + n + " " + rows[i].power + " (" + rows[i].quantity + ")\n";
					}
				}else{
					text = text + "Nessun incantesimo disponibile\n";
				}
				bot.sendMessage(message.chat.id, text, backPack);
			});
		}else{
			connection.query('SELECT inventory.player_id, item.name, item.craftable, rarity.id, rarity.name As rname, COUNT(item.name) As num FROM `inventory`, item, rarity WHERE player_id = ' + player_id + ' AND rarity.shortname = item.rarity AND inventory.item_id = item.id AND rarity = "' + soloRarity + '" GROUP BY item.name ORDER BY rarity.id DESC, item.name ASC', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0){
					text = "*" + rows[0].rname + "*:\n\n";

					for (i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].craftable == 0){
							rows[i].name = "*" + rows[i].name + "*";
						}
						text = text + "> " + rows[i].name + " (" + rows[i].num + ")\n";
					}
				}else{
					text = text + "Nessun oggetto di questa raritÃ  disponibile\n";
				}
				bot.sendMessage(message.chat.id, text, backPack);
			});
		}
	});
});

bot.onText(/^Classifica|^Top/i, function(message) {
	var kb = {
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [['Crafting','Settimanale'],['AbilitÃ ','Rango'],['Ricchezza','Draghi'],['Imprese Completate','Missioni'],['Per Livello'],['Collezione Artefatti'],['Torna al menu']]
		}
	};

	bot.sendMessage(message.chat.id, "Seleziona il tipo di classifica da visualizzare", kb);
});

bot.onText(/^Crafting/i, function(message) {
	getRank(message, 20, 0);
});

bot.onText(/^Settimanale/i, function(message) {
	getRank(message, 20, 1);
});

bot.onText(/^AbilitÃ $/i, function(message) {
	getRank(message, 20, 6);
});

bot.onText(/^Draghi$/i, function(message) {
	getRankDr(message, 20);
});

bot.onText(/^Rango$/i, function(message) {
	getRank(message, 20, 2);
});

bot.onText(/^Ricchezza$/i, function(message) {
	getRank(message, 20, 3);
});

bot.onText(/^Imprese Completate$/i, function(message) {
	getRank(message, 20, 4);
});

bot.onText(/^Missioni$/i, function(message) {
	getRank(message, 20, 5);
});

bot.onText(/^Collezione Artefatti$/i, function(message) {
	getRankArt(message, 100);
});

bot.onText(/^Per Livello$/i, function(message) {
	getRankLev(message, 20);
});

function getRank(message, size, type){
	var t = "craft_count";
	var tx = "sui punti creazione";
	var tval = "pnt";
	if (type == 1){
		t = "craft_week";
		tx = "sui punti creazione settimanali";
	} else if (type == 2){
		t = "rank";
		tx = "sui punti rango dungeon";
	} else if (type == 3){
		t = "money";
		tx = "sulla ricchezza attuale";
		tval = " Â§";
	} else if (type == 4){
		t = "achievement_count";
		tx = "sulle imprese completate";
	} else if (type == 5){
		t = "mission_count";
		tx = "sulle missioni completate";
	} else if (type == 6){
		t = "ability";
		tx = "sull'abilitÃ ";
	}

	var text = "Classifica basata " + tx + ":\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var mypos = 0;

	var banned_join = banlist_id.join();

	connection.query('SELECT nickname, ' + t + ' As points FROM player WHERE account_id NOT IN (' + banned_join + ') AND nickname != "LastSoldier95" AND nickname != "fenix45" GROUP BY nickname, ' + t + ', exp, weapon ORDER BY points DESC', function(err, rows, fields) {
		if (err) throw err;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			if (c < size+1){
				if (t = "money")
					rows[i].points = formatNumber(rows[i].points);
				text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].points + " " + tval + ")\n";
			}
			if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()){
				mypnt = rows[i].points;
				mypos = c;
			}
			c++;
		}
		text = text + "\nTu:\n" + mypos + "Â° " + message.from.username + " (" + mypnt + " " + tval + ")";

		var keyrank = {
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [['Top'],['Torna al menu']]
			}
		};

		bot.sendMessage(message.chat.id, text, keyrank);
	});
}

function getRankLev(message, size){
	var text = "Classifica basata sul livello:\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var mypos = 0;

	var banned_join = banlist_id.join();

	connection.query('SELECT nickname, exp, reborn, case reborn when 1 then FLOOR(exp/10) when 2 then FLOOR(exp/10)+100 when 3 then FLOOR(exp/10)+100+150 when 4 then FLOOR(exp/10)+100+150+200 when 5 then FLOOR(exp/10)+100+150+200+300 end as lev FROM player WHERE account_id NOT IN (' + banned_join + ') AND nickname != "LastSoldier95" AND nickname != "fenix45" ORDER BY lev DESC', function(err, rows, fields) {
		if (err) throw err;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			if (c < size+1){
				text = text + c + "Â° " + rows[i].nickname + " (" + Math.floor(rows[i].exp/10) + " R" + (rows[i].reborn-1) + ")\n";
			}
			if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()){
				mypnt = Math.floor(rows[i].exp/10) + " R" + (rows[i].reborn-1);
				mypos = c;
			}
			c++;
		}
		text = text + "\nTu:\n" + mypos + "Â° " + message.from.username + " (" + mypnt + ")";

		var keyrank = {
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [['Top'],['Torna al menu']]
			}
		};

		bot.sendMessage(message.chat.id, text, keyrank);
	});
}

function getRankDr(message, size){
	var text = "Classifica draghi:\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var myinfo = 0;

	var banned_join = banlist_id.join();

	connection.query('SELECT dragon.name, dragon.type, dragon.level, player.nickname FROM dragon, player WHERE player.account_id NOT IN (' + banned_join + ') AND player_id = player.id AND player_id != 1 AND player_id != 3 ORDER BY level DESC', function(err, rows, fields) {
		if (err) throw err;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			if (c < size+1){
				text = text + c + "Â° " + rows[i].name + " " + rows[i].type + " (" + rows[i].level + ", " + rows[i].nickname + ")\n";
			}
			if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()){
				mypnt = rows[i].points;
				myinfo = c + "Â° " + rows[i].name + " " + rows[i].type + " (" + rows[i].level + ", " + rows[i].nickname + ")\n";
			}
			c++;
		}
		text = text + "\nTu:\n" + myinfo;

		var keyrank = {
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [['Top'],['Torna al menu']]
			}
		};

		bot.sendMessage(message.chat.id, text, keyrank);
	});
};

function getRankArt(message, size){
	var text = "Classifica ottenimento artefatti:\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var myinfo = 0;

	var banned_join = banlist_id.join();

	connection.query('SELECT DISTINCT(name), player.nickname, COUNT(DISTINCT(name)) As tot FROM inventory_rarity, player WHERE player.id = inventory_rarity.player_id AND player.account_id NOT IN (' + banned_join + ') AND player.nickname != "fenix45" AND player.nickname != "LastSoldier95" AND name LIKE "Artefatto%" GROUP BY player.nickname HAVING COUNT(DISTINCT(name)) > 0 ORDER BY COUNT(DISTINCT(name)) DESC', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Ancora nessun giocatore ha ottenuto un artefatto", back);
			return;
		}

		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			if (c<31){
				if (c < size+1){
					text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].tot + "/5)\n";
				}
			}
			if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()){
				mypnt = rows[i].points;
				myinfo = c + "Â° " + rows[i].nickname + " (" + rows[i].tot + "/5)\n";
			}
			c++;
		}
		if (myinfo == "0"){
			myinfo = "Non possiedi artefatti";
		}
		text = text + "\nTu:\n" + myinfo;

		var keyrank = {
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [['Top'],['Torna al menu']]
			}
		};

		bot.sendMessage(message.chat.id, text, keyrank);
	});	
};

bot.onText(/negozio/i, function(message) {
	var oggetto = "";
	var iKeys = [];

	var price_drop = 0;
	var price_drop_msg = "";
	var n = new Date().getDay()
	var n2 = new Date().getDate();

	if (n == 0){
		if (n2 < 10){
			sconto = 20;
		}
		price_drop = 1;
		price_drop_msg = "*Oggi il prezzo Ã¨ ridotto del " + sconto + "%!*\n";
	}

	connection.query('SELECT id, holiday, money, account_id, mission_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		helpMsg(message.chat.id, player_id, 6);

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Compra","Vendi","Ricicla"],["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, price_drop_msg + "Hai a disposizione " + formatNumber(money) + " Â§, cosa vuoi fare?", kb).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text == "Compra"){
					connection.query('SELECT value, name FROM chest WHERE id < 7', function(err, rows, fields) {
						if (err) throw err;
						if (price_drop == 1){
							iKeys.push(["Compra Pozione Piccola (" + formatNumber(parseInt(1200-Math.round((1200/100)*sconto))) + " Â§)"]);
							iKeys.push(["Compra Pozione Media (" + formatNumber(parseInt(2400-Math.round((2400/100)*sconto))) + " Â§)"]);
							iKeys.push(["Compra Pozione Grande (" + formatNumber(parseInt(4800-Math.round((4800/100)*sconto))) + " Â§)"]);
							iKeys.push(["Compra Piuma di Fenice (" + formatNumber(parseInt(6000-Math.round((6000/100)*sconto))) + " Â§)"]);
							iKeys.push(["Compra Cenere di Fenice (" + formatNumber(parseInt(25000-Math.round((25000/100)*sconto))) + " Â§)"]);
							iKeys.push(["Compra Bevanda Energetica (" + formatNumber(parseInt(20000-Math.round((20000/100)*sconto))) + " Â§)"]);
							iKeys.push(["Compra Bevanda Energetica Plus (" + formatNumber(parseInt(38000-Math.round((38000/100)*sconto))) + " Â§)"]);
							iKeys.push(["Compra Gemma (150.000 Â§)"]);
						}else{
							iKeys.push(["Compra Pozione Piccola (1.200 Â§)"]);
							iKeys.push(["Compra Pozione Media (2.400 Â§)"]);
							iKeys.push(["Compra Pozione Grande (4.800 Â§)"]);
							iKeys.push(["Compra Piuma di Fenice (6.000 Â§)"]);
							iKeys.push(["Compra Cenere di Fenice (25.000 Â§)"]);
							iKeys.push(["Compra Bevanda Energetica (20.000 Â§)"]);
							iKeys.push(["Compra Bevanda Energetica Plus (38.000 Â§)"]);
							iKeys.push(["Compra Gemma (150.000 Â§)"]);
						}

						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (price_drop == 1){
								rows[i].value = rows[i].value-Math.round((rows[i].value/100)*sconto);
							}
							iKeys.push(["Compra " + rows[i].name + " (" + rows[i].value + " Â§)"]);
						}
						iKeys.push(["Torna al negozio"]);
						iKeys.push(["Torna al menu"]);

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, "Seleziona l'oggetto da acquistare.", kb);
					});
				}else if (answer.text == "Vendi"){
					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Valore < 200","Valore < 2000"],["Valore < 7000","Valore < 15000"],["Valore < 30000","Valore > 30000"],["Vendi C","Vendi NC"],["Vendi R","Vendi UR"],["Vendi L","Vendi E"],["Torna al negozio"],["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona una categoria", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {

							if (answer.text.indexOf("Valore") == -1){
								return;
							}

							var filter = answer.text.substring(answer.text.indexOf(" ")+1);
							if (filter == "< 200"){
								filter = "<= 200";
							}else if (filter == "< 2000"){
								filter = "<= 2000 AND value > 200";
							}else if (filter == "< 7000"){
								filter = "<= 7000 AND value > 2000";
							}else if (filter == "< 15000"){
								filter = "<= 15000 AND value > 7000";
							}else if (filter == "< 30000"){
								filter = "<= 30000 AND value > 15000";
							}else if (filter == "> 3000"){
								filter = "> 30000";
							}

							connection.query('SELECT item.value, item.name, COUNT(item.name) As Num FROM inventory, item WHERE value ' + filter + ' AND inventory.player_id=' + player_id + ' AND inventory.item_id = item.id GROUP BY item.name LIMIT 100', function(err, rows, fields) {
								if (err) throw err;
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									iKeys.push(["Vendi " + rows[i].name + " (" + rows[i].value + " Â§) posseduti: " + rows[i].Num]);
								}

								if (Object.keys(iKeys).length > 0){
									iKeys.push(["Torna al negozio"]);									
									iKeys.push(["Torna al menu"]);

									var kb = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											one_time_keyboard: true,
											"keyboard": iKeys
										}
									};

									bot.sendMessage(message.chat.id, "Seleziona l'oggetto da vendere", kb);
								}else{
									bot.sendMessage(message.chat.id, "Nessun oggetto nello zaino.", back);
								};
							});
						};
					});
				}
			};
		});
	});
});

bot.onText(/ricicla/i, function(message) {
	connection.query('SELECT id, holiday, money, account_id, mission_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		var kbR = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["C","NC","R"],["UR","L","E"],["Torna al negozio"],["Torna al menu"]]
			}
		};

		var iKeys = [];

		bot.sendMessage(message.chat.id, "Seleziona la raritÃ  dell'oggetto da riciclare", kbR).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				var r = answer.text;

				if ((r == "Torna al menu") || (r == "Torna al negozio")){
					return;
				}

				if ((r == "C") || (r == "NC") || (r == "R") || (r == "UR") || (r == "L") || (r == "E")){
					//kek
				}else{
					bot.sendMessage(message.chat.id, "RaritÃ  non valida", back);
					return;
				}

				connection.query('SELECT nickname, name, COUNT(name) AS quantity, rarity FROM `inventory_rarity` WHERE rarity = "' + r + '" AND nickname = "' + message.from.username + '" GROUP BY name, nickname HAVING COUNT(name) >= 5', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Non hai oggetti di raritÃ  " + r + " riciclabili.", back);
						return;
					}
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						iKeys.push([rows[i].name + " (" + rows[i].rarity + ", " + rows[i].quantity + ")"]);
					}

					iKeys.push(["Torna al negozio"]);
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					var kb2 = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Ricicla Ancora"],["Torna al menu"]]
						}
					};

					var kbC = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["Stessa RaritÃ "],["RaritÃ  Superiore"],["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona gli oggetti da riciclare, consumandone 5 riceverai un oggetto della stessa raritÃ , o superiore (in questo caso ti costerÃ  C: 500, NC: 750, R: 1000, UR: 1500 o L: 2000 Â§).", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var oggetto = answer.text;

							if ((oggetto == "Torna al menu") || (oggetto == "Torna al negozio")){
								return;
							}

							var pos = oggetto.indexOf("(");
							oggetto = oggetto.substr(0, pos-1);

							bot.sendMessage(message.chat.id, "Con quale modalitÃ  vuoi riciclare " + oggetto + "?", kbC).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if ((answer.text == "Stessa RaritÃ ") || (answer.text == "RaritÃ  Superiore")){
										connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;

											connection.query('SELECT item_id, name, COUNT(name) AS quantity, rarity FROM `inventory_rarity` WHERE nickname = "' + message.from.username + '" AND name = "' + oggetto + '" AND rarity = "' + r + '" GROUP BY name, nickname HAVING COUNT(name) >= 5', function(err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length == 0){
													bot.sendMessage(message.chat.id, "Non possiedi l'oggetto specificato.", back);
													return;
												}

												var rarity = rows[0].rarity;
												var nRarity = rarity;

												var price = 0;

												if (answer.text == "RaritÃ  Superiore"){
													if (nRarity == "C"){
														nRarity = "NC";
														price = 500;
													}else if (nRarity == "NC"){
														nRarity = "R";
														price = 750;
													}else if (nRarity == "R"){
														nRarity = "UR";
														price = 1000;
													}else if (nRarity == "UR"){
														nRarity = "L";
														price = 1500;
													}else if (nRarity == "L"){
														nRarity = "E";
														price = 2000;
													}else{
														bot.sendMessage(message.chat.id, "Non puoi riciclare questa raritÃ !", back);
														return;
													}
												}

												if (money < price){
													bot.sendMessage(message.chat.id, "Non hai abbastanza monete (" + price + " Â§)", back);
													return;
												}

												connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});

												setAchievement(message.chat.id, player_id, 15, 1);

												connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + rows[0].item_id + ' LIMIT 5', function(err, rows, fields) {
													if (err) throw err;
													connection.query('SELECT id, name FROM item WHERE rarity = "' + nRarity + '" AND name != "' + oggetto + '" AND craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
														if (err) throw err;
														var itemName = rows[0].name;
														connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + rows[0].id + ')', function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Hai riciclato gli oggetti e ricevuto *" + itemName + "* (" + nRarity + ")!", kb2);
														});
													});
												});
											});
										});
									};
								};
							});
						};
					});
				});
			};
		});
	});
});

bot.onText(/^vendi/i, function(message) {
	var oggetto = message.text.substring(message.text.indexOf(" ")+1);

	if (oggetto.indexOf("(") != -1){
		oggetto = oggetto.substring(0, oggetto.indexOf("(")-1);
	}

	if (message.text.toLowerCase() == "vendi"){
		return;
	}

	if (oggetto.trim() == ""){
		return;
	}

	var conf = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Conferma"],["Torna al negozio"]]
		}
	};
	var store = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna al negozio"]]
		}
	};

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["1"],["2"],["3"],["4"],["5"],["10"],["Torna al menu"]]
		}
	};


	if ((oggetto == "C") || (oggetto == "NC") || (oggetto == "R") || (oggetto == "UR") || (oggetto == "L") || (oggetto == "E")){
		connection.query('SELECT id, money, holiday FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
			if (err) throw err;

			var player_id = rows[0].id;
			if (rows[0].holiday == 1){
				bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
				return;
			}

			bot.sendMessage(message.chat.id, "Sei veramente sicuro di voler vendere tutto la raritÃ  " + oggetto + " al prezzo base?", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text.toLowerCase() == "si"){
						connection.query('SELECT SUM(item.value) As total FROM inventory, item WHERE inventory.item_id = item.id AND rarity = "' + oggetto + '" AND player_id=' + player_id, function(err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Non hai oggetti da vendere!", store);
								return;
							}

							var total = rows[0].total;

							if (crazyMode == 1){
								total = total+(total/100*10);
							}

							if (total == null){
								bot.sendMessage(message.chat.id, "Non hai oggetti da vendere!", store);
								return;
							}

							bot.sendMessage(message.chat.id, "Prezzo calcolato: " + total + " Â§, continuare?", yesno).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text.toLowerCase() == "si"){
										connection.query('SELECT SUM(item.value) As total FROM inventory, item WHERE inventory.item_id = item.id AND rarity = "' + oggetto + '" AND player_id=' + player_id, function(err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length == 0){
												bot.sendMessage(message.chat.id, "Non hai oggetti da vendere!", store);
												return;
											}

											total = rows[0].total;

											if (crazyMode == 1){
												total = total+(total/100*10);
											}

											console.log("ZAINO VENDUTO PER " + total);

											connection.query('DELETE inventory FROM inventory, item WHERE inventory.item_id = item.id AND rarity = "' + oggetto + '" AND player_id=' + player_id, function(err, rows, fields) {
												if (err) throw err;
												connection.query('UPDATE player SET money = money + ' + total + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai venduto tutta la raritÃ  *" + oggetto + "* per *" + total + "* Â§!", store);
												});
											});
										});
									}
								}
							});
						});
					}
				}
			});
		});
		return;
	}

	bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di " + oggetto + " da vendere", kb).then(function() {
		answerCallbacks[message.chat.id] = function(answer) {
			var quantity = parseInt(answer.text);
			if ((quantity <= 0) || (isNaN(quantity)) || (re.test(quantity) == false)){
				bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
				return;
			}
			connection.query('SELECT id, holiday, money, account_id, mission_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
				if (err) throw err;

				var account_id = (rows[0].account_id).toString();
				if (banlist_id.indexOf(account_id) != -1){
					var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
					bot.sendMessage(message.chat.id, text, mark);
					return;
				}
				if (rows[0].holiday == 1){
					bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
					return;
				}

				var player_id = rows[0].id;
				var money = parseInt(rows[0].money);

				connection.query('SELECT item.name, item.id, item.value FROM item, inventory WHERE inventory.item_id = item.id AND item.name="' + oggetto + '" AND inventory.player_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Oggetto non valido.", store);
						return;
					}
					if (Object.keys(rows).length < quantity){
						bot.sendMessage(message.chat.id, "Non hai abbastanza oggetti", store);
						return;
					}
					var item_id = rows[0].id;
					var itemName = rows[0].name;
					var singleValue = parseInt(rows[0].value);
					var value = parseInt(rows[0].value)*quantity;

					if (crazyMode == 1){
						value = value+(value/100*10);
					}

					setAchievement(message.chat.id, player_id, 7, value);

					var newmoney = money+value;

					connection.query('UPDATE `player` SET `money`=' + newmoney + ' WHERE `nickname`="' + message.from.username + '"', function(err, rows, fields) {
						if (err) throw err;
					});

					//console.log(player_id, item_id);

					var d = new Date();
					var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
					for (var i = 0; i < quantity; i++) {
						connection.query('INSERT INTO market_direct_history(item_id, price, time, from_id, to_id, buyer, type) VALUES (' + item_id + ',' + singleValue + ',"' + long_date + '",' + player_id + ',0,"Negozio",3)', function(err, rows, fields) {
							if (err) throw err;
						});
					};

					connection.query('DELETE FROM `inventory` WHERE `player_id`=' + player_id + ' AND `item_id`=' + item_id + ' LIMIT ' + quantity, function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Hai venduto " + quantity + "x " + itemName + " per " + value + " Â§!", store);
					});
				});
			});
		};
	});
});

bot.onText(/compra/i, function(message) {
	connection.query('SELECT * FROM player WHERE `nickname` = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var money = rows[0].money;
		var player_id = rows[0].id;

		var oggetto = message.text.substring(message.text.indexOf(" ")+1);
		var price_drop = 0;
		var n = new Date().getDay()
		var n2 = new Date().getDate();

		if (n == 0){
			if (n2 < 10){
				sconto = 20;
			}
			price_drop = 1;
		}

		if (message.text.indexOf("(") == -1){
			return;
		}

		if ((oggetto == "") || (oggetto == " ")){
			return;
		}

		var store = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Torna al negozio"],["Torna al menu"]]
			}
		};

		var pos = oggetto.indexOf("(");
		if (pos != -1){
			oggetto = oggetto.substr(0, pos-1);
		}

		connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 7', function(err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0){
				abBonus = rows[0].ability_level*2;

				var rand = Math.random()*100;
				if (rand < abBonus){
					abBonus = 1;
				}
			}

			if (oggetto.indexOf("Scrigno") != -1){
				connection.query('SELECT value, id FROM chest WHERE `name`="' + oggetto + '" AND id < 7', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Scrigno non valido.", store);
						return;
					}
					var chest_id = rows[0].id;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["1"],["2"],["3"],["4"],["5"],["10"],["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di scrigni da acquistare", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var quantity = answer.text;
							if (quantity == "Torna al menu"){
								return;
							}
							if ((quantity < 1) || (re.test(quantity) == false)){
								bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
								return;
							}

							var price = rows[0].value;

							if (price_drop == 1){
								price -= Math.round((rows[0].value/100)*sconto);
							}

							quantity = Math.floor(quantity);
							price = price*parseInt(quantity);

							if (money-price < 0){
								bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
								return;
							}

							var bonus_text = "";
							if (abBonus == 1){
								price = Math.round(price/2);
								bonus_text = " grazie al tuo talento!";
							}

							setAchievement(message.chat.id, player_id, 14, quantity, chest_id);

							connection.query('UPDATE `player` SET `money`=money-' + price + ' WHERE `nickname`="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								for (var i = 0; i < quantity; i++) {
									connection.query('INSERT INTO `inventory_chest`(`player_id`, `chest_id`) VALUES (' + player_id + ',' + chest_id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
								};
								bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
							});
						};
					});
				});
			}else if (oggetto.indexOf("Pozione") != -1){
				if (crazyMode == 1){
					bot.sendMessage(message.chat.id, "Non puoi acquistare pozioni durante il weekend folle", back);
					return;
				}
				connection.query('SELECT id FROM item WHERE `name`="' + oggetto + '"', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Pozione non valida.", store);
						return;
					}
					var potion_id = rows[0].id;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["1"],["2"],["3"],["4"],["5"],["10"],["Torna al menu"]]
						}
					};


					bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di pozioni da acquistare", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var quantity = answer.text;
							if (quantity == "Torna al menu"){
								return;
							}
							if ((quantity < 1) || (re.test(quantity) == false)){
								bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
								return;
							}

							quantity = parseInt(quantity);
							quantity = Math.floor(quantity);

							var value = 0;
							if (potion_id == "92"){
								value = 1200;
							}else if (potion_id == "93"){
								value = 2400;
							}else if (potion_id == "94"){
								value = 4800;
							}else{
								bot.sendMessage(message.chat.id, "Errore sconosciuto", store);
								return;
							}

							var price = parseInt(value);

							if (price_drop == 1){
								price -= Math.round(value/100)*sconto;
							}

							price = price*quantity;

							if (money-price < 0){
								bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
								return;
							}

							var bonus_text = "";
							if (abBonus == 1){
								price = Math.round(price/2);
								bonus_text = " grazie al tuo talento!";
							}

							connection.query('UPDATE `player` SET `money`=money-' + price + ' WHERE `nickname`="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								for (var i = 0; i < quantity; i++) {
									connection.query('INSERT INTO `inventory`(`player_id`, `item_id`) VALUES (' + player_id + ',' + potion_id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
								};
								bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
							});
						};
					});
				});
			}else if (oggetto.indexOf("Bevanda Energetica") != -1){
				if (crazyMode == 1){
					bot.sendMessage(message.chat.id, "Non puoi acquistare bevande durante il weekend folle", back);
					return;
				}
				bot.sendMessage(message.chat.id, "Acquistare? La bevanda verrÃ  attivata immediatamente! Attento, se hai una bevanda (di qualsiasi tipo) giÃ  attiva, l'acquisto della nuova la rimpiazzerÃ .", yesno).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text.toLowerCase() == "si"){
							var price = 20000;
							var missions = 3;

							if (oggetto.indexOf("Plus") != -1){
								price = 38000;
								missions = 6;
							}

							if (price_drop == 1){
								price -= Math.round((price/100)*sconto);
							}

							if (money-price < 0){
								bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
								return;
							}

							var bonus_text = "";
							if (abBonus == 1){
								price = Math.round(price/2);
								bonus_text = " grazie al tuo talento!";
							}

							if (oggetto.indexOf("Plus") == -1){
								setAchievement(message.chat.id, player_id, 16, 1);
							}

							connection.query('UPDATE `player` SET `money`=money-' + price + ' WHERE id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								connection.query('UPDATE `player` SET `boost_id`=1,`boost_mission` = ' + missions + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
								});
							});				
						}
					};
				});
			}else if ((oggetto.indexOf("Piuma di Fenice") != -1) || (oggetto.indexOf("Cenere di Fenice") != -1)){
				if (crazyMode == 1){
					bot.sendMessage(message.chat.id, "Non puoi acquistare piume o cenere durante il weekend folle", back);
					return;
				}
				connection.query('SELECT id, name FROM item WHERE `name`="' + oggetto + '"', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Oggetto non valido.", store);
						return;
					}
					var item_id = rows[0].id;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["1"],["2"],["3"],["4"],["5"],["10"],["Torna al menu"]]
						}
					};

					var name = rows[0].name;
					bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di " + name + " da acquistare", kb).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var quantity = answer.text;
							if (quantity == "Torna al menu"){
								return;
							}
							if ((quantity < 1) || (re.test(quantity) == false)){
								bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
								return;
							}

							quantity = parseInt(quantity);
							quantity = Math.floor(quantity);

							var value = 0;
							if (name == "Piuma di Fenice"){
								value = 6000;
							}else if (name == "Cenere di Fenice"){
								value = 25000;
							}
							var price = parseInt(value);

							if (price_drop == 1){
								price -= Math.round(value/100)*sconto;
							}

							price = price*quantity;

							if (money-price < 0){
								bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
								return;
							}

							var bonus_text = "";
							if (abBonus == 1){
								price = Math.round(price/2);
								bonus_text = " grazie al tuo talento!";
							}

							if (name == "Piuma di Fenice"){
								setAchievement(message.chat.id, player_id, 17, quantity);
							}

							connection.query('UPDATE `player` SET `money`=money-' + price + ' WHERE `nickname`="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								for (var i = 0; i < quantity; i++) {
									connection.query('INSERT INTO `inventory`(`player_id`, `item_id`) VALUES (' + player_id + ',' + item_id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
								};
								bot.sendMessage(message.chat.id, "Acquisto di " + quantity + "x " + name + " completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
							});
						};
					});
				});
			}else if (oggetto.indexOf("Gemma") != -1){
				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["1"],["2"],["3"],["4"],["5"],["10"],["Torna al menu"]]
					}
				};

				if (player_id != 1){
					var d = new Date();
					if (d.getDay != 3){
						if ((d.getHours < 9) || (d.getHours > 12)){
							bot.sendMessage(message.chat.id, "Le gemme possono essere acquistate solamente il mercoledÃ¬ mattina (9-12)", store);
							return;
						}
					}
				}

				bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di gemme da acquistare", kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						var quantity = answer.text;
						if (quantity == "Torna al menu"){
							return;
						}
						if ((quantity < 1) || (re.test(quantity) == false)){
							bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
							return;
						}

						quantity = parseInt(quantity);
						quantity = Math.floor(quantity);

						var value = 150000;
						var price = parseInt(value);

						if (price_drop == 1){
							//	price -= Math.round(value/100)*sconto;
						}

						price = price*quantity;

						if (money-price < 0){
							bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
							return;
						}

						var bonus_text = "";
						if (abBonus == 1){
							price = Math.round(price/2);
							bonus_text = " grazie al tuo talento!";
						}

						connection.query('UPDATE player SET money = money-' + price + ', gems = gems + ' + quantity + ' WHERE id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
						});
					};
				});
			}
		});
	});
});

bot.onText(/^Artefatti/i, function(message) {
	//if (message.from.username != "fenix45"){
	//	bot.sendMessage(message.chat.id, "Non Ã¨ ancora giunto il momento giovane xxxawan!", back);
	//	return;
	//}

	var artifacts = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Artefatto Fiammeggiante"],["Artefatto Elettrico"],["Artefatto Tempesta"],["Artefatto Buio"],["Artefatto Divinatorio"],["Torna al menu"]]
		}
	};

	var get = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Ottieni Artefatto"],["Torna al menu"]]
		}		
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;

		if (rows[0].reborn < 4){
			bot.sendMessage(message.chat.id, "Per accedere agli artefatti devi aver raggiunto almeno la Rinascita 3", back);
			return;
		}

		connection.query('SELECT COUNT(id) As cnt FROM artifacts WHERE player_id = ' + player_id, function (err, rows, fields){
			if (err) throw err;

			if (rows[0].cnt == 5){
				bot.sendMessage(message.chat.id, "Hai ottenuto tutti gli Artefatti!", back);
				return;
			}

			bot.sendMessage(message.chat.id, 	"Gli ArtefattiðŸŒŸ sono degli strumenti di *incredibile potenza*, che una volta uniti insieme possono fornire una forza sovraumana.\n" +
							"Tuttavia per ottenerli Ã¨ necessario completare diverse *'prove'* riservate solo ai migliori combattenti.\n" +
							"A quale artefatto vuoi aspirare?", artifacts).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "Artefatto Fiammeggiante"){
						bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi raggiungere 125 punti dungeon e possedere 5.000.000 Â§, questi ultimi ti verranno sottratti per completare il rituale.", get).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if (answer.text == "Ottieni Artefatto"){
									connection.query('SELECT id FROM artifacts WHERE item_id = 614 AND player_id = ' + player_id, function (err, rows, fields){
										if (err) throw err;

										if (Object.keys(rows).length > 0){
											bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
											return;
										}

										connection.query('SELECT * FROM player WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;

											var money = rows[0].money;
											var rank = rows[0].rank;

											if (money < 5000000){
												bot.sendMessage(message.chat.id, "Non hai abbastanza monete (" + formatNumber(money) + "/5.000.000)", back);
												return;
											}

											if (rank < 125){
												bot.sendMessage(message.chat.id, "Non hai abbastanza punti rango (" + rank + "/125)", back);
												return;
											}

											connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',614)', function (err, rows, fields){
												if (err) throw err;
												connection.query('UPDATE player SET money = money - ' + 5000000 + ' WHERE id = ' + player_id, function (err, rows, fields){
													if (err) throw err;
													connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',614)', function (err, rows, fields){
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Fiammeggiante*!", back);
													});
												});
											});
										});
									});
								}
							}
						});
					}else if (answer.text == "Artefatto Elettrico"){
						connection.query('SELECT id FROM artifacts WHERE item_id = 614 AND player_id = ' + player_id, function (err, rows, fields){
							if (err) throw err;

							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Fiammeggiante*!", back);
								return;
							}

							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi raggiungere 10.000 punti creazione, il drago al livello 100 e possedere 15.000.000 Â§, questi ultimi ti verranno sottratti per completare il rituale.", get).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Ottieni Artefatto"){
										connection.query('SELECT id FROM artifacts WHERE item_id = 615 AND player_id = ' + player_id, function (err, rows, fields){
											if (err) throw err;

											if (Object.keys(rows).length > 0){
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('SELECT level FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;

												if ((Object.keys(rows).length > 0) && (rows[0].level < 100)){
													bot.sendMessage(message.chat.id, "Il tuo drago non Ã¨ ad un livello abbastanza alto", back);
													return;
												}

												connection.query('SELECT * FROM player WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;

													var money = rows[0].money;
													var craft_count = rows[0].craft_count;

													if (money < 15000000){
														bot.sendMessage(message.chat.id, "Non hai abbastanza monete (" + formatNumber(money) + "/15.000.000)", back);
														return;
													}

													if (craft_count < 10000){
														bot.sendMessage(message.chat.id, "Non hai abbastanza punti creazione (" + craft_count + "/10.000)", back);
														return;
													}

													connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',615)', function (err, rows, fields){
														if (err) throw err;
														connection.query('UPDATE player SET money = money - ' + 15000000 + ' WHERE id = ' + player_id, function (err, rows, fields){
															if (err) throw err;
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',615)', function (err, rows, fields){
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Elettrico*!", back);
															});
														});
													});
												});
											});
										});
									}
								}
							});
						});
					}else if (answer.text == "Artefatto Tempesta"){
						connection.query('SELECT id FROM inventory WHERE item_id = 615 AND player_id = ' + player_id, function (err, rows, fields){
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Elettrico*!", back);
								return;
							}
							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi portare al livello 10 almeno 5 Talenti, possedere 20 Gemme (verranno consumate) e raggiungere le 100 Imprese completate.", get).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Ottieni Artefatto"){
										connection.query('SELECT id FROM artifacts WHERE item_id = 644 AND player_id = ' + player_id, function (err, rows, fields){
											if (err) throw err;

											if (Object.keys(rows).length > 0){
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('SELECT COUNT(id) As num FROM ability WHERE player_id = ' + player_id + ' AND ability_level = 10', function(err, rows, fields) {
												if (err) throw err;

												if (rows[0].num < 5){
													bot.sendMessage(message.chat.id, "I Talenti non sono ancora ad un livello sufficiente", back);
													return;
												}

												connection.query('SELECT * FROM player WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;

													if (rows[0].achievement_count < 100){
														bot.sendMessage(message.chat.id, "Non hai abbastanza punti imprese (" + rows[0].achievement_count + "/100)", back);
														return;
													}

													if (rows[0].gems < 20){
														bot.sendMessage(message.chat.id, "Non hai abbastanza gemme (" + rows[0].gems + "/20)", back);
														return;
													}

													connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',644)', function (err, rows, fields){
														if (err) throw err;
														connection.query('UPDATE player SET gems = gems - ' + 20 + ' WHERE id = ' + player_id, function (err, rows, fields){
															if (err) throw err;
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',644)', function (err, rows, fields){
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Tempesta*!", back);
															});
														});
													});
												});
											});
										});
									}
								}
							});
						});
					}else if (answer.text == "Artefatto Buio"){
						connection.query('SELECT id FROM inventory WHERE item_id = 644 AND player_id = ' + player_id, function (err, rows, fields){
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Tempesta*!", back);
								return;
							}
							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi aver completato 1000 missioni, vinto 400 ispezioni (effettuate o respinte), e ottenuto 300 Polvere (S).", get).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Ottieni Artefatto"){
										connection.query('SELECT id FROM artifacts WHERE item_id = 648 AND player_id = ' + player_id, function (err, rows, fields){
											if (err) throw err;

											if (Object.keys(rows).length > 0){
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('SELECT mission_count FROM player WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;

												if (rows[0].mission_count < 1000){
													bot.sendMessage(message.chat.id, "Non hai completato abbastanza missioni (" + rows[0].mission_count + "/1000)", back);
													return;
												}

												connection.query('SELECT from_id, COUNT(from_id) As cnt FROM heist_history WHERE from_id = ' + player_id + ' AND fail = 0', function(err, rows, fields) {
													if (err) throw err;

													var cnt = 0;
													cnt = parseInt(rows[0].cnt);

													connection.query('SELECT to_id, COUNT(to_id) As cnt FROM heist_history WHERE to_id = ' + player_id + ' AND fail > 0', function(err, rows, fields) {
														if (err) throw err;

														cnt = cnt + parseInt(rows[0].cnt);
														if (cnt < 400){
															bot.sendMessage(message.chat.id, "Non hai vinto abbastanza ispezioni (" + cnt + "/400)", back);
															return;
														}

														connection.query('SELECT COUNT(*) As qnt FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 646', function (err, rows, fields){
															if (err) throw err;

															if (rows[0].qnt < 300){
																bot.sendMessage(message.chat.id, "Non hai raccolto abbastanza polvere (" + rows[0].cnt + "/300)", back);
																return;
															}

															connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',648)', function (err, rows, fields){
																if (err) throw err;
																connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 646 LIMIT 300', function (err, rows, fields){
																	if (err) throw err;
																	connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',648)', function (err, rows, fields){
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Buio*!", back);
																	});
																});
															});
														});
													});
												});
											});
										});
									}
								}
							});
						});
					}else if (answer.text == "Artefatto Divinatorio"){
						connection.query('SELECT id FROM inventory WHERE item_id = 648 AND player_id = ' + player_id, function (err, rows, fields){
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Buio*!", back);
								return;
							}

							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi:\n" +
											"> Raggiungere il livello 1000\n" +
											"> Aver completato almeno 500 dungeon\n" +
											"> Aver completato 20 scalate complete nello stesso team\n" +
											"> Aver partecipato e aiutato a vincere 3 imprese globali\n\n" +
											"L'artefatto Ã¨ pronto ma non puÃ² essere ancora ottenuto in quanto potrebbe essere aggiornato lievemente", get).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Ottieni Artefatto"){

										if (message.from.username != "fenix45"){
											bot.sendMessage(message.chat.id, "L'artefatto Ã¨ pronto ma non puÃ² essere ancora ottenuto in quanto potrebbe essere aggiornato lievemente, pazienta", back);
											return;
										}

										connection.query('SELECT id FROM artifacts WHERE item_id = 675 AND player_id = ' + player_id, function (err, rows, fields){
											if (err) throw err;

											if (Object.keys(rows).length > 0){
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',675)', function (err, rows, fields){
												if (err) throw err;
												connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',675)', function (err, rows, fields){
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Divinatorio*!", back);
												});
											});
										});
									}
								}
							});
						});
					}
				}
			});
		});
	});
});

bot.onText(/^Edificio Abbandonato/i, function(message) {
	connection.query('SELECT id, lore_page FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields){
		if (err) throw err;

		var next = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Indaga oltre"],["Torna al menu"]]
			}		
		};

		var prev = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["DÃ©jÃ  vu"],["Torna al menu"]]
			}		
		};

		var house = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Edificio Abbandonato"],["Torna al menu"]]
			}		
		};


		var page = rows[0].lore_page;
		var player_id = rows[0].id;

		if (page == 0){
			bot.sendMessage(message.chat.id, 	"Vi Ã¨, in lontananza, un edificio che non avevi mai scorto prima di adesso; una strana forza magica ti attrae verso quel posto. Ti ci dirigi, per scoprire i segreti celati dietro a tale edificio.\n" +
							"Esso Ã¨ fatto da Assi di Legno Lavorato, disposte in modo asimmetrico, e dai buchi che vi si formano si intravedono macabri tavoli vuoti. La porta Ã¨ barricata con altre Assi di Legno, e di fronte a essa vi Ã¨ affisso un cartello; la scritta, perÃ², Ã¨ completamente erosa dal tempo, e vi si legge una sola parola: Lore.\n" +
							"L'insieme di questi aspetti ti fa pienamente comprendere che quest'edificio sia abbandonato da molti anni, e nonostante il tuo istinto d'avventuriero ti dica che il suddetto posto celi dei macabri misteri, decidi di non indagare oltre.", next).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "Indaga oltre"){
						connection.query('UPDATE player SET lore_page = 1 WHERE id = ' + player_id, function (err, rows, fields){
							if (err) throw err;
							bot.sendMessage(message.chat.id, "...", house);
						});
					}
				}
			});
		}else{	//Importante che l'ultima sia else e non abbia update
			bot.sendMessage(message.chat.id,	"Un sol monito, pregno di ignoto, ne sovrasta la fragile entrata:\n\n'In missione, erra per effimeri sempiterni'.", prev).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "DÃ©jÃ  vu"){
						connection.query('UPDATE player SET lore_page = 0 WHERE id = ' + player_id, function (err, rows, fields){
							if (err) throw err;
							bot.sendMessage(message.chat.id, "...", house);
						});
					}
				};
			});
		}

	});
});

bot.onText(/^Albero Talenti$|Albero/i, function(message) {

	var next = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Albero Talenti"],["Torna al menu"]]
		}		
	};

	var prev = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Torna all'Albero"],["Torna al menu"]]
		}		
	};

	var ability_pot = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Conferma"],["Torna all'Albero"]]
		}		
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var my_money = rows[0].money;
		var iKeys = [];

		if ((Math.floor(rows[0].exp/10) < 50) && (rows[0].reborn == 1)){
			bot.sendMessage(message.chat.id, "Devi aver raggiunto almeno il livello 50 per accedere a questa funzionalitÃ ", back);
			return;
		}

		connection.query('SELECT ability.ability_id, ability.ability_level, ability_list.name, ability_list.val, ability_list.det FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			var ablist = "";
			var abarr = [];
			var abname = [];

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				ablist += "> " + rows[i].name + " (Livello " + rows[i].ability_level + ", " + (rows[i].ability_level*rows[i].val) + " " + rows[i].det + ")\n";
				abarr[rows[i].ability_id] = rows[i].ability_level;
			}

			connection.query('SELECT name, id FROM ability_list', function(err, rows, fields) {
				if (err) throw err;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					iKeys.push([rows[i].name]);
					abname[rows[i].id] = rows[i].name;
				}
				iKeys.push(["Torna al menu"]);

				var ability_list = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				bot.sendMessage(message.chat.id, "Seleziona il Talento da apprendere o potenziare\n" + ablist, ability_list).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text == "Torna al menu"){
							return;
						}
						connection.query('SELECT * FROM ability_list WHERE name = "' + answer.text + '"', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Talento non valido", prev);
								return;
							}

							var ability_id = rows[0].id;
							var ability_desc = rows[0].description;
							var ability_prev = rows[0].prev;
							var ability_name = rows[0].name;

							if (ability_prev != 0){
								if (abarr[ability_prev] == undefined){
									bot.sendMessage(message.chat.id, "Questo Talento richiede prima il potenziamento di: " + abname[ability_prev], prev);
									return;
								}else{
									if (abarr[ability_prev] < 10){
										bot.sendMessage(message.chat.id, "Questo Talento richiede prima il potenziamento al livello massimo di: " + abname[ability_prev], prev);
										return;
									}
								}
							}

							connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = ' + ability_id, function(err, rows, fields) {
								if (err) throw err;

								var text = "Caratteristiche Talento " + ability_name + " :\n" + ability_desc;
								var text2 = "";
								var text3 = "\n\nFornisce: ";
								var text4 = "\nLivello massimo: ";
								var money = 0;
								var itemid = 0;
								var itemqnt = 0;
								var learn = "apprendere questo talento";
								var level = 0;
								var forlevel = "per livello talento";

								if (Object.keys(rows).length > 0){
									level = parseInt(rows[0].ability_level);
									learn = "potenziare questo talento al livello " + (level+1);
								}

								if (ability_id == 1){			// 1% ogni livello
									text3 += "+1% " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level == 0){
										money = 300000;
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Scheggia di Hatrurite";
										itemid = 91;
									}else if (level == 1){
										money = 400000;
										itemqnt = 2;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Scheggia di Palladio";
										itemid = 151;
									}else if (level >= 2){
										money = 500000;
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Componente Ultra Cristallo";
										itemid = 562;
									}
								}else if (ability_id == 2){		// 100 monete ogni livello
									text3 += "+100 Â§ " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 10){
										money = 5000*(level+1);
										itemqnt = (level+1);
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Ala della Fenice";
										itemid = 345;
									}
								}else if (ability_id == 3){		// -30 secondi ogni livello
									text3 += "-30 secondi " + forlevel + " (dimezzato durante l'evento folle)";
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 10){
										money = 50000*(level+1);
										itemqnt = (level*2);
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Lama Maledetta";
										itemid = 104;
									}
								}else if (ability_id == 4){		// +2% riuscita ispezione
									text3 += "+2% riuscita ispezione " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 5){
										money = 50000*(level+1);
										itemqnt = (level*2);
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Sfera Tempesta";
										itemid = 296;
									}else if (level < 10){
										money = 25000*(level+1);
										itemqnt = (level*2);
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Spirito di Palladio";
										itemid = 357;								
									}
								}else if (ability_id == 5){
									text3 += "+2% monete " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 5){
										money = 30000*(level+1);
										itemqnt = level;
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Frammento Divino";
										itemid = 190;
									}else if (level < 10){
										money = 20000*(level+1);
										itemqnt = (level*2);
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Nucleo Supernova";
										itemid = 565;					
									}
								}else if (ability_id == 6){
									text3 += "+3% salute recuperata, +10% probabilitÃ  " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 3){
										money = 500000*(level+1);
										itemqnt = 2;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Respiro di Morte";
										itemid = 201;
									}else if (level < 6){
										money = 500000*(level+1);
										itemqnt = 2;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Urlo di Morte";
										itemid = 532;
									}else if (level < 8){
										money = 500000*(level+1);
										itemqnt = 2;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Soffio di Morte";
										itemid = 598;
									}else if (level < 10){
										money = 500000*(level+1);
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Necronucleo";
										itemid = 200;					
									}
								}else if (ability_id == 7){
									text3 += "+2% probabilitÃ  di dimezzare " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 1){
										money = 50000*(level+1);
										itemqnt = 50;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Cuscino";
										itemid = 10;
									}else if (level < 2){
										money = 50000*(level+1);
										itemqnt = 40;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Molla";
										itemid = 11;
									}else if (level < 3){
										money = 50000*(level+1);
										itemqnt = 30;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Metallo";
										itemid = 23;
									}else if (level < 4){
										money = 50000*(level+1);
										itemqnt = 30;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Carta";
										itemid = 1;
									}else if (level < 6){
										money = 50000*(level+1);
										itemqnt = 30;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Cordino Fragile";
										itemid = 5;
									}else if (level < 8){
										money = 50000*(level+1);
										itemqnt = 25;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Diamante";
										itemid = 9;
									}else if (level < 10){
										money = 50000*(level+1);
										itemqnt = 25;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Pietra del Sangue";
										itemid = 20;
									}
								}else if (ability_id == 8){
									text3 += "+3% probabilitÃ  di evoluzione pietra " + forlevel;
									text4 += "5";
									if (level >= 5){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 1){
										money = 50000*(level+1);
										itemqnt = 3;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Rubino del Dio Vulcano";
										itemid = 451;
									}else if (level < 2){
										money = 50000*(level+1);
										itemqnt = 2;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Pendolo";
										itemid = 403;
									}else if (level < 4){
										money = 50000*(level+1);
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Spirito del Fato";
										itemid = 288;
									}else if (level < 5){
										money = 50000*(level+1);
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Struttura della Piramide Meteorite";
										itemid = 427;
									}
								}else if (ability_id == 9){
									text3 += "+5% probabilitÃ  di raddoppio " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 5){
										money = 15000*(level+1);
										itemqnt = (level+1);
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Propulsore X";
										itemid = 202;
									}else if (level < 10){
										money = 15000*(level+1);
										itemqnt = (level+1)-5;
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Generatore del Vuoto";
										itemid = 321;
									}
								}else if (ability_id == 10){
									text3 += "+2% probabilitÃ  " + forlevel;;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 5){
										money = 20000*(level+1);
										itemqnt = (level+1);
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Anima delle Ere";
										itemid = 317;
									}else if (level < 10){
										money = 30000*(level+1);
										itemqnt = (level+1)-5;
										if (itemqnt == 0){
											itemqnt = 1;
										}
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Batteria Infinita";
										itemid = 479;
									}
								}else if (ability_id == 11){
									text3 += "+1% " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 10){
										money = 30000*(level+1);
										itemqnt = (level+1);
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Plutonio";
										itemid = 238;
									}
								}else if (ability_id == 12){
									text3 += "2% " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 5){
										money = 30000*(level+1);
										itemqnt = (level+1);
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Lama Celeste";
										itemid = 102;
									}else if (level < 10){
										money = 35000*(level+1);
										itemqnt = (level+1);
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Manico Diabolico";
										itemid = 103;
									}
								}else if (ability_id == 13){
									text3 += "+10 " + forlevel;
									text4 += "10";
									if (level >= 10){
										bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
										return;
									}
									if (level < 3){
										money = 10000*(level+1);
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Respiro di Morte";
										itemid = 201;
									}else if (level < 6){
										money = 10000*(level+1);
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Urlo di Morte";
										itemid = 532;
									}else if (level < 8){
										money = 10000*(level+1);
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Soffio di Morte";
										itemid = 598;
									}else if (level < 10){
										money = 10000*(level+1);
										itemqnt = 1;
										text2 += "\n> " + formatNumber(money) + " Â§";
										text2 += "\n> " + itemqnt + "x Necronucleo";
										itemid = 200;					
									}
								}else{
									bot.sendMessage(message.chat.id, "Talento non valido", prev);
									return;
								}

								bot.sendMessage(message.chat.id, text + "\n\nPer " + learn + " sono necessari:" + text2 + text3 + text4, ability_pot).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {
										if (answer.text.toLowerCase() == "conferma"){
											connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;

												if (rows[0].money - money < 0){
													bot.sendMessage(message.chat.id, "Non hai abbastanza monete", prev);
													return;
												}

												connection.query('SELECT id, COUNT(*) As num FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemid, function(err, rows, fields) {
													if (err) throw err;

													if (rows[0].num < itemqnt){
														bot.sendMessage(message.chat.id, "Non hai abbastanza oggetti necessari", prev);
														return;
													}

													setAchievement(message.chat.id, player_id, 18, 1);

													connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;

														connection.query('SELECT * FROM ability WHERE player_id = ' + player_id + ' AND ability_id = ' + ability_id, function(err, rows, fields) {
															if (err) throw err;

															if (Object.keys(rows).length > 0){
																connection.query('UPDATE ability SET ability_level = ability_level+1 WHERE player_id = ' + player_id + ' AND ability_id = ' + ability_id, function(err, rows, fields) {
																	if (err) throw err;
																	connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemid + ' LIMIT ' + itemqnt, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Talento potenziato! Livello: *" + level + " -> " + (level+1) + "*", prev);
																	});
																});
															}else{
																connection.query('INSERT INTO ability (player_id, ability_level, ability_id) VALUES (' + player_id + ',1,' + ability_id + ')', function(err, rows, fields) {
																	if (err) throw err;
																	connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemid + ' LIMIT ' + itemqnt, function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Talento appreso!", prev);
																	});
																});
															}
														});
													});
												});
											});
										}
									};
								});
							});
						});
					};
				});
			});
		});
	});
});

bot.onText(/equipaggia/i, function(message) {

	var equip = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Equipaggia Ancora"],["Torna allo zaino"],["Torna al menu"]]
		}
	};

	var oggetto = message.text.substring(message.text.indexOf(" ")+1, message.text.lenght);
	if ((message.text.indexOf(" ") != -1) && (oggetto != "Ancora")){
		connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
			if (err) throw err;

			var account_id = (rows[0].account_id).toString();
			if (banlist_id.indexOf(account_id) != -1){
				var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
				bot.sendMessage(message.chat.id, text, mark);
				return;
			}

			var player_id = rows[0].id;
			var player_reborn = rows[0].reborn;
			var player_level = Math.floor(rows[0].exp/10);

			if (rows[0].holiday == 1){
				bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
				return;
			}

			bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var resp = answer.text;
					if (resp.toLowerCase() != "si"){
						return;
					}

					oggetto = oggetto.toLowerCase();

					if (oggetto.indexOf("talismano") != -1){
						connection.query('SELECT * FROM player WHERE charm_id != 0 AND id = ' + player_id, function(err, rows, fields) {						
							if (err) throw err;

							var charm_id = 0;
							if (Object.keys(rows).length > 0){
								charm_id = rows[0].charm_id;
							}
							connection.query('SELECT COUNT(item.name) As num, item.reborn, item.id FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND item.name = "' + oggetto + '"', function(err, rows, fields) {
								if (err) throw err;
								if (rows[0].num > 0){
									if (player_reborn < rows[0].reborn){
										bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario.", equip);	
										return;
									}

									var itemid = rows[0].id;

									if (charm_id != 0){
										connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + charm_id + ')', function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Il Talismano precedentemente equipaggiato Ã¨ tornato nell'inventario", equip);
										});
									}

									connection.query('UPDATE player SET charm_id = ' + itemid + ' WHERE id = ' + player_id , function(err, rows, fields) {
										if (err) throw err;
										connection.query('DELETE FROM inventory WHERE item_id = ' + itemid + ' AND player_id = ' + player_id  + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Talismano equipaggiato!", equip);
										});
									});
								}else{
									bot.sendMessage(message.chat.id, "Non puoi equipaggiare questo talismano.", equip);
								}
							});
						});
					}else{
						connection.query('SELECT COUNT(*) As num, item.reborn, item.critical, item.power, item.power_armor, item.power_shield, item.id, item.rarity FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id=' + player_id + ' AND item.name = "' + oggetto + '" AND (item.power <> 0 OR item.power_armor <> 0 OR item.power_shield <> 0)', function(err, rows, fields) {
							if (err) throw err;
							if (rows[0].num > 0){
								var itemid = rows[0].id;
								var power = rows[0].power;
								var power_a = rows[0].power_armor;
								var power_s = rows[0].power_shield;
								var critical = rows[0].critical;
								var reborn = rows[0].reborn;
								var rarity = rows[0].rarity;

								var level_nec = 0;
								if (rarity == "UR"){
									level_nec = 15;
								}else if (rarity == "L"){
									level_nec = 30;
								}else if (rarity == "E"){
									level_nec = 50;
								}else if (rarity == "UE"){
									level_nec = 60;
								}
								if ((player_level < level_nec) && (player_reborn == 1)){
									bot.sendMessage(message.chat.id, "Non hai il livello necessario. (" + level_nec + ")", equip);	
									return;
								}

								if (player_reborn < reborn){
									bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario.", equip);	
									return;
								}

								if (power != 0){ //Arma
									connection.query('SELECT * FROM player WHERE weapon_id != 0 AND id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										var weapon_id = 0;
										if (Object.keys(rows).length > 0){
											weapon_id = rows[0].weapon_id;
										}

										if ((itemid == 221) || (itemid == 638) || (itemid == 639) || (itemid == 640)){
											power = Math.round(50+(player_level/2));
										}

										if (weapon_id != 0){
											connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon_id + ')', function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "L'Arma precedentemente equipaggiata Ã¨ tornata nell'inventario", equip);
											});
										}

										connection.query('UPDATE player SET weapon=' + power + ', weapon_id=' + itemid + ', weapon_crit=' + critical + ' WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
											if (err) throw err;
											connection.query('DELETE FROM inventory WHERE item_id = ' + itemid + ' AND player_id = ' + player_id  + ' LIMIT 1', function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Arma equipaggiata!", equip);
											});
										});
									});
								}else if (power_a != 0){ //Armatura
									connection.query('SELECT * FROM player WHERE weapon2_id != 0 AND id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										var weapon2_id = 0;
										if (Object.keys(rows).length > 0){
											weapon2_id = rows[0].weapon2_id;
										}

										if (itemid == 577){
											power_a = Math.round(25+(player_level/2));
											power_a = -Math.abs(power_a);
										}

										if (weapon2_id != 0){
											connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon2_id + ')', function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "L'Armatura precedentemente equipaggiata Ã¨ tornata nell'inventario", equip);
											});
										}

										connection.query('UPDATE player SET weapon2=' + power_a  + ', weapon2_id=' + itemid + ', weapon2_crit=' + critical + ' WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
											if (err) throw err;
											connection.query('DELETE FROM inventory WHERE item_id = ' + itemid + ' AND player_id = ' + player_id  + ' LIMIT 1', function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Armatura equipaggiata!", equip);
											});
										});
									});
								}else if (power_s != 0) { //Scudo
									connection.query('SELECT * FROM player WHERE weapon3_id != 0 AND id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										var weapon3_id = 0;
										if (Object.keys(rows).length > 0){
											weapon3_id = rows[0].weapon3_id;
										}

										if ((itemid == 600) || (itemid == 671) || (itemid == 672) || (itemid == 673)){
											power_s = Math.round(20+(player_level/2));
											power_s = -Math.abs(power_s);
										}

										if (weapon3_id != 0){
											connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon3_id + ')', function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Lo Scudo precedentemente equipaggiato Ã¨ tornato nell'inventario", equip);
											});
										}

										connection.query('UPDATE player SET weapon3=' + power_s + ', weapon3_id=' + itemid + ', weapon3_crit=' + critical + ' WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
											if (err) throw err;
											connection.query('DELETE FROM inventory WHERE item_id = ' + itemid + ' AND player_id = ' + player_id  + ' LIMIT 1', function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Scudo equipaggiato!", equip);
											});
										});
									});					
								}else{
									bot.sendMessage(message.chat.id, "Non puoi equipaggiare l'oggetto specificato.", equip);
								}
							}else{
								bot.sendMessage(message.chat.id, "Non puoi equipaggiare l'oggetto specificato.", equip);
							}
						});
					}
				};
			});
		});
		return;	
	}

	var bottext = "*Oggetti equipaggiabili:*\n";

	connection.query('SELECT id, charm_id, weapon_id, account_id, weapon2_id, exp, weapon3_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var player_level = Math.floor(rows[0].exp/10);
		var charm_id = rows[0].charm_id;
		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var noequip = 0;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		connection.query('SELECT item.power, item.power_armor, item.power_shield, item.critical, item.name, item.id FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id=' + player_id + ' AND (item.power <> 0 OR item.power_armor <> 0 OR item.power_shield <> 0) GROUP BY item.name', function(err, rows, fields) {
			if (err) throw err;
			var iKeys = [];
			if (Object.keys(rows).length > 0){
				bottext = bottext + "\n*Armi/Protezioni:*\n";
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if ((rows[i].id == 221) || (rows[i].id == 638) || (rows[i].id == 639) || (rows[i].id == 640)){
						rows[i].power = Math.round(50+(player_level/2));
					}
					if (rows[i].id == 577){
						rows[i].power_armor = -Math.round(25+(player_level/2));
					}
					if ((rows[i].id == 600) || (rows[i].id == 671) || (rows[i].id == 672) || (rows[i].id == 673)){
						rows[i].power_shield = -Math.round(20+(player_level/2));
					}

					if (rows[i].power != 0){
						if ((rows[i].id == weapon_id) || (rows[i].id == weapon2_id) || (rows[i].id == weapon3_id)){
							bottext = bottext + "> " + rows[i].name + " (+" + rows[i].power + " danno, " + rows[i].critical + ") â˜‘ï¸ \n";
						}else{
							bottext = bottext + "> " + rows[i].name + " (+" + rows[i].power + " danno, " + rows[i].critical + ")\n";
						}
					}else if (rows[i].power_armor != 0){
						if ((rows[i].id == weapon_id) || (rows[i].id == weapon2_id) || (rows[i].id == weapon3_id)){
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_armor + " danno subito, " + rows[i].critical + ") â˜‘ï¸ \n";
						}else{
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_armor + " danno subito, " + rows[i].critical + ")\n";
						}
					}else if (rows[i].power_shield != 0){
						if ((rows[i].id == weapon_id) || (rows[i].id == weapon2_id) || (rows[i].id == weapon3_id)){
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_shield + " danno subito, " + rows[i].critical + ") â˜‘ï¸ \n";
						}else{
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_shield + " danno subito, " + rows[i].critical + ")\n";
						}
					}
					iKeys.push(["Equipaggia " + rows[i].name]);
				}
			}else{
				bottext = bottext + "Nessun arma o protezione equipaggiabile.";
				noequip = 1;
			}
			bottext = bottext + "\n";
			connection.query('SELECT item.name, item.id FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND item.name LIKE "Talismano%" GROUP BY item.name', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0){
					bottext = bottext + "*Talismani:*\n";
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].id == charm_id){
							bottext = bottext + "> " + rows[i].name + " â˜‘ï¸ \n";
						}else{
							bottext = bottext + "> " + rows[i].name + "\n";
						}
						iKeys.push(["Equipaggia " + rows[i].name]);
					}
				}else{
					bottext = bottext + "Nessun talismano equipaggiabile.";
					noequip = noequip+1;
				}

				if (noequip == 2){
					bot.sendMessage(message.chat.id, bottext, back);
					return;
				}

				iKeys.push(["Niente"]);
				iKeys.push(["Torna allo zaino"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				bot.sendMessage(message.chat.id, bottext + "\nCosa vuoi equipaggiare?\nQuando equipaggiato l'oggetto verrÃ  rimosso dall'inventario, usa Rimuovi per disequipaggiarlo", kb);
			});
		});		
	});
});

bot.onText(/rimuovi/i, function(message) {
	var oggetto = "";

	var kbEquip = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Equipaggia"],["Rimuovi"],["Torna allo zaino"],["Torna al menu"]]
		}
	};

	connection.query('SELECT id, holiday, account_id, weapon_id, weapon2_id, weapon3_id, charm_id, mission_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var charm_id = rows[0].charm_id;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var oggetto = message.text.substring(message.text.indexOf(" ")+1);

		if ((message.text.indexOf(" ") != -1) && (oggetto != " ") && (oggetto != "")){
			bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var resp = answer.text;
					if (resp.toLowerCase() != "si"){
						return;
					}

					oggetto = oggetto.toLowerCase();

					if (oggetto == "arma"){
						if (weapon_id != 0){
							connection.query('UPDATE player SET weapon=0, weapon_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon_id + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Arma rimossa dall'equipaggiamento.", kbEquip);
								});
							});
						}else{
							bot.sendMessage(message.chat.id, "Non hai nessun arma equipaggiata.", kbEquip);
						}
					}else if (oggetto == "armatura"){
						if (weapon2_id != 0){
							connection.query('UPDATE player SET weapon2=0, weapon2_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon2_id + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Armatura rimossa dall'equipaggiamento.", kbEquip);
								});
							});
						}else{
							bot.sendMessage(message.chat.id, "Non hai nessun armatura equipaggiata.", kbEquip);
						}
					}else if (oggetto == "scudo"){
						if (weapon3_id != 0){
							connection.query('UPDATE player SET weapon3=0, weapon3_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon3_id + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Scudo rimosso dall'equipaggiamento.", kbEquip);
								});
							});
						}else{
							bot.sendMessage(message.chat.id, "Non hai nessuno scudo equipaggiato.", kbEquip);
						}
					}else if (oggetto == "talismano"){
						if (charm_id != 0){
							connection.query('UPDATE player SET charm_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + charm_id + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Talismano rimosso dall'equipaggiamento.", kbEquip);
								});
							});
						}else{
							bot.sendMessage(message.chat.id, "Non hai nessun talismano equipaggiato", kbEquip);
						}
					}else if (oggetto == "tutto"){
						var text = "";
						if (weapon_id != 0){
							text += "> Arma\n";
							connection.query('UPDATE player SET weapon=0, weapon_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon_id + ')', function(err, rows, fields) {
									if (err) throw err;
								});
							});
						}
						if (weapon2_id != 0){
							text += "> Armatura\n";
							connection.query('UPDATE player SET weapon2=0, weapon2_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon2_id + ')', function(err, rows, fields) {
									if (err) throw err;
								});
							});
						}
						if (weapon3_id != 0){
							text += "> Scudo\n";
							connection.query('UPDATE player SET weapon3=0, weapon3_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + weapon3_id + ')', function(err, rows, fields) {
									if (err) throw err;
								});
							});
						}
						if (charm_id != 0){
							text += "> Talismano\n";
							connection.query('UPDATE player SET charm_id=0 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + charm_id + ')', function(err, rows, fields) {
									if (err) throw err;
								});
							});
						}

						if (text == ""){
							bot.sendMessage(message.chat.id, "Non hai alcun oggetto equipaggiato", back);
						}else{
							bot.sendMessage(message.chat.id, text + "\nRimossi e reinseriti nello zaino", back);
						}
					}else{
						bot.sendMessage(message.chat.id, "Equipaggiamento non valido.", back);
						return;
					}
				};
			});			
			return;	
		}


		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Rimuovi Arma","Rimuovi Armatura"],["Rimuovi Scudo","Rimuovi Talismano"],["Rimuovi Tutto"],["Torna allo zaino"],["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, "Cosa vuoi rimuovere?", kb);
	});
});

bot.onText(/torna a crea|crea (.+)/i, function(message) {
	var oggetto = "";
	var inventario = "";
	var bottext = "Oggetti creabili:\n";

	connection.query('SELECT id, holiday, money, reborn, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		var reborn = rows[0].reborn;

		if (message.text.indexOf("ðŸ“¦") == -1){
			if ((message.text.indexOf(" ") != -1) && (message.text != "Torna a Crea")){
				var oggetto = message.text.substring(message.text.indexOf(" ")+1, message.text.lenght);

				if ((oggetto.indexOf("Oggetto") == -1) && (oggetto != "Ancora")){
					creaOggetto(message, player_id, oggetto, money, reborn);
					return;
				}
			}
		}

		connection.query('SELECT item_id FROM inventory WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					inventario = inventario + '"' + rows[i].item_id + '",';
				}
				inventario = inventario.slice(0, -1);
				connection.query('SELECT item.name, item.rarity, item.power, craft.material_1, craft.material_2, craft.material_3 FROM craft, item WHERE craft.material_result = item.id AND material_1 IN (' + inventario + ') AND material_2 IN (' + inventario + ') AND material_3 IN (' + inventario + ') ORDER BY item.name', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].power != 0){
								if (rows[i].power > 0){
									bottext = bottext + "> " + rows[i].name + " (" + rows[i].rarity + ") +" + rows[i].power + " danno\n";
								}else{
									bottext = bottext + "> " + rows[i].name + " (" + rows[i].rarity + ") " + rows[i].power + " danno subito\n";	
								}
							}else{
								bottext = bottext + "> " + rows[i].name + " (" + rows[i].rarity + ")\n";
							}
							iKeys.push(["Crea " + rows[i].name]);
						}
						iKeys.push(["Niente"]);

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext + "\nLe creazioni di alto livello hanno un prezzo:\nUR 500 Â§ - L 750 Â§ - E 1000 Â§\nUE 10k Â§ - U 50k - X 100k Â§\nSolamente le creazioni a pagamento aumentano i punti creazione!", kb);

						//	connection.query('SELECT item.name, item.rarity, item.power, craft.material_1, craft.material_2, craft.material_3 FROM craft, item WHERE craft.material_result = item.id AND material_1 IN (' + inventario + ') AND material_2 IN (' + inventario + ') AND material_3 IN (' + inventario + ') ORDER BY item.name', function(err, rows, fields) {
						//		if (err) throw err;
						//	});
					}else{
						bot.sendMessage(message.chat.id, "Non puoi fabbricare nessun oggetto.", back);
					}
				});
			}
		});
	});
});

function creaOggetto(message, player_id, oggetto, money, reborn){
	var inventario = "";

	connection.query('SELECT id, term FROM search_history WHERE player_id = ' + player_id + ' ORDER BY id DESC LIMIT 2', function(err, rows, fields) {
		if (err) throw err;

		var prevtxt = "";
		var iKeys = [];

		iKeys.push(["Crea Ancora"]);

		if (Object.keys(rows).length == 2){
			prevtxt = "Torna a " + rows[1].term;
			iKeys.push([prevtxt]);
		}

		var craft_fail = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Cerca " + oggetto],["Torna al menu"]]
			}
		};

		connection.query('SELECT item_id FROM inventory WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					inventario = inventario + '"' + rows[i].item_id + '",';
				}
				inventario = inventario.slice(0, -1);

				connection.query('SELECT craft.material_1, craft.material_2, craft.material_3, craft.material_result, item.name FROM craft, item WHERE craft.material_result = item.id AND material_1 IN (' + inventario + ') AND material_2 IN (' + inventario + ') AND material_3 IN (' + inventario + ') AND item.name = "' + oggetto + '"', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var mat1 = rows[0].material_1;
						var mat2 = rows[0].material_2;
						var mat3 = rows[0].material_3;
						var matR = rows[0].material_result;
						var craftexp = 0;

						oggetto = rows[0].name;

						connection.query('SELECT name, rarity, reborn, power FROM `item` WHERE id = ' + matR, function(err, rows, fields) {
							if (err) throw err;

							var result_name = rows[0].name;
							var result_rarity = rows[0].rarity;
							var result_reborn = rows[0].reborn;
							var result_power = rows[0].power;

							connection.query('SELECT name, rarity, reborn FROM `item` WHERE id IN (' + mat1 + ',' + mat2 + ',' + mat3 + ')', function(err, rows, fields) {
								if (err) throw err;

								if (reborn < result_reborn){
									bot.sendMessage(message.chat.id, "Il tuo livello rinascita non Ã¨ sufficente per creare questo oggetto.", back);
									return;
								}

								var Rmoney = "";
								if (result_rarity == "L"){
									Rmoney += "\n> 750 Â§";
								}else if (result_rarity == "UR"){
									Rmoney += "\n> 500 Â§";
								}else if (result_rarity == "E"){
									Rmoney += "\n> 1000 Â§";
								}else if (result_rarity == "UE"){
									Rmoney += "\n> 10k Â§";
								}else if (result_rarity == "U"){
									Rmoney += "\n> 50k Â§";
								}else if (result_rarity == "X"){
									Rmoney += "\n> 100k Â§";
								}

								var n1 = rows[0].name;
								var n2 = rows[1].name;
								var n3 = rows[2].name;

								bot.sendMessage(message.chat.id, "Stai per consumare i seguenti oggetti:\n> " + n1 + "\n> " + n2 + "\n> " + n3 + Rmoney, yesno).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {

										var res = answer.text.toLowerCase();
										if (res == "Torna al menu"){
											return;
										}else if (res == "si"){

											connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;

												money = rows[0].money;

												connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + mat1, function (err, rows, fields){
													if (err) throw err;
													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "Non possiedi il primo oggetto per la creazione (" + n1 + ")", craft_fail);
														return;
													}
													connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + mat2, function (err, rows, fields){
														if (err) throw err;
														if (Object.keys(rows).length == 0){
															bot.sendMessage(message.chat.id, "Non possiedi il secondo oggetto per la creazione (" + n2 + ")", craft_fail);
															return;
														}
														connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + mat3, function (err, rows, fields){
															if (err) throw err;
															if (Object.keys(rows).length == 0){
																bot.sendMessage(message.chat.id, "Non possiedi il terzo oggetto per la creazione (" + n3 + ")", craft_fail);
																return;
															}

															var cost = 0;
															if (result_rarity == "L"){
																cost = 750;
																craftexp = 3;
															}else if (result_rarity == "UR"){
																cost = 500;
																craftexp = 2;
															}else if (result_rarity == "E"){
																cost = 1000;
																craftexp = 5;
															}else if (result_rarity == "X"){
																cost = 100000;
																craftexp = 50;
															}else if (result_rarity == "UE"){
																cost = 10000;
																craftexp = 25;
															}else if (result_rarity == "U"){
																cost = 50000;
																craftexp = 35;
															}
															if (crazyMode == 1){
																craftexp = craftexp*2;
															}

															if (cost > 0){
																if (money < cost){
																	bot.sendMessage(message.chat.id, "Ti servono " + cost + " Â§ per creare questo oggetto.", craft_fail);
																	return;
																}else{
																	connection.query('UPDATE `player` SET money = money-' + cost + ' WHERE `nickname` = "' + message.from.username + '"', function(err, rows, fields) {
																		if (err) throw err;
																	});
																}
															};

															connection.query('INSERT INTO `inventory`(`player_id`, `item_id`) VALUES (' + player_id + ',' + matR + ')', function(err, rows, fields) {
																if (err) throw err;
																connection.query('DELETE FROM `inventory` WHERE item_id=' + mat1 + ' AND player_id=' + player_id + ' LIMIT 1', function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('DELETE FROM `inventory` WHERE item_id=' + mat2 + ' AND player_id=' + player_id + ' LIMIT 1', function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('DELETE FROM `inventory` WHERE item_id=' + mat3 + ' AND player_id=' + player_id + ' LIMIT 1', function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE `player` SET craft_week = craft_week+' + craftexp + ', craft_count = craft_count+' + craftexp + ' WHERE `nickname` = "' + message.from.username + '"', function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('SELECT team_id FROM team_player WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;

																	if (Object.keys(rows).length > 0){
																		connection.query('UPDATE team SET craft_count = craft_count+' + craftexp + ' WHERE id = ' + rows[0].team_id, function(err, rows, fields) {
																			if (err) throw err;
																		});
																	}

																	iKeys.push(["Torna a " + oggetto]);
																	iKeys.push(["Torna al menu"]);

																	var craft = {
																		parse_mode: "Markdown",
																		reply_markup: {
																			resize_keyboard: true,
																			one_time_keyboard: true,
																			"keyboard": iKeys
																		}
																	};

																	if (result_power > 0){
																		setAchievement(message.chat.id, player_id, 34, 1);
																	}

																	bot.sendMessage(message.chat.id, "L'oggetto *" + oggetto + "* Ã¨ stato creato!", craft);
																});
															});

															setAchievement(message.chat.id, player_id, 10, craftexp);
															setAchievement(message.chat.id, player_id, 12, 1, matR);
															checkFestival(message.chat.id, player_id, matR);
														});
													});
												});
											});
										};
									};
								});
							});
						});
					}else{
						bot.sendMessage(message.chat.id, "Non puoi creare questo oggetto.", craft_fail);
					}
				});
			}
		});
	});
}

function checkFestival(chat_id, player_id, item_id){
	if (eventFestival == 0){
		return;
	}

	connection.query('SELECT event_crafting_item.price, event_crafting_item.id As eventId, event_crafting_item.cnt, item.id FROM event_crafting_item, item WHERE item.id = event_crafting_item.item_id ORDER BY event_crafting_item.id DESC LIMIT 1', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (rows[0].id == item_id){

				var price = rows[0].price;
				var cnt = rows[0].cnt;
				var eventId = rows[0].eventId;

				connection.query('UPDATE event_crafting_item SET price = price+10, cnt = cnt+1 WHERE id = ' + eventId, function(err, rows, fields) {
					if (err) throw err;
					connection.query('UPDATE event_crafting_status SET cnt = cnt+1 WHERE player_id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						connection.query('UPDATE player SET money = money + ' + price + ' WHERE id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							var plur = "e";
							if ((parseInt(cnt)+1) == 1){
								plur = "a";
							}
							bot.sendMessage(chat_id, "Hai creato l'oggetto per il festival! Hai ottenuto *" + price + " Â§*, Ã¨ stato creato " + (parseInt(cnt)+1) + " volt" + plur + "!", back);
						});
					});
				});
			}
		}
	});
}

bot.onText(/^test$/i, function(message) {
	if (message.from.username == "fenix45"){
		setAchievementProgress(1, 1);
		setAchievementProgress(1, 2);
		setAchievementProgress(1, 3);
	}
});

function setAchievementProgress(player_id, type, manual = 0){
	connection.query('SELECT * FROM player WHERE id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;

		var chat_id = rows[0].chat_id;

		if (type == 1){
			var lev = Math.floor(rows[0].exp/10);
			for (var i = 0, len = Object.keys(progLev).length; i < len; i++) {
				if (lev >= progLev[i]){
					achievementDetail(player_id, chat_id, type, i, progLevRew[i], "Hai raggiunto il livello " + progLev[i]);
				}
			}
		}else if (type == 2){
			var miss = rows[0].mission_count;
			for (var i = 0, len = Object.keys(progMis).length; i < len; i++) {
				if (miss >= progMis[i]){
					achievementDetail(player_id, chat_id, type, i, progMisRew[i], "Hai completato " + progMis[i] + " missioni");
				}
			}
		}else if (type == 3){
			var dung = rows[0].dungeon_count;
			for (var i = 0, len = Object.keys(progDung).length; i < len; i++) {
				if (dung >= progDung[i]){
					achievementDetail(player_id, chat_id, type, i, progDungRew[i], "Hai completato " + progDung[i] + " dungeon");
				}
			}
		}
	});
};

function achievementDetail(player_id, chat_id, type, subtype, reward, msg){
	connection.query('SELECT COUNT(id) As cnt FROM achievement_progressive_status WHERE subtype = ' + subtype + ' AND type = ' + type + ' AND player_id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		if (rows[0].cnt == 0){
			bot.sendMessage(chat_id, msg + " e ottenuto <i>" + formatNumber(reward) + "</i> Â§!", html);
			connection.query('UPDATE player SET money = money + ' + reward + ' WHERE id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
				connection.query('INSERT INTO achievement_progressive_status (player_id, type, subtype) VALUES (' + player_id + ',' + type + ',' + subtype + ')', function(err, rows, fields) {
					if (err) throw err;
				});
			});
		}
	});
};

function setAchievement(chat_id, player_id, type, increment, itemId = 0){
	connection.query('SELECT achievement_count FROM player WHERE id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;

		var achievement_count = parseInt(rows[0].achievement_count)+1;

		connection.query('SELECT name, value, type, achievement_id, item_id, reward FROM achievement_daily, achievement_list WHERE achievement_daily.achievement_id = achievement_list.id AND achievement_list.type = ' + type, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				var count_ach = rows[0].value;
				var ach_id = rows[0].achievement_id;
				var reward = rows[0].reward;
				var item_id = rows[0].item_id;
				var name = rows[0].name;

				if (item_id != 0){
					if ((item_id == 0) || (item_id != itemId)){
						return;
					}
				}

				connection.query('SELECT progress, completed FROM achievement_status WHERE achievement_id = ' + ach_id + ' AND player_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;

					var completed = 0;
					var progress = 0;
					if (Object.keys(rows).length == 0){
						connection.query('INSERT INTO achievement_status (player_id, achievement_id, progress) VALUES (' + player_id + ',' + ach_id + ',0)', function(err, rows, fields) {
							if (err) throw err;

							if ((progress+increment >= count_ach) && (completed == 0)){
								console.log("Impresa: " + player_id + " - " + type + " - " + increment + " - " + itemId);

								connection.query('UPDATE player SET achievement_count = achievement_count+1, money = money+' + reward + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE achievement_status SET completed = 1 WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai completato l'impresa giornaliera *" + name + "* e hai ricevuto " + formatNumber(reward) + " Â§!", mark);
									setAchievement(chat_id, player_id, 40, 1);
								});
								if ((achievement_count % 10) == 0){
									var randChest = Math.random()*100;
									var chest_id = 0;
									var chest_name = "";
									if (randChest <= 60){
										chest_id = 4;
										chest_name = "Scrigno di Diamante";
									}else if (randChest <= 90){
										chest_id = 5;
										chest_name = "Scrigno Leggendario";
									}else{
										chest_id = 6;
										chest_name = "Scrigno Epico";
									}
									connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + player_id + ',' + chest_id + ')', function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(chat_id, "Hai completato *10 imprese* e hai ricevuto " + chest_name + "!", mark);
									});
								}
							}
							connection.query('UPDATE achievement_status SET progress = progress+' + increment + ' WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function(err, rows, fields) {
								if (err) throw err;
							});
						});
					}else{
						completed = rows[0].completed;
						progress = rows[0].progress;

						if ((progress+increment >= count_ach) && (completed == 0)){
							console.log("Impresa: " + player_id + " - " + type + " - " + increment + " - " + itemId);

							connection.query('UPDATE player SET achievement_count = achievement_count+1, money = money+' + reward + ' WHERE id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
							});
							connection.query('UPDATE achievement_status SET completed = 1 WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai completato l'impresa giornaliera *" + name + "* e hai ricevuto " + formatNumber(reward) + " Â§!", mark);
								setAchievement(chat_id, player_id, 40, 1);
							});

							if ((achievement_count % 10) == 0){
								var randChest = Math.random()*100;
								var chest_id = 0;
								var chest_name = "";
								if (randChest <= 60){
									chest_id = 4;
									chest_name = "Scrigno di Diamante";
								}else if (randChest <= 90){
									chest_id = 5;
									chest_name = "Scrigno Leggendario";
								}else{
									chest_id = 6;
									chest_name = "Scrigno Epico";
								}
								connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + player_id + ',' + chest_id + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai completato *10 imprese* e hai ricevuto " + chest_name + "!", mark);
								});
							}
						}
						if (completed == 0){
							connection.query('UPDATE achievement_status SET progress = progress+' + increment + ' WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function(err, rows, fields) {
								if (err) throw err;
							});
						}
					}
				});
			};
		});
	});
}

bot.onText(/^scrigni/i, function(message) {
	s = message.text;
	var scrigno = "";
	var iKeys = [];

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		connection.query('SELECT chest.name As name, COUNT(chest.name) As num, (SELECT COUNT(*) FROM inventory_chest WHERE player_id = ' + player_id + ') As tot FROM inventory_chest, chest WHERE inventory_chest.player_id=' + player_id + ' AND inventory_chest.chest_id = chest.id GROUP BY chest.name ORDER BY chest.id', function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length > 0){

				if (rows[0].tot > 1){
					iKeys.push(["Apri tutti"]);
				}

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					iKeys.push(["Apri " + rows[i].name + " (" + rows[i].num + ")"]);
				}

				iKeys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				var plur = "i";
				if (rows[0].tot == 1){
					plur = "o";
				}

				bot.sendMessage(message.chat.id, "Possiedi " + rows[0].tot + " scrign" + plur, kb);
			}else{
				bot.sendMessage(message.chat.id, "Non possiedi nessuno scrigno.", back);
			}
		});
	});
});

bot.onText(/^apri/i, function(message) {

	/*
	if (message.from.username != "fenix45"){
		bot.sendMessage(message.chat.id, "Manutenzione", back);
		return;
	}
	*/

	connection.query('SELECT id, reborn FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;

		var chestMore = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Scrigni"],["Torna al menu"]]
			}
		};

		var scrigno = message.text.substring(message.text.indexOf(" ")+1);
		if (scrigno.indexOf("(") != -1){
			scrigno = scrigno.substring(0, scrigno.indexOf("(")-1);
		}
		if ((scrigno == "") || (scrigno == " ")){
			return;
		}

		var all = "";
		if (scrigno != "tutti"){
			all = ' AND chest.name = "' + scrigno + '"';
		}else{
			all = ' AND chest.id != 8';
		}	

		connection.query('SELECT chest.id, chest.name FROM chest, inventory_chest WHERE chest.id = inventory_chest.chest_id AND inventory_chest.player_id = ' + player_id + all, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non possiedi lo scrigno selezionato", chestMore);
				return;
			}

			var qnt = Object.keys(rows).length;
			qnt = qnt.toString();
			var rarity = rows[0].id;

			if (scrigno != "tutti"){
				if (rarity == 8){
					var chestNum = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": [["C","NC","R"],["UR","L","E"],["Torna al menu"]]
						}
					};

					connection.query('SELECT COUNT(id) As qnt FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 651', function(err, rows, fields) {
						if (err) throw err;

						bot.sendMessage(message.chat.id, "Seleziona la raritÃ  dell'oggetto che vuoi trovare in questo scrigno, ti costerÃ  una diversa quantitÃ  di Chiavi Mistiche  ðŸ—\nNe possiedi: " + rows[0].qnt, chestNum).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								var resp = answer.text;
								if (resp == "Torna al menu"){
									return;
								}
								connection.query('SELECT id FROM rarity WHERE shortname = "' + answer.text + '" AND id < 7', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "RaritÃ  non valida", chestMore);
										return;
									}
									var rarity = answer.text;
									var cost = rows[0].id*4;

									bot.sendMessage(message.chat.id, "Questa raritÃ  ti costerÃ  " + cost + "ðŸ— , procedi?", yesno).then(function() {
										answerCallbacks[message.chat.id] = function(answer) {
											if (answer.text.toLowerCase() == "si"){
												connection.query('SELECT COUNT(id) As qnt FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 651', function(err, rows, fields) {
													if (err) throw err;
													if (rows[0].qnt < cost){
														bot.sendMessage(message.chat.id, "Non hai abbastanza Chiavi Mistiche", chestMore);
														return;
													}

													connection.query('DELETE FROM inventory_chest WHERE player_id = ' + player_id + ' AND chest_id = 8 LIMIT 1', function(err, rows, fields) {
														if (err) throw err;
														connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 651 LIMIT ' + cost, function(err, rows, fields) {
															if (err) throw err;
															connection.query('SELECT name, id FROM item WHERE craftable = 0 AND rarity = "' + rarity + '" ORDER BY RAND()', function(err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Nello Scrigno Mistico hai trovato *" + rows[0].name + "* ed una ðŸ’Ž!", back);
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].id + ')', function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																});
															});
														});
													});
												});
											}
										}
									});
								});
							};
						});
					});
					return;
				}
			}

			if (scrigno == "tutti"){
				var chestNum = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Si"],["Torna al menu"]]
					}
				};
			}else if (qnt > 1){
				var chestNum = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["1"],[qnt],["Torna al menu"]]
					}
				};
			}else{
				var chestNum = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["1"],["Torna al menu"]]
					}
				};
			}

			var alltxt = "Sicuro di voler aprire tutti gli scrigni?";
			if (scrigno != "tutti"){
				alltxt = "Possiedi " + qnt + " *" + scrigno + "*, quanti ne vuoi aprire?";
			}

			bot.sendMessage(message.chat.id, alltxt, chestNum).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var resp = answer.text;
					if (resp == "Torna al menu"){
						return;
					}

					if (scrigno != "tutti"){
						resp = parseInt(resp);
						if ((resp < 1) || (resp > parseInt(qnt))){
							bot.sendMessage(message.chat.id, "QuantitÃ  non valida", chestMore);
							return;
						}
					}else{
						resp = 10000;
					}

					var quantity = 1;
					quantity = resp;
					var limit = "LIMIT " + quantity;

					var allsql = "";
					if (scrigno != "tutti"){
						allsql = 'inventory_chest.chest_id = ' + rarity + ' AND ';
					}else{
						allsql = 'chest.id != 8 AND ';
					}

					connection.query('SELECT inventory_chest.id, chest_id, rarity_shortname FROM inventory_chest, chest WHERE ' + allsql + 'inventory_chest.chest_id = chest.id AND player_id = "' + player_id + '" ORDER BY chest.id ' + limit, function(err, rows, fields) {
						if (err) throw err;

						var id = 0;
						var chest_rarity = "";
						var chest_id = 0;
						var item_name = "";
						var item_rarity = "";
						var index = 0;
						if (Object.keys(rows).length == 0){
							bot.sendMessage(message.chat.id, "Non possiedi gli scrigni indicati", chestMore);
							return;
						}
						if (Object.keys(rows).length > 150){
							bot.sendMessage(message.chat.id, "Purtroppo non puoi aprire cosÃ¬ tanti scrigni insieme :(", chestMore);
							return;
						}

						var itemqnt = Object.keys(rows).length;
						var i = 0;
						var index = 0;
						var len = Object.keys(rows).length;

						var itemsArray = [];
						var special = 0;

						for (i = 0; i < len; i++){
							chest_rarity = rows[i].rarity_shortname;
							chest_id = rows[i].chest_id;

							id = rows[i].id;

							connection.query('SELECT id, name, rarity FROM item WHERE rarity = "' + chest_rarity + '" AND craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
								if (err) throw err;

								special = 0;
								item_name = rows[0].name;
								item_rarity = rows[0].rarity;
								if (item_rarity == "U"){
									var randU = Math.random()*100;
									if (reborn > 3)
										randU -= 10;
									if (randU <= 20){
										item_name = "Gemma";
										item_rarity = "ðŸ’Ž";
										special = 1;
									}
								}
								itemsArray.push(item_name +  " (" + item_rarity + ")");
								index++;

								if (special == 0){
									connection.query('INSERT INTO inventory (player_id, item_id) VALUES(' + player_id + ',' + rows[0].id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
								}else{
									connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
									});
								}

								connection.query('DELETE FROM `inventory_chest` WHERE `player_id` = ' + player_id + ' AND id = ' + this.id, function(err, rows, fields) {
									if (err) throw err;
								});

								if (index == len){
									var msg = "";
									var arrLen = itemsArray.join().toString();
									if (Object.keys(arrLen).length > 4000){
										msg = "Hai trovato " + len + " oggetti!";
									}else{
										var plur = "i";
										if (itemqnt == 1){
											plur = "o";
										}	
										msg = "Hai trovato " + itemqnt + " oggett" + plur + ":";
										var hist = {};
										itemsArray.map( function (a) { if (a in hist) hist[a] ++; else hist[a] = 1; } );
										Object.keys(hist).forEach(function(key) {
											msg += "\n> " + hist[key] + "x " + key;
										});
									}
									bot.sendMessage(message.chat.id, msg, chestMore);

									setAchievement(message.chat.id, player_id, 5, len);
								}
							}.bind( {id: id} ));
						}
					});
				};
			});
		});
	});
});

bot.onText(/weekend della follia/i, function(message) {
	if (crazyMode == 0){
		bot.sendMessage(message.chat.id, "La modalitÃ  follia non Ã¨ attiva!", back);
		return;
	}

	var bonus = 	"> Tutte le missioni velocizzate\n" +
		"> Ricompense scrigni doppi nelle missioni\n" +
		"> Danno raddoppiato in boss, vendette e dungeon\n" +
		"> Monete raddoppiate nelle ispezioni\n" +
		"> PossibilitÃ  maggiore di trovare U Base e missioni U!\n" +
		"> Eventi in missione molto particolari\n" +
		"> I tempi di attesa nel dungeon sono dimezzati (ma la vocazione non influisce)\n" +
		"> Valore degli oggetti durante la vendita al bot aumentato\n" +
		"> Ottieni una gemma per ogni missione L/E iniziata nell'evento\n" +
		"> I tempi delle ispezioni sono ridotti\n" +
		"> Ottieni piÃ¹ punti creando oggetti!\n\n" +
		"I bonus possono cambiare di volta in volta!";

	bot.sendMessage(message.chat.id, "*Follia!*\nQuesto evento dura fino a domenica a mezzanotte, con questi *bonus*:\n\n" + bonus, back);
});

bot.onText(/weekend della fortuna/i, function(message) {
	if (message.from.username != "fenix45"){
		if (luckyMode == 0){
			bot.sendMessage(message.chat.id, "La modalitÃ  fortuna inizierÃ  alle 10:00!", back);
			return;
		}
	}

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Tenta la fortuna"],["Torna al menu"]]
		}
	};

	var bonus = 	"> 50% di probabilitÃ  in piÃ¹ di evolvere lo scrigno missione\n" +
		"> Monete a fine missione o raddoppiate o dimezzate\n" +
		"> Pietre a fine cava raddoppiate o dimezzate\n" +
		"> Giocando i gettoni, la vittoria Ã¨ doppia e la perdita Ã¨ nulla\n" +
		"> La probabilitÃ  di successo in ispezione Ã¨ decisamente incrementata\n" +
		"> I punti rango ottenuti al completamento del dungeon possono essere raddoppiati o nulli\n" +
		"> Puoi tentare di raddoppiare il tuo patrimonio ma attenzione, potresti perderlo totalmente!\n\n" +
		"Sei pronto a tentare la fortuna?";

	bot.sendMessage(message.chat.id, "*Fortuna!*\nQuesto evento dura fino a domenica a mezzanotte, con questi *bonus*:\n\n" + bonus, kb).then(function() {
		answerCallbacks[message.chat.id] = function(answer) {
			if (answer.text == "Tenta la fortuna"){

				connection.query('SELECT 1 FROM contest WHERE player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function(err, rows, fields) {
					if (err) throw err; 

					if (Object.keys(rows).length > 0){
						bot.sendMessage(message.chat.id, "Puoi tentare la fortuna solamente una volta!", back);
						return;
					}

					bot.sendMessage(message.chat.id, "Attenzione! Hai il 50% di probabilitÃ  che il tuo patrimonio venga raddoppiato oppure completamente perso, sei veramente sicuro?\nPuoi tentare la fortuna solamente una volta", yesno).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text.toLowerCase() == "si"){
								connection.query('SELECT money, id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
									if (err) throw err;

									var rand = Math.random()*100;
									var player_id = rows[0].id;
									var money = rows[0].money;
									var newmoney = 0;

									if (rand < 40){
										newmoney = money*2;
										connection.query('UPDATE player SET money = ' + newmoney + ' WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "*WOOW!!* Incredibilmente il tuo patrimonio di " + money + " Â§ Ã¨ stato *RADDOPPIATO* a *" + newmoney + "* Â§!!", back);
										});
									}else{
										newmoney = 0;
										connection.query('UPDATE player SET money = ' + newmoney + ' WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "*NOOOO!!* Incredibilmente il tuo patrimonio di " + money + " Â§ Ã¨ stato completamente *AZZERATO* Â§!!", back);
										});
									}
									connection.query('INSERT INTO contest (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
								});
							};
						};
					});
				});
			};
		};
	});
});

bot.onText(/arena/i, function(message) {
	if (arena == 0){
		bot.sendMessage(message.chat.id, "L'arena Ã¨ chiusa!", back);
		return;
	}

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Continua all'arena"],["Torna al menu"]]
			}
		};
		var kb2 = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Scegli Drago 1","Scegli Drago 2"],["Punta Pietre"],["Torna al menu"]]
			}
		};
		var kb3 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Entra nell'arena"],["Torna al menu"]]
			}
		};
		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Torna all'arena"],["Torna al menu"]]
			}
		};

		connection.query('SELECT * FROM event_arena_status WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO event_arena_status (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Benvenuto nell'Arena dei Draghi 2.0!\nIn questa arena i draghi si sfideranno, avrai l'occasione di vincere le Pietre per potenziare il tuo drago scegliendo quale sarÃ  il probabile vincitore dello scontro, inizia!", kb);
				});
			}else{

				if (rows[0].extracted == 0){
					connection.query('SELECT id, level FROM dragon WHERE level > 10 ORDER BY RAND()', function(err, rows, fields) {
						if (err) throw err;

						var id1 = parseInt(rows[0].id);
						var level1 = parseInt(rows[0].level);

						connection.query('SELECT id, level FROM dragon WHERE level BETWEEN ' + (level1-10) + ' AND ' + (level1+10) + ' AND id != ' + id1 + ' ORDER BY RAND()', function(err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Non sono riuscito a trovare uno sfidante valido, riprova", kbBack);
								return;
							}

							var id2 = parseInt(rows[0].id);
							var level2 = parseInt(rows[0].level);

							var landType = 0;
							var landRand = Math.random()*60;
							if (landRand < 10){
								landType = 1;
							}else if (landRand < 20){
								landType = 2;
							}else if (landRand < 30){
								landType = 3;
							}else if (landRand < 40){
								landType = 4;
							}else if (landRand < 50){
								landType = 5;
							}else{
								landType = 6;
							}

							var now = new Date();
							now.setMinutes(now.getMinutes() + Math.round(Math.random()*15+15));
							var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
							var short_time = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());

							connection.query('UPDATE event_arena_status SET extracted = 1, dragon_1 = ' + id1 + ', dragon_2 = ' + id2 + ', land_type = ' + landType + ', fight_time = "' + long_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "I draghi sfidanti sono stati estratti!", kb3);
							});		
						});
					});
				}else{

					var d1 = rows[0].dragon_1;
					var d2 = rows[0].dragon_2;
					var choice = rows[0].choice;
					var bet_id = rows[0].bet_id;
					var landType = rows[0].land_type;

					var d = new Date(rows[0].fight_time);
					var short_time = addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + ":" + addZero(d.getSeconds());

					connection.query('SELECT id, name, level, type FROM dragon WHERE id = ' + d1, function(err, rows, fields) {
						if (err) throw err;

						var name1 = rows[0].name;
						var type1 = rows[0].type;
						var id = rows[0].id;
						var level1 = rows[0].level;

						connection.query('SELECT name, level, type FROM dragon WHERE id = ' + d2, function(err, rows, fields) {
							if (err) throw err;

							var name2 = rows[0].name;
							var type2 = rows[0].type;
							var level2 = rows[0].level;

							var landDesc = "";
							if (landType == 1){
								landDesc = "Scottatura";
							}else if (landType == 2){
								landDesc = "Congelamento;"
							}else if (landType == 3){
								landDesc = "Avvelenamento";
							}else if (landType == 4){
								landDesc = "Sonno";
							}else if (landType == 5){
								landDesc = "Rallentamento";
							}else{
								landDesc = "Terrore";
							}

							if (choice == 0){
								choice = "-";
							}else if (choice == 1){
								choice = "â‘ ";
							}else if (choice == 2){
								choice = "â‘¡";
							}

							bot.sendMessage(message.chat.id, 	"La prossima Sfida si tiene in un'Arena con un terreno che provoca <b>" + landDesc + "</b> " + landSym(landType) + " tra:\n\n" +
											"â‘  <b>" + name1 + " " + type1 + "</b> (LV " + level1 + ") " + dragonSym(type1) + "\n\n" +
											"               âš”ï¸\n\n" + 
											"â‘¡ <b>" + name2 + " " + type2 + "</b> (LV " + level2 + ") " + dragonSym(type2) + "\n\n" +
											"Hai puntato su: " + choice + "\n\n" +
											"Lo scontro inizierÃ  alle " + short_time, kb2).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Torna al menu"){
										return;
									}

									connection.query('SELECT extracted FROM event_arena_status WHERE player_id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;

										if (rows[0].extracted == 0){
											bot.sendMessage(message.chat.id, "I draghi non sono ancora stati estratti!", kbBack);
											return;
										}

										if (answer.text == "Scegli Drago 1"){
											connection.query('UPDATE event_arena_status SET choice = 1 WHERE player_id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai scelto il drago 1!", kbBack);
											});
										}else if (answer.text == "Scegli Drago 2"){
											connection.query('UPDATE event_arena_status SET choice = 2 WHERE player_id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai scelto il drago 2!", kbBack);
											});
										}else if (answer.text == "Punta Pietre"){
											if (choice == 0){
												bot.sendMessage(message.chat.id, "Prima scegli il drago su cui puntare!", kbBack);
												return;
											}
											if (bet_id != 0){
												bot.sendMessage(message.chat.id, "Hai giÃ  puntato su questo scontro!", kbBack);
												return;
											}
											bot.sendMessage(message.chat.id, "Specifica la pietra che vuoi puntare sul drago scrivendo il codice, " +
															"se vinci otterrai pietre pari a quelle puntate, altrimenti le perderai. La quantitÃ  massima di pietre per puntata Ã¨ 3.\n" +
															"Pietra Anima di Legno -> 1\n" +
															"Pietra Anima di Ferro -> 2\n" +
															"Pietra Anima Preziosa -> 3\n" +
															"Pietra Cuore di Diamante -> 4\n" +
															"Pietra Cuore Leggendario -> 5\n" +
															"Pietra Spirito Epico -> 6\n\n" +
															"Attenzione, puoi puntare solamente una volta", kbBack).then(function() {
												answerCallbacks[message.chat.id] = function(answer) {
													if (answer.text == "Torna all'arena"){
														return;
													}
													if (answer.text.indexOf(",") != -1){
														/*
														var part = answer.text.split(",");
														var stone = (67+parseInt(part[0]));

														if ((part[0] < 1) || (part[0] > 6) || (re.test(part[0]) == false)){
															bot.sendMessage(message.chat.id, "Codice pietra non valido!", kbBack);
															return;
														}
														if ((part[1] < 1) || (part[1] > 3) || (re.test(part[1]) == false)){
															bot.sendMessage(message.chat.id, "QuantitÃ  non valida!", kbBack);
															return;
														}
														var qnt = part[1];
														*/

														var stone = (67+parseInt(answer.text));
														if ((stone < 1) || (stone > 6) || (re.test(stone) == false)){
															bot.sendMessage(message.chat.id, "Codice pietra non valido!", kbBack);
															return;
														}
														var qnt = 1;

														connection.query('SELECT COUNT(id) As cnt FROM inventory WHERE item_id = ' + stone + ' AND player_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;

															if (rows[0].cnt < qnt){
																bot.sendMessage(message.chat.id, "Non hai abbastanza pietre di quel tipo", kbBack);
																return;
															}

															connection.query('DELETE FROM inventory WHERE item_id = ' + stone + ' AND player_id = ' + player_id + ' LIMIT ' + qnt, function(err, rows, fields) {
																if (err) throw err;
																connection.query('UPDATE event_arena_status SET bet_id = ' + stone + ', bet_qnt = ' + qnt + ' WHERE player_id = ' + player_id, function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Puntata completata!", kbBack);
																});
															});
														});
													}else{
														bot.sendMessage(message.chat.id, "Sintassi errata", kbBack);
													}
												};
											});
										}
									});
								};
							});
						});
					});
				}
			};
		});
	});
});

function dragonSym(type){
	if (type == "delle Montagne"){
		return "ðŸ”";
	}else if (type == "dei Cieli"){
		return "â˜ï¸";
	}else if (type == "Infernale"){
		return "ðŸ”¥";
	}else if (type == "dell'OscuritÃ "){
		return "ðŸ”®";
	}else if (type == "dei Mari"){
		return "ðŸŒŠ";
	}else if (type == "dei Ghiacci"){
		return "â„ï¸";
	}
}

function landSym(type){
	if (type == 1){
		return "ðŸ’¥";
	}else if (type == 2){
		return "â›„ï¸";
	}else if (type == 3){
		return "ðŸ’€";
	}else if (type == 4){
		return "ðŸ’¤";
	}else if (type == 5){
		return "ðŸš¶";
	}else if (type == 6){
		return "ðŸ‘º";
	}
}

function setFinishedArena(element, index, array){
	var watcher_id = element.player_id;
	var chat_id = element.chat_id;

	connection.query('SELECT player_id, win, lose, land_type, dragon_1, dragon_2, choice, bet_id, bet_qnt FROM event_arena_status WHERE player_id = ' + watcher_id, function(err, rows, fields) {
		if (err) throw err;

		var dragon1 = rows[0].dragon_1;
		var dragon2 = rows[0].dragon_2;
		var choice = rows[0].choice;
		var landType = rows[0].land_type;
		var bet_id = rows[0].bet_id;
		var bet_qnt = rows[0].bet_qnt;
		var win = rows[0].win;
		var lose = rows[0].lose;

		if (choice == 0){
			connection.query('UPDATE event_arena_status SET extracted = 0, dragon_1 = 0, dragon_2 = 0, land_type = 0, choice = 0, bet_id = 0, bet_qnt = 0, fight_time = NULL WHERE player_id = ' + watcher_id, function(err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(chat_id, "Tempo scaduto per la selezione del drago preferito, torna all'arena per assistere ad un altro scontro");
			});
			return;
		}

		connection.query('SELECT * FROM dragon WHERE id = ' + dragon1, function(err, rows, fields) {
			if (err) throw err;

			var myId = rows[0].id;
			var name1 = rows[0].name;
			if (name1.lenght > 30){
				name1 = name1.substring(0, 30) + "...";
			}
			var myLife = Math.round(parseInt(rows[0].exp*10));
			var totMyLife = myLife;
			var myDmg = parseInt(rows[0].damage)+parseInt(rows[0].claws);
			var myCrit = parseInt(rows[0].critical);
			var myType = rows[0].type;
			var player_id1 = rows[0].player_id;

			connection.query('SELECT class, chat_id, charm_id, reborn FROM player WHERE id = ' + player_id1, function(err, rows, fields) {
				if (err) throw err;

				var reborn = rows[0].reborn;
				var class_id = rows[0].class;
				var charm_id = rows[0].charm_id;
				var chat_id1 = rows[0].chat_id;

				if (charm_id == 602){
					myDmg += 25;
					myCrit += 10;
				}
				if ((class_id == 7) && (reborn == 3)){
					myCrit += 5;
				}
				if ((class_id == 7) && (reborn >= 4)){
					myCrit += 7;
				}

				connection.query('SELECT * FROM dragon WHERE id = ' + dragon2, function(err, rows, fields) {
					if (err) throw err;

					var enemyId = rows[0].player_id;
					var name2 = rows[0].name;
					if (name2.lenght > 30){
						name2 = name2.substring(0, 30) + "...";
					}
					var enemyLife = Math.round(parseInt(rows[0].exp*10));
					var enemyDmg = parseInt(rows[0].damage)+parseInt(rows[0].claws);
					var enemyCrit = parseInt(rows[0].critical);
					var enemyType = rows[0].type;
					var player_id2 = rows[0].player_id;

					connection.query('SELECT class, chat_id, charm_id, reborn FROM player WHERE id = ' + player_id2, function(err, rows, fields) {
						if (err) throw err;

						var reborn2 = rows[0].reborn;
						var class_id2 = rows[0].class;
						var enemyCharm_id = rows[0].charm_id;
						var chat_id2 = rows[0].chat_id;

						if (enemyCharm_id == 602){
							enemyDmg += 25;
							enemyCrit += 10;
						}
						if ((class_id2 == 7) && (reborn2 == 3)){
							enemyCrit += 5;
						}
						if ((class_id2 == 7) && (reborn2 >= 4)){
							enemyCrit += 7;
						}

						var totEnemyLife = enemyLife;

						var rDmg = 0;
						var rDmg2 = 0;
						var killed = 0;
						var code = 0;
						var rand = 0;

						var landRand = 0;
						var landDesc = "";

						var critTxt1 = "";
						var critTxt2 = "";

						if (landType == 1){
							landDesc = "Scottatura";
						}else if (landType == 2){
							landDesc = "Congelamento;"
						}else if (landType == 3){
							landDesc = "Avvelenamento";
						}else if (landType == 4){
							landDesc = "Sonno";
						}else if (landType == 5){
							landDesc = "Rallentamento";
						}else{
							landDesc = "Terrore";
						}

						var weak = 0;

						if ((myType == "dell'OscuritÃ ") && (enemyType == "dei Ghiacci")){
							myDmg = myDmg*1.5;
						}
						if ((myType == "dell'OscuritÃ ") && (enemyType == "dei Cieli")){
							enemyDmg = enemyDmg*1.5;
							weak = 1;
						}

						if ((myType == "dei Ghiacci") && (enemyType == "dei Cieli")){
							myDmg = myDmg*1.5;
						}
						if ((myType == "dei Ghiacci") && (enemyType == "Infernale")){
							enemyDmg = enemyDmg*1.5;
							weak = 1;
						}

						if ((myType == "dei Mari") && (enemyType == "Infernale")){
							myDmg = myDmg*1.5;
						}
						if ((myType == "dei Mari") && (enemyType == "delle Montagne")){
							enemyDmg = enemyDmg*1.5;
							weak = 1;
						}

						if ((myType == "dei Cieli") && (enemyType == "dell'OscuritÃ ")){
							myDmg = myDmg*1.5;
						}
						if ((myType == "dei Cieli") && (enemyType == "dei Ghiacci")){
							enemyDmg = enemyDmg*1.5;
							weak = 1;
						}

						if ((myType == "delle Montagne") && (enemyType == "dei Mari")){
							myDmg = myDmg*1.5;
						}
						if ((myType == "delle Montagne") && (enemyType == "dell'OscuritÃ ")){
							enemyDmg = enemyDmg*1.5;
							weak = 1;
						}

						if ((myType == "Infernale") && (enemyType == "delle Montagne")){
							myDmg = myDmg*1.5;
						}
						if ((myType == "delle Montagne") && (enemyType == "dei Mari")){
							enemyDmg = enemyDmg*1.5;
							weak = 1;
						}

						var actions = [];

						actions.push("La salute di " + name2 + " " + dragonSym(enemyType) + " Ã¨ *" + totEnemyLife + "* hp, quella di " + name1 + " " + dragonSym(myType) + " Ã¨ *" + totMyLife + "* hp");
						actions.push("Lo scontro avviene su un terreno che provoca *" + landDesc + "* " + landSym(landType));
						actions.push("<=>");

						var nextNull = 0;
						var nextMid = 0;
						var nextCrit = 0;
						var nextWeak = 0;

						var nextNull2 = 0;
						var nextMid2 = 0;
						var nextCrit2 = 0;
						var nextWeak2 = 0;

						var landRandB = 0;
						var landRandB2 = 0;
						var landDmg = 0;
						var landDmg2 = 0;

						var hits = 0;
						var hits2 = 0;

						var hit_arr = ["ferisce","sfregia","squarta","urta","infilza"];
						var hit_len = Object.keys(hit_arr).length;

						while (killed == 0) {
							landRandB = Math.random()*100;
							landRandB2 = Math.random()*100;

							if (nextNull == 1){
								actions.push(name1 + " non Ã¨ riuscito a colpire l'avversario!");
								nextNull = 0;
							}else{
								hits2++;

								rDmg = Math.round(Math.random()*(myDmg*2)+myDmg);
								if (nextWeak == 1){
									landDmg = (rDmg/100)*10;
									rDmg -= landDmg;
									nextWeak = 0;
								}

								if (nextMid2 == 1){
									rDmg = rDmg/2;
									nextMid = 0;
								}

								rDmg = Math.round(rDmg);
								enemyLife = Math.round(enemyLife - rDmg);

								// drago 2 >> drago 1

								landDmg2 = (rDmg/100)*10;
								landDmg2 = Math.round(landDmg2);

								if ((landType == 1) && (enemyType != "Infernale")){
									if (landRandB2 < 50){
										actions.push("Per *Scottatura*, " + name2 + " subisce ulteriori " + landDmg2 + " danni");
										rDmg += landDmg;
									}
								}
								if ((landType == 2) && (enemyType != "dei Ghiacci")){
									if (landRandB2 < 40){
										actions.push("Per *Congelamento*, " + name2 + " viene paralizzato dal freddo");
										nextNull = 1;
									}
								}
								if ((landType == 3) && (enemyType != "delle Montagne")){
									if (landRandB2 < 50){
										actions.push("Per *Avvelenamento*, " + name2 + " ha il danno dimezzato");
										nextMid = 1;
									}
								}
								if ((landType == 4) && (enemyType != "dei Cieli")){
									if (landRandB2 < 40){
										actions.push("Per *Sonno*, " + name2 + " subisce un danno critico");
										nextCrit = 1;
									}
								}
								if ((landType == 5) && (enemyType != "dei Mari")){
									if (landRandB2 < 50){
										actions.push("Per *Rallentamento*, il danno di " + name2 + " sarÃ  piÃ¹ debole");
										nextWeak = 1;
									}
								}
								if ((landType == 6) && (enemyType != "dell'OscuritÃ ")){
									if (landRandB2 < 40){
										actions.push("Per *Terrore*, " + name2 + " rimane paralizzato");
										nextNull = 1;
									}
								}

								rand = Math.random()*100;
								if (rand <= myCrit){
									rDmg = rDmg*2;
									critTxt1 = "Danno Critico!";
								}else{
									critTxt1 = "";
								}

								actions.push(name1 + " " + hit_arr[Math.round(Math.random()*hit_len)-1] + " il drago avversario -" + rDmg + " (" + enemyLife + " hp) " + critTxt1);
							}

							if (enemyLife <= 0){
								killed = 1;
								code = 1;
								actions.push("*" + name1 + " Ã¨ il vincitore*! (" + hits + " turni)");
							}else{
								if (nextNull2 == 1){
									actions.push(name2 + " non Ã¨ riuscito a colpire l'avversario!");
									nextNull2 = 0;
								}else{
									hits++;

									rDmg2 = Math.round(Math.random()*(enemyDmg*2)+enemyDmg);
									if (nextWeak2 == 1){
										landDmg = (rDmg/100)*10;
										rDmg2 -= landDmg;
										nextWeak2 = 0;
									}

									if (nextMid2 == 1){
										rDmg2 = rDmg2/2;
										nextMid2 = 0;
									}

									// drago 1 >> drago 2

									landDmg = (rDmg2/100)*10;
									landDmg = Math.round(landDmg);

									if ((landType == 1) && (myType != "Infernale")){
										if (landRandB < 50){
											actions.push("Per *Scottatura*, " + name1 + " subisce ulteriori " + landDmg + " danni");
											rDmg2 += landDmg;
										}
									}
									if ((landType == 2) && (myType != "dei Ghiacci")){
										if (landRandB < 40){
											actions.push("Per *Congelamento*, " + name1 + " 1 viene paralizzato dal freddo");
											nextNull2 = 1;
										}
									}
									if ((landType == 3) && (myType != "delle Montagne")){
										if (landRandB < 50){
											actions.push("Per *Avvelenamento*, " + name1 + " ha il danno dimezzato");
											nextMid2 = 1;
										}
									}
									if ((landType == 4) && (myType != "dei Cieli")){
										if (landRandB < 40){
											actions.push("Per *Sonno*, " + name1 + " subisce un danno critico");
											nextCrit2 = 1;
										}
									}
									if ((landType == 5) && (myType != "dei Mari")){
										if (landRandB < 50){
											actions.push("Per *Rallentamento*, il danno di " + name1 + " sarÃ  piÃ¹ debole");
											nextWeak2 = 1;
										}
									}
									if ((landType == 6) && (myType != "dell'OscuritÃ ")){
										if (landRandB < 40){
											actions.push("Per *Terrore*, " + name1 + " rimane paralizzato");
											nextNull2 = 1;
										}
									}

									rand = Math.random()*100;
									if ((rand <= enemyCrit) || (nextCrit2 == 1)){
										rDmg2 = rDmg2*2;
										critTxt2 = "Danno Critico!";
										nextCrit2 = 0;
									}else{
										critTxt2 = "";
									}

									myLife = Math.round(myLife - rDmg2);
									rDmg2 = Math.round(rDmg2);

									actions.push(name2 + " " + hit_arr[Math.round(Math.random()*hit_len)-1] + " il drago avversario -" + rDmg2 + " (" + myLife + " hp) " + critTxt2);
								}
							};

							if (myLife <= 0){
								killed = 1;						
								code = 2;
								actions.push("*" + name2 + " Ã¨ il vincitore*! (" + hits2 + " turni)");
							}
						}

						var len = parseInt(Object.keys(actions).length);
						var battle = "";

						if (len > 60){
							actions.splice(20, (len-40));
							actions.splice(21, 0, "(...)");
							len = Object.keys(actions).length;
						}

						for (var i = 0; i < len; i++) {
							battle += actions[i] + "\n";
						}
						bot.sendMessage(chat_id, battle, mark);

						if (code == choice){
							connection.query('UPDATE event_arena_status SET extracted = 0, win = win+1, dragon_1 = 0, dragon_2 = 0, land_type = 0, choice = 0, bet_id = 0, bet_qnt = 0, fight_time = NULL WHERE player_id = ' + watcher_id, function(err, rows, fields) {
								if (err) throw err;

								connection.query('SELECT name FROM item WHERE id = ' + bet_id, function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										var stone = (67+Math.round(Math.random()*5+1));

										connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + watcher_id + ',' + stone + ')', function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('SELECT name FROM item WHERE id = ' + stone, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(chat_id, "Hai vinto e ottenuto " + rows[0].name + "!\nTorna all'arena per fare la prossima scelta!");
										});
									}else{
										var qnt = bet_qnt*2;
										for (var i = 0; i < qnt; i++) {
											connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + watcher_id + ',' + bet_id + ')', function(err, rows, fields) {
												if (err) throw err;
											});
										}
										bot.sendMessage(chat_id, "*Hai vinto* e ottenuto " + qnt + "x " + rows[0].name + "!\nTorna all'arena per fare la prossima scelta!", mark);
									}

									if ((parseInt(win)+1) % 10 == 0){
										var chest = Math.round(Math.random()*2+3);

										connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + watcher_id + ',' + chest + ')', function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('SELECT name FROM name WHERE id = ' + chest, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(chat_id, "Come bonus per le vittorie ottenute hai vinto anche uno " + rows[0].name + "!");
										});
									}
								});
							});
						}else{
							connection.query('UPDATE event_arena_status SET extracted = 0, lose = lose+1, dragon_1 = 0, dragon_2 = 0, land_type = 0, choice = 0, bet_id = 0, bet_qnt = 0, fight_time = NULL WHERE player_id = ' + watcher_id, function(err, rows, fields) {
								if (err) throw err;
								connection.query('SELECT name FROM item WHERE id = ' + bet_id, function(err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0){
										bot.sendMessage(chat_id, "*Hai perso!*\nTorna all'arena per fare la prossima scelta!", mark);
									}else{
										bot.sendMessage(chat_id, "*Hai perso* e hai lasciato " + bet_qnt + "x " + rows[0].name + " alla segreteria dell'arena!\nTorna all'arena per fare la prossima scelta!", mark);
									}
								});
							});
						}

						//1 per drago 1, 2 per drago 2

						var dragon_win = 0;
						var dragon_lose = 0;

						if (choice == 1){
							dragon_win = dragon1;
							dragon_lose = dragon2;

							connection.query('UPDATE player SET money = money+1000 WHERE id = ' + player_id1, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id1, "Il tuo drago ha ottenuto una vittoria nell'arena! Hai vinto 1.000 Â§!");
							});
						}else{	
							dragon_win = dragon2;							
							dragon_lose = dragon1;

							connection.query('UPDATE player SET money = money+1000 WHERE id = ' + player_id2, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id2, "Il tuo drago ha ottenuto una vittoria nell'arena! Hai vinto 1.000 Â§!");
							});
						}

						connection.query('SELECT dragon_id FROM event_arena_dragon WHERE dragon_id = ' + dragon_win, function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								connection.query('INSERT INTO event_arena_dragon (dragon_id, win, lose) VALUES (' + dragon_win + ', 1, 0)', function(err, rows, fields) {
									if (err) throw err;
								});
							}else{
								connection.query('UPDATE event_arena_dragon SET win = win+1 WHERE dragon_id = ' + dragon_win, function(err, rows, fields) {
									if (err) throw err;
								});
							}
						});
						connection.query('SELECT dragon_id FROM event_arena_dragon WHERE dragon_id = ' + dragon_lose, function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								connection.query('INSERT INTO event_arena_dragon (dragon_id, win, lose) VALUES (' + dragon_lose + ', 0, 1)', function(err, rows, fields) {
									if (err) throw err;
								});
							}else{
								connection.query('UPDATE event_arena_dragon SET lose = lose+1 WHERE dragon_id = ' + dragon_lose, function(err, rows, fields) {
									if (err) throw err;
								});
							}
						});
					});
				});
			});
		});
	});
};

bot.onText(/affronta boss|^boss ðŸ— |^boss/i, function(message) {
	var iKeys = [];
	var boss = "";
	var team_id = 0;
	calcLife(message);

	var bossKb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Affronta Boss"],["Torna al menu"]]
		}
	};

	var bossKb2 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Visualizza Boss"],["Torna al menu"]]
		}
	};

	connection.query('SELECT team_player.team_id, COUNT(*) As num FROM `player`, team_player WHERE player.nickname = "' + message.from.username + '" AND team_player.player_id = player.id', function(err, rows, fields) {
		if (err) throw err;
		var team_id = 0;
		if (rows[0].num > 0){
			team_id = rows[0].team_id;
		}else{
			bot.sendMessage(message.chat.id, "Puoi affrontare i boss solo se sei in un team.", back);
			return;
		}

		connection.query('SELECT players FROM team WHERE id = ' + team_id, function(err, rows, fields) {
			if (err) throw err;

			if ((rows[0].players < 3) && (team_id != 2)){
				bot.sendMessage(message.chat.id, "Il team deve possedere almeno 3 membri.", back);
				return;
			}

			connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
				if (err) throw err;
				var player_id = rows[0].id;
				var boss_id = rows[0].boss_id;
				var money = rows[0].money;
				var boss_time = rows[0].boss_time;
				var player_exp = rows[0].exp;
				var player_life = rows[0].life;
				var player_total_life = rows[0].total_life;
				var craft_count = rows[0].craft_count;
				var reborn = rows[0].reborn;
				var class_id = rows[0].class;

				var account_id = (rows[0].account_id).toString();
				if (banlist_id.indexOf(account_id) != -1){
					var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
					bot.sendMessage(message.chat.id, text, mark);
					return;
				}
				if (rows[0].holiday == 1){
					bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
					return;
				}

				if ((class_id == 1) && (reborn >= 3)){
					bot.sendMessage(message.chat.id, "Raggiunta questa Rinascita la Vocazione Ã¨ obbligatoria, la puoi scegliere nella sezione Giocatore > Vocazione", back);
					return;
				}

				helpMsg(message.chat.id, player_id, 3);

				if (rows[0].mission_id != 0){
					bot.sendMessage(message.chat.id, "Non puoi affrontare i boss finchÃ¨ sei in missione.", bossKb2);
					return;
				}
				/*
				if (rows[0].mission_special_id != 0){
					var time = new Date(rows[0].mission_special_time_end);
					bot.sendMessage(message.chat.id, "Sei in itinerario fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), abort_mission);
					return;
				}
				*/

				if ((rows[0].travel_id != 0) || (rows[0].cave_id != 0)){
					if (rows[0].travel_id != 0){
						var time = new Date(rows[0].travel_time_end);
					}else{
						var time = new Date(rows[0].cave_time_end);				
					}
					bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), bossKb2);
					return;
				}

				if (player_life <= 0){
					bot.sendMessage(message.chat.id, "Non hai abbastanza salute per combattere contro il boss! Riprova domani.", back);
					return;
				}

				if (boss_time != null){
					var time = new Date(boss_time);
					bot.sendMessage(message.chat.id, "Non puoi ancora affrontare i boss, ti sei appena trasferito (" + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear() + ")", back);
					return;
				}

				if (Math.floor(player_exp/10) < 5){
					bot.sendMessage(message.chat.id, "Il tuo danno a questo livello Ã¨ troppo basso, Ã¨ sconsigliato procedere fino al raggiungimento del livello 5", back);
					return;
				}

				if (boss_id == 0){
					connection.query('SELECT team.boss_count, boss_team.life, boss_team.total_life, boss_team.killedby, team.boss_respawn, boss.name FROM team, boss_team, boss WHERE team.id = team_id AND boss_team.boss_id = boss.id AND unlocked = 1 AND team_id = ' + team_id + ' ORDER BY boss_id', function(err, rows, fields) {
						if (err) throw err;

						var boss_list = "\n";
						if (Object.keys(rows).length == 0){
							bot.sendMessage(message.chat.id, "Il tuo team non Ã¨ ancora abilitato a visualizzare i boss, segnala a @fenix45.", back);
							return;
						}
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].life <= 0){
								boss_list += "*" + rows[i].name + "* (ucciso da " + rows[i].killedby.replace(new RegExp("_", "g"), " ") + ")\n";
							}else{
								iKeys.push(["Affronta boss: " + rows[i].name]);
								boss_list += "*" + rows[i].name + "* (" + rows[i].life + "/" + rows[i].total_life + " hp)\n";
							}
						}
						if (rows[0].boss_respawn != null){
							var d = new Date(rows[0].boss_respawn);
							var short_time = addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + ":" + addZero(d.getSeconds());
							var short_date = addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();

							boss_list += "\nI boss tornano in vita il " + short_date + " alle " + short_time;
						}

						var boss_count = rows[0].boss_count;

						if ((reborn == 5) && (boss_count < 100)){
							console.log("NOBOSS: " + reborn + "-" + player_exp/10 + "-" + boss_count);
							bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ troppo alto per affrontare i boss in questo team", back);
							return;
						}
						if ((player_exp/10 >= 300) && (boss_count < 100)){
							console.log("NOBOSS: " + reborn + "-" + player_exp/10 + "-" + boss_count);
							bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ troppo alto per affrontare i boss in questo team", back);
							return;
						}
						if ((player_exp/10 >= 200) && (boss_count < 100)){
							console.log("NOBOSS: " + reborn + "-" + player_exp/10 + "-" + boss_count);
							bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ troppo alto per affrontare i boss in questo team", back);
							return;
						}

						iKeys.push(["Torna al menu"]);

						if (message.text.indexOf(":") != -1){
							var boss = message.text.substring(message.text.indexOf(":")+1).trim();

							connection.query('SELECT boss_team.id, boss.description, boss.name FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND unlocked = 1 AND team_id = ' + team_id + ' AND name = "' + boss + '" AND life > 0', function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length > 0){
									var boss_id = rows[0].id;
									var desc = "";
									if (rows[0].description != null){
										desc = rows[0].description + "\n\n";
									}
									var name = rows[0].name;
									connection.query('UPDATE `player` SET `boss_id`=' + boss_id + ' WHERE `id`=' + player_id, function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, desc + "Hai deciso di affrontare *" + name + "*!", bossKb);
									});
								}else{
									bot.sendMessage(message.chat.id, "Questo boss non Ã¨ valido!", back);
								}
							});

							connection.query('SELECT MAX(boss_id) As max FROM boss_team WHERE team_id = ' + team_id, function(err, rows, fields) {
								if (err) throw err;
								if (parseInt(rows[0].max) < 31){
									console.log("Boss massimo: " + rows[0].max);
									connection.query('SELECT * FROM boss WHERE id > ' + rows[0].max, function(err, rows, fields) {
										if (err) throw err;
										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											if (rows[i].id == 1){
												connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',1,' + team_id + ')', function(err, rows, fields) {
													if (err) throw err;
												});
											}else{
												connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',0,' + team_id + ')', function(err, rows, fields) {
													if (err) throw err;
												});
											}
											console.log("Boss mancante aggiunto: " + rows[i].id);
										}
									});	
								}
							});

							return;
						};

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, "Seleziona il boss, i partecipanti ricevono il bottino in base al danno.\nI boss tornano in vita ogni 48 ore dopo aver ucciso il primo.\nPer sbloccare i boss successivi, il tuo team deve sconfiggerli in ordine.\n" + boss_list, kb);
					});
				}else{
					connection.query('SELECT boss_team.life, boss_team.total_life, boss.name, boss_team.unlocked FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND boss_team.id = ' + boss_id, function(err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0){
							bot.sendMessage(message.chat.id, "Errore misterioso, contatta l'admin per segnalarlo.", back);
							return;
						}

						if (rows[0].unlocked == 0){
							connection.query('UPDATE `player` SET `boss_id`=0 WHERE `id`=' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Sei pronto a tornare a sfidare il boss!", bossKb);
							});
							return;
						}

						var boss_life = rows[0].life;

						connection.query('UPDATE `player` SET magic_to = 1 WHERE id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
						});

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": [["Attacco Leggero","Attacco Pesante"],["Incantesimi"],["Utilizzabili Boss"],["Visualizza Boss"],["Torna al menu"]]
							}
						};

						bot.sendMessage(message.chat.id, "*La tua salute*: " + player_life + " / " + player_total_life + "\n*Salute " + rows[0].name + "*: " + rows[0].life + " / " + rows[0].total_life + "\nCosa vuoi fare?", kb);
					});
				};
			});
		});
	});
});

bot.onText(/^Incantesimi$/i, function(message) {

	//if (message.from.username != "fenix45"){
	//	bot.sendMessage(message.chat.id, "A breve", back);
	//	return;
	//}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var to = rows[0].magic_to;

		if (to == 0){
			return;
		}

		var text = 	"Incantesimi:\n" +
			"*Furia dei Mari*: Ricarica la salute in base al danno assorbito (non annulla l'attacco!)\n" +
			"*Tempesta Folgorante*: Paralizza il bersaglio per alcuni turni\n" +
			"*Impeto di Fiamme*: Infligge un notevole danno al bersaglio\n" +
			"*Ira Astrale*: Aumenta la probabilitÃ  di critico per alcuni turni (dal turno successivo)\n" +
			"\nSe gli incantesimi vengono applicati al boss, ne beneficiano tutti i giocatori che lo attaccano.";

		connection.query('DELETE FROM magic WHERE quantity <= 0', function(err, rows, fields) {
			if (err) throw err;

			connection.query('SELECT type, power, quantity FROM magic WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0){
					var n = "";
					var iKeys = [];
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].type == 1){
							n = "Furia dei Mari";
						}else if (rows[i].type == 2){
							n = "Tempesta Folgorante";
						}else if (rows[i].type == 3){
							n = "Impeto di Fiamme";
						}else if (rows[i].type == 4){
							n = "Ira Astrale";
						}
						iKeys.push(["Lancia " + n + " " + rows[i].power + " (" + rows[i].quantity + ")"]);
					}

					if (to == 1){
						iKeys.push(["Affronta Boss"]);
					}else if (to == 2){
						iKeys.push(["Torna al Dungeon"]);
					}
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					if (to == 1){
						extra = "il boss";
					}else if (to == 2){
						extra = "il mostro";
					}

					bot.sendMessage(message.chat.id, text + "\nSeleziona l'incantesimo da utilizzare contro " + extra + "!", kb);
				}else{
					bot.sendMessage(message.chat.id, text + "\nNon possiedi alcun incantesimo, puoi ottenerli attraverso la Sintesi!", back);
					return;
				}
			});
		});
	});
});

bot.onText(/^Attacco leggero|^Attacco pesante|^Lancia ([a-zA-Z ]+) ([0-9]+)/i, function(message, match) {

	var bossKb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Affronta Boss"],["Torna al menu"]]
		}
	};

	var double = 0;
	if (message.text.indexOf("Pesante") != -1){
		double = 1;
	}

	fixBoss();

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Non ho trovato il tuo account", back);
			return;
		}

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (Math.floor(rows[0].exp/10) < 5){
			bot.sendMessage(message.chat.id, "Il tuo danno a questo livello Ã¨ troppo basso, Ã¨ sconsigliato procedere fino al raggiungimento del livello 5", back);
			return;
		}

		var player_id = rows[0].id;
		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var boss_time = rows[0].boss_time;
		var reborn = rows[0].reborn;
		var class_id = rows[0].class;
		var player_paralyzed = rows[0].paralyzed;
		var automagic1 = rows[0].weapon_enchant_bonus;

		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;

		if ((boost_mission == 0) && (boost_id != 0)){
			connection.query('UPDATE player SET boost_id = 0 WHERE id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});
		}

		var critical = parseInt(rows[0].weapon_crit);
		var critical_armor = parseInt(rows[0].weapon2_crit);
		var critical_shield = parseInt(rows[0].weapon3_crit);

		if (charm_id == 404){
			critical += 6;
		}
		if (charm_id == 493){
			critical += 2;
		}
		if (charm_id == 494){
			critical += 4;
		}
		if (charm_id == 495){
			critical_armor += 3;
		}
		if (charm_id == 496){
			critical_shield += 3;
		}
		if ((class_id == 2) && (reborn == 3)){
			critical_armor += 5;
		}
		if ((class_id == 2) && (reborn >= 4)){
			critical_armor += 5;
			critical_shield += 5;
		}
		if ((class_id == 4) && (reborn == 3)){
			critical += 2;
		}
		if ((class_id == 4) && (reborn >= 4)){
			critical += 7;
			critical_armor += 7;
			critical_shield += 7;
		}
		if ((class_id == 5) && (reborn == 3)){
			critical_shield += 3;
		}
		if ((class_id == 5) && (reborn >= 4)){
			critical_shield += 5;
		}
		if ((class_id == 6) && (reborn == 3)){
			critical_armor += 2;
		}
		if ((class_id == 6) && (reborn == 3)){
			critical_shield += 2;
		}
		if ((class_id == 6) && (reborn >= 4)){
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn >= 4)){
			critical_shield += 7;
		}
		if ((class_id == 6) && (reborn == 5)){
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn == 5)){
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 3)){
			critical_shield += 5;
		}
		if ((class_id == 8) && (reborn >= 4)){
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 5)){
			critical += 7;
		}
		if ((class_id == 9) && (reborn == 3)){
			critical += 2;
			critical_shield += 2;
		}
		if ((class_id == 9) && (reborn >= 4)){
			critical += 7;
			critical_shield += 7;
		}

		var danno = Math.round(Math.random()*(rows[0].exp/10+rows[0].weapon)+rows[0].weapon);
		danno += rows[0].weapon_enchant;

		var charm_id = rows[0].charm_id;
		var player_exp = rows[0].exp;

		if (charm_id == 62){
			danno = danno+5;
		}else if (charm_id == 184){
			danno = danno+15;
		}else if (charm_id == 188){
			danno = danno+20;
		}
		var bonus = 0;
		if (rows[0].weapon2 < 0){
			var bonus = Math.abs(rows[0].weapon2)+Math.abs(rows[0].weapon3)+rows[0].weapon2_enchant+rows[0].weapon3_enchant;
			bonus = Math.round(Math.random()*((rows[0].exp/10+bonus)/2)+bonus);
		}
		var shield = rows[0].weapon3;
		var armor = rows[0].weapon2;

		danno = parseInt(danno);
		bonus = parseInt(bonus);

		var magic = 0;
		var magicId = 0;
		var magicPow = 0;

		if (message.text.indexOf("Lancia") != -1){
			if (rows[0].magic_to == 1){
				//match[1] = match[1].slice(0, -1);
				if (match[1] == "Furia dei Mari"){
					magic = 1;
				}else if (match[1] == "Tempesta Folgorante"){
					magic = 2;
				}else if (match[1] == "Impeto di Fiamme"){
					magic = 3;
				}else if (match[1] == "Ira Astrale"){
					magic = 4;
				}
			}else{
				return;
			}
		}

		if (rows[0].mission_id != 0){
			bot.sendMessage(message.chat.id, "Non puoi affrontare i boss finchÃ¨ sei in missione.", back);
			return;
		}
		/*
		if (rows[0].mission_special_id != 0){
			var time = new Date(rows[0].mission_special_time_end);
			bot.sendMessage(message.chat.id, "Sei in itinerario fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), abort_mission);
			return;
		}
		*/

		if ((rows[0].travel_id != 0) || (rows[0].cave_id != 0)){
			if (rows[0].travel_id != 0){
				var time = new Date(rows[0].travel_time_end);
			}else{
				var time = new Date(rows[0].cave_time_end);
			}
			bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), abort_travel);
			return;
		}

		var pow = 0;
		if (match[2] != undefined){
			pow = match[2];
		}

		connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 10', function(err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0){
				abBonus = parseInt(rows[0].ability_level)*2;
			}

			var magicDouble = 0;
			connection.query('SELECT type, id, power, quantity FROM magic WHERE player_id = ' + player_id + ' AND power = ' + pow + ' AND type = ' + magic, function(err, rows, fields) {
				if (err) throw err;

				if (magic != 0){
					if (Object.keys(rows).length > 0){
						if (rows[0].quantity == 0){
							bot.sendMessage(message.chat.id, "Hai terminato gli utilizzi dell'incantesimo selezionato!", bossKb);
							return;
						}else{
							magicId = rows[0].id;
							magicPow = rows[0].power;

							var rand = Math.random()*100;
							if ((class_id == 4) && ((magic == 3) || (magic == 4)) && (reborn == 5)){
								abBonus += 25;
							}
							if (rand < abBonus){
								magicPow = magicPow*2;
								magicDouble = 1;
							}
						}
					}else{
						bot.sendMessage(message.chat.id, "Non possiedi l'incantesimo selezionato!", bossKb);
						return;
					}
				}

				var automagic = 0;

				if (magic == 0){
					var magicrand = Math.random()*100;
					if (magicrand < 2){
						if (weapon_id == 630){
							magic = 2;
							automagic = 1;
							magicPow = 50;
						}else if (weapon_id == 631){
							magic = 3;
							automagic = 1;
							magicPow = 50;
						}else if (weapon_id == 632){
							magic = 1;
							automagic = 1;
							magicPow = 50;
						}
					}
					if (magicrand < 5){
						if (weapon_id == 638){
							magic = 2;
							automagic = 1;					
							magicPow = 150;
						}else if (weapon_id == 639){
							magic = 3;
							automagic = 1;
							magicPow = 150;
						}else if (weapon_id == 640){
							magic = 1;
							automagic = 1;
							magicPow = 150;
						}
					}
					if ((magicrand > 80) && (automagic1 == 1)){
						var magicrand2 = Math.random()*100;
						if (magicrand2 < 30){
							magic = 1;
							automagic = 1;
							magicPow = 50;
						}else if (magicrand2 < 60){
							magic = 2;
							automagic = 1;
							magicPow = 100;
						}else{
							magic = 3;
							automagic = 1;
							magicPow = 50;
						}
					}
				}

				if (magicDouble == 0){
					if ((class_id == 2) && (reborn == 3)){
						magicPow += magicPow*0.1;
					}
					if ((class_id == 2) && (reborn >= 4)){
						magicPow += magicPow*0.25;
					}
					if ((class_id == 2) && (reborn == 5)){
						magicPow += magicPow*0.5;
					}
					if ((class_id == 3) && (reborn == 5)){
						magicPow += magicPow*0.3;
					}
				}

				connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 1', function(err, rows, fields) {
					if (err) throw err;

					var abBonus = 0;
					if (Object.keys(rows).length > 0){
						abBonus = rows[0].ability_level;
						critical += abBonus;
						critical_armor += abBonus;
						critical_shield += abBonus;
					}

					connection.query('SELECT team_player.team_id, team_player.suspended, COUNT(*) As num FROM `player`, team_player WHERE player.nickname = "' + message.from.username + '" AND team_player.player_id = player.id', function(err, rows, fields) {
						if (err) throw err;
						var team_id = 0;
						if (rows[0].num > 0){
							team_id = rows[0].team_id;
						}else{
							bot.sendMessage(message.chat.id, "Puoi affrontare i boss solo se sei in un team.", back);
							return;
						}

						if (boss_time != null){
							bot.sendMessage(message.chat.id, "Non puoi ancora affrontare i boss, ti sei appena trasferito.", back);
							return;				
						}

						if (rows[0].suspended == 1){
							bot.sendMessage(message.chat.id, "Non puoi attaccare i boss finchÃ¨ sei sospeso", back);
							return;
						}

						connection.query('SELECT players FROM team WHERE id = ' + team_id, function(err, rows, fields) {
							if (err) throw err;

							if ((rows[0].players < 3) && (team_id != 2)){
								bot.sendMessage(message.chat.id, "Il team deve possedere almeno 3 membri.", back);
								return;
							}

							connection.query('SELECT critical, damage, defense, claws, saddle FROM dragon WHERE player_id=' + player_id, function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length > 0){
									if ((class_id == 7) && (reborn > 1)){
										rows[0].claws += rows[0].claws*0.5;
									}
									if ((class_id == 7) && (reborn > 1)){
										rows[0].saddle += rows[0].saddle*0.5;
									}
									if ((class_id == 7) && (reborn >= 4)){
										rows[0].damage += rows[0].damage*0.5;
									}
									if ((class_id == 7) && (reborn >= 4)){
										rows[0].defense += rows[0].defense*0.5;
									}
									danno += parseInt(rows[0].damage);
									danno += parseInt(rows[0].claws);
									bonus += parseInt(rows[0].defense);
									bonus += parseInt(rows[0].saddle);
									if (charm_id == 602){
										danno += 25;
									}
									var dragon_crit = rows[0].critical;
									if ((class_id == 7) && (reborn == 3)){
										dragon_crit += 5;
									}
									if ((class_id == 7) && (reborn >= 4)){
										dragon_crit += 7;
									}
									if ((class_id == 7) && (reborn == 5)){
										critical += dragon_crit/2;
									}
								}

								connection.query('SELECT * FROM player WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									var boss_id = rows[0].boss_id;
									var money = rows[0].money;
									var player_exp = rows[0].exp;
									var player_life = rows[0].life;
									var player_total_life = rows[0].total_life;
									var craft_count = rows[0].craft_count;

									if (player_life <= 0){
										bot.sendMessage(message.chat.id, "Non abbastanza salute per combattere contro il boss! Riprova domani.", back);
										return;
									}

									if (boss_id > 0){
										connection.query('SELECT boss_team.life, boss_team.countdown, boss_team.paralyzed, boss.id As bossNum, boss_team.critic, boss_team.id, boss_team.total_life, boss.name, boss_team.unlocked FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND boss_team.id = ' + boss_id, function(err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length == 0){
												bot.sendMessage(message.chat.id, "Errore misterioso, contatta l'admin per segnalarlo.", back);
												return;
											}

											var boss_num = rows[0].bossNum;
											if (rows[0].unlocked == 0){
												connection.query('UPDATE `player` SET `boss_id`=0 WHERE `id`=' + player_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Sei pronto a tornare a sfidare il boss!", bossKb);
												});
												return;
											}

											if (boss_num == 31){
												if ((magic != 0) && (automagic == 0)){
													bot.sendMessage(message.chat.id, "Questo boss Ã¨ immune agli incantesimi lanciati manualmente!");
													magic = 0;
												}
											}

											var boss_life = rows[0].life;
											var critic = rows[0].critic;
											var countdown = rows[0].countdown;
											var boss_total_life = rows[0].total_life;

											var vita;
											var vita_tot;
											if (boss_life => 0){
												var boss_drop = boss_total_life/10;
												var critical_rand = Math.round(Math.random()*100)+1;
												var crit_bool = 0;
												var crit_txt = "";

												if (double == 1){
													danno = danno*1.5;
												}

												if (crazyMode == 1){
													danno = danno*2;
												}

												if (critic > 0){
													critical = 80;
												}

												if (critical_rand <= critical){
													danno = danno*2;
													crit_bool = 1;
													setAchievement(message.chat.id, player_id, 33, 1);
												}

												var magic_txt = "";
												if (magic == 3){
													var prop = 100*magicPow/200;
													danno = danno*(prop/15);
													if (magicDouble == 1){
														magic_txt = "con un incantesimo (x2), ";
													}else{
														magic_txt = "con un incantesimo, ";
													}
												}

												var magic_txt2 = "";
												var extra_bonus = 0;
												if (magic == 1){
													var prop = 100*magicPow/200;
													extra_bonus = bonus*(prop/5);
													if (magicDouble == 1){
														magic_txt2 = ", assorbito grazie ad un incantesimo (x2)";
													}else{
														magic_txt2 = ", assorbito grazie ad un incantesimo";
													}
												}

												if ((boost_mission > 0) && (boost_id == 6)){
													connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
													});
													danno = danno*2;
												}

												if ((class_id == 8) && (reborn > 1)){
													danno += danno*0.1;
												}
												if ((class_id == 8) && (reborn == 5)){
													danno += danno*0.1;
												}
												if ((class_id == 8) && ((reborn == 3) || (reborn >= 4))){
													danno += danno*0.07;
												}

												//638 - Hoenir
												//639 - Xocotl
												//640 - Hydros

												if (boss_num == 28){			//Hoenir - Elettro
													if (weapon_id == 638){
														danno = 0;
													}
													if (weapon_id == 640){
														danno = danno*1.5;		//Acqua >> Elettro
													}
													if (weapon_id == 639){
														danno = danno*0.5;		//Fuoco > Elettro
													}
												}
												if (boss_num == 29){			//Hydros - Acqua
													if (weapon_id == 640){
														danno = 0;
													}
													if (weapon_id == 639){
														danno = danno*1.5;		//Fuoco >> Acqua
													}
													if (weapon_id == 638){
														danno = danno*0.5;		//Elettro > Acqua
													}
												}
												if (boss_num == 30){			//Xocotl - Fuoco
													if (weapon_id == 639){
														danno = 0;
													}
													if (weapon_id == 638){
														danno = danno*1.5;		//Elettro >> Fuoco
													}
													if (weapon_id == 640){
														danno = danno*0.5;		//Acqua > Fuoco
													}
												}

												danno = Math.floor(danno);

												var multi = Math.round(Math.floor(player_exp/10)/10);
												if (multi >= 5){
													danno = danno*5;
												}else{
													danno = danno*multi;
												}

												var kb = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Attacco Leggero","Attacco Pesante"],["Incantesimi"],["Utilizzabili Boss"],["Visualizza Boss"],["Torna al menu"]]
													}
												};

												var next = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														one_time_keyboard: true,
														"keyboard": [["Continua"],["Torna al menu"]]
													}
												};

												var status = "Normale";

												if (rows[0].paralyzed > 0){
													status = "Paralizzato (" + rows[0].paralyzed + " turni)";
												}
												if (rows[0].critic > 0){
													status = "Vulnerabile (" + rows[0].critic + " turni)";
												}

												bot.sendMessage(message.chat.id, "Battaglia contro il boss:\nStato boss: " + status + "\nSalute boss: *" + boss_life + "* hp\nLa tua salute: *" + player_life + "* hp", next).then(function() {
													answerCallbacks[message.chat.id] = function(answer) {

														if (answer.text != "Continua"){
															return;
														}

														if (magic != 0){
															setAchievement(message.chat.id, player_id, 6, 1);
														}

														var meParalyzed = 0;
														if (player_paralyzed > 0){
															connection.query('UPDATE player SET paralyzed = paralyzed-1 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															meParalyzed = 1;
															danno = 0;
														}

														if ((magic == 2) && (meParalyzed == 0)){
															var turn = 0;
															turn = Math.floor(magicPow/100)+1;
															var r = Math.random()*100;
															if ((automagic == 1) && (r < 50))
																turn++;
															connection.query('UPDATE boss_team SET paralyzed = ' + turn + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																if (err) throw err;
																if (magicDouble == 1){
																	bot.sendMessage(message.chat.id, "Il boss Ã¨ stato paralizzato per " + turn + " turni (x2)!");
																}else{
																	bot.sendMessage(message.chat.id, "Il boss Ã¨ stato paralizzato per " + turn + " turni!");
																}
															});
														}

														if ((magic == 4) && (meParalyzed == 0)){
															var turn = 0;
															turn = Math.floor(magicPow/100)+1;
															connection.query('UPDATE boss_team SET critic = ' + turn + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																if (err) throw err;
																if (magicDouble == 1){
																	bot.sendMessage(message.chat.id, "Il boss Ã¨ vulnerabile ai colpi critici per " + turn + " turni (x2)!");
																}else{
																	bot.sendMessage(message.chat.id, "Il boss Ã¨ vulnerabile ai colpi critici per " + turn + " turni!");
																}
															});
														}

														connection.query('SELECT boss_team.life, boss_team.paralyzed, boss_team.critic, boss_team.total_life FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND boss_team.id = ' + boss_id, function(err, rows, fields) {
															if (err) throw err;

															var lifeB = rows[0].life;	
															var paralyzed = rows[0].paralyzed;
															var critic = rows[0].critic;

															if (lifeB < 0){
																bot.sendMessage(message.chat.id, "Il boss Ã¨ giÃ  stato sconfitto", bossKb);
																return;
															}

															if (paralyzed > 0){
																// Riduce il count sotto
															}
															if (critic > 0){
																connection.query('UPDATE boss_team SET critic = critic-1 WHERE id = ' + boss_id, function(err, rows, fields) {
																	if (err) throw err;
																});
															}

															connection.query('UPDATE `boss_team` SET `life`=life-' + danno + ' WHERE id=' + boss_id, function(err, rows, fields) {
																if (err) throw err;
															});

															connection.query('INSERT INTO boss_damage(boss_id, player_id, team_id, damage) VALUES (' + boss_id + ',' + player_id + ',' + team_id + ',' + danno + ')', function(err, rows, fields) {
																if (err) throw err;
															});

															if ((magic != 0) && (automagic == 0) && (meParalyzed == 0)){
																if (magic != 3){		//SCALA MAGIE ECCETTO FIAMME
																	connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields){
																		if (err) throw err;
																		console.log("Magia con ID " + magicId + " utilizzata");
																	});
																}
															}

															lifeB = lifeB-danno;

															setAchievement(message.chat.id, player_id, 2, danno);

															if (lifeB <= 0){
																if ((magic != 0) && (automagic == 0) && (meParalyzed == 0)){
																	if (magic == 3){	//SCALA SOLO FIAMME
																		connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields){
																			if (err) throw err;
																			console.log("Magia con ID " + magicId + " utilizzata");
																		});
																	}
																}

																finishedBoss(message, boss_id);

																connection.query('SELECT boss_respawn FROM team WHERE id = ' + team_id, function(err, rows, fields) {
																	if (err) throw err;
																	if (rows[0].boss_respawn == null){
																		var now = new Date();
																		now.setHours(now.getHours() + 48);
																		var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
																		var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());							

																		connection.query('UPDATE team SET boss_respawn = "' + long_date + '" WHERE id = ' + team_id, function(err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il primo boss Ã¨ stato ucciso, il tuo team ha tempo fino alle " + short_date + " di dopodomani prima che i boss tornino in vita!");
																		});
																	}
																});

																var bonus_drop = 0;
																var bonus_act = 0;

																connection.query('SELECT T2.players, T2.level FROM team T1 JOIN team T2 ON T1.child_team = T2.id WHERE T1.id = ' + team_id, function (err, rows, fields){
																	if (err) throw err;

																	//Se questa Ã¨ la madre
																	if (Object.keys(rows).length > 0){
																		if (rows[0].level >= 5){
																			bonus_drop += Math.round(parseInt(rows[0].players)*100)/2;
																			bonus_act = 1;
																		}
																	}

																	connection.query('SELECT T2.players, T2.level FROM team T1 JOIN team T2 ON T1.id = T2.id WHERE T1.child_team = ' + team_id, function (err, rows, fields){
																		if (err) throw err;

																		//Se questa Ã¨ la accademia
																		if (Object.keys(rows).length > 0){
																			if ((rows[0].level >= 5) && (bonus_act == 0)){
																				bonus_drop += Math.round(parseInt(rows[0].players)*100)/2;
																			}
																		}

																		connection.query('SELECT player.id, player.nickname, player.chat_id, (SELECT COUNT(nickname) FROM `player`, team_player WHERE player.id = team_player.player_id AND team_player.team_id = ' + team_id + ') As num FROM `player`, team_player WHERE player.id = team_player.player_id AND team_player.team_id = ' + team_id, function(err, rows, fields) {
																			if (err) throw err;
																			var drop = parseInt((boss_drop) + (parseInt(rows[0].num)*20));
																			bonus_drop += parseInt(rows[0].num*100);

																			if (Object.keys(rows).length > 0){
																				if (rows[0].num > 0){
																					teamBoss(team_id, bonus_drop, message);
																				}
																			}

																			var now = new Date();
																			var rand = Math.round(Math.random()*5+3);
																			now.setHours(now.getHours() + rand);
																			var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

																			connection.query('UPDATE boss_team SET paralyzed = 0, critic = 0, killedby = "' + message.from.username + '" WHERE id = ' + boss_id, function(err, rows, fields) {
																				if (err) throw err;

																				connection.query('SELECT boss_id FROM boss_team WHERE id = ' + boss_id, function(err, rows, fields) {
																					if (Object.keys(rows).length > 0){
																						connection.query('UPDATE boss_team SET unlocked = 1 WHERE team_id = ' + team_id + ' AND boss_id = ' + (parseInt(rows[0].boss_id)+1), function(err, rows, fields) {
																							if (err) throw err;
																						});
																					}
																				});

																				connection.query('UPDATE player SET money=money+' + drop + ' WHERE id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;

																					var randCaps = Math.round(Math.random()*100);
																					if ((randCaps < 2) && (player_exp > 500)){
																						connection.query('SELECT COUNT(*) As num FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 169', function(err, rows, fields) {
																							if (err) throw err;

																							if (rows[0].num == 0){
																								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',169)', function(err, rows, fields) {
																									if (err) throw err;
																									bot.sendMessage(message.chat.id, "Hai ottenuto una RARISSIMA *Capsula di Antimateria*!", back);
																								});
																							};
																						});
																					}

																					if (boss_num == 20){
																						connection.query('UPDATE team SET kill_num1 = kill_num1+1 WHERE id = ' + team_id, function(err, rows, fields) {
																							if (err) throw err;
																						});
																					}else if (boss_num == 31){
																						connection.query('UPDATE team SET kill_num2 = kill_num2+1 WHERE id = ' + team_id, function(err, rows, fields) {
																							if (err) throw err;
																						});
																					}

																					connection.query('UPDATE team SET boss_count=boss_count+1 WHERE id = ' + team_id, function(err, rows, fields) {
																						if (err) throw err;
																						bot.sendMessage(message.chat.id, "Hai UCCISO il boss, ottenuto *" + drop + "* Â§ mentre il team ha guadagnato *" + bonus_drop + "* Â§!\nInoltre hai sbloccato il boss successivo!", bossKb);
																						setAchievement(message.chat.id, player_id, 19, 1);
																					});
																					if ((armor == 0) && (shield == 0)){
																						setAchievement(message.chat.id, player_id, 44, 1);
																					}
																				});
																			});
																		});
																	});
																});
															}else{
																if (paralyzed > 0){
																	connection.query('UPDATE boss_team SET paralyzed = paralyzed-1 WHERE id = ' + boss_id, function(err, rows, fields) {
																		if (err) throw err;

																		bot.sendMessage(message.chat.id, "Il boss Ã¨ paralizzato!", kb).then(function() {
																			answerCallbacks[message.chat.id] = function(answer) {
																				if (answer.text == "Consumabili"){
																					Consumabili(message, player_id, 1, player_total_life, player_life, boss_id);
																				}
																			};
																		});

																		// Per impresa globale
																		connection.query('INSERT INTO achievement_global (player_id, value) VALUES (' + player_id + ',' + danno + ')', function(err, rows, fields) {
																			if (err) throw err;
																		});

																		setTimeout(function() {
																			bot.sendMessage(message.chat.id, "Hai colpito il boss " + magic_txt + "e hai inflitto *" + danno + "* danni" + crit_txt + ", ha ancora " + lifeB + " hp", mark);
																		}, 500);
																	});
																	if ((magic != 0) && (automagic == 0)){
																		if (magic == 3){
																			connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields){
																				if (err) throw err;
																				console.log("Magia con ID " + magicId + " utilizzata");
																			});
																		}
																	}
																	return;
																}

																if (crit_bool == 1){
																	crit_txt = " CRITICI";
																	setAchievement(message.chat.id, player_id, 33, 1);
																}

																var damage = 0;
																var max = Math.round((boss_drop/15)*1.5);
																var min = Math.round((boss_drop/16)*1.5);
																damage = Math.round(Math.random()*max+min)-bonus;
																var heal = Math.round(Math.abs(player_total_life*0.1-damage));
																damage = damage-extra_bonus;

																//console.log(damage, min, max);

																var critical_rand2 = Math.round(Math.random()*100)+1;
																var crit_txt2 = "";

																if ((critical_rand2 <= critical_armor) && (meParalyzed == 0)){
																	damage = damage/1.5;
																	crit_txt2 = ", ridotti grazie alla tua corazza";
																	setAchievement(message.chat.id, player_id, 31, 1);
																}

																var critical_rand3 = Math.round(Math.random()*100)+1;
																var crit_bool3 = 0;
																var crit_txt3 = "";

																if ((critical_rand3 <= critical_shield) && (meParalyzed == 0)){
																	crit_bool3 = 1;
																	crit_txt3 = ", assorbito completamente dallo scudo";
																	setAchievement(message.chat.id, player_id, 32, 1);
																}

																if (charm_id == 63){
																	damage = damage-5;
																}else if (charm_id == 186){
																	damage = damage-15;
																}else if (charm_id == 189){
																	damage = damage-20;
																}

																if (multi >= 5){
																	damage = damage*5;
																}else{
																	damage = damage*multi;
																}

																if (double == 1){
																	damage = damage*1.5;
																}
																if ((class_id == 2) && (reborn > 1)){
																	damage += damage*0.05;
																}
																if ((class_id == 6) && (reborn > 1)){
																	damage -= damage*0.15;
																}
																if ((class_id == 8) && (reborn > 1)){
																	damage += damage*0.1;
																}
																if ((class_id == 8) && (reborn == 5)){
																	damage += damage*0.1;
																}
																if ((class_id == 8) && ((reborn == 3) || (reborn >= 4))){
																	damage += damage*0.07;
																}
																if ((class_id == 9) && (reborn > 1)){
																	damage += damage*0.1;
																}

																var special = "";
																var specialRand = Math.random()*100;
																if (specialRand <= 20){
																	if (boss_num == 28){
																		special = "Obliterazione";
																		damage = Math.round(getRandomArbitrary(player_total_life*0.1,player_total_life*0.2));
																	}
																	if (boss_num == 29){
																		special = "Ascensione di Nettuno";
																		damage = Math.round(getRandomArbitrary(player_total_life*0.2,player_total_life*0.3));
																	}
																	if (boss_num == 30){
																		special = "Colonne dell'Inferno";
																		damage = Math.round(getRandomArbitrary(player_total_life*0.4,player_total_life*0.5));
																	}
																}

																var enemy_magic = "";
																var enemy_magicRand = Math.random()*100;
																var heal_enemy = 0;
																if ((boss_num >= 18) && (special == "")){
																	if ((boss_num-17) > enemy_magicRand){
																		var rand2 = Math.random()*100;

																		if (rand2 < 30){
																			var r = 100;
																			rand = Math.random()*100;
																			if (weapon3_id == 672){
																				r = 70;
																			}
																			if (r >= rand){
																				enemy_magic = "Impeto di Fiamme";
																				damage = damage*4;
																			}
																		}else if (rand2 < 60){
																			var r = 100;
																			rand = Math.random()*100;
																			if (weapon3_id == 673){
																				r = 70;
																			}
																			if (r >= rand){
																				enemy_magic = "Furia dei Mari";
																				heal_enemy = Math.round(Math.abs(boss_total_life*0.1-danno));
																				if (boss_life+heal_enemy > boss_total_life){
																					heal_enemy = boss_total_life-boss_life;
																				}
																				if (heal_enemy < 0)
																					heal_enemy = Math.abs(heal_enemy);
																				if (heal_enemy > 50000){
																					heal_enemy = 50000;
																				}
																				connection.query('UPDATE `boss_team` SET `life`=life+' + heal_enemy + ' WHERE id=' + boss_id, function(err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																		}else{
																			var r = 100;
																			rand = Math.random()*100;
																			if (weapon3_id == 671){
																				r = 70;
																			}
																			if (r >= rand){
																				enemy_magic = "Tempesta Folgorante";
																				connection.query('UPDATE player SET paralyzed = 2 WHERE id = ' + player_id, function(err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																		}
																	}
																}

																var necroD = 10;

																if (boss_num == 31){
																	countdown++;
																	if (countdown >= necroD){
																		special = "Necro-Anima";
																		damage = player_life;
																		countdown = 0;
																	}else{
																		if (countdown == necroD-3){
																			bot.sendMessage(message.chat.id, "3...");
																		}else if (countdown == necroD-2){
																			bot.sendMessage(message.chat.id, "2...");
																		}else if (countdown == necroD-1){
																			bot.sendMessage(message.chat.id, "1...");
																		}
																	}
																	connection.query('UPDATE boss_team SET countdown = ' + countdown + ' WHERE id = ' + boss_id, function(err, rows, fields) {
																		if (err) throw err;
																		console.log("Countdown:" + boss_id + " " + countdown);
																	});
																}

																damage = Math.round(damage);

																if (damage <= 0){
																	damage = 0;
																}

																if (crit_bool3 == 1){
																	damage = 0;
																}

																setAchievement(message.chat.id, player_id, 30, damage);

																connection.query('UPDATE `player` SET `life`=life-' + damage + ' WHERE id=' + player_id, function(err, rows, fields) {
																	if (err) throw err;

																	if (magic == 3){
																		connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields){
																			if (err) throw err;
																			console.log("Magia con ID " + magicId + " utilizzata");
																		});
																	}

																	var extra = "attacca";
																	if (special != ""){
																		extra = "colpisce con *" + special + "*";
																	}
																	if (enemy_magic != ""){
																		extra = "colpisce con *" + enemy_magic + "*";
																		if (heal_enemy != 0){
																			extra += " recuperando " + heal_enemy + " hp";
																		}
																	}

																	if (player_life - damage <= 0){
																		var msg = "";
																		if (danno != 0){
																			msg = "Hai colpito il boss infliggendo un danno pari a *" + danno + "* hp, ma sei stato sconfitto con un colpo mortale da *" + damage + "* hp!";
																		}else{
																			msg = "Il boss ti " + extra + " con un colpo mortale da *" + damage + "* hp!";
																		}
																		bot.sendMessage(message.chat.id, msg, back);
																		return;
																	}

																	if (magic_txt2 != ""){
																		connection.query('UPDATE player SET life = life+' + heal + ' WHERE id = ' + player_id, function(err, rows, fields) {
																			if (err) throw err;
																			calcLife(message);
																			console.log("Ricarica salute: " + heal);
																		});
																		if (magicDouble == 1){
																			magic_txt2 += " (+" + heal + " hp - x2)";
																		}else{
																			magic_txt2 += " (+" + heal + " hp)";
																		}
																	}

																	if (damage <= 0){
																		bot.sendMessage(message.chat.id, "Hai evitato il colpo del boss" + crit_txt3 + magic_txt2 + "!", kb).then(function() {
																			answerCallbacks[message.chat.id] = function(answer) {
																				if (answer.text == "Consumabili"){
																					Consumabili(message, player_id, 1, player_total_life, player_life, boss_id);
																				}
																			};
																		});
																	}else{
																		bot.sendMessage(message.chat.id, "Il boss ti " + extra + " e perdi *" + damage + "* hp" + crit_txt2 + magic_txt2 + ", hai ancora " + (player_life - damage) + " hp!", kb).then(function() {
																			answerCallbacks[message.chat.id] = function(answer) {
																				if (answer.text == "Consumabili"){
																					Consumabili(message, player_id, 1, player_total_life, player_life, boss_id);
																				}
																			};
																		});
																	}

																	setTimeout(function() {
																		if (meParalyzed == 0){
																			bot.sendMessage(message.chat.id, "Hai colpito il boss " + magic_txt + "e hai inflitto *" + danno + "* danni" + crit_txt + ", ha ancora " + lifeB + " hp", mark);
																		}else if (meParalyzed == 1){
																			if ((player_paralyzed-1) != 0){
																				bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il boss, sei ancora paralizzato per " + (player_paralyzed-1) + " turni", mark);
																			}else{
																				bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il mostro, e ora non sei piÃ¹ paralizzato");
																			}
																		}
																	}, 500);
																});
															}
														});
													};
												});
											}
										});
									}
								});
							});
						});
					});
				});
			});
		});
	});
});

bot.onText(/visualizza boss/i, function(message) {
	var bossKb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Affronta Boss"],["Torna al menu"]]
		}
	};


	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		connection.query('SELECT team_id FROM team_player WHERE player_id=' + player_id, function(err, rows, fields) {
			if (err) throw err;	

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non sei in un team!", back)
				return;
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT boss_team.life, boss_team.total_life, boss_team.killedby, boss.name FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND unlocked = 1 AND team_id = ' + team_id + ' ORDER BY boss_id', function(err, rows, fields) {
				if (err) throw err;
				var boss_list = "\n";
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].life <= 0){
						boss_list += "*" + rows[i].name + "* (ucciso da " + rows[i].killedby.replace(new RegExp("_", "g"), " ") + ")\n";
					}else{
						boss_list += "*" + rows[i].name + "* (" + rows[i].life + "/" + rows[i].total_life + " hp)\n";
					}
				}
				connection.query('SELECT boss_respawn FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					if (rows[0].boss_respawn != null){
						var d = new Date(rows[0].boss_respawn);
						var short_time = addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + ":" + addZero(d.getSeconds());
						var short_date = addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();

						boss_list += "I boss tornano in vita il " + short_date + " alle " + short_time;
					}
					bot.sendMessage(message.chat.id, boss_list, bossKb);
				});
			});
		});
	});
});

bot.onText(/^pozioni|utilizzabili boss|^âš’$/i, function(message) {
	connection.query('SELECT id, life, total_life, boss_id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var life = rows[0].life;
		var total_life = rows[0].total_life;
		var boss_id = rows[0].boss_id;

		if (life <= 0){
			bot.sendMessage(message.chat.id, "Sei morto, per tornare in vita ti serve una Piuma di Fenice!", revive);
			return;
		}

		if (message.text.indexOf("Utilizzabili") != -1){
			if (message.text.indexOf("Boss") != -1){
				Consumabili(message, player_id, 1, total_life, life, boss_id);
			}
		}else if (message.text.toLowerCase().indexOf("pozioni") != -1){
			Consumabili(message, player_id, 2, total_life, life, 0);			
		}else if (message.text.indexOf("âš’") != -1){
			Consumabili(message, player_id, 4, total_life, life, 0);
		}
	});
});

bot.onText(/Torna in Vita/i, function(message) {

	var kbHeal = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Usa Piuma di Fenice"],["Usa Cenere di Fenice"],["Torna al menu"]]
		}
	};

	connection.query('SELECT id, life, total_life FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var life = rows[0].life;
		var total_life = rows[0].total_life;

		if (life <= 0){
			connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id IN (619,647)', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					bot.sendMessage(message.chat.id, "Non possiedi nessun oggetto utile", back);
				}else{
					bot.sendMessage(message.chat.id, "Vuoi usare una Piuma di Fenice o una Cenere di Fenice per tornare in vita?", kbHeal).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text == "Usa Piuma di Fenice"){
								connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 619', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Non possiedi nessuna Piuma di Fenice", back);
									}else{
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 619 LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
											connection.query('UPDATE player SET life = ROUND(total_life/10) WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Bentornato! ðŸŒŸ ", back);
												setAchievement(message.chat.id, player_id, 20, 1);
											});
										});
									}
								});
							}else if (answer.text == "Usa Cenere di Fenice"){
								connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 647', function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Non possiedi nessuna Cenere di Fenice", back);
									}else{
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 647 LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
											connection.query('UPDATE player SET life = total_life WHERE id = ' + player_id, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Bentornato! ðŸŒŸ ", back);
												setAchievement(message.chat.id, player_id, 20, 1);
											});
										});
									}
								});
							}
						}
					});
				}
			});
		}else{
			bot.sendMessage(message.chat.id, "Sei in salute, non Ã¨ necessario tornare in vita", back);
		}
	});
});

function Consumabili(message, player_id, from, player_total_life, player_life, boss_id){

	var query = "";
	if ((from == 1) || (from == 3)){ //BOSS
		query = 'SELECT item.name, item.id, COUNT(item.name) As num FROM inventory, item WHERE inventory.item_id = item.id AND category IN (1,4) AND player_id = ' + player_id + ' GROUP BY item.name';
	}else if ((from == 2) || (from == 4)){ //ZAINO - DUNGEON
		query = 'SELECT item.name, item.id, COUNT(item.name) As num FROM inventory, item WHERE inventory.item_id = item.id AND category = 1 AND player_id = ' + player_id + ' GROUP BY item.name';
	}

	connection.query('SELECT * FROM boss_team WHERE id = ' + boss_id, function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			var boss_life = rows[0].life;
			var boss_total_life = rows[0].total_life;
		}
		connection.query(query, function(err, rows, fields) {
			if (err) throw err;
			var itemKeys = [];

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": itemKeys
				}
			};

			var kbAgain = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Usa Ancora"],["Affronta Boss"],["Torna al menu"]]
				}
			};
			var kbAgainD = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Usa Ancora"],["Torna al dungeon"],["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length > 0){
				var desc = "";
				var perc1 = 0;
				var perc2 = 0;
				var perc3 = 0;
				var perc4 = 0;
				var perc5 = 0;
				var perc6 = 0;
				var perc7 = 0;								
				var perc8 = 0;								
				var perc9 = 0;								
				var perc10 = 0;			

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					//Pozioni
					if (rows[i].id == "92"){
						perc1 = Math.round((player_total_life/100)*5);
						desc = "Recupera " + perc1 + " hp";
					}else if (rows[i].id == "93"){
						perc2 = Math.round((player_total_life/100)*10);
						desc = "Recupera " + perc2 + " hp";
					}else if (rows[i].id == "94"){
						perc3 = Math.round((player_total_life/100)*20);
						desc = "Recupera " + perc3 + " hp";
					}else if (rows[i].id == "17"){ 					//Molotov 500
						perc4 = 500;
						desc = perc4 + " danno istantaneo";
					}else if (rows[i].id == "95"){					//Bomba di Schegge 600
						perc5 = 600;
						desc = perc5 + " danno istantaneo";
					}else if (rows[i].id == "7"){
						perc6 = Math.round((Math.random()*200)+100); 		//Pietra piccola 100-300
						desc = perc6 + " danno istantaneo";
					}else if (rows[i].id == "38"){
						perc7 = Math.round((Math.random()*4000)+3000); 		//Dirigibile Esplosivo 3000-7000
						desc = perc7 + " danno istantaneo";
					}else if (rows[i].id == "106"){
						perc8 = Math.round((Math.random()*100)+900); 		//Bomba Distruttiva 900-1000
						desc = perc8 + " danno istantaneo";
					}else if (rows[i].id == "107"){
						perc9 = Math.round((Math.random()*500)+3500); 		//Bomba Nucleare 3500-4000
						desc = perc9 + " danno istantaneo";
					}else if (rows[i].id == "108"){
						perc10 = Math.round((Math.random()*1000)+7000); 	//Bomba al Plutonio 7000-8000
						desc = perc10 + " danno istantaneo";
					}else if (rows[i].id == "594"){
						perc11 = Math.round((player_total_life/100)*30);
						desc = "Recupera " + perc11 + " hp";
					}else if (rows[i].id == "595"){
						perc12 = Math.round((player_total_life/100)*50);
						desc = "Recupera " + perc12 + " hp";
					}else if (rows[i].id == "596"){
						perc13 = Math.round((player_total_life/100)*70);
						desc = "Recupera " + perc13 + " hp";
					}else if (rows[i].id == "597"){
						perc14 = Math.round((player_total_life/100)*100);
						desc = "Recupera " + perc14 + " hp";
					}

					itemKeys.push([rows[i].name + " (" + rows[i].num + ") - " + desc]);
				}
				if (from == 1){
					itemKeys.push(["Affronta Boss"]);
				}
				if (from == 2){
					itemKeys.push(["Torna allo Zaino"]);
				}
				if (from == 4){
					itemKeys.push(["Torna al dungeon"]);
				}
				itemKeys.push(["Torna al menu"]);

				bot.sendMessage(message.chat.id, "Quale oggetto vuoi usare?", kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {

						var oggetto = answer.text;
						if (oggetto == "Affronta Boss"){
							return;
						}else if (oggetto == "Torna al menu"){
							return;
						}else if (oggetto == "Torna allo Zaino"){
							return;
						}else if (oggetto == "Torna al dungeon"){
							return;
						}

						var pos = oggetto.indexOf(" (");
						if (pos != -1){
							oggetto = oggetto.substring(0, pos);
						}
						connection.query('SELECT id, category FROM item WHERE name = "' + oggetto + '"', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length <= 0){
								if ((from == 2) || (from == 3)){
									bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste!", back);
								}else{
									bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste!", kb);
								}
								return;
							}

							var item_id = rows[0].id;
							var category = rows[0].category;
							var perc = 0;

							if (item_id == "92"){
								perc = perc1;
							}else if (item_id == "93"){
								perc = perc2;
							}else if (item_id == "94"){
								perc = perc3;
							}else if (item_id == "17"){
								perc = perc4;
							}else if (item_id == "95"){
								perc = perc5;
							}else if (item_id == "7"){
								perc = perc6;
							}else if (item_id == "38"){
								perc = perc7;
							}else if (item_id == "106"){
								perc = perc8;
							}else if (item_id == "107"){
								perc = perc9;
							}else if (item_id == "108"){
								perc = perc10;
							}else if (item_id == "594"){
								perc = perc11;
							}else if (item_id == "595"){
								perc = perc12;
							}else if (item_id == "596"){
								perc = perc13;
							}else if (item_id == "597"){
								perc = perc14;
							}else{
								if (from == 4){
									bot.sendMessage(message.chat.id, "Errore selezione oggetto", kbAgainD);
								}else{
									bot.sendMessage(message.chat.id, "Errore selezione oggetto", kbAgain);									
								}
								return;
							}

							if (category == 1){
								var kb = {
									parse_mode: "Markdown",
									reply_markup: {
										resize_keyboard: true,
										one_time_keyboard: true,
										"keyboard": [["1"],["2"],["3"],["4"],["5"],["10"],["Torna al menu"]]
									}
								};

								if (player_life <= 0){
									bot.sendMessage(message.chat.id, "Sei morto, per tornare in vita ti serve una Piuma di Fenice o la Cenere di Fenice!", revive);
									return;
								}

								bot.sendMessage(message.chat.id, "Quante pozioni vuoi usare?", kb).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {

										var qnt = parseInt(answer.text);
										if ((answer.text == "Torna al menu") || (answer.text == "Affronta boss")){
											return;
										}
										if ((qnt < 1) || (qnt > 10) || (re.test(qnt) == false)){
											if (from == 4){
												bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbAgainD);
											}else{
												bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbAgain);
											}
											return;
										}

										connection.query('SELECT item.name FROM inventory, item WHERE item.id = inventory.item_id AND item_id = ' + item_id + ' AND player_id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length < qnt){
												if (from == 4){
													bot.sendMessage(message.chat.id, "Non hai abbastanza pozioni", kbAgainD);
												}else{
													bot.sendMessage(message.chat.id, "Non hai abbastanza pozioni", kbAgain);
												}
												return;
											}

											var itemName = rows[0].name;

											connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + item_id + ' LIMIT ' + qnt, function(err, rows, fields) {
												if (err) throw err;

												perc = perc*qnt;
												setAchievement(message.chat.id, player_id, 35, qnt);

												var all = 0;
												if ((player_life + perc) >= player_total_life){
													perc = player_total_life - player_life;
													all = 1;
												}

												connection.query('UPDATE player SET life = life+' + perc + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													if (all == 1){
														if ((from == 2) || (from == 3)){
															bot.sendMessage(message.chat.id, "Hai recuperato tutti gli hp!", kbAgain).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss")){
																		player_life = player_total_life;
																		Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																		return;
																	}
																};
															});
														}else if (from == 4){
															bot.sendMessage(message.chat.id, "Hai recuperato tutti gli hp!", kbAgainD).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if ((answer.text != "Torna al menu") && (answer.text != "Torna al dungeon")){
																		player_life = player_total_life;
																		Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																		return;
																	}
																};
															});
														}else{
															bot.sendMessage(message.chat.id, "Hai recuperato tutti gli hp!", kbAgain).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss")){
																		player_life = player_total_life;
																		Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																		return;
																	}
																};
															});
														}
													}else{
														if ((from == 2) || (from == 3)){
															bot.sendMessage(message.chat.id, "Hai usato " + qnt + "x " + itemName + ", hai recuperato " + perc + " hp, ora hai " + (player_life+perc) + "/" + player_total_life + " hp!", kbAgain).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss")){
																		player_life = player_life+perc;
																		Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																		return;
																	}
																};
															});
														}else if (from == 4){
															bot.sendMessage(message.chat.id, "Hai usato " + qnt + "x " + itemName + ", hai recuperato " + perc + " hp, ora hai " + (player_life+perc) + "/" + player_total_life + " hp!", kbAgainD).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if ((answer.text != "Torna al menu") && (answer.text != "Torna al dungeon")){
																		player_life = player_life+perc;
																		Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																		return;
																	}
																};
															});														
														}else{
															bot.sendMessage(message.chat.id, "Hai usato " + qnt + "x " + itemName + ", hai recuperato " + perc + " hp, ora hai " + (player_life+perc) + "/" + player_total_life + " hp!", kbAgain).then(function() {
																answerCallbacks[message.chat.id] = function(answer) {
																	if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss")){
																		player_life = player_life+perc;
																		Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																		return;
																	}
																};
															});
														}
													}
												});
											});
										});
									};
								});
							}else if (category == 4){

								connection.query('SELECT boss_id FROM boss_team WHERE id = ' + boss_id, function(err, rows, fields) {
									if (err) throw err;

									if (rows[0].boss_id == 31){
										perc = 0;
									}

									if ((boss_life - perc) > 500){
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + item_id + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
											connection.query('UPDATE boss_team SET life = life-' + perc + ' WHERE id = ' + boss_id, function(err, rows, fields) {
												if (err) throw err;
												connection.query('SELECT * FROM boss_team WHERE id = ' + boss_id, function(err, rows, fields) {
													if (err) throw err;
													if (rows[0].life <= 0){
														connection.query('UPDATE `player` SET `boss_id`=0 WHERE id=' + player_id, function(err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Purtroppo il boss Ã¨ giÃ  stato sconfitto, riprova domani o selezionane un altro.", back);
															return;
														});
														return;
													}else{
														bot.sendMessage(message.chat.id, "Hai usato un oggetto lanciabile, hai inflitto " + perc + " danni!\nSalute boss: " + rows[0].life + "/" + rows[0].total_life, kbAgain).then(function() {
															answerCallbacks[message.chat.id] = function(answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss")){
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
														setAchievement(message.chat.id, player_id, 29, perc);
													}
												});
											});
										});
									}else{
										bot.sendMessage(message.chat.id, "Il bersaglio ha pochi hp, non puoi usare un oggetto lanciabile per ucciderlo.", kb);
									}
								});
							}
						});
					};
				});
			}else{
				var Keys = [];
				if (from == 1){
					Keys.push(["Affronta Boss"]);
				}else{
					Keys.push(["Torna al menu"]);
				}

				var kbBack = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": Keys
					}
				};

				bot.sendMessage(message.chat.id, "Non possiedi nessun consumabile, creali o cercali nelle missioni.", kbBack);
			}
		});
	});
}

bot.onText(/spia rifugio|spia:/i, function(message) {

	var spy_null = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Nessuno"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (rows[0].spy_count >= 15){
			bot.sendMessage(message.chat.id, "Hai raggiunto il limite giornaliero.");
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp/10);
		var power = rows[0].weapon;
		var myhouse = rows[0].house_id;

		if ((rows[0].life <= 0) && (rows[0].exp > 10)){
			bot.sendMessage(message.chat.id, "Non puoi iniziare ispezioni da morto.", back);
			return;
		}

		if ((rows[0].travel_id != 0) || (rows[0].cave_id != 0)){
			if (rows[0].travel_id != 0){
				var time = new Date(rows[0].travel_time_end);
			}else{
				var time = new Date(rows[0].cave_time_end);				
			}
			bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), abort_travel);
			return;
		}

		if (rows[0].money < 500){
			bot.sendMessage(message.chat.id, "Non hai abbastanza soldi.", back);
			return;
		}

		if (message.text.indexOf(":") != -1){
			var player = message.text.substring(message.text.indexOf(":")+1);
			player = player.replace("@","").trim();

			connection.query('SELECT id, heist_protection, chat_id, account_id, house_id FROM player WHERE nickname="' + player + '"', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0){
					var chat_id = rows[0].chat_id;
					var house_id = rows[0].house_id;

					var account_id = (rows[0].account_id).toString();
					if (banlist_id.indexOf(account_id) != -1){
						bot.sendMessage(message.chat.id, "Non puoi spiare un giocatore bannato", back);
						return;
					}

					if (rows[0].heist_protection != null){
						bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione");
						return;
					}
					setAchievement(message.chat.id, player_id, 42, 1);
					getInfo(message, player, myhouse);
					connection.query('UPDATE player SET spy_count = spy_count+1, money=money-500 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
						if (err) throw err;
					});

					if (message.from.username != "fenix45"){
						if (house_id == 1){
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno ha spiato il tuo rifugio!");
						}else if (house_id == 2){
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno *di livello " + level + "* ha spiato il tuo rifugio!", mark);
						}else if ((house_id == 3) || (house_id == 4)){
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che *un livello " + level + ", con +" + power + " di danno* ha spiato il tuo rifugio!", mark);									
						}else if (house_id >= 5){
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che *" + message.from.username.replace(new RegExp("_", "g"), " ") + "* ha spiato il tuo rifugio!", mark);
						}
					}
				}else{
					bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
				}
			});
			return;
		}

		bot.sendMessage(message.chat.id, "Puoi spiare un rifugio inserendo il nickname del giocatore, dovrai pagare 500 Â§!\nInserisci il nickname del giocatore oppure scrivi *Spia: Nomegiocatore*", spy_null).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				var player = answer.text;
				if (player == "Nessuno"){
					return;
				}
				player = player.replace("@","").trim();

				connection.query('SELECT id, heist_protection, chat_id, house_id, account_id FROM player WHERE nickname="' + player + '"', function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0){
						var chat_id = rows[0].chat_id;
						var house_id = rows[0].house_id;

						var account_id = (rows[0].account_id).toString();
						if (banlist_id.indexOf(account_id) != -1){
							bot.sendMessage(message.chat.id, "Non puoi spiare un giocatore bannato", back);
							return;
						}

						if (rows[0].heist_protection != null){
							bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione");
							return;
						}

						setAchievement(message.chat.id, player_id, 42, 1);
						getInfo(message, player, myhouse);
						connection.query('UPDATE player SET spy_count = spy_count+1, money=money-100 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
							if (err) throw err;
						});

						if (message.from.username != "fenix45"){
							if (house_id == 1){
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno ha spiato il tuo rifugio!");
							}else if (house_id == 2){
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno *di livello " + level + "* ha spiato il tuo rifugio!", mark);
							}else if ((house_id == 3) || (house_id == 4)){
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che *un livello " + level + ", con +" + power + " di danno* ha spiato il tuo rifugio!", mark);									
							}else if (house_id >= 5){
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che *" + message.from.username.replace(new RegExp("_", "g"), " ") + "* ha spiato il tuo rifugio!", mark);
							}
						}
					}else{
						bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
					}
				});
			};
		});
	});
});

bot.onText(/xxxteria/i, function(message) {
	if ((message.from.username != "fenix45") && (xxxteria == 0)){
		bot.sendMessage(message.chat.id, "Lo xxxteria Ã¨ ancora chiusa!", back);
		return;
	}

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["1 Biglietto (750 Â§)","5 Biglietti (3000 Â§)"],["20 Biglietti (10.000 Â§)"],["Torna al menu"]]
		}
	};

	var today = new Date();
	if ((today.getDay() != 6) && (today.getDay() != 0)){
		bot.sendMessage(message.chat.id, "Oggi la xxxteria Ã¨ chiusa! Torna nel weekend!", back);
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if ((rows[0].exp/10 < 25) && (rows[0].reborn == 1)){
			bot.sendMessage(message.chat.id, "Devi essere almeno livello 25 per partecipare alla xxxteria", back)
			return;
		}

		if (rows[0].craft_count <= 25){
			bot.sendMessage(message.chat.id, "Devi possedere almeno 25 punti creazione per partecipare alla xxxteria", back)
			return;			
		}

		var prize = "";
		var date = new Date();
		var text = "";
		switch(date.getDay()){
			case 6:
				prize += "> Scrigni (R, UR, L)\n";
				prize += "> Monete\n";
				prize += "> Oggetti (UR, L)\n";
				prize += "> Gemme!\n";
				break;
			case 0: 
				prize += "> Scrigni (UR, L, E)\n";
				prize += "> Monete (Tante!)\n";
				prize += "> Oggetti (L, E)\n";
				prize += "> Gemme!\n";
				extra = "Torna tra poco per acquistare i biglietti dell'estrazione della domenica!";
				break;
							}

		connection.query('SELECT extracted FROM `event_lottery_prize`', function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].extracted == 1){
				bot.sendMessage(message.chat.id, "L'estrazione Ã¨ in corso o Ã¨ terminata!\n" + extra, back)
				return;
			}
			connection.query('SELECT COUNT(*) As num FROM event_lottery_coins WHERE player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function(err, rows, fields) {
				if (err) throw err;
				var ticketNum = rows[0].num;
				bot.sendMessage(message.chat.id, "Benvenuto nella Lootteria!\nAcquista biglietti per avere piÃ¹ probabilitÃ  di essere estratto, l'estrazione avverrÃ  ogni sabato e domenica tra le 17 e le 20 (sabato Leggendari, domenica Epici)!\nPossiedi " + ticketNum + "/20 biglietti\n\nI premi oggi sono i seguenti:\n" + prize, kb);
			});
		});
	});
});

bot.onText(/bigliett/i, function(message) {
	if ((message.from.username != "fenix45") && (xxxteria == 0)){
		bot.sendMessage(message.chat.id, "Lo xxxteria Ã¨ chiusa!", back);
		return;
	}

	if (xxxteria == 1){
		var today = new Date();
		if ((today.getDay() != 6) && (today.getDay() != 0)){
			bot.sendMessage(message.chat.id, "Oggi la xxxteria Ã¨ chiusa! Torna nel weekend!", back);
			return;
		}
	}

	var ticketNum = parseInt(message.text.substring(0, message.text.indexOf(" ")));

	if ((ticketNum != 1) && (ticketNum != 2) && (ticketNum != 3) && (ticketNum != 4) && (ticketNum != 5) && (ticketNum != 20)){
		bot.sendMessage(message.chat.id, "Numero biglietti non valido", back);
		return;
	}

	if (xxxteriaBlock == 1){
		bot.sendMessage(message.chat.id, "Non Ã¨ momentaneamente possibile acquistare biglietti", back);
		return;
	}

	bot.sendMessage(message.chat.id, "Confermi l'acquisto di " + ticketNum + " biglietti?", yesno).then(function() {
		answerCallbacks[message.chat.id] = function(answer) {
			if (answer.text.toLowerCase() == "si"){

				connection.query('SELECT extracted FROM `event_lottery_prize`,item WHERE item.id = event_lottery_prize.item_id', function(err, rows, fields) {
					if (err) throw err;
					if (rows[0].extracted == 1){
						bot.sendMessage(message.chat.id, "Durante l'estrazione non puoi acquistare biglietti!", back)
						return;
					}

					connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
						if (err) throw err;
						var player_id = rows[0].id;
						var money = rows[0].money;

						if (rows[0].craft_count <= 25){
							bot.sendMessage(message.chat.id, "Non hai abbastanza punti creazione per partecipare alla xxxteria", back)
							return;			
						}

						if ((rows[0].exp/10 < 25) && (rows[0].reborn == 1)){
							bot.sendMessage(message.chat.id, "Devi essere almeno livello 25 per partecipare alla xxxteria", back)
							return;
						}

						connection.query('SELECT COUNT(*) As num FROM event_lottery_coins WHERE player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							var playerTicket = parseInt(rows[0].num);

							if ((playerTicket > 20) || (playerTicket+ticketNum > 20)){
								bot.sendMessage(message.chat.id, "Puoi possedere al massimo 20 biglietti per estrazione", back);
								return;
							}

							var tot = ticketNum*750;
							if (ticketNum == 5){
								tot = 3000;
							}else if (ticketNum == 20){
								tot = 10000;
							}

							if (money-tot <= 0){
								bot.sendMessage(message.chat.id, "Non hai abbastanza soldi", back);
								return;
							}

							for (var i = 0; i < ticketNum; i++) {
								connection.query('INSERT INTO event_lottery_coins (player_id) VALUES (' + player_id + ')', function(err, rows, fields) {
									if (err) throw err;
								});
							}
							connection.query('UPDATE player SET money = money - ' + tot + ' WHERE id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai acquistato " + ticketNum + " biglietti per " + tot + " Â§!", back);
							});
						});
					});
				});
			};
		};
	});
});

bot.onText(/necro del destino|prova necro/i, function(message) {
	var d = new Date();
	if (d.getDay() != 1){
		bot.sendMessage(message.chat.id, "Puoi tentare la fortuna solamente il lunedÃ¬!", back);
		return;
	}

	connection.query('SELECT id, token, account_id, holiday FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back);
			return;
		}

		var player_id = rows[0].id;
		var item_list = "532,169,201,200,598";
		var mytoken = rows[0].token;

		if (mytoken <= 0){
			bot.sendMessage(message.chat.id, "Non hai nessun gettone, puoi trovarli durante le missioni!", back);
			return;
		}

		connection.query('SELECT name, COUNT(name) As qnt FROM inventory_rarity WHERE player_id = ' + player_id + ' AND item_id IN (' + item_list + ') GROUP BY name', function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Non hai nessun oggetto utile disponibile", back);
				return;
			}

			var iKeys = [];

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push([rows[i].name + " (" + rows[i].qnt + ")"]);
			}
			iKeys.push(["Torna al menu"]);

			var items = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			var nBack = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Torna alla prova necro"],["Torna al menu"]]
				}
			};

			var plur = "i";
			if (mytoken == 1){
				plur = "e";
			}

			bot.sendMessage(message.chat.id, "Seleziona un oggetto U tra quelli in lista per tentare la fortuna, ti servirÃ  anche un gettone. In caso di vittoria otterrai un oggetto creabile E o L e una ðŸ’Ž, in caso di sconfitta ne perderai uno craftato di uguale raritÃ , tenta la fortuna!\nHai ancora " + mytoken + " getton" + plur + "!", items).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					if (answer.text == "Torna al menu"){
						return;
					}

					var ogg = answer.text.substring(0, answer.text.indexOf("(")-1);

					bot.sendMessage(message.chat.id, "Sei sicuro di voler consumare " + ogg + "?", yesno).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text.toLowerCase() == "si"){
								var sql = 'SELECT item.id FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND inventory.item_id IN (' + item_list + ') AND item.name = "' + ogg + '"';
								console.log(sql);
								connection.query(sql, function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Oggetto non valido, riprova", back);
										return;
									}
									var itemId = rows[0].id;
									connection.query('SELECT token FROM player WHERE id = ' + player_id, function(err, rows, fields) {
										if (err) throw err;
										if (rows[0].token < 1){
											bot.sendMessage(message.chat.id, "Non hai abbastanza gettoni", back);
											return;
										}

										var rand = Math.random()*100;
										var rarity = "";
										if (rand < 30){
											rarity = "E";
										}else{
											rarity = "L";
										}
										connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemId + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('UPDATE player SET token = token - 1 WHERE id = ' + player_id, function(err, rows, fields) {
											if (err) throw err;
										});
										if (rand < 50){
											connection.query('SELECT id, name FROM item WHERE craftable = 1 AND rarity = "' + rarity + '" ORDER BY RAND()', function(err, rows, fields) {
												if (err) throw err;
												var itemName = rows[0].name;
												connection.query('UPDATE player SET gems = gems + 1 WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
												connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[0].id + ')', function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "INCREDIBILE! Con grande fortuna hai vinto *" + itemName + "* e una ðŸ’Ž!", back);
												});
											});
										}else{
											connection.query('SELECT item.id, item.name FROM inventory, item WHERE inventory.item_id = item.id AND player_id = ' + player_id + ' AND rarity = "' + rarity + '" AND craftable = 1 ORDER BY RAND()', function(err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length > 0){
													connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + rows[0].id + ' LIMIT 1', function(err, rows, fields) {
														if (err) throw err;
													});
													bot.sendMessage(message.chat.id, "NOOOOO! Purtroppo hai perso *" + rows[0].name + "*!", back);
												}else{
													if (rarity == "L"){
														var money = 50000;
													}else{
														var money = 100000;
													}
													connection.query('UPDATE player SET money = money - ' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
														if (err) throw err;
													});
													bot.sendMessage(message.chat.id, "NOOOOO! Purtroppo hai perso *" + money + "* Â§!", back);
												}
											});
										}
									});
								});
							};
						};
					});
				};
			});
		});
	});
});

bot.onText(/Sfide del Destino/i, function(message) {
	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Gettone del Destino ðŸŒ","Necro del Destino ðŸ”®"],["Torna al menu"]]
		}
	};
	bot.sendMessage(message.chat.id, "Seleziona il tipo di prova che vuoi affrontare", kb);
});

bot.onText(/gettone/i, function(message) {

	if (message.text == "Inserisci Gettone"){
		return;
	}

	connection.query('SELECT id, token, money FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var mymoney = parseInt(rows[0].money);
		var mytoken = parseInt(rows[0].token);

		if (mytoken <= 0){
			bot.sendMessage(message.chat.id, "Non hai nessun gettone, puoi trovarli durante le missioni!", back);
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Scegli: Testa","Scegli: Croce"],["Torna al menu"]]
			}
		};

		var plur = "i";
		if (mytoken == 1){
			plur = "e";
		}

		bot.sendMessage(message.chat.id, "Sfida il destino giocando con i Gettoni del Destino, hai il 50% di possibilitÃ , se indovini ricevi un oggetto tra R e E, se perdi dal tuo zaino scomparirÃ  un oggetto della stessa raritÃ , perchÃ¨ non provarci?\nHai ancora " + mytoken + " getton" + plur + "!", kb).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {

				var resp = answer.text;

				if (resp == "Torna al menu"){
					return;
				}

				connection.query('SELECT id, token, money FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
					if (err) throw err;
					var player_id = rows[0].id;
					var mymoney = parseInt(rows[0].money);
					var mytoken = parseInt(rows[0].token);

					if (mytoken <= 0){
						bot.sendMessage(message.chat.id, "Non hai nessun gettone, puoi trovarli durante le missioni!", back);
						return;
					}

					var rand = Math.round((Math.random()*99)+1);

					var chest4 = 50;
					var chest5 = 15;
					var chest6 = 5;

					var rarity = "R";
					var rarityId = 3;

					if (rand <= chest6){
						rarity = "E";
						rarityId = 6;
					}else if (rand <= chest5){
						rarity = "L";
						rarityId = 5;
					}else if (rand <= chest4){
						rarity = "UR";
						rarityId = 4;
					}

					var token = Math.round(Math.random()*1);
					var choice = 0;

					if (resp == "Scegli: Testa"){
						choice = 1;
					}else if (resp == "Scegli: Croce"){
						choice = 0;
					}else{
						bot.sendMessage(message.chat.id, "Valore non valido.", back);
						return;
					}

					connection.query('UPDATE player SET token = token-1 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
					});

					setAchievement(message.chat.id, player_id, 43, 1);

					if (choice == token){

						setAchievement(message.chat.id, player_id, 21, 1);

						var rand = Math.round(Math.random()*100);
						if ((rand <= 30) && (mymoney > 100000)){
							connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',220)', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai indovinato e ottenuto una *Capsula di Prelevazione Tipo A*! Che fortuna!", back);
							});
							return;
						}
						connection.query('SELECT item.name, item.id FROM item WHERE rarity = "' + rarity + '" AND craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
							if (err) throw err;
							var itemid = rows[0].id;
							var itemname = rows[0].name;
							connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + itemid + ')', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Che fortuna! Hai indovinato e ottenuto " + itemname + " (" + rarity + ")!\nTorna la prossima volta per ricevere altri sostanziosi premi!", back);
							});
							if (luckyMode == 1){
								connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',' + itemid + ')', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Grazie alla fortuna hai ottenuto un secondo " + itemname + " (" + rarity + ")!", back);
								});					
							}
						});
					}else{
						connection.query('SELECT item.name, item.id FROM item, inventory WHERE item.id = inventory.item_id AND item.rarity = "' + rarity + '" AND craftable = 0 AND inventory.player_id = ' + player_id + ' ORDER BY RAND()', function(err, rows, fields) {
							if (err) throw err;

							if (luckyMode == 1){
								bot.sendMessage(message.chat.id, "Dannazione hai sbagliato! Ma grazie alla fortuna stavolta non hai perso nulla!", back);
								return;
							}

							if (Object.keys(rows).length > 0){
								var itemid = rows[0].id;
								var itemname = rows[0].name;
								connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + itemid + ' LIMIT 1', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Dannazione! Hai sbagliato e hai perso " + itemname + " (" + rarity + ")!\nRiprova, magari andrÃ  meglio la prossima volta!", back);
								});
							}else{
								var money = rarityId*1000;
								if (mymoney - money <= 0){
									money = mymoney;
								}
								connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Dannazione! Hai sbagliato e hai perso " + money + " Â§!\nRiprova, magari andrÃ  meglio la prossima volta!", back);
								});
							}
						});
					}
				});
			};
		});
	});
});

bot.onText(/^rifugio|Torna al rifugio|Contatta lo gnomo/i, function(message) {

	if (message.text.indexOf("Elettricista") != -1){
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var player_id = rows[0].id;
		var myexp = rows[0].exp;
		var house_id = rows[0].house_id;
		var lev = Math.floor(myexp/10);
		var life = rows[0].life;
		var reborn = rows[0].reborn;
		var ability = rows[0].ability;

		connection.query('SELECT * FROM heist_progress WHERE from_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length > 0){

				var kb = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Digita Codice"],["Mura","Cortile","Ruscello"],["Caverna","Deposito Spade","Campo di Pomodori"],["Torna al menu"]]
					}
				};

				var rBack = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						one_time_keyboard: true,
						"keyboard": [["Torna al Rifugio"],["Torna al menu"]]
					}
				};

				if (rows[0].wait_time != null){
					var now = new Date(rows[0].wait_time);
					var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());
					bot.sendMessage(message.chat.id, "Il tuo gnomo sta ancora esplorando una zona, attendi fino alle " + short_date, back);
					return;
				}

				var len = rows[0].wlength;
				var attempt = parseInt(rows[0].attempt);
				var travel = parseInt(rows[0].travel);
				var ext = rows[0].extracted;
				var word = rows[0].word;
				var toId = rows[0].to_id;

				var wordS = word.split("");
				var code = "";
				var f = 0;
				var extS = ext;
				var found = 0;

				if (ext != null){
					var len2 = ext.length;
					extS = ext.split("");
					for (i=0;i<len;i++){
						f = 0;
						for (j=0;j<len2;j++){
							if (wordS[i] == extS[j]){
								f = 1;
								found++;
								break;
							}else{
								f = 0;
							}
						}
						if (f == 0){
							code += "_ ";
						}else{
							code += wordS[i] + " ";
						}
					}
				}else{
					for (i=0;i<len;i++){
						code += "_ ";
					}
				}

				bot.sendMessage(message.chat.id,"Sul portone del rifugio vi Ã¨ una piccola pulsantiera con degli spazi vuoti, uno per lettera:\nðŸ— " + code + "\n" +
								"Esplora i dintorni del rifugio per trovare altre lettere, altrimenti digita la parola secondo te corretta, hai solo " + attempt + " tentativi rimanenti!", kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text == "Torna al menu"){
							return;
						}
						if (	(answer.text == "Mura") || (answer.text == "Cortile") || (answer.text == "Ruscello") ||
							(answer.text == "Caverna") ||(answer.text == "Deposito Spade") ||(answer.text == "Campo di Pomodori")) {

							travel++;

							if (found >= len-2){
								bot.sendMessage(message.chat.id, "Hai giÃ  trovato tutte le lettere possibili, ora fai altri tentativi", rBack);
								return;
							}	

							var now = new Date();
							now.setMinutes(now.getMinutes() + travel*Math.round(Math.random()*5+5));
							var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
							var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());

							connection.query('UPDATE heist_progress SET wait_time = "' + long_date + '", travel = travel+1 WHERE from_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;

								bot.sendMessage(message.chat.id, "Hai deciso di comunicare al tuo gnomo un luogo accanto al rifugio: " + answer.text + 
												"\nDovrai attendere fino alle " + short_date + " per permettergli di setacciarlo come si deve", back);
							});
						}else if (answer.text == "Digita Codice"){
							bot.sendMessage(message.chat.id, "Quale codice vuoi comunicare allo gnomo? Ha ancora " + attempt + " possibilitÃ , dopodichÃ¨ il sistema di difese del rifugio lo sigillerÃ  per sempre. Scrivi sempre tutto in minuscolo e non inserire gli accenti!", back).then(function() {
								answerCallbacks[message.chat.id] = function(answer) {
									if (answer.text == "Torna al menu"){
										return;
									}
									connection.query('SELECT money, chat_id FROM player WHERE id = ' + toId, function(err, rows, fields) {
										if (err) throw err;

										var chat_id = rows[0].chat_id;
										var toMoney = rows[0].money;

										if (answer.text.toLowerCase() == word){
											connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 5', function(err, rows, fields) {
												if (err) throw err;

												var abBonus = 0;
												if (Object.keys(rows).length > 0){
													abBonus = rows[0].ability_level/10*2;
												}

												var money = ability*10;
												money += money*abBonus;

												if (toMoney < money){
													money = toMoney;
												}

												money = Math.round(money);

												connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + toId, function(err, rows, fields) {
														if (err) throw err;
														connection.query('DELETE FROM heist_progress WHERE from_id = ' + player_id, function(err, rows, fields) {
															if (err) throw err;
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',651)', function(err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "La parola *" + answer.text + "* Ã¨ corretta! In una stanzetta hai trovato un sacchettino contenente " + money + " Â§ ed una Chiave Mistica  ðŸ—!", back);
																bot.sendMessage(chat_id, message.from.username + " Ã¨ riuscito ad aprire il portone protetto del tuo rifugio, purtroppo avendo lasciato incustodito un sacchettino di monete, hai perso " + money + " Â§");

																setAchievement(message.chat.id, player_id, 8, 1);
															});
														});
													});
												});
											});
										}else{
											if (attempt-1 == 0){
												connection.query('DELETE FROM heist_progress WHERE from_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai sbagliato 3 volte, la parola era *" + word + "*! Il portone del rifugio si blocca ed il tuo gnomo Ã¨ costretto a tornare indietro", back);
													bot.sendMessage(chat_id, message.from.username + " non Ã¨ riuscito ad indovinare il codice per il tuo portone, cosÃ¬ Ã¨ stato respinto");
												});
											}else{
												connection.query('UPDATE heist_progress SET attempt = attempt-1 WHERE from_id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "La parola Ã¨ sbagliata! Hai ancora " + (attempt-1) + " tentativi", rBack);
												});
											}
										}
									});
								};
							});
						}
					};
				});
				return;
			}

			if ((life <= 0) && (myexp > 10)){
				bot.sendMessage(message.chat.id, "Non puoi iniziare ispezioni da morto.", back);
				return;
			}

			if ((lev < 15) && (reborn == 1)){
				bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ ancora troppo basso.", back);
				return;
			}


			/*
				var iKeys = [];
				iKeys = [["Ispezione","Spia Rifugio"],["Migliora Rifugio"],["Prelevazione","Protezione"],["Torna al menu"]];
				iKeys.unshift(["In corso"]);
				*/

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Ispezione","Spia Rifugio"],["Migliora Rifugio"],["Prelevazione","Protezione"],["Torna al menu"]]
				}
			};

			var kb2 = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": [["Matchmaking (100 Â§)"],["Inserisci il Nickname (200 Â§)"],["Torna al Rifugio"]]
				}
			};

			connection.query('SELECT name FROM house WHERE id = ' + house_id, function(err, rows, fields) {
				if (err) throw err;

				bot.sendMessage(message.chat.id, "Bentornato nel tuo *" + rows[0].name + "*! Cosa vuoi fare?", kb).then(function() {
					answerCallbacks[message.chat.id] = function(answer) {
						if (answer.text == "Ispezione"){
							bot.sendMessage(message.chat.id, "Invia uno gnomo ad un rifugio di un altro giocatore per cercare di ottenere il suo bottino e una Chiave Mistica, puoi usare il Matchmaking per sceglierlo casualmente in base alla tua abilitÃ  oppure inserire il suo nickname", kb2);
						}
					};
				});
			});
		});
	});
});


bot.onText(/matchmaking/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var myexp = rows[0].exp;
		var lev = Math.floor(myexp/10)
		var reborn = rows[0].reborn;
		var myab = rows[0].ability;
		var from_id = rows[0].id;
		var weapon_bonus = rows[0].weapon;
		var life = rows[0].life;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var heist_count = rows[0].heist_count;
		var last_mm = rows[0].last_mm;

		var travel = rows[0].travel_id;
		var cave = rows[0].cave_id;

		if ((life <= 0) && (myexp > 10)){
			bot.sendMessage(message.chat.id, "Non puoi iniziare ispezioni da morto.", back);
			return;
		}

		if ((lev < 15) && (reborn == 1)){
			bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ ancora troppo basso, torna quando avrai raggiunto il livello 15.", back);
			return;
		}

		connection.query('SELECT id FROM heist_progress WHERE from_id=' + from_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				bot.sendMessage(message.chat.id, "Stai svolgendo un ispezione, completala prima di iniziarne un'altra", back);
				return;
			}

			connection.query('SELECT COUNT(*) As num, datetime FROM heist WHERE from_id=' + from_id, function(err, rows, fields) {
				if (err) throw err;
				if (rows[0].num > 0){
					var date = new Date(rows[0].datetime);
					var short_date = addZero(date.getHours()) + ":" + addZero(date.getMinutes()) + ":" + addZero(date.getSeconds());
					bot.sendMessage(message.chat.id, "Sei in un ispezione fino alle " + short_date, back);
					return;
				}

				if (heist_count >= 5){
					bot.sendMessage(message.chat.id, "Puoi ispezionare un rifugio solamente 5 volte al giorno, riprova domani.", back);
					return;
				}

				if (money < 100){
					bot.sendMessage(message.chat.id, "Non hai abbastanza monete!", back);
					return;
				}

				connection.query('SELECT team_id FROM team_player WHERE player_id = ' + from_id, function(err, rows, fields) {
					if (err) throw err;

					var team_id = 0;
					var heist_limit = 3;
					if (Object.keys(rows).length > 0){
						team_id = parseInt(rows[0].team_id);
						heist_limit = 7;
					}

					var offset = Math.round(myab/2);
					var offset2 = Math.round(myab/3);
					var limit = 30;
					var count = 100;
					var i = 0;
					var banned_join = banlist_id.join();
					var minexp = 150;

					connection.query("SELECT nickname, exp, team_player.team_id FROM player, team_player WHERE player.heist_limit < " + heist_limit + " AND player.account_id NOT IN (" + banned_join + ") AND team_player.player_id = player.id AND team_player.team_id != " + team_id + " AND heist_protection IS NULL AND ability BETWEEN " + (myab-offset) + " AND " + (myab+offset2) + " AND nickname <> '" + message.from.username + "' AND money > 0 AND exp > " + minexp + " AND player.id != " + last_mm + " ORDER BY ability DESC, heist_limit ASC, RAND() LIMIT " + limit, function(err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length < 3){
							offset += 20;
							offset2 += 20;
							connection.query("SELECT nickname, exp, team_player.team_id FROM player, team_player WHERE player.heist_limit < " + heist_limit + " AND player.account_id NOT IN (" + banned_join + ") AND team_player.player_id = player.id AND team_player.team_id != " + team_id + " AND heist_protection IS NULL AND ability BETWEEN " + (myab-offset) + " AND " + (myab+offset2) + " AND nickname <> '" + message.from.username + "' AND money > 0 AND exp > " + minexp + " AND player.id != " + last_mm + " ORDER BY ability DESC, heist_limit ASC, RAND() LIMIT " + limit, function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length < 3){
									offset += 50;
									offset2 += 50;
									connection.query("SELECT nickname, exp, team_player.team_id FROM player, team_player WHERE player.heist_limit < " + heist_limit + " AND player.account_id NOT IN (" + banned_join + ") AND team_player.player_id = player.id AND team_player.team_id != " + team_id + " AND heist_protection IS NULL AND ability BETWEEN " + (myab-offset) + " AND " + (myab+offset2) + " AND nickname <> '" + message.from.username + "' AND money > 0 AND exp > " + minexp + " AND player.id != " + last_mm + " ORDER BY ability DESC, heist_limit ASC, RAND() LIMIT " + limit, function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length < 3){
											offset += 100;
											offset2 += 100;
											if (Object.keys(rows).length < 5){
												bot.sendMessage(message.chat.id, "Nessun giocatore adatto trovato, riprova.", back);
											}else{
												var rand;
												rand = Math.floor(Math.random()*Object.keys(rows).length); //0 sono io
												attack(rows[rand].nickname, message, from_id, weapon_bonus, 100, 1);
											}
										}else{
											var rand;
											rand = Math.floor(Math.random()*Object.keys(rows).length); //0 sono io
											attack(rows[rand].nickname, message, from_id, weapon_bonus, 100, 1);
										}
									});
								}else{
									var rand;
									rand = Math.floor(Math.random()*Object.keys(rows).length); //0 sono io
									attack(rows[rand].nickname, message, from_id, weapon_bonus, 100, 1);
								}
							});
						}else{
							var rand;
							rand = Math.floor(Math.random()*Object.keys(rows).length); //0 sono io
							attack(rows[rand].nickname, message, from_id, weapon_bonus, 100, 1);
						}
					});
				});
			});
		});
	});
});

bot.onText(/inserisci il nickname|ispeziona: /i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (wanted == 0){
			if (rows[0].heist_protection != null){
				bot.sendMessage(message.chat.id, "Hai attivato la protezione, non puoi iniziare ispezioni");
				return;
			}
		}

		var myexp = rows[0].exp;
		var lev = Math.floor(myexp/10);
		var reborn = rows[0].reborn;
		var from_id = rows[0].id;
		var weapon_bonus = rows[0].weapon;
		var life = rows[0].life;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var heist_count = rows[0].heist_count;

		if ((lev < 15) && (reborn == 1)){
			bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ ancora troppo basso.", back);
			return;
		}

		var travel = rows[0].travel_id;
		var cave = rows[0].cave_id;

		connection.query('SELECT COUNT(*) As num, datetime FROM heist WHERE from_id=' + from_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].num > 0){
				var date = new Date(rows[0].datetime);
				var short_date = addZero(date.getHours()) + ":" + addZero(date.getMinutes()) + ":" + addZero(date.getSeconds());
				bot.sendMessage(message.chat.id, "Sei in un ispezione fino alle " + short_date, back);
				return;
			}
			connection.query('SELECT id FROM heist_progress WHERE from_id=' + from_id, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0){
					bot.sendMessage(message.chat.id, "Stai svolgendo un ispezione, completala prima di iniziarne un'altra", back);
					return;
				}

				connection.query('SELECT wanted_id FROM event_wanted_status WHERE player_id = ' + from_id, function(err, rows, fields) {
					if (err) throw err;

					var wanted_id = 0;
					if (Object.keys(rows).length > 0){
						wanted_id = rows[0].wanted_id;
					}

					if (money < 200){
						bot.sendMessage(message.chat.id, "Non hai abbastanza monete!", back);
						return;
					}

					if (message.text.indexOf(":") != -1){
						var usr = message.text.substring(message.text.indexOf(":")+2).replace("@","").trim();
						//console.log(usr);

						if (message.from.username.toLowerCase() == usr.toLowerCase()){
							bot.sendMessage(message.chat.id, "Non puoi ispezionare te stesso.", back);
							return;
						}

						usr = usr.replace(/[^\w\s]/gi, '');

						connection.query('SELECT id, account_id, reborn FROM player WHERE nickname="' + usr + '"', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length > 0){
								var account_id = (rows[0].account_id).toString();
								if (banlist_id.indexOf(account_id) != -1){
									bot.sendMessage(message.chat.id, "Non puoi ispezionare un giocatore bannato", back);
									return;
								}

								var d = new Date();
								var time = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate());

								if ((wanted == 0) && (rows[0].id != wanted_id)){
									if (reborn > rows[0].reborn){
										bot.sendMessage(message.chat.id, "Puoi ispezionare solamente un giocatore con una rinascita pari o superiore alla tua", back);
										return;
									}
									if (heist_count >= 5){
										bot.sendMessage(message.chat.id, "Puoi ispezionare un rifugio solamente 5 volte al giorno, riprova domani.", back);
										return;
									}
								}

								connection.query('SELECT id FROM heist_history WHERE from_id = ' + from_id + ' AND to_id = ' + rows[0].id + ' AND time LIKE "' + time + '%"', function(err, rows, fields) {
									if (err) throw err;
									if ((Object.keys(rows).length <= 2) || (wanted == 1)){
										attack(usr, message, from_id, weapon_bonus, 200, 0);
									}else{
										bot.sendMessage(message.chat.id, "Hai ispezionato troppe volte questo giocatore, riprova domani.", back);
									}
								});
							}else{
								bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
							}
						});
						return;
					}

					bot.sendMessage(message.chat.id, "Inserisci il nickname del giocatore da sfidare.\n*OPPURE* puoi ispezionare un giocatore scrivendo *Ispeziona: Nomeutente*", mark).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (message.text.indexOf(":") != -1){
								return;
							}

							answer.text = answer.text.replace("@","").trim();

							if (message.from.username.toLowerCase() == answer.text.toLowerCase()){
								bot.sendMessage(message.chat.id, "Non puoi ispezionare te stesso.", back);
								return;
							}

							connection.query('SELECT reborn, id, account_id FROM player WHERE nickname="' + answer.text + '"', function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length > 0){

									var account_id = (rows[0].account_id).toString();
									if (banlist_id.indexOf(account_id) != -1){
										bot.sendMessage(message.chat.id, "Non puoi ispezionare un giocatore bannato", back);
										return;
									}

									var d = new Date();
									var time = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate());

									if ((wanted == 0) && (rows[0].id != wanted_id)){
										if (reborn > rows[0].reborn){
											bot.sendMessage(message.chat.id, "Puoi ispezionare solamente un giocatore con una rinascita pari o superiore alla tua", back);
											return;
										}
										if (heist_count >= 5){
											bot.sendMessage(message.chat.id, "Puoi ispezionare un rifugio solamente 5 volte al giorno, riprova domani.", back);
											return;
										}
									}

									connection.query('SELECT id FROM heist_history WHERE from_id = ' + from_id + ' AND to_id = ' + rows[0].id + ' AND time LIKE "' + time + '%"', function(err, rows, fields) {
										if (err) throw err;
										if ((Object.keys(rows).length <= 2) || (wanted == 1)){
											attack(answer.text, message, from_id, weapon_bonus, 200, 0);
										}else{
											bot.sendMessage(message.chat.id, "Hai ispezionato troppe volte questo giocatore, riprova domani.", back);
										}
									});
								}else{
									bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
								}
							});
						};
					});
				});
			});
		});
	});
});

bot.onText(/^protezione$/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		connection.query('SELECT * FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 237', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Ti serve il Campo di Forza.", back);
				return;
			}
			bot.sendMessage(message.chat.id, "Il Campo di Forza ti fornirÃ  protezione dalle Ispezioni per 24 ore, ma intanto non potrai ispezionare, confermi?", yesno).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {
					var conf = answer.text;
					if (conf == "Si"){

						connection.query('SELECT * FROM inventory WHERE player_id = ' + player_id + ' AND item_id = 237', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Ti serve il Campo di Forza.", back);
								return;
							}

							var now = new Date();
							now.setHours(now.getHours() + 24);
							var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
							var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());

							connection.query('UPDATE player SET heist_protection = "' + long_date + '" WHERE id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Sei protetto fino alle " + short_date, back);
							});
							connection.query('DELETE FROM inventory WHERE item_id = 237 AND player_id = ' + player_id + ' LIMIT 1', function(err, rows, fields) {
								if (err) throw err;
							});					
						});
					}
				};
			});
		});
	});
});

bot.onText(/^prelevazione/i, function(message) {

	/*
	if (message.from.username != "fenix45"){
		bot.sendMessage(message.chat.id, "Manutenzione", back);
		return;
	}
	*/

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var from_id = rows[0].id;
		var reborn = rows[0].reborn;
		var totlife1 = rows[0].total_life;

		var pre = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Tipo A","Tipo B"],["Torna al menu"]]
			}
		};

		var pBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Prelevazione"],["Torna al menu"]]
			}
		};

		if (xxxteria == 1){
			bot.sendMessage(message.chat.id, "Durante la xxxteria non puoi usare la capsula, monello ðŸŒ", back);
			return;			
		}

		bot.sendMessage(message.chat.id, "Seleziona il tipo di capsula da utilizzare", pre).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {

				if (answer.text == "Torna al menu"){
					return;
				}

				if ((answer.text != "Tipo A") && (answer.text != "Tipo B")){
					bot.sendMessage(message.chat.id, "Tipo non valido!", back);
					return;
				}

				var cId = 0;
				var t = "";

				if (answer.text == "Tipo A"){
					cId = 220;
					t = "Inserisci il nickname del giocatore a cui rubare un oggetto Epico o Leggendario (qualsiasi). L'oggetto prelevato sarÃ  casuale.";
				}else if (answer.text == "Tipo B"){
					cId = 618;
					t = "Inserisci il nickname del giocatore a cui rubare due scrigni tra Leggendari o Epici. Gli scrigni prelevati saranno casuali.";
				}

				connection.query('SELECT * FROM inventory WHERE player_id = ' + from_id + ' AND item_id = ' + cId, function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						bot.sendMessage(message.chat.id, "Ti serve una Capsula di Prelevazione del tipo selezionato.", back);
						return;
					}

					bot.sendMessage(message.chat.id, t, back).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var name = answer.text.replace("@","").trim();
							if ((name == "") || (name == "Torna al menu")){
								return;
							}

							if (cId == 220){
								connection.query('SELECT id FROM player WHERE nickname = "' + name + '"', function(err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Il giocatore inserito non esiste", back);
										return;
									}

									var to_id = rows[0].id;

									connection.query('SELECT item.id, player.capsule_limit, player.total_life, player.reborn, player.chat_id, player.house_id, player.account_id, player.heist_protection FROM `inventory`, item, player WHERE player.id = inventory.player_id AND item.id = inventory.item_id AND inventory.player_id = ' + to_id + ' AND (item.rarity = "E" OR (item.rarity = "L" AND craftable = 1)) ORDER BY RAND()', function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "L'utente specificato non esiste o non puÃ² essere prelevato.", pBack);
											return;
										}

										var account_id = (rows[0].account_id).toString();
										if (banlist_id.indexOf(account_id) != -1){
											bot.sendMessage(message.chat.id, "Non puoi prelevare un giocatore bannato", pBack);
											return;
										}

										var house_id = rows[0].house_id;
										var itemId = rows[0].id;
										var chat_id = rows[0].chat_id;
										var totlife2 = rows[0].total_life;
										var capsule_limit = rows[0].capsule_limit;

										if (capsule_limit >= 5){
											bot.sendMessage(message.chat.id, "Il bersaglio ha raggiunto il limite di prelevazioni subite. Riprova domani.", match);
											return;
										}

										if (rows[0].heist_protection != null){
											bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione", pBack);
											return;
										}

										if (reborn > rows[0].reborn){
											bot.sendMessage(message.chat.id, "Puoi utilizzare la capsula solamente su un giocatore con una rinascita pari o superiore alla tua", back);
											return;
										}

										connection.query('SELECT id FROM inventory WHERE player_id = ' + from_id + ' AND item_id = ' + cId, function (err, rows, fields){
											if (err) throw err;

											if (Object.keys(rows).length == 0){
												bot.sendMessage(message.chat.id, "Non possiedi la Capsula necessaria", pBack);
												return;
											}

											connection.query('SELECT name FROM item WHERE id = ' + itemId, function(err, rows, fields) {
												if (err) throw err;
												var itemName = rows[0].name;
												connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + from_id + ',' + itemId + ')', function(err, rows, fields) {
													if (err) throw err;
												});
												connection.query('DELETE FROM inventory WHERE player_id = ' + to_id + ' AND item_id = ' + itemId + ' LIMIT 1', function(err, rows, fields) {
													if (err) throw err;
													connection.query('DELETE FROM inventory WHERE item_id = 220 AND player_id = ' + from_id + ' LIMIT 1', function(err, rows, fields) {
														if (err) throw err;

														var randStone = Math.round(Math.random()*3);
														var stone_id = 70+randStone;
														connection.query('SELECT name FROM item WHERE id = ' + stone_id, function(err, rows, fields) {
															if (err) throw err;

															var stone_name = rows[0].name;
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + from_id + ',' + stone_id + ')', function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + from_id + ',' + stone_id + ')', function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + from_id + ',' + stone_id + ')', function(err, rows, fields) {
																if (err) throw err;
															});

															bot.sendMessage(message.chat.id, "Sei riuscito a rubare *" + itemName + "* ed il druido delle prelevazioni ti ha premiato con 3x " + stone_name + "!", back);
															if (house_id != 6){
																bot.sendMessage(chat_id, "Un truffatore professionista Ã¨ riuscito a rubarti *" + itemName + "* dallo zaino!", mark);
															}else{
																bot.sendMessage(chat_id, "Un truffatore di nome " + message.from.username + " Ã¨ riuscito a rubarti <b>" + itemName + "</b> dallo zaino!", html);
															}

															setAchievement(message.chat.id, from_id, 47, 1);

															var d = new Date();
															d.setHours(d.getHours() + 48);
															var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

															connection.query('UPDATE player SET capsule_limit = capsule_limit+1 WHERE id = ' + to_id, function(err, rows, fields) {
																if (err) throw err;
															});

															var rand = Math.random()*200;
															if ((rand < 5) && (reborn >= 3)){
																connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',532)', function(err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Un *Urlo di Morte* rieccheggia in lontananza... Wow!");
																});
															}
														});
													});
												});
											});
										});
									});
								});
							};
							if (cId == 618){
								connection.query('SELECT id FROM player WHERE nickname = "' + name + '"', function(err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Il giocatore inserito non esiste", back);
										return;
									}

									var to_id = rows[0].id;

									connection.query('SELECT chest.id, player.capsule_limit, player.reborn, player.chat_id, player.total_life, player.account_id, player.house_id, player.heist_protection FROM inventory_chest, chest, player WHERE player.id = inventory_chest.player_id AND chest.id = inventory_chest.chest_id AND inventory_chest.player_id = ' + to_id + ' AND chest.id IN (5,6) ORDER BY RAND() LIMIT 2', function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length > 1){

											var account_id = (rows[0].account_id).toString();
											if (banlist_id.indexOf(account_id) != -1){
												bot.sendMessage(message.chat.id, "Non puoi prelevare un giocatore bannato", pBack);
												return;
											}

											var house_id = rows[0].house_id;
											var chestId = rows[0].id;
											var chestId2 = rows[1].id;
											var chat_id = rows[0].chat_id;
											var totlife2 = rows[0].total_life;
											var capsule_limit = rows[0].capsule_limit;

											if (capsule_limit >= 5){
												bot.sendMessage(message.chat.id, "Il bersaglio ha raggiunto il limite di prelevazioni subite. Riprova domani.", match);
												return;
											}

											if (rows[0].heist_protection != null){
												bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione", pBack);
												return;
											}

											if (reborn > rows[0].reborn){
												bot.sendMessage(message.chat.id, "Puoi utilizzare la capsula solamente su un giocatore con una rinascita pari o superiore alla tua", back);
												return;
											}

											connection.query('SELECT id FROM inventory WHERE player_id = ' + from_id + ' AND item_id = ' + cId, function (err, rows, fields){
												if (err) throw err;

												if (Object.keys(rows).length == 0){
													bot.sendMessage(message.chat.id, "Non possiedi la Capsula necessaria", pBack);
													return;
												}

												connection.query('SELECT name FROM chest WHERE id = ' + chestId, function(err, rows, fields) {
													if (err) throw err;
													var chestName = rows[0].name;
													connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + from_id + ',' + chestId + ')', function(err, rows, fields) {
														if (err) throw err;
													});
													connection.query('DELETE FROM inventory_chest WHERE player_id = ' + to_id + ' AND chest_id = ' + chestId + ' LIMIT 1', function(err, rows, fields) {
														if (err) throw err;
													});

													connection.query('SELECT name FROM chest WHERE id = ' + chestId2, function(err, rows, fields) {
														if (err) throw err;
														var chestName2 = rows[0].name;
														connection.query('DELETE FROM inventory WHERE item_id = 618 AND player_id = ' + from_id + ' LIMIT 1', function(err, rows, fields) {
															if (err) throw err;

															connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + from_id + ',' + chestId2 + ')', function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('DELETE FROM inventory_chest WHERE player_id = ' + to_id + ' AND chest_id = ' + chestId2 + ' LIMIT 1', function(err, rows, fields) {
																if (err) throw err;
															});

															var randStone = Math.round(Math.random()*3);
															var stone_id = 70+randStone;
															connection.query('SELECT name FROM item WHERE id = ' + stone_id, function(err, rows, fields) {
																if (err) throw err;

																var stone_name = rows[0].name;
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + from_id + ',' + stone_id + ')', function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + from_id + ',' + stone_id + ')', function(err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + from_id + ',' + stone_id + ')', function(err, rows, fields) {
																	if (err) throw err;
																});

																bot.sendMessage(message.chat.id, "Sei riuscito a rubare *" + chestName + "* e *" + chestName2 + "* ed il druido delle prelevazioni ti ha premiato con 3x " + stone_name + "!", pBack);
																if (house_id != 6){
																	bot.sendMessage(chat_id, "Uno scassinatore professionista Ã¨ riuscito a rubarti *" + chestName + "* e *" + chestName2 + "* dal rifugio!");
																}else{
																	bot.sendMessage(chat_id, "Un truffatore di nome " + message.from.username.replace(new RegExp("_", "g"), " ") + " Ã¨ riuscito a rubarti *" + chestName + "* e *" + chestName2 + "* dallo zaino!", mark);
																}

																setAchievement(message.chat.id, from_id, 47, 1);

																var d = new Date();
																d.setHours(d.getHours() + 48);
																var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																connection.query('UPDATE player SET capsule_limit = capsule_limit+1 WHERE id = ' + to_id, function(err, rows, fields) {
																	if (err) throw err;
																});

																var rand = Math.random()*200;
																if ((rand < 5) && (reborn >= 3)){
																	connection.query('INSERT INTO inventory  (player_id, item_id) VALUES (' + player_id + ',532)', function(err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Un *Urlo di Morte* rieccheggia in lontananza... Wow!");
																	});
																}
															});
														});
													});
												});
											});
										}else{
											bot.sendMessage(message.chat.id, "L'utente specificato non esiste o non puÃ² essere prelevato.", pBack);
										}
									});
								});
							};
						};
					});
				});
			};
		});
	});
});

bot.onText(/migliora rifugio/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var from_id = rows[0].id;

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if ((house_id+1) > 6){
			bot.sendMessage(message.chat.id, "Hai raggiunto il limite massimo di upgrade del rifugio.", back);
			return;
		}

		var level_text = "";
		var level = [];
		var level_money = 0;
		var check1 = "âœ…";
		var check2 = "âœ…";
		var check3 = "âœ…";

		if ((house_id+1) == 2){
			level_text = "> Cemento Armato\n> Materiale da Costruzione\n> Marmo";
			level = [144,145,148];
			level_money = 1500;
		}else if ((house_id+1) == 3){
			level_text = "> Progetto di Costruzione\n> Materiale da Costruzione\n> Marmo";
			level = [147,145,148];
			level_money = 3000;
		}else if ((house_id+1) == 4){
			level_text = "> Progetto di Costruzione\n> Titanio\n> Marmo";
			level = [147,149,148];
			level_money = 4500;
		}else if ((house_id+1) == 5){
			level_text = "> Progetto di Costruzione\n> Titanio\n> Oro Nero";
			level = [147,149,105];
			level_money = 7000;
		}else if ((house_id+1) == 6){
			level_text = "> Progetto Definitivo\n> Congegno Parallelo\n> Cella Blindata";
			level = [359,367,370];
			level_money = 10000;			
		}

		connection.query('SELECT inventory.item_id FROM player, inventory WHERE inventory.item_id = ' + level[0] + ' AND inventory.player_id = player.id AND player.id=' + from_id, function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				check1 = "";	
			}
			connection.query('SELECT inventory.item_id FROM player, inventory WHERE inventory.item_id = ' + level[1] + ' AND inventory.player_id = player.id AND player.id=' + from_id, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					check2 = "";
				}
				connection.query('SELECT inventory.item_id FROM player, inventory WHERE inventory.item_id = ' + level[2] + ' AND inventory.player_id = player.id AND player.id=' + from_id, function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						check3 = "";
					}


					if ((house_id+1) == 2){
						level_text = "> Cemento Armato " + check1 + "\n> Materiale da Costruzione " + check2 + "\n> Marmo " + check3;
					}else if ((house_id+1) == 3){
						level_text = "> Progetto di Costruzione " + check1 + "\n> Materiale da Costruzione " + check2 + "\n> Marmo " + check3;
					}else if ((house_id+1) == 4){
						level_text = "> Progetto di Costruzione " + check1 + "\n> Titanio " + check2 + "\n> Marmo " + check3;
					}else if ((house_id+1) == 5){
						level_text = "> Progetto di Costruzione " + check1 + "\n> Titanio " + check2 + "\n> Oro Nero " + check3;
					}else if ((house_id+1) == 6){
						level_text = "> Progetto Definitivo " + check1 + "\n> Congegno Parallelo " + check2 + "\n> Cella Blindata " + check3;
					}

					bot.sendMessage(message.chat.id, "Per passare al livello " + (house_id+1) + " del rifugio devi possedere i seguenti oggetti:\n" + level_text + "\nOltre a " + level_money + " Â§", yesno).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							var action = answer.text;
							if (action == "Torna al menu"){
								return;
							}

							if (money < level_money){
								bot.sendMessage(message.chat.id, "Non hai abbastanza monete!", back);
								return;
							}							

							connection.query('SELECT id FROM inventory WHERE item_id = ' + level[0] + ' AND player_id=' + from_id, function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "Non possiedi il primo oggetto richiesto.", back);
									return;
								}
								connection.query('SELECT id FROM inventory WHERE item_id = ' + level[1] + ' AND player_id=' + from_id, function(err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Non possiedi il secondo oggetto richiesto.", back);
										return;
									}
									connection.query('SELECT id FROM inventory WHERE item_id = ' + level[2] + ' AND player_id=' + from_id, function(err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0){
											bot.sendMessage(message.chat.id, "Non possiedi il terzo oggetto richiesto.", back);
											return;
										}

										connection.query('UPDATE player SET house_id = house_id+1, money=money-' + level_money + ' WHERE id = ' + from_id, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Potenziamento completato!", back);
										});

										connection.query('DELETE FROM inventory WHERE item_id = ' + level[0] + ' AND player_id = ' + from_id + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM inventory WHERE item_id = ' + level[1] + ' AND player_id = ' + from_id + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('DELETE FROM inventory WHERE item_id = ' + level[2] + ' AND player_id = ' + from_id + ' LIMIT 1', function(err, rows, fields) {
											if (err) throw err;
										});
									});
								});
							});
						};
					});	
				});
			});
		});
	});
});

function attack(nickname, message, from_id, weapon_bonus, cost, source){

	connection.query('SELECT exp, ability, chat_id, heist_count, heist_limit, heist_protection, house_id, id, money FROM player WHERE nickname="' + nickname + '"', function(err, rows, fields) {
		if (err) throw err;
		var chat_id_nickname = rows[0].chat_id;
		var isMatch = source;

		/*
		if ((message.from.username != "fenix45") && (message.from.username != "Gaius87") && (message.from.username != "CH4R124RD")){
			bot.sendMessage(message.chat.id, "Manutenzione", back);
			return;
		}
		*/

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Questo nickname non esiste, riprova.", back);
			return;
		}

		var to_id = rows[0].id;
		var house_id = rows[0].house_id;
		var heist_count = parseInt(rows[0].heist_count);
		var heist_limit = parseInt(rows[0].heist_limit);
		var ability = parseInt(rows[0].ability);

		var match = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Matchmaking"],["Torna al menu"]]
			}
		};

		if (wanted == 0){
			if (rows[0].heist_protection != null){
				bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione", match);
				return;
			}
			if (rows[0].money <= 0){
				bot.sendMessage(message.chat.id, "Il bersaglio ha poche monete, riprova cambiando giocatore.", match);
				return;				
			}

			if ((rows[0].exp <= 150) && (isMatch == 0)){
				bot.sendMessage(message.chat.id, "Il bersaglio ha poca esperienza, riprova cambiando giocatore.", match);
				return;
			}
		}

		connection.query('SELECT level FROM dragon WHERE player_id = ' + to_id, function(err, rows, fields) {
			if (err) throw err;

			var dragon_lev = 0;

			if (Object.keys(rows).length > 0){
				dragon_lev = rows[0].level;
			}

			connection.query('SELECT team.name FROM team_player, team WHERE team.id = team_player.team_id AND player_id = ' + to_id,  function(err, rows, fields) {
				if (err) throw err;

				var team_name = "-";

				if (wanted == 0){
					if (Object.keys(rows).length == 0){
						if (heist_limit >= 3){
							bot.sendMessage(message.chat.id, "Il bersaglio non possiede un team e ha raggiunto il limite di ispezioni subite. Riprova domani.", match);
							return;
						}
					}else{
						if (heist_limit >= 7){
							bot.sendMessage(message.chat.id, "Il bersaglio ha raggiunto il limite di ispezioni subite. Riprova domani.", match);
							return;
						}
						team_name = rows[0].name;
					}
				}

				if (isMatch == 1){
					connection.query('UPDATE player SET last_mm = ' + to_id + ' WHERE id = ' + from_id, function(err, rows, fields) {
						if (err) throw err;
					});
				}

				connection.query('SELECT name, rooms, grade FROM house WHERE id=' + house_id, function(err, rows, fields) {
					if (err) throw err;

					var house_name = rows[0].name;
					var grade = rows[0].grade;
					var rooms = rows[0].rooms;
					var iKeys = [];

					iKeys.push(["Invia Piedelesto"]);
					iKeys.push(["Invia Occhiofurbo"]);
					iKeys.push(["Invia Testacalda"]);
					iKeys.push(["Matchmaking (Â§)"]);
					iKeys.push(["Torna al menu"]);

					var option = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					connection.query('SELECT wanted_id FROM event_wanted_status WHERE player_id = ' + from_id, function(err, rows, fields) {
						if (err) throw err;

						var isWanted = 0;
						if (Object.keys(rows).length > 0){
							if (rows[0].wanted_id == to_id){
								isWanted = 1;
							}
						}

						connection.query('UPDATE player SET money=money-' + cost + ' WHERE id = ' + from_id, function(err, rows, fields) {
							if (err) throw err;
						});

						var dragon_text = "";
						if (dragon_lev > 0){
							dragon_text = " ed un drago di livello " + dragon_lev + " sorveglia la sua entrata";
						}

						var text = "Stai per inviare uno gnomo servitore al rifugio di <b>" + nickname + "</b> (" + team_name + ") con abilitÃ  " + ability + ".\nAlloggia in un " + house_name + " (" + house_id + ")" + dragon_text + ". Seleziona quale gnomo servitore vuoi inviare.";
						if (isWanted == 1){
							text = "Stai per inviare uno gnomo servitore alla cattura di <b>" + nickname + "</b>, seleziona quale gnomo esploratore vuoi inviare";
						}

						bot.sendMessage(message.chat.id, text, option).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {
								if ((answer.text == "Torna al menu") || (answer.text == "Matchmaking")){
									return;
								}

								var query = "";
								var method = 0;
								if (answer.text == "Invia Piedelesto"){
									method = 1;
								}else if (answer.text == "Invia Occhiofurbo"){
									method = 3;
								}else if (answer.text == "Invia Testacalda"){
									method = 2;
								}else{
									return;
								}

								//Secondi (massimo 6*600 + 100)
								var totTime = (grade*1200) + (dragon_lev*60) + (Math.round(Math.random()*300+60));

								var rate = 70;

								if (method == 1){
									totTime = Math.round(totTime*0.8);
									rate = 60;
								}else if (method == 3){
									totTime = Math.round(totTime*1.2);
									rate = 80;
								}

								if (wanted == 1){
									totTime = Math.round(totTime/1.5);
								}

								if (crazyMode == 1){
									totTime = Math.round(totTime/2);
								}

								if (isWanted == 1){
									totTime = (Math.round(Math.random()*10+5)*method)*60;
								}

								var now = new Date();
								now.setSeconds(now.getSeconds() + totTime);
								var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());
								var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

								var kb_heist = {
									parse_mode: "Markdown",
									reply_markup: {
										resize_keyboard: true,
										one_time_keyboard: true,
										"keyboard": [["Completa immediatamente"],["Torna al menu"]]
									}
								};

								connection.query('INSERT INTO heist (from_id, to_id, datetime, rate1, rate2, rate3, grade, matchmaking) ' +
												 'VALUES (' + from_id + ',' + to_id + ',"' + long_date + '",' + rate + ',0,0,' + grade + ',' + isMatch + ')', function(err, rows, fields) {
									if (err) throw err;
									if (isWanted == 0){
										bot.sendMessage(message.chat.id, "Hai inviato il tuo gnomo esploratore all'ispezione del rifugio selezionato, torna alle " + short_date + " per risolvere i dilemma del rifugio ed ottenere una ðŸ—", kb_heist);
									}else{
										bot.sendMessage(message.chat.id, "Hai inviato il tuo gnomo esploratore alla cattura del ricercato, torna alle " + short_date + " per scoprirne l'esito", kb_heist);
									}
								});
								connection.query('UPDATE player SET heist_count = heist_count+1 WHERE id = ' + from_id, function(err, rows, fields) {
									if (err) throw err;
								});
							};
						});
					});
				});
			});
		});
	});
}

function getRandomArbitrary(min, max) {
	return Math.random() * (max - min) + min;
}

bot.onText(/itinerario propizio|itinerari|regioni/i, function(message) {

	if (specialMission == 0){
		if (message.from.username != "fenix45"){
			return;
		}
	}

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Il tuo account non Ã¨ stato trovato, usa /start per crearne uno nuovo.", back);
			return;
		}

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (rows[0].mission_special_id != 0){
			var time = new Date(rows[0].mission_special_time_end);
			bot.sendMessage(message.chat.id, "Sei in itinerario fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()), back);
			return;
		}

		if (rows[0].mission_id != 0){
			bot.sendMessage(message.chat.id, "Non puoi iniziare un itinerario finchÃ¨ sei in missione", abort_mission);
			return;
		}

		var player_id = rows[0].id;
		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;
		var charm_id = rows[0].charm_id;
		var life = rows[0].life;		
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;
		var money = rows[0].money;
		var class_id = rows[0].class;
		var travel_id = rows[0].travel_id;
		var cave_id = rows[0].cave_id;

		if ((boost_mission <= 0) && (boost_id != 0)){
			connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
				console.log("BOOST_RESET: " + boost_id + " - " + boost_mission);
			});
			boost_mission = 0;
			boost_id = 0;
		}

		connection.query('SELECT * FROM rarity WHERE special_mission IS NOT NULL', function(err, rows, fields) {
			if (err) throw err;

			var iKeys = [];
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push([rows[i].special_mission + " (" + rows[i].shortname + ")"]);
			}

			iKeys.push(["Torna al menu"]);

			var kbRar = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			bot.sendMessage(message.chat.id, "*Itinerario Propizio*\nDurante la tua avventura hai trovato una *mappa* che indica con precisione tutti i carichi di merci che viaggiano nel mondo di Lootia" +
							" ed il loro contenuto, puoi recarti in quei luoghi e magari potresti trovare un oggetto tra quelli segnati, buona fortuna!\n\n" +
							"Seleziona la regione e segui un itinerario", kbRar).then(function() {
				answerCallbacks[message.chat.id] = function(answer) {

					if (answer.text == "Torna al menu"){
						return;
					}

					var reg4 = /\((.+)\)/i;
					var rar = answer.text.match(reg4);

					connection.query('SELECT * FROM mission_zone WHERE rarity = "' + rar[1] + '"', function(err, rows, fields) {
						if (err) throw err;

						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							iKeys.push([rows[i].name + " (" + Math.round(rows[i].duration/60) + " minuti)"]);
						}

						iKeys.push(["Torna alle regioni"]);
						iKeys.push(["Torna al menu"]);

						var kbMiss = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						var missConf = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								one_time_keyboard: true,
								"keyboard": [["Si"],["Torna agli itinerari"],["Torna al menu"]]
							}
						};

						bot.sendMessage(message.chat.id, "Seleziona la zona in cui iniziare un itinerario", kbMiss).then(function() {
							answerCallbacks[message.chat.id] = function(answer) {

								if ((answer.text == "Torna al menu") || (answer.text == "Torna alle regioni")){
									return;
								}

								var zn = answer.text.substring(0, answer.text.indexOf("(")-1);

								connection.query('SELECT * FROM mission_zone WHERE name = "' + zn + '"', function(err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0){
										bot.sendMessage(message.chat.id, "Zona non valida", back);
										return;
									}

									var name = rows[0].name;
									var mission_id = rows[0].id;
									var duration = rows[0].duration;
									var mission_description = rows[0].description;
									var rarity = rows[0].rarity;
									var items = "";

									connection.query('SELECT item.name, item.rarity FROM mission_zone_item, item, mission_zone WHERE mission_zone_item.zone_id = mission_zone.id AND mission_zone.id = ' + mission_id + ' AND mission_zone_item.item_id = item.id', function(err, rows, fields) {
										if (err) throw err;

										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											items += "\n> " + rows[i].name + " (" + rows[i].rarity + ")";
										}

										if ((parseInt(life) <= 0) && (parseInt(exp) > 10)){
											bot.sendMessage(message.chat.id, "Non puoi affrontare gli itinerari da morto.", back);
											return;
										}

										var parsedDate = new Date();
										var extra1 = "âœ…";
										var extra2 = "âœ…";

										if (charm_id == 60){ //RapiditÃ 
											duration -= duration*0.05;
										}else if (charm_id == 187){
											duration -= duration*0.1;
										}else if (charm_id == 188){
											duration -= duration*0.15;
										}else{
											extra1 = "âŒ";
										}
										if ((class_id == 3) && (reborn == 3)){
											duration -= (duration*0.05);
										}
										if ((class_id == 3) && (reborn >= 4)){
											duration -= (duration*0.1);
										}

										if (boost_id == 1){
											duration = duration/2;
											name = name + " (Velocizzata)";
										}else if ((boost_id == 0) || (boost_id == 3)){
											extra2 = "âŒ";
										}

										parsedDate.setSeconds(parsedDate.getSeconds() + duration);

										bot.sendMessage(message.chat.id, "Iniziare l'itinerario nel " + name + "?\n\nTalismano VelocitÃ : " + extra1 + "\nBevanda: " + extra2 + "\n\nOggetti trovabili in questo luogo:" + items, missConf).then(function() {
											answerCallbacks[message.chat.id] = function(answer) {
												if (answer.text.toLowerCase() == "si"){
													var mission_date = addZero(parsedDate.getHours()) + ":" + addZero(parsedDate.getMinutes()) + ":" + addZero(parsedDate.getSeconds());
													var description = mission_description.replace(new RegExp("%player%", "g"), message.from.username.replace(new RegExp("_", "g"), " "));
													var long_date = parsedDate.getFullYear() + "-" + addZero(parsedDate.getMonth()+1) + "-" + addZero(parsedDate.getDate()) + " " + addZero(parsedDate.getHours()) + ':' + addZero(parsedDate.getMinutes()) + ':' + addZero(parsedDate.getSeconds());
													bot.sendMessage(message.chat.id, "*" + name + "*\n" + message.from.username.replace(new RegExp("_", "g"), " ") + ", " + description + " " + mission_date + " _(" + toTime(duration) + ")_", back);

													connection.query('UPDATE `player` SET event=0,`mission_special_id`=' + mission_id + ',`chat_id`=' + message.chat.id + ', `mission_special_time_end`="' + long_date + '" WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
														if (err) throw err;
													});

													if (boost_id == 1){
														if (boost_mission-1 == 0){
															connection.query('UPDATE `player` SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}else{
															connection.query('UPDATE `player` SET boost_mission = boost_mission - 1 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}
													}
													dailyChest(message, player_id);
												}
											};
										});
									});
								});
							};
						});
					});
				};
			});
		});
	});	
});

bot.onText(/nuova missione/i, function(message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Il tuo account non Ã¨ stato trovato, usa /start per crearne uno nuovo.", back);
			return;
		}

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		if (rows[0].mission_special_id != 0){
			var time = new Date(rows[0].mission_special_time_end);
			bot.sendMessage(message.chat.id, "Sei in itinerario fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()), back);
			return;
		}

		var player_id = rows[0].id;
		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;
		var charm_id = rows[0].charm_id;
		var life = rows[0].life;
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;
		var money = rows[0].money;
		var class_id = rows[0].class;

		if ((class_id == 1) && (reborn >= 3)){
			bot.sendMessage(message.chat.id, "Raggiunta questa Rinascita la Vocazione Ã¨ obbligatoria, la puoi scegliere nella sezione Giocatore > Vocazione", back);
			return;
		}

		helpMsg(message.chat.id, player_id, 2);

		if ((boost_mission <= 0) && (boost_id != 0)){
			connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
				console.log("BOOST_RESET: " + boost_id + " - " + boost_mission);
			});
			boost_mission = 0;
			boost_id = 0;
		}

		if ((parseInt(life) <= 0) && (parseInt(exp) > 10)){
			bot.sendMessage(message.chat.id, "Non puoi affrontare le missioni da morto.", back);
			return;
		}

		if ((rows[0].travel_id != 0) || (rows[0].cave_id != 0)){
			bot.sendMessage(message.chat.id, "Non puoi andare in missione finchÃ¨ sei in viaggio.", back);
			return;
		}else{
			connection.query('SELECT mission_id, lore_page, lore_mission, mission_time_end, mission_auto_id FROM player WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;	
				var id = rows[0].mission_id;
				var time = new Date(rows[0].mission_time_end);
				var mission_auto = rows[0].mission_auto_id;
				var current = 0;
				var lore_page = rows[0].lore_page;
				var lore_mission = rows[0].lore_mission;

				connection.query('SELECT * FROM heist WHERE from_id=' + player_id, function(err, rows, fields) {
					if (err) throw err;

					if (id != 0){
						bot.sendMessage(message.chat.id, "Sei in missione fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), abort_mission);
						return;
					}

					if ((lore_page == 1) && (lore_mission == 0)){
						var rand = Math.random()*100;
						if (rand < 5){
							var newDate = new Date();
							newDate.setHours(newDate.getHours() + 1);
							var mission_date = addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());
							var description = "peregrini: furente, incoerente; rimbombo di passi; miraggio - rimbomba -, ora realtÃ : e grigia Ã¨ la chioma, grigia la polvere d'un lungo itinerare, d'un vecchio, vetusto, che a lungo potÃ© errare; e agli occhi l'effimero - strepita -, il sempiterno: o Lootia, te vide, di te volle scrivere, in te fu pregno. Giacque dunque la punta su un foglio, e di essa l'inchiostro grondante. Ma d'una tempesta si ode il crepito; langue, al suon della morte; fredda la quiete, prima del fremito. 'Al Tempio, al Tempio!', rimembri i canti, 'Al Tempo giocoso, a Spazi cangianti'. E rimbomba, o rimbomba, il suon dei suoi passi - quasi in un ballo in fa diesis minore -; urla la fenice, spirando la vita; a Un Nuovo Inizio sorge in albore." +
								"\nE s'aprirÃ  l'entrata al vecchio inchiostro di un possesso per sempre." +
								"\n\n...\n\nSilenzio.\n\n...\n\n" +
								"Ah, sÃ¬, ricevi anche un macabro omaggio e torni al Rifugio alle " + mission_date;
							var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth()+1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());
							connection.query('UPDATE `player` SET lore_mission = 1, event = 1, `mission_id` = 1001, `mission_time_end`="' + long_date + '" WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "*Polvere*\n" + message.from.username.replace(new RegExp("_", "g"), " ") + ", " + description, abort_mission);
							});
							return;
						}
					}

					if (mission_auto == 0){
						mission_auto += 1;
					}

					connection.query('SELECT chest_id FROM mission_auto WHERE id = ' + mission_auto, function(err, rows, fields) {
						if (err) throw err;

						var chest_id = rows[0].chest_id;
						if (chest_id == 6){
							var rand = Math.random()*100;
							if (rand <= 5){
								chest_id = 7;
							}
						}

						var result = 0;
						if (chest_id != 7){
							var minTime = [0,600,1000,5200,9500,36000,85000];
							var maxTime = [0,900,3000,9400,23000,54000,93000];
							var stdev = [0,200,977,1787,6635,10220,3348];
							var media = [0,889,1822,6297,17252,47798,88004];

							var randx = 0;
							var randy = 1;
							var checkDuration = 0;

							while (randy > checkDuration){
								randx = getRandomArbitrary(minTime[chest_id], maxTime[chest_id]);
								randy = getRandomArbitrary(0, 1/Math.sqrt(2*stdev[chest_id]));
								checkDuration = (1/Math.sqrt(2*Math.PI*stdev[chest_id]))*Math.exp(-1/2*Math.pow((randx-media[chest_id])/stdev[chest_id]),2);
							}
							result = Math.round(randx);
						}else if (chest_id == 7){
							result = 172800;
						}

						var duration = result;

						connection.query('SELECT name, description, id As mission_id FROM mission WHERE chest_id = ' + chest_id + ' ORDER BY RAND()', function(err, rows, fields) {
							if (err) throw err;
							var dbDate = new Date;
							var parsedDate = new Date(Date.parse(dbDate));
							var name = rows[0].name;
							var mission_id = rows[0].mission_id;
							var mission_description = rows[0].description;

							var extra1 = "âœ…";
							var extra2 = "âœ…";

							if (charm_id == 60){ //RapiditÃ 
								duration = duration - (duration/100*5);
							}else if (charm_id == 187){
								duration = duration - (duration/100*10);
							}else if (charm_id == 188){
								duration = duration - (duration/100*15);
							}else{
								extra1 = "âŒ";
							}
							if ((class_id == 3) && (reborn == 3)){
								duration -= (duration*0.05);
							}
							if ((class_id == 3) && (reborn >= 4)){
								duration -= (duration*0.1);
							}

							var newDate = new Date(parsedDate.getTime() + (1000 * duration));

							if (boost_id == 1){
								duration = duration/2;
								name = name + " (Velocizzata)";
								newDate = new Date(parsedDate.getTime() + (1000 * (Math.round(duration*100)/100)));
							}else if ((boost_id == 0) || (boost_id == 3)){
								extra2 = "âŒ";
							}

							if (crazyMode == 1){
								duration = duration/2;
								name = name + " (FOLLE)";
								newDate = new Date(parsedDate.getTime() + (1000 * (Math.round(duration*100)/100)));
							}

							if (luckyMode == 1){
								name = name + " (FORTUNA?)";
							}

							connection.query('SELECT rarity_shortname FROM chest WHERE id = ' + chest_id, function(err, rows, fields) {
								if (err) throw err;

								var rarity_short = rows[0].rarity_shortname;
								if (rarity_short == "U"){
									rarity_short = "E";
								}

								bot.sendMessage(message.chat.id, "Iniziare la missione?\nRaritÃ  Scrigno: " + rarity_short + "\nTalismano VelocitÃ : " + extra1 + "\nBevanda: " + extra2, yesno).then(function() {
									answerCallbacks[message.chat.id] = function(answer) {
										if (answer.text.toLowerCase() != "si"){
											return;
										}

										var mission_date = addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());
										var description = mission_description.replace(new RegExp("%player%", "g"), message.from.username.replace(new RegExp("_", "g"), " "));
										var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth()+1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());

										bot.sendMessage(message.chat.id, "*" + name + "*\n" + message.from.username.replace(new RegExp("_", "g"), " ") + ", " + description + " " + mission_date + " _(" + toTime(duration) + ")_", abort_mission);

										if ((mission_auto+1) > max_mission_id){
											mission_auto = 1;
										}else{
											mission_auto++;
										}

										connection.query('UPDATE `player` SET event = 0, `mission_id`=' + mission_id + ',`chat_id`=' + message.chat.id + ', mission_auto_id=' + mission_auto + ',`mission_time_end`="' + long_date + '" WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
											if (err) throw err;
										});

										if (boost_id == 1){
											if (boost_mission-1 == 0){
												connection.query('UPDATE `player` SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}else{
												connection.query('UPDATE `player` SET boost_mission = boost_mission - 1 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}
										}
										if (crazyMode == 1){
											if ((rarity_short == "L") || (rarity_short == "E")){
												connection.query('UPDATE `player` SET `gems`=gems+1 WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "FOLLE! Hai ricevuto una Gemma ðŸ’Ž!");
												});					
											}
										}

										dailyChest(message, player_id);
									};
								});
							});
						});
					});
				});
			});
		};
	});
});

function helpMsg(chat_id, player_id, type){
	connection.query('SELECT * FROM help_message WHERE player_id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			connection.query('INSERT INTO help_message (player_id, type_' + type + ') VALUES (' + player_id + ',1)', function(err, rows, fields) {
				if (err) throw err;
			});
		}else{
			var name = 'rows[0].type_' + type;
			if (eval(name) == 1){
				return;
			}
			connection.query('UPDATE help_message SET type_' + type + ' = 1 WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});
		}

		var text = "";
		switch (type){
			case 1:
				text = 	"*LE IMPRESE*\n\n" +
					"Le imprese sono degli obbiettivi giornalieri di tipi molto differenti, che vanno dalle missioni da completare, a viaggi, a oggetti da creare. Ogni impresa completata fornisce Â§ e viene contata per un premio finale dopo un certo numero di completamenti. Le imprese vengono resettate ogni giorno a mezzanotte e non sono disponibili durante il weekend, a differenza degli eventi. Nella schermata principale inoltre viene visualizzata l'impresa che si Ã¨ prossimi a completare, cosÃ¬ da agevolarne l'ottenimento del premio. Infine per quanto riguarda i casi in cui un'impresa fosse riferita ad un oggetto, quest'ultimo verrÃ  visualizzato in questa sezione del menÃ¹.";
				break;
			case 2:
				text = 	"*LE MISSIONI*\n\n" +
					"Le missioni sono uno dei tanti modi per ottenere oggetti nel bot, una volta iniziate Ã¨ sufficiente attendere il tempo specificato per ricevere automaticamente uno scrigno corrispondente alla raritÃ  della stessa. Dopo aver ottenuto lo scrigno, recarsi nella sezione Scrigni del menu principale per aprirlo. Nelle missioni Ã¨ possibile ottenere bevande che offrono vari effetti come raddoppio delle monete o diminuzione del tempo di attesa. I Talismani e altri oggetti equipaggiabili possono influire nella missione. Si tratta di una delle funzioni fondamentali del gioco, svolgine il piÃ¹ possibile!";
				break;
			case 3:
				text = "*I BOSS*\n\n" +
					"I boss sono dei temibili mostri affrontabili solamente in team, alla loro uccisione tutti ne otterrete monete e esperienza. E' possibili utilizzare diversi tipi di attacchi come il Leggero, il Pesante, gli Incantesimi e i Consumabili, considerando che il boss Ã¨ condiviso fra tutti i membri, Ã¨ necessario coordinarsi il piÃ¹ possibile per sconfiggerli tutti e 20 e ottenere il premio finale. Tuttavia se ti trovi ad un livello basso, Ã¨ sconsigliato lanciarsi anche contro i boss piÃ¹ deboli.";
				break;
			case 4:
				text = "*IL TEAM*\n\n" +
					"I team sono dei gruppi di giocatori utili a ottenere piÃ¹ monete e affrontare i boss per ottenere exp, Ã¨ possibile anche creare dei sotto team, dette accademie. La partecipazione e la collaborazione Ã¨ importante per abbattere tutti i boss e scalare la classifica.";
				break;
			case 5:
				text = "*IL DRAGO*\n\n" +
					"Il drago Ã¨ il tuo fedele compagno di avventure, puÃ² nascere con 6 pietre di diverso tipo ottenute dalle cave dal livello 10, una volta nato Ã¨ necessario dargli da mangiare per farlo crescere e ottenere piÃ¹ bonus in battaglia e nei viaggi, come l'aumento del danno e la riduzione dei tempi di attesa, come la produzione continua di bevande grazie ai suoi poteri. Inoltre Ã¨ utile negli eventi e nella difesa del rifugio.";
				break;
			case 6:
				text = "*IL NEGOZIO*\n\n" +
					"Nel negozio Ã¨ possibile acquistare Pozioni, Scrigni o Piume di Fenice, oppure vendere qualsiasi oggetto a prezzo base, tramite la funzione Ricicla invece Ã¨ possibile convertire 5 oggetti uguali in un altro oggetto della stessa raritÃ  oppure della raritÃ  successiva.";
				break;
			case 7:
				text = "*IL MERCATO*\n\n" +
					"Il mercato Ã¨ il luogo in cui si possono incontrare mercanti che vendono oggetti a buon prezzo, oppure regalarne. Da qui puoi seguire il link per entrare nel gruppo apposito e commerciare in gran quantitÃ . Il Mercante Pazzo mette a disposizione dei pacchetti di oggetti a buon prezzo ogni giorno, ricorda di darci un'occhiata!";
				break;
			case 8:
				text = "*IL GIOCATORE*\n\n" +
					"In questa sezione trovi tutte le informazioni sul tuo giocatore, oppure su quelle del giocatore che stai spiando, in base al livello del tuo rifugio ti vengono rivelate piÃ¹ informazioni sul bersaglio. Attraverso i pulsanti di Statistiche puoi visualizzare altre informazioni sulla tua avventura, se non visualizzi ancora il drago, visita l'apposita sezione dal menÃ¹ principale per ottenere altre informazioni. Ecco una descrizione per ogni voce:\n\nGiocatore ðŸ‘¤\nOgni simbolo sta ad indicare la tua esperienza e la tua RINASCITA\nðŸ”… Rinascita 0 \nðŸ”† Rinascita 1\nðŸ’« Rinascita 2\nðŸ”± Rinascita 3\nâšœï¸ Rinascita 4\nðŸ¹ La tua vocazione, una volta scelta non sarÃ  possibile cambiarla!\nðŸ’Ž Le Gemme in tuo possesso\nðŸ’° I soldi in tuo possesso\nâ¤ï¸ La tua vita, attuale e totale\nðŸ“¦ I punti creazione che hai realizzato fin'ora, tra parentesi quelli settimanali\n\nEquipaggiamento âš”ï¸\nðŸ—¡ La tua fedelissima arma\nðŸ¥‹ La tua armatura\nðŸ›¡ Il tuo scudo\nðŸ“¿ Il talismano che indossi\nðŸ’¥ Il range del tuo danno base\n\nðŸ‰ Il migliore amico del giocatore, il tuo draghetto!\nðŸ’± Informazioni sulla tua abilitÃ  nelle ispezioni, il tuo rango e una piccola descrizione personale";
				break;
			case 9:
				text = "*LA MODALITA' VACANZA*\n\n" +
					"Puoi attivare la modalitÃ  vacanza per essere protetto dalle ispezioni durante un periodo in cui non giochi, essa si attiva automaticamente se non giochi per un lungo periodo di tempo cosÃ¬ da non diventare preda facile. La durata minima Ã¨ 2 settimane durante le quali non potrai effettuare alcuna azione nel bot. Procedi con cautela.";
				break;
					}
		bot.sendMessage(chat_id, text, mark);
	});
}

bot.onText(/^imprese/i, function(message) {

	if (message.text.toLowerCase().indexOf("completate") != -1){
		return;
	}

	connection.query('SELECT id, account_id, achievement_count, dungeon_count, mission_count, exp FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var cnt = rows[0].achievement_count;
		var lev = Math.floor(rows[0].exp/10);
		var mission_count = rows[0].mission_count;
		var dungeon_count = rows[0].dungeon_count;

		helpMsg(message.chat.id, player_id, 1);
		setAchievementProgress(player_id, 1);

		connection.query('SELECT SUM(value) As globalVal FROM achievement_global', function(err, rows, fields) {
			if (err) throw err;

			var globalVal = rows[0].globalVal;
			if (globalVal == null){
				globalVal = 0;
			}

			connection.query('SELECT L.name, L.det, L.value, L.reward, L.type, S.progress, I.name As itemName FROM achievement_daily D INNER JOIN achievement_list L ON D.achievement_id = L.id LEFT JOIN achievement_status S ON S.achievement_id = D.achievement_id AND S.player_id = ' + player_id + ' LEFT JOIN item I ON D.item_id = I.id', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0){
					var text = "*Imprese giornaliere*\n";
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].progress == null){
							rows[i].progress = 0;
						}
						if (rows[i].type == 12){
							rows[i].name += " (" + rows[i].itemName + ")";
						}
						if (rows[i].progress >= rows[i].value){
							text += "> *" + rows[i].name + "*: " + formatNumber(rows[i].reward) + " Â§ ottenuti âœ… \n";
						}else{
							text += "> *" + rows[i].name + "*: " + formatNumber(rows[i].progress) + "/" + formatNumber(rows[i].value) + " " + rows[i].det + " (" + formatNumber(rows[i].reward) + " Â§)\n";
						}
					}

					text += "\n*Imprese complessive*\n";

					var end = 0;
					for (var i = 0, len = Object.keys(progLev).length; i < len; i++) {
						if (lev >= progLev[i]){
							end = (i+1);
						}
					}
					if (progLev[end] == undefined){
						text += "Imprese per livello completate\n";
					}else{
						text += "Livello " + lev + " su " + progLev[end] + " (" + formatNumber(progLevRew[end]) + " Â§)\n";
					}

					end = 0;
					for (var i = 0, len = Object.keys(progMis).length; i < len; i++) {
						if (mission_count >= progMis[i]){
							end = (i+1);
						}
					}
					if (progMis[end] == undefined){
						text += "Imprese per missioni completate\n";
					}else{
						text += mission_count + " su " + progMis[end] + " missioni completate (" + formatNumber(progMisRew[end]) + " Â§)\n";
					}

					end = 0;
					for (var i = 0, len = Object.keys(progDung).length; i < len; i++) {
						if (dungeon_count >= progDung[i]){
							end = (i+1);
						}
					}
					if (progDung[end] == undefined){
						text += "Imprese per dungeon completate\n";
					}else{
						text += dungeon_count + " su " + progDung[end] + " dungeon completati (" + formatNumber(progDungRew[end]) + " Â§)\n";
					}

					if (message.from.username == "fenix45"){
						text += "\n*Impresa globali*\n";
						text += "Sono stati inflitti *" + formatNumber(globalVal) + "* dmg su ?? dmg\n";
					}
					bot.sendMessage(message.chat.id, text + "\n*Imprese completate*: " + cnt + "\nRicevi un premio aggiuntivo dopo il completamento delle imprese giornaliere e di piÃ¹ imprese contemporanee!", back);
				}else{
					bot.sendMessage(message.chat.id, "Oggi non sono disponibili imprese da poter completare :(\nTorna in settimana!", back);
				}
			});
		});
	});
});

bot.onText(/^vacanza/i, function(message) {
	var iKeys = [];
	connection.query('SELECT account_id, holiday, id FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var holiday = rows[0].holiday;
		var player_id = rows[0].id;
		var btn = "Avvia ModalitÃ  Vacanza";

		helpMsg(message.chat.id, player_id, 9);

		if (holiday != 0){
			btn = "Disattiva ModalitÃ  Vacanza";
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [[btn],["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, "Puoi entrare in modalitÃ  vacanza quando sai di non riuscire ad accedere al gioco per lungo tempo, non vuoi essere Ispezionato o espulso dal team.\nDurante questo periodo non potrai effettuare alcuna operazione se non di visualizzazione. *La durata minima Ã¨ 2 settimane*, quando vuoi disattivarla dopo questo periodo torna su questa pagina e clicca Disattiva ModalitÃ  Vacanza.",kb).then(function() {
			answerCallbacks[message.chat.id] = function(answer) {
				if (answer.text == "Avvia ModalitÃ  Vacanza"){
					var now = new Date();
					now.setDate(now.getDate()+14);
					var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

					var now2 = new Date();
					now2.setDate(now2.getDate()+365);
					var long_date2 = now2.getFullYear() + "-" + addZero(now2.getMonth()+1) + "-" + addZero(now2.getDate()) + " " + addZero(now2.getHours()) + ':' + addZero(now2.getMinutes()) + ':' + addZero(now2.getSeconds());

					bot.sendMessage(message.chat.id, "Sei sicuro? Non potrai annullare la modalitÃ  per due settimane!", yesno).then(function() {
						answerCallbacks[message.chat.id] = function(answer) {
							if (answer.text.toLowerCase() == "si"){
								connection.query('INSERT INTO holiday (player_id, time_end) VALUES (' + player_id + ',"' + long_date + '")', function(err, rows, fields) {
									if (err) throw err;
									connection.query('UPDATE player SET holiday = 1, heist_protection = "' + long_date2 + '" WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai attivato la modalitÃ  vacanza!", back);
									});
								});
							}
						};
					});
				}else if (answer.text == "Disattiva ModalitÃ  Vacanza"){
					if (holiday == 0){
						bot.sendMessage(message.chat.id, "Non sei in vacanza!", back);
						return;
					}

					var now = new Date();
					var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

					connection.query('SELECT time_end FROM holiday WHERE player_id = ' + player_id, function (err, rows, fields) {					
						if (err) throw err;

						if (rows[0].time_end > long_date){
							var now = new Date(rows[0].time_end);
							var long_date = addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear();
							bot.sendMessage(message.chat.id, "Non puoi ancora tornare dalla vacanza, devi aspettare fino alle " + long_date + "!", back);
							return;
						}

						connection.query('UPDATE player SET holiday = 0, heist_protection = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							connection.query('DELETE FROM holiday WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai disattivato la modalitÃ  vacanza!", back);
							});
						});
					});
				}
			};
		});
	});
});

bot.onText(/viaggi/i, function(message) {
	var iKeys = [];

	connection.query('SELECT mission_special_id, mission_special_time_end, mission_id, id, reborn, exp, life, account_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;

		var account_id = (rows[0].account_id).toString();
		if (banlist_id.indexOf(account_id) != -1){
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banlist_tx[banlist_id.indexOf(account_id)] + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1){
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!", back)
			return;
		}

		var lev = rows[0].exp/10;
		var life = rows[0].life;
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;
		var player_id = rows[0].id;

		if ((life <= 0) && (exp > 10)){
			bot.sendMessage(message.chat.id, "Non puoi affrontare i viaggi da morto.", back);
			return;
		}
		/*
		if (rows[0].mission_special_id != 0){
			var time = new Date(rows[0].mission_special_time_end);
			bot.sendMessage(message.chat.id, "Sei in itinerario fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), abort_mission);
			return;
		}
		*/
		if (rows[0].mission_id != 0){
			bot.sendMessage(message.chat.id, "Non puoi andare in viaggio finchÃ¨ sei in missione.", back);
			return;
		}else{

			connection.query('SELECT * FROM event_dust_status WHERE player_id = ' + player_id, function(err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0){
					if (rows[0].extracting == 1){
						//	bot.sendMessage(message.chat.id, "Non puoi andare in viaggio finchÃ¨ il generatore Ã¨ attivo.", back);
						//	return;
					}
				}

				connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length > 0){
						if (rows[0].zone_id != 0){
							bot.sendMessage(message.chat.id, "Non puoi andare in viaggio finchÃ¨ sei in miniera.", back);
							return;
						}
					}

					connection.query('SELECT travel_id, travel_time_end, cave_id, cave_time_end, id, boost_id, boost_mission, charm_id FROM player WHERE nickname="' + message.from.username + '"', function(err, rows, fields) {
						if (err) throw err;
						var player_id = rows[0].id;
						var boost_id = rows[0].boost_id;
						var boost_mission = rows[0].boost_mission;
						var charm_id = rows[0].charm_id;

						if (rows[0].travel_id != 0){
							var time = new Date(rows[0].travel_time_end);
							bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), abort_travel);
							return;
						}else if (rows[0].cave_id != 0){
							var time = new Date(rows[0].cave_time_end);
							bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth()+1) + "/" + time.getFullYear(), back);
							return;
						}else{
							var extra = " UNION ALL SELECT name, duration FROM cave";
							if ((lev < 10) && (reborn == 1)){
								extra = "";
							}

							connection.query('SELECT * FROM dragon WHERE player_id = ' + player_id, function(err, rows, fields) {
								if (err) throw err;
								var dragon_boost = 0;
								var dragon_level = 0;
								var text = "";

								if (Object.keys(rows).length > 0){
									dragon_level = rows[0].level;
									if (dragon_level >= 50){
										dragon_level = 50;
									}
									dragon_boost = 1;
									text = " Il drago velocizza i tuoi viaggi.";
								}

								connection.query('SELECT name, duration FROM travel' + extra, function(err, rows, fields) {
									if (err) throw err;
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										if (dragon_boost == 1){
											iKeys.push(["Viaggia a " + rows[i].name + " (" + Math.floor(rows[i].duration-(rows[i].duration*dragon_level/100)) + " ore)"]);								
										}else{
											iKeys.push(["Viaggia a " + rows[i].name + " (" + rows[i].duration + " ore)"]);
										}
									}
									if (Object.keys(iKeys).length > 0){
										iKeys.push(["Torna al menu"]);
										var viaggio = "";

										var kb = {
											parse_mode: "Markdown",
											reply_markup: {
												resize_keyboard: true,
												one_time_keyboard: true,
												"keyboard": iKeys
											}
										};

										if (message.text.indexOf("Viaggia a") != -1){
											viaggio = message.text.substring(getPosition(message.text," ",2)+1);

											var pos = viaggio.indexOf("(");
											if (pos != -1){
												viaggio = viaggio.substr(0, pos-1);
											}

											if ((boost_id == 3) && (boost_mission <= 0)){
												connection.query('UPDATE player SET boost_id = 0 AND boost_mission = 0 WHERE id = ' + player_id, function(err, rows, fields) {
													if (err) throw err;
												});
												boost_id = 0;
											}

											var boost_text = "";

											if (viaggio.indexOf("Cava") != -1){						
												boost_text = "\nBevanda: âŒ";
												if ((boost_id == 3) && (boost_mission > 0)){
													boost_text = "\nBevanda: âœ…";
												}
												if (charm_id == 603){
													boost_text += "\nTalismano Nutriente: âœ…";
												}else{
													boost_text += "\nTalismano Nutriente: âŒ";
												}											
											}

											bot.sendMessage(message.chat.id, "Iniziare il viaggio?" + boost_text, yesno).then(function() {
												answerCallbacks[message.chat.id] = function(answer) {
													var resp = answer.text;
													if (resp.toLowerCase() != "si"){
														return;
													}
													var cavepos = viaggio.indexOf("Cava");
													if (cavepos != -1){
														if ((exp < 100) && (reborn == 1)){
															bot.sendMessage(message.chat.id, "Non puoi viaggiare in cava fino al livello 10.", back);
															return;
														}

														connection.query('SELECT * FROM cave WHERE name = "' + viaggio + '"', function(err, rows, fields) {
															if (err) throw err;
															if (Object.keys(iKeys).length == 0){
																bot.sendMessage(message.chat.id, "Cava non valida.", back);
																return;
															}else{
																var dbDate = new Date();
																var parsedDate = new Date(Date.parse(dbDate));
																var newDate = new Date(parsedDate.getTime() + (1000*60*60*Math.floor(rows[0].duration-(rows[0].duration*dragon_level/100))));
																var short_date = addZero(newDate.getDate()) + "/" + addZero(newDate.getMonth()+1) + "/" + newDate.getFullYear() + " alle " + addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());
																var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth()+1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());

																bot.sendMessage(message.chat.id, "*" + rows[0].name + "*\n" + message.from.username.replace(new RegExp("_", "g"), " ") + ", ti aspetta un esplorazione di _" + Math.floor(rows[0].duration-(rows[0].duration*dragon_level/100)).toString() + " ore_ nella " + viaggio + " che terminerÃ  il " + short_date, abort_travel);
																connection.query('UPDATE `player` SET `exp`=exp+1,`cave_id`=' + rows[0].id + ',`chat_id`=' + message.chat.id + ',`cave_time_end`="' + long_date + '" WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
																	if (err) throw err;
																});
															}
														});
													}else{
														connection.query('SELECT * FROM travel WHERE name = "' + viaggio + '"', function(err, rows, fields) {
															if (err) throw err;
															if (Object.keys(rows).length == 0){
																bot.sendMessage(message.chat.id, "Viaggio non valido.", back);
																return;
															}else{
																var dbDate = new Date();
																var parsedDate = new Date(Date.parse(dbDate));
																var newDate = new Date(parsedDate.getTime() + (1000*60*60*Math.floor(rows[0].duration-(rows[0].duration*dragon_level/100))));
																var short_date = addZero(newDate.getDate()) + "/" + addZero(newDate.getMonth()+1) + "/" + newDate.getFullYear() + " alle " + addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());	
																var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth()+1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());

																bot.sendMessage(message.chat.id, "*" + rows[0].name + "*\n" + message.from.username.replace(new RegExp("_", "g"), " ") + ", ti aspetta un viaggio di _" +  Math.floor(rows[0].duration-(rows[0].duration*dragon_level/100)).toString() + " ore_, " + rows[0].description + " " + short_date, abort_travel);
																connection.query('UPDATE `player` SET `exp`=exp+1,`travel_id`=' + rows[0].id + ',`chat_id`=' + message.chat.id + ',`travel_time_end`="' + long_date + '" WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
																	if (err) throw err;
																});
															}
														});
													}
												};
											});
											return;
										};
										bot.sendMessage(message.chat.id, "Seleziona il viaggio da intraprendere." + text + "\nAttenzione: iniziando il viaggio non potrai far missioni, ispezioni, o affrontare i boss.", kb);
									}
								});
							});
						}
					});	
				});
			});
		}
	});
});


//FUNZIONI

function refreshBosses(){
	connection.query('SELECT id FROM team WHERE boss_respawn < NOW() AND boss_respawn IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			connection.query('SELECT id, team_id, boss_id FROM boss_team WHERE team_id = ' + rows[0].id, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0){
					rows.forEach(respawnBoss);
				}
				console.log("Respawn boss per team " + rows[0].team_id);
			});
			connection.query('SELECT player_id, chat_id FROM `team_player`, player WHERE team_player.player_id = player.id AND team_id = ' + rows[0].id + ' ORDER BY team_player.id', function(err, rows, fields) {
				if (err) throw err;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					bot.sendMessage(rows[i].chat_id, "I boss sono tornati in vita, torna a combattere!");
				}
			});
		}
	});
}

function respawnBoss(element, index, array){
	if (element.boss_id == 1){
		connection.query('UPDATE `boss_team` SET life = total_life, killedby = "", unlocked = 1 WHERE id = ' + element.id, function(err, rows, fields) {
			if (err) throw err;
		});	
	}else{
		connection.query('UPDATE `boss_team` SET life = total_life, killedby = "", unlocked = 0 WHERE id = ' + element.id, function(err, rows, fields) {
			if (err) throw err;
		});
	}
	connection.query('UPDATE `team` SET boss_respawn = NULL WHERE id = ' + element.team_id, function(err, rows, fields) {
		if (err) throw err;
	});
	connection.query('DELETE FROM boss_damage WHERE team_id = ' + element.team_id, function(err, rows, fields) {
		if (err) throw err;
	});
	connection.query('UPDATE player P INNER JOIN team_player T ON P.id = T.player_id SET P.boss_id = 0 WHERE T.team_id = ' + element.team_id, function(err, rows, fields) {
		if (err) throw err;
	});
}

function refreshLife(){
	connection.query('UPDATE `player` SET `life`=total_life', function(err, rows, fields) {
		if (err) throw err;
		console.log(getNow("it") + " Vita resettata.");
	});
	connection.query('DELETE FROM daily_chest', function(err, rows, fields) {
		if (err) throw err;
		console.log(getNow("it") + " Scrigni giornalieri resettati.");
	});	
}

function checkTeam(){
	connection.query('SELECT id, chat_id FROM player WHERE team_time < NOW() AND team_time IS NOT NULL', function(err, rows, fields) {
		var chat_id = 0;
		var id = 0;
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				chat_id = rows[i].chat_id;
				id = rows[i].id;

				connection.query('UPDATE player SET team_time = NULL WHERE id =' + id, function(err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
	connection.query('SELECT id, chat_id FROM player WHERE boss_time < NOW() AND boss_time IS NOT NULL', function(err, rows, fields) {
		var chat_id = 0;
		var id = 0;
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				chat_id = rows[i].chat_id;
				id = rows[i].id;

				connection.query('UPDATE player SET boss_time = NULL WHERE id = ' + id, function(err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
};

function checkEvents(){
	connection.query('SELECT * FROM `player` WHERE event = 0 AND mission_id != 0 AND money > 500 AND exp > 100 ORDER BY RAND() LIMIT 10', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + " 1 evento da notificare");
			}else{
				console.log(getNow("it") + " " + Object.keys(rows).length + " eventi da notificare");
			}
			rows.forEach(setEvents);
		}
	});
}

function setEvents(element, index, array){
	var player_id = 0;
	var chat_id = 0;
	var level = 0;
	var rand = 0;
	var text = "";
	var itemName = "";
	var itemName2 = "";
	var itemName3 = "";
	var chat_id_t = 0;
	var money = 0;

	rand = Math.round(Math.random()*46);

	if (crazyMode == 1){
		rand = Math.round(Math.random()*51);
	}

	player_id = element.id;
	boss_id = element.boss_id;
	chat_id = element.chat_id;
	level = element.exp/10;
	exp = element.exp;
	money = element.money;

	//console.log(player_id, rand, chat_id);
	if (rand == 0){
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("C", "NC") AND item.craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			connection.query('INSERT INTO inventory  (player_id, item_id) VALUES(' + player_id + ', ' + rows[0].id + ')', function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione hai incontrato un mercante, che con la sua immensa ed incredibile gentilezza ti lascia un dono per il tuo grande coraggio, ti ha regalato un " + itemName;
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 1){
		var damage = Math.round(Math.random()*(exp*3))+1;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione un mostro ti ha attaccato alle spalle e ti ha tolto " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 2){
		var damage = Math.round(Math.random()*(exp*2))+1;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione una trappola ti ha sorpreso e hai perso " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 3){
		var value = Math.round(Math.random()*(exp*5))+1;
		if (money - value <= 0){
			return;
		}
		if (value <= 0){
			value == 0;
		}
		connection.query('UPDATE player SET money = money - ' + value + ' WHERE player.id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione un ladro ti ha spintonato e rubato " + value + " Â§";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 4){
		var value = Math.round(Math.random()*(exp))+50;
		if (money - value <= 0){
			value = 1;
		}
		connection.query('UPDATE player SET money = money - ' + value + ' WHERE player.id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione incontri un uomo bisognoso, decidi di donargli " + value + " Â§";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 5){
		var value = Math.round(Math.random()*(exp*2))+10;
		connection.query('UPDATE player SET money = money + ' + value + ' WHERE player.id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione trovi un sacchetto pieno d'oro, ottieni cosÃ¬ " + value + " Â§";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 6){
		connection.query('SELECT life, total_life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var value = Math.round(Math.random()*(rows[0].total_life/5))+10;

			connection.query('UPDATE player SET life = life + ' + value + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione ti imbatti in un piccolo villaggio e recuperi " + value + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 7){
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("C", "NC") AND item.craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			connection.query('INSERT INTO inventory  (player_id, item_id) VALUES(' + player_id + ', ' + rows[0].id + ')', function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione salvi un bambino dai manigoldi del villaggio, e ricevi come ricompensa " + itemName;
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 8){
		var value = Math.round(Math.random()*(exp/4))+15;
		connection.query('UPDATE player SET life = life + ' + value + ' WHERE player.id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			text = "Durante una missione ricevi una bevanda rigenerante, grazie ad essa recuperi " + value + " hp";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 9){
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("NC","R") AND item.craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			connection.query('INSERT INTO inventory  (player_id, item_id) VALUES(' + player_id + ', ' + rows[0].id + ')', function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione trovi un piccolo scrigno che potrebbe contentere qualcosa di interessante, lo apri e trovi " + itemName;
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 10){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 10);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione trovi una scorciatoia, risparmi cosÃ¬ 10 minuti";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 11){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 10);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione ti imbatti in un bivio, tuttavia prendi la strada piÃ¹ lunga, tornerai 10 minuti piÃ¹ tardi";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 12){
		var damage = Math.round(Math.random()*(level*2))+10;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione il cielo si fa scuro e comincia a piovere, solamente che la pioggia che cade ti brucia la pelle, perdi cosÃ¬ " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 13){
		connection.query('SELECT item_id, name FROM inventory_rarity WHERE rarity IN ("C","NC") AND player_id=' + player_id + ' ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				var itemId = rows[0].item_id;
				var itemName = rows[0].name;
				connection.query('DELETE FROM inventory WHERE item_id = ' + itemId + ' AND player_id=' + player_id + ' LIMIT 1', function(err, rows, fields) {
					if (err) throw err;
					text = "Durante la missione ti accorgi che lo zaino Ã¨ piÃ¹ leggero, controlli ed effettivamente manca l'oggetto " + itemName + "!";
					bot.sendMessage(chat_id, text);
				});
			}else{
				text = "Durante la missione ti accorgi che lo zaino Ã¨ piÃ¹ leggero, controlli ma non manca nulla! Era solo un impressione...";
				bot.sendMessage(chat_id, text);
			}
		});
	}else if (rand == 14){
		var textArray = [
			'Durante la missione rischi di scivolare scalando una montagna, ma per fortuna mantieni salda la presa e non succede nulla',
			'Durante la missione un cavallo sulla collina vicina, diventa improvvisamente un orco. Fortunatamente non ti vede e non succede nulla',
			'Durante la missione osservi un uccellino che sta consumando il suo pranzo, quando ti accorgi che in realtÃ  si tratta di uno stivale, decidi di andartene e non succede nulla',
			'Durante la missione vedi uno scheletro adagiato su un angolino della strada, ma ti strofini gli occhi e ti accorgi che in realtÃ  si tratta di una paperella, ah',
			'Durante la missione inizi una missione, ma nemmeno in quella accade nulla di strano, che strano, peccato',
			'Durante la missione... no fa troppo caldo, quindi non fai nulla',
			'Durante la missione un ladro ti spintona e ti ruba lo zaino. Ah! Scherzavo.',
			'Durante la missione trovi il collo di Maurizio Costanzo che in realtÃ  non esiste quindi non succede nulla',
			'Durante la missione vedi un mercante addormentato. Decidi di derubarlo quando all\'improvviso risuona una voce che fa "E SE POI TE NE PENTI?". Allora cambi idea e continui per la tua strada'
		];
		var rand = Math.floor(Math.random()*textArray.length);
		bot.sendMessage(chat_id, textArray[rand]);
	}else if (rand == 15){
		var damage = Math.round(Math.random()*(exp*7))+40;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione scivoli da un dirupo molto alto, ti rompi un osso della gamba e perdi " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 16){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 20);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione un goblin ti nota e ti insegue con la bava alla bocca, sei costretto a deviare la strada quindi tornerai 20 minuti piÃ¹ tardi";
			bot.sendMessage(chat_id, text);
		});			
	}else if (rand == 17){
		var value = Math.round(Math.random()*(exp*3))+5;
		if (money - value <= 0){
			value = money;
		}
		connection.query('UPDATE player SET money = money - ' + value + ' WHERE player.id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione ti distrai in un casinÃ², ma sfortunatamente non sei un buon giocatore cosÃ¬ perdi " + value + " Â§";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 18){
		var value = Math.round(Math.random()*(exp*3))+5;
		connection.query('UPDATE player SET money = money + ' + value + ' WHERE player.id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione ti distrai in un casinÃ², sei un gran giocatore! Vinci cosÃ¬ " + value + " Â§";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 19){
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("C","NC","R") AND item.craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			itemName2 = rows[1].name;
			itemName3 = rows[2].name;
			connection.query('INSERT INTO inventory  (player_id, item_id) VALUES(' + player_id + ', ' + rows[0].id + ')', function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione noti un mercante qualche metro davanti a te, ad un certo punto perÃ² il suo sacco pieno si rompe, raccogli gli oggetti e trovi " + itemName + ", " + itemName2 + " e " + itemName3;
				bot.sendMessage(chat_id, text);
			});
			connection.query('INSERT INTO inventory  (player_id, item_id) VALUES(' + player_id + ', ' + rows[1].id + ')', function(err, rows, fields) {
				if (err) throw err;
			});
			connection.query('INSERT INTO inventory  (player_id, item_id) VALUES(' + player_id + ', ' + rows[2].id + ')', function(err, rows, fields) {
				if (err) throw err;
			});
		});
	}else if (rand == 20){
		var damage = Math.round(Math.random()*(exp*2))+40;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione trovi uno scrigno pieno di monete d'oro sul ciglio della strada, solo che dopo un attimo ti accorgi che si tratta di cioccolata, preso dalla disperazione divori il contenuto dello scrigno e perdi " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 21){
		var itemId = Math.round(Math.random()*5+68);
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.id = ' + itemId + ' AND item.craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			connection.query('INSERT INTO inventory  (player_id, item_id) VALUES(' + player_id + ', ' + rows[0].id + ')', function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione senti qualcosa toccarti un piede, abbassi lo sguardo e vedi una pietra strana, ricevi " + itemName + "!";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 22){
		var damage = Math.round(Math.random()*(exp/2))+20;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione uno stregone ti coglie di sorpresa e ti ruba " + damage + " hp, che poi andrÃ  a donare alla congrega dei maghi oscuri";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 23){
		var damage = Math.round(Math.random()*(exp/2))+120;
		connection.query('SELECT * FROM player WHERE craft_count > 20 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			var nick = rows[0].nickname.replace(new RegExp("_", "g"), " ");
			var chat_id2 = rows[0].chat_id;
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE id = ' + rows[0].id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione trovi un arco e una freccia per terra, decidi di scoccarla verso il cielo in segno vittorioso ma senza volerlo colpisci un passante di nome " + nick + ", che perde " + damage + " hp";
				bot.sendMessage(chat_id, text);
				var text2 = "Vedi una freccia in lontananza avvicinarsi a te a gran velocitÃ , ti si conficca nel braccio e purtroppo perdi " + damage + " hp!";
				bot.sendMessage(chat_id2, text2);
			});
		});			
	}else if (rand == 24){
		var money = Math.round(Math.random()*(exp))+20;
		connection.query('SELECT chat_id, nickname FROM player WHERE exp > 30 AND money >= ' + money + ' ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;

			var chat_id2 = rows[0].chat_id;

			text = "Durante la missione vedi qualcuno con la testa china sul cellulare, con la coda dell'occhio noti che sta giocando ad uno strano bot, leggi il suo nickname e scopri che si chiama " + rows[0].nickname + ", per fargli uno scherzo gli fai uno sgambetto e gli fai cliccare a caso, cosÃ¬ perde " + money + " Â§";
			var text2 = "Un passante per la strada ti fa uno sgambetto e cliccando a caso sul cellulare perdi " + money + " Â§!";
			bot.sendMessage(chat_id, text);
			bot.sendMessage(chat_id2, text2);

			connection.query('UPDATE player SET money = money - ' + money + ' WHERE nickname="' + rows[0].nickname + '"', function(err, rows, fields) {
				if (err) throw err;
			});
		});
	}else if (rand == 25){
		var money = Math.round(Math.random()*(exp))+50;
		connection.query('UPDATE player SET money = money + ' + money + ' WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});

		text = "Durante la missione trovi una leva nascosta dentro un albero cavo. Curioso la tiri, ma non succede niente. In realtÃ  la leva ha fatto cadere un sacchettino pieno di qualcosa, ottieni " + money + " Â§!";
		bot.sendMessage(chat_id, text);
	}else if (rand == 26){
		var damage = Math.round(Math.random()*(exp*2))+20;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione trovi un pulsante a forma di papera e inizi a premerlo a ripetizione. Dopo giusto alcuni secondi ti accorgi che il pulsante ti toglie hp ogni volta che lo tocchi, infatti hai perso " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 27){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 15);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione finisci nel mezzo di un uragano. Sollevato e lanciato lontano, quando ti riprendi scopri di essere tornato al luogo di partenza. Corri per recuperare il tempo perso, ma aumenti il tempo missione di 15 minuti";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 28){
		var damage = Math.round(Math.random()*(exp*2))+20;
		connection.query('UPDATE boss_team SET life = life - ' + damage + ' WHERE id = ' + boss_id, function(err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione vedi sfrecciare sopra di te una figura rossa. Ti distrai non tanto per la figura, ma per il fatto che sembra aver perso una nocciolina che precipitando ti urta la fronte attirando la tua attenzione. Un po'per vendetta un po' per fame mangi la nocciolina con tutto il guscio e scopri con sommo piacere che era una super arachide di super Pippo. Ti precipiti contro il boss che stai sfidando, che perde immediatamente " + damage + " hp con un megapugno!";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 29){
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			connection.query('UPDATE player SET life = life - (life/10) WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione incontri tutti i boss riuniti assieme. Ti fissano, tu li fissi. Loro ti colpiscono violentemente e ti lasciano a terra nel fango";
				bot.sendMessage(chat_id, text);
			});
		});			
	}else if (rand == 30){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 15);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione senti che qualcuno ti sta seguendo. Inizi a girare la zona per seminarlo, ma dopo esserti accorto che si tratta della tua ombra scopri di aver corso nella direzione giusta, risparmiandoti 15 minuti di viaggio";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 31){
		var damage = Math.round(Math.random()*(exp*3))+100;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione ti distrai giocando a Loot Bot sul cellulare e sbatti violentemente contro un muro, perdendo " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 32){
		connection.query('SELECT item_id, name FROM inventory_rarity WHERE rarity = "NC" AND player_id=' + player_id + ' ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0){
				var itemId = rows[0].item_id;
				var itemName = rows[0].name;
				connection.query('DELETE FROM inventory WHERE item_id = ' + itemId + ' AND player_id=' + player_id + ' LIMIT 1', function(err, rows, fields) {
					if (err) throw err;
					text = "Durante la missione incontri un uomo seduto sul marciapiede, decidi cosÃ¬ di derubarlo. Si scopre perÃ² che quell'uomo Ã¨ LastSoldier95. Lui ti guarda, apparentemente non succede nulla. Ma quando controlli nello zaino, noti che manca " + itemName + "!";
					bot.sendMessage(chat_id, text);
				});
			}else{
				text = "Durante la missione incontri un uomo seduto sul marciapiede, decidi cosÃ¬ di derubarlo. Si scopre perÃ² che quell'uomo Ã¨ LastSoldier95. Lui ti guarda, non succede nulla. Oggi Ã¨ magnanimo.";
				bot.sendMessage(chat_id, text);
			}
		});
	}else if (rand == 33){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 60);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			connection.query('SELECT name, id FROM chest WHERE id IN (1,2) ORDER BY RAND()', function(err, rows, fields) {
				if (err) throw err;
				var chestName = rows[0].name;
				var chestId = rows[0].id;
				connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES (' + player_id + ',' + chestId + ')', function(err, rows, fields) {
					if (err) throw err;
				});
				text = "Durante la missione decidi di intraprendere un'altra missione. Impiegherai un ora in piÃ¹ per tornare, ma ricevi " + chestName;
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 34){
		var damage = Math.round(Math.random()*(exp/5))+10;
		connection.query('SELECT nickname FROM player WHERE exp > 30 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione incontri " + rows[0].nickname + " e vi salutate. Entrambi recuperate " + damage + " hp (d'altronde Ã¨ salutare).";
			bot.sendMessage(chat_id, text);

			connection.query('UPDATE player SET life = life + ' + damage + ' WHERE nickname="' + rows[0].nickname + '"', function(err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE player SET life = life + ' + damage + ' WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
				if (err) throw err;
			});				
		});
	}else if (rand == 35){
		var damage = Math.round(Math.random()*(exp/2))+1;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0){
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione incontri Jovanotti che ti lancia un faffo. Perdi " + damage + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 36){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 60);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione cadi in un portale spazio temporale a forma di papera. Impiegherai un ora in meno per tornare.";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 37){
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity = "R" AND item.craftable = 0 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			connection.query('INSERT INTO inventory (player_id, item_id) VALUES(' + player_id + ', ' + rows[0].id + ')', function(err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione entri erroneamente nell'ufficio di fenix45. Prima di andartene perÃ², vai al suo computer personale e modifichi i dati del tuo pg aggiungendo 1000 Â§ e " + itemName;
				bot.sendMessage(chat_id, text);

				connection.query('UPDATE player SET money = money + 1000 WHERE player.id=' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
			});
		});
	}else if (rand == 38){
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 30);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET life = life + (life/20), mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione incontri tua nonna che ti invita a fare uno spuntino. Impieghi 30 minuti in piÃ¹ per tornare, ma recuperi un po' di salute.";
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 39){
		connection.query('UPDATE player SET mission_id = 0, mission_time_end = null WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});			
		text = "Durante una missione dimentichi di essere in missione e torni nel tuo rifugio senza ricompense.";
		bot.sendMessage(chat_id, text);
	}else if (rand == 40){
		connection.query('SELECT name, id FROM chest WHERE id < 5 ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			text = "Durante una missione pesti per sbaglio un sasso che in realtÃ  era una leva nascosta! Si apre una fenditura nel muro e trovi uno " + rows[0].name + "!";
			bot.sendMessage(chat_id, text);

			connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES(' + player_id + ', ' + rows[0].id + ')', function(err, rows, fields) {
				if (err) throw err;
			});				
		});
	}else if (rand == 41){
		text = "Durante una missione incontri una fata graziosissima, diventate cosÃ¬ amici che decide di ricaricarti la vita al massimo!";
		bot.sendMessage(chat_id, text);

		connection.query('UPDATE player SET life = total_life WHERE player.id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});
	}else if (rand == 42){
		connection.query('SELECT mission_time_end, money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 20);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth()+1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});

			if (rows[0].money > 250){
				text = "Durante una missione incontri un motociclista spericolato che ti dÃ  un passaggio, risparmi cosÃ¬ 20 minuti di missione, ma per ringraziarlo gli dai 250 Â§";
				connection.query('UPDATE player SET money = money-250 WHERE id=' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
			}else{
				text = "Durante una missione incontri un motociclista spericolato che ti dÃ  un passaggio, risparmi cosÃ¬ 20 minuti di missione, per stavolta lo fa gratuitamente";
			}
			bot.sendMessage(chat_id, text);			
		});
	}else if (rand == 43){
		connection.query('SELECT item.name, item.id FROM inventory, item WHERE item.id = inventory.item_id AND item.rarity = "NC" AND inventory.player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var money = 500;
			var itemName = rows[0].name;
			if (Object.keys(rows).length > 0){
				text = "Durante una missione, all'improvviso irrompe un fulmine, accecandoti. Ti accorgi in realtÃ  che il fulmine nient'altro era il boss di un villaggio vicino, che rubava ai sudditi e per non farsi riconoscere si era lanciato su se stesso un incantesimo che lo rendeva veloce come un fulmine. Quest'ultimo ti ha preso dallo zaino " + itemName + " ma al suo posto ti ha lasciato " + money + " Â§.";
				connection.query('DELETE FROM inventory WHERE item_id = ' + rows[0].id + ' AND player_id=' + player_id + ' LIMIT 1', function(err, rows, fields) {
					if (err) throw err;
				});
			}else{
				money = 300;
				text = "Durante una missione, all'improvviso irrompe un fulmine, accecandoti. Ti accorgi in realtÃ  che il fulmine nient'altro era il boss di un villaggio vicino, che rubava ai sudditi e per non farsi riconoscere si era lanciato su se stesso un incantesimo che lo rendeva veloce come un fulmine. Quest'ultimo non ti ha preso nulla dallo zaino, e ti ha lasciato " + money + " Â§.";
			}
			connection.query('UPDATE player SET money = money+' + money + ' WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 44){
		connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ', 73)', function(err, rows, fields) {
			if (err) throw err;
		});
		text = "Durante la missione incontri il grande mastro domatore di draghi Fuligah. Dopo una breve chiaccherata ti lascia in dono una Pietra Spirito Epico!";
		bot.sendMessage(chat_id, text);			
	}else if (rand == 45){
		connection.query('UPDATE player SET life = life - (life/3) WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});

		text = "Durante la missione incontri l'immenso drago di LastSoldier95 intento a consumare il suo pasto quotidiano. Dato che non vuoi diventare parte del banchetto, pian pianino torni indietro senza fare il minimo rumore e senza farti vedere. Ma quando pensi di essere scappato, il drago ti starnutisce addosso e perdi 1/3 della tua salute.";
		bot.sendMessage(chat_id, text);
	}else if (rand == 46){
		var rand = Math.random()*100;
		var text2 = "";
		if (rand > 50){
			text2 = "per la profonda disperazione ti distrai, inciampi e perdi il 2% delle monete";
			connection.query('UPDATE player SET money = money - ((money/100)*2) WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});				
		}else{
			connection.query('UPDATE player SET money = money + ((money/100)*5) WHERE id=' + player_id, function(err, rows, fields) {
				if (err) throw err;
			});	
			text2 = "tuttavia ci riprensa e si rende conto che in effetti, non fosse poi cosÃ¬ male, allora si congratula con te e ti regala il 5% delle monete in piÃ¹!"
		}

		text = "Durante la missione ti viene l'ispirazione poetica e decidi di scrivere una poesia avventurosa, ma appena finisci di scriverla non essendo un bravo scrittore dietro di te appare Lara997 e te la strappa perchÃ¨ scritta male, " + text2;
		bot.sendMessage(chat_id, text);
	}else if (rand == 47){
		connection.query('SELECT money FROM player WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			var money = rows[0].money;

			if (money < 1000){
				connection.query('SELECT item.id, item.name FROM item, inventory WHERE item.rarity = "R" AND item.id = inventory.player_id AND inventory.player_id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0){
						return;
					}
					var itemName = rows[0].name;
					var itemId = rows[0].id;
					text = "Durante la missione vedi una insegna che recita L'EMPORIO e decidi di entrare a dare un'occhiata. Il simpatico proprietario ekvas ti ubriaca di chiacchiere sull'andamento del mercato e dei prezzi. Esci con una Colla ma ti accorgi di esser stato convinto a scambiarla con " + itemName + "...";

					connection.query('DELETE FROM inventory WHERE item_id = ' + item_id + ' AND player_id=' + player_id + ' LIMIT 1', function(err, rows, fields) {
						if (err) throw err;
					});
				});
			}else{
				var lost = Math.round(money/100)*5;
				text = "Durante la missione vedi una insegna che recita L'EMPORIO e decidi di entrare a dare un'occhiata. Il simpatico proprietario ekvas ti ubriaca di chiacchiere sull'andamento del mercato e dei prezzi. Esci con una Colla ma ti accorgi di esser stato convinto a pagarla " + lost + " Â§...";

				connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',3)', function(err, rows, fields) {
					if (err) throw err;
				});

				connection.query('UPDATE player SET money = money - ' + lost + ' WHERE id=' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
			}
			bot.sendMessage(chat_id, text);
		});
	}else if (rand == 48){
		connection.query('INSERT INTO  inventory_chest (player_id, chest_id) VALUES(' + player_id + ', 6)', function(err, rows, fields) {
			if (err) throw err;
		});

		text = "Durante la missione senti scorrere la follia dentro di te, al punto che senti l'anima esplodere e mostrare tutto il suo spirito d'avventura. Intraprendi una missione alla velocitÃ  della luce e questa missione ti fornisce uno Scrigno Epico!";
		bot.sendMessage(chat_id, text);			
	}else if (rand == 49){
		connection.query('UPDATE player SET exp = exp + 15 WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});
		text = "Durante la missione incontri un folle barcollante sul ciglio della strada, avvicinandoti scopri che si tratta di un elfo delle Lande Immaginarie, una razza ormai estinta, notandolo in fin di vita gli vai a comprare alcune pozioni, e lui ricambia donandoti 15 exp con un incantesimo";
		bot.sendMessage(chat_id, text);
	}else if (rand == 50){
		connection.query('SELECT item.id, item.name FROM inventory, item WHERE inventory.item_id = item.id AND item.rarity = "L" AND inventory.player_id = ' + player_id + ' ORDER BY RAND()', function(err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0){
				text = "Durante la missione ti rechi all'Emporio della Follia, deciso ad acquistare qualche strano intruglio ma stavolta arrivi troppo tardi, Ã¨ chiuso.";
				bot.sendMessage(chat_id, text);
				return;
			}
			var item1 = rows[0].name;
			var item1_id = rows[0].id;
			connection.query('SELECT item.id, item.name FROM item WHERE item.rarity = "L" ORDER BY RAND()', function(err, rows, fields) {
				if (err) throw err;
				var item2 = rows[0].name;
				var item2_id = rows[0].id;

				connection.query('UPDATE inventory SET item_id = ' + item2_id + ' WHERE item_id = ' + item1_id + ' AND player_id = ' + player_id + ' LIMIT 1', function(err, rows, fields) {
					if (err) throw err;
				});

				text = "Durante la missione ti rechi all'Emporio della Follia, incuriosito dai prodotti acquisti la Polvere Inverter, da applicare su un oggetto nello zaino ne cambia l'aspetto. Incuriosito procedi subito seguendo le istruzioni e il tuo oggetto " + item1 + " si trasforma in un " + item2 + "!";
				bot.sendMessage(chat_id, text);
			});
		});
	}else if (rand == 51){
		connection.query('UPDATE player SET token = token + 2 WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});
		text = "Durante la missione un ragazzino ti regala un ampolla con su scritto 'Bevanda della Follia', decidi di berla per curiositÃ , improvvisamente svieni. Al tuo risveglio trovi BEN 2 Gettoni del Destino appoggiati a terra!";
		bot.sendMessage(chat_id, text);
	}

	connection.query('UPDATE player SET event = 1 WHERE player.id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
	});
};

function refreshHeists(){
	connection.query('UPDATE `player` SET `heist_count` = 0, heist_limit = 0, capsule_limit = 0, spy_count = 0', function(err, rows, fields) {
		if (err) throw err;
		console.log(getNow("it") + " Ispezioni aggiornate");
	});
};

function checkRefill(){
	connection.query('SELECT player.id, player.total_life, chat_id, ability.ability_level FROM player, ability WHERE ability.player_id = player.id AND ability.ability_id = 6 AND ability.ability_level > 0 AND player.life <= 0 AND player.refilled = 0', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + " 1 player resuscitato");
			}else{
				console.log(getNow("it") + " " + Object.keys(rows).length + " player resuscitati");
			}
			rows.forEach(setRefill);
		}
	});
};

function setRefill(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;
	var tot = element.total_life;
	var lev = element.ability_level*3;

	var refill = Math.round(tot/100*lev);
	var rand = Math.random()*100;
	var prob = lev*10;

	if (prob > 50){
		prob = 50;
	}

	console.log(prob, rand, refill);

	if (player_id == 1){
		prob = 100;
	}

	if (rand < prob){
		connection.query('UPDATE player SET refilled = 1, life = ' + refill + ' WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "L'Intervento Divino ti ha concesso di tornare in battaglia con " + refill + " hp!");
		});
	}else{
		connection.query('UPDATE player SET refilled = 1 WHERE id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});		
	}
};

function checkAct(){
	connection.query('SELECT P.nickname, P.id As player_id, P.chat_id, CAST(L.time As date) As last_action, CURDATE(), DATEDIFF(CURDATE(), CAST(L.time As date)) As last_access FROM player P INNER JOIN last_command L ON P.account_id = L.account_id WHERE P.holiday != 1 HAVING last_access > 60 LIMIT 20', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 giocatore espulso\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " giocatori espulsi\x1b[0m");
			}
			rows.forEach(setFinishedAct);
		}
	});
};

function setFinishedAct(element, index, array) {
	var player_id = element.player_id;
	var nickname = element.nickname;
	var chat_id = element.chat_id;
	var last_access = element.last_access;

	console.log(">> " + player_id + " - " + nickname + " inattivo da " + last_access + " giorni");

	var now = new Date();
	now.setDate(now.getDate()+14);
	var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

	var now2 = new Date();
	now2.setDate(now2.getDate()+365);
	var long_date2 = now2.getFullYear() + "-" + addZero(now2.getMonth()+1) + "-" + addZero(now2.getDate()) + " " + addZero(now2.getHours()) + ':' + addZero(now2.getMinutes()) + ':' + addZero(now2.getSeconds());

	connection.query('INSERT INTO holiday (player_id, time_end) VALUES (' + player_id + ',"' + long_date + '")', function(err, rows, fields) {
		if (err) throw err;
		connection.query('UPDATE player SET holiday = 1, heist_protection = "' + long_date2 + '" WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Per inattivitÃ  Ã¨ stata attivata automaticamente la modalitÃ  vacanza!");
		});
	});
}

function checkTeamAct(){
	connection.query('SELECT P.nickname, P.chat_id, T.team_id, T.player_id, CAST(L.time As date) As last_action, CURDATE(), DATEDIFF(CURDATE(), CAST(L.time As date)) As last_access FROM player P INNER JOIN team_player T ON P.id = T.player_id INNER JOIN last_command L ON P.account_id = L.account_id WHERE P.holiday != 1 HAVING last_access > 14 LIMIT 20', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 giocatore espulso\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " giocatori espulsi\x1b[0m");
			}
			rows.forEach(setFinishedTeamAct);
		}
	});
};

function setFinishedTeamAct(element, index, array) {
	var player_id = element.player_id;
	var nickname = element.nickname;
	var chat_id = element.chat_id;

	console.log(">> " + player_id + " - " + nickname + " in espulsione");

	connection.query('DELETE FROM team_player WHERE player_id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "Sei stato espulso dal team per inattivitÃ ");
	});
};

function checkHeists(){
	connection.query('SELECT heist.id FROM `player`, heist WHERE player.id = heist.from_id AND heist.datetime < NOW() AND heist.datetime IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 ispezione terminata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " ispezioni terminate\x1b[0m");
			}
			rows.forEach(setFinishedHeist);
		}
	});
};

function checkHeistsProgress(){
	connection.query('SELECT player.id, chat_id, word, extracted FROM player, heist_progress WHERE player.id = heist_progress.from_id AND heist_progress.wait_time < NOW() AND heist_progress.wait_time IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 ispezione progressiva terminata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " ispezioni progressive terminate\x1b[0m");
			}
			rows.forEach(setFinishedHeistProgress);
		}
	});
};

function checkChestEvent(){
	connection.query('SELECT event_chest_list.id, event_chest_list.player_id, player.chat_id FROM `event_chest_list`, player WHERE event_chest_list.player_id = player.id AND time_end < NOW() AND time_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 evento cassa terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " eventi cassa terminati\x1b[0m");
			}
			rows.forEach(setFinishedChestEvent);
		}
	});
};

function checkDust(){
	connection.query('SELECT player.nickname, event_dust_status.qnt, event_dust_status.generated, player.chat_id, event_dust_status.max_qnt, event_dust_status.id FROM event_dust_status, player WHERE player.id = event_dust_status.player_id AND extracting = 1 AND last_update < DATE_SUB(NOW(), INTERVAL 1 HOUR) AND notified = 0', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			rows.forEach(setDust);			
		}
	});
};

function setDust(element, index, array){
	var id = element.id;
	var nick = element.nickname;
	var chat_id = element.chat_id;
	var max_qnt = element.max_qnt;
	var qnt = element.qnt;
	var generated = element.generated;

	//console.log("Polvere: " + nick + " - " + generated);

	if (generated+1 >= max_qnt){
		bot.sendMessage(chat_id, "Il generatore Ã¨ pieno! Svuotalo per produrre altra polvere!");
		connection.query('UPDATE event_dust_status SET notified = 1 WHERE id = ' + id, function(err, rows, fields) {
			if (err) throw err;
		});
	}
	if (generated < max_qnt){
		var d = new Date();
		var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
		connection.query('UPDATE event_dust_status SET generated = generated+' + qnt + ', last_update = "' + long_date + '" WHERE id = ' + id, function(err, rows, fields) {
			if (err) throw err;
		});
	}
};

function checkMissions(){
	connection.query('SELECT nickname, id, mission_id, chat_id FROM `player` WHERE mission_time_end < NOW() AND mission_time_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0){
			if (firstStart == 0){
				console.log("\x1b[31mxxx Online: " + getNow("it") + "\x1b[0m");
				firstStart = 1;
			}
		}else{
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 missione terminata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " missioni terminate\x1b[0m");
			}
			rows.forEach(setFinishedMission);
		}
	});
};

function checkSpecialMissions(){
	connection.query('SELECT nickname, id, mission_special_id, chat_id FROM `player` WHERE mission_special_time_end < NOW() AND mission_special_time_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 itinerario terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " itinerari terminati\x1b[0m");
			}
			rows.forEach(setFinishedSpecialMission);
		}
	});
};

function checkEnchant(){
	connection.query('SELECT id, chat_id FROM `player` WHERE weapon_enchant_end < NOW() AND weapon_enchant_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 incantamento arma terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " incantamento terminato\x1b[0m");
			}
			rows.forEach(setFinishedEnchant1);
		}
	});
};

function checkEnchant2(){
	connection.query('SELECT id, chat_id FROM `player` WHERE weapon2_enchant_end < NOW() AND weapon2_enchant_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 incantamento armatura terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " incantamento terminato\x1b[0m");
			}
			rows.forEach(setFinishedEnchant2);
		}
	});
};

function checkEnchant3(){
	connection.query('SELECT id, chat_id FROM `player` WHERE weapon3_enchant_end < NOW() AND weapon3_enchant_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 incantamento scudo terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " incantamento terminato\x1b[0m");
			}
			rows.forEach(setFinishedEnchant3);
		}
	});
};

function setFinishedEnchant1(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET weapon_enchant_end = NULL, weapon_enchant = 0, weapon_enchant_bonus = 0 WHERE id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "L'incantamento dell'arma Ã¨ terminato");
	});
};

function setFinishedEnchant2(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET weapon2_enchant_end = NULL, weapon2_enchant = 0, weapon2_enchant_bonus = 0 WHERE id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "L'incantamento dell'armatura Ã¨ terminato");
	});
};

function setFinishedEnchant3(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET weapon3_enchant_end = NULL, weapon3_enchant = 0, weapon3_enchant_bonus = 0 WHERE id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "L'incantamento dello scudo Ã¨ terminato");
	});
};

function checkDragonArena(){
	connection.query('SELECT player_id, chat_id FROM player, event_arena_status WHERE event_arena_status.player_id = player.id AND fight_time < NOW() AND fight_time IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 scontro drago terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " draghi terminati\x1b[0m");
			}
			rows.forEach(setFinishedArena);
		}
	});
};

function reloadFestival(){
	connection.query('SELECT MAX(id) As maxid FROM event_crafting_item', function(err, rows, fields) {
		if (err) throw err;

		connection.query('SELECT id FROM event_crafting_item WHERE time < NOW() AND time IS NOT NULL AND id = ' + rows[0].maxid, function(err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				return;
			}

			connection.query('SELECT rarity, name, id FROM item WHERE craftable = 1 AND rarity IN ("NC","R","UR","L") ORDER BY RAND()', function(err, rows, fields) {
				if (err) throw err;

				var d = new Date();
				d.setHours(d.getHours() + 2);
				var time_end = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

				var value = 0;
				if (rows[0].rarity == "NC"){
					value = 1500;
				}else if (rows[0].rarity == "R"){
					value = 2000;
				}else if (rows[0].rarity == "UR"){
					value = 3000;
				}else if (rows[0].rarity == "L"){
					value = 5000;
				}else if (rows[0].rarity == "E"){
					value = 10000;
				}

				connection.query('INSERT INTO event_crafting_item (item_id, time, price) VALUES (' + rows[0].id + ',"' + time_end + '",' + value + ')', function(err, rows, fields) {
					if (err) throw err;
					console.log(getNow("it") + "\x1b[32m Festival aggiornato\x1b[0m");
				});
			});
		});
	});
};

function checkDungeonNotification(){
	connection.query('SELECT player_id, id FROM dungeon_status WHERE TIMESTAMPDIFF(MINUTE, NOW(), finish_time) < 60 AND finish_time IS NOT NULL AND notified = 0', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 dungeon notificato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " dungeon notificati\x1b[0m");
			}
			rows.forEach(setFinishedDungeonNotification);
		}
	});
};

function checkDungeonNotificationIstance(){
	connection.query('SELECT id FROM dungeon_list WHERE TIMESTAMPDIFF(MINUTE, NOW(), finish_date) < 180 AND finish_date IS NOT NULL AND notified = 0', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 istanza dungeon notificata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " istanze dungeon notificate\x1b[0m");
			}
			rows.forEach(setFinishedDungeonNotificationIstance);
		}
	});
};

function setFinishedDungeonNotification(element, index, array) {
	var player_id = element.player_id;
	var id = element.id;

	connection.query('SELECT chat_id FROM player WHERE id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		var chat_id = rows[0].chat_id;
		connection.query('UPDATE dungeon_status SET notified = 1 WHERE id = ' + id, function(err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Ti rimane solamente 1 ora per terminare il dungeon! Forza!");
		});
	});
};

function setFinishedDungeonNotificationIstance(element, index, array) {
	var dungeon_id = element.id;

	connection.query('UPDATE dungeon_list SET notified = 1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
		if (err) throw err;
	});

	connection.query('SELECT player_id FROM dungeon_status WHERE dungeon_id = ' + dungeon_id, function(err, rows, fields) {
		if (err) throw err;
		for (i = 0; i < Object.keys(rows).length; i++){
			connection.query('SELECT chat_id FROM player WHERE id = ' + rows[i].player_id, function(err, rows, fields) {
				if (err) throw err;
				var chat_id = rows[0].chat_id;
				bot.sendMessage(chat_id, "Ti rimangono solamente 3 ore prima del crollo dell'istanza! Forza!");
			});
		};
	});
};

function checkDungeonRoom(){
	connection.query('SELECT dungeon_status.id As room_id, player.id As player_id, player.chat_id As chat_id FROM dungeon_status, player WHERE dungeon_status.player_id = player.id AND room_time < NOW() AND room_time IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 stanza terminata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " stanze terminate\x1b[0m");
			}
			rows.forEach(setFinishedDungeonRoom);
		}
	});
};

function checkGnome(){
	connection.query('SELECT heist_progress.id As progressId, player.id As player_id, player.chat_id As chat_id FROM heist_progress, player WHERE heist_progress.from_id = player.id AND time_end < NOW() AND time_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 gnomo scaduto\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " gnomi scaduti\x1b[0m");
			}
			rows.forEach(setFinishedGnome);
		}
	});
};

function setFinishedGnome(element, index, array){
	var chat_id = element.chat_id;

	connection.query('DELETE FROM heist_progress WHERE id = ' + element.progressId, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(element.chat_id, "Il tuo gnomo Ã¨ stato troppo tempo fuori! E' tornato al tuo rifugio senza aver indovinato la parola.");
	});
};

function checkDungeonEnd(){
	connection.query('SELECT id, chat_id FROM player WHERE dungeon_time < NOW() AND dungeon_time IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 dungeon terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " dungeon terminati\x1b[0m");
			}
			rows.forEach(setFinishedDungeonEnd);
		}
	});
};

function checkDungeonExpire(){
	connection.query('SELECT dungeon_status.id As dungeon_id, player.id As player_id, player.chat_id FROM dungeon_status, player WHERE dungeon_status.player_id = player.id AND dungeon_status.finish_time < NOW() AND dungeon_status.finish_time IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 giocatore istanza dungeon scaduto\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " giocatori in istanze dungeon scaduti\x1b[0m");
			}
			rows.forEach(setFinishedDungeonExpire);
		}
	});
};

function checkIstanceExpire(){
	/*
	connection.query('SELECT dungeon_list.id As dungeon_id, player.id As player_id, player.chat_id FROM dungeon_status, player, dungeon_list ' +
			'WHERE dungeon_status.dungeon_id = dungeon_list.id AND dungeon_status.player_id = player.id AND dungeon_list.finish_date < NOW() ' +
			'AND dungeon_list.finish_date IS NOT NULL AND dungeon_list.main <> 1 LIMIT 100', function(err, rows, fields) {
	*/
	connection.query('SELECT dungeon_list.id As dungeon_id FROM dungeon_list WHERE dungeon_list.finish_date < NOW() AND dungeon_list.finish_date IS NOT NULL AND dungeon_list.main = 0 LIMIT 100', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 istanza dungeon scaduta\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " istanze dungeon scadute\x1b[0m");
			}
			rows.forEach(setFinishedIstanceExpire);
		}
	});
};

function setFinishedIstanceExpire(element, index, array){
	var dungeon_id = element.dungeon_id;

	console.log("Cancellazione istanza ID " + dungeon_id);

	connection.query('SELECT player.id As player_id, player.chat_id FROM dungeon_status, player, dungeon_list ' +
					 'WHERE dungeon_status.dungeon_id = dungeon_list.id AND dungeon_status.player_id = player.id AND dungeon_list.id = ' + dungeon_id, function(err, rows, fields) {
		if (Object.keys(rows).length > 0){
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				console.log("Notifica crollo istanza ID " + dungeon_id + " del player id " + rows[i].player_id);
				bot.sendMessage(rows[i].chat_id, "L'intera istanza Ã¨ scaduta, sei costretto ad uscire dal dungeon!");
			}
		}
		connection.query('DELETE FROM dungeon_list WHERE id = ' + dungeon_id, function(err, rows, fields) {
			if (err) throw err;
		});
		connection.query('DELETE FROM dungeon_status WHERE dungeon_id = ' + dungeon_id, function(err, rows, fields) {
			if (err) throw err;
		});
	});

};

function setFinishedDungeonExpire(element, index, array){
	var player_id = element.player_id;
	var dungeon_id = element.dungeon_id;
	var chat_id = element.chat_id;

	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function(err, rows, fields) {
		if (err) throw err;
	});

	connection.query('DELETE FROM dungeon_status WHERE id = ' + dungeon_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "Hai impiegato troppo tempo per completare il dungeon, i muri cominciano a crollare e sei costretto a scappare!");
	});	
};

function setFinishedDungeonEnd(element, index, array){
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET dungeon_time = NULL WHERE id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(element.chat_id, "I dungeon sono di nuovo disponibili!");
	});	
};

function setFinishedDungeonRoom(element, index, array){
	var player_id = element.player_id;
	var chat_id = element.chat_id;

	connection.query('UPDATE dungeon_status SET room_time = NULL WHERE id = ' + element.room_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(element.chat_id, "Sei tornato in forze per proseguire il dungeon!");
	});
};

function setFinishedChestEvent(element, index, array){
	var player_id = element.player_id;
	connection.query('SELECT item_id FROM `event_chest_content` WHERE player_id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + player_id + ',' + rows[i].item_id + ')', function(err, rows, fields) {
				if (err) throw err;
			});
		}
		connection.query('DELETE FROM event_chest_content WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});
		connection.query('DELETE FROM event_chest_list WHERE player_id = ' + player_id, function(err, rows, fields) {
			if (err) throw err;
		});

		bot.sendMessage(element.chat_id, "L'offerta nella vetrina evento Ã¨ terminata, tutti gli oggetti sono tornati nell'inventario.");
	});
};

function checkEventMissions(){
	connection.query('SELECT player.nickname, player.id As player_id, player.chat_id, mission_event_status.mission_id FROM `player`, mission_event_status WHERE mission_event_status.player_id = player.id AND mission_end < NOW() AND mission_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 missione evento terminata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " missioni evento terminate\x1b[0m");
			}
			rows.forEach(setFinishedEventMission);
		}
	});
};

function teamBoss(team_id, drop, message){
	connection.query('SELECT team_player.notification, player.id, player.nickname, player.chat_id, (SELECT COUNT(nickname) FROM `player`, team_player WHERE player.id = team_player.player_id AND team_player.team_id = ' + team_id + ') As num FROM `player`, team_player WHERE team_player.suspended = 0 AND player.id = team_player.player_id AND team_player.team_id = ' + team_id, function(err, rows, fields) {
		if (err) throw err;
		rows.forEach(function (element, index, arr) {
			setTeamBoss(element, index, arr, drop, message.from.username, message, team_id);
		});
	});
};

function setTeamBoss(element, index, array, drop, killerName, message, team_id) {
	var chat_id = element.chat_id;
	var notify = element.notification;

	//console.log("BOSSKILL: " + element.nickname + " " + element.id + " " + team_id);

	connection.query('SELECT boss_team.boss_id FROM boss_team, player WHERE boss_team.id = player.boss_id AND player.id = ' + element.id, function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			if (rows[0].boss_id == 20){
				connection.query('UPDATE boss_team SET total_life = total_life + 500 WHERE boss_id <= 20 AND team_id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
				});

				connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + element.id + ',7)', function(err, rows, fields) {
					if (err) throw err;
					if (notify == 1){
						bot.sendMessage(chat_id, "Partecipando all'uccisione del Titano hai ottenuto uno *Scrigno Capsula*, ma la salute di tutti i boss precedenti Ã¨ aumentata! Inoltre il tempo massimo Ã¨ stato esteso per consentirti di continuare la scalata.", back);
					}
				});
				connection.query('SELECT boss_respawn FROM team WHERE id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					if (rows[0].boss_respawn != null){
						var now = new Date(rows[0].boss_respawn);
						now.setHours(now.getHours() + 1);
						var long_date = now.getFullYear() + "-" + addZero(now.getMonth()+1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
						var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());							

						connection.query('UPDATE team SET boss_respawn = "' + long_date + '" WHERE id = ' + team_id, function(err, rows, fields) {
							if (err) throw err;
						});
					}
				});
			}
			if (rows[0].boss_id == 31){
				connection.query('UPDATE boss_team SET total_life = total_life + 10000 WHERE boss_id > 20 AND team_id = ' + team_id, function(err, rows, fields) {
					if (err) throw err;
					if (notify == 1){
						bot.sendMessage(chat_id, "Partecipando all'uccisione di Phoenix hai ottenuto una gran quantitÃ  di Mana e alcune Gemme, ma la salute degli ultimi boss Ã¨ aumentata!", back);
					}
					connection.query('UPDATE event_mana_status SET mana_1 = mana_1 + 2500, mana_2 = mana_2 + 2500, mana_3 = mana_3 + 2500 WHERE player_id = ' + element.id, function(err, rows, fields) {
						if (err) throw err;
					});
					connection.query('UPDATE player SET gems = gems+10 WHERE id = ' + element.id, function(err, rows, fields) {
						if (err) throw err;
					});
					connection.query('UPDATE team_player SET kill_streak = kill_streak+1 WHERE player_id = ' + element.id, function(err, rows, fields) {
						if (err) throw err;
					});
				});				
			}
		}

		connection.query('UPDATE `player` SET exp=exp+1, `money` = money+' + drop + ', boss_id = 0 WHERE id = ' + element.id, function(err, rows, fields) {
			if (err) throw err;
			if (notify == 1){
				if (element.nickname != killerName){
					bot.sendMessage(chat_id, killerName + " del tuo team ha ucciso un boss e hai guadagnato <b>" + drop + "</b> Â§!", html);
				}
			}
		});
	});
};

function finishedBoss(message, boss_id){
	//	connection.query('UPDATE `player` SET boss_id=0 WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
	//		if (err) throw err;
	//	});

	var team_id = 0;

	connection.query('SELECT team_id, COUNT(id) As num FROM `team_player` WHERE suspended = 0 AND player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '") ORDER BY `team_id` ASC', function(err, rows, fields) {
		if (err) throw err;
		if (rows[0].num == 0){
			console.log("No team error.");
		}
		team_id = rows[0].team_id;

		connection.query('SELECT life FROM boss_team WHERE id = ' + boss_id, function(err, rows, fields) {
			if (err) throw err;
			if (rows[0].life <= 0){
				var sql = 'SELECT team_player.notification, (SELECT COUNT(*) FROM boss_damage WHERE boss_id = ' + boss_id + ' AND team_id = ' + team_id + ') As num, ' +
					'player.nickname, player.id, player.chat_id , SUM(boss_damage.damage) As damage FROM `boss_damage`, player, team_player ' +
					'WHERE team_player.player_id = player.id AND player.id = boss_damage.player_id AND boss_damage.boss_id = ' + boss_id + ' ' +
					'AND boss_damage.team_id = ' + team_id + ' GROUP BY player.nickname ORDER BY damage DESC';

				connection.query(sql, function(err, rows, fields) {
					if (err) throw err;
					if (rows[0].num > 0){
						rows.forEach(setFinishedBoss);
					}else{
						console.log("Errore boss");
					}
				});
			}else{
				console.log("Errore boss");
			}
		});
	});
};

function setFinishedBoss(element, index, array){

	var damage = element.damage;
	var player_id = element.id;
	var chat_id = element.chat_id;
	var notify = element.notification;

	connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = 12', function(err, rows, fields) {
		if (err) throw err;

		var abBonus = 0;
		if (Object.keys(rows).length > 0){
			abBonus = rows[0].ability_level*2;
		}

		var money = damage/2;
		money = Math.round(money+(money*abBonus/100));

		connection.query('UPDATE `player` SET exp=exp+2, `money`=money+' + money + ' WHERE id=' + player_id, function(err, rows, fields) {
			if (err) throw err;
			if (notify == 1){
				bot.sendMessage(chat_id, "Il boss Ã¨ stato ucciso! Grazie al tuo contributo hai guadagnato *" + money + "* Â§!", mark);
			}
			//	connection.query('DELETE FROM boss_damage WHERE player_id = ' + player_id, function(err, rows, fields) {
			//		if (err) throw err;
			//	});
		});
	});
};

function checkTravels(){
	connection.query('SELECT nickname, id, travel_id, chat_id FROM `player` WHERE travel_time_end < NOW() AND travel_time_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 viaggio terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " viaggi terminati\x1b[0m");
			}
			rows.forEach(setFinishedTravel);
		}
	});
};

function resetDungeonSkip(){
	connection.query('UPDATE player SET dungeon_skip = 0 WHERE dungeon_skip != 0', function(err, rows, fields) {
		if (err) throw err;
	});
};

function resetRefill(){
	connection.query('UPDATE player SET refill = 0 WHERE refill != 0', function(err, rows, fields) {
		if (err) throw err;
	});	
};

function checkCave(){
	connection.query('SELECT nickname, reborn, boost_id, charm_id, id, cave_id, chat_id, boost_mission FROM `player` WHERE cave_time_end < NOW() AND cave_time_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 viaggio cava terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " viaggi cava terminati\x1b[0m");
			}
			rows.forEach(setFinishedCave);
		}
	});
};

function checkRebornChest(){
	connection.query('SELECT chat_id, parent_id As parent_id, reborn_chest_status.rarity_id FROM player, reborn_chest, reborn_chest_status WHERE reborn_chest.parent_id = reborn_chest_status.id AND player.id = reborn_chest_status.player_id AND time_end < NOW() AND time_end IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 cassa rinascita terminata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " casse rinascita terminate\x1b[0m");
			}
			rows.forEach(setFinishedRebornChest);
		}		
	});
};

function setFinishedRebornChest(element, index, array) {
	var chat_id = element.chat_id;
	var rarity_id = element.rarity_id;
	var parent_id = element.parent_id;

	connection.query('SELECT shortname FROM rarity WHERE id = ' + rarity_id, function(err, rows, fields) {
		if (err) throw err;

		var rarity = rows[0].shortname;

		connection.query('DELETE FROM reborn_chest_status WHERE id = ' + parent_id, function(err, rows, fields) {
			if (err) throw err;
			connection.query('DELETE FROM reborn_chest WHERE parent_id = ' + parent_id, function(err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(chat_id, "La cassa rinascita " + rarity + " Ã¨ scaduta!");
			});
		});
	});
}

function checkProtection(){
	connection.query('SELECT nickname, id, chat_id FROM `player` WHERE heist_protection < NOW() AND heist_protection IS NOT NULL', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 protezione terminata\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " protezioni terminate\x1b[0m");
			}
			rows.forEach(setFinishedProtection);
		}
	});
};

function setFinishedProtection(element, index, array) {
	var chat_id = element.chat_id;
	connection.query('UPDATE `player` SET `heist_protection`=NULL WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
		if (err) throw err;
		//console.log(getNow("it") + " Protezione terminata per " + element.nickname);
		bot.sendMessage(chat_id, "L'effetto del Campo di Forza Ã¨ terminato!");
	});
}

function checkBoost(){
	connection.query('SELECT nickname, id, boost_id, chat_id FROM `player` WHERE boost_mission = 0 AND boost_id != 0', function(err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0){
			if (Object.keys(rows).length == 1){
				console.log(getNow("it") + "\x1b[32m 1 boost terminato\x1b[0m");
			}else{
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " boost terminati\x1b[0m");
			}
			rows.forEach(setFinishedBoost);
		}
	});
};

function toTime(seconds){
	var numdays = Math.floor((seconds % 31536000) / 86400);
	var numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);
	var numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);

	if (numdays > 0){
		if (numdays == 1){
			return numdays + " giorno, " + numhours + " ore e " + numminutes + " min";
		}else{
			return numdays + " giorni, " + numhours + " ore e " + numminutes + " min";
		}
	}else{
		if (numhours > 1){
			return numhours + " ore e " + numminutes + " min";
		}else if (numhours == 1){
			return numhours + " ora e " + numminutes + " min";
		}else if (numhours < 1){
			return numminutes + " min";
		}
	}
}

function setFinishedEventMission(element, index, array) {
	var chat_id = element.chat_id;

	//console.log("Event: " + element.player_id + " - " + element.mission_id);

	connection.query('SELECT choice FROM mission_event_text WHERE id = ' + element.mission_id, function(err, rows, fields) {
		if (err) throw err;
		var choice = rows[0].choice;
		connection.query('UPDATE mission_event_status SET mission_end = NULL, mission_id = 0, choice_id = ' + rows[0].choice + ' WHERE player_id = ' + element.player_id, function(err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Hai completato la missione evento!\nProsegui la storia attraverso il pulsante nel menÃ¹.");
		});
	});
}


function setFinishedMission(element, index, array) {
	var chat_id = element.chat_id;

	connection.query('SELECT charm_id, class, mission_auto_id, boost_id, boost_mission, reborn FROM player WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
		if (err) throw err;
		var charm_id = parseInt(rows[0].charm_id);
		var auto_id = parseInt(rows[0].mission_auto_id);
		var boost_id = parseInt(rows[0].boost_id);
		var boost_mission = parseInt(rows[0].boost_mission);
		var reborn = parseInt(rows[0].reborn);
		var class_id = parseInt(rows[0].class);

		if ((boost_mission <= 0) && (boost_id != 0)){
			connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE nickname = "' + element.nickname + '"', function(err, rows, fields) {
				if (err) throw err;
			});
			boost_mission = 0;
			boost_id = 0;
		}

		connection.query('UPDATE `player` SET `mission_id`=0,`mission_time_end`=NULL WHERE nickname="' + element.nickname + '" AND mission_id != 0', function(err, rows, fields) {
			if (err) throw err;

			if (element.mission_id == 1001){
				connection.query('INSERT INTO `inventory`(`player_id`, `item_id`) VALUES (' + element.id + ',15)', function(err, rows, fields) {
					if (err) throw err;
				});
				bot.sendMessage(chat_id, "Missione completata!\nHai trovato un misterioso *Tavolino*", mark);
				return;
			}

			connection.query('SELECT chest_id FROM mission WHERE id="' + element.mission_id + '"', function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					console.log(">> ERRORE MISSIONE: " + element.mission_id + " DI " + element.nickname);
				}

				var mission_chest = rows[0].chest_id;
				var rand = 0;
				var evolved = 0;
				var evolved_text = "";

				rand = Math.round((Math.random()*100)+1);
				var bonus = 0;
				if (charm_id == 61){
					bonus = 5;
				}else if(charm_id == 185){
					bonus = 10;
				}else if(charm_id == 189){
					bonus = 15;
				}

				if ((class_id == 3) && (reborn >= 4)){
					bonus += 5;
				}
				if ((class_id == 3) && (reborn == 3)){
					bonus += 2.5;
				}
				if ((class_id == 7) && (reborn == 3)){
					bonus += 10;
				}
				if ((class_id == 7) && (reborn >= 4)){
					bonus += 15;
				}

				if (luckyMode == 1){
					bonus += 50;
				}

				if (boost_id == 5){
					bonus = bonus*2;
				}

				if (mission_chest < 6){
					if (rand <= bonus){
						mission_chest++;
						evolved = 1;
					}
				}

				//console.log(getNow("it") + " Scrigno: " + mission_chest + " - Rand: " + rand);

				rand = Math.random()*100;

				connection.query('SELECT ability_level FROM ability WHERE player_id = ' + element.id + ' AND ability_id = 11', function(err, rows, fields) {
					if (err) throw err;

					var abBonus = 0;
					var rand_c = 15;

					if (Object.keys(rows).length > 0){
						abBonus = rows[0].ability_level;
					}
					rand_c += abBonus;

					var d = new Date();
					if (d.getDay() == 2){
						rand_c += 10;
					}

					if ((rand >= 5) && (rand <= rand_c) && (boost_id == 0)){
						var rand2 = Math.round(Math.random()*4);
						if (rand2 == 0){
							connection.query('UPDATE `player` SET `boost_id`=1,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Energetica! Per 3 missioni il tempo di esecuzione missioni Ã¨ dimezzato.");
							});
						}else if (rand2 == 1){
							connection.query('UPDATE `player` SET `boost_id`=2,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Duplicante! Per 3 missioni gli scrigni ottenuti a fine missione sono raddoppiati.");
							});
						}else if (rand2 == 2){
							connection.query('UPDATE `player` SET `boost_id`=4,`boost_mission`= 2 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Livellante! Per 2 missioni i punti esperienza ottenuti a fine missione sono raddoppiati.");
							});
						}else if (rand2 == 3){
							connection.query('UPDATE `player` SET `boost_id`=5,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Quadrifoglio! Per 3 missioni la fortuna Ã¨ raddoppiata.");
							});
						}else if (rand2 == 4){
							connection.query('UPDATE `player` SET `boost_id`=6,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Furia! Per 3 attacchi il tuo danno Ã¨ raddoppiato.");
							});
						}
						setAchievement(chat_id, element.id, 37, 1);
					}

					if (rand <= 2){
						connection.query('UPDATE `player` SET `token`=token+1 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(chat_id, "Hai trovato un Gettone del Destino!");
							setAchievement(chat_id, element.id, 37, 1);
						});
					}

					if ((rand > 2) && (rand < 4)){
						connection.query('SELECT id FROM inventory_chest WHERE player_id = ' + element.id + ' AND chest_id = 8', function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + element.id + ',8)', function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato uno Scrigno Mistico! Che fortuna!");
								});
							}
						});
					}

					if ((rand > 99) && (reborn >= 2)){
						connection.query('UPDATE `player` SET `gems`=gems+1 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(chat_id, "Hai trovato una Gemma ðŸ’Ž!");
							setAchievement(chat_id, element.id, 37, 1);
						});					
					}

					if (auto_id == (max_mission_id+1)){
						auto_id = 1;
					}

					connection.query('SELECT ability_level FROM ability WHERE player_id = ' + element.id + ' AND ability_id = 2', function(err, rows, fields) {
						if (err) throw err;

						var abBonus = 0;
						if (Object.keys(rows).length > 0){
							abBonus = parseInt(rows[0].ability_level)*100;
						}

						connection.query('SELECT rarity.shortname As rarity FROM mission_auto, mission, rarity WHERE mission.chest_id = rarity.id AND mission.chest_id = mission_auto.chest_id AND mission_auto.id = ' + auto_id + ' LIMIT 1', function(err, rows, fields) {
							if (err) throw err;
							var rarity_miss = "";

							if (Object.keys(rows).length > 0){
								rarity_miss = "\nLa prossima sarÃ  di raritÃ  " + rows[0].rarity;
							}

							connection.query('SELECT name, rarity_shortname, id FROM chest WHERE id = ' + mission_chest, function(err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0){
									bot.sendMessage(chat_id, "Si Ã¨ verificato un problema, contatta l'amministratore @fenix45.");
									return;
								}
								var chest_id = rows[0].id;
								var money = Math.round(((Math.random()*100)+100)*mission_chest);

								if (luckyMode == 1){
									var rand = Math.random()*100;
									if (rand < 50){
										money = money*2;
									}else{
										money = Math.round(money/2);
									}
								}

								if (boost_id == 7){
									money = money*2;
								}

								money += abBonus;

								var exp = 0;
								exp = mission_chest;

								if (evolved == 1){
									evolved_text = ", evoluto grazie alla fortuna";
								}

								var crazyText = "";
								var num = 1;

								if (boost_id == 2){
									num++;
									crazyText = num + "x ";

									connection.query('INSERT INTO `inventory_chest`(`player_id`, `chest_id`) VALUES (' + element.id + ',' + chest_id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
								}
								if (boost_id == 4){
									exp = exp*2;
								}
								if (crazyMode == 1){
									num++;
									crazyText = num + "x ";

									connection.query('INSERT INTO `inventory_chest`(`player_id`, `chest_id`) VALUES (' + element.id + ',' + chest_id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
								}

								if (crazyMode == 1){
									var rand = Math.random()*100;
									if ((chest_id >= 5) && (rand < 3)){
										connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + element.id + ',200)', function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(chat_id, "Sei stato veramente molto fortunato ed hai ottenuto un Necronucleo! Woah!");
										});
									}

									if ((chest_id == 6) && (rand > 90)){
										connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + element.id + ',7)', function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(chat_id, "FOLLE! Hai trovato uno *Scrigno Capsula*!", mark);
										});
										return;
									}
								}

								bot.sendMessage(chat_id, "Missione completata! Hai ottenuto:\n" + crazyText + "*" + rows[0].name + "* (" + rows[0].rarity_shortname + ")" + evolved_text + ", *" + money  + "* Â§ e *" + exp + "* exp!" + rarity_miss, mark);

								connection.query('INSERT INTO `inventory_chest`(`player_id`, `chest_id`) VALUES (' + element.id + ',' + chest_id + ')', function(err, rows, fields) {
									if (err) throw err;
								});

								if ((class_id == 7) && (reborn > 1)){
									money -= money*0.15;
								}
								if ((class_id == 9) && (reborn > 1)){
									money += money*0.15;
								}
								if ((class_id == 9) && (reborn == 5)){
									money += money*0.05;
								}

								connection.query('UPDATE player SET exp=exp+' + exp + ', mission_count=mission_count+1, money=money+' + money + ' WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
									if (err) throw err;
								});

								if ((villa == 1) || (element.nickname == "fenix45")){
									connection.query('SELECT points FROM event_villa_status WHERE player_id = ' + element.id, function (err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length > 0){
											var points = parseInt(rows[0].points);
											connection.query('UPDATE event_villa_status SET points = points+' + chest_id + ' WHERE player_id = ' + element.id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(chat_id, "Hai ricevuto " + chest_id + " punti per l'evento di LastSoldier95! Ora ne possiedi *" + (points+chest_id) + "*!", mark);
											});
										};
									});
								}

								if ((boost_id == 2) || (boost_id == 4) || (boost_id == 5) || (boost_id == 7)){
									if (boost_mission-1 == 0){
										connection.query('UPDATE player SET boost_mission = 0, boost_id = 0 WHERE id = ' + element.id, function(err, rows, fields) {
											if (err) throw err;
										});
									}else{
										connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + element.id, function(err, rows, fields) {
											if (err) throw err;
										});
									}
								}

								setAchievement(chat_id, element.id, 1, 1);
								setAchievementProgress(element.id, 2);
							});
						});
					});
				});
			});
		});
	});
}

function setFinishedSpecialMission(element, index, array) {
	var chat_id = element.chat_id;
	var mission_id = element.mission_special_id;

	connection.query('SELECT charm_id, class, boost_id, boost_mission, reborn FROM player WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
		if (err) throw err;
		var charm_id = parseInt(rows[0].charm_id);
		var boost_id = parseInt(rows[0].boost_id);
		var boost_mission = parseInt(rows[0].boost_mission);
		var reborn = parseInt(rows[0].reborn);
		var class_id = parseInt(rows[0].class);

		if ((boost_mission <= 0) && (boost_id != 0)){
			connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE nickname = "' + element.nickname + '"', function(err, rows, fields) {
				if (err) throw err;
			});
			boost_mission = 0;
			boost_id = 0;
		}

		connection.query('UPDATE `player` SET `mission_special_id`=0,`mission_special_time_end`=NULL WHERE nickname="' + element.nickname + '" AND mission_special_id != 0', function(err, rows, fields) {
			if (err) throw err;

			connection.query('SELECT ability_level FROM ability WHERE player_id = ' + element.id + ' AND ability_id = 11', function(err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				var rand_c = 15;

				if (Object.keys(rows).length > 0){
					abBonus = rows[0].ability_level;
				}
				rand_c += abBonus;

				var d = new Date();
				if (d.getDay() == 2){
					rand_c += 10;
				}

				/*
					if ((rand >= 5) && (rand <= rand_c) && (boost_id == 0)){
						var rand2 = Math.round(Math.random()*4);
						if (rand2 == 0){
							connection.query('UPDATE `player` SET `boost_id`=1,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Energetica! Per 3 missioni il tempo di esecuzione missioni Ã¨ dimezzato.");
							});
						}else if (rand2 == 1){
							connection.query('UPDATE `player` SET `boost_id`=2,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Duplicante! Per 3 missioni gli scrigni ottenuti a fine missione sono raddoppiati.");
							});
						}else if (rand2 == 2){
							connection.query('UPDATE `player` SET `boost_id`=4,`boost_mission`= 2 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Livellante! Per 2 missioni i punti esperienza ottenuti a fine missione sono raddoppiati.");
							});
						}else if (rand2 == 3){
							connection.query('UPDATE `player` SET `boost_id`=5,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Quadrifoglio! Per 3 missioni la fortuna Ã¨ raddoppiata.");
							});
						}else if (rand2 == 4){
							connection.query('UPDATE `player` SET `boost_id`=6,`boost_mission`= 3 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai trovato una Bevanda Furia! Per 3 attacchi il tuo danno Ã¨ raddoppiato.");
							});
						}
					}

					if (rand <= 2){
						connection.query('UPDATE `player` SET `token`=token+1 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(chat_id, "Hai trovato un Gettone del Destino!");
						});
					}

					if ((rand > 99) && (reborn >= 2)){
						connection.query('UPDATE `player` SET `gems`=gems+1 WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(chat_id, "Hai trovato una Gemma ðŸ’Ž!");
						});					
					}
					*/

				connection.query('SELECT item.name, rarity.id As rarityid, item.rarity, item.id FROM item, rarity, mission_zone_item WHERE item.rarity = rarity.shortname AND zone_id = ' + mission_id + ' AND item.id = mission_zone_item.item_id ORDER BY RAND()', function(err, rows, fields) {
					if (err) throw err;

					var item_id = rows[0].id;
					var exp = rows[0].rarityid;
					var num = 1;

					if (boost_id == 2){
						num++;

						connection.query('INSERT INTO `inventory`(`player_id`, `item_id`) VALUES (' + element.id + ',' + item_id + ')', function(err, rows, fields) {
							if (err) throw err;
						});
					}
					if (boost_id == 4){
						exp = exp*2;
					}

					bot.sendMessage(chat_id, "Itinerario completato! Hai ottenuto:\n" + num + "x *" + rows[0].name + "* (" + rows[0].rarity + "), *" + exp + "* exp e della *Polvere* (S)!", mark);

					connection.query('INSERT INTO `inventory`(`player_id`, `item_id`) VALUES (' + element.id + ',' + item_id + ')', function(err, rows, fields) {
						if (err) throw err;
					});
					connection.query('INSERT INTO `inventory`(`player_id`, `item_id`) VALUES (' + element.id + ',646)', function(err, rows, fields) {
						if (err) throw err;
					});

					connection.query('UPDATE player SET exp=exp+' + exp + ' WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
						if (err) throw err;
					});

					if ((boost_id == 2) || (boost_id == 4) || (boost_id == 5)){
						if (boost_mission-1 == 0){
							connection.query('UPDATE player SET boost_mission = 0, boost_id = 0 WHERE id = ' + element.id, function(err, rows, fields) {
								if (err) throw err;
							});
						}else{
							connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + element.id, function(err, rows, fields) {
								if (err) throw err;
							});
						}
					}
				});
			});
		});
	});
}

function setFinishedHeistProgress(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;
	var ext = element.extracted;
	var word = element.word;

	if (ext != null){
		var len = Object.keys(ext).length;
		if (len > 0){
			var chars = ext.split("");
			for (i=0;i<len;i++){
				word = word.replace(new RegExp(chars[i], 'g'), "");
			}
		}
	}

	var len = Object.keys(word).length;
	if (len == 0){
		console.log("Conosci giÃ  tutte le lettere...");
		return;
	}
	var letters = word.split("");
	letters = shuffle(letters);
	var rand = Math.floor(Math.random()*Object.keys(letters).length);
	var letter = letters[rand];

	if (letter == undefined){
		console.log("Lettera undefined (?)");
		return;
	}

	connection.query('UPDATE heist_progress SET extracted = CONCAT(IFNULL(extracted,""), "' + letter + '"), wait_time = NULL WHERE from_id = ' + player_id, function(err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "Ispezione completata, hai scoperto una nuova lettera: *" + letter + "*!", mark);
	});
};


function setFinishedHeist(element, index, array) {
	connection.query('SELECT player.nickname, player.heist_streak, player.ability, player.money, player.id, player.chat_id, heist.grade, heist.rate1, heist.to_id, heist.matchmaking FROM player, heist WHERE heist.from_id = player.id AND heist.id = ' + element.id, function(err, rows, fields) {
		if (err) throw err;
		var fromNick = rows[0].nickname;
		var fromId = rows[0].id;
		var toId = rows[0].to_id;
		var fromChat = rows[0].chat_id;
		var fromMoney = parseInt(rows[0].money);
		var fromAbility = parseInt(rows[0].ability);
		var streak = parseInt(rows[0].heist_streak);
		var isMatch = rows[0].matchmaking;
		var rate = rows[0].rate1;		//ProbabilitÃ  di successo
		var grade = rows[0].grade;

		var kbNext = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Contatta lo Gnomo"],["Torna al menu"]]
			}
		};

		connection.query('SELECT * FROM dragon WHERE player_id = ' + toId, function(err, rows, fields) {
			if (err) throw err;
			var dragon_room = 0;
			var dragon_level = 0;
			var dragon_name = "";
			if (Object.keys(rows).length > 0){
				dragon_room = 1;
				dragon_level = rows[0].level;
				if (dragon_level > 50)
					dragon_level = 50;
				dragon_name = rows[0].name + " " + rows[0].type;
			}
			connection.query('SELECT player.nickname, player.ability, player.id As playerid, player.chat_id, player.money FROM player, heist WHERE heist.to_id = player.id AND heist.id = ' + element.id, function(err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0){
					console.log("Errore id ispezione: " + element.id);
					return;
				}
				var toNick = rows[0].nickname;
				var toId = rows[0].playerid;
				var toMoney = parseInt(rows[0].money);
				var toChat = rows[0].chat_id;
				var toAbility = parseInt(rows[0].ability);

				connection.query('SELECT wanted_id, player_id FROM event_wanted_status WHERE player_id = ' + fromId, function(err, rows, fields) {
					if (err) throw err;

					if ( ((wanted == 1) || (fromId == 1)) && (Object.keys(rows).length > 0) ){
						if (toId == rows[0].wanted_id){
							var rand_succ = Math.random()*100;
							var wantedId = rows[0].wanted_id;

							connection.query('SELECT heist_win_2 FROM event_wanted_status WHERE player_id = ' + wantedId, function(err, rows, fields) {
								if (err) throw err;
								var heist = rows[0].heist_win_2;

								var randChest = 0;
								var chest_id = 0;

								randChest = Math.round((Math.random()*99)+1);
								if ((randChest <= 100) && (randChest >= 50)){			//50%
									chest_id = 2;
								}else if ((randChest < 50) && (randChest >= 20)){		//30%   
									chest_id = 3;
								}else if ((randChest < 20) && (randChest >= 5)){ 		//15%
									chest_id = 4;
								}else if ((randChest < 5) && (randChest >= 0)){ 		//5%
									chest_id = 5;
								}
								connection.query('SELECT name, rarity_shortname FROM chest WHERE id = ' + chest_id, function(err, rows, fields) {
									if (err) throw err;
									connection.query('INSERT INTO `inventory_chest`(`player_id`, `chest_id`) VALUES (' + fromId + ',' + chest_id + ')', function(err, rows, fields) {
										if (err) throw err;
									});
									bot.sendMessage(fromChat, "Come ricompensa per il tentativo hai ricevuto uno *" + rows[0].name + "* (" + rows[0].rarity_shortname + ")!", mark);
								});

								connection.query('SELECT money, chat_id FROM player WHERE id = ' + wantedId, function(err, rows, fields) {
									if (err) throw err;

									var wanted_chat = rows[0].chat_id;

									if (rand_succ < 35){
										var money = ((parseInt(heist)*100)+1000);

										if (money > 10000){
											money = 10000;
										}

										bot.sendMessage(wanted_chat, "Lo gnomo di " + fromNick + " Ã¨ riuscito a catturarti! AndrÃ  meglio la prossima volta!");

										connection.query('UPDATE player SET money = money + ' + money + ' WHERE id = ' + fromId, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(fromChat, "Il tuo gnomo ha catturato il ricercato e hai ottenuto la sua taglia pari a *" + money + "* Â§\nTorna nella schermata dell'evento per visualizzare il nuovo ricercato!", mark);
										});

										connection.query('UPDATE event_wanted_status SET heist_win = heist_win+1 WHERE player_id = ' + fromId, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('UPDATE event_wanted_status SET heist_lost_2 = heist_lost_2+1 WHERE player_id = ' + wantedId, function(err, rows, fields) {
											if (err) throw err;
										});

										var banned_join = banlist_id.join();

										connection.query('SELECT nickname, from_id, COUNT(from_id) FROM heist_history, player, event_wanted_status WHERE account_id NOT IN (' + banned_join + ') AND fail = 0 AND event_wanted_status.player_id = player.id AND player.id = heist_history.from_id AND player.id != ' + fromId + ' AND time between DATE_SUB(now(),INTERVAL 2 MONTH) AND NOW() GROUP BY from_id ORDER BY COUNT(from_id) DESC LIMIT 200', function(err, rows, fields) {
											if (err) throw err;

											var len = Object.keys(rows).length;
											var rand = Math.round(Math.random()*len);

											var sel = rows[rand].from_id;
											connection.query('UPDATE event_wanted_status SET wanted_id = ' + sel + ' WHERE player_id = ' + fromId, function(err, rows, fields) {
												if (err) throw err;
												//bot.sendMessage(fromChat, "Ora ispeziona il nuovo ricercato!");
											});
										});
									}else{
										bot.sendMessage(wanted_chat, "Lo gnomo di " + fromNick + " ha tentato di catturarti, ma fortunatamente sei riuscito a scappare!");
										bot.sendMessage(fromChat, "Il tuo tentativo di cattura Ã¨ stato un FALLIMENTO, riprova tentando ancora!");

										connection.query('UPDATE event_wanted_status SET heist_lost = heist_lost+1 WHERE player_id = ' + fromId, function(err, rows, fields) {
											if (err) throw err;
										});
										connection.query('UPDATE event_wanted_status SET heist_win_2 = heist_win_2+1 WHERE player_id = ' + wantedId, function(err, rows, fields) {
											if (err) throw err;
										});
									}
									connection.query('DELETE FROM `heist` WHERE `id`=' + element.id, function(err, rows, fields) {
										if (err) throw err;
									});
								});
							});
							return;
						}
					}
					connection.query('SELECT house_id FROM player WHERE id = ' + toId, function(err, rows, fields) {
						if (err) throw err;

						rate -= rows[0].house_id*2;

						connection.query('SELECT ability_level FROM ability WHERE player_id = ' + fromId + ' AND ability_id = 4', function(err, rows, fields) {
							if (err) throw err;

							var abBonus = 0;
							var abBonus2 = 0;
							if (Object.keys(rows).length > 0){
								abBonus = rows[0].ability_level;
								rate = parseInt(rate)+(abBonus*2);
							}

							if (luckyMode == 1){
								rate += 15;
							}

							connection.query('UPDATE `player` SET heist_limit = heist_limit+1 WHERE nickname="' + toNick + '"', function(err, rows, fields) {
								if (err) throw err;
							});

							var rand = Math.random()*100;
							var fail = 1;
							if (rand < rate){
								fail = 0;
							}

							if (fromId == 1)
								fail = 0;

							var d = new Date();
							var history_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

							connection.query('INSERT INTO heist_history (from_id, to_id, rate1, rate2, rate3, fail, time) VALUES ' +
											 '(' + fromId + ',' + toId + ',' + rate + ',0,0,' + fail + ',"' + history_date + '")', function (err, rows, fields){
								if (err) throw err;
							});

							if (fail == 1){
								var ab = fromAbility;
								var ab2 = toAbility;

								if (isMatch == 1){
									setAchievement(fromChat, fromId, 13, 1);
								}

								if (isMatch == 1){
									ab -= 5;
									ab2 += 5;
									if (fromAbility > toAbility){		//ho perso contro uno piÃ¹ debole
										ab -= 3;
										ab2 += 3;
									}else if (fromAbility < toAbility){ 	//ho perso contro uno piÃ¹ forte
										ab += 3;
										ab2 -= 3;
									}
									if (ab < 0){
										ab = 0;
									}
									if (ab2 < 0){
										ab2 = 0;
									}							
								}

								connection.query('UPDATE `player` SET ability = ' + ab + ' WHERE id = ' + fromId, function(err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE `player` SET ability = ' + ab2 + ' WHERE id = ' + toId, function(err, rows, fields) {
									if (err) throw err;
								});
								bot.sendMessage(fromChat, "Il tuo gnomo non Ã¨ riuscito a raggiungere il rifugio nemico, dannazione!", back);
								connection.query('SELECT chat_id FROM player WHERE id = ' + toId, function(err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(rows[0].chat_id, "Lo gnomo di <b>" + fromNick + "</b> Ã¨ stato respinto dai tuoi guardiani del cancello!", html);
								});
							}else{
								var ab = fromAbility;
								var ab2 = toAbility;

								if (isMatch == 1){
									setAchievement(toChat, toId, 9, 1);
								}

								if (isMatch == 1){
									ab += 5;
									ab2 -= 5;
									if (fromAbility > toAbility){		//ho vinto contro uno piÃ¹ debole
										ab -= 2;
										ab2 += 2;
									}else if (fromAbility < toAbility){ 	//ho vinto contro uno piÃ¹ forte
										ab += 2;
										ab2 -= 2;
									}
									if (ab < 0){
										ab = 0;
									}
									if (ab2 < 0){
										ab2 = 0;
									}
								}

								connection.query('UPDATE `player` SET ability = ' + ab + ', exp=exp+1 WHERE id = ' + fromId, function(err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE `player` SET ability = ' + ab2 + ' WHERE id = ' + toId, function(err, rows, fields) {
									if (err) throw err;
								});

								var heistRand = Math.random()*100;

								if (streak+1 >= 15){
									var chestStreak = 4;
									if (heistRand % 2 == 0){
										chestStreak = 5;
									}
									connection.query('UPDATE player SET heist_streak = 0 WHERE id = ' + fromId, function(err, rows, fields) {
										if (err) throw err;
										connection.query('INSERT INTO inventory_chest (player_id, chest_id) VALUES (' + fromId + ',' + chestStreak + ')', function(err, rows, fields) {
											if (err) throw err;
											connection.query('SELECT name FROM chest WHERE id = ' + chestStreak, function(err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(fromChat, "Per aver vinto 15 ispezioni hai ricevuto uno *" + rows[0].name + "*!", mark);
											});
										});
									});
								}else{
									connection.query('UPDATE player SET heist_streak = heist_streak+1 WHERE id = ' + fromId, function(err, rows, fields) {
										if (err) throw err;
									});
								}

								var len = 0;
								len = 5+Math.round(grade/2);

								connection.query('SELECT word, wlength FROM dictionary WHERE wlength BETWEEN ' + (len-1) + ' AND ' + (len+1) + ' ORDER BY RAND()', function(err, rows, fields) {
									if (err) throw err;

									var word = rows[0].word;
									var wlength = rows[0].wlength;

									var d = new Date();
									d.setHours(d.getHours() + 12);
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
									var short_time = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

									connection.query('INSERT INTO heist_progress (from_id, to_id, word, wlength, time_end) VALUES (' + fromId + ',' + toId + ',"' + word + '",' + wlength + ', "' + long_date + '")', function(err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(fromChat, "Il tuo gnomo Ã¨ arrivato al rifugio nemico, ora devi decifrare la parola per scassinare l'entrata, hai tempo fino alle " + short_time + "!", kbNext);
										connection.query('SELECT chat_id FROM player WHERE id = ' + toId, function(err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(rows[0].chat_id, "Lo gnomo di <b>" + fromNick + "</b> Ã¨ riuscito ad arrivare davanti alla tua porta!", html);
										});
									});
								});
							}
							connection.query('DELETE FROM `heist` WHERE `id`=' + element.id, function(err, rows, fields) {
								if (err) throw err;
							});
						});
					});
				});
			});
		});
	});
};

function setFinishedTravel(element, index, array) {
	var chat_id = element.chat_id;

	connection.query('SELECT ability_level FROM ability WHERE player_id = ' + element.id + ' AND ability_id = 9', function(err, rows, fields) {
		if (err) throw err;

		var abBonus = 0;
		var double = 0;
		if (Object.keys(rows).length > 0){
			var rand = 0;
			abBonus = parseInt(rows[0].ability_level)*5;
			if (rand < abBonus){
				double = 1;
			}
		}

		connection.query('UPDATE `player` SET `travel_id`=0,`travel_time_end`=NULL WHERE nickname="' + element.nickname + '" AND travel_id != 0', function(err, rows, fields) {
			if (err) throw err;
			connection.query('SELECT chest_id, money FROM travel WHERE id="' + element.travel_id + '"', function(err, rows, fields) {
				if (err) throw err;
				var mission_chest = rows[0].chest_id;
				var money = rows[0].money;
				connection.query('SELECT name, rarity_shortname FROM chest WHERE id = "' + mission_chest + '"', function(err, rows, fields) {
					if (err) throw err;
					var chest_id = mission_chest;

					var qnt = 5;

					if (double == 1){
						qnt = 10;
					}

					bot.sendMessage(chat_id, "Viaggio completato, hai trovato " + qnt + "x *" + rows[0].name + "* (" + rows[0].rarity_shortname + ") e *" + money + "* Â§!", mark);

					for (i = 0; i < qnt; i++){
						connection.query('INSERT INTO `inventory_chest`(`player_id`, `chest_id`) VALUES (' + element.id + ',' + chest_id + ')', function(err, rows, fields) {
							if (err) throw err;
						});
					}

					connection.query('UPDATE player SET money=money+' + money + ', exp = exp + ' + (chest_id*5-1) + ' WHERE nickname="' + element.nickname + '"', function(err, rows, fields) {
						if (err) throw err;
					});
				});
			});
		});
	});
}

function setFinishedCave(element, index, array) {
	var chat_id = element.chat_id;
	var boost_id = element.boost_id;
	var boost_mission = element.boost_mission;

	if ((boost_mission <= 0) && (boost_id != 0)){
		connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + element.id, function(err, rows, fields) {
			if (err) throw err;
		});
		boost_mission = 0;
		boost_id = 0;
	}

	connection.query('SELECT * FROM cave WHERE id=' + element.cave_id, function(err, rows, fields) {
		if (err) throw err;

		var rand = 0;
		var stone_id = 0;
		var charm_id = parseInt(element.charm_id);

		var caveid = parseInt(element.cave_id)+2;
		if (charm_id == 603){
			caveid += 2;
		}

		if (luckyMode == 1){
			var rand = Math.random()*100;
			if (rand < 50){
				caveid = caveid*2;
			}else{
				caveid = Math.round(caveid/2);
			}
		}

		connection.query('SELECT ability_level FROM ability WHERE player_id = ' + element.id + ' AND ability_id = 8', function(err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0){
				abBonus = parseInt(rows[0].ability_level)*3;
			}

			var boost_text = "";
			if (boost_id == 3){
				caveid = caveid*2;
				boost_text = "\n\nRaddoppiate grazie alla Bevanda Fiamma di Drago!";
				connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + element.id, function(err, rows, fields) {
					if (err) throw err;
				});
			}

			var text = "";
			var rand2 = 0;
			var evolved = 0;

			for (i = 0; i < caveid; i++){ 
				evolved = 0;

				rand = Math.round(Math.random()*100);
				if (rand <= 5){
					stone_id = 73;
				}else if (rand <= 10){
					stone_id = 72;
				}else if (rand <= 25){
					stone_id = 71;
				}else if (rand <= 40){
					stone_id = 70;
				}else if (rand <= 60){
					stone_id = 69;
				}else if (rand <= 100){
					stone_id = 68;
				}

				rand2 = Math.random()*100;
				if ((rand2 < abBonus) && (stone_id != 73)){
					evolved = 1;
					stone_id++;
				}
				connection.query('INSERT INTO inventory (player_id, item_id) VALUES(' + element.id + ', ' + stone_id + ")", function(err, rows, fields) {
					if (err) throw err;
				});
				if (evolved == 1){
					connection.query('SELECT name FROM item WHERE id=' + stone_id, function(err, rows, fields) {
						if (err) throw err;
						text = text + "\n> " + rows[0].name + " evoluta!";
					});
				}else{
					connection.query('SELECT name FROM item WHERE id=' + stone_id, function(err, rows, fields) {
						if (err) throw err;
						text = text + "\n> " + rows[0].name;
					});
				}
			}

			connection.query('UPDATE `player` SET cave_id=0, `cave_time_end`=NULL WHERE nickname="' + element.nickname + '" AND cave_id != 0', function(err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(chat_id, "Hai completato l'esplorazione della cava e hai ottenuto:" + text + boost_text);
			});

			var now = new Date();
			var rand = Math.random()*200;
			if ((now.getHours() == 11) && (rand < 3) && (element.reborn >= 3)){
				connection.query('INSERT INTO inventory (player_id, item_id) VALUES (' + element.id + ',201)', function(err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(chat_id, "Hai ottenuto un Respiro di Morte! Che fortuna!");
				});
			}

			connection.query('SELECT ability_level FROM ability WHERE player_id = ' + element.id + ' AND ability_id = 11', function(err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				var rand_c = 5;
				if (Object.keys(rows).length > 0){
					abBonus = rows[0].ability_level;
				}
				rand_c += abBonus;

				if ((rand < rand_c) && (boost_id == 0)){
					connection.query('UPDATE `player` SET `boost_id`=3,`boost_mission`= 3 WHERE id=' + element.id, function(err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(chat_id, "Hai trovato una Bevanda Fiamma di Drago! Per 3 viaggi in cava le pietre ottenute sono raddoppiate.");
					});
				}
			});
			setAchievement(chat_id, element.id, 11, 1);
		});
	});
}

function setFinishedBoost(element, index, array) {
	var chat_id = element.chat_id;
	connection.query('UPDATE `player` SET `boost_id`=0, `boost_mission`=0 WHERE nickname="' + element.nickname + '" AND boost_id != 0', function(err, rows, fields) {
		if (err) throw err;
		//console.log(getNow("it") + " Boost terminato per " + element.nickname);
		bot.sendMessage(chat_id, "Effetto della bevanda terminato!");
	});
}

function checkReborn(){
	connection.query('SELECT id, exp, life, total_life, reborn, chat_id, nickname FROM player WHERE exp >= 1000', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				if (rows[i].reborn == 1){
					if (rows[i].exp >= 1000){
						connection.query('UPDATE player SET exp = 1000 WHERE id = ' + rows[i].id, function(err, rows, fields) {
							if (err) throw err;
						});
					}
				}else if (rows[i].reborn == 2){
					if (rows[i].exp >= 1500){
						connection.query('UPDATE player SET exp = 1500 WHERE id = ' + rows[i].id, function(err, rows, fields) {
							if (err) throw err;
						});
					}
				}else if (rows[i].reborn == 3){
					if (rows[i].exp >= 2000){
						connection.query('UPDATE player SET exp = 2000 WHERE id = ' + rows[i].id, function(err, rows, fields) {
							if (err) throw err;
						});
					}				
				}else if (rows[i].reborn == 4){
					if (rows[i].exp >= 3000){
						var player_id = rows[i].id;
						var chat_id = rows[i].chat_id;
						var nick = rows[i].nickname;
						connection.query('UPDATE player SET exp = 3000 WHERE id = ' + rows[i].id, function(err, rows, fields) {
							if (err) throw err;
						});
						connection.query('SELECT player_id FROM tear WHERE type = 1 AND player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								lacrima(this.player_id, this.chat_id);
								console.log("Lacrima consegnata a " + this.nick);
							}
						}.bind( {player_id: player_id, chat_id: chat_id, nick: nick} ));
					}
				}else if (rows[i].reborn == 5){
					if (rows[i].exp >= 5000){
						var player_id = rows[i].id;
						var chat_id = rows[i].chat_id;
						var nick = rows[i].nickname;
						connection.query('SELECT player_id FROM tear WHERE type = 2 AND player_id = ' + player_id, function(err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								lacrima2(this.player_id, this.chat_id);
								console.log("Lacrima 2 consegnata a " + this.nick);
							}
						}.bind( {player_id: player_id, chat_id: chat_id, nick: nick} ));
					}
					if (rows[i].exp >= 10000){
						connection.query('UPDATE player SET exp = 10000 WHERE id = ' + rows[i].id, function(err, rows, fields) {
							if (err) throw err;
						});
					}
				}

				var life = rows[i].exp*10;
				if ((rows[i].life == 0) && (rows[i].total_life == 0)){
					connection.query('UPDATE player SET life = ' + life + ', total_life = ' + life + ' WHERE id = ' + rows[i].id, function(err, rows, fields) {
						if (err) throw err;
					});
				}else{
					connection.query('UPDATE player SET total_life = ' + life + ' WHERE id = ' + rows[i].id, function(err, rows, fields) {
						if (err) throw err;
					});
					/*
					var diff_life = life-rows[i].total_life;
					connection.query('UPDATE player SET life=life+' + diff_life + ', total_life = ' + life + ' WHERE id = ' + rows[i].id, function(err, rows, fields) {
						if (err) throw err;
					});
					*/
				}
			}
		}
	});
};

function calcLife(message){
	connection.query('SELECT id, exp, life, weapon_id, weapon2_id, weapon3_id, total_life, reborn FROM player WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0){

			var player_id = rows[0].id;

			if (rows[0].reborn == 1){
				if (rows[0].exp >= 1000){
					connection.query('UPDATE player SET exp = 1000 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						console.log("\x1b[36m" + message.from.username + " ha raggiunto il livello massimo (1)" + "\x1b[0m");
					});
				}
			}else if (rows[0].reborn == 2){
				if (rows[0].exp >= 1500){
					connection.query('UPDATE player SET exp = 1500 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						console.log("\x1b[36m" + message.from.username + " ha raggiunto il livello massimo (2)" + "\x1b[0m");
					});
				}
			}else if (rows[0].reborn == 3){
				if (rows[0].exp >= 2000){
					connection.query('UPDATE player SET exp = 2000 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						console.log("\x1b[36m" + message.from.username + " ha raggiunto il livello massimo (3)" + "\x1b[0m");
					});
				}				
			}else if (rows[0].reborn == 4){
				if (rows[0].exp >= 3000){
					connection.query('UPDATE player SET exp = 3000 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						console.log("\x1b[36m" + message.from.username + " ha raggiunto il livello massimo (4)" + "\x1b[0m");
					});
				}				
			}else if (rows[0].reborn == 5){
				if (rows[0].exp >= 10000){
					connection.query('UPDATE player SET exp = 10000 WHERE id = ' + player_id, function(err, rows, fields) {
						if (err) throw err;
						console.log("\x1b[36m" + message.from.username + " ha raggiunto il livello massimo (5)" + "\x1b[0m");
					});
				}				
			}

			var life = rows[0].exp*10;
			if ((rows[0].life == 0) && (rows[0].total_life == 0)){
				connection.query('UPDATE player SET life = ' + life + ', total_life = ' + life + ' WHERE id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
			}else{
				connection.query('UPDATE player SET total_life = ' + life + ' WHERE id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
				/*
				var diff_life = life-rows[0].total_life;
				connection.query('UPDATE player SET life=life+' + diff_life + ', total_life = ' + life + ' WHERE nickname = "' + message.from.username + '"', function(err, rows, fields) {
					if (err) throw err;
				});
				*/
			}

			var lev = Math.floor(rows[0].exp/10);
			var power = Math.round(50+(lev/2));

			if ((rows[0].weapon_id == 221) || (rows[0].weapon_id == 638) || (rows[0].weapon_id == 639) || (rows[0].weapon_id == 640)){
				//console.log("Necrolama aggiornata: " + power);
				connection.query('UPDATE player SET weapon = ' + power + ' WHERE id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
			}

			power = Math.round(25+(lev/2));			
			power = -Math.abs(power);

			if (rows[0].weapon2_id == 577){
				//console.log("Corazza Necro aggiornata: " + power);
				connection.query('UPDATE player SET weapon2 = ' + power + ' WHERE id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
			}

			power = Math.round(20+(lev/2));			
			power = -Math.abs(power);

			if ((rows[0].weapon3_id == 600) || (rows[0].weapon3_id == 671) || (rows[0].weapon3_id == 672) || (rows[0].weapon3_id == 673)){
				//console.log("Scudo Necro aggiornato: " + power);
				connection.query('UPDATE player SET weapon3 = ' + power + ' WHERE id = ' + player_id, function(err, rows, fields) {
					if (err) throw err;
				});
			}

			connection.query('UPDATE player SET life = total_life WHERE life > total_life', function(err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE player SET life = 0 WHERE life < 0', function(err, rows, fields) {
				if (err) throw err;
			});
		}else{
			bot.sendMessage(message.chat.id, "Il tuo account non Ã¨ stato trovato, ripristina il nickname oppure premi /start per registrarti.");
		}
	});
}

function addZero(i) {
	if (i < 10) {
		i = "0" + i;
	}
	return i;
}

function formatNumber(num) {
	return ("" + num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, function($1) { return $1 + "." });
}

function toDate(lang, date) {
	var d = new Date(date);
	if (lang == "it"){
		var datetime = addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear() + " alle " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	}else if (lang == "en"){
		var datetime = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	}else{
		var datetime = "Lingua non specificata";
	}
	return datetime;	
}

function getNow(lang, obj) {
	var d = new Date();
	obj = typeof obj !== 'undefined' ? obj : false;
	if (lang == "it"){
		var datetime = addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear() + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	}else if (lang == "en"){
		var datetime = d.getFullYear() + "-" + addZero(d.getMonth()+1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	}else{
		var datetime = "Lingua non specificata";
	}
	if (obj == true){
		datetime = new Date(datetime);
	}
	return datetime
}

function callNTimes( time, fn) {
	function callFn() {
		if (1 < 0) return;
		fn();
		setTimeout(callFn, time);
	}
	setTimeout(callFn, time);
}

function findAndRemove(array, str){
	for (var i = 0; i < array.length; i++) {
		if (array[i] == str){
			array.splice(i, 1);
		}
	}
	return array;
}

function findInArray(array, str){
	for (var i = 0; i < array.length; i++) {
		if (array[i] == str){
			return true;
		}
	}
	return false;
}

function getPosition(str, m, i) {
	return str.split(m, i).join(m).length;
}

function shuffle(array) {
	var currentIndex = array.length, temporaryValue, randomIndex;

	while (0 !== currentIndex) {
		randomIndex = Math.floor(Math.random() * currentIndex);
		currentIndex -= 1;

		temporaryValue = array[currentIndex];
		array[currentIndex] = array[randomIndex];
		array[randomIndex] = temporaryValue;
	}
	return array;
}

function mysql_real_escape_string (str) {
	return str.replace(/[\0\x08\x09\x1a\n\r"'\\\%]/g, function (char) {
		switch (char) {
			case "\0":
				return "\\0";
			case "\x08":
				return "\\b";
			case "\x09":
				return "\\t";
			case "\x1a":
				return "\\z";
			case "\n":
				return "\\n";
			case "\r":
				return "\\r";
			case "\"":
			case "'":
			case "\\":
			case "%":
				return "\\"+char;
					}
	});
}

function estimate(values) {
	if (values.length <= 2)
		return average(values);
	var avg = average(values),
		upper = [],
		lower = [];
	values.forEach( function(val) {
		if (val >= avg)
			upper.push(val);
		else
			lower.push(val);
	});

	if (upper.length == 0)
		return average(lower);
	if (lower.length == 0)
		return average(upper);

	var upperDev = deviationFromAvg(upper, avg),
		lowerDev = deviationFromAvg(lower, avg);
	if (upperDev >= lowerDev)
		return estimate(lower);
	else
		return estimate(upper);
}

function average(values){
	var sum = 0;
	values.forEach( function(el) { sum += +el; } );
	return Math.floor(sum / values.length);
}

function deviationFromAvg(values, avg){
	var dev = 0;
	values.forEach( function(el) { dev += Math.abs(el - avg); } );
	return Math.floor(dev / values.length);
}
