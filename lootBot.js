process.env["NTBA_FIX_319"] = 1;
process.env["NTBA_FIX_350"] = 1;

process.on('uncaughtException', function (error) {
	console.log("\x1b[31muncaughtException: " + error + "\x1b[0m");
});

process.on('unhandledRejection', function (error, p) {
	if (error.message.indexOf("Too Many Requests") == -1)
		console.log("\x1b[31munhandledRejection: " + error.message + "\x1b[0m");
});

var max_mission_id = 290;
var timevar = [];
var timevarFlood = [];
var answerCallbacks = {};

// Eventi automatici
var eventMana = 0;
var eventDust = 0;

// Eventi attivati
var crazyMode = 0;			// nulla
var luckyMode = 0;			// svuota contest
var arena = 0;				// azzera le due tabelle
var lootteria = 0;			// svuota event_lottery_coins e event_lottery_prize con extracted a 0
var lootteriaBlock = 0;
var autoEstrazione = 0;
var villa = 0;				// update a 10 punti
var wanted = 0;				// svuota event_wanted_status
var eventTeamStory = 0;		// svuota event_team_story
var eventFestival = 0;		// event_crafting_status con total_cnt a 0		
var specialMission = 0;		// nulla
var checkDragonTopOn = 1;	// svuota tabelle dragon_ e auto increment dummy a 100000

// FestivitÃ  o disattivati
var eventStory = 0;
var halloween = 0;
var snowHouse = 0;
var snowHouseEnd = 0;

// Variabili globali
var teamMission = 1;
var missionDayLimit = 5;
var sconto = 10;
var sconto_evento = 0;
var max_duration = 5;
var wait_room = 900;
var wait_dungeon = 2;
var wait_dungeon_long = 5;
var max_istance = 120;
var merchant_limit = 5;
var rank_cap = 15;
var rankList = [20, 50, 75, 100, 150, 200, 500, 750, 1000, 1500];
var progLev = [50, 100, 250, 450, 750, 1250, 1500, 1750];
var progLevRew = [50000, 100000, 125000, 150000, 250000, 1000000, 2500000, 5000000];
var progMis = [10, 25, 50, 75, 100, 250, 500, 1000, 2000, 5000, 10000, 25000, 50000];
var progMisRew = [5000, 12500, 25000, 50000, 75000, 100000, 250000, 350000, 500000, 1000000, 2000000, 3000000, 5000000];
var progDung = [1, 5, 10, 25, 50, 75, 100, 250, 500, 1000, 1500, 2500, 3000];
var progDungRew = [10000, 50000, 75000, 100000, 250000, 500000, 750000, 1000000, 2000000, 3000000, 4500000, 6000000];
var progCraft = [100, 500, 1000, 2500, 5000, 10000, 20000, 50000, 75000, 100000, 200000, 300000];
var progCraftRew = [10000, 50000, 75000, 150000, 250000, 500000, 1000000, 2000000, 4000000, 6000000, 8000000, 10000000];

var re = new RegExp("^[0-9]*$");
var re2 = new RegExp("^[a-zA-Z0-9Ã Ã¨Ã¬Ã²Ã¹ ]*$");
var re3 = new RegExp("^[a-zA-Z0-9!?,.Ã Ã¨Ã©Ã¬Ã²Ã¹@ ]*$");
var re4 = new RegExp("^[a-zA-Z0-9Ã Ã¨Ã¬Ã²Ã¹ ]{1,40}$");
var re5 = new RegExp("^[a-zA-Z0-9!?,.Ã Ã¨Ã©Ã¬Ã²Ã¹@ ]{1,255}$");
var re6 = new RegExp("^[a-zA-Z0-9Ã Ã¨Ã©Ã¬Ã²Ã¹\\'\\-\\* ]{1,255}$");

var config = require('./config.js');
var TelegramBot = require('node-telegram-bot-api');
var fs = require('fs')
var Schedule = require('node-schedule');
var request = require('request');
var readline = require('readline');
var mysql = require('mysql');
var mysql_sync = require('sync-mysql');

var token = '171514820:AAHSsAF-_bkpB5Du5NLvRqlUpzgSntwz22c';
var bot = new TelegramBot(token, {
	polling: true,
	polling: {
		params: {
			"limit": 80
		}
	}
});

var j = Schedule.scheduleJob('00 3 * * *', function () { //3 notte
	refreshHeists();
	refreshLife();
	if (checkDragonTopOn == 1)
		checkDragonTop();
});

var j1 = Schedule.scheduleJob('00 8 * * *', function () { //8 di mattina
	if (checkDragonTopOn == 1)
		cleanDragon();
});

var j2 = Schedule.scheduleJob('59 23 * * *', function () { //23:59 notte
	saveActive();
});

var j3 = Schedule.scheduleJob('01 00 * * *', function () { //00:01 notte
	var d = new Date();
	if (d.getDay() != 5)
		autoMana();
	if (d.getDay() != 2)
		autoDust();
	if ((d.getDay() != 6) && (d.getDay() != 0)) {
		reloadAchievement();
	} else {
		resetAchievement();
	}
	if (d.getDay() == 1)
		craftWeek();
	resetTeamMission();
});

var j4 = Schedule.scheduleJob('05 00 * * *', function () { //00:05 notte
	refreshMerchant(0);
	market_generation();
	resetDungeonSkip();
	resetRefill();
	deleteSearch();
	//checkDragonNoBattle();
});

var j5 = Schedule.scheduleJob('00 15 * * *', function () { //15:00
	var d = new Date();
	if (d.getDay() == 1)
		updateSpecialItem();
	else if (d.getDay() == 2)
		resetSpecialItem();
});

callNTimes(20000, function () { //20 secondi
	if (checkDragonTopOn == 1)
		checkDragonSearch();
});

callNTimes(40000, function () { //40 secondi
	checkMissions();
});

callNTimes(40000, function () { //40 secondi
	if (checkDragonTopOn == 1)
		checkDragonSearchCd();
});

callNTimes(60000, function () { //Ogni 1 minuto
	if (eventStory == 1)
		checkEventMissions();
	checkDragonArena();
	checkDragonTopCd();
	checkEventMissions();
	checkSpecialMissions();
	checkDungeonRoom();
	checkDungeonEnd();
	checkDungeonExpire();
	checkIstanceExpire();
	checkHeists();
	checkHeistsProgress();
	checkDust();
	checkMerchant();
	checkTeamMissions();

	if (crazyMode == 1)
		merchant_limit = 8;
	var d = new Date();
	if ((d.getDay() != 6) && (d.getDay() != 0) && (luckyMode == 1)) {
		luckyMode = 0;
	}
	if ((d.getDay() != 6) && (d.getDay() != 0) && (crazyMode == 1)) {
		crazyMode = 0;
	}
	if ((d.getDay() != 6) && (d.getDay() != 0) && (wanted == 1)) {
		wanted = 0;
	}
	if ((d.getDay() > 3) && (d.getDay() < 6) && (villa == 1)) {
		villa = 0;
	}
	if ((d.getDay() == 4) || (d.getDay() == 5)) {
		eventMana = 1;
		checkKeyboard();
	} else {
		eventMana = 0;
		checkKeyboard();
	}
	if ((d.getDay() == 1) || (d.getDay() == 2)) {
		eventDust = 1;
		checkKeyboard();
	} else {
		eventDust = 0;
		checkKeyboard();
	}

	if (eventFestival == 1) {
		reloadFestival(0);
		checkFestivalWait();
		checkFestivalFinish();
	}
	if (autoEstrazione == 1) {
		estrazione();
	}
});

callNTimes(120000, function () { //Ogni 2 minuti
	checkProtection();
	checkDungeonNotification();
	checkDungeonNotificationIstance();
	checkReborn();
	checkDragonSleep();
	checkDragonBattle();
	if (checkDragonTopOn == 1)
		checkDragonNoMatch();
	checkMissionTeamExpire();
});

callNTimes(300000, function () { //Ogni 5 minuti
	checkTeam();
	refreshBosses();
	checkTravels();
	checkCave();
	checkEnchant();
	checkEnchant2();
	checkEnchant3();
	checkGlobalMsg();
});

callNTimes(1800000, function () { //Ogni mezz'ora
	checkEvents();
	checkTeamAct();
	checkAct();
	checkGnome();
});

callNTimes(3600000, function () { //Ogni ora
	calcBaseFunc(1);
	checkTeamClean();
	checkTeamPlayers();
});

console.log('Avvio bot...');

var connection = mysql.createConnection({
	host: config.dbhost,
	user: config.dbuser,
	password: config.dbpassword,
	database: config.dbdatabase
});
connection.connect();

var connection_sync = new mysql_sync({
	host: config.dbhost,
	user: config.dbuser,
	password: config.dbpassword,
	database: config.dbdatabase
});

process.on('SIGINT', function() {
	console.log("Spegnimento bot...");
	connection.end();
	process.exit();
});

process.on('SIGTERM', function() {
	console.log("Spegnimento bot...");
	connection.end();
	process.exit();
});

bot.on('polling_error', function(error) {
	console.log(error);
});

var d = new Date();

function checkSpam(message) {
	var isOk = true;
	var diff = 0;
	if (timevar[message.from.id] != undefined) {
		diff = new Date() / 1000 - timevar[message.from.id];
		if (diff < 0.8) {
			//console.log("SPAM Utente " + message.from.username + ": " + truncate(message.text.replace("\n"," "), 100));
			isOk = false;
		}
	}
	timevar[message.from.id] = new Date() / 1000;

	return isOk;
}

bot.on('message', function (message) {
	if (message.text != undefined) {
		if ((message.text != "") && (message.text.indexOf("/start") == -1)) {
			//console.log(getNow("it") + " - " + message.from.username + ": " + message.text);
			connection.query('SELECT id FROM last_command WHERE account_id = ' + message.from.id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					connection.query('SELECT account_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0) {
							connection.query('INSERT INTO last_command (account_id, time) VALUES (' + message.from.id + ',"' + getNow("en") + '")', function (err, rows, fields) {
								if (err) {
									console.log("Errore chiave esterna message (" + message.from.id + "): " + message.text);
									console.log(err);
								};
							});
						}
					});
				} else {
					connection.query('UPDATE last_command SET time = "' + getNow("en") + '" WHERE account_id = ' + message.from.id, function (err, rows, fields) {
						if (err) throw err;
					});
				}
			});
		}
	}
	connection.query('SELECT account_id, market_ban, id, status, exp, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0) {
			return;
		}
		var player_id = rows[0].id;
		var status = rows[0].status;
		var lev = Math.floor(rows[0].exp / 10);
		var reborn = rows[0].reborn;

		if (message.successful_payment != undefined) {
			connection.query('SELECT payload, status, id FROM payments WHERE player_id = ' + player_id + ' ORDER BY id DESC', function (err, rows, fields) {
				if (err) throw err;

				if ((rows[0].payload != message.successful_payment.invoice_payload) || (rows[0].status != "WAIT")) {
					bot.sendMessage(message.chat.id, "Errore durante la verifica del pagamento, riprova", back);
					return;
				}

				connection.query('UPDATE payments SET status = "OK" WHERE id = ' + rows[0].id, function (err, rows, fields) {
					if (err) throw err;

					var amount = Math.floor(message.successful_payment.total_amount / 100);

					bot.sendMessage("@lnotify", "#Donazione " + message.from.username + " (" + message.from.id + ") per " + message.successful_payment.total_amount / 100 + " â‚¬");
					bot.sendMessage(message.chat.id, "Hai ricevuto *" + amount + " ðŸŒ•* per la tua donazione, grazie mille!", back);

					connection.query('UPDATE player SET donation = donation + ' + amount + ' WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});
					connection.query('UPDATE player SET moon_coin = moon_coin + ' + amount + ' WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});
					connection.query('INSERT INTO donation_history (player_id, amount, source) VALUES (' + player_id + ', ' + amount + ', "Telegram")', function (err, rows, fields) {
						if (err) throw err;
					});
				});
			});
		}

		if (status != null) {
			connection.query('UPDATE player SET status = NULL, status_cnt = 0 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		if (rows[0].account_id != message.from.id) {
			if (rows[0].market_ban == 0) {
				bot.sendMessage("@lnotify", "#Accountid " + message.from.username + "-" + message.from.id + ": " + message.text);
				connection.query('UPDATE player SET market_ban = 1 WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "E' stata trovata un'incongruenza id relativa al tuo account, comunica all'amministratore. Intanto sei impossibilitato ad utilizzare il mercato");
				});
			}
		}

		var one_time_gift = 0;
		if (one_time_gift == 1){
			if ((lev >= 10) || (reborn > 1)) {
				var d = new Date();
				if (d.getDate() == 10) {
					connection.query('SELECT COUNT(*) As cnt FROM one_time_gift WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						if (rows[0].cnt == 0) {
							connection.query('INSERT INTO one_time_gift (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
								if (err) throw err;
								connection.query('UPDATE player SET gems = gems+10 WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Per la pazienza che hai dimostrato nonostante il blackout dei server di ieri, ti spetta un piccolo dono ottenibile solo oggi: *10* ðŸ’Ž!\nRicorda di invitare amici con il link invito che trovi nella sezione giocatore e lasciare un voto per il bot su StoreBot! Buon divertimento ;)", mark);
									console.log("One_time_gift a " + message.from.username);
								});
							});
						}
					});
				};
			};
		}
	});

	var callback = answerCallbacks[message.chat.id];
	if (callback) {
		delete answerCallbacks[message.chat.id];
		return callback(message);
	}

	var reg = new RegExp("(alter|select|delete|insert|truncate|!=|<>)","gi");
	if (reg.test(message.text) == true)
		bot.sendMessage("@lnotify", "#Inject " + message.from.username + ": " + message.text);

	if (message.from.username == undefined)
		bot.sendMessage(message.from.id, "Imposta un nickname per poter giocare! Puoi farlo dalle impostazioni di Telegram.", back);
});

bot.on("pre_checkout_query", function (message) {
	bot.answerPreCheckoutQuery(message.id, true);
});

var mainKeys = [];
var mainKeysR = [];
var mainKeysR2 = [];

var topOpen = "Chiuse";
if (checkDragonTopOn == 1)
	topOpen = "Aperte";

mainKeys = [['Missione âš”'],
			['Dungeon ðŸ›¡', 'Vette ðŸ² (' + topOpen + ')'],
			['Alchimia âš—ï¸', 'Rifugio ðŸ”¦'],
			['Zaino ðŸŽ’', 'Piazza ðŸ’°', 'Scrigni ðŸ”‘'],
			['Giocatore ðŸ‘¤', 'Team âšœï¸'],
			['Imprese ðŸ‹ï¸', 'Drago ðŸ‰', 'Viaggi ðŸ—º'],
			['Sfide del Destino ðŸ”®', 'Eventi ðŸŽ¯'],
			['Top ðŸ”', 'Monete Lunari ðŸŒ•', 'Info ðŸ“–']]

var defaultKeys = [];
defaultKeys = mainKeys.slice();

var resp = {
	reply_markup: JSON.stringify({
		force_reply: true
	})
};

var mark = {
	parse_mode: "Markdown"
};

var html = {
	parse_mode: "HTML"
};

var main_html = {};
var mainReborn2_html = {};
var mainReborn_html = {};

var back = {
	parse_mode: "Markdown",
	disable_web_page_preview: true,
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Torna al menu"]]
	}
};

var back_html = {
	parse_mode: "Html",
	disable_web_page_preview: true,
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Torna al menu"]]
	}
};

var yesno = {
	parse_mode: "Markdown",
	reply_markup: {
		"force_reply": true,
		"resize_keyboard": true,
		"//one_time_keyboard": true,
		"keyboard": [["Si"], ["Torna al menu"]]
	}
};

var conf = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Conferma"], ["Torna al menu"]]
	}
};

var abort_travel = {
	parse_mode: "HTML",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Ritorna"], ["Torna al menu"]]
	}
};

var abort_travel_2 = {
	parse_mode: "HTML",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Ritorna"], ["Concludi immediatamente"], ["Torna al menu"]]
	}
};

var abort_mission = {
	parse_mode: "HTML",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Termina subito"], ["Torna al menu"]]
	}
};

var team = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Torna al Team"], ["Torna al menu"]]
	}
};

var team_html = {
	parse_mode: "HTML",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Torna al Team"], ["Torna al menu"]]
	}
};

var no_preview = {
	parse_mode: "Markdown",
	disable_web_page_preview: true
};

var html_no_preview = {
	parse_mode: "HTML",
	disable_web_page_preview: true
};

var revive = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Torna in Vita"], ["Torna al menu"]]
	}
};

var keyrank = {
	parse_mode: "HTML",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [['Top'], ['Torna al menu']]
	}
};

var kb_heist = {
	parse_mode: "Markdown",
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Completa immediatamente"], ["Torna al menu"]]
	}
};

var no_preview_html = {
	parse_mode: "HTML",
	disable_web_page_preview: true
};

var no_preview_back = {
	parse_mode: "Markdown",
	disable_web_page_preview: true,
	reply_markup: {
		resize_keyboard: true,
		//one_time_keyboard: true,
		"keyboard": [["Torna al menu"]]
	}
};

bot.onText(/^\/key/, function (message, match) {
	checkKeyboard();
	bot.sendMessage(message.chat.id, "Tastiera aggiornata");
});

bot.onText(/^\/eventon (.+)|^\/eventon|^\/eventoff (.+)|^\/eventoff/, function (message, match) {
	if (message.from.id == 20471035) {
		var event = "";
		if ((match[1] == undefined) && (match[2] == undefined)) {
			bot.sendMessage(message.chat.id, "crazy, lucky, arena, lottery, villa, wanted, teamstory, festival, specialmission, top");
			return;
		}
		if (message.text.indexOf("eventon") != -1) {
			event = match[1];
		} else if (message.text.indexOf("eventoff") != -1) {
			event = match[2];
		}

		var onoff = 1;
		if (message.text.indexOf("eventoff") != -1)
			onoff = 0;

		if (onoff == 1){
			if (event == "crazy")
				crazyMode = onoff;
			if (event == "lucky") {
				connection.query('DELETE FROM contest', function (err, rows, fields) {
					if (err) throw err;
					luckyMode = onoff;
				});
			}
			if (event == "arena") {
				connection.query('DELETE FROM event_arena_status', function (err, rows, fields) {
					if (err) throw err;
					connection.query('DELETE FROM event_arena_dragon', function (err, rows, fields) {
						if (err) throw err;
						arena = onoff;
					});
				});
			}
			if (event == "lottery") {
				connection.query('DELETE FROM event_lottery_coins', function (err, rows, fields) {
					if (err) throw err;
					connection.query('UPDATE event_lottery_prize SET extracted = 0', function (err, rows, fields) {
						if (err) throw err;
						lootteria = onoff;
					});
				});
			}
			if (event == "villa") {
				connection.query('UPDATE event_villa_status SET points = 10', function (err, rows, fields) {
					if (err) throw err;
					villa = onoff;
				});
			}
			if (event == "wanted") {
				connection.query('DELETE FROM event_wanted_status', function (err, rows, fields) {
					if (err) throw err;
					wanted = onoff;
				});
			}
			if (event == "teamstory") {
				connection.query('DELETE FROM event_team_story', function (err, rows, fields) {
					if (err) throw err;
					eventTeamStory = onoff;
				});
			}
			if (event == "festival") {
				connection.query('UPDATE event_crafting_status SET total_cnt = 0', function (err, rows, fields) {
					if (err) throw err;
					// svuota anche event_crafting_item?
					eventFestival = onoff;
				});
			}
			if (event == "specialmission")
				specialMission = onoff;
			if (event == "top"){
				connection.query('ALTER TABLE dragon_dummy AUTO_INCREMENT = 100000', function (err, rows, fields) {
					if (err) throw err;
				});
				connection.query('DELETE FROM dragon_dummy', function (err, rows, fields) {
					if (err) throw err;
				});
				connection.query('DELETE FROM dragon_top_dummy', function (err, rows, fields) {
					if (err) throw err;
				});
				connection.query('DELETE FROM dragon_top_rank', function (err, rows, fields) {
					if (err) throw err;
				});
				connection.query('DELETE FROM dragon_top_status', function (err, rows, fields) {
					if (err) throw err;
				});
				checkDragonTopOn = onoff;
			}
		}else{
			if (event == "crazy")
				crazyMode = onoff;

			if (event == "lucky")
				luckyMode = onoff;

			if (event == "arena")
				arena = onoff;

			if (event == "lottery")
				lootteria = onoff;

			if (event == "villa")
				villa = onoff;

			if (event == "wanted")
				wanted = onoff;

			if (event == "teamstory")
				eventTeamStory = onoff;

			if (event == "festival")
				eventFestival = onoff;

			if (event == "specialmission")
				specialMission = onoff;

			if (event == "top")
				checkDragonTopOn = onoff;
		}

		checkKeyboard();
		bot.sendMessage(message.chat.id, "Evento " + event + " impostato a " + onoff);
	}
});

var dMana = new Date();
if ((dMana.getDay() == 4) || (dMana.getDay() == 5)) {
	eventMana = 1;
} else {
	eventMana = 0;
}
if ((d.getDay() == 1) || (d.getDay() == 2)) {
	eventDust = 1;
	checkKeyboard();
} else {
	eventDust = 0;
	checkKeyboard();
}

checkKeyboard();

function checkKeyboard() {
	mainKeys = defaultKeys.slice();
	mainKeysR = mainKeys.slice();
	mainKeysR2 = mainKeys.slice();

	mainKeysR.splice(0, 0, ['â­ï¸ Rinasci â­ï¸ ']);

	if (eventMana == 1) {
		mainKeys.splice(0, 0, ['â› Miniere di Mana (Evento) â›° ']);
		mainKeysR.splice(1, 0, ['â› Miniere di Mana (Evento) â›° ']);
		mainKeysR2.splice(1, 0, ['â› Miniere di Mana (Evento) â›° ']);
	}
	if (lootteria == 1) {
		mainKeys.splice(0, 0, ['ðŸ’Ž Lootteria (Evento) ðŸ’° ']);
		mainKeysR.splice(1, 0, ['ðŸ’Ž Lootteria (Evento) ðŸ’° ']);
		mainKeysR2.splice(1, 0, ['ðŸ’Ž Lootteria (Evento) ðŸ’° ']);
	}
	if (crazyMode == 1) {
		mainKeys.splice(0, 0, ['ðŸŽ‰ Weekend della Follia (Evento) ðŸ˜±']);
		mainKeysR.splice(1, 0, ['ðŸŽ‰ Weekend della Follia (Evento) ðŸ˜±']);
		mainKeysR2.splice(1, 0, ['ðŸŽ‰ Weekend della Follia (Evento) ðŸ˜±']);
	}
	if (luckyMode == 1) {
		mainKeys.splice(0, 0, ['ðŸŒ’ Evento della Luna (Evento) ðŸ€']);
		mainKeysR.splice(1, 0, ['ðŸŒ’ Evento della Luna (Evento) ðŸ€']);
		mainKeysR2.splice(1, 0, ['ðŸŒ’ Evento della Luna (Evento) ðŸ€']);
	}
	if (arena == 1) {
		mainKeys.splice(0, 0, ['ðŸ² Arena dei Draghi (Evento) ðŸ”¥ ']);
		mainKeysR.splice(1, 0, ['ðŸ² Arena dei Draghi (Evento) ðŸ”¥']);
		mainKeysR2.splice(1, 0, ['ðŸ² Arena dei Draghi (Evento) ðŸ”¥']);
	}
	if (eventFestival == 1) {
		mainKeys.splice(0, 0, ['ðŸŽ‰Crafting Festival (Evento) ðŸ› ']);
		mainKeysR.splice(1, 0, ['ðŸŽ‰Crafting Festival (Evento) ðŸ› ']);
		mainKeysR2.splice(1, 0, ['ðŸŽ‰Crafting Festival (Evento) ðŸ› ']);
	}
	if (specialMission == 1) {
		mainKeys.splice(0, 0, ['ðŸ¹Itinerario Propizio (Evento) ðŸŽ¯']);
		mainKeysR.splice(1, 0, ['ðŸ¹Itinerario Propizio (Evento) ðŸŽ¯']);
		mainKeysR2.splice(1, 0, ['ðŸ¹Itinerario Propizio (Evento) ðŸŽ¯']);
	}
	if (wanted == 1) {
		mainKeys.splice(0, 0, ['ðŸ’°Il Ricercato (Evento) ðŸ‘º']);
		mainKeysR.splice(1, 0, ['ðŸ’°Il Ricercato (Evento) ðŸ‘º']);
		mainKeysR2.splice(1, 0, ['ðŸ’°Il Ricercato (Evento) ðŸ‘º']);
	}
	if (eventDust == 1) {
		mainKeys.splice(0, 0, ['â² Generatore di Polvere (Evento) ðŸ”¥']);
		mainKeysR.splice(1, 0, ['â² Generatore di Polvere (Evento) ðŸ”¥']);
		mainKeysR2.splice(1, 0, ['â² Generatore di Polvere (Evento) ðŸ”¥']);
	}
	if (villa == 1) {
		mainKeys.splice(0, 0, ['ðŸ° Villa di LastSoldier95 (Evento) ðŸ“¦']);
		mainKeysR.splice(1, 0, ['ðŸ° Villa di LastSoldier95 (Evento) ðŸ“¦']);
		mainKeysR2.splice(1, 0, ['ðŸ° Villa di LastSoldier95 (Evento) ðŸ“¦']);
	}
	if (eventTeamStory == 1) {
		mainKeys.splice(0, 0, ['ðŸ’¬ Il Canto del Bardo (Evento) ðŸ“š']);
		mainKeysR.splice(1, 0, ['ðŸ’¬ Il Canto del Bardo (Evento) ðŸ“š']);
		mainKeysR2.splice(1, 0, ['ðŸ’¬ Il Canto del Bardo (Evento) ðŸ“š']);
	}
	var d = new Date();
	if ((d.getDay() == 3) && (d.getHours() > 9) && (d.getHours() < 22)) {
		mainKeys.splice(0, 0, ['ðŸ“ƒ Casa dei Giochi (Evento) ðŸŽ²']);
		mainKeysR.splice(1, 0, ['ðŸ“ƒ Casa dei Giochi (Evento) ðŸŽ²']);
		mainKeysR2.splice(1, 0, ['ðŸ“ƒ Casa dei Giochi (Evento) ðŸŽ²']);
	}
	if (snowHouse == 1){	
		mainKeys.splice(0, 0, ['ðŸŽ„ Villaggio Innevato (Evento) ðŸŒ¨']);
		mainKeysR.splice(1, 0, ['ðŸŽ„ Villaggio Innevato (Evento) ðŸŒ¨']);
		mainKeysR2.splice(1, 0, ['ðŸŽ„ Villaggio Innevato (Evento) ðŸŒ¨']);
	}

	main_html = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": mainKeys
		}
	};

	mainReborn_html = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": mainKeysR
		}
	};

	mainReborn2_html = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": mainKeysR2
		}
	};
};

bot.onText(/^\/ping/, function (message, match) {
	bot.sendMessage(message.chat.id, "_Pong_", mark);
});

//EASTEREGG

bot.onText(/^Sniffa$/i, function (message, match) {
	bot.sendMessage(message.chat.id, "Uh, un ðŸ¼!");
});

bot.onText(/^Edo$/i, function (message, match) {
	bot.sendMessage(message.chat.id, "Boss âš¡ï¸");
});

//EASTEREGG

bot.onText(/^\/accountid (.+)/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query('SELECT nickname, account_id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non ho trovato l'utente");
				return;
			}

			bot.sendMessage(message.chat.id, rows[0].account_id);
		});
	}
});

bot.onText(/^\/genmarket/, function (message, match) {
	market_generation();
	console.log("OK");
});

bot.onText(/^\/cleanInactive$/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query("SELECT COUNT(P.nickname) As cnt FROM last_command L RIGHT JOIN player P ON L.account_id = P.account_id WHERE time IS NULL AND P.id < (SELECT MAX(id)-5000 FROM player)", function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(message.chat.id, "Last command non memorizzato: " + rows[0].cnt + "\nContinuo?", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query("SELECT P.id, P.nickname, P.account_id, L.time FROM last_command L RIGHT JOIN player P ON L.account_id = P.account_id WHERE time IS NULL AND P.id < (SELECT MAX(id)-5000 FROM player)", function (err, rows, fields) {
							if (err) throw err;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								console.log(rows[i].id + "  - " + rows[i].nickname + " inattivo dal " + rows[i].time);
							}
							bot.sendMessage(message.chat.id, "Continuare con la cancellazione?", yesno).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text.toLowerCase() == "si") {
										connection.query("SELECT P.id, P.nickname, P.account_id, L.time FROM last_command L RIGHT JOIN player P ON L.account_id = P.account_id WHERE time IS NULL AND P.id < (SELECT MAX(id)-5000 FROM player) LIMIT 1000", function (err, rows, fields) {
											if (err) throw err;
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												console.log("Eliminato: " + rows[i].id + "  - " + rows[i].nickname + " inattivo dal " + rows[i].time);
												connection.query("DELETE FROM player WHERE id = " + rows[i].id + " LIMIT 1", function (err, rows, fields) {
													if (err) throw err;
												});
											}
											bot.sendMessage(message.chat.id, "Fin.", back);
										});
									};
								};
							});
						});
					}
				}
			});
		});
	};
});

bot.onText(/^\/cleanInactive6$/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query("SELECT COUNT(P.nickname) As cnt FROM last_command L RIGHT JOIN player P ON L.account_id = P.account_id WHERE time < NOW() - INTERVAL 6 MONTH", function (err, rows, fields) {
			if (err) throw err;

			bot.sendMessage(message.chat.id, "Inattivi da + di 6 mesi: " + rows[0].cnt + "\nContinuo?", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query("SELECT P.id, P.nickname, L.time FROM last_command L RIGHT JOIN player P ON L.account_id = P.account_id WHERE time < NOW() - INTERVAL 6 MONTH", function (err, rows, fields) {
							if (err) throw err;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								console.log(rows[i].id + "  - " + rows[i].nickname + " inattivo dal " + rows[i].time);
							}
							bot.sendMessage(message.chat.id, "Continuare con la cancellazione?", yesno).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text.toLowerCase() == "si") {
										connection.query("SELECT P.id, P.nickname, L.time FROM last_command L RIGHT JOIN player P ON L.account_id = P.account_id WHERE time < NOW() - INTERVAL 6 MONTH LIMIT 1000", function (err, rows, fields) {
											if (err) throw err;
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												console.log("Eliminato: " + rows[i].id + "  - " + rows[i].nickname + " inattivo dal " + rows[i].time);
												connection.query("DELETE FROM player WHERE id = " + rows[i].id + " LIMIT 1", function (err, rows, fields) {
													if (err) throw err;
												});
											}
											bot.sendMessage(message.chat.id, "Fin.", back);
										});
									};
								};
							});
						});
					}
				}
			});
		});
	};
});

bot.onText(/^\/updateSpecial/, function (message, match) {
	if (message.from.id == 20471035) {
		updateSpecialItem();
		bot.sendMessage(message.chat.id, "Ok");
	}
});

bot.onText(/^\/stopglobal$/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query('UPDATE config SET global_eventon = 0', function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(message.chat.id, "Ok");
		});
	}
});

bot.onText(/^\/endglobal$/, function (message, match) {
	if (message.from.id == 20471035) {

		// aggiorna il codice dell'impresa globale globalAchievement!! e di conseguenza anche qua sotto e classifica

		connection.query('SELECT I.id As id1, I.name As name1, I2.id As id2, I2.name As name2, I3.id As id3, I3.name As name3 FROM config C INNER JOIN item I ON C.global_item1 = I.id INNER JOIN item I2 ON C.global_item2 = I2.id INNER JOIN item I3 ON C.global_item3 = I3.id', function (err, rows, fields) {
			if (err) throw err;

			var item_1 = rows[0].name1;
			var item_2 = rows[0].name2;
			var item_3 = rows[0].name3;
			var item_1id = rows[0].id1;
			var item_2id = rows[0].id2;
			var item_3id = rows[0].id3;

			console.log(item_1, item_2, item_3, item_1id, item_2id, item_3id);

			connection.query('SELECT COUNT(DISTINCT player_id) As cnt FROM achievement_global', function (err, rows, fields) {
				if (err) throw err;

				var tot = rows[0].cnt;

				connection.query('SELECT SUM(value) As val FROM achievement_global', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Il valore attuale Ã¨ " + formatNumber(rows[0].val) + " per " + formatNumber(tot) + " persone, sicuro di chiudere l'impresa? Ricorda il messaggio e il valore del bonus", yesno).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text.toLowerCase() == "si") {
								connection.query('UPDATE player SET global_end = 0', function (err, rows, fields) {
									if (err) throw err;

									connection.query('SELECT P.nickname, P.chat_id, A.player_id, SUM(A.value) As val FROM achievement_global A INNER JOIN player P ON A.player_id = P.id WHERE P.account_id NOT IN (SELECT account_id FROM banlist) GROUP BY A.player_id ORDER BY val DESC', function (err, rows, fields) {
										if (err) throw err;

										var minValue = 2000;
										var bonusText = "+5% monete ottenute dal contributo per l'uccisione dei boss";

										var text = "";

										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											text = "";
											if (rows[i].val >= (rows[0].val / 2)) {
												addItem(rows[i].player_id, item_1id);
												text += "> " + item_1 + "\n";
											}
											if (rows[i].val >= (rows[0].val / 100)) {
												addItem(rows[i].player_id, item_2id);
												text += "> " + item_2 + "\n";
											}
											addItem(rows[i].player_id, item_3id);
											text += "> " + item_3 + "\n";

											if (rows[i].val >= minValue) {
												connection.query('UPDATE player SET global_end = 1 WHERE id = ' + rows[i].player_id, function (err, rows, fields) {
													if (err) throw err;
												});
												text += "> Bonus completamento: *" + bonusText + "*!\n";
											}

											text += "\n*Grazie per aver partecipato!*";

											bot.sendMessage(rows[i].chat_id, "Per il completamento dell'*Impresa Globale* hai ricevuto:\n" + text, mark);
										}
									});
									connection.query('(SELECT A.player_id, chat_id, nickname, SUM(A.value) As val, global_event FROM player P, achievement_global A WHERE P.id = A.player_id AND P.account_id NOT IN (SELECT account_id FROM banlist) GROUP BY A.player_id ORDER BY SUM(A.value) DESC LIMIT 100) UNION (SELECT A.player_id, chat_id, nickname, SUM(A.value) As val, global_event FROM player P, achievement_global A WHERE P.id = A.player_id AND P.account_id NOT IN (SELECT account_id FROM banlist) AND P.global_event < 5 GROUP BY A.player_id ORDER BY SUM(A.value) DESC LIMIT 100)', function (err, rows, fields) {
										if (err) throw err;
										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											connection.query('UPDATE player SET global_event = global_event+1 WHERE id = ' + rows[i].player_id, function (err, rows, fields) {
												if (err) throw err;
											});
											bot.sendMessage(rows[i].chat_id, "Inoltre per il tuo posizionamento in classifica la tua impresa globale viene conteggiata nelle statistiche!", mark);
											//console.log(rows[i].nickname + " - Punto");
										}
									});
									bot.sendMessage(message.chat.id, "Fatto!");
								});
							}
						}
					});
				});
			});
		});
	}
});

bot.onText(/^\/failglobal/, function (message, match) {
	if (message.from.id == 20471035) {

		connection.query('SELECT COUNT(DISTINCT player_id) As cnt FROM achievement_global', function (err, rows, fields) {
			if (err) throw err;

			var tot = rows[0].cnt;

			connection.query('SELECT SUM(value) As val FROM achievement_global', function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Il valore attuale Ã¨ " + formatNumber(rows[0].val) + " per " + formatNumber(tot) + " persone, sicuro di chiudere l'impresa FALLITA?", yesno).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text.toLowerCase() == "si") {

							var minValue = 500000;
							var minText = "monete da vendite";
							var text = "i tempi delle cave sono incrementati del 30%";

							connection.query('SELECT P.nickname, P.chat_id, A.player_id, SUM(A.value) As val FROM achievement_global A INNER JOIN player P ON A.player_id = P.id WHERE P.reborn > 1 AND P.account_id NOT IN (SELECT account_id FROM banlist) GROUP BY A.player_id HAVING SUM(A.value) < ' + minValue + ' ORDER BY val DESC', function (err, rows, fields) {
								if (err) throw err;
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									connection.query('UPDATE player SET global_end = 1 WHERE id = ' + rows[i].player_id, function (err, rows, fields) {
										if (err) throw err;
									});
									bot.sendMessage(rows[i].chat_id, "Per il fallimento dell'impresa e lo scarso impegno (minimo " + minValue + " " + minText + "), da questo momento fino al termine della prossima impresa " + text);
									console.log(rows[i].nickname + " - Fallito");
								}
							});

							// scommentare se conta la partecipazione di team!
							/*
							connection.query('SELECT P.nickname, P.id As player_id, DATEDIFF(CURDATE(), CAST(L.time As date)) As last_access, T.team_id FROM player P LEFT JOIN achievement_global A ON A.player_id = P.id INNER JOIN last_command L ON L.account_id = P.account_id LEFT JOIN team_player T ON P.id = T.player_id WHERE A.player_id IS NULL AND P.reborn > 1 AND T.team_id IS NOT NULL HAVING last_access >= 28', function (err, rows, fields) {
								if (err) throw err;
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									connection.query('UPDATE player SET global_end = 1 WHERE id = ' + rows[i].player_id, function (err, rows, fields) {
										if (err) throw err;
									});
									console.log(rows[i].nickname + " - Fallito extra");
								}
							});
							*/

							connection.query('UPDATE config SET global_eventon = 0, global_eventwait = 1', function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Fatto!");
							});
						}
					}
				});
			});
		});
	};
});

bot.onText(/^\/endtop$/, function (message, match) {
	if (message.from.id == 20471035) {
		bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text == "Si") {
					connection.query('SELECT id FROM dragon_top_list ORDER BY id', function (err, rows, fields) {
						if (err) throw err;
						var top_id = 0;
						var mana = 0;
						var dust = 0;
						var chest = 0;
						var item_id = 0;
						var item_name = "";
						var item_qnt = 0;
						var extra_text = "";
						var chestText = "";
						var text = "";

						var multi = 1.2;

						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							top_id = rows[i].id;
							connection.query('SELECT D.player_id, D.rank, P.chat_id FROM dragon_top_rank D, player P, dragon D2 WHERE P.id = D2.player_id AND D.player_id = P.id AND D.top_id = ' + top_id + ' ORDER BY D.rank DESC, D2.level ASC, P.id ASC', function (err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length > 0) {
									for (var j = 0, len = Object.keys(rows).length; j < len; j++) {
										if ((rows[j].rank < 12) && (this.top_id == 1)) {
											bot.sendMessage(rows[j].chat_id, "Per il tuo posizionamento nelle *Vette dei Draghi*, essendo rimasto al primo Monte e di basso rango, non hai ricevuto alcun premio aggiuntivo! La prossima volta prova ad impegnarti di piÃ¹ :(", mark);
											console.log(rows[j].rank, this.top_id, "Skip");
											continue; // per non dare altri premi
										}

										mana = Math.round(Math.pow(this.top_id, multi) * 200);
										chest = Math.round((Math.pow(this.top_id, multi) * 10) - (j * 2));
										if (chest < 0)
											chest = 0;
										dust = Math.round(rows[j].rank * (Math.pow(this.top_id, multi) * 8));

										if ((this.top_id == 3) && (j < 4)){
											item_id = 608;
											item_name = "Pass Bronzo";
											item_qnt = 2-Math.floor(j/2);
										}else if ((this.top_id == 4) && (j < 6)){
											item_id = 609;
											item_name = "Pass Argento";
											item_qnt = 3-Math.floor(j/2);
										}else if ((this.top_id == 5) && (j < 8)){
											item_id = 610;
											item_name = "Pass Oro";
											item_qnt = 4-Math.floor(j/2);
										}else{
											item_id = 0;
											item_name = "";
											item_qnt = 0;
										}

										console.log(rows[j].player_id, rows[j].rank, this.top_id, mana, dust, chest, item_name, item_qnt);

										connection.query('UPDATE event_mana_status SET mana_1 = mana_1+' + mana + ', mana_2 = mana_2+' + mana + ', mana_3 = mana_3+' + mana + ' WHERE player_id = ' + rows[j].player_id, function (err, rows, fields) {
											if (err) throw err;
										});
										addItem(rows[j].player_id, 646, dust);
										addChest(rows[j].player_id, 9, chest);
										if (item_id > 0){
											addItem(rows[j].player_id, item_id, item_qnt);
										}

										chestText = "";
										if (chest > 0){
											chestText = "\n> " + chest + " Scrigni Scaglia";
										}
										extra_text = "";
										if (item_id != 0){
											extra_text = "\n> " + item_qnt + "x " + item_name;
										}

										text = "Per il tuo posizionamento nelle *Vette dei Draghi* hai ricevuto:\n> " + mana + " Mana per tipo\n> " + dust + " unitÃ  di Polvere" + chestText + extra_text + "\n\nI premi durante le prossime stagioni potrebbero cambiare, grazie per aver giocato!";

										bot.sendMessage(rows[j].chat_id, text, mark);
									}
									connection.query('UPDATE player SET top_first = 0', function (err, rows, fields) {
										if (err) throw err;
									});
								}
							}.bind({
								top_id: top_id
							}));
						}
						bot.sendMessage(message.chat.id, "Fatto!", back);
					});
				};
			};
		});
	}
});

function market_generation() {
	var items = [];
	var rarity = [];
	var est = [];

	connection.query('DELETE FROM market_pack', function (err, rows, fields) {
		if (err) throw err;
		connection.query('SELECT id, estimate FROM item WHERE craftable = 0 AND rarity = "C" ORDER BY RAND() LIMIT 10', function (err, rows, fields) {
			if (err) throw err;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				items.push(rows[i].id);
				rarity.push(1);
				est.push(rows[i].estimate);
			}
			connection.query('SELECT id, estimate FROM item WHERE craftable = 0 AND rarity = "NC" ORDER BY RAND() LIMIT 6', function (err, rows, fields) {
				if (err) throw err;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					items.push(rows[i].id);
					rarity.push(2);
					est.push(rows[i].estimate);
				}
				connection.query('SELECT id, estimate FROM item WHERE craftable = 0 AND rarity = "R" ORDER BY RAND() LIMIT 5', function (err, rows, fields) {
					if (err) throw err;
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						items.push(rows[i].id);
						rarity.push(3);
						est.push(rows[i].estimate);
					}
					connection.query('SELECT id, estimate FROM item WHERE craftable = 0 AND rarity = "UR" ORDER BY RAND() LIMIT 4', function (err, rows, fields) {
						if (err) throw err;
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							items.push(rows[i].id);
							rarity.push(4);
							est.push(rows[i].estimate);
						}
						connection.query('SELECT id, estimate FROM item WHERE craftable = 0 AND rarity = "L" ORDER BY RAND() LIMIT 3', function (err, rows, fields) {
							if (err) throw err;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								items.push(rows[i].id);
								rarity.push(5);
								est.push(rows[i].estimate);
							}
							connection.query('SELECT id, estimate FROM item WHERE craftable = 0 AND rarity = "E" ORDER BY RAND() LIMIT 2', function (err, rows, fields) {
								if (err) throw err;
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									items.push(rows[i].id);
									rarity.push(6);
									est.push(rows[i].estimate);
								}

								for (var i = 0, len = items.length; i < len; i++) {

									est[i] = Math.round(getRandomArbitrary(est[i] - (est[i] * 0.2), est[i]));

									connection.query('INSERT INTO market_pack (pack_id, item_id, price) VALUES (' + rarity[i] + ',' + items[i] + ',' + est[i] + ')', function (err, rows, fields) {
										if (err) throw err;
									});
								}
								console.log("Mercato a rotazione aggiornato");

								connection.query('UPDATE player SET market_pack = 0', function (err, rows, fields) {
									if (err) throw err;
								});
							});
						});
					});
				});
			});
		});
	});
}

bot.onText(/^\/refreshEstimate/i, function (message) {
	if (message.from.id == 20471035) {

		connection.query('UPDATE item SET estimate = value WHERE estimate < value', function (err, rows, fields) {
			if (err) throw err;

			connection.query('SELECT id, name, estimate FROM item', function (err, rows, fields) {
				if (err) throw err;

				var id = 0;
				var est = 0;
				var n = "";

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					id = rows[i].id;
					est = rows[i].estimate;
					n = rows[i].name;

					connection.query('SELECT DISTINCT(from_id), price FROM market_direct_history WHERE time BETWEEN date_sub(NOW(),INTERVAL 1 WEEK) AND NOW() AND price != (SELECT value FROM item WHERE id = ' + id + ') AND item_id = ' + id + ' AND type = 2', function (err, rows, fields) {
						if (err) throw err;
						var price = 0;
						var arr = [];
						if (Object.keys(rows).length > 1) {
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								if ((rows[i].price < (this.est) * 3) && (rows[i].price > (this.est / 3)))
									arr.push(rows[i].price);
							}

							if (arr.length > 1){
								price = estimate(arr);

								if (!isNaN(price)) {
									connection.query('UPDATE item SET estimate = ' + price + ' WHERE id = ' + this.id, function (err, rows, fields) {
										if (err) throw err;
									});
									console.log("Estimate per " + this.n + ": " + price);
								} else {
									console.log("Estimate per " + this.n + ": scartato per isNaN");
								}
							}else{
								console.log("Estimate per " + this.n + ": scartato, pochi valori");
							}
						}
					}.bind({
						id: id,
						est: est,
						n: n
					}));
				}
			});
		});
	};
});

bot.onText(/^\/miner/, function (message, match) {

	if (!checkSpam(message)) {
		return;
	}

	if (message.from.id != 20471035) {
		bot.sendMessage(message.chat.id, "Presto disponibile");
		return;
	}

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		request('https://api.crypto-loot.com/user/balance?secret=' + config.cltoken + '&name=lootminer' + player_id, function(err, res, body) {
			if (err) throw err;

			var rate = 102400;
			var value = 1800;
			var json = JSON.parse(body);
			var tot = json.total;
			console.log("Miner:", json.total, json.balance);

			connection.query('SELECT total_hash FROM miner WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				var gain = 0;

				if (Object.keys(rows).length == 0){
					connection.query('INSERT INTO miner (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Il tuo profilo Ã¨ stato creato! Usa il comando /miner per riaccere alla funzione.");
					});
					return;
				}

				if (tot > rows[0].total_hash){
					gain = tot-rows[0].total_hash;
					bot.sendMessage(message.chat.id, "Hai ottenuto *" + Math.floor(gain/rate*100)/100 + " LBH* dall'ultimo accesso!", mark);
				}
				connection.query('UPDATE miner SET total_hash = ' + tot + ', hash = hash+' + gain + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					connection.query('SELECT hash FROM miner WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						var my_lbh = rows[0].hash/rate;
						connection.query('SELECT SUM(hash) As tot FROM miner', function (err, rows, fields) {
							if (err) throw err;
							var lbh = rows[0].tot/rate;

							var iKeys = [];
							iKeys.push([{
								text: "Vai al Miner!",
								url: "http://fenixweb.net/miner.php?user=" + player_id
							}]);

							bot.sendMessage(message.chat.id, "Benvenuto in Loot Miner!\nSono stati accumulati fin ora <b>" + Math.floor(lbh*1000)/1000 + " LBH</b> (dei quali <b>" + Math.floor(my_lbh*1000)/1000 + "</b> prodotti da te), puoi contribuire ad ottenerne altri cliccando sul pulsante sotto.\nUna volta raggiunti almeno <i>" + value + "</i> LBH, tutti i partecipanti otterrano 1 ðŸŒ•!", {
								parse_mode: 'HTML',
								disable_web_page_preview: true,
								reply_markup: {
									inline_keyboard: iKeys
								}
							});

							if (lbh >= 1800)
								shareMoon();
						});
					});
				});
			});
		});
	});
});

function shareMoon(){

	var rate = 102400;
	var value = 1800;
	var players = [];
	var chats = [];

	connection.query('SELECT player_id, hash, chat_id FROM miner, player WHERE player.id = miner.player_id AND hash > 0 ORDER BY miner.id', function (err, rows, fields) {
		if (err) throw err;

		var total = 0;
		var last = 0;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			total += rows[i].hash;
			players.push(rows[i].player_id);
			chats.push(rows[i].chat_id);
			console.log("Utente:", rows[i].hash, rows[i].player_id);
			if (total >= (rate*value)){
				if (total > (rate*value))
					last = total-(rate*value);
				console.log("Scarto:", last);
				break;
			}
		}

		for (var i = 0; i < players.length; i++) {
			connection.query('UPDATE miner SET hash = 0 WHERE player_id = ' + players[i], function (err, rows, fields) {
				if (err) throw err;
			});
			if (i == players.length-1){
				connection.query('UPDATE miner SET hash = ' + last + ' WHERE player_id = ' + players[i], function (err, rows, fields) {
					if (err) throw err;
				});
			}
			/*
			bot.sendMessage(chats[i], "Grazie al tuo contributo per il Loot Miner hai ottenuto 1 ðŸŒ•!");
			connection.query('UPDATE player SET moon_coin = moon_coin+1 WHERE id = ' + players[i], function (err, rows, fields) {
				if (err) throw err;
			});
			*/
		}
	});
}

bot.onText(/^\/comandi/, function (message, match) {
	if (message.from.id == 20471035) {
		bot.sendMessage(message.chat.id, "Lista comandi\n" +
						"/ban nick motivo\n" +
						"/unban nick\n" +
						"/marketban nick\n" +
						"/setwarn nick n\n" +
						"/setmsg messaggio\n" +
						"/save (memorizza gli attivi)\n" +
						"/active (stampa gli attivi)\n" +
						"/festival (cambia oggetto manualmente)\n" +
						"/fixboss\n" +
						"/spboss teamid (spawn boss)\n" +
						"/getid nick\n" +
						"/lacrima nick\n" +
						"/dona nick n\n" +
						"/dai_scrigni nick,nome,qnt\n" +
						"/dai_ogg nick,ogg,qnt\n" +
						"/soldi nick,qnt\n" +
						"/dai_gemme nick,qnt\n" +
						"/dai_moon nick,qnt\n" +
						"/key (aggiorna tastiere)\n" +
						"/eventon /eventoff\n" +
						"/cmd backuplist/backup/reboot\n" +
						"/accountid nick\n" +
						"/genmarket (rigenera mercante pazzo)\n" +
						"/endglobal (fine globale)\n" +
						"/failglobal (fallimento globale)\n" +
						"/manutenzione testo (msg agli attivi < 24h)");
	} else {
		bot.sendMessage(message.chat.id, "Piacerebbe :D");
	}
});

bot.onText(/^\/marketban (.+)/, function (message, match) {
	match[1] = match[1].replace("@", "");
	if (message.from.id == 20471035) {
		connection.query('SELECT id, market_ban, nickname, id, account_id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non ho trovato nessun utente con quel nickname.");
				return;
			}

			if (rows[0].market_ban == 0) {
				connection.query('UPDATE player SET market_ban = 1 WHERE id = ' + rows[0].id, function (err, rows, fields) {
					if (err) throw err;
				});

				bot.sendMessage(message.chat.id, rows[0].nickname + " bannato dal mercato.");
			} else {
				connection.query('UPDATE player SET market_ban = 0 WHERE id = ' + rows[0].id, function (err, rows, fields) {
					if (err) throw err;
				});

				bot.sendMessage(message.chat.id, rows[0].nickname + " sbannato dal mercato.");
			}
		});
	};
});

bot.onText(/^\/sendmsg/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query('DELETE FROM global_msg', function (err, rows, fields) {
			if (err) throw err;
			connection.query('ALTER TABLE global_msg AUTO_INCREMENT=1', function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('INSERT INTO global_msg (chat_id) SELECT P.chat_id FROM last_command L, player P WHERE L.account_id = P.account_id AND L.time > NOW() - INTERVAL 2 WEEK AND P.global_msg = 1 AND P.account_id NOT IN (SELECT account_id FROM banlist)', function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Inserite " + rows.affectedRows + " voci");
			});
		});
	}
});

bot.onText(/^\/setmsg (.+)/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query('UPDATE config SET global_msg = "' + match[1] + '"', function (err, rows, fields) {
			if (err) throw err;
			connection.query('SELECT global_msg FROM config', function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Messaggio impostato, ora 'ALTER TABLE global_msg AUTO_INCREMENT=1' poi /sendmsg");
				bot.sendMessage(message.chat.id, rows[0].global_msg, no_preview_html);
			});
		});
	}
});

bot.onText(/^\/getmsg/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query('SELECT global_msg FROM config', function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(message.chat.id, rows[0].global_msg);
		});
	}
});

bot.onText(/^\/manutenzione (.+)/, function (message, match) {
	if (message.from.id == 20471035) {

		if (match[1] == undefined){
			bot.sendMessage(message.chat.id, "Messaggio non impostato (/manutenzione testo)");
			return;
		}

		connection.query('SELECT chat_id FROM last_command, player WHERE last_command.account_id = player.account_id AND TIMESTAMPDIFF(HOUR, time, NOW()) < 24 AND player.account_id NOT IN (SELECT account_id FROM banlist) ORDER BY time ASC', function (err, rows, fields) {
			if (err) throw err;

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				bot.sendMessage(rows[i].chat_id, "*Avviso*\n" + match[1], mark);
			}

			bot.sendMessage(message.chat.id, "Inviato a " + Object.keys(rows).length + " utenti");
		});
	}
});

bot.onText(/^\/setwarn ([^\s]+) (.+)/, function (message, match) {
	if (message.from.id == 20471035) {
		connection.query('SELECT nickname, id, account_id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non ho trovato nessun utente con quel nickname.");
				return;
			}
			connection.query('UPDATE player SET market_warn = ' + match[2] + ' WHERE id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
			});
			bot.sendMessage(message.chat.id, rows[0].nickname + " impostato a " + match[2] + " warn");
		});
	};
});

bot.onText(/^\/ban ([^\s]+) (.+)|^\/ban/, function (message, match) {
	if (message.from.id == 20471035) {

		if (match[1] == undefined){
			bot.sendMessage(message.chat.id, "Sintassi: /ban nickname motivo");
			return;
		}

		connection.query('SELECT nickname, id, account_id FROM player WHERE nickname = "' + match[1].replace("@", "") + '"', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non ho trovato nessun utente con quel nickname.");
				return;
			}

			connection.query('INSERT INTO banlist (account_id, reason) VALUES (' + rows[0].account_id + ',"' + match[2] + '")', function (err, rows, fields) {
				if (err) throw err;
			});

			connection.query('DELETE FROM public_shop WHERE player_id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE player SET market_ban = 1, boss_id = NULL WHERE id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('DELETE FROM team_player WHERE player_id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE token SET token = NULL, status = "REVOKED" WHERE player_id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('DELETE FROM mission_team_party_player WHERE player_id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
			});

			bot.sendMessage(message.chat.id, rows[0].nickname + " (" + rows[0].account_id + ") bannato.");
		});
	};
});


bot.onText(/^\/unban (.+)|^\/unban/, function (message, match) {
	if (message.from.id == 20471035) {

		if (match[1] == undefined){
			bot.sendMessage(message.chat.id, "Sintassi: /unban nickname");
			return;
		}

		var nickname = match[1].replace("@", "");
		connection.query('SELECT nickname, account_id FROM player WHERE nickname = "' + nickname + '"', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non ho trovato nessun utente con quel nickname.");
				return;
			}

			connection.query('UPDATE player SET market_ban = 0 WHERE account_id = ' + rows[0].account_id, function (err, rows, fields) {
				if (err) throw err;
			});

			connection.query('DELETE FROM banlist WHERE account_id = ' + rows[0].account_id, function (err, rows, fields) {
				if (err) throw err;
			});
			bot.sendMessage(message.chat.id, rows[0].nickname + " sbannato!");
		});
	};
});

bot.onText(/^\/save/, function (message, match) {
	if (message.from.id != 20471035) {
		return;
	}
	saveActive();
	bot.sendMessage(message.chat.id, "Salvata");
});

bot.onText(/^\/festival/, function (message, match) {
	if (message.from.id != 20471035) {
		return;
	}
	reloadFestival(1);
	bot.sendMessage(message.chat.id, "Fatto!");
});

bot.onText(/^\/active/, function (message, match) {
	if (message.from.id != 20471035) {
		return;
	}
	connection.query('SELECT count, time FROM active_history ORDER BY time DESC LIMIT 50', function (err, rows, fields) {
		if (err) throw err;

		var text = "";
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			text += rows[i].count + " -> " + toDate("it", rows[i].time) + "\n";
		}
		bot.sendMessage(message.chat.id, text);
	});
});

function saveActive() {
	var d = new Date();
	var today = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate());
	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

	connection.query('SELECT COUNT(*) As active FROM `last_command` WHERE time LIKE "' + today + '%"', function (err, rows, fields) {
		if (err) throw err;
		var act = rows[0].active;

		connection.query('INSERT INTO active_history (count, time) VALUES (' + act + ',"' + long_date + '")', function (err, rows, fields) {
			if (err) throw err;
			console.log("AttivitÃ  giocatori salvatata! --> " + act + " <--");
		});
	});
}

bot.onText(/\/start (.+)|\/start/i, function (message, match) {
	if (message.from.username == undefined) {
		bot.sendMessage(message.chat.id, "Devi impostare un username su Telegram per poter giocare, puoi farlo tramite le *impostazioni* dell'applicazione. Una volta impostato, usa di nuovo il comando /start, oppure /start CODICEINVITO nel caso di un link invito, altrimenti non riceverai il bonus invito.", mark);
		return;
	}

	var invite = match[1];
	if (invite != undefined)
		console.log("Codice invito: " + invite);

	var code = "Non disponibile";

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			connection.query('UPDATE player SET chat_id = ' + message.chat.id + ' WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Sei giÃ  registrato! Se hai qualche problema, segnala all'amministratore", back);
			});
			return;
		}
		connection.query('SELECT * FROM player WHERE account_id = ' + message.from.id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				bot.sendMessage(message.chat.id, "Questo id Ã¨ giÃ  registrato, se hai cambiato nome utente usa /migrazione. Grazie!", back);
				return;
			}

			var rnd_code = makeid();
			connection.query('SELECT nickname, id, chat_id FROM player WHERE invite_code = "' + invite + '"', function (err, rows, fields) {
				if (err) throw err;

				var invite = "";
				var money = 10000;	// Nuovo utente
				var gems = 1;
				if (Object.keys(rows).length > 0) {
					var d = new Date();
					var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

					connection.query('INSERT INTO referral_list (new_player, player_id, new_player_nick, player_nick, time) VALUES ((SELECT MAX(id) FROM player)+1, ' + rows[0].id + ',"' + message.from.username + '", "' + rows[0].nickname + '", "' + long_date + '")', function (err, rows, fields) {
						if (err) throw err;
					});

					invite = " (" + rows[0].nickname + ")";

					bot.sendMessage(rows[0].chat_id, "Un utente si Ã¨ registrato con il tuo link invito, dopo che avrÃ  completato alcune missioni otterrai monete e ðŸ’Ž! Inoltre riceverai un premio cospicuo quando il giocatore raggiungerÃ  la varie rinascite (fino alla terza)!");
					bot.sendMessage(message.chat.id, "Ti sei registrato con un link invito, hai ricevuto " + formatNumber(money)  + " Â§  e " + gems + " ðŸ’Ž!");
				}
				connection.query('INSERT INTO player (id, exp, account_id, nickname, chat_id, money, gems, invite_code, life, total_life) VALUES (DEFAULT, 10, ' + message.from.id + ', "' + message.from.username + '", ' + message.chat.id + ', ' + money + ', ' + gems + ',"' + rnd_code + '", 10, 10)', function (err, rows, fields) {
					if (err) throw err;

					bot.sendMessage("@lnotify", "#Registrazione: " + message.from.username + " (" + message.from.id + ") " + invite);

					printStart(message);
				});
			});
		});
	});
});

bot.onText(/\/fixboss/, function (message) {
	fixBoss(-1);
	bot.sendMessage(message.chat.id, "Fatto!");
});

bot.onText(/\/fixdragon (.+)/, function (message, match) {
	connection.query('SELECT id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		connection.query('UPDATE dragon_top_status SET is_dummy = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(message.chat.id, "Fatto!");
		});
	});
});

bot.onText(/\/cleanDb/, function (message, match) {
	connection.query('SELECT id, name FROM team', function (err, rows, fields) {
		if (err) throw err;
		var newname = "";
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			newname = "";
			if (re4.test(rows[i].name) == false) {
				newname = rows[i].name.replaceAll("[^a-zA-Z0-9Ã Ã¨Ã¬Ã²Ã¹ ]", "").trim();
				console.log(rows[i].name + " -> " + newname);
				connection.query('UPDATE team SET name = "' + newname + '" WHERE id = ' + rows[i].id, function (err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
});

function fixBoss(team_id) {
	if (team_id == -1){
		connection.query('UPDATE boss_team SET life = 1 WHERE killedby IS NULL AND life <= 0', function (err, rows, fields) {
			if (err) throw err;
		});
	}else{
		connection.query('UPDATE boss_team SET life = 1 WHERE killedby IS NULL AND life <= 0 AND team_id = ' + team_id, function (err, rows, fields) {
			if (err) throw err;
		});
	}
}

function dailyChest(message, player_id) {
	var rand = 0;
	var chest_id = 0;

	rand = Math.round((Math.random() * 99) + 1);
	if ((rand <= 100) && (rand >= 50)) { //50%
		chest_id = 1;
	} else if ((rand < 50) && (rand >= 20)) { //30%   
		chest_id = 2;
	} else if ((rand < 20) && (rand >= 10)) { //10%
		chest_id = 3;
	} else if ((rand < 10) && (rand >= 0)) { //10%
		chest_id = 4;
	} else {
		console.log("Errore condizioni, random: " + rand);
	}

	connection.query('SELECT COUNT(*) As num FROM daily_chest WHERE player_id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		if (rows[0].num == 0) {
			connection.query('SELECT name, rarity_shortname FROM chest WHERE id = ' + chest_id, function (err, rows, fields) {
				if (err) throw err;
				addChest(player_id, chest_id);
				connection.query('INSERT INTO daily_chest (player_id, chest_id) VALUES (' + player_id + ',' + chest_id + ')', function (err, rows, fields) {
					if (err) throw err;
				});
				bot.sendMessage(message.chat.id, "Iniziando la prima missione della giornata, hai ricevuto lo scrigno giornaliero: *" + rows[0].name + "* (" + rows[0].rarity_shortname + ")!", mark);
				setAchievement(message.chat.id, player_id, 39, 1);
			});
		}
	});
};

bot.onText(/Donazioni|Monete Lunari/i, function (message) {
	var kb = {
		parse_mode: "HTML",
		disable_web_page_preview: true,
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Fai una Donazione!"], ["Lista Donatori"], ["Torna al menu"]]
		}
	};

	var date = new Date();

	connection.query("SELECT ROUND(SUM(amount)) As tot FROM donation_history WHERE MONTH(time) = " + (date.getMonth()+1), function (err, rows, fields) {
		if (err) throw err;

		if (rows[0].tot == null)
			rows[0].tot = 0;

		var max = 85;
		var att = rows[0].tot;
		var progress = calcDragonLife(att, max);

		bot.sendMessage(message.chat.id, "<b>Donazioni</b>\n\n<i>Magari non tutti voi sapete che mantenere il server di Loot Bot ha un costo che deve essere saldato ogni mese, non ci sono pubblicitÃ , nÃ¨ acquisti pay2win, nÃ¨ sponsorizzazioni che contribuiscono al sostentamento. PerciÃ² tu nel tuo piccolo puoi aiutare donando attraverso il link sotto, qualsiasi cifra puÃ² aiutare. Per motivarti un po' (lo so che ti stai chiedendo: 'e io che ci guadagno?') oltre al fatto che saprai che hai aiutato ad estendere di un mese questo passatempo, riceverai anche una Moneta Lunare per ogni euro donato.\nNon Ã¨ niente di obbligatorio e niente di troppo vantaggioso, anzi. PerÃ² purtroppo non sempre si riesce a mantenere tutto in modo gratuito. A me personalmente farebbe molto piacere la cosa, pensaci!</i>\n\nLink PayPal: https://www.paypal.me/EdoardoCortese\nIndirizzo Bitcoin: <code>3ChwKyXG4fo8NDAdQwJERUty78qumeyn91</code>\n\nRicordati di specificare il nickname, se hai problemi contattami in privato (@fenix45).\nIn caso di abbandono del gioco o casi simili, la donazione <i>non verrÃ </i> rimborsata.\n\nProgresso per il mese attuale: " + progress + " " + att + " â‚¬ / " + max + " â‚¬", kb);
	});
});

bot.onText(/Fai una Donazione!/i, function (message) {

	var iKeys = [];
	iKeys.push([{
		text: "Paypal",
		url: "https://www.paypal.me/EdoardoCortese"
	}]);
	iKeys.push([{
		text: "2 â‚¬",
		callback_data: "pay:2.00"
	},{
		text: "4 â‚¬",
		callback_data: "pay:4.00"
	}]);
	iKeys.push([{
		text: "10 â‚¬",
		callback_data: "pay:10.00"
	},{
		text: "20 â‚¬",
		callback_data: "pay:20.00"
	}]);
	iKeys.push([{
		text: "50 â‚¬",
		callback_data: "pay:50.00"
	},{
		text: "100 â‚¬",
		callback_data: "pay:100.00"
	}]);

	bot.sendMessage(message.chat.id, "Seleziona l'importo della tua donazione, se il pagamento avviene tramite Telegram attraverso il servizio Stripe le ðŸŒ• vengono accreditate immediatamente. Nel caso di Paypal potrebbero subire ritardi di qualche ora.\n<b>RICORDA DI SPECIFICARE IL NICKNAME SU PAYPAL!</b>", {
		parse_mode: 'HTML',
		disable_web_page_preview: true,
		reply_markup: {
			inline_keyboard: iKeys
		}
	});
});

Array.prototype.randomElement = function () {
	return this[Math.floor(Math.random() * this.length)]
}

bot.on('callback_query', function (message) {

	if (!checkSpam(message.message)) {
		return;
	}

	var text = message.data;
	var func = text.split(":")[0];
	var param = text.split(":")[1];

	connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			bot.answerCallbackQuery(message.id, {text: 'Registrati per utilizzare questa funzione!'});
			return;
		}

		var player_id = rows[0].id;
		var chat_id = rows[0].chat_id;

		if (func == "pay") {
			var payload = player_id + Date.now() + param;
			var prices = [{
				label: "Donazione",
				amount: parseInt(param.replace(".", ""))
			}];
			connection.query('INSERT INTO payments (player_id, payload, amount, status) VALUES (' + player_id + ', "' + payload + '", ' + param + ', "WAIT")', function (err, rows, fields) {
				if (err) throw err;
				bot.sendInvoice(chat_id, "Donazione", "Donazione di " + param + "â‚¬", payload, "350862534:LIVE:NTg4MzAxNGMzMzI5", "pay", "EUR", prices);
			});
		}else if (func == "team_miss"){

			var part_id = text.split(":")[2];

			connection.query('SELECT T.part_id, T.team_id, T.party_id, T.assigned_to, T.report_id, P.answ_id FROM mission_team_party_player P, mission_team_party T WHERE P.party_id = T.party_id AND P.team_id = T.team_id AND P.player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					bot.answerCallbackQuery(message.id, {text: 'Errore'});
					return;
				}

				var team_id = rows[0].team_id;
				var party_id = rows[0].party_id;
				var assigned_to = rows[0].assigned_to;
				var report_id = rows[0].report_id;

				if (rows[0].part_id != part_id){
					bot.answerCallbackQuery(message.id, {text: 'Parte di incarico giÃ  completata!'});
					return;
				}

				if (param != "update"){
					if (rows[0].answ_id > 0){
						bot.answerCallbackQuery(message.id, {text: 'Hai giÃ  votato!'});
						param = "update";
						return;
					}
				}

				connection.query('SELECT COUNT(id) As cnt FROM mission_team_party_player P WHERE team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
					if (err) throw err;
					var party_cnt = rows[0].cnt;

					connection.query('SELECT question, answ1, answ2, answ3, pnt1, pnt2, pnt3, report1, report2, report3 FROM mission_team_list_part WHERE list_id = ' + assigned_to + ' AND part_id = ' + part_id, function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							bot.answerCallbackQuery(message.id, {text: 'Errore'});
							return;
						}

						var question = rows[0].question;
						var answ1 = rows[0].answ1;
						var answ2 = rows[0].answ2;
						var answ3 = rows[0].answ3;
						var pnt1 = rows[0].pnt1;
						var pnt2 = rows[0].pnt2;
						var pnt3 = rows[0].pnt3;
						var report1 = rows[0].report1;
						var report2 = rows[0].report2;
						var report3 = rows[0].report3;

						var iKeys = [];
						iKeys.push([{
							text: "Aggiorna",
							callback_data: "team_miss:update:" + part_id
						}]);

						if (param != "update"){
							connection_sync.query('UPDATE mission_team_party_player SET answ_id = ' + param + ' WHERE player_id = ' + player_id);
						}

						connection.query('SELECT answ_id FROM mission_team_party_player WHERE team_id = ' + team_id + ' AND party_id = ' + party_id + ' AND answ_id != 0', function (err, rows, fields) {
							if (err) throw err;

							var text = "\n\nScelte del tuo party:\n";
							var val1 = 0;
							var val2 = 0;
							var val3 = 0;
							var valmax = 0;
							var len = Object.keys(rows).length;
							for (var i = 0; i < len; i++) {
								if (rows[i].answ_id == 1)
									val1++;
								else if (rows[i].answ_id == 2)
									val2++;
								else if (rows[i].answ_id == 3)
									val3++;
							}

							if ((val1 > val2) && (val1 > val3)){
								valmax = 1;
							}else if ((val2 > val1) && (val2 > val3)){
								valmax = 2;
							}else if ((val3 > val2) && (val3 > val1)){
								valmax = 3;
							}

							var isRandom = 0;

							if (valmax == 0){
								if ((val1 == val2) && (val2 == val3)){
									valmax = [1,2,3].randomElement();
								}else if (val1 == val2){
									valmax = [1,2].randomElement();
								}else if (val1 == val3){
									valmax = [1,3].randomElement();
								}else if (val2 == val3){
									valmax = [2,3].randomElement();
								}else{
									valmax = [1,2,3].randomElement();
								}
								isRandom = 1;
							}

							var choice = "";
							var choiceNum = 0;
							if (valmax == 1){
								text += "*" + answ1 + " (" + Math.round(val1*100/len) + "%)*\n";
							}else{
								text += answ1 + " (" + Math.round(val1*100/len) + "%)\n";
							}
							if (valmax == 2){
								text += "*" + answ2 + " (" + Math.round(val2*100/len) + "%)*\n";
							}else{
								text += answ2 + " (" + Math.round(val2*100/len) + "%)\n";
							}
							if (valmax == 3){
								text += "*" + answ3 + " (" + Math.round(val3*100/len) + "%)*\n";
							}else{
								text += answ3 + " (" + Math.round(val3*100/len) + "%)\n";
							}

							if (valmax == 1){
								choice = answ1;
								choiceNum = val1;
							}else if (valmax == 2){
								choice = answ2;
								choiceNum = val2;
							}else{
								choice = answ3;
								choiceNum = val3;
							}

							text += "\nVoti: " + len + "/" + party_cnt;

							connection.query('SELECT text FROM mission_team_report WHERE report_id = ' + report_id + ' AND part_id = ' + (part_id-1) + ' ORDER BY id DESC', function (err, rows, fields) {
								if (err) throw err;

								var last_answer = "";
								if (Object.keys(rows).length > 0){
									last_answer = capitalizeFirstLetter(rows[0].text);
								}
								question = question.replace("%casuale%", "qualcuno");
								var newtext = "*Incarico in corso*\n\n_" + last_answer + question + "_" + text;
								var checktext = newtext.replaceAll("[\*\_]", "").trim();
								if (message.message.text != checktext){
									bot.editMessageText(newtext, {
										chat_id: message.message.chat.id,
										message_id: message.message.message_id,
										parse_mode: 'Markdown',
										reply_markup: {
											inline_keyboard: iKeys
										}
									});
									bot.answerCallbackQuery(message.id, {text: 'Aggiornato'});
								}else{
									bot.answerCallbackQuery(message.id, {text: 'Nessuna novitÃ '});
								}
							});

							if ((len >= party_cnt) && (param != "update")){

								console.log("Scelte completate per team " + team_id + ", party " + party_id);

								connection.query('SELECT duration, parts FROM mission_team_list WHERE id = ' + assigned_to, function (err, rows, fields) {
									if (err) throw err;

									var duration = rows[0].duration;
									var total_parts = rows[0].parts;

									var d = new Date();
									d.setSeconds(d.getSeconds() + duration);
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
									var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

									connection.query('UPDATE mission_team_party SET mission_time_end = "' + long_date + '" WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT player_id, player.chat_id FROM mission_team_party_player, player WHERE mission_team_party_player.player_id = player.id AND team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
											if (err) throw err;

											var txt = "proseguite l'incarico fino alle " + short_date + "!";
											var randomText = "";
											if (part_id == total_parts)
												txt = "attendete l'assegnazione delle ricompense alle " + short_date + "!";
											if (isRandom)
												randomText = " (in modo casuale tra le scelte a pari merito)";
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												bot.sendMessage(rows[i].chat_id, "La decisione presa Ã¨ stata _" + choice + "_ da parte di " + choiceNum + " membri del party" + randomText + ", " + txt, mark);
											}

											connection.query('UPDATE mission_team_party SET wait = 0 WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
												if (err) throw err;
											});

											var paramPnt = 0;
											var paramText = "";
											if (valmax == 1){
												paramPnt = pnt1;
												paramText = report1;
											}else if (valmax == 2){
												paramPnt = pnt2;
												paramText = report2;
											}else if (valmax == 3){
												paramPnt = pnt3;
												paramText = report3;
											}

											if (part_id == 1){
												connection.query('SELECT MAX(report_id) As mx FROM mission_team_report', function (err, rows, fields) {
													if (err) throw err;

													var maxid = 1;
													if (rows[0].mx != null)
														maxid = parseInt(rows[0].mx)+1;

													connection.query('INSERT INTO mission_team_report (report_id, party_id, team_id, part_id, answ_id, pnt, text) VALUES (' + maxid + ', ' + party_id + ', ' + team_id + ', ' + part_id + ', ' + valmax + ', ' + paramPnt + ',"' + paramText + '")', function (err, rows, fields) {
														if (err) throw err;
														connection.query('UPDATE mission_team_party SET report_id = ' + maxid + ' WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
															if (err) throw err;
														});
													});
												});
											}else{
												connection.query('INSERT INTO mission_team_report (report_id, party_id, team_id, part_id, answ_id, pnt, text) VALUES (' + report_id + ', ' + party_id + ', ' + team_id + ', ' + part_id + ', ' + valmax + ', ' + paramPnt + ',"' + paramText + '")', function (err, rows, fields) {
													if (err) throw err;
												});
											}
										});
									});
								});
							}
						});
					});
				});
			});
		}
	});
});

bot.onText(/Donatori/i, function (message) {
	var top = "";
	connection.query('SELECT nickname, donation FROM player WHERE donation > 0 ORDER BY donation DESC', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			var c = 1;
			for (var i = 0, len = Object.keys(rows).length - 1; i < len; i++) {
				top += c + "Â° " + rows[i].nickname + " (" + rows[i].donation + " â‚¬)\n";
				if (rows[i].donation != rows[i + 1].donation)
					c++;
			}
			top += c + "Â° " + rows[Object.keys(rows).length - 1].nickname + " (" + rows[Object.keys(rows).length - 1].donation + " â‚¬)\n";
		} else {
			top = "Nessuna donazione :(\n";
		}
		bot.sendMessage(message.chat.id, "<b>Top donatori:</b>\n" + top, back_html);
	});
});

bot.onText(/avvEstraz/, function (message) {
	if (message.from.id == 20471035) {
		bot.sendMessage("@EstrazioniLootteria", "L'estrazione inizierÃ  a breve!");
		bot.sendMessage(message.chat.id, "Inviato");
	};
});

bot.onText(/fineEstraz/, function (message) {
	if (message.from.id == 20471035) {
		var kb = {
			parse_mode: "Markdown",
			disable_web_page_preview: true,
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Scrigno di Consolazione"], ["Torna al menu"]]
			}
		};

		connection.query('SELECT player.nickname, player.id, player.chat_id FROM event_lottery_coins, player WHERE event_lottery_coins.player_id = player.id GROUP BY player_id', function (err, rows, fields) {
			if (err) throw err;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				bot.sendMessage(rows[i].chat_id, "*Lootteria*: L'estrazione Ã¨ terminata! Usa il pulsante sotto per ricevere uno scrigno di consolazione!\n(Puoi anche scrivere Scrigno di Consolazione)", kb);
			}
			bot.sendMessage(message.chat.id, "Notifica inviata a " + Object.keys(rows).length + " utenti");
		});
	};
});

bot.onText(/Scrigno di Consolazione/i, function (message) {
	connection.query('SELECT id, holiday FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var date = new Date();

		connection.query('SELECT extracted FROM event_lottery_prize WHERE day >= ' + date.getDay() + ' ORDER BY id DESC', function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].extracted == 0) {
				bot.sendMessage(message.chat.id, "L'estrazione Ã¨ in corso!", back)
				return;
			}

			connection.query('SELECT id FROM event_lottery_coins WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Non hai partecipato alla lotteria oppure hai vinto qualcosa durante l'estrazione.", back);
					return;
				}

				var chest_id = 0;
				var chestName = "";
				switch (date.getDay()) {
					case 6:
						chestName = "Scrigno di Diamante";
						chest_id = 4;
						break;
					case 0:
						chestName = "Scrigno Leggendario";
						chest_id = 5;
						break;
					default:
						bot.sendMessage(message.chat.id, "Non Ã¨ piÃ¹ possibile riscattare il premio di consolazione", back);
						return;
						break;
				}

				bot.sendMessage(message.chat.id, "Riscattare lo Scrigno?", yesno).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text.toLowerCase() == "si") {
							addChest(player_id, chest_id);

							bot.sendMessage(message.chat.id, "Hai ricevuto *" + chestName + "* come premio di consolazione!", back);

							connection.query('DELETE FROM event_lottery_coins WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								console.log(player_id + " consolazione riscattata");
							});
						};
					};
				});
			});
		});
	});
});

function estrazione() {

	var date = new Date();

	connection.query('SELECT E.id, item_id, I.name As item_name, money, chest_id, exp, C.name As chest_name, gems, mana, extracted, quantity ' +
					 'FROM event_lottery_prize As E LEFT JOIN item As I ON E.item_id = I.id LEFT JOIN chest As C ON E.chest_id = C.id ' +
					 'WHERE E.extracted = 0 AND E.day >= ' + date.getDay(),
					 function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			console.log("Non ci sono piÃ¹ premi");
			autoEstrazione = 0;

			bot.sendMessage("@EstrazioniLootteria", "Estrazioni terminate!");
			return;
		}

		var ext_id = rows[0].id;

		var name = "";
		var type = "";
		var item_id = 0;
		var chest_id = 0;
		var money = 0;
		var exp = 0;
		var mana = 0;
		var quantity = 1;
		var gems = 0;

		if ((rows[0].item_id != 0) && (rows[0].item_id != null)) {
			type = "item";
			name = rows[0].item_name;
			item_id = rows[0].item_id;
			quantity = rows[0].quantity;
		} else if (rows[0].money != 0) {
			type = "money";
			name = rows[0].money + " Â§";
			money = rows[0].money;
		} else if ((rows[0].chest_id != 0) && (rows[0].item_id != null)) {
			type = "chest";
			name = rows[0].chest_name;
			chest_id = rows[0].chest_id;
			quantity = rows[0].quantity;
		} else if (rows[0].gems != 0) {
			gems = rows[0].gems;
			type = "gems";
			name = rows[0].gems + " ðŸ’Ž";
		} else if (rows[0].exp != 0) {
			type = "exp";
			name = rows[0].exp + " exp";
			exp = rows[0].exp;
		} else if (rows[0].mana != 0) {
			type = "mana";
			name = rows[0].mana + " Mana tutti i tipi";
			mana = rows[0].mana;
		} else {
			console.log("Errore estrazione");
			return;
		}

		connection.query('SELECT COUNT(*) As num FROM event_lottery_coins', function (err, rows, fields) {
			if (err) throw err;

			var num = parseInt(rows[0].num) - 1;
			var rand = Math.round(Math.random() * num);

			connection.query('SELECT player_id, nickname FROM event_lottery_coins, player WHERE player.id = event_lottery_coins.player_id AND player_id != 1 AND player_id != 3 ORDER BY RAND() LIMIT ' + rand + ',' + quantity, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					console.log("Errore estrazione vincitore " + rand + "-" + quantity);
					return;
				}

				if (Object.keys(rows).length > 15) {
					console.log("QuantitÃ  elevata " + Object.keys(rows).length + " - " + rand + " - " + quantity);
					return;
				}

				connection.query('UPDATE event_lottery_prize SET extracted = 1 WHERE id = ' + ext_id, function (err, rows, fields) {
					if (err) throw err;
				});

				var text = "<i>Lootteria</i> - Estrazione per <b>" + name + "</b>!\n\n";

				var playerId = 0;
				var nickname = "";
				var nick_extracted = [];

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					playerId = rows[i].player_id;
					nickname = rows[i].nickname;
					nick_extracted.push(playerId);
					console.log("Estratto " + nickname);

					if (quantity > 1) {
						text += "> " + nickname + "\n";
					} else {
						text += "Il vincitore Ã¨ <b>" + nickname + "</b>\n";
					}

					if (type == "item") {
						addItem(playerId, item_id);
					}
					if (type == "chest") {
						addChest(playerId, chest_id);
					}
					if (type == "money") {
						connection.query('UPDATE player SET money = money + ' + money + ' WHERE id = ' + playerId, function (err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "gems") {
						connection.query('UPDATE player SET gems = gems+' + gems + ' WHERE id = ' + playerId, function (err, rows, fields) {
							if (err) throw err;
						});
					}
					if (type == "exp") {
						setExp(playerId, exp);
					}
					if (type == "mana") {
						connection.query('UPDATE event_mana_status SET mana_1 = mana_1 + ' + mana + ', mana_2 = mana_2 + ' + mana + ', mana_3 = mana_3 + ' + mana + ' WHERE player_id = ' + playerId, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				};

				connection.query('SELECT MAX(id) As tot FROM event_lottery_prize WHERE day >= ' + date.getDay(), function (err, rows, fields) {
					if (err) throw err;

					var tot = rows[0].tot;
					text += "\n" + ext_id + " / " + tot;
					bot.sendMessage("@EstrazioniLootteria", text, html);
					console.log("Estrazione " + ext_id + " terminata");

					for (var i = 0, len = Object.keys(nick_extracted).length; i < len; i++) {
						playerId = nick_extracted[i];
						connection.query('DELETE FROM event_lottery_coins WHERE player_id = ' + playerId, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				});
			});
		});
	});
}

bot.onText(/^\/estrazione$/, function (message) {
	if (message.from.id == 20471035) {
		if (autoEstrazione == 0) {
			autoEstrazione = 1;
		} else {
			autoEstrazione = 0;
		}
		bot.sendMessage(message.chat.id, "Autoestrazione impostato a " + autoEstrazione);
	};
});

bot.onText(/spboss (.+)/, function (message, match) {
	var team_id = match[1];

	if (team_id == undefined) {
		bot.sendMessage(message.chat.id, "Boh!", back);
	}

	if (message.from.id == 20471035) {
		spawnTeamBoss(team_id);
		bot.sendMessage(message.chat.id, "Fatto :3", back);
	} else {
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.", back);
	}
});

bot.onText(/\/getid (.+)/, function (message, match) {
	connection.query('SELECT * FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(message.chat.id, rows[0].id);
	});
});

function lacrima(player_id, chat_id) {
	connection.query('SELECT id FROM artifacts WHERE player_id = ' + player_id + ' AND item_id = 614', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			connection.query('SELECT player_id FROM tear WHERE type = 1 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					addItem(player_id, 641);
					connection.query('INSERT INTO tear (player_id, type) VALUES (' + player_id + ',1)', function (err, rows, fields) {
						if (err) throw err;
					});
					bot.sendMessage(chat_id, "Hai raggiunto il livello 300!\nPer questo hai ottenuto una *Lacrima dell'Immortale* come ricompensa!\nOra crea l'oggetto finale che preferisci e ottieni 2 artefatti per continuare con la rinascita!", mark);
					console.log("Lacrima 1 consegnata a " + player_id);
				}
			});
		};
	});
}

function lacrima2(player_id, chat_id) {
	connection.query('SELECT id FROM artifacts WHERE player_id = ' + player_id + ' AND item_id = 644', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			connection.query('SELECT player_id FROM tear WHERE type = 2 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					addItem(player_id, 674);
					connection.query('INSERT INTO tear (player_id, type) VALUES (' + player_id + ',2)', function (err, rows, fields) {
						if (err) throw err;
					});
					bot.sendMessage(chat_id, "Hai raggiunto il livello 500!\nPer questo hai ottenuto una *Lacrima del Rinnegato* come ricompensa!", mark);
					console.log("Lacrima 2 consegnata a " + player_id);
				};
			});
		};
	});
}

function lacrima3(player_id, chat_id) {
	connection.query('SELECT id FROM artifacts WHERE player_id = ' + player_id + ' AND item_id = 644', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			connection.query('SELECT player_id FROM tear WHERE type = 3 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					addItem(player_id, 691);
					connection.query('INSERT INTO tear (player_id, type) VALUES (' + player_id + ',3)', function (err, rows, fields) {
						if (err) throw err;
					});
					bot.sendMessage(chat_id, "Hai raggiunto il livello 900!\nPer questo hai ottenuto una *Lacrima dell'Impavido* come ricompensa!", mark);
					console.log("Lacrima 3 consegnata a " + player_id);
				};
			})
		};
	});
}

bot.onText(/\/dona (.+)/, function (message, match) {
	if (message.from.id == 20471035) {
		if (match[1] == undefined) {
			bot.sendMessage(message.chat.id, "/dona nickname quantitÃ ");
			return;
		}

		var split = match[1].split(" ");

		var nick = split[0];
		var qnt = split[1];

		connection.query('SELECT * FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
			if (err) throw err;
			var player_id = rows[0].id;

			connection.query('UPDATE player SET moon_coin = moon_coin + ' + qnt + ', donation = donation + ' + qnt + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('INSERT INTO donation_history (player_id, amount, source) VALUES (' + player_id + ', ' + qnt + ', "Paypal")', function (err, rows, fields) {
				if (err) throw err;
			});
			bot.sendMessage(rows[0].chat_id, "Hai ricevuto *" + qnt + " ðŸŒ•* dall'amministratore per la tua donazione! Grazie mille!", mark);
			bot.sendMessage(message.chat.id, "Consegnati!");
		});
	} else {
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/^\/m (.+)|^\/m$/, function (message, match) {
	if (match[1] == undefined) {
		bot.sendMessage(message.chat.id, "Sintassi: /m nickname testo");
		return;
	}

	var split = match[1].split(/ (.+)/);

	var nick = split[0];
	var msg = split[1];

	if (re3.test(msg) == false) {
		bot.sendMessage(message.chat.id, "Puoi usare solo alcuni simboli");
		return;
	}

	nick = nick.replace("@", "");

	connection.query('SELECT account_id, id, exp, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp/10);
		var reb = rows[0].reborn;

		if ((level < 20) && (reb == 1)){
			bot.sendMessage(message.chat.id, "Raggiungi il livello 20 prima di poter inviare messaggi privati agli altri giocatori", back);
			return;
		}

		connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO direct_message (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Sei stato aggiunto al registro messaggi, usa /ricezione per bloccare i messaggi o riattivarli");
				});
			}

			connection.query('SELECT id, chat_id, account_id FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Il giocatore non esiste!");
					return;
				}

				var banReason = isBanned(rows[0].account_id);
				if (banReason != null) {
					bot.sendMessage(message.chat.id, "Il giocatore Ã¨ bannato");
					return;
				}

				var player_id2 = rows[0].id;
				var chat_id2 = rows[0].chat_id;

				connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = ' + player_id2, function (err, rows, fields) {
					if (err) throw err;
					var allow = 1;
					if (Object.keys(rows).length == 0) {
						connection.query('INSERT INTO direct_message (player_id, to_id) VALUES (' + player_id2 + ', ' + player_id + ')', function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(chat_id2, "Sei stato aggiunto al registro messaggi, usa /ricezione per bloccare i messaggi in entrata o riattivarli, '/r testo' per rispondere all'ultima discussione");
						});
					} else {
						allow = rows[0].allow;
					}

					if (allow == 0) {
						bot.sendMessage(message.chat.id, "Il giocatore ha bloccato la ricezione messaggi");
						return;
					}

					connection.query('UPDATE direct_message SET reply_text = "' + msg.slice(0, 30) + "..." + '", to_id = ' + player_id + ' WHERE player_id = ' + player_id2, function (err, rows, fields) {
						if (err) throw err;
					});

					bot.sendMessage(chat_id2, "<b>Messaggio da @" + message.from.username + ":</b>\n" + msg, html);
					bot.sendMessage(message.chat.id, "Inviato!");
				});
			});
		});
	});
});

bot.onText(/^\/r (.+)|^\/r$/, function (message, match) {
	if (match[1] == undefined) {
		bot.sendMessage(message.chat.id, "Sintassi: /r testo");
		return;
	}

	var msg = match[1];

	if (re3.test(msg) == false) {
		bot.sendMessage(message.chat.id, "Puoi usare solo alcuni simboli");
		return;
	}

	connection.query('SELECT account_id, id, exp, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp/10);
		var reb = rows[0].reborn;

		if ((level < 20) && (reb == 1)){
			bot.sendMessage(message.chat.id, "Raggiungi il livello 20 prima di poter rispondere ai messaggi privati agli altri giocatori", back);
			return;
		}

		connection.query('SELECT id, player_id, allow, to_id, reply_text FROM direct_message WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Inizia prima una conversazione");
				return;
			}

			if (rows[0].to_id == 0) {
				bot.sendMessage(message.chat.id, "Nessun messaggio a cui rispondere");
				return;
			}

			var reply_text = rows[0].reply_text;

			connection.query('SELECT id, chat_id, account_id FROM player WHERE id = ' + rows[0].to_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Il giocatore non esiste!");
					return;
				}

				var banReason = isBanned(rows[0].account_id);
				if (banReason != null) {
					bot.sendMessage(message.chat.id, "Il giocatore Ã¨ bannato");
					return;
				}

				var player_id2 = rows[0].id;
				var chat_id2 = rows[0].chat_id;

				connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = ' + player_id2, function (err, rows, fields) {
					if (err) throw err;
					var allow = 1;
					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Il giocatore non Ã¨ registrato, invia prima un messaggio");
						return;
					} else {
						allow = rows[0].allow;
					}

					if (allow == 0) {
						bot.sendMessage(message.chat.id, "Il giocatore ha bloccato la ricezione messaggi");
						return;
					}

					connection.query('UPDATE direct_message SET reply_text = "' + msg.slice(0, 30) + "..." + '", to_id = ' + player_id + ' WHERE player_id = ' + player_id2, function (err, rows, fields) {
						if (err) throw err;
					});

					bot.sendMessage(chat_id2, "<b>Risposta da @" + message.from.username + ":</b>\n<i>" + reply_text + "</i>\n" + msg, html);
					bot.sendMessage(message.chat.id, "Inviato!");
				});
			});
		});
	});
});

bot.onText(/\/ricezione/, function (message, match) {
	connection.query('SELECT id, player_id, allow FROM direct_message WHERE player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Registrati prima inviando un messaggio");
			return;
		}

		var allow = rows[0].allow;
		var player_id = rows[0].player_id;

		if (allow == 1) {
			allow = 0;
			bot.sendMessage(message.chat.id, "Ricezione messaggi disattivata");
		} else if (allow == 0) {
			allow = 1;
			bot.sendMessage(message.chat.id, "Ricezione messaggi attivata");
		}
		connection.query('UPDATE direct_message SET allow = ' + allow + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});
	});
});

bot.onText(/\/link (.+)/, function (message, match) {
	if ((message.from.id == 20471035)){
		var split = match[1].split(",");
		connection.query('SELECT id FROM player WHERE nickname = "' + split[0] + '"', function (err, rows, fields) {
			if (err) throw err;

			var new_player_id = rows[0].id;

			connection.query('SELECT id FROM player WHERE nickname = "' + split[1] + '"', function (err, rows, fields) {
				if (err) throw err;

				var player_id = rows[0].id;

				var d = new Date();
				var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

				connection.query('INSERT INTO referral_list (new_player, player_id, new_player_nick, player_nick, time) VALUES (' + new_player_id + ', ' + player_id + ',"' + split[0] + '", "' + split[1] + '", "' + long_date + '")', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Fatto");
				});
			});
		});
	}
});

bot.onText(/\/dai_scrigni (.+),(.+),(.+)/, function (message, match) {
	var nick = match[1].trim();
	var chest_name = match[2].trim();
	var qnt = match[3].trim();

	if (message.from.id == 20471035) {
		connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Utente non trovato");
				return;
			}
			var chat_id = rows[0].chat_id;
			var player_id = rows[0].id;
			connection.query('SELECT id, name FROM chest WHERE name = "' + chest_name + '"', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Scrigno non trovato");
					return;
				}
				var chest_name = rows[0].name;
				var chest_id = rows[0].id;
				addChest(player_id, chest_id, qnt);
				bot.sendMessage(chat_id, "Hai ricevuto " + qnt + "x *" + chest_name + "* dal Mercante Leggendario!", mark);
				bot.sendMessage(message.chat.id, "Consegnato!");
			});
		});
	} else {
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/dai_ogg (.+),(.+),(.+)/, function (message, match) {
	var nick = match[1].trim();
	var item_name = match[2].trim();
	var qnt = match[3].trim();

	if (message.from.id == 20471035) {
		connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Utente non trovato");
				return;
			}
			var chat_id = rows[0].chat_id;
			var player_id = rows[0].id;
			connection.query('SELECT id, name FROM item WHERE name = "' + item_name + '"', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Oggetto non trovato");
					return;
				}
				var item_name = rows[0].name;
				var item_id = rows[0].id;
				addItem(player_id, item_id, qnt);
				bot.sendMessage(chat_id, "Hai ricevuto " + qnt + "x *" + item_name + "* dal Mercante Leggendario!", mark);
				bot.sendMessage(message.chat.id, "Consegnato!");
			});
		});
	} else {
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/soldi (.+),(.+)/, function (message, match) {
	var nick = match[1].trim();
	var qnt = match[2].trim();

	if (message.from.id == 20471035) {
		connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Utente non trovato");
				return;
			}
			var chat_id = rows[0].chat_id;
			var player_id = rows[0].id;

			var query = "";
			var msg = "";
			if ((qnt.indexOf("-") != -1) || (qnt.indexOf("+") != -1)) {
				query = "money = money " + qnt;
				msg = "Hai ricevuto *" + qnt + " Â§* dal Mercante Leggendario!";
			} else {
				query = "money = " + qnt;
				msg = "Il tuo patrimonio Ã¨ stato impostato a *" + qnt + " Â§* dal Mercante Leggendario!";
			}

			connection.query('UPDATE player SET ' + query + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				bot.sendMessage(chat_id, msg, mark);
				bot.sendMessage(message.chat.id, "Consegnato!");
			});
		});
	} else {
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/dai_gemme (.+),(.+)/, function (message, match) {
	var nick = match[1].trim();
	var qnt = match[2].trim();

	if (message.from.id == 20471035) {
		connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Utente non trovato");
				return;
			}
			var chat_id = rows[0].chat_id;
			var player_id = rows[0].id;

			var query = "";
			var msg = "";
			if ((qnt.indexOf("-") != -1) || (qnt.indexOf("+") != -1)) {
				query = "gems = gems " + qnt;
				msg = "Hai ricevuto *" + qnt + " ðŸ’Ž* dal Mercante Leggendario!";
			} else {
				query = "gems = " + qnt;
				msg = "Le tue ðŸ’Ž sono state impostate a *" + qnt + "* dal Mercante Leggendario!";
			}

			connection.query('UPDATE player SET ' + query + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				bot.sendMessage(chat_id, msg, mark);
				bot.sendMessage(message.chat.id, "Consegnato!");
			});
		});
	} else {
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/dai_moon (.+),(.+)/, function (message, match) {
	var nick = match[1].trim();
	var qnt = match[2].trim();

	if (message.from.id == 20471035) {
		connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Utente non trovato");
				return;
			}
			var chat_id = rows[0].chat_id;
			var player_id = rows[0].id;

			var query = "";
			var msg = "";
			if ((qnt.indexOf("-") != -1) || (qnt.indexOf("+") != -1)) {
				query = "moon_coin = moon_coin " + qnt;
				msg = "Hai ricevuto *" + qnt + " ðŸŒ•* dal Mercante Leggendario!";
			} else {
				query = "moon_coin = " + qnt;
				msg = "Le tue ðŸŒ• sono state impostate a *" + qnt + "* dal Mercante Leggendario!";
			}

			connection.query('UPDATE player SET ' + query + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				bot.sendMessage(chat_id, msg, mark);
				bot.sendMessage(message.chat.id, "Consegnato!");
			});
		});
	} else {
		bot.sendMessage(message.chat.id, "Questo comando puÃ² essere utilizzato solo dall'amministratore.");
	}
});

bot.onText(/\/invitati/i, function (message) {
	connection.query('SELECT player.nickname, player.exp, player.reborn FROM referral_list, player WHERE new_player = player.id AND player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Nessun utente si Ã¨ registrato con il tuo link");
			return;
		}

		var text = Object.keys(rows).length + " giocatori si sono registrati con il tuo link invito:\n";
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			text += "> @" + rows[i].nickname + " Livello: " + Math.floor(rows[i].exp / 10) + " Rinascita: " + (rows[i].reborn - 1) + "\n";
		}
		bot.sendMessage(message.chat.id, text);
	});
});

bot.onText(/\/globali/, function (message, match) {
	connection.query('SELECT global_msg FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (rows[0].global_msg == 1) {
			connection.query('UPDATE player SET global_msg = 0 WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Ricezione avvisi disattivata, usa /globali per riattivarla");
			});
		} else {
			connection.query('UPDATE player SET global_msg = 1 WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Ricezione avvisi attivata, usa /globali per disattivarla");
			});
		}
	});
});

bot.onText(/\/messaggio (.+)|\/messaggio/, function (message, match) {
	if ((match[1] == undefined) || (match[1] == "")) {
		bot.sendMessage(message.chat.id, "Specifica il messaggio da inviare al tuo team, il messaggio viene tagliato se vai a capo. Sintassi: /messaggio testo", back);
		return;
	}

	var msg = match[1];

	connection.query('SELECT account_id, id, money, holiday FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;	
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT player_id FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') AND role = 1', function (err, rows, fields) {
			if (err) throw err;

			var adminId = rows[0].player_id;

			connection.query('SELECT player_id, chat_id FROM `team_player`, player WHERE team_player.player_id = player.id AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY team_player.id', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Non sei in un team", back);
					return;
				}

				if (adminId != player_id) {
					bot.sendMessage(message.chat.id, "Non sei amministratore del team", back);
					return;
				}

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].chat_id != message.chat.id) {
						bot.sendMessage(rows[i].chat_id, "Messaggio dall'Amministratore Team\n" + msg);
					}
				}
				bot.sendMessage(message.chat.id, "Messaggio inviato a " + (Object.keys(rows).length - 1) + " giocatori del team");
			});
		});
	});
});

bot.onText(/\/migrazione/, function (message, match) {
	connection.query('SELECT * FROM player WHERE account_id = ' + message.from.id, function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (message.from.username == undefined) {
			bot.sendMessage(message.chat.id, "Imposta il nickname prima di migrare", back);
			return;
		}
		bot.sendMessage(message.chat.id, "Il tuo account verrÃ  aggiornato al tuo attuale username, verrÃ  inviata una notifica all'amministratore. Continuare?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					connection.query('SELECT id, nickname, account_id FROM player WHERE account_id = ' + message.from.id, function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "Non ho trovato il tuo account, segnala all'amministratore", back);
							return;
						}

						var banReason = isBanned(rows[0].account_id);
						if (banReason != null) {
							var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
							bot.sendMessage(message.chat.id, text, mark);
							return;
						}

						var id = rows[0].id;
						var nickname = rows[0].nickname;

						connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length > 0) {
								bot.sendMessage(message.chat.id, "Non puoi migrare su un utente giÃ  registrato, contatta l'amministratore", back);
								bot.sendMessage("@lnotify", "#MigrazioneNegata: " + message.from.username);
								return;
							}

							connection.query('UPDATE player SET nickname = "' + message.from.username + '" WHERE id = ' + id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Migrazione completata!", back);

								bot.sendMessage("@lnotify", "#Migrazione: " + nickname + " -> " + message.from.username);
							});
						});
					});
				};
			};
		});
	});
});

bot.onText(/\/riscatta (.+)/, function (message, match) {
	connection.query('SELECT account_id, id FROM player WHERE account_id = ' + message.from.id, function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var code = match[1];
		connection.query('SELECT * FROM code_list WHERE code = "' + code + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Questo codice non Ã¨ valido", back);
				return;
			}
			if (rows[0].used != "") {
				bot.sendMessage(message.chat.id, "Questo codice Ã¨ giÃ  stato utilizzato", back);
				return;
			}
			var nick = rows[0].nickname;
			if ((nick != message.from.username) && (nick != "")) {
				bot.sendMessage(message.chat.id, "Non puoi riscattare questo codice privato", back);
				return;
			}
			var chest_id = parseInt(rows[0].chest_id);
			if (chest_id != 0) {
				addChest(player_id, chest_id);

				connection.query('SELECT name FROM chest WHERE id = ' + chest_id, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai ottenuto *" + rows[0].name + "*!", back);
				});
			}
			var item_id = parseInt(rows[0].item_id);
			if (item_id != 0) {
				addItem(player_id, item_id);
				connection.query('SELECT name FROM item WHERE id = ' + item_id, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai ottenuto *" + rows[0].name + "*!", back);
				});
			}
			var money = parseInt(rows[0].money);
			if (money != 0) {
				connection.query('UPDATE player SET money = money + ' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai ottenuto *" + money + "* Â§!", back);
				});
			}
			var gems = parseInt(rows[0].gems);
			if (gems != 0) {
				connection.query('UPDATE player SET gems = gems + ' + gems + ' WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai ottenuto *" + gems + "* ðŸ’Ž !", back);
				});
			}
			connection.query('UPDATE code_list SET used = "' + message.from.username + '" WHERE code = "' + code + '"', function (err, rows, fields) {
				if (err) throw err;
				console.log("Codice: " + code + " utilizzato");
			});
		});
	});
});

bot.onText(/craftweek/i, function (message) {
	if (message.from.id == 20471035) {
		bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					craftWeek();
					bot.sendMessage(message.chat.id, "Fatto!", back);
				}
			}
		});
	}
});

function craftWeek() {
	connection.query('UPDATE player SET craft_week = 0', function (err, rows, fields) {
		if (err) throw err;
	});
}

bot.onText(/resetach/i, function (message) {
	if (message.from.id == 20471035) {
		bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					reloadAchievement();
					bot.sendMessage(message.chat.id, "Fatto!", back);
				};
			};
		});
	}
});

bot.onText(/resetallboss/i, function (message) {
	if (message.from.id == 20471035) {
		bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					incremBoss(0);
					bot.sendMessage(message.chat.id, "Fatto!", back);
				};
			};
		});
	}
});

function incremBoss(team_id) {

	var where = "";
	if (team_id > 0) {
		where = " WHERE id = " + team_id;
	}

	connection.query('SELECT id, total_life FROM boss', function (err, rows, fields) {
		if (err) throw err;

		var totlife = [];
		totlife.push(0); //per avere un valore vuoto
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			totlife.push(rows[i].total_life);
		}

		connection.query('SELECT * FROM team' + where, function (err, rows, fields) {
			if (err) throw err;

			var life = 0;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {

				//console.log("TEAMID: " + rows[i].name + " (" + rows[i].id + ") PARZ: " + rows[i].kill_num1 + " COMPL: " + rows[i].kill_num2);
				for (var j = 1; j < 32; j++) {
					boss_id = j;
					if (j <= 20) {
						life = totlife[j] + (rows[i].kill_num1 * (8000 + (j * 2000)));
					} else if ((j > 20) && (j <= 27)) {
						life = totlife[j] + (rows[i].kill_num2 * 60000 + ((j - 20) * 5000));
					} else {
						life = totlife[j] + (rows[i].kill_num2 * 120000 + ((j - 27) * 20000));
					}

					life += (12 + (2 * j) - Math.log(life - 1)) * 1000;
					life = Math.round(life);

					//console.log("> BOSSID: " + boss_id + " LIFE: " + life);

					connection.query('UPDATE boss_team SET total_life = ' + life + ' WHERE team_id = ' + rows[i].id + ' AND boss_id = ' + boss_id, function (err, rows, fields) {
						if (err) throw err;
					});

					life = 0;
				}
				connection.query('UPDATE boss_team SET life = total_life WHERE life > total_life', function (err, rows, fields) {
					if (err) throw err;
				});
			}
		});
	});
}


function resetAchievement() {
	connection.query('DELETE FROM achievement_daily', function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('DELETE FROM achievement_status', function (err, rows, fields) {
		if (err) throw err;
	});
	console.log("Imprese azzerate");
};

function resetTeamMission() {
	connection.query('UPDATE team SET mission_day_count = 0', function (err, rows, fields) {
		if (err) throw err;
	});
}

function reloadAchievement() {
	connection.query('SELECT id, name, item_rarity, type FROM (SELECT * FROM achievement_list ORDER BY RAND()) as t WHERE id NOT IN (SELECT achievement_id FROM achievement_daily) GROUP BY type ORDER BY RAND() LIMIT 3', function (err, rows, fields) {
		if (err) throw err;

		connection.query('DELETE FROM achievement_daily', function (err, rows, fields) {
			if (err) throw err;
		});
		connection.query('DELETE FROM achievement_status', function (err, rows, fields) {
			if (err) throw err;
		});

		var rarity = 0;
		var id = 0;
		var type = 0;

		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			rarity = rows[i].item_rarity;
			id = rows[i].id;
			type = rows[i].type;

			if ((rarity != 0) && (type == 12)) {
				connection.query('SELECT item.id FROM item, rarity WHERE rarity.shortname = item.rarity AND rarity.id = ' + rarity + ' AND craftable = 1 ORDER BY RAND()', function (err, rows, fields) {
					if (err) throw err;
					connection.query('INSERT INTO achievement_daily (id, achievement_id, item_id) VALUES (' + (this.i + 1) + ',' + this.id + ',' + rows[0].id + ')', function (err, rows, fields) {
						if (err) throw err;
					});
				}.bind({
					i: i,
					id: id
				}));
			} else {
				connection.query('INSERT INTO achievement_daily (id, achievement_id, item_id) VALUES (' + (i + 1) + ',' + id + ',' + rarity + ')', function (err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
};

bot.onText(/automana/i, function (message) {
	if (message.from.id == 20471035) {
		bot.sendMessage(message.chat.id, "Sicuro?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					autoMana();
					bot.sendMessage(message.chat.id, "Fatto!", back);
				};
			};
		});
	}
});

function autoMana() {
	connection.query('SELECT mana.name, class, reborn, chat_id, nickname, player_id, rate, type, ROUND(TIMESTAMPDIFF(MINUTE,time_start,NOW())/60*rate,0) As quantity FROM event_mana_status, event_mana_zone, player, mana WHERE mana.id = event_mana_zone.type AND player.id = player_id AND event_mana_status.time_start IS NOT NULL AND event_mana_status.zone_id = event_mana_zone.id', function (err, rows, fields) {
		if (err) throw err;

		var mana_type = "";
		var text = "";
		if (Object.keys(rows).length > 0) {
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				mana_type = 'mana_' + rows[i].type;
				if ((rows[i].class == 2) && (rows[i].reborn > 1)) {
					rows[i].quantity += rows[i].quantity * 0.3;
				}
				if ((rows[i].class == 3) && (rows[i].type == 2) && (rows[i].reborn > 1)) {
					rows[i].quantity += rows[i].quantity * 0.5;
				}
				if ((rows[i].class == 3) && (rows[i].type != 2) && (rows[i].reborn > 1)) {
					rows[i].quantity -= rows[i].quantity * 0.2;
				}
				if ((rows[i].class == 4) && (rows[i].type == 3) && (rows[i].reborn > 1)) {
					rows[i].quantity += rows[i].quantity * 0.5;
				}
				if ((rows[i].class == 4) && (rows[i].type != 3) && (rows[i].reborn > 1)) {
					rows[i].quantity -= rows[i].quantity * 0.2;
				}
				if ((rows[i].class == 5) && (rows[i].type == 1) && (rows[i].reborn > 1)) {
					rows[i].quantity += rows[i].quantity * 1;
				}
				if ((rows[i].class == 5) && (rows[i].type != 1) && (rows[i].reborn > 1)) {
					rows[i].quantity -= rows[i].quantity * 0.1;
				}
				if ((rows[i].class == 6) && (rows[i].reborn > 1)) {
					rows[i].quantity -= rows[i].quantity * 0.1;
				}
				rows[i].quantity = Math.floor(rows[i].quantity);

				connection.query('UPDATE event_mana_status SET ' + mana_type + ' = ' + mana_type + ' + ' + rows[i].quantity + ', zone_id = 0, time_start = NULL WHERE player_id = ' + rows[i].player_id, function (err, rows, fields) {
					if (err) throw err;
				});
				bot.sendMessage(rows[i].chat_id, "Le miniere sono state chiuse, hai ricevuto " + rows[i].quantity + " Mana " + rows[i].name + "!");
				text += "\n" + rows[i].quantity + " Mana " + rows[i].name + " per " + rows[i].nickname + "(" + rows[i].player_id + ")";
			}
		} else {
			console.log("Nessuna miniera da terminare");
		}
	});
};

function autoDust() {
	connection.query('SELECT chat_id, nickname, player_id, extracting FROM event_dust_status, player WHERE player.id = player_id AND extracting = 1', function (err, rows, fields) {
		if (err) throw err;

		var text = "";
		if (Object.keys(rows).length > 0) {
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				connection.query('UPDATE event_dust_status SET extracting = 0, last_update = NULL WHERE player_id = ' + rows[i].player_id, function (err, rows, fields) {
					if (err) throw err;
				});
				bot.sendMessage(rows[i].chat_id, "I Generatori di Polvere sono stati spenti!");
			}
		} else {
			console.log("Nessuna polvere da terminare");
		}
	});
};

function makeid() {
	var text = "";
	var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

	for (var i = 0; i < 10; i++)
		text += possible.charAt(Math.floor(Math.random() * possible.length));

	return text;
}

function printStart(message) {
	connection.query('SELECT invite_code, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var code = rows[0].invite_code;
		var gender_text = ""
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}
		bot.sendMessage(message.chat.id, 'âš¡ï¸ Benvenut' + gender_text + ' nel <b>LootBot</b>!âš¡ï¸ \n\n' +
						'Benvenut' + gender_text + ' nel bot piÃ¹ divertente di Telegram! Dal 15 Maggio 2016 intrattiene migliaia di giocatori italiani ogni giorno, entra anche tu nel mondo di Lootia, intraprendi missioni, esplora i misteriosi dungeon ed affronta ogni tipo di creatura del mondo di Lootia!\n\n' +
						'Il tuo nickname da avventurier' + gender_text + ' Ã¨: <b>' + message.from.username + '</b>.\n' +
						'Se modifichi il nickname perderai i dati di gioco! Usa il comando /migrazione per modificarlo automaticamente.\n' +
						'Rispetta la community e sarai rispettato, gioca consapevolmente.\n\n' +
						'<b>Per iniziare</b> ðŸ—¡\n' +
						'- Leggi i <a href="http://telegra.ph/Introduzione-a-Loot-Bot-12-15">Suggerimenti per i nuovi avventurieri</a>\n' +
						'- Segui il canale @wikilootbot\n' +
						'- Visualizza i /gruppi e le /faq avviando l\'importantissimo bot di supporto @lootplusbot\n' +
						'- Entra nella <a href="https://t.me/joinchat/AAAAAEDH8FbelcVFTmw-mQ">Lootbot School</a> per imparare le basi\n' +
						'- Cerca un team per imparare ulteriormente le strategie per iniziare avvantaggiato\n\n' +
						'<b>Regolamento</b> ðŸš«\n' +
						'- Importante! Leggi il <a href="http://telegra.ph/Regolamento-di-LOOT-01-13">Regolamento Completo di Loot</a>.\n\n' +
						'<b>InattivitÃ </b> ðŸ”Ž\n' +
						'- Dopo 60 giorni di inattivitÃ  il tuo account sarÃ  automaticamente inserito in modalitÃ  vacanza.\n' +
						'- Dopo 6 mesi di inattivitÃ  il tuo account sarÃ  eliminato senza possibilitÃ  di ripristinarlo.\n' +
						'- Come ultima attivitÃ  si intende un qualsiasi comando inviato tramite il bot principale o il Plus.\n\n' +
						'<b>Link Utili</b> ðŸ“ƒ\n' +
						'- Vota il bot nello <a href="https://storebot.me/bot/lootgamebot">Storebot</a>\n' +
						'- Per aiutarmi a mantenere il server, <a href="http://fenixweb.net/">fai una donazione</a>, riceverai delle Monete Lunari ðŸŒ•!\n\n' +
						'<b>Crediti</b> ðŸ‘‘\n' +
						'- Edoardo Cortese @fenix45\n' +
						'- Emanuele Finiguerra @LastSoldier95', no_preview_html);

		mainMenu(message);
	});
}

bot.onText(/^info/i, function (message) {

	if (message.text.toLowerCase().indexOf("globale") != -1)
		return;

	printStart(message);
});

function mainMenu(message) {
	calcLife(message);

	var price_drop = 0;
	var price_drop_msg = "";
	var n = new Date().getDay()
	var n2 = new Date().getDate();

	if (sconto_evento > 0) {
		sconto = sconto_evento;
		price_drop = 1;
		price_drop_msg = "\nðŸ’¸ Oggi sconti del <b>" + sconto + "%</b> all'emporio ed al mercato per il <b>Black Friday</b>!";
	} else {
		if ((n == 0) && (crazyMode == 0)) {
			if (n2 <= 7)
				sconto = 20;
			price_drop = 1;
			price_drop_msg = "\nðŸ’¸ Oggi sconti del <b>" + sconto + "%</b> all'emporio ed al mercato!";
		} else if (n == 2) {
			price_drop_msg = "\nðŸ€ Oggi giornata <b>fortunata</b>!";
		} else {
			var links = ["<a href='http://telegram.me/storebot?start=lootgamebot'>Vota</a> il bot ðŸ”!",
						 "Entra nella <a href='https://telegram.me/joinchat/AThc-z_EfojvcE8mbGw1Cw'>Taverna</a> ðŸº!",
						 "Commercia nel <a href='https://telegram.me/joinchat/AThc-z90Erh4M2O8Mk5QLw'>Mercato</a> ðŸ’°!",
						 "Iscriviti a @LootBotAvvisi per seguire le novitÃ !",
						 "<a href='https://www.paypal.me/EdoardoCortese'>Dona</a> e riceverai ðŸŒ• per la Ruota della Luna!",
						 "Aggiungi @lootplusbot al tuo gruppo!",
						 ((n != 6) && (n != 0) ? "Ricordati di completare le Imprese Giornaliere!" : "In settimana completa le Imprese Giornaliere!")];
			var rand = Math.round(Math.random() * (Object.keys(links).length - 1));
			price_drop_msg = "\n " + links[rand];
		}
	}

	var time = "ðŸŒ• Salve";
	var n = new Date().getHours();

	if ((n >= 7) && (n <= 19)) {
		time = "â˜€ï¸ Buongiorno";
	} else if ((n > 19) && (n < 23)) {
		time = "ðŸŒ™ Buonasera";
	}

	connection.query('SELECT id, account_id, mission_id, mission_special_id, travel_id, cave_id, exp, life, total_life, reborn, money, holiday, boost_id, market_pack, heist_protection, mission_time_end, mission_special_time_end, travel_time_end, cave_time_end, dungeon_time, boost_mission, paralyzed, mission_party, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var gender_text = "";
		var christmas = "ðŸŽ…ðŸ¼";
		var player_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
			christmas = "ðŸŽ…ðŸ¼";
			player_text = "Giocatore";
		}else{
			gender_text = "a";
			christmas = "ðŸ¤¶ðŸ¼";
			player_text = "Giocatrice";
		}

		var msgtext = "<b>" + time + " " + message.from.username + "!</b>";

		// FestivitÃ  (mese -1)
		if ((new Date().getDate() == 25) && (new Date().getMonth() == 11)){
			msgtext += " Buon Natale! " + christmas;
		}else if ((new Date().getDate() == 1) && (new Date().getMonth() == 3)){
			msgtext += " Buona Pasqua! ðŸ£";
		}

		var player_id = rows[0].id;
		var mission_id = rows[0].mission_id;
		var mission_special_id = rows[0].mission_special_id;
		var travel_id = rows[0].travel_id;
		var cave_id = rows[0].cave_id;
		var exp = rows[0].exp;
		var lev = Math.floor(exp / 10);
		var life = rows[0].life;
		var tot_life = rows[0].total_life;
		var reborn = rows[0].reborn;
		var money = rows[0].money;
		var holiday = rows[0].holiday;
		var boost_id = rows[0].boost_id;
		var market_pack = rows[0].market_pack;
		var heist_protection = rows[0].heist_protection;

		var mission_time_end = rows[0].mission_time_end;
		var mission_special_time_end = rows[0].mission_special_time_end;
		var travel_time_end = rows[0].travel_time_end;
		var cave_time_end = rows[0].cave_time_end;
		var dungeon_time = rows[0].dungeon_time;
		var boost_end = rows[0].boost_mission;
		var mission_party = rows[0].mission_party;

		if (rows[0].paralyzed > 0) {
			var plur = "i";
			if (rows[0].paralyzed == 1)
				plur = "o";
			msgtext = msgtext + "\nâš¡ï¸ Sei paralizzat" + gender_text + " ancora per <b>" + rows[0].paralyzed + " turn" + plur + "</b>";
		}

		if (mission_party > 0) {
			var rows = connection_sync.query('SELECT p1.mission_time_end, p1.wait, p1.part_id, p0.parts FROM mission_team_list p0, mission_team_party p1, mission_team_party_player p2 WHERE p0.id = p1.assigned_to AND p1.party_id = p2.party_id AND p1.team_id = p2.team_id AND p2.player_id = ' + player_id);
			if (Object.keys(rows).length > 0) {
				if (rows[0].wait == 1){
					msgtext = msgtext + "\nðŸ† Incarico in attesa di votazione";
				}else{
					var wait_time = new Date(rows[0].mission_time_end);
					msgtext = msgtext + "\nðŸ† Incarico in corso fino alle " + addZero(wait_time.getHours()) + ":" + addZero(wait_time.getMinutes()) + " " + rows[0].part_id + "/" + rows[0].parts;
				}
			}
		}

		connection.query('SELECT room_time FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var min = 0;
			var room_time = 0;

			if (Object.keys(rows).length > 0) {
				room_time = rows[0].room_time;
				if (rows[0].room_time != null) {
					var now = new Date();
					min = Math.round(((new Date(room_time) - now) / 1000) / 60);
				}
			}

			if (crazyMode == 0) {
				if (market_pack == 0)
					msgtext += "\nðŸ‘ 1 pacchetto acquistabile dal Mercante";
			} else {
				if ((3-market_pack) > 0)
					msgtext += "\nðŸ‘ " + (3-market_pack) + " pacchetti acquistabili dal Mercante";
			}

			connection.query('SELECT wait_time FROM heist_progress WHERE from_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0) {
					if (rows[0].wait_time == null) {
						msgtext += "\nâ“ Gnomo in attesa di istruzioni";
					} else {
						var wait_time = new Date(rows[0].wait_time);
						msgtext += "\nðŸ”¦ Gnomo in esplorazione fino alle " + addZero(wait_time.getHours()) + ":" + addZero(wait_time.getMinutes());
					}
				}

				if (heist_protection != null) {
					var prot_time = new Date(heist_protection);
					msgtext += "\nðŸš· Protett" + gender_text + " fino alle " + addZero(prot_time.getHours()) + ":" + addZero(prot_time.getMinutes());
				}

				connection.query('SELECT zone_id FROM event_mana_status WHERE time_start IS NOT NULL AND player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length > 0) {
						var zone = "";
						if (rows[0].zone_id == 1) {
							type = "Blu";
						} else if (rows[0].zone_id == 2) {
							type = "Giallo";
						} else if (rows[0].zone_id == 3) {
							type = "Rosso";
						}

						msgtext = msgtext + "\nâ› Estrazione di Mana " + type + " in corso";
					}

					connection.query('SELECT COUNT(*) As cnt FROM heist WHERE to_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length > 0) {
							if (rows[0].cnt > 0) {
								var plur = "o";
								if (rows[0].cnt > 1) {
									plur = "i";
								}
								msgtext = msgtext + "\nâš ï¸ <b>" + rows[0].cnt + "</b> gnom" + plur + " in lontananza";
							}
						}

						connection.query('SELECT COUNT(*) As cnt FROM heist_progress WHERE to_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length > 0) {
								if (rows[0].cnt > 0) {
									var plur = "o";
									if (rows[0].cnt > 1) {
										plur = "i";
									}
									msgtext = msgtext + "\nâš ï¸ <b>" + rows[0].cnt + "</b> gnom" + plur + " davanti al rifugio";
								}
							}

							connection.query('SELECT `extracting`, `generated`, `max_qnt` FROM event_dust_status WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length > 0) {
									if (rows[0].extracting == 1) {
										msgtext = msgtext + "\nâ² Generatore acceso (" + rows[0].generated + "/" + rows[0].max_qnt + " unitÃ )";
									}
								}

								connection.query('SELECT datetime FROM heist WHERE from_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length > 0) {
										var heist_end = new Date(rows[0].datetime);
										msgtext = msgtext + "\nðŸ”¦ Gnomo in ispezione alle " + addZero(heist_end.getHours()) + ":" + addZero(heist_end.getMinutes());
									}

									connection.query('SELECT name, progress, value, ROUND(progress/IF(multiply=0, value, value*' + reborn + ')*100) As perc, multiply FROM achievement_daily, achievement_list, achievement_status WHERE achievement_daily.achievement_id = achievement_list.id AND achievement_status.achievement_id = achievement_list.id AND player_id = ' + player_id + ' AND completed = 0 ORDER BY perc DESC', function (err, rows, fields) {
										if (err) throw err;

										var achievement = "";
										if (Object.keys(rows).length > 0) {
											if (rows[0].multiply == 1)
												rows[0].value = rows[0].value*reborn;
											achievement = "\nðŸ‹ Impresa imminente: " + rows[0].name + " (" + formatNumber(rows[0].progress) + "/" + formatNumber(rows[0].value) + ")";
										}

										connection.query('SELECT time_end, day_cnt, item.name FROM merchant_offer, item WHERE merchant_offer.item_id = item.id AND player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length > 0) {
												if (rows[0].day_cnt < merchant_limit) {
													var d = new Date();
													if ((d.getHours() > 8) && (d.getHours() < 23)) {
														if (rows[0].time_end != null) {
															var time_end = new Date(rows[0].time_end);
															var short_date = addZero(time_end.getHours()) + ":" + addZero(time_end.getMinutes());
															if (time_end.getHours() < 23)
																msgtext = msgtext + "\nðŸ’¬ Contrabbandiere assente fino alle " + short_date;
														} else {
															msgtext = msgtext + "\nðŸ”© Offerta Contrabbandiere disponibile"; //per " + rows[0].name;
														}
													}
												}
											}

											connection.query('SELECT boost_time, sleep_time_end FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;

												if (mission_id > 0) {
													var mission_end = new Date(mission_time_end);
													var now = new Date();
													var tomorrow = new Date();
													tomorrow.setDate(now.getDate() + 1);
													var tomorrow2 = new Date();
													tomorrow2.setDate(now.getDate() + 2);
													if (tomorrow.getFullYear() == mission_end.getFullYear() && tomorrow.getMonth() == mission_end.getMonth() && tomorrow.getDate() == mission_end.getDate()) {
														msgtext = msgtext + "\nâš” Missione fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes()) + " di domani";
													} else if (tomorrow2.getFullYear() == mission_end.getFullYear() && tomorrow2.getMonth() == mission_end.getMonth() && tomorrow2.getDate() == mission_end.getDate()) {
														msgtext = msgtext + "\nâš” Missione fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes()) + " di dopodomani";
													} else {
														msgtext = msgtext + "\nâš” Missione fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes());
													}
												}
												if (mission_special_id > 0) {
													var mission_end = new Date(mission_special_time_end);
													msgtext = msgtext + "\nðŸ—¾ Itinerario fino alle " + addZero(mission_end.getHours()) + ":" + addZero(mission_end.getMinutes());
												}
												if (travel_id > 0) {
													var travel_end = new Date(travel_time_end);
													msgtext = msgtext + "\nðŸ—º Viaggio fino alle " + addZero(travel_end.getHours()) + ":" + addZero(travel_end.getMinutes()) + " del " + addZero(travel_end.getDate()) + "/" + addZero(travel_end.getMonth() + 1) + "/" + travel_end.getFullYear();
												}
												if (cave_id > 0) {
													var cave_end = new Date(cave_time_end);
													msgtext = msgtext + "\nðŸ—» Esplorazione cava fino alle " + addZero(cave_end.getHours()) + ":" + addZero(cave_end.getMinutes()) + " del " + addZero(cave_end.getDate()) + "/" + addZero(cave_end.getMonth() + 1) + "/" + cave_end.getFullYear();
												}
												if (dungeon_time != null) {
													var dungeon = new Date(dungeon_time);
													msgtext = msgtext + "\nðŸ›¡ Attesa dungeon fino alle " + addZero(dungeon.getHours()) + ":" + addZero(dungeon.getMinutes());
												}
												if (min > 0) {
													var plur = "i";
													if (min == 1) {
														plur = "o";
													}
													msgtext = msgtext + "\nðŸ›¡ Prossima stanza tra " + min + " minut" + plur;
												}

												if ((room_time == null) && (dungeon_time == null)) {
													msgtext = msgtext + "\nâ—ï¸ Prosegui il dungeon!";
												}

												if (Object.keys(rows).length > 0) {

													var boost_time = rows[0].boost_time;
													var sleep_time_end = rows[0].sleep_time_end;

													if (rows[0].boost_time != null) {
														var dragon = new Date(rows[0].boost_time);
														var now = new Date();
														if (dragon < now) {
															msgtext = msgtext + "\nðŸ¶ Bevanda pronta al ritiro";
														} else {
															msgtext = msgtext + "\nðŸ¶ Produzione bevanda alle " + addZero(dragon.getHours()) + ":" + addZero(dragon.getMinutes());
														}
													}

													var dragon = connection_sync.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id);

													if (Object.keys(dragon).length > 0) {
														if (dragon[0].combat == 1)
															msgtext = msgtext + "\nðŸ‰ Drago in combattimento nella Vetta";
														else
															if (sleep_time_end != null) {
																var dragon_time = new Date(rows[0].sleep_time_end);
																msgtext = msgtext + "\nðŸ’¤ Il drago riposa fino alle " + addZero(dragon_time.getHours()) + ":" + addZero(dragon_time.getMinutes());
															}else{
																var d = new Date();
																var err = 0;
																if (d.getHours() == 2) {
																	if (d.getMinutes() > 30)
																		err = 1;
																}
																if ((d.getHours() >= 3) && (d.getHours() < 9))
																	err = 1;
																if (err == 0)
																	msgtext = msgtext + "\nðŸ‰ Drago in attesa nella Vetta";
															}
													}else{
														if (sleep_time_end != null) {
															var dragon_time = new Date(rows[0].sleep_time_end);
															msgtext = msgtext + "\nðŸ’¤ Il drago riposa fino alle " + addZero(dragon_time.getHours()) + ":" + addZero(dragon_time.getMinutes());
														}
													}
												}
												if (boost_id == 1) {
													var plur = "i";
													if (boost_end == 1) {
														plur = "e";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Energetica attiva per " + boost_end + " mission" + plur;
												}
												if (boost_id == 2) {
													var plur = "i";
													if (boost_end == 1) {
														plur = "e";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Scrigno attiva per " + boost_end + " mission" + plur;
												}
												if (boost_id == 4) {
													var plur = "i";
													if (boost_end == 1) {
														plur = "e";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Livellante attiva per " + boost_end + " mission" + plur;
												}
												if (boost_id == 3) {
													var plur = "i";
													if (boost_end == 1) {
														plur = "io";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Fiamma di Drago attiva per " + boost_end + " viagg" + plur;
												}
												if (boost_id == 5) {
													var plur = "i";
													if (boost_end == 1) {
														plur = "e";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Quadrifoglio attiva per " + boost_end + " mission" + plur;
												}
												if (boost_id == 6) {
													var plur = "hi";
													if (boost_end == 1) {
														plur = "o";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Furia attiva per " + boost_end + " attacc" + plur;
												}
												if (boost_id == 7) {
													var plur = "i";
													if (boost_end == 1) {
														plur = "e";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Bottino attiva per " + boost_end + " mission" + plur;
												}
												if (boost_id == 8) {
													var plur = "e";
													if (boost_end == 1) {
														plur = "a";
													}
													if (boost_end > 0)
														msgtext = msgtext + "\nðŸ¹ Bevanda Corsa attiva per " + boost_end + " stanz" + plur;
												}
												if (holiday > 0) {
													msgtext = msgtext + "\nâ›± Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!";
												}
												if (achievement != "") {
													msgtext += achievement;
												}
												var reb = "";
												if (reborn > 1) {
													reb = " R" + (reborn - 1);
												}
												var s = rebSym(reborn);
												if (message.from.id == 129597113)
													s = "ðŸ¼";

												msgtext += "\n" + s + " <b>" + lev + "</b> â¤ï¸ " + formatNumber(life) + "/" + formatNumber(tot_life) + "\nðŸ’° " + formatNumber(money) + " Â§";
												msgtext += price_drop_msg;

												if (((exp >= 1000) && (reborn == 1)) || ((exp >= 1500) && (reborn == 2)) || ((exp >= 2000) && (reborn == 3)) || ((exp >= 3000) && (reborn == 4))) {
													var f = 0;
													for(i = 0; i < Object.keys(mainKeysR).length; i++){
														if (mainKeysR[i][0].indexOf("Giocatore") != -1){
															mainKeysR[i][0] = mainKeysR[i][0].replace("Giocatore", player_text);
														}else if (mainKeysR[i][0].indexOf("Giocatrice") != -1){
															mainKeysR[i][0] = mainKeysR[i][0].replace("Giocatrice", player_text);
														}
													}

													mainReborn_html = {
														parse_mode: "HTML",
														disable_web_page_preview: true,
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": mainKeysR
														}
													};
													bot.sendMessage(message.chat.id, msgtext, mainReborn_html);
												} else if (((exp <= 50) && (reborn == 2)) || ((exp <= 50) && (reborn == 3)) || ((exp <= 50) && (reborn == 4))) {
													var f = 0;
													for(i = 0; i < Object.keys(mainKeysR2).length; i++){
														if (mainKeysR2[i][0].indexOf("Giocatore") != -1){
															mainKeysR2[i][0] = mainKeysR2[i][0].replace("Giocatore", player_text);
														}else if (mainKeysR2[i][0].indexOf("Giocatrice") != -1){
															mainKeysR2[i][0] = mainKeysR2[i][0].replace("Giocatrice", player_text);
														}
													}

													mainReborn2_html = {
														parse_mode: "HTML",
														disable_web_page_preview: true,
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": mainKeysR2
														}
													};
													bot.sendMessage(message.chat.id, msgtext, mainReborn2_html);
												} else {													
													var f = 0;
													for(i = 0; i < Object.keys(mainKeys).length; i++){
														if (mainKeys[i][0].indexOf("Giocatore") != -1){
															mainKeys[i][0] = mainKeys[i][0].replace("Giocatore", player_text);
														}else if (mainKeys[i][0].indexOf("Giocatrice") != -1){
															mainKeys[i][0] = mainKeys[i][0].replace("Giocatrice", player_text);
														}
													}

													main_html = {
														parse_mode: "HTML",
														disable_web_page_preview: true,
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": mainKeys
														}
													};

													bot.sendMessage(message.chat.id, msgtext, main_html);
												}
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
}

function rebSym(reborn) {
	var rebSym = "";
	if (reborn == 1) {
		rebSym = "âœ¨";
	} else if (reborn == 2) {
		rebSym = "ðŸ”†";
	} else if (reborn == 3) {
		rebSym = "ðŸ’«";
	} else if (reborn == 4) {
		rebSym = "â­ï¸";
	} else if (reborn == 5) {
		rebSym = "ðŸŒŸ";
	}
	return rebSym;
}

bot.onText(/torna al menu$/i, function (message) {
	connection.query('SELECT account_id FROM plus_players WHERE account_id = ' + message.from.id, function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0) {
			connection.query('INSERT INTO plus_players (account_id, nickname) VALUES (' + message.from.id + ',"' + message.from.username + '")', function (err, rows, fields) {
				if (err) throw err;
				console.log(message.from.username + " aggiunto");
			});
		} else {
			connection.query('SELECT real_name, gender, id FROM player WHERE account_id = "' + message.from.id + '"', function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0) {
					if ((rows[0].real_name == null) || (rows[0].gender == null)){
						connection.query('UPDATE plus_players SET nickname = "' + message.from.username + '" WHERE account_id = ' + message.from.id, function (err, rows, fields) {
							if (err) throw err;
						});
					}else{
						connection.query('UPDATE plus_players SET nickname = "' + message.from.username + '", gender = "' + rows[0].gender + '", real_name = "' + rows[0].real_name + '" WHERE account_id = ' + message.from.id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				}
			});
		}
	});
	calcLife(message);
	mainMenu(message);
});
bot.onText(/niente$/i, function (message) {
	mainMenu(message);
});
bot.onText(/nessuno$/i, function (message) {
	mainMenu(message);
});
bot.onText(/annulla$/i, function (message) {
	mainMenu(message);
});

bot.onText(/giocatore|giocatrice/i, function (message) {
	getInfo(message, message.from.username, 6);
});

function getInfo(message, player, myhouse_id) {
	calcLife(message);

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			helpMsg(message.chat.id, rows[0].id, 8);
		}
	});

	connection.query('SELECT id, house_id, class, reborn, custom_name, custom_name2, custom_name3, custom_name_h, weapon_id, weapon2_id, weapon3_id, charm_id, boost_id, gender FROM player WHERE nickname = "' + player + '"', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Il giocatore non esiste.", back);
			return;
		}

		var gender_text = "Giocatore";
		if (rows[0].gender == "F"){
			gender_text = "Giocatrice";
		}

		var player_id = rows[0].id;
		var boost_id = rows[0].boost_id;
		var custom_name = rows[0].custom_name;
		var custom_name2 = rows[0].custom_name2;
		var custom_name3 = rows[0].custom_name3;
		var custom_name_h = rows[0].custom_name_h;

		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var charm_id = rows[0].charm_id;
		var house_id = rows[0].house_id;
		var reborn = rows[0].reborn;
		var class_id = rows[0].class;

		connection.query('SELECT name, id FROM item WHERE id = ' + weapon_id, function (err, rows, fields) {
			if (err) throw err;
			var weapon = "-";
			var weapon_id = 0;
			if (Object.keys(rows).length > 0) {
				weapon_id = rows[0].id;
				if ((weapon_id == 638) || (weapon_id == 639) || (weapon_id == 640) || (weapon_id == 754)) {
					if (custom_name != null) {
						weapon = custom_name + rows[0].name.replace("Necro", "");
					} else {
						weapon = rows[0].name;
					}
				} else {
					weapon = rows[0].name;
				}
			};

			connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 1', function (err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				if (Object.keys(rows).length > 0) {
					abBonus = rows[0].ability_level * rows[0].val;
				}

				connection.query('SELECT COUNT(item_id) As cnt FROM artifacts WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					var artifacts = "";
					if (rows[0].cnt == 0) {
						artifacts = "-";
					}
					if (rows[0].cnt >= 1) {
						artifacts += "ðŸ”¥";
					}
					if (rows[0].cnt >= 2) {
						artifacts += "âš¡ï¸";
					}
					if (rows[0].cnt >= 3) {
						artifacts += "â›ˆ";
					}
					if (rows[0].cnt >= 4) {
						artifacts += "ðŸŒ‘";
					}
					if (rows[0].cnt >= 5) {
						artifacts += "ðŸ”®";
					}

					connection.query('SELECT name, description FROM item WHERE id = ' + charm_id, function (err, rows, fields) {
						if (err) throw err;
						var talismano = "-";
						var talismano_desc = "";
						if (Object.keys(rows).length > 0) {
							talismano = rows[0].name;
							talismano_desc = " (" + rows[0].description + ")";
						};

						connection.query('SELECT name FROM house WHERE grade = ' + house_id, function (err, rows, fields) {
							if (err) throw err;
							var rifugio = "-";
							if (Object.keys(rows).length > 0) {
								if (house_id >= 5) {
									if (custom_name_h != null) {
										rifugio = "Rifugio " + custom_name_h + " (" + house_id + ")";
									} else {
										rifugio = rows[0].name + " (" + house_id + ")";
									}
								} else {
									rifugio = rows[0].name + " (" + house_id + ")";
								}
							};

							connection.query('SELECT name FROM player, team, team_player WHERE player.id = ' + player_id + ' AND team.id = team_player.team_id AND team_player.player_id = player.id', function (err, rows, fields) {
								if (err) throw err;
								var team_desc = "";
								if (Object.keys(rows).length > 0) {
									team_desc = "âšœï¸ " + rows[0].name.trim() + "\n";
								};

								connection.query('SELECT name FROM house WHERE id = ' + house_id, function (err, rows, fields) {
									if (err) throw err;
									var house_name = rows[0].name;

									connection.query('SELECT name FROM item WHERE id = ' + weapon2_id, function (err, rows, fields) {
										if (err) throw err;
										var weapon2 = "-";
										if (Object.keys(rows).length > 0) {
											if ((weapon2_id == 688) || (weapon2_id == 689) || (weapon2_id == 690)) {
												if (custom_name2 != null) {
													weapon2 = rows[0].name.replace("Necro", custom_name2);
												} else {
													weapon2 = rows[0].name;
												}
											} else {
												weapon2 = rows[0].name;
											}
										}

										connection.query('SELECT name FROM item WHERE id = ' + weapon3_id, function (err, rows, fields) {
											if (err) throw err;
											var weapon3 = "-";
											if (Object.keys(rows).length > 0) {
												if ((weapon3_id == 671) || (weapon3_id == 672) || (weapon3_id == 673)) {
													if (custom_name3 != null) {
														weapon3 = rows[0].name.replace("Necro", custom_name3);
													} else {
														weapon3 = rows[0].name;
													}
												} else {
													weapon3 = rows[0].name;
												}
											}

											connection.query('SELECT dragon.* FROM player, dragon WHERE player.id = dragon.player_id AND player.id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												var dragon_name = "-";
												var dragon_level = "-";
												var dragon_damage = "-";
												var dragon_defence = "-";
												var dragon_critical = "-";
												var dragon_clawsid = 0;
												var dragon_saddleid = 0;
												var dragon_armsid = 0;
												var dragon_claws = 0;
												var dragon = 0;
												var dragon_status = "In salute";

												if (Object.keys(rows).length > 0) {
													dragon = 1;

													if (charm_id == 602) {
														rows[0].damage += 25;
														rows[0].critical += 10;
													}
													if (charm_id == 695) {
														rows[0].damage += 30;
														rows[0].critical += 15;
													}

													if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
														rows[0].claws += rows[0].claws * 1;
													}else if ((class_id == 7) && (reborn > 1)) {
														rows[0].claws += rows[0].claws * 0.5;
													}
													if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
														rows[0].saddle += rows[0].saddle * 1;
													}else if ((class_id == 7) && (reborn > 1)) {
														rows[0].saddle += rows[0].saddle * 0.5;
													}

													if ((class_id == 7) && (reborn == 3)) {
														rows[0].critical += 5;
													}
													if ((class_id == 7) && (reborn >= 4)) {
														rows[0].critical += 7;
													}

													dragon_name = rows[0].name.trim() + " " + rows[0].type;
													dragon_level = rows[0].level;
													dragon_damage = "+" + Math.round(rows[0].damage + rows[0].claws);
													dragon_defence = "-" + Math.round(rows[0].defence + rows[0].saddle);
													dragon_critical = Math.round(rows[0].critical);

													dragon_claws = parseInt(rows[0].claws);

													dragon_clawsid = rows[0].claws_id;
													dragon_saddleid = rows[0].saddle_id;
													dragon_armsid = rows[0].arms_id;

													if (rows[0].life <= 0) {
														dragon_status = "Esausto";
													}
													if (rows[0].sleep_h > 0) {
														dragon_status = "Dorme";
													}
												}

												connection.query('SELECT name, COUNT(name) As num FROM item WHERE id = ' + dragon_clawsid, function (err, rows, fields) {
													if (err) throw err;

													var dragon_claws_n = "-";
													if (rows[0].num > 0) {
														dragon_claws_n = rows[0].name;
													}

													connection.query('SELECT name, COUNT(name) As num FROM item WHERE id = ' + dragon_saddleid, function (err, rows, fields) {
														if (err) throw err;

														var dragon_saddle_n = "-";
														if (rows[0].num > 0) {
															dragon_saddle_n = rows[0].name;
														}

														connection.query('SELECT name, COUNT(name) As num FROM item WHERE id = ' + dragon_armsid, function (err, rows, fields) {
															if (err) throw err;

															var dragon_arms_n = "-";
															if (rows[0].num > 0) {
																dragon_arms_n = rows[0].name;
															}

															connection.query('SELECT player_nick As player, new_player_nick As new, time FROM referral_list WHERE 	new_player = ' + player_id, function (err, rows, fields) {
																if (err) throw err;

																var referral = "";
																if (Object.keys(rows).length > 0) {
																	var d = new Date(rows[0].time);
																	var short_date = addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
																	referral = "Invitato da: " + rows[0].player + " (" + short_date + ")\n";
																}

																connection.query('SELECT COUNT(inventory.item_id) As cnt FROM inventory, item WHERE inventory.item_id = item.id AND player_id = ' + player_id + ' AND rarity = "IN" AND inventory.quantity > 0', function (err, rows, fields) {

																	if (err) throw err;

																	var inest = rows[0].cnt;

																	connection.query('SELECT class.name FROM player, class WHERE player.id = ' + player_id + ' AND player.class = class.id', function (err, rows, fields) {
																		if (err) throw err;

																		var class_name = "-";
																		if (Object.keys(rows).length > 0) {
																			class_name = rows[0].name;
																		}

																		connection.query('SELECT * FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			var stars = rebSym(reborn);

																			if (player_id == 1) {
																				stars = "ðŸ‘‘";
																			}

																			var enchant1 = "";
																			if (rows[0].weapon_enchant == 1){
																				enchant1 = " âš¡ï¸";
																			}else if (rows[0].weapon_enchant == 2){
																				enchant1 = " ðŸ”¥";
																			}else if (rows[0].weapon_enchant == 3){
																				enchant1 = " ðŸŒŠ";
																			}
																			var enchant2 = "";
																			if (rows[0].weapon2_enchant == 1){
																				enchant2 = " âš¡ï¸";
																			}else if (rows[0].weapon2_enchant == 2){
																				enchant2 = " ðŸ”¥";
																			}else if (rows[0].weapon2_enchant == 3){
																				enchant2 = " ðŸŒŠ";
																			}
																			var enchant3 = "";
																			if (rows[0].weapon3_enchant == 1){
																				enchant3 = " âš¡ï¸";
																			}else if (rows[0].weapon3_enchant == 2){
																				enchant3 = " ðŸ”¥";
																			}else if (rows[0].weapon3_enchant == 3){
																				enchant3 = " ðŸŒŠ";
																			}

																			//Talismani

																			if (charm_id == 62) {
																				rows[0].weapon += 5;
																			}
																			if (charm_id == 184) {
																				rows[0].weapon += 15;
																			}
																			if (charm_id == 188) {
																				rows[0].weapon += 20;
																			}
																			if (charm_id == 404) {
																				rows[0].weapon_crit += 6;
																			}
																			if (charm_id == 493) {
																				rows[0].weapon_crit += 2;
																			}
																			if (charm_id == 494) {
																				rows[0].weapon_crit += 4;
																			}
																			if (charm_id == 495) {
																				rows[0].weapon2_crit += 3;
																			}
																			if (charm_id == 496) {
																				rows[0].weapon3_crit += 3;
																			}
																			if (charm_id == 696) {
																				rows[0].weapon_crit += 5;
																				rows[0].weapon2_crit += 5;
																				rows[0].weapon3_crit += 3;
																			}
																			if (charm_id == 698) {
																				rows[0].weapon += 30;
																			}
																			if (abBonus > 0) {
																				rows[0].weapon_crit += abBonus;
																				rows[0].weapon2_crit += abBonus;
																				rows[0].weapon3_crit += abBonus;
																			}

																			//Vocazioni

																			if ((class_id == 2) && (reborn == 3)) {
																				rows[0].weapon2_crit += 5;
																			}
																			if ((class_id == 2) && (reborn >= 4)) {
																				rows[0].weapon2_crit += 7;
																				rows[0].weapon3_crit += 7;
																			}
																			if ((class_id == 4) && (reborn == 3)) {
																				rows[0].weapon_crit += 2;
																				rows[0].weapon2_crit += 2;
																				rows[0].weapon3_crit += 2;
																			}
																			if ((class_id == 4) && (reborn >= 4)) {
																				rows[0].weapon_crit += 7;
																				rows[0].weapon2_crit += 7;
																				rows[0].weapon3_crit += 7;
																			}
																			if ((class_id == 5) && (reborn == 3)) {
																				rows[0].weapon3_crit += 4;
																			}
																			if ((class_id == 5) && (reborn >= 4)) {
																				rows[0].weapon3_crit += 8;
																			}
																			if ((class_id == 6) && (reborn == 3)) {
																				rows[0].weapon2_crit += 2;
																			}
																			if ((class_id == 6) && (reborn == 3)) {
																				rows[0].weapon3_crit += 2;
																			}
																			if ((class_id == 6) && (reborn >= 4)) {
																				rows[0].weapon2_crit += 7;
																			}
																			if ((class_id == 6) && (reborn >= 4)) {
																				rows[0].weapon3_crit += 7;
																			}
																			if ((class_id == 6) && (reborn == 5)) {
																				rows[0].weapon2_crit += 7;
																			}
																			if ((class_id == 6) && (reborn == 5)) {
																				rows[0].weapon3_crit += 7;
																			}
																			if ((class_id == 8) && (reborn == 3)) {
																				rows[0].weapon3_crit += 5;
																			}
																			if ((class_id == 8) && (reborn >= 4)) {
																				rows[0].weapon3_crit += 7;
																			}
																			if ((class_id == 8) && (reborn == 5)) {
																				rows[0].weapon_crit += 10;
																			}
																			if ((class_id == 9) && (reborn == 3)) {
																				rows[0].weapon_crit += 2;
																				rows[0].weapon3_crit += 2;
																			}
																			if ((class_id == 9) && (reborn >= 4)) {
																				rows[0].weapon_crit += 7;
																				rows[0].weapon3_crit += 7;
																			}

																			if ((class_id == 7) && (reborn == 5)) {
																				rows[0].weapon_crit += Math.round(dragon_critical / 2);
																			}

																			if ((class_id == 8) && (reborn == 2)) {
																				rows[0].weapon += rows[0].weapon * 0.10;
																			}else if ((class_id == 8) && (reborn == 3)) {
																				rows[0].weapon += rows[0].weapon * 0.15;
																			}else if ((class_id == 8) && (reborn == 4)) {
																				rows[0].weapon += rows[0].weapon * 0.17;
																			}else if ((class_id == 8) && (reborn == 5)) {
																				rows[0].weapon += rows[0].weapon * 0.30;
																			}

																			//Descrizioni

																			var weapon_desc = "";
																			if (weapon != "-") {
																				rows[0].weapon += rows[0].power_dmg;
																				rows[0].weapon_crit += rows[0].power_weapon;
																				weapon_desc = " (+" + Math.round(rows[0].weapon) + ", " + rows[0].weapon_crit + "%, " + rows[0].weapon_enchant + enchant1 + ")";
																			}
																			var weapon2_desc = "";
																			if (weapon2 != "-") {
																				rows[0].weapon2 -= rows[0].power_def;
																				rows[0].weapon2_crit += rows[0].power_armor;
																				weapon2_desc = " (" + Math.round(rows[0].weapon2) + ", " + rows[0].weapon2_crit + "%, " + rows[0].weapon2_enchant + enchant2 + ")";
																			}
																			var weapon3_desc = "";
																			if (weapon3 != "-") {
																				rows[0].weapon3_crit += rows[0].power_shield;
																				weapon3_desc = " (" + Math.round(rows[0].weapon3) + ", " + rows[0].weapon3_crit + "%, " + rows[0].weapon3_enchant + enchant3 + ")";
																			}

																			var nickname = rows[0].nickname;
																			var weapon_d = parseInt(rows[0].weapon);
																			var lev = Math.floor(rows[0].exp / 10);
																			var player_atk = (lev + weapon_d + rows[0].weapon_enchant) + " - " + ((lev + weapon_d + rows[0].weapon_enchant) + (weapon_d + rows[0].weapon_enchant + dragon_claws));
																			var player_description = rows[0].player_description;
																			var player_custom_nickname = rows[0].player_custom_nickname;

																			var Keys = []

																			if (player == message.from.username) {
																				Keys.push(["Vocazione ðŸ¹", "Albero Talenti ðŸŒ³"]);
																				Keys.push(["Link Invito ðŸ—£", "Statistiche ðŸ“Š", "Artefatti ðŸ”±"]);
																				if (((weapon_id == 638) || (weapon_id == 639) || (weapon_id == 640) || (weapon_id == 754) ||
																					 (weapon2_id == 688) || (weapon2_id == 689) || (weapon2_id == 690) ||
																					 (weapon3_id == 671) || (weapon3_id == 672) || (weapon3_id == 673)) || (house_id >= 5)) {
																					Keys.push(["Nomina Equip/Rifugio ðŸ·"]);
																				}
																				if (boost_id != 0) {
																					Keys.push(["Annulla Bevanda Attiva ðŸš«"]);
																				}
																				Keys.push(["Descrizione Personale ðŸ’¬","Soprannome ðŸ’¬"],["Vacanza â›± ", "Sesso âš¤"]);
																			} else {
																				if (myhouse_id == 1) {
																					rows[0].life = "?";
																					rows[0].total_life = "?";
																					rows[0].heist_count = "?";
																					rows[0].spy_count = "?";
																					rows[0].money = "?";
																					rows[0].exp = "?";
																					lev = "?";
																					weapon = "?";
																					weapon_desc = "";
																					weapon2 = "?";
																					weapon2_desc = "";
																					weapon3 = "?";
																					weapon3_desc = "";
																					talismano = "?";
																					talismano_desc = "";
																					dragon_name = "?";
																					dragon_level = "?";
																					dragon_claws_n = "?";
																					dragon_damage = "?";
																					dragon_saddle_n = "?";
																					dragon_defence = "?";
																					dragon_critical = "?";
																					dragon_status = "?";
																				} else if (myhouse_id == 2) {
																					rows[0].heist_count = "?";
																					rows[0].spy_count = "?";
																					rows[0].money = "?";
																					weapon = "?";
																					weapon_desc = "";
																					weapon2 = "?";
																					weapon2_desc = "";
																					weapon3 = "?";
																					weapon3_desc = "";
																					talismano = "?";
																					talismano_desc = "";
																					dragon_name = "?";
																					dragon_level = "?";
																					dragon_claws_n = "?";
																					dragon_damage = "?";
																					dragon_saddle_n = "?";
																					dragon_arms_n = "?";
																					dragon_defence = "?";
																					dragon_critical = "?";
																				} else if (myhouse_id == 3) {
																					rows[0].heist_count = "?";
																					rows[0].spy_count = "?";
																					rows[0].money = "?";
																					talismano = "?";
																					talismano_desc = "";
																					dragon_name = "?";
																					dragon_level = "?";
																					dragon_claws_n = "?";
																					dragon_damage = "?";
																					dragon_saddle_n = "?";
																					dragon_defence = "?";
																					dragon_critical = "?";
																				} else if (myhouse_id == 4) {
																					rows[0].heist_count = "?";
																					rows[0].spy_count = "?";
																					rows[0].money = "?";
																				} else if (myhouse_id == 5) {
																					rows[0].money = "?";
																				}
																			}
																			Keys.push(["Torna al menu"]);

																			var kb = {
																				parse_mode: "HTML",
																				reply_markup: {
																					resize_keyboard: true,
																					//one_time_keyboard: true,
																					"keyboard": Keys
																				}
																			};

																			bot.sendMessage(message.chat.id, "<b>" + gender_text + "</b> ðŸ‘¤\n" +
																							"ðŸ‘¤ " + nickname + (player_custom_nickname != null ? " <i>" + player_custom_nickname + "</i>" : "") + "\n" +
																							team_desc + 
																							stars + " " + formatNumber(lev) + " (" + formatNumber(rows[0].exp) + " xp)" + "\n\n" +
																							"ðŸ¹ " + class_name + "\n" +
																							"ðŸ’Ž " + rows[0].gems + " ðŸ† " + inest + "\n" +
																							"ðŸ’° " + formatNumber(rows[0].money) + " Â§\n" +
																							"â¤ï¸ " + formatNumber(rows[0].life) + " / " + formatNumber(rows[0].total_life) + " hp\n" +
																							"ðŸ“¦ " + formatNumber(rows[0].craft_count) + " (" + formatNumber(rows[0].craft_week) + ")\n" +
																							"ðŸ• " + rifugio + "\n" +
																							"\n<b>Equipaggiamento</b> âš”ï¸\n" +
																							"ðŸ—¡ " + weapon + weapon_desc + "\n" +
																							"ðŸ¥‹ " + weapon2 + weapon2_desc + "\n" +
																							"ðŸ›¡ " + weapon3 + weapon3_desc + "\n" +
																							"ðŸ“¿ " + talismano + "\n" +
																							//"ðŸ’¥ " + player_atk + "\n" +

																							(dragon ? "\n<b>" + dragon_name + " (L" + dragon_level + ")</b> ðŸ‰\n" : "") +
																							(dragon ? "Stato: " + dragon_status + "\n" : "") +
																							(dragon ? dragon_claws_n + " (" + dragon_damage + ")\n" : "") +
																							(dragon ? dragon_saddle_n + " (" + dragon_defence + ")\n" : "") +
																							(dragon ? dragon_arms_n + "\n" : "") +
																							(dragon ? "Critico (" + dragon_critical + "%)\n" : "") +

																							"\n<b>Altro</b> ðŸ’±\n" +
																							referral +
																							"Artefatti: " + artifacts + "\n" +
																							"Rango: " + getRankName(rows[0].rank, 0) + " (" + rows[0].rank + ")\n" +
																							"AbilitÃ : " + formatNumber(rows[0].ability) + "\n" +
																							"Incarichi: " + formatNumber(rows[0].mission_team_count) + "\n" +
																							(player_description != null ? "\n<i>" + player_description + "</i>" : ""), kb);
																		});
																	});
																});
															});
														});
													});
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
};

bot.onText(/Sesso âš¤/i, function (message) {
	connection.query('SELECT id, real_name, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var my_gender = rows[0].gender;

		if (rows[0].real_name == null){
			bot.sendMessage(message.chat.id, "Puoi inserire sotto il tuo vero nome, questo verrÃ  utilizzato per identificare il tuo sesso e di conseguenza alcuni testi verranno visualizzati diversamente.\nAttenzione: puoi farlo solamente una volta, non sbagliare!\n\nInserisci il tuo nome qua sotto senza caratteri speciali o spazi.", back).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text == "Torna al menu"){
						return;
					}else{
						request('https://gender-api.com/get?name=' + answer.text + '&key=xTZExqbJQfWzdGPzcP&country=IT', function (error, response, body) {
							if (response.statusCode == 200){
								var json = JSON.parse(body);

								if ((json.name == undefined) || (json.gender == undefined)){
									bot.sendMessage(message.chat.id, "Per il momento non Ã¨ piÃ¹ possibile inserire nomi, riprova tra qualche giorno/ora", back);
									return;
								}

								var gender = "M";
								if (json.gender == "female"){
									gender = "F";
								}

								if (json.accuracy < 30){
									bot.sendMessage(message.chat.id, "Non Ã¨ stato possibile identificare il sesso, contatta l'amministratore", back);
									return;
								}

								connection.query('UPDATE player SET real_name = "' + json.name + '", gender = "' + gender + '" WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err; 

									bot.sendMessage(message.chat.id, "Hai inserito *" + json.name + "*, il sesso identificato Ã¨ *" + gender + "* con un accuratezza del *" + json.accuracy + "%*", back);

								});
							}else{
								bot.sendMessage(message.chat.id, "Errore, riprova", back);
							}
						});
					}
				}
			});
		}else{
			bot.sendMessage(message.chat.id, "Hai giÃ  impostato il nome, il sesso salvato Ã¨ " + my_gender + ". Per il momento non Ã¨ possibile modificarlo, in caso di problemi contatta l'amministratore", back);
			return;
		}
	});
});

bot.onText(/Rimodulatore di Flaridion|Torna dal rimodulatore|^rimodulatore$/i, function (message) {
	connection.query('SELECT id FROM artifacts WHERE item_id = 675 AND player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Devi possedere tutti gli artefatti per accedere a questa funzione", back);
			return;
		}

		connection.query('SELECT id, account_id, money, power_dmg, power_def, power_weapon, power_armor, power_shield, power_pnt, power_used, gain_exp, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
			if (err) throw err;

			var player_id = rows[0].id;
			/*
			if (player_id != 1){
				bot.sendMessage(message.chat.id, "Manutenzione", back);
				return;
			}
			*/
			var power_pnt = rows[0].power_pnt;
			var gain_exp = rows[0].gain_exp;
			var my_money = rows[0].money;
			var power_used = rows[0].power_used;
			var power_dmg = parseInt(rows[0].power_dmg);
			var power_def = parseInt(rows[0].power_def);
			var power_weapon = parseInt(rows[0].power_weapon);
			var power_armor = parseInt(rows[0].power_armor);
			var power_shield = parseInt(rows[0].power_shield);

			var arrMolt = [2,1,20,20,35];

			var gender_text = "o";
			if (rows[0].gender == "F")
				gender_text = "a";

			var banReason = isBanned(rows[0].account_id);
			if (banReason != null) {
				var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
				bot.sendMessage(message.chat.id, text, mark);
				return;
			}

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Acquista Flaridion ðŸ’°", "Reset ðŸš«"], ["Attacco (" + rimodPrice(power_dmg+1, arrMolt[0]) + " Flaridion)", "Difesa (" + rimodPrice(power_def+1, arrMolt[1]) + " Flaridion)"], ["Critico (" + rimodPrice(power_weapon+1, arrMolt[2]) + " Flaridion)"], ["Dimezzamento (" + rimodPrice(power_armor+1, arrMolt[3]) + " Flaridion)"], ["Annullamento (" + rimodPrice(power_shield+1, arrMolt[4]) + " Flaridion)"], ["Torna all'alchimia"], ["Torna al menu"]]
				}
			};

			var kbYesNo = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Si"], ["Torna dal rimodulatore"], ["Torna al menu"]]
				}
			};

			var kbBack = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Torna dal rimodulatore"], ["Torna al menu"]]
				}
			};

			var kbNum = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["1", "5", "10"], ["Torna al menu"]]
				}
			};

			var text = "Benvenut" + gender_text + " dal *Rimodulatore di Flaridion* ðŸ”¨!\nPuoi acquistare dei Flaridion per ottenere forza e abilitÃ  aggiuntiva, ogni caratteristica ha un costo diverso ed incrementa man mano che la caratteristica viene potenziata. Al momento possiedi *" + formatNumber(power_pnt) + " Flaridion* inutilizzati, ne hai utilizzati " + formatNumber(power_used) + ".\n\n" +
				"Attacco: +" + formatNumber(power_dmg) + "\n" +
				"Difesa: +" + formatNumber(power_def) + "\n" +
				"Critico Arma: +" + power_weapon + "\n" +
				"Dimezzamento Armatura: +" + power_armor + "\n" +
				"Annullamento Scudo: +" + power_shield + "\n" +
				"\nCosa vuoi fare?";

			bot.sendMessage(message.chat.id, text, kb).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if ((answer.text == "Torna al menu") || (answer.text == "Torna all'alchimia")) {
						return;
					} else if (answer.text.indexOf("Acquista Flaridion") != -1) {
						var price_money = 1000000;
						var price_exp = 30;

						bot.sendMessage(message.chat.id, "Ogni Flaridion ti costerÃ  *" + formatNumber(price_money) + " Â§ e " + price_exp + " exp accumulata*, hai a disposizione " + formatNumber(my_money) + " Â§ e " + gain_exp + " exp accumulata, quanti ne vuoi acquistare?", kbNum).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if ((answer.text == "Torna dal rimodulatore") || (answer.text == "Torna al menu")) {
									return;
								} else {
									var num = parseInt(answer.text);
									if (isNaN(num)){
										bot.sendMessage(message.chat.id, "QuantitÃ  non valida!", kbBack);
										return;
									}
									if (num < 1) {
										bot.sendMessage(message.chat.id, "Devi acquistarne almeno uno!", kbBack);
										return;
									}

									bot.sendMessage(message.chat.id, "Sicuro di voler acquistare *" + formatNumber(num) + " Flaridion*?", kbYesNo).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.toLowerCase() == "si") {
												connection.query('SELECT money, gain_exp FROM player WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													price_money = price_money * num;
													price_exp = price_exp * num;

													if (rows[0].money < price_money) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza monete, te ne servono " + formatNumber(price_money) + "!", kbBack);
														return;
													}

													if (rows[0].gain_exp < price_exp) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza exp accumulata, te ne serve " + formatNumber(price_exp) + "!", kbBack);
														return;
													}

													connection.query('UPDATE player SET money = money-' + price_money + ', gain_exp = gain_exp-' + price_exp + ', power_pnt = power_pnt+' + num + ' WHERE id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Acquisto completato! Il mercante ti assegna *" + num + " Flaridion* e ti ringrazia per l'affare concluso!", kbBack);
													});
												});
											}
										}
									});
								}
							}
						});
					} else if (answer.text.indexOf("Reset") != -1) {
						if (power_used == 0) {
							bot.sendMessage(message.chat.id, "Devi procedere almeno ad un potenziamento per poterli resettare", kbBack);
							return;
						}
						var gems = 500;
						bot.sendMessage(message.chat.id, "Puoi redistribuire i potenziamenti al costo di *" + gems + " ðŸ’Ž* ottenendo *" + formatNumber(power_used) + " Flaridion*, procedi?", kbYesNo).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase() == "si") {
									connection.query('SELECT gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										if (rows[0].gems < gems) {
											bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž!", kbBack);
											return;
										}

										connection.query('UPDATE player SET gems = gems-' + gems + ', power_used = 0, power_pnt = power_pnt+' + power_used + ', power_dmg = 0, power_def = 0, power_weapon = 0, power_armor = 0, power_shield = 0 WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Sono stati riaccreditati " + formatNumber(power_used) + " Flaridion!", kbBack);
										});
									});
								}
							}
						});
					} else {
						var price_coin = 1;
						var value = 0;
						var query = "";
						var power_name = answer.text.substr(0, answer.text.indexOf("(") - 1);
						var molt = 0;
						if (power_name == "Attacco") {
							value = power_dmg;
							query = "power_dmg";
							molt = arrMolt[0];
						} else if (power_name == "Difesa") {
							value = power_def;
							query = "power_def";
							molt = arrMolt[1];
						} else if (power_name == "Critico") {
							value = power_weapon;
							query = "power_weapon";
							molt = arrMolt[2];
						} else if (power_name == "Dimezzamento") {
							value = power_armor;
							query = "power_armor";
							molt = arrMolt[3];
						} else if (power_name == "Annullamento") {
							value = power_shield;
							query = "power_shield";
							molt = arrMolt[4];
						} else {
							bot.sendMessage(message.chat.id, "Caratteristica non valida", kbBack);
							return;
						}

						price_coin = rimodPrice(value+1, molt);

						bot.sendMessage(message.chat.id, "Il Rimodulatore incrementerÃ  questa caratteristica al costo di *" + price_coin + " Flaridion*, confermi?", kbYesNo).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase() == "si") {

									bot.sendMessage(message.chat.id, "Sicuro di voler consumare *" + price_coin + "* Flaridion per ottenere +1 " + power_name + "?", kbYesNo).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.toLowerCase() == "si") {
												connection.query('SELECT power_pnt FROM player WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													if (rows[0].power_pnt < price_coin) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza Flaridion!", kbBack);
														return;
													}
													connection.query('UPDATE player SET power_pnt = power_pnt-' + price_coin + ', ' + query + ' = ' + query + '+1, power_used = power_used+' + price_coin + ' WHERE id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Il Rimodulatore di Flaridion ha portato la tua caratteristica *" + power_name + "* a *+" + (value+1) + "*!", kbBack);
														console.log(message.from.username + " rimodulatore di " + power_name + " a " + (value+1) + " per " + price_coin);
													});
												});
											}
										}
									});
								}
							}
						});
					}
				};
			});
		});
	});
});

function rimodPrice(nextLevel, unitPrice){
	var x = 0;
	var y = 0;
	for (i = 0; i < nextLevel; i++) {
		y = x;
		x += funz(x) * unitPrice;
	}

	return Math.round(x - y);
}

function funz(x) {
	return 1 + (Math.pow(x, 1.8)) / 100000;
}

bot.onText(/annulla bevanda/i, function (message) {
	connection.query('SELECT id, boost_id, boost_mission FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		if (rows[0].boost_id == 0) {
			bot.sendMessage(message.chat.id, "Non hai nessuna bevanda attiva, puoi produrle con il drago o trovarle nelle missioni", back);
			return;
		}

		var cost = 1;
		if (crazyMode == 1) {
			cost = 3;
		}

		bot.sendMessage(message.chat.id, "Sei sicuro di voler annullare la bevanda attiva? Ti costerÃ  " + cost + " ðŸ’Ž", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					connection.query('SELECT gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						var gems = rows[0].gems;

						if (gems < cost) {
							bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž!", back);
							return;
						}

						connection.query('UPDATE player SET gems = gems-' + cost + ', boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "La bevanda attiva Ã¨ stata annullata", back);
						});
					});
				};
			};
		});
	});
});

bot.onText(/descrizione personale/i, function (message) {
	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		bot.sendMessage(message.chat.id, "Inserisci la descrizione del tuo personaggio, comparirÃ  quando altri giocatori ti spiano.\nNon utilizzare insulti, bestemmie, offese verso gli altri player, ecc., massimo 500 caratteri, non andare a capo e non tutti i simboli sono consentiti. Scrivi _cancella_ per rimuovere la descrizione.", back).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text != "Torna al menu") {
					var resp = answer.text;

					if (resp.toLowerCase() == "cancella"){
						bot.sendMessage(message.chat.id, "Descrizione personaggio rimossa", back);
						connection.query('UPDATE player SET player_description = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
						return;
					}

					var reg = new RegExp("^[a-zA-Z0-9Ã Ã¨Ã¬Ã²Ã¹Ã©.,\\\?\!\'\@\(\) ]{1,500}$");
					if (reg.test(resp) == false) {
						bot.sendMessage(message.chat.id, "Descrizione non valida, riprova", back);
						return;
					}
					bot.sendMessage(message.chat.id, "Descrizione personaggio impostata:\n\n_" + resp + "_", back);
					connection.query('UPDATE player SET player_description = "' + resp + '" WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});
				}
			}
		});
	});
});

bot.onText(/soprannome/i, function (message) {
	connection.query('SELECT id, exp FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		if (Math.floor(rows[0].exp/10) < 1000){
			bot.sendMessage(message.chat.id, "Puoi impostare il soprannome solo al livello 1.000", back);
			return;
		}

		bot.sendMessage(message.chat.id, "Inserisci il soprannome per il tuo personaggio, comparirÃ  a fianco al tuo nome, come ad esempio 'fenix45 l'ubriaco'.\nNon utilizzare insulti, bestemmie, offese verso gli altri player, ecc., massimo 20 caratteri, non andare a capo e non tutti i simboli sono consentiti. Scrivi _cancella_ per rimuovere il soprannome.", back).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text != "Torna al menu") {
					var resp = answer.text;

					if (resp.toLowerCase() == "cancella"){
						bot.sendMessage(message.chat.id, "Soprannome rimosso", back);
						connection.query('UPDATE player SET player_custom_nickname = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
						return;
					}

					var reg = new RegExp("^[a-zA-ZÃ Ã¨Ã¬Ã²Ã¹Ã©.,\\\?\!\'\@\(\) ]{1,20}$");
					if (reg.test(resp) == false) {
						bot.sendMessage(message.chat.id, "Soprannome non valido, riprova", back);
						return;
					}
					bot.sendMessage(message.chat.id, "Soprannome personaggio impostato:\n\n<i>" + message.from.username + " " + resp + "</i>", back_html);
					connection.query('UPDATE player SET player_custom_nickname = "' + resp + '" WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});
				}
			}
		});
	});
});

bot.onText(/trasmogrificazione|trasmo$|^\/trasmo (.+)/i, function (message, match) {

	/*
	if (message.from.id != 20471035){
		bot.sendMessage(message.chat.id, "A breveeeeeeh", back);
		return;
	}
	*/

	connection.query('SELECT id, exp FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp / 10);

		connection.query('SELECT 1 FROM necro_change WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {

				var kb = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Procedi"], ["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Per sbloccare questa funzionalitÃ  ti serviranno questi requisiti:\n" +
								"> 160 Livelli complessivi dei Talenti\n" +
								"> Almeno 4 Artefatti ottenuti\n" +
								"> Livello 1000\n" +
								"> Drago al livello 200\n" +
								"> Set Necro Base (verrÃ  consumato)\n" +
								"\nIn seguito potrai cambiare il tipo di equipaggiamento Necro.", kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text == "Procedi") {

							connection.query("SELECT SUM(ability_level) As cnt FROM ability WHERE player_id = " + player_id, function (err, rows, fields) {
								if (err) throw err;

								if (rows[0].cnt < 160) {
									bot.sendMessage(message.chat.id, "I talenti ottenuti non sono sufficienti", back);
									return;
								}

								connection.query("SELECT COUNT(item_id) As cnt FROM artifacts WHERE player_id = " + player_id, function (err, rows, fields) {
									if (err) throw err;

									if (rows[0].cnt < 4) {
										bot.sendMessage(message.chat.id, "Gli artefatti ottenuti non sono sufficienti", back);
										return;
									}

									if (level < 1000) {
										bot.sendMessage(message.chat.id, "Il livello del personaggio ottenuto non Ã¨ sufficiente", back);
										return;
									}

									connection.query('SELECT * FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Non possiedi il drago", back);
											return;
										}

										if (rows[0].level < 200) {
											bot.sendMessage(message.chat.id, "Il livello del drago ottenuto non Ã¨ sufficiente", back);
											return;
										}

										if (getItemCnt(player_id, 221) < 1) {
											bot.sendMessage(message.chat.id, "Non possiedi la Necrolama", back);
											return;
										}

										if (getItemCnt(player_id, 577) < 1) {
											bot.sendMessage(message.chat.id, "Non possiedi la Corazza Necro", back);
											return;
										}

										if (getItemCnt(player_id, 600) < 1) {
											bot.sendMessage(message.chat.id, "Non possiedi lo Scudo Necro", back);
											return;
										}

										delItem(player_id, 221, 1);
										delItem(player_id, 577, 1);
										delItem(player_id, 600, 1);

										connection.query('INSERT INTO necro_change (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Hai ottenuto l'accesso alle *Porte degli Dei*, potrai cambiare il tipo di equipaggiamento Necro su richiesta!", back);
										});
									});
								});
							});
						};
					};
				});
				return;
			}

			var kb = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Necrolama"], ["Corazza Necro"], ["Scudo Necro"], ["Torna al menu"]]
				}
			};

			var kb2 = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Rossa", "Gialla", "Blu"], ["Torna alla trasmo"]]
				}
			};

			var kbWeap = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Rossa", "Gialla", "Blu"], ["Torna alla trasmo"]]
				}
			};

			connection.query('SELECT step FROM necro_game WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var step6 = 0;
				if (Object.keys(rows).length > 0) {
					if (rows[0].step == 6){
						kbWeap = {
							parse_mode: "HTML",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Rossa", "Gialla"], ["Blu", "Bianca"], ["Torna alla trasmo"]]
							}
						};
						step6 = 1;
					}
				}

				var kbBack = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Torna alla trasmo"], ["Boss", "Torna al menu"]]
					}
				};

				if (message.text.indexOf("/trasmo") != -1){
					var query = match[1].split(",");
					var len = Object.keys(query).length;

					if (len < 3){
						bot.sendMessage(message.chat.id, "Sintassi: /trasmo bianca,gialla,rosso (spada, armatura, scudo)");
						return;
					}

					connection.query('SELECT weapon_id, weapon2_id, weapon3_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						if ((rows[0].weapon_id != 638) && (rows[0].weapon_id != 639) && (rows[0].weapon_id != 640) && (rows[0].weapon_id != 754)) {
							bot.sendMessage(message.chat.id, "Equipaggia una delle 4 lame incantate per poterla scambiare");
							return;
						}

						if ((rows[0].weapon2_id != 688) && (rows[0].weapon2_id != 689) && (rows[0].weapon2_id != 690)) {
							bot.sendMessage(message.chat.id, "Equipaggia una delle 3 corazze incantate per poterla scambiare");
							return;
						}

						if ((rows[0].weapon3_id != 671) && (rows[0].weapon3_id != 672) && (rows[0].weapon3_id != 673)) {
							bot.sendMessage(message.chat.id, "Equipaggia uno dei 3 scudi incantati per poterlo scambiare");
							return;
						}

						var weapon = 0;
						if (query[0].toLowerCase() == "rossa"){
							weapon = 639;
						}else if (query[0].toLowerCase() == "gialla"){
							weapon = 638;
						}else if (query[0].toLowerCase() == "blu"){
							weapon = 640;
						}else if (query[0].toLowerCase() == "bianca"){
							if (step6 == 0){
								bot.sendMessage(message.chat.id, "Devi prima sbloccare la trasmogrificazione della Necrolama di Phoenix nella Necro del Destino!");
								return;
							}
							weapon = 754;
						}else{
							bot.sendMessage(message.chat.id, "Colore arma non valido, riprova");
							return;
						}

						var weapon2 = 0;
						if (query[1].toLowerCase() == "rossa"){
							weapon2 = 688;
						}else if (query[1].toLowerCase() == "gialla"){
							weapon2 = 690;
						}else if (query[1].toLowerCase() == "blu"){
							weapon2 = 689;
						}else{
							bot.sendMessage(message.chat.id, "Colore armatura non valido, riprova");
							return;
						}

						var weapon3 = 0;
						if (query[2].toLowerCase() == "rosso"){
							weapon3 = 672;
						}else if (query[2].toLowerCase() == "giallo"){
							weapon3 = 671;
						}else if (query[2].toLowerCase() == "blu"){
							weapon3 = 673;
						}else{
							bot.sendMessage(message.chat.id, "Colore scudo non valido, riprova");
							return;
						}

						connection.query('UPDATE player SET weapon_id = ' + weapon + ', weapon2_id = ' + weapon2 + ', weapon3_id = ' + weapon3 + ' WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Equipaggiamento cambiato di tipo!");
						});
					});

					return;
				}

				bot.sendMessage(message.chat.id, "Scegli l'oggetto dell'Equip Necro da cambiare", kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text == "Torna al menu") {
							return;
						} else {
							var set = answer.text;
							bot.sendMessage(message.chat.id, "Con quale tipo di oggetto vuoi scambiarlo?", kbWeap).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Torna al menu") {
										return;
									}
									var type = answer.text;
									if (set.toLowerCase() == "necrolama") {
										connection.query('SELECT weapon_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if ((rows[0].weapon_id != 638) && (rows[0].weapon_id != 639) && (rows[0].weapon_id != 640) && (rows[0].weapon_id != 754)) {
												bot.sendMessage(message.chat.id, "Equipaggia una delle 4 lame incantate per poterla scambiare", kbBack);
												return;
											}

											var id = 0;
											if (type.toLowerCase() == "rossa") {
												id = 639;
											} else if (type.toLowerCase() == "gialla") {
												id = 638;
											} else if (type.toLowerCase() == "blu") {
												id = 640;
											} else if (type.toLowerCase() == "bianca") {
												if (step6 == 0){
													bot.sendMessage(message.chat.id, "Devi prima sbloccare la trasmogrificazione della Necrolama di Phoenix nella Necro del Destino!", kbBack);
													return;
												}
												id = 754;
											} else {
												bot.sendMessage(message.chat.id, "Colore non valido", kbBack);
												return;
											}

											connection.query('UPDATE player SET weapon_id = ' + id + ' WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Necrolama cambiata di tipo, ora Ã¨ *" + type + "*!", kbBack);
											});
										});
									} else if (set.toLowerCase() == "corazza necro") {
										connection.query('SELECT weapon2_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if ((rows[0].weapon2_id != 688) && (rows[0].weapon2_id != 689) && (rows[0].weapon2_id != 690)) {
												bot.sendMessage(message.chat.id, "Equipaggia una delle 3 corazze incantate per poterla scambiare", kbBack);
												return;
											}

											var id = 0;
											if (type.toLowerCase() == "rossa") {
												id = 688;
											} else if (type.toLowerCase() == "gialla") {
												id = 690;
											} else if (type.toLowerCase() == "blu") {
												id = 689;
											} else {
												bot.sendMessage(message.chat.id, "Colore non valido", kbBack);
												return;
											}

											connection.query('UPDATE player SET weapon2_id = ' + id + ' WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Corazza Necro cambiata di tipo, ora Ã¨ *" + type + "*!", kbBack);
											});
										});
									} else if (set.toLowerCase() == "scudo necro") {
										connection.query('SELECT weapon3_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if ((rows[0].weapon3_id != 671) && (rows[0].weapon3_id != 672) && (rows[0].weapon3_id != 673)) {
												bot.sendMessage(message.chat.id, "Equipaggia uno dei 3 scudi incantati per poterlo scambiare", kbBack);
												return;
											}

											var id = 0;
											if (type.toLowerCase() == "rossa") {
												id = 672;
												type = "Rosso";
											} else if (type.toLowerCase() == "gialla") {
												id = 671;
												type = "Giallo";
											} else if (type.toLowerCase() == "blu") {
												id = 673;
											} else {
												bot.sendMessage(message.chat.id, "Colore non valido", kbBack);
												return;
											}

											connection.query('UPDATE player SET weapon3_id = ' + id + ' WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Scudo Necro cambiato di tipo, ora Ã¨ *" + type + "*!", kbBack);
											});
										});
									}
								};
							});
						};
					};
				});
			});
		});
	});
});

bot.onText(/nomina equip/i, function (message) {
	var kb = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Nomina Necrolama"], ["Nomina Corazza Necro"], ["Nomina Scudo Necro"], ["Nomina Rifugio"], ["Torna al menu"]]
		}
	};

	bot.sendMessage(message.chat.id, "Quale elemento vuoi rinominare?", kb);
});

bot.onText(/nomina necrolama/i, function (message) {
	connection.query('SELECT id, weapon_id, custom_name FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var weapon_id = rows[0].weapon_id;

		if (rows[0].custom_name != null) {
			bot.sendMessage(message.chat.id, "Ripristinare il nome originale della Necrolama?", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('UPDATE player SET custom_name = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Hai ripristinato il nome originale della tua Necrolama!", back);
						});
					}
				}
			});
			return;
		}

		if ((weapon_id != 638) && (weapon_id != 639) && (weapon_id != 640) && (weapon_id != 754)) {
			bot.sendMessage(message.chat.id, "Equipaggia una delle 4 Necrolame Incantate per utilizzare questa funzionalitÃ ", back);
			return;
		}

		bot.sendMessage(message.chat.id, "Inserisci il nome da utilizzare per la tua *Necrolama*, risulterÃ  poi in questo modo: '_Nomeinserito_+lama' per esempio inserendo '_Banana_', il nome diventerÃ  '_Bananalama_'.\nNon utilizzare nomi non consoni, divinitÃ , insulti, ecc., massimo 10 caratteri e nessun simbolo!", back).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text != "Torna al menu") {
					var resp = answer.text;
					var reg = new RegExp("^[a-zA-ZÃ Ã¨Ã¬Ã²Ã¹Ã©.,\\\?\!\'\@\(\)]{1,20}$");
					if (reg.test(resp) == false) {
						bot.sendMessage(message.chat.id, "Nome non valido, riprova", back);
						return;
					}
					connection.query('SELECT name FROM item WHERE id = ' + weapon_id, function (err, rows, fields) {
						if (err) throw err;

						bot.sendMessage(message.chat.id, "Complimenti! La tua nuova Necrolama si chiama ora *" + resp + rows[0].name.replace("Necro", "") + "*!", back);
						connection.query('UPDATE player SET custom_name = "' + resp + '" WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					});
				}
			}
		});
	});
});

bot.onText(/nomina corazza necro/i, function (message) {
	connection.query('SELECT id, weapon2_id, custom_name2 FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var weapon2_id = rows[0].weapon2_id;

		if (rows[0].custom_name2 != null) {
			bot.sendMessage(message.chat.id, "Ripristinare il nome originale della Corazza?", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('UPDATE player SET custom_name2 = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Hai ripristinato il nome originale della tua Corazza!", back);
						});
					}
				}
			});
			return;
		}

		if ((weapon2_id != 688) && (weapon2_id != 689) && (weapon2_id != 690)) {
			bot.sendMessage(message.chat.id, "Equipaggia una delle 3 Corazze Incantate per utilizzare questa funzionalitÃ ", back);
			return;
		}

		bot.sendMessage(message.chat.id, "Inserisci il nome da utilizzare per la tua *Corazza*, risulterÃ  poi in questo modo: 'Corazza _Nomeinserito_' per esempio inserendo '_Banana_', il nome diventerÃ  'Corazza _Banana_'.\nNon utilizzare nomi non consoni, divinitÃ , insulti, ecc., massimo 10 caratteri e nessun simbolo!", back).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text != "Torna al menu") {
					var resp = answer.text;
					var reg = new RegExp("^[a-zA-ZÃ Ã¨Ã¬Ã²Ã¹Ã©.,\\\?\!\'\@\(\)]{1,20}$");
					if (reg.test(resp) == false) {
						bot.sendMessage(message.chat.id, "Nome non valido, riprova", back);
						return;
					}
					connection.query('SELECT name FROM item WHERE id = ' + weapon2_id, function (err, rows, fields) {
						if (err) throw err;

						bot.sendMessage(message.chat.id, "Complimenti! La tua nuova Corazza si chiama ora *" + rows[0].name.replace("Necro", resp) + "*!", back);
						connection.query('UPDATE player SET custom_name2 = "' + resp + '" WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					});
				}
			}
		});
	});
});

bot.onText(/nomina scudo necro/i, function (message) {
	connection.query('SELECT id, weapon3_id, custom_name3 FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var weapon3_id = rows[0].weapon3_id;

		if (rows[0].custom_name3 != null) {
			bot.sendMessage(message.chat.id, "Ripristinare il nome originale dello Scudo?", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('UPDATE player SET custom_name3 = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Hai ripristinato il nome originale del tuo Scudo!", back);
						});
					}
				}
			});
			return;
		}

		if ((weapon3_id != 671) && (weapon3_id != 672) && (weapon3_id != 673)) {
			bot.sendMessage(message.chat.id, "Equipaggia uno dei 3 Scudi Incantati per utilizzare questa funzionalitÃ ", back);
			return;
		}

		bot.sendMessage(message.chat.id, "Inserisci il nome da utilizzare per il tuo *Scudo*, risulterÃ  poi in questo modo: 'Scudo _Nomeinserito_' per esempio inserendo '_Banana_', il nome diventerÃ  'Scudo _Banana_'.\nNon utilizzare nomi non consoni, divinitÃ , insulti, ecc., massimo 10 caratteri e nessun simbolo!", back).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text != "Torna al menu") {
					var resp = answer.text;
					var reg = new RegExp("^[a-zA-ZÃ Ã¨Ã¬Ã²Ã¹Ã©.,\\\?\!\'\@\(\)]{1,20}$");
					if (reg.test(resp) == false) {
						bot.sendMessage(message.chat.id, "Nome non valido, riprova", back);
						return;
					}
					connection.query('SELECT name FROM item WHERE id = ' + weapon3_id, function (err, rows, fields) {
						if (err) throw err;

						bot.sendMessage(message.chat.id, "Complimenti! Il tuo nuovo Scudo si chiama ora *" + rows[0].name.replace("Necro", resp) + "*!", back);
						connection.query('UPDATE player SET custom_name3 = "' + resp + '" WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					});
				}
			}
		});
	});
});

bot.onText(/nomina rifugio/i, function (message) {
	connection.query('SELECT id, house_id, custom_name_h FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var house_id = rows[0].house_id;

		if (rows[0].custom_name_h != null) {
			bot.sendMessage(message.chat.id, "Ripristinare il nome originale del Rifugio?", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('UPDATE player SET custom_name_h = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Hai ripristinato il nome originale del Rifugio!", back);
						});
					}
				}
			});
			return;
		}

		if (house_id < 5) {
			bot.sendMessage(message.chat.id, "Devi possedere il rifugio almeno al livello 5 per utilizzare questa funzionalitÃ ", back);
			return;
		}

		bot.sendMessage(message.chat.id, "Inserisci il nome da utilizzare per il tuo *Rifugio*, risulterÃ  poi in questo modo: 'Rifugio _Nomeinserito_' per esempio inserendo '_Banana_', il nome diventerÃ  'Rifugio _Banana_'.\nNon utilizzare nomi non consoni, divinitÃ , insulti, ecc., massimo 15 caratteri, spazi e nessun simbolo!", back).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text != "Torna al menu") {
					var resp = answer.text;
					var reg = new RegExp("^[a-zA-Z ]{0,30}$");
					if (reg.test(resp) == false) {
						bot.sendMessage(message.chat.id, "Nome non valido, riprova", back);
						return;
					}
					connection.query('SELECT name FROM house WHERE grade = ' + house_id, function (err, rows, fields) {
						if (err) throw err;

						bot.sendMessage(message.chat.id, "Complimenti! Il tuo nuovo Rifugio si chiama ora *Rifugio " + resp + "*!", back);
						connection.query('UPDATE player SET custom_name_h = "' + resp + '" WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					});
				}
			}
		});
	});
});

bot.onText(/resetta guide/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		bot.sendMessage(message.chat.id, "Sei sicuro di voler ripristinare tutte le guide per sezione?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					connection.query('DELETE FROM help_message WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Le guide sono state resettate!", back);
					});
				}
			}
		});
	});
});

bot.onText(/casa dei giochi/i, function (message) {

	var s = 1;
	if ((message.from.id != 20471035) && (message.from.username != "Gaius87") && (message.from.username != "lorsalv") && (message.from.username != "Juri_L") && (message.from.username != "CH4R124RD") && (message.from.username != "Raukonar") && (message.from.username != "Shaeryen")) {
		s = 0;
	}

	if (s == 0) {
		var d = new Date();
		if (d.getDay() != 3) {
			bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
			return;
		}
		if ((d.getHours() < 10) || (d.getHours() > 21)) {
			bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
			return;
		}
	}

	connection.query('SELECT account_id, market_ban, holiday, id, reborn, money, exp, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp/10);
		var myMoney = rows[0].money;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		if ((level < 50) && (rows[0].reborn == 1)){
			bot.sendMessage(message.chat.id, "Raggiungi almeno il livello 50 per accedere a questa funzione! Dopo di che potrai tentare la fortuna in vari mini giochi e ottenere interessanti somme di monete!", back);
			return;
		}

		var game = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Numero Fortunato ðŸ¥‡", "Combo Craft ðŸ’Ž"], ["Carte e Pirata ðŸ“ƒ"], ["Torna al menu"]]
			}
		};

		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbBack2 = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbRote = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Gira Rotelle"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbNum = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Gioca Numeri"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbCard = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Vedi la Carta ðŸ“ƒ"], ["Classifica", "Tabella Premi"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		connection.query('SELECT id FROM game_house_stats WHERE type = 1 AND player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO game_house_stats (player_id, type) VALUES (' + player_id + ', 1)', function (err, rows, fields) {
					if (err) throw err;
				});
			}
		});

		connection.query('SELECT id FROM game_house_stats WHERE type = 2 AND player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO game_house_stats (player_id, type) VALUES (' + player_id + ', 2)', function (err, rows, fields) {
					if (err) throw err;
				});
			}
		});

		connection.query('SELECT id FROM game_house_stats WHERE type = 3 AND player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO game_house_stats (player_id, type) VALUES (' + player_id + ', 3)', function (err, rows, fields) {
					if (err) throw err;
				});
			}
		});

		bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella Casa dei Giochi!\nSeleziona il gioco a cui vuoi partecipare", game).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if ((answer.text.indexOf("Numero Fortunato") != -1)) {
					bot.sendMessage(message.chat.id, "*Numero Fortunato*\n\nIn questo gioco puoi puntare su uno o piÃ¹ numeri e offrire una certa somma di Â§, quando avrai specificato entrambe le informazioni, la _Sfera Tempesta_ verrÃ  fatta girare nel grosso campo da gioco e si fermerÃ  su uno dei 36 numeri (37 considerando lo 0, che perÃ² Ã¨ sempre perdente). Se almeno una delle tue previsioni sarÃ  corretta, otterrai una vincita pari a quanto puntato per il numero di previsioni.\n\nAl momento possiedi " + formatNumber(myMoney) + " Â§", kbNum);
				} else if ((answer.text.indexOf("Combo Craft") != -1)) {
					var price = 1000;
					bot.sendMessage(message.chat.id, "*Combo di Craft*\n\nIn questo gioco puoi tentare la fortuna facendo girare le 3 _Rotelle X_ e tentare di vincere qualcosa. Quando tutte e 3 segneranno lo stesso simbolo, otterrai oggetti o strumenti particolari. Ogni giocata ti costerÃ  " + price + " Â§, procedi?\n\nAl momento possiedi " + formatNumber(myMoney) + " Â§", kbRote);
				} else if ((answer.text.indexOf("Carte e Pirata") != -1)) {
					var price = 500;
					bot.sendMessage(message.chat.id, "*Carte e Pirata*\n\nIn questo gioco dovrai sfidare il Pirata a _Carte Stropicciate_ e indovinare piÃ¹ volte possibili di fila se la carta successiva sarÃ  piÃ¹ alta o piÃ¹ bassa della precedente. Le carte hanno un valore che varia casualmente tra 1 e 20. Giocare ti costerÃ  " + price + " Â§ a carta, il gioco finisce quando non indovini e riceverai un premio partendo dalle 5 vittorie di fila, procedi?\n\nAl momento possiedi " + formatNumber(myMoney) + " Â§", kbCard).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text == "Classifica") {

								var text = "Classifica per vittorie consecutive:\n";
								var c = 1;
								var mypnt = 0;
								var totpnt = 0;
								var mypos = 0;
								var size = 20;

								connection.query('SELECT nickname, record FROM game_house_stats, player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND game_house_stats.player_id = player.id AND player.id NOT IN (1,3) AND game_house_stats.type = 3 ORDER BY record DESC', function (err, rows, fields) {
									if (err) throw err;
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										if (c < size + 1) {
											rows[i].total_cnt = formatNumber(rows[i].record);
											text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].record + ")\n";
										}
										if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
											mypnt = rows[i].record;
											mypos = c;
										}
										c++;
									}
									text = text + "\nTu:\n" + mypos + "Â° " + message.from.username + " (" + mypnt + ")";

									bot.sendMessage(message.chat.id, text, kbBack2);
								});
							} else if (answer.text == "Tabella Premi") {
								var text = "*Tabella premi*:\n\n" +
									"_(Vittorie consecutive)_\n" +
									"5-6: 5x Scrigno di Legno\n" +
									"7-9: 5x Scrigno di Ferro\n" +
									"10-11: 5x Scrigno Prezioso\n" +
									"12-14: 5x Scrigno di Diamante\n" +
									"15-19: 5x Scrigno Leggendario\n" +
									"20-24: 5x Scrigno Epico\n" +
									"25-29: 15x Scrigno Epico\n" +
									"30-in su: 1x Scrigno Capsula";

								bot.sendMessage(message.chat.id, text, kbBack);
							}
						};
					});
				}
			};
		});
	});
});

bot.onText(/gioca numeri/i, function (message) {

	if (!checkSpam(message)) {
		return;
	}

	var s = 1;
	if ((message.from.id != 20471035) && (message.from.username != "Gaius87") && (message.from.username != "lorsalv") && (message.from.username != "Juri_L") && (message.from.username != "CH4R124RD") && (message.from.username != "Raukonar") && (message.from.username != "Shaeryen")) {
		s = 0;
	}

	if (s == 0) {
		var d = new Date();
		if (d.getDay() != 3) {
			bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
			return;
		}
		if ((d.getHours() < 10) || (d.getHours() > 21)) {
			bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
			return;
		}
	}

	connection.query('SELECT account_id, market_ban, holiday, id, reborn, money, exp FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp/10);
		var myMoney = rows[0].money;

		if ((level < 50) && (rows[0].reborn == 1)){
			bot.sendMessage(message.chat.id, "Sblocca la casa dei giochi per accedere a questa funzione!", back);
			return;
		}

		var kbChoice = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Tutti i pari", "Tutti i dispari"], ["Primi 12", "Secondi 12", "Ultimi 12"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbNum = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Gioca Numeri"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, "Seleziona i numeri che vuoi giocare, separati da virgola. Oppure indica i gruppi di numeri attraverso i pulsanti.", kbChoice).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {

				if (answer.text == "Torna alla casa dei giochi") {
					return;
				}

				if (answer.text == "Tutti i pari") {
					answer.text = "2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36";
				} else if (answer.text == "Tutti i dispari") {
					answer.text = "1,3,5,7,9,11,13,15,17,19,21,23,25,27,29,31,33,35";
				} else if (answer.text == "Primi 12") {
					answer.text = "1,2,3,4,5,6,7,8,9,10,11,12";
				} else if (answer.text == "Secondi 12") {
					answer.text = "13,14,15,16,17,18,19,20,21,22,23,24";
				} else if (answer.text == "Ultimi 12") {
					answer.text = "25,26,27,28,29,30,31,32,33,34,35,36";
				}

				var numbers = answer.text.trim().split(",");
				var len = Object.keys(numbers).length;

				if (len < 1) {
					bot.sendMessage(message.chat.id, "Inserisci almeno un numero, riprova", kbNum);
					return;
				}

				if (len > 18) {
					bot.sendMessage(message.chat.id, "Troppi numeri, massimo 18, riprova", kbNum);
					return;
				}

				var check = 0;
				var checkn = 0;

				for (var i = 0; i < len; i++) {
					numbers[i] = Math.round(numbers[i]);

					if (isNaN(numbers[i])) {
						bot.sendMessage(message.chat.id, "Almeno un numero non Ã¨ valido, riprova", kbNum);
						return;
					}
					if ((numbers[i] < 1) || (numbers[i] > 36)) {
						bot.sendMessage(message.chat.id, numbers[i] + " non Ã¨ valido, deve essere compreso tra 1 e 36", kbNum);
						return;
					}
					checkn = 0;
					for (var j = 0; j < len; j++) {
						if (numbers[i] == numbers[j]) {
							checkn++;
						}
						if (checkn >= 2) {
							bot.sendMessage(message.chat.id, numbers[i] + " non Ã¨ valido, Ã¨ giÃ  stato inserito", kbNum);
							return;
						}
					}
				}

				connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					var max = 10000;
					bot.sendMessage(message.chat.id, "La tua puntata in caso di vittoria sarÃ  x*" + Math.round(36 / len) + "*, ora indica l'ammontare per la tua puntata, massimo " + max + " Â§. Possiedi " + formatNumber(rows[0].money) + " Â§", kbBack).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if ((answer.text != "Torna alla casa dei giochi") && (answer.text != "Torna al menu")) {
								var money = parseInt(answer.text);

								if (isNaN(money)) {
									bot.sendMessage(message.chat.id, "Valore non valido, riprova", kbNum);
									return;
								}

								money = Math.round(money);

								if (money > max) {
									bot.sendMessage(message.chat.id, "Il massimo Ã¨ " + max + " Â§", kbNum);
									return;
								}

								if (money < 1) {
									bot.sendMessage(message.chat.id, "Il minimo Ã¨ 1 Â§", kbNum);
									return;
								}

								connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;

									if (rows[0].money < money) {
										bot.sendMessage(message.chat.id, "Non hai cosÃ¬ tante monete", kbNum);
										return;
									}

									var win = Math.floor(money * Math.round(36 / len));

									bot.sendMessage(message.chat.id, "Bene, ecco un riassunto:\nNumeri: " + numbers.join() + "\nImporto: " + formatNumber(money) + " Â§\n\nIn caso di vittoria otterrai: " + formatNumber(win) + " Â§, procedi?", kbYesNo).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.toLowerCase() == "si") {
												connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													if (rows[0].money < money) {
														bot.sendMessage(message.chat.id, "Non hai monete sufficienti", kbNum);
														return;
													}

													var extracted = Math.round(Math.random() * 36);

													bot.sendMessage(message.chat.id, "La sfera viene lanciata sul campo...");
													setTimeout(function () {
														bot.sendMessage(message.chat.id, "Rotola rotola...");
														setTimeout(function () {

															connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;

																if (rows[0].money < money) {
																	bot.sendMessage(message.chat.id, "Non hai cosÃ¬ tante monete", kbNum);
																	return;
																}

																connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	if (numbers.indexOf(extracted) != -1) {
																		bot.sendMessage(message.chat.id, "E si ferma sul numero *" + extracted + "*!\n\nHAI VINTO e ottenuto *" + formatNumber(win) + "* Â§!", kbNum);

																		connection.query('UPDATE player SET money = money+' + win + ' WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});

																		connection.query('UPDATE game_house_stats SET win = win+1, pay = pay+ ' + money + ' WHERE player_id = ' + player_id + ' AND type = 1', function (err, rows, fields) {
																			if (err) throw err;
																		});
																	} else {
																		bot.sendMessage(message.chat.id, "E si ferma sul numero *" + extracted + "*!\n\nHAI PERSO!", kbNum);

																		connection.query('UPDATE game_house_stats SET lose = lose+1, pay = pay+ ' + money + ' WHERE player_id = ' + player_id + ' AND type = 1', function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																});
															});
														}, 2000);
													}, 2000);
												});
											}
										};
									});
								});
							};
						};
					});
				});
			};
		});
	});
});

bot.onText(/gira rotelle/i, function (message) {

	if (!checkSpam(message)) {
		return;
	}

	var d = new Date();
	if (d.getDay() != 3) {
		bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
		return;
	}
	if ((d.getHours() < 10) || (d.getHours() > 21)) {
		bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
		return;
	}

	var kbBack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna alla casa dei giochi"], ["Torna al menu"]]
		}
	};

	var kbRote = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			one_time_keyboard: true,
			"keyboard": [["Gira Rotelle"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT account_id, market_ban, holiday, id, reborn, money, exp FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp/10);
		var myMoney = rows[0].money;

		if ((level < 50) && (rows[0].reborn == 1)){
			bot.sendMessage(message.chat.id, "Sblocca la casa dei giochi per accedere a questa funzione!", back);
			return;
		}

		var price = 1000;

		connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (rows[0].money < price) {
				bot.sendMessage(message.chat.id, "Non hai monete sufficienti", kbBack);
				return;
			}

			var symArray = ["ðŸŒ•", "ðŸŽ²", "ðŸ“š", "ðŸ›¡", "ðŸ¿", "ðŸ»", "ðŸ”©", "ðŸ«", "ðŸŽ¯", "ðŸ’°"];
			var symLen = symArray.length;
			var sym1 = symArray[Math.floor(Math.random() * symLen)];
			var sym2 = symArray[Math.floor(Math.random() * symLen)];
			var sym3 = symArray[Math.floor(Math.random() * symLen)];

			var sym4 = symArray[Math.floor(Math.random() * symLen)];
			var sym5 = symArray[Math.floor(Math.random() * symLen)];
			var sym6 = symArray[Math.floor(Math.random() * symLen)];

			var sym7 = symArray[Math.floor(Math.random() * symLen)];
			var sym8 = symArray[Math.floor(Math.random() * symLen)];
			var sym9 = symArray[Math.floor(Math.random() * symLen)];


			bot.sendMessage(message.chat.id, "Le rotelle cominciano a roteare...");
			setTimeout(function () {
				bot.sendMessage(message.chat.id, "Lentamente rallentano...");
				setTimeout(function () {

					connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						if (rows[0].money < price) {
							bot.sendMessage(message.chat.id, "Non hai monete sufficienti", kbBack);
							return;
						}

						connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							var win = 0;
							var result = "";
							if ((sym1 == sym2) && (sym2 == sym3)) {
								win += 1;
								result += "Orizzontale prima riga con 3 " + sym1 + "\n";
							}
							if ((sym4 == sym5) && (sym5 == sym6)) {
								win += 1;
								result += "Orizzontale seconda riga con 3 " + sym4 + "\n";
							}
							if ((sym7 == sym8) && (sym8 == sym9)) {
								win += 1;
								result += "Orizzontale terza riga con 3 " + sym7 + "\n";
							}

							if ((sym1 == sym5) && (sym5 == sym9)) {
								win += 1;
								result += "Diagonale da sinistra con 3 " + sym1 + "\n";
							}
							if ((sym3 == sym5) && (sym5 == sym7)) {
								win += 1;
								result += "Diagonale da destra con 3 " + sym3 + "\n";
							}

							if ((sym1 == sym4) && (sym4 == sym7)) {
								win += 1;
								result += "Verticale prima colonna con 3 " + sym1 + "\n";
							}
							if ((sym2 == sym5) && (sym5 == sym8)) {
								win += 1;
								result += "Verticale seconda colonna con 3 " + sym2 + "\n";
							}
							if ((sym3 == sym6) && (sym6 == sym9)) {
								win += 1;
								result += "Verticale terza colonna con 3 " + sym3 + "\n";
							}

							if ((sym1 == "ðŸ”©") && (sym2 == "ðŸ”©") && (sym3 == "ðŸ”©")) {
								addItem(player_id, 220);
								bot.sendMessage(message.chat.id, "Con questa particolare combinazione hai ottenuto una *Capsula Prelevazione*! Che fortuna!", back);
							}

							var txt = "";
							if (win > 0) {
								txt = "\n\nHAI VINTO!\nRisultato:\n" + result;

								connection.query('UPDATE game_house_stats SET win = win+1, pay = pay+ ' + price + ' WHERE player_id = ' + player_id + ' AND type = 2', function (err, rows, fields) {
									if (err) throw err;
								});
							} else {
								txt = "\n\nHAI PERSO!";
								connection.query('UPDATE game_house_stats SET lose = lose+1, pay = pay+ ' + price + ' WHERE player_id = ' + player_id + ' AND type = 2', function (err, rows, fields) {
									if (err) throw err;
								});
							}

							bot.sendMessage(message.chat.id, "E si fermano indicando 9 simboli\n\n" + sym1 + " " + sym2 + " " + sym3 + " \n" + sym4 + " " + sym5 + " " + sym6 + " \n" + sym7 + " " + sym8 + " " + sym9 + " " + txt, kbRote);

							if (win > 0) {
								var rand = 0;
								for (var i = 0; i < win; i++) {
									rand = Math.random() * 100;

									if (rand < 90) {
										connection.query('SELECT id, name FROM item WHERE estimate < 100000 AND rarity IN ("C","NC","R","UR","L","E") ORDER BY RAND()', function (err, rows, fields) {
											var name = rows[0].name;
											addItem(player_id, rows[0].id);
											bot.sendMessage(message.chat.id, "Con questa particolare combinazione hai ottenuto: *" + name + "*!", mark);
										});
									} else if (rand < 99) {
										connection.query('SELECT id, name FROM item WHERE rarity = "D" AND name LIKE "Pietra%" ORDER BY RAND()', function (err, rows, fields) {
											var name = rows[0].name;
											addItem(player_id, rows[0].id);
											bot.sendMessage(message.chat.id, "Con questa particolare combinazione hai ottenuto un: *" + name + "*!", mark);
										});
									} else {
										connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function (err, rows, fields) {
											bot.sendMessage(message.chat.id, "Con questa particolare combinazione hai ottenuto una *Gemma*!", mark);
										});
									}
								}
							}
						});
					});
				}, 2000);
			}, 2000);
		});
	});
});

bot.onText(/vedi la carta/i, function (message) {

	if (!checkSpam(message)) {
		return;
	}

	var s = 1;
	if ((message.from.id != 20471035) && (message.from.username != "Gaius87") && (message.from.username != "lorsalv") && (message.from.username != "Juri_L") && (message.from.username != "CH4R124RD") && (message.from.username != "Raukonar") && (message.from.username != "Shaeryen")) {
		s = 0;
	}

	if (s == 0) {
		var d = new Date();
		if (d.getDay() != 3) {
			bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
			return;
		}
		if ((d.getHours() < 10) || (d.getHours() > 21)) {
			bot.sendMessage(message.chat.id, "La Casa dei Giochi Ã¨ aperta solo il mercoledÃ¬, dalle 10:00 alle 22:00", back);
			return;
		}
	}

	connection.query('SELECT account_id, market_ban, holiday, id, reborn, money, exp FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp/10);
		var myMoney = rows[0].money;

		if ((level < 50) && (rows[0].reborn == 1)){
			bot.sendMessage(message.chat.id, "Sblocca la casa dei giochi per accedere a questa funzione!", back);
			return;
		}

		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbChoice2 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["PiÃ¹ bassa â¬‡ï¸", "PiÃ¹ alta â¬†ï¸"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		var kbCard = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Vedi la Carta ðŸ“ƒ"], ["Torna alla casa dei giochi"], ["Torna al menu"]]
			}
		};

		connection.query('SELECT player_id, streak, card FROM house_game_3 WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var price = 500;
			var streak = 0;
			var card = Math.round(Math.random() * 19 + 1);
			var record = 0;

			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO house_game_3 (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
				});
			} else {
				streak = rows[0].streak;
				card = rows[0].card;
			}

			if (myMoney < price) {
				bot.sendMessage(message.chat.id, "Non hai monete sufficienti", kbBack);
				return;
			}

			connection.query('SELECT record FROM game_house_stats WHERE type = 3 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0) {
					record = rows[0].record;
				}

				connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					connection.query('UPDATE house_game_3 SET card = ' + card + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Sequenza di vittorie: *" + streak + "*\nIl Pirata tira fuori la carta stropicciata e legge ad alta voce il numero scritto sopra:\n\n*" + card + "*\n\nSecondo te la carta successiva sarÃ ...", kbChoice2).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {

								var card2 = Math.round(Math.random() * 19 + 1);
								var win = 0;

								if (answer.text.indexOf("PiÃ¹ alta") != -1) {
									if (card2 > card) {
										win = 1;
									} else if (card2 < card) {
										win = 0;
									} else if (card2 == card) {
										win = 1
									}
								} else if (answer.text.indexOf("PiÃ¹ bassa") != -1) {
									if (card2 < card) {
										win = 1;
									} else if (card2 > card) {
										win = 0;
									} else if (card2 == card) {
										win = 1
									}
								} else {
									return;
								}

								if (win == 1) {
									bot.sendMessage(message.chat.id, "Il Pirata prende l'altra carta e la apre piano piano, al suo interno si legge un numero:\n\n*" + card2 + "*\n\nHAI VINTO!", kbCard);
									connection.query('UPDATE house_game_3 SET card = ' + card2 + ', streak = streak+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
									});
								} else {

									var txt = "\nMa hai vinto solo " + streak + " turni di fila, non ti meriti nessun premio.";


									var chest_id = 0;
									var qnt = 0;
									var chest_name = "";

									if ((streak >= 5) && (streak <= 6)) {
										chest_name = "Scrigno di Legno";
										chest_id = 1;
										qnt = 5;
									}
									if ((streak >= 7) && (streak <= 9)) {
										chest_name = "Scrigno di Ferro";
										chest_id = 2;
										qnt = 5;
									}
									if ((streak >= 10) && (streak <= 11)) {
										chest_name = "Scrigno Prezioso";
										chest_id = 3;
										qnt = 5;
									}
									if ((streak >= 12) && (streak <= 14)) {
										chest_name = "Scrigno di Diamante";
										chest_id = 4;
										qnt = 5;
									}
									if ((streak >= 15) && (streak <= 19)) {
										chest_name = "Scrigno Leggendario";
										chest_id = 5;
										qnt = 5;
									}
									if ((streak >= 20) && (streak <= 24)) {
										chest_name = "Scrigno Epico";
										chest_id = 6;
										qnt = 5;
									}
									if ((streak >= 25) && (streak <= 29)) {
										chest_name = "Scrigno Epico";
										chest_id = 6;
										qnt = 15;
									}
									if (streak >= 30) {
										chest_name = "Scrigno Capsula";
										chest_id = 7;
										qnt = 1;
									}

									if (streak > record) {
										connection.query('UPDATE game_house_stats SET record = ' + streak + ' WHERE type = 3 AND player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
									}

									var num = (chest_id + 1);

									if (chest_id > 0) {
										txt = "\nIn base alle " + streak + " vittorie consecutive hai vinto *" + qnt + "x " + chest_name + "*!";

										addChest(player_id, chest_id, qnt);

										connection.query('UPDATE game_house_stats SET win = win+1, pay = pay+ ' + price + ' WHERE player_id = ' + player_id + ' AND type = 3', function (err, rows, fields) {
											if (err) throw err;
										});
									} else {
										connection.query('UPDATE game_house_stats SET lose = lose+1, pay = pay+ ' + price + ' WHERE player_id = ' + player_id + ' AND type = 3', function (err, rows, fields) {
											if (err) throw err;
										});
									}

									bot.sendMessage(message.chat.id, "Sequenza di vittorie: *" + streak + "*\nIl Pirata prende un'altra carta e la apre lentamente, al suo interno si legge un numero:\n\n*" + card2 + "*\n\nHAI PERSO!" + txt, kbCard);
									connection.query('DELETE FROM house_game_3 WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
									});
								}
							};
						});
					});
				});
			});
		});
	});
});

bot.onText(/$vocazioni|vocazione|torna alle vocazioni/i, function (message) {

	if (message.text == "Cambia Vocazione") {
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var player_class = rows[0].class;
		var reborn = rows[0].reborn;
		var changed = rows[0].class_changed;

		if (reborn == 1) {
			bot.sendMessage(message.chat.id, "Non puoi selezionare una vocazione fino alla Rinascita 1 (Livello 100). Potrai scegliere la strada che il tuo eroe desidera intraprendere ottenendo particolari abilitÃ !\nPuoi visualizzare le Vocazioni e le loro descrizione in questo documento: http://telegra.ph/Lista-Vocazioni-di-Loot-01-26", back);
			return;
		}

		connection.query('SELECT name FROM class', function (err, rows, fields) {
			if (err) throw err;

			var iKeys = [];
			var text = "";

			for (var i = 1, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push([rows[i].name]);
			}

			iKeys.push(["Torna al menu"]);

			var sClass = {
				parse_mode: "Markdown",
				disable_web_page_preview: true,
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			var bClass = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Torna alle vocazioni"]]
				}
			};

			var backChange = {
				parse_mode: "Markdown",
				disable_web_page_preview: true,
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Cambia Vocazione"], ["Torna al menu"]]
				}
			};

			var cClass = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Si"], ["Torna alle vocazioni"]]
				}
			};

			if (player_class == 1) {
				bot.sendMessage(message.chat.id, "Le *Vocazioni* sono dei percorsi che puoi scegliere e per migliorare una particolare sezione del tuo personaggio.\nSeleziona la vocazione che preferisci per trarne i benefici associati, ma fai attenzione, eccetto particolari momenti come i bilanciamenti, *non potrai piÃ¹ cambiarla!*\n\nIn questo documento sono descritte nei particolari, scegli saggiamente: http://telegra.ph/Lista-Vocazioni-di-Loot-01-26", sClass).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text != "Torna al menu") {
							connection.query('SELECT id, name FROM class WHERE name = "' + answer.text + '"', function (err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0) {
									bot.sendMessage(message.chat.id, "Vocazione non valida!", bClass);
									return;
								}

								var class_id = rows[0].id;
								var class_name = rows[0].name;
								var description = rows[0].description;

								bot.sendMessage(message.chat.id, "Sicuro di voler scegliere la Vocazione *" + class_name + "*?", cClass).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "si") {
											bot.sendMessage(message.chat.id, "Sicuro?", cClass).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													if (answer.text.toLowerCase() == "si") {
														connection.query('UPDATE player SET class = ' + class_id + ' WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Hai selezionato la vocazione *" + class_name + "*!", back);
														});
													}
												}
											});
										}
									}
								});
							});
						}
					};
				});
			} else {
				connection.query('SELECT name FROM class WHERE id = ' + player_class, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Ulteriori informazioni sulla vocazione *" + rows[0].name + "*: http://telegra.ph/Lista-Vocazioni-di-Loot-01-26", backChange);
				});
			}
		});
	});
});

bot.onText(/cambia vocazione/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var player_class = rows[0].class;
		var reborn = rows[0].reborn;
		var changed = rows[0].class_changed;

		if (reborn == 1) {
			bot.sendMessage(message.chat.id, "Sblocca le vocazioni prima di poterla cambiare", back);
			return;
		}

		var bClass = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alle vocazioni"]]
			}
		};
		var cClass = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna alle vocazioni"]]
			}
		};

		if (changed == 1) {
			bot.sendMessage(message.chat.id, "Hai giÃ  cambiato Vocazione una volta", bClass);
			return;
		}

		if (player_class == 1) {
			bot.sendMessage(message.chat.id, "Puoi cambiare vocazione solo dopo averne scelta una", bClass);
			return;
		}

		var d = new Date("2018-01-28 22:00:00");
		var now = new Date();

		if (now > d){
			bot.sendMessage(message.chat.id, "Non Ã¨ piÃ¹ possibile cambiare la vocazione", bClass);
			return;
		}

		bot.sendMessage(message.chat.id, "Sei sicuro di voler modificare la Vocazione? Puoi farlo solamente una volta dal momento in cui sceglierai 'Si', hai tempo fino al " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + " alle " + addZero(d.getHours()) + ":" + addZero(d.getMinutes()), cClass).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					connection.query('UPDATE player SET class = 1, class_changed = 1 WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Hai resettato la vocazione, ora fai la nuova scelta", bClass);
						console.log("Reset vocazione da " + player_class);
					});
				}
			}
		});
	});
});

bot.onText(/statistiche/i, function (message) {
	connection.query('SELECT id, mission_count, achievement_count, dungeon_count, global_event, kill_streak_ok, gain_exp, mission_team_count FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var missioni = rows[0].mission_count;
		var imprese = rows[0].achievement_count;
		var dungeon_tot = rows[0].dungeon_count;
		var global_event = rows[0].global_event;
		var kill_streak_ok = rows[0].kill_streak_ok;
		var gain_exp = rows[0].gain_exp;
		var mission_team_count = rows[0].mission_team_count;

		connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE to_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var ispezioniSubite = rows[0].cnt;

			connection.query('SELECT kill_streak FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var scalate = 0;
				if (Object.keys(rows).length > 0) {
					scalate = rows[0].kill_streak;
				}

				var scalateOk = "No";
				if (kill_streak_ok == 1) {
					scalateOk = "Si";
				} else {
					if (scalate >= 20) {
						connection.query('UPDATE player SET kill_streak_ok = 1 WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
						scalateOk = "Si";
					}
				}

				connection.query('SELECT total_cnt FROM merchant_offer WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					var contrabbandiere = 0;
					if (Object.keys(rows).length > 0) {
						contrabbandiere = rows[0].total_cnt;
					}

					connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE from_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						var ispezioniEffettuate = rows[0].cnt;
						connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail > 0 AND to_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							var ispezioniSubiteVinte = rows[0].cnt;
							connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail = 0 AND to_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								var ispezioniSubitePerse = rows[0].cnt;
								connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail = 0 AND from_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									var ispezioniEffettuateVinte = rows[0].cnt;
									connection.query('SELECT COUNT(*) As cnt FROM heist_history WHERE fail > 0 AND from_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										var ispezioniEffettuatePerse = rows[0].cnt;
										connection.query('SELECT COUNT(*) As cnt FROM search_history WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											var ricerche = rows[0].cnt;
											connection.query('SELECT SUM(quantity) As cnt FROM market_direct_history WHERE from_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												var vendite = rows[0].cnt;
												connection.query('SELECT SUM(quantity) As cnt FROM market_direct_history WHERE to_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													var acquisti = rows[0].cnt;
													connection.query('SELECT COUNT(*) As cnt FROM market_history WHERE from_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														var scambiOut = rows[0].cnt;
														connection.query('SELECT COUNT(*) As cnt FROM market_history WHERE to_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															var scambiIn = rows[0].cnt;
															connection.query('SELECT COUNT(*) As cnt FROM referral_list WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																var invitati = rows[0].cnt;
																connection.query('SELECT SUM(quantity) As cnt FROM inventory WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	var oggetti = rows[0].cnt;
																	connection.query('SELECT COUNT(*) As cnt FROM public_lottery_history WHERE creator_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		var lotterie = rows[0].cnt;
																		connection.query('SELECT COUNT(*) As cnt FROM public_lottery_history WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			var lotterieVinte = rows[0].cnt;
																			connection.query('SELECT COUNT(*) As cnt FROM ability WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																				var abilita = rows[0].cnt;

																				connection.query("SELECT SUM(ability_level) As cnt FROM ability WHERE player_id = " + player_id, function (err, rows, fields) {
																					if (err) throw err;

																					var talenti = rows[0].cnt

																					var text = "*Statistiche giocatore*\n\n" +
																						"*Missioni completate*: " + missioni + "\n" +
																						"*Imprese giornaliere completate*: " + imprese + "\n" +
																						"*Dungeon completati*: " + dungeon_tot + "\n" +
																						"*Ispezioni subite*: " + ispezioniSubite + "\n" +
																						"*Ispezioni subite vinte*: " + ispezioniSubiteVinte + "\n" +
																						"*Ispezioni subite perse*: " + ispezioniSubitePerse + "\n" +
																						"*Ispezioni effettuate vinte*: " + ispezioniEffettuateVinte + "\n" +
																						"*Ispezioni effettuate perse*: " + ispezioniEffettuatePerse + "\n" +
																						"*Ricerche*: " + ricerche + " (ultimi 30g)\n" +
																						"*Acquisti*: " + acquisti + "\n" +
																						"*Vendite*: " + vendite + "\n" +
																						"*Scambi in uscita*: " + scambiOut + "\n" +
																						"*Scambi in entrata*: " + scambiIn + "\n" +
																						"*Utenti invitati*: " + invitati + "\n" +
																						"*Oggetti posseduti*: " + oggetti + "\n" +
																						"*Lotterie*: " + lotterie + "\n" +
																						"*Lotterie vinte*: " + lotterieVinte + "\n" +
																						"*Talenti sbloccati*: " + abilita + "\n" +
																						"*Scalate personali nel team attuale*: " + scalate + "\n" +
																						"*20 scalate raggiunte*: " + scalateOk + "\n" +
																						"*Imprese globali (partecipando attivamente)*: " + global_event + "\n" +
																						"*Esperienza accumulata*: " + gain_exp + "\n" +
																						"*Offerte contrabbandiere accettate*: " + formatNumber(contrabbandiere) + "\n" +
																						"*Livelli Talenti raggiunti*: " + talenti + "\n" +
																						"*Incarichi completati*: " + mission_team_count + "\n";

																					bot.sendMessage(message.chat.id, text, back);
																				});
																			});
																		});
																	});
																});
															});
														});
													});
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
});

function getRankFileId(rank) {
	var fileid = "";
	if (rank < rankList[0]) {
		fileid = "CAADAgADGgADotsCAQ5SJkme2h2bAg";
	} else if (rank < rankList[1]) {
		fileid = "CAADAgADJAADotsCAT4JAAGfG9ECkAI";
	} else if (rank < rankList[2]) {
		fileid = "CAADAgADJQADotsCAapCRcaM7LsgAg";
	} else if (rank < rankList[3]) {
		fileid = "CAADAgADHQADotsCAdM1n5lYdhnhAg";
	} else if (rank < rankList[4]) {
		fileid = "CAADAgADHgADotsCARhzy43RSldJAg";
	} else if (rank < rankList[5]) {
		fileid = "CAADAgADHwADotsCAdlRncszacM4Ag";
	} else if (rank < rankList[6]) {
		fileid = "CAADAgADIAADotsCAUnlb5EAAUm7iwI";
	} else if (rank < rankList[7]) {
		fileid = "CAADAgADIQADotsCAfwVvhD-OyLdAg";
	} else if (rank < rankList[8]) {
		fileid = "CAADAgADIgADotsCAc_f5ai7tAS6Ag";
	} else {
		fileid = "CAADAgADIwADotsCAbPikwR4V2YHAg";
	}

	return fileid;
}

function getRankName(rank, opt) {

	if (opt == 0) {
		var text = "";

		if (rank <= rankList[0]) {
			text = "Esploratore Novizio";
		} else if (rank <= rankList[1]) {
			text = "Esploratore Modesto";
		} else if (rank <= rankList[2]) {
			text = "Esploratore Professionista";
		} else if (rank <= rankList[3]) {
			text = "Avventuriero Giovane";
		} else if (rank <= rankList[4]) {
			text = "Avventuriero Forestiero";
		} else if (rank <= rankList[5]) {
			text = "Avventuriero della Notte";
		} else if (rank <= rankList[6]) { //500
			text = "Avventuriero Impavido";
		} else if (rank <= rankList[7]) { //750
			text = "Avventuriero Eroico";
		} else if (rank <= rankList[8]) { //750
			text = "Eroe delle Esplorazioni";
		} else {
			text = "Mappatore Avanzato";
		}

		return text;
	} else if (opt == 1) {
		var next = 0;

		for (var i = 0, len = Object.keys(rankList).length; i < len; i++) {
			if (rank < rankList[i]) {
				next = rankList[i];
				break;
			}
		}

		return next;
	}
}

function globalAchievement(player_id, value = 1) {
	connection.query('SELECT global_eventon, global_cap, global_eventwait FROM config', function (err, rows, fields) {
		if (err) throw err;
		if (rows[0].global_eventon == 1) {
			var cap = rows[0].global_cap;
			connection.query('SELECT SUM(value) As cnt FROM achievement_global', function (err, rows, fields) {
				if (err) throw err;
				if (rows[0].cnt >= cap) {
					connection.query('UPDATE config SET global_eventon = 0', function (err, rows, fields) {
						if (err) throw err;
						console.log("Fine impresa!");
					});
				} else {
					connection.query('INSERT INTO achievement_global (player_id, value) VALUES (' + player_id + ', ' + value + ')', function (err, rows, fields) {
						if (err) throw err;
					});

					/*
					connection.query('SELECT 1 FROM achievement_global WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0) {
							connection.query('UPDATE achievement_global SET value = value+' + value + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
							});
						}else{
							connection.query('INSERT INTO achievement_global (player_id, value) VALUES (' + player_id + ', ' + value + ')', function (err, rows, fields) {
								if (err) throw err;
							});
						}
					});
					*/
				}
			});
		} else {
			if (rows[0].global_eventwait == 1) {
				connection.query('INSERT INTO achievement_global (player_id, value) VALUES (' + player_id + ', ' + value + ')', function (err, rows, fields) {
					if (err) throw err;
					console.log("Pre-impresa +" + value);
				});

				/*
				console.log("Pre-impresa +" + value);
				connection.query('SELECT 1 FROM achievement_global WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						connection.query('UPDATE achievement_global SET value = value+' + value + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					}else{
						connection.query('INSERT INTO achievement_global (player_id, value) VALUES (' + player_id + ', ' + value + ')', function (err, rows, fields) {
							if (err) throw err;
						});
					}
				});
				*/
			}
		}
	});
}

bot.onText(/dungeon/i, function (message) {

	if (message.text.indexOf("velocemente") != -1) {
		return;
	}

	var max_rooms_neg = 15;		// Diventa negativo dopo

	var dBack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna al dungeon"], ["Torna al menu"]]
		}
	};

	var dBack_html = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna al dungeon"], ["Torna al menu"]]
		}
	};

	var dYesNo = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Si"], ["Torna al dungeon"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var player_life = rows[0].life;
		var player_total_life = rows[0].total_life;
		var player_ability = rows[0].ability;
		var player_money = rows[0].money;
		var player_rank_b = rows[0].rank;
		var player_rank = rows[0].rank;
		if (player_rank > 500)
			player_rank = 500;
		var player_reborn = rows[0].reborn;
		var player_level = Math.floor(rows[0].exp / 10);
		var player_class_id = rows[0].class;
		var player_dungeon_skip = rows[0].dungeon_skip;
		var dungeon_count = rows[0].dungeon_count;
		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (player_reborn == 1) {
			bot.sendMessage(message.chat.id, "Per accedere ai dungeon devi aver raggiunto almeno la Rinascita 1 (Livello 100), dopo di che potrai esplorare labirinti sempre differenti, combattere creature e risolvere misteriosi enigmi! Ma solo quando avrai abbastanza esperienza per farlo. Forza!", back);
			return;
		}

		if (player_id != 1) {
			if ((player_class_id == 1) && (player_reborn >= 3)) {
				bot.sendMessage(message.chat.id, "Raggiunta questa Rinascita la Vocazione Ã¨ obbligatoria, la puoi scegliere nella sezione Giocatore > Vocazione", back);
				return;
			}
		}

		if (player_life <= 0) {
			bot.sendMessage(message.chat.id, "Non puoi entrare nel dungeon da morto", revive);
			return;
		}
		var dungeon_time = rows[0].dungeon_time;

		var nightText = "";
		var nightMode = 0;
		var now = new Date();
		if (now.getHours() <= 6) {
			nightText = "*, attento, di notte i dungeon nascondono piÃ¹ insidie!*";
			nightMode = 1;
		}

		connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 3', function (err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0) {
				/*
				if (crazyMode == 1){
					abBonus = parseInt(rows[0].ability_level)*(rows[0].val/2);
				}else{
				*/
				abBonus = parseInt(rows[0].ability_level) * rows[0].val;
				//}
			}

			connection.query('SELECT * FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					connection.query('SELECT * FROM dungeon_list ORDER BY min_rank', function (err, rows, fields) {
						if (err) throw err;

						var iKeys = [];

						iKeys.push(["Il tuo Rango"]);
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							var num = rows[i].name.match(/\d+/g);
							if (num == null) {
								if (rows[i].name != "Test") {
									iKeys.push([rows[i].name + " (stanze: " + rows[i].rooms + ", punti min: " + rows[i].min_rank + ")"]);
								}
							}
						}

						iKeys.push(["Resetta il Rango"]);
						iKeys.push(["Torna al menu"]);

						var dSelect = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						var rank = getRankName(player_rank_b, 0);

						bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella *Sala di Ritrovo degli Esploratori*\nQui puoi controllare i dungeon esistenti ed esplorarli.\nIl tuo rango attuale Ã¨ _" + rank + "_\nSeleziona il dungeon da esplorare" + nightText, dSelect).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {

								if (answer.text == "Torna al menu") {
									return;
								}

								if (answer.text == "Il tuo Rango") {
									var next_rank = 0;
									next_rank = parseInt(getRankName(player_rank_b, 1));
									bot.sendMessage(message.chat.id, "Rango Attuale: *" + formatNumber(rank) + "* (" + player_rank_b + ")\nAumento Rango a " + formatNumber(next_rank) + " punti\nHai completato " + formatNumber(dungeon_count) + " dungeon fin ora!", dBack);

									setTimeout(function () {
										bot.sendSticker(message.chat.id, getRankFileId(player_rank_b));
									}, 500);
									return;
								}

								if (answer.text == "Resetta il Rango") {
									if ((player_reborn < 2) || (player_level > 5)){
										bot.sendMessage(message.chat.id, "Per resettare i tuoi punti dungeon, devi aver raggiunto la rinascita 2 ed essere massimo livello 5.", dBack);
										return;
									}
									bot.sendMessage(message.chat.id, "Sei sicuro di voler resettare i tuoi punti dungeon? Potrai farlo al massimo fino al livello 5", dYesNo).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.toLowerCase() == "si") {
												connection.query('UPDATE player SET rank = 0 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai resettato i punti dungeon!", dBack);
												});
											}
										}
									});
									return;
								}

								if (dungeon_time != null) {
									var d = new Date(dungeon_time);
									var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

									var dVarco = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": [["Si"], ["Prosegui il dungeon"], ["Torna al menu"]]
										}
									};

									bot.sendMessage(message.chat.id, "Puoi tornare nei dungeon alle " + short_date + "\nVuoi utilizzare un Varco Temporale per annullare l'attesa?\nNe possiedi " + getItemCnt(player_id, 645), dVarco).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.toLowerCase() == "si") {

												if (crazyMode == 0) {
													if (player_dungeon_skip >= 3) {
														bot.sendMessage(message.chat.id, "Puoi usare un Varco Temporale solamente 3 volte al giorno", back);
														return;
													}
												}

												if (getItemCnt(player_id, 645) == 0) {
													bot.sendMessage(message.chat.id, "Non possiedi un Varco Temporale", back);
													return;
												}
												delItem(player_id, 645, 1);
												connection.query('UPDATE player SET dungeon_time = NULL, dungeon_skip = dungeon_skip+1 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Puoi tornare nel dungeon!", dBack);
													setAchievement(message.chat.id, player_id, 41, 1);
												});
											}
										};
									});
									return;
								}

								if (answer.text != "Torna al menu") {
									var name1 = answer.text.substring(0, answer.text.indexOf("(") - 1);
									name1 = name1.replace(/[0-9]/g, '').trim();

									connection.query('SELECT id FROM dungeon_list WHERE name = "' + name1 + '"', function (err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
											return;
										}

										connection.query('SELECT COUNT(id) As cnt FROM dungeon_list WHERE main = 0 AND name LIKE "' + name1 + '%"', function (err, rows, fields) {
											if (err) throw err;

											var this_istance_number = rows[0].cnt;

											connection.query('SELECT * FROM dungeon_list WHERE name LIKE "' + name1 + '%" AND duration < 5 ORDER BY duration DESC', function (err, rows, fields) {
												if (err) throw err;

												if (Object.keys(rows).length == 0) {
													bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
													return;
												}

												if (player_rank < rows[0].min_rank) {
													bot.sendMessage(message.chat.id, "Sali di rango per iniziare questo dungeon", dBack);
													return;
												}

												var this_rank = rows[0].min_rank;
												var this_room = rows[0].rooms;

												var iKeys = [];
												iKeys.push(["Genera Nuova Istanza"]);

												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													if (i < 120) {
														var num = rows[i].name.match(/\d+/g);
														if (num != null) {
															iKeys.push([rows[i].name + " (" + (5 - rows[i].duration) + " posti liberi)"]);
														}
													}
												}
												iKeys.push(["Torna al dungeon"]);
												iKeys.push(["Torna al menu"]);

												var dSelect2 = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": iKeys
													}
												};

												var d = new Date();
												d.setHours(d.getHours() + (parseInt(this_room) + 5));
												var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

												connection.query('SELECT DISTINCT(min_rank) FROM `dungeon_list` ORDER BY min_rank', function (err, rows, fields) {
													if (err) throw err;

													var last_rank = 0;
													for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
														if (player_rank >= rows[i].min_rank) {
															last_rank = rows[i].min_rank;
														}
													}

													if ((last_rank != this_rank) && (message.from.id != 20471035)) {
														bot.sendMessage(message.chat.id, "Il tuo rango Ã¨ troppo alto per accedere a questo dungeon", dBack);
														return;
													}

													bot.sendMessage(message.chat.id, "Seleziona una variante di dungeon esistente o creane una nuova, in ogni variante la disposizione delle stanze sarÃ  diversa e scompariranno alla scadenza dell'istanza.\n" +
																	"Possono essere ancora create *" + (Math.abs(max_istance - this_istance_number)) + "* istanze.", dSelect2).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if ((answer.text != "Torna al menu") && (answer.text != "Torna al dungeon")) {

																if (answer.text == "Genera Nuova Istanza") {
																	connection.query('SELECT * FROM dungeon_list WHERE name LIKE "' + name1 + '%" ORDER BY LENGTH(name), name', function (err, rows, fields) {
																		if (err) throw err;

																		if (Object.keys(rows).length == 0) {
																			bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
																			return;
																		}

																		var newname = "";
																		var dungeon_rooms = rows[0].rooms;
																		var dungeon_rank = rows[0].min_rank;
																		var istance = 0;
																		var num = rows[Object.keys(rows).length - 1].name.match(/\d+/g);
																		if (num == null) {
																			// Caso in cui esiste solo il dungeon base
																			istance = 1;
																		} else {
																			// Caso in cui Ã¨ presente giÃ  una stanza numerata

																			var numArray = rows.map(function (item) {
																				return item.name.replace(/^\D+/g, '');
																			});

																			istance = findMissing(numArray);
																			if (istance == undefined) {
																				istance = parseInt(rows[Object.keys(rows).length - 1].name.replace(/^\D+/g, '')) + 1;
																				console.log("Istanza undefined (" + name1 + ")");
																			}
																			//console.log(">> NEWISTANCE: " + istance);
																		}

																		newname = name1 + " " + istance;

																		if (istance == -1) {
																			console.log("Istanza -1 (" + name1 + ")");
																			bot.sendMessage(message.chat.id, "Errore creazione istanza, riprova", dBack);
																			return;
																		}

																		if (Object.keys(rows).length > max_istance) {
																			bot.sendMessage(message.chat.id, "Questo dungeon ha raggiunto il limite massimo di istanze, gioca prima a quelle giÃ  create", dBack);
																			return;
																		}

																		var d = new Date();
																		d.setDate(d.getDate() + 7);
																		var long_date2 = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																		connection.query('INSERT INTO dungeon_list (name, rooms, min_rank, finish_date, creator_id) VALUES ("' + newname + '",' + dungeon_rooms + ',' + dungeon_rank + ',"' + long_date2 + '",' + player_id + ')', function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('SELECT * FROM dungeon_list WHERE name = "' + newname + '"', function (err, rows, fields) {
																				var dungeon_id = rows[0].id;
																				var dungeon_name = rows[0].name;

																				var duration = rows[0].duration;
																				if (duration >= max_duration) {
																					bot.sendMessage(message.chat.id, "Questo dungeon Ã¨ giÃ  pieno di esploratori, aspetta che qualcuno esca o genera una nuova istanza.", dBack);
																					return;
																				}

																				connection.query('UPDATE dungeon_list SET duration = duration+1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																					if (err) throw err;

																					connection.query('INSERT INTO dungeon_status (player_id, dungeon_id, room_id, finish_time) VALUES (' + player_id + ',' + dungeon_id + ',1,"' + long_date + '")', function (err, rows, fields) {
																						if (err) throw err;
																						bot.sendMessage(message.chat.id, "Sei stato aggiunto alla Lista Avventurieri del dungeon *" + dungeon_name + "*!", dBack);
																					});
																				});
																			});
																		});
																	});
																} else {
																	var name2 = answer.text.substring(0, answer.text.indexOf("(") - 1);

																	if (name2.match(/\d+/g) == null) {
																		bot.sendMessage(message.chat.id, "Istanza non valida", dBack);
																		return;
																	}

																	connection.query('SELECT * FROM dungeon_list WHERE name = "' + name2 + '"', function (err, rows, fields) {
																		if (err) throw err;

																		if (Object.keys(rows).length == 0) {
																			bot.sendMessage(message.chat.id, "Il dungeon che hai selezionato non esiste", dBack);
																			return;
																		}

																		if (player_rank < rows[0].min_rank) {
																			bot.sendMessage(message.chat.id, "Sali di rango per iniziare questo dungeon", dBack);
																			return;
																		}

																		var dungeon_id = rows[0].id;
																		var dungeon_name = rows[0].name;

																		var duration = rows[0].duration;
																		var creator_id = rows[0].creator_id;
																		var creation = rows[0].creation_date;
																		var finish = rows[0].finish_date;

																		var long_date_creation = toDate("it", creation);
																		var long_date_finish = toDate("it", finish);

																		var confDg = {
																			parse_mode: "HTML",
																			reply_markup: {
																				resize_keyboard: true,
																				//one_time_keyboard: true,
																				"keyboard": [["Si"], ["Torna al dungeon"]]
																			}
																		};

																		connection.query('SELECT nickname, room_id FROM dungeon_status S, dungeon_list L, player P WHERE L.id = ' + dungeon_id + ' AND L.id = S.dungeon_id AND S.player_id = P.id', function (err, rows, fields) {
																			if (err) throw err;

																			var playerlist = "";
																			if (Object.keys(rows).length > 0) {
																				playerlist = "\n";
																				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																					playerlist += "> " + rows[i].nickname + " (stanza " + rows[i].room_id + ")\n";
																				};
																				playerlist += "\n";
																			};

																			connection.query('SELECT nickname FROM player WHERE id = ' + creator_id, function (err, rows, fields) {
																				if (err) throw err;

																				var creator_name = "?";
																				if (Object.keys(rows).length > 0) {
																					creator_name = rows[0].nickname;
																				}

																				bot.sendMessage(message.chat.id, "<i>" + name2 + "</i>\n<b>Data creazione</b>: " + long_date_creation + "\n<b>Creatore dell'istanza</b>: " + creator_name +
																								"\n<b>Data crollo</b>: " + long_date_finish + "\n<b>Esploratori al suo interno</b>: " + duration + "/" + max_duration + "\n" +
																								playerlist + "Continuare?", confDg).then(function () {
																					answerCallbacks[message.chat.id] = function (answer) {
																						if (answer.text.toLowerCase() == "si") {
																							connection.query('SELECT duration FROM dungeon_list WHERE name = "' + name2 + '"', function (err, rows, fields) {
																								if (err) throw err;
																								if ((rows[0].duration >= max_duration) || (duration < 0)) {
																									bot.sendMessage(message.chat.id, "Questo dungeon Ã¨ giÃ  pieno di esploratori, aspetta che qualcuno esca o genera una nuova istanza.", dBack);
																									return;
																								}

																								connection.query('UPDATE dungeon_list SET duration = duration+1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																									if (err) throw err;
																									connection.query('INSERT INTO dungeon_status (player_id, dungeon_id, room_id, finish_time) VALUES (' + player_id + ',' + dungeon_id + ',1,"' + long_date + '")', function (err, rows, fields) {
																										if (err) throw err;
																										bot.sendMessage(message.chat.id, "Sei stato aggiunto alla Lista Avventurieri del dungeon *" + dungeon_name + "*!", dBack);
																										setAchievement(message.chat.id, player_id, 27, 1);
																									});
																								});
																							});
																						};
																					};
																				});
																			});
																		});
																	});
																};
															};
														};
													});
												});
											});
										});
									});
								};
							};
						});
					});
				} else {

					var dng_pass = rows[0].pass;

					if (dungeon_time != null) {
						var d = new Date(dungeon_time);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

						var dVarco = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Si"], ["Prosegui il dungeon"], ["Torna al menu"]]
							}
						};

						bot.sendMessage(message.chat.id, "Puoi tornare nei dungeon alle " + short_date + "\nVuoi utilizzare un Varco Temporale per annullare l'attesa?\nNe possiedi " + getItemCnt(player_id, 645), dVarco).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase() == "si") {

									if (crazyMode == 0) {
										if (player_dungeon_skip >= 3) {
											bot.sendMessage(message.chat.id, "Puoi usare un Varco Temporale solamente 3 volte al giorno", back);
											return;
										}
									}

									if (getItemCnt(player_id, 645) == 0) {
										bot.sendMessage(message.chat.id, "Non possiedi un Varco Temporale", back);
										return;
									}
									delItem(player_id, 645, 1);
									connection.query('UPDATE player SET dungeon_time = NULL, dungeon_skip = dungeon_skip+1 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Puoi tornare nel dungeon!", dBack);
										setAchievement(message.chat.id, player_id, 41, 1);
									});
								}
							};
						});
						return;
					}

					var dNav = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["â˜ ï¸", "â¬†ï¸", "ðŸ”‘"], ["â¬…ï¸", "âš’", "âž¡ï¸"], ["Scappa", "Torna al menu"]]
						}
					};

					var dNext = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Prosegui il dungeon"], ["Torna al menu"]]
						}
					};

					var dNext2 = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Prosegui"], ["Torna al menu"]]
						}
					};

					var dStart = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Entra nel dungeon"], ["Torna al menu"]]
						}
					};

					var dBattle = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Attacca", "Scappa"], ["Torna al menu"]]
						}
					};

					var dChest = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Prendi"], ["Torna al menu"]]
						}
					};

					var dPeople = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Aiuta", "Ignora"], ["Torna al menu"]]
						}
					};

					var dPotions = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Segui la Vecchia", "Ignora"], ["Torna al menu"]]
						}
					};

					var dButtons = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["1", "2", "3"], ["4", "5", "6"], ["Scappa"], ["Torna al menu"]]
						}
					};

					var dKeys = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Tipo 1: Scorciatoia"], ["Tipo 2: Rivelazione"], ["Torna al dungeon"]]
						}
					};

					var dungeon_id = parseInt(rows[0].dungeon_id);
					var room_id = parseInt(rows[0].room_id);
					var monster_id = rows[0].monster_id;
					var last_dir = rows[0].last_dir;
					var room_time = new Date(rows[0].room_time);
					var param = rows[0].param;
					var timecheck = rows[0].timevar;
					var finish_time = new Date(rows[0].finish_time);

					if (rows[0].room_time != null) {
						var now = new Date();
						var min = Math.round(((room_time - now) / 1000) / 60);
						if (min >= 0) {
							if (min > 0) {
								bot.sendMessage(message.chat.id, "Sei impegnato nel dungeon ancora " + min + " minuti", dNext);
							} else {
								bot.sendMessage(message.chat.id, "Sei impegnato nel dungeon ancora per qualche secondo", dNext);
							}
							return;
						} else {
							connection.query('UPDATE dungeon_status SET room_time = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
							});
						}
					}

					connection.query('UPDATE `player` SET magic_to = 2, dragon_to = 2 WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});

					var text = "";

					connection.query('SELECT * FROM dungeon_rooms WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							connection.query('SELECT * FROM dungeon_list WHERE id = ' + dungeon_id, function (err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0) {
									connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Il dungeon corrispondente non esiste piÃ¹, selezionane un altro.", back);
									});
									return;
								}

								bot.sendMessage(message.chat.id, "Il dungeon Ã¨ in costruzione, attendi.");

								var rooms = parseInt(rows[0].rooms);
								var id = rows[0].id;

								//	Mostro: > 10
								//	Scrigno: 1
								//	Monete: 2
								//	Trappola: 3
								//	Viandante: 4
								//	Trasporto: 5
								//	Persone in pericolo: 6
								//	Vecchia strega: 7
								//	Elementale: 8
								//	Divisa in due: 9
								//	Spada o bottino: 10
								//	Fontana di Mana: 0
								//  Fessura nel muro: -1
								//  Ascia Gigante: -2
								//	Gabbia con parola: -3
								//	Predone scambio: -4
								//	Meditazione: -5
								//	Desideri: -6
								//	Drago di Last: -7
								//	Stanza vuota: -8
								//	Marinaio: -9
								//	Porta misteriosa: -10
								//	Pozzo: -11
								//	Anziano saggio: -12
								// 	Mappatore distratto: -13
								//	Specchio magico: -14
								// 	Alchimista: -15

								var arr = [];
								var p1 = Math.round((rooms * 3) / 100 * 60);
								var rand = 0;

								for (var i = 0; i < (rooms * 3); i++) {
									if (i < p1) {
										rand = Math.round(Math.random() * 10 + (rooms + 1)); //per evitare che venga generato 10, cioÃ¨ un errore dove non trova il mostro
										arr.push([rand]);
									} else {
										rand = Math.round(Math.random() * (max_rooms_neg+10) - max_rooms_neg);	//minimo = max_rooms_neg, massimo = 10
										arr.push([rand]);
									}
								}

								arr = shuffle(arr);

								var arr1 = arr.slice(0, rooms);
								var arr2 = arr.slice(rooms, rooms * 2);
								var arr3 = arr.slice(rooms * 2, rooms * 3);

								for (var i = 0; i < rooms; i++) {
									top = arr1[i];
									right = arr2[i];
									left = arr3[i];
									connection.query('INSERT INTO dungeon_rooms (room_id, dungeon_id, player_id, dir_top, dir_right, dir_left) VALUES (' + (i + 1) + ',' + dungeon_id + ',' + player_id + ',' + top + ',' + right + ',' + left + ')', function (err, rows, fields) {
										if (err) throw err;
									});
									if ((top == 4) || (right == 4) || (left == 4)) {
										connection.query('SELECT id, value, estimate FROM item WHERE craftable = 0 AND rarity NOT IN ("UE","A","H","S","D","U","IN","X") ORDER BY RAND() LIMIT 3', function (err, rows, fields) {
											if (err) throw err;

											var item1 = rows[0].id;
											var item2 = rows[1].id;
											var item3 = rows[2].id;

											var est1 = parseInt(rows[0].estimate);
											var est2 = parseInt(rows[1].estimate);
											var est3 = parseInt(rows[2].estimate);

											var price1 = Math.round(Math.random() * (est1 * 0.1) + (est1));
											var price2 = Math.round(Math.random() * (est2 * 0.1) + (est2));
											var price3 = Math.round(Math.random() * (est3 * 0.1) + (est3));

											connection.query('INSERT INTO dungeon_market (room_id, dungeon_id, item_1, item_2, item_3, price_1, price_2, price_3) ' +
															 'VALUES (' + (this.i + 1) + ',' + dungeon_id + ',' + item1 + ',' + item2 + ',' + item3 + ',' + price1 + ',' + price2 + ',' + price3 + ')',
															 function (err, rows, fields) {
												if (err) throw err;
											});
										}.bind({
											i: i
										}));
									}
									if ((top == -4) || (right == -4) || (left == -4)) {
										connection.query('SELECT id FROM item WHERE craftable = 0 AND rarity NOT IN ("UE","A","H","S","D","U","IN","X") ORDER BY RAND() LIMIT 2', function (err, rows, fields) {
											if (err) throw err;

											var item1 = rows[0].id;
											var item2 = rows[1].id;

											connection.query('INSERT INTO dungeon_trade (room_id, dungeon_id, item_1, item_2) ' +
															 'VALUES (' + (this.i + 1) + ',' + dungeon_id + ',' + item1 + ',' + item2 + ')',
															 function (err, rows, fields) {
												if (err) throw err;
											});
										}.bind({
											i: i
										}));
									}
									if ((top == -11) || (right == -11) || (left == -11)) {
										connection.query('SELECT COUNT(id) As cnt FROM dungeon_well WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
											if (err) throw err;

											if (rows[0].cnt == 0) {
												var rand = Math.round(Math.random() * (player_rank * 50)) + (player_rank * 50);
												connection.query('INSERT INTO dungeon_well (dungeon_id, amount) VALUES (' + dungeon_id + ',' + rand + ')', function (err, rows, fields) {
													if (err) throw err;
												});
											};
										});
									}
								}

								console.log("Generazione dungeon con " + rooms + " stanze completata");

								connection.query('UPDATE dungeon_status SET room_id = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Il dungeon Ã¨ stato creato, ora inizia l'esplorazione!", dStart);
								});
							});
						} else {

							connection.query('SELECT rooms, finish_date FROM dungeon_list WHERE id = ' + dungeon_id, function (err, rows, fields) {
								if (err) throw err;

								var room_num = rows[0].rooms;
								var instance_finish_time = rows[0].finish_date;

								connection.query('SELECT * FROM dungeon_rooms WHERE room_id = ' + room_id + ' AND dungeon_id = ' + dungeon_id, function (err, rows, fields) {
									if (err) throw err;

									if (monster_id != 0) {
										bot.sendMessage(message.chat.id, "Stai combattendo contro un mostro!\nNon puoi proseguire senza averlo prima sconfitto.", dBattle).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text == "Scappa") {
													bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text.toLowerCase() == "si") {

																var rand = Math.random() * 100;
																if (rand < 20) {
																	var dmg = Math.round(player_total_life * 20 / 100);
																} else {
																	var dmg = Math.round(player_total_life * 30 / 100);
																}

																var exText = "";

																connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});

																if (player_life - dmg <= 0) {
																	exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	if (player_rank > 0) {
																		connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																} else {
																	exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																	var d = new Date();
																	d.setHours(d.getHours() + (wait_dungeon - 1));
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);

															}
														}
													});
												}
											};
										});
										return;
									}

									var now = new Date();
									var dungeon_tot = Math.round((finish_time - now) / 1000); // In secondi
									var instance_tot = Math.round((instance_finish_time - now) / 1000); // In secondi

									var end_time = Math.min(dungeon_tot, instance_tot);
									text = "Stanza " + room_id + "/" + room_num + " (" + toTime(end_time, 0) + " rimanenti)\n";

									if (room_id == 1) {
										text += "Decidi di addentrarti nel dungeon. Nell'oscuritÃ  intravedi una strada e vari corridoi che si perdono a vista d'occhio. Quale direzione scegli di intraprendere?";
									} else {
										var dText = [
											"L'atmosfera cupa e misteriosa ti inquieta, hai davanti a te 3 strade, dove prosegui?",
											"Una stanza di fronte a te mostra 3 porte in 3 diverse direzioni, dove decidi di proseguire?",
											"Indeciso sulla direzione, rimani a riflettere sperando che sia il miglior percorso, quale strada scegli?",
											"Di fronte a te diverse strade che portano in direzioni diverse, dove ti dirigi?"
										];
										var len = parseInt(Object.keys(dText).length) - 1;
										var index = Math.round(Math.random() * len);

										text += dText[index];
									}

									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "Sei arrivato alla stanza finale! Per uscire devi sconfiggere la Bestia del Dungeon.");

										connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + (parseInt(room_num) + 10) + ' ORDER BY RAND()', function (err, rows, fields) {
											if (err) throw err;
											if (Object.keys(rows).length == 0) {
												bot.sendMessage(message.chat.id, "Errore", back);
												return;
											}
											connection.query('UPDATE dungeon_status SET boss_battle = 1, monster_id = ' + rows[0].id + ', monster_life = ' + (rows[0].life * 3) + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
											});

											setTimeout(function () {
												bot.sendMessage(message.chat.id, "Incontri una Bestia *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo e completare il dungeon, oppure scappare.", dBattle).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Scappa") {
															bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text.toLowerCase() == "si") {

																		var rand = Math.random() * 100;
																		if (rand < 50) {
																			var dmg = Math.round(player_total_life * 20 / 100);
																		} else {
																			var dmg = Math.round(player_total_life * 30 / 100);
																		}

																		var exText = "";

																		connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});

																		if (player_life - dmg <= 0) {
																			exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																			var d = new Date();
																			d.setHours(d.getHours() + wait_dungeon_long);
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			if (player_rank > 0) {
																				connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;
																				});
																			}
																		} else {
																			exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																			var d = new Date();
																			d.setHours(d.getHours() + (wait_dungeon - 1));
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																		connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																	}
																}
															});
														}
													};
												});
											}, 1000);
										});
										return;
									}

									var dir_top = parseInt(rows[0].dir_top);
									var dir_right = parseInt(rows[0].dir_right);
									var dir_left = parseInt(rows[0].dir_left);

									var dir = null;

									if (last_dir != null) {
										text = "Ti trovi nella stanza numero " + room_id + " (" + dungeonToDesc(last_dir) + ").\nCrollo dungeon tra " + toTime(dungeon_tot, 0) + "\nCrollo istanza tra " + toTime(instance_tot, 0);
										dNav = dNext2;
									}

									bot.sendMessage(message.chat.id, text, dNav).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text == "â¬†ï¸") {
												dir = dir_top;
											} else if (answer.text == "â¬…ï¸") {
												dir = dir_left;
											} else if (answer.text == "âž¡ï¸") {
												dir = dir_right;
											} else if (answer.text == "ðŸ”‘") {
												bot.sendMessage(message.chat.id, "Puoi utilizzare le chiavi per sfruttare diverse funzionalitÃ ", dKeys).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Tipo 1: Scorciatoia") {
															bot.sendMessage(message.chat.id, "Puoi prendere una scorciatoia utilizzando una Chiave Tipo 1, procedi?", dYesNo).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text.toLowerCase() == "si") {
																		if (getItemCnt(player_id, 604) == 0) {
																			bot.sendMessage(message.chat.id, "Non hai abbastanza Chiavi Tipo 1", dBack);
																		} else {
																			delItem(player_id, 604, 1);
																			connection.query('UPDATE dungeon_status SET room_id = room_id+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(message.chat.id, "Hai preso una scorciatoia!", dBack);
																			});
																		}
																	}
																}
															});
														} else if (answer.text == "Tipo 2: Rivelazione") {
															bot.sendMessage(message.chat.id, "Puoi rivelare le stanze utilizzando una Chiave Tipo 2, procedi?", dYesNo).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text.toLowerCase() == "si") {
																		if (getItemCnt(player_id, 605) == 0) {
																			bot.sendMessage(message.chat.id, "Non hai abbastanza Chiavi Tipo 2", dBack);
																		} else {
																			delItem(player_id, 605, 1);
																			var text = "Scelta stanza successiva:\n";
																			var i = 0;
																			var d = 0;
																			var t = "";

																			while (i < 3) {
																				if (i == 0) {
																					d = dir_top;
																					t = "Avanti";
																				} else if (i == 1) {
																					d = dir_right;
																					t = "Destra";
																				} else if (i == 2) {
																					d = dir_left;
																					t = "Sinistra";
																				}
																				text += "*" + t + ":* " + dungeonToDesc(d) + "\n";
																				i++;
																			}

																			bot.sendMessage(message.chat.id, text, dBack);
																		}
																	}
																}
															});
														}
													};
												});
												return;
											} else if (answer.text == "Scappa") {
												bot.sendMessage(message.chat.id, "Sicuro di voler uscire dal dungeon? Se possiedi un Kit Fuga lo consumerai e non dovrai attendere prima di rientrare. In ogni caso perderai 1 punto rango.", dYesNo).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text.toLowerCase() == "si") {
															var extra = "";
															if (getItemCnt(player_id, 616) > 0) {
																delItem(player_id, 616, 1);
																extra = " scappando con un Kit Fuga!";
															} else {
																var d = new Date();
																d.setHours(d.getHours() + wait_dungeon_long);
																var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
															if (player_rank > 0) {
																connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
															connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai deciso di rinunciare al dungeon" + extra, back);
															});
														}
													}
												});
												return;
											} else if (answer.text == "â˜ ï¸") {

												if (dng_pass != 0) {
													bot.sendMessage(message.chat.id, "Questo dungeon Ã¨ giÃ  stato passato, non puoi ripassarlo", dBack);
													return;
												}

												connection.query('SELECT name, inventory.quantity As num FROM item, inventory WHERE item.name LIKE "Pass%" AND inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, "Non possiedi nessun pass.", dBack);
														return;
													}

													var iKeys = [];
													for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
														iKeys.push([rows[i].name + " (" + rows[i].num + ")"]);
													}
													iKeys.push(["Torna al dungeon"]);

													var dPass = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": iKeys
														}
													};

													bot.sendMessage(message.chat.id, "Puoi utilizzare un *Pass* per chiedere aiuto ad un tuo compagno di team (di pari rinascita) e farlo entrare nel dungeon al posto tuo: il Pass *Bronzo* ti permette di chiedere aiuto ad un compagno con Rinascita pari alla tua, il Pass *Argento* ad un compagno con 1 rinascita di differenza, mentre il Pass *Oro* con 2 rinascite di differenza", dPass).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {

															if (answer.text != "Torna al dungeon") {
																var passName = answer.text.substring(0, answer.text.indexOf("(") - 1);


																connection.query('SELECT item.name, item.id FROM item, inventory WHERE item.name = "' + passName + '" AND inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
																	if (err) throw err;
																	if (Object.keys(rows).length == 0) {
																		bot.sendMessage(message.chat.id, "Non possiedi il pass selezionato.", dBack);
																		return;
																	} else {

																		var passId = rows[0].id;

																		if ((passId != 608) && (passId != 609) && (passId != 610)) {
																			bot.sendMessage(message.chat.id, "Pass non valido", dBack);
																			return;
																		}

																		connection.query('SELECT team_id FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			if (Object.keys(rows).length == 0) {
																				bot.sendMessage(message.chat.id, "Devi essere in un team per utilizzare questa funzionalitÃ .", dBack);
																				return;
																			} else {
																				var team_id = rows[0].team_id;
																				connection.query('SELECT nickname FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + rows[0].team_id + ' AND player_id != ' + player_id, function (err, rows, fields) {
																					if (err) throw err;
																					if (Object.keys(rows).length == 0) {
																						bot.sendMessage(message.chat.id, "Nessun compagno di team disponibile.", dBack);
																						return;
																					} else {
																						var iKeys2 = [];
																						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																							iKeys2.push([rows[i].nickname]);
																						}
																						iKeys2.push(["Torna al dungeon"]);

																						var dTeam = {
																							parse_mode: "Markdown",
																							reply_markup: {
																								resize_keyboard: true,
																								//one_time_keyboard: true,
																								"keyboard": iKeys2
																							}
																						};

																						bot.sendMessage(message.chat.id, "Seleziona il compagno di team con cui scambiarti, ricorda che questo utente non deve essere in un dungeon.", dTeam).then(function () {
																							answerCallbacks[message.chat.id] = function (answer) {
																								connection.query('SELECT nickname, rank, dungeon_time, player.reborn, player.id, player.chat_id FROM team_player, player WHERE player.nickname = "' + answer.text + '" AND player.id = team_player.player_id AND team_id = ' + team_id + ' AND player_id != ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																									if (Object.keys(rows).length == 0) {
																										bot.sendMessage(message.chat.id, "Utente non valido.", dBack);
																										return;
																									} else {
																										var new_playerid = rows[0].id;
																										var chat_id = rows[0].chat_id;
																										var pass_reborn = rows[0].reborn;
																										var pass_rank = rows[0].rank;

																										if (passId == 608) {
																											if (player_reborn != pass_reborn) {
																												bot.sendMessage(message.chat.id, "Puoi usare questo pass solo verso utenti con rinascita pari alla tua", dBack);
																												return;
																											}
																										} else if (passId == 609) {
																											if (pass_reborn - player_reborn > 1) {
																												bot.sendMessage(message.chat.id, "Puoi usare questo pass solo verso utenti con rinascita piÃ¹ alta di 1 rispetto alla tua, o uguale", dBack);
																												return;
																											}
																										} else if (passId == 610) {
																											if (pass_reborn - player_reborn > 2) {
																												bot.sendMessage(message.chat.id, "Puoi usare questo pass solo verso utenti con rinascita piÃ¹ alta di 2 rispetto alla tua, piÃ¹ alta di 1, o uguale", dBack);
																												return;
																											}
																										}

																										bot.sendMessage(message.chat.id, "Sei sicuro?", dYesNo).then(function () {
																											answerCallbacks[message.chat.id] = function (answer) {
																												if (answer.text.toLowerCase() == "si"){
																													if (rows[0].dungeon_time != null) {
																														bot.sendMessage(message.chat.id, "L'utente Ã¨ in attesa dungeon", dBack);
																														return;
																													}

																													if (getItemCnt(player_id, passId) == 0) {
																														bot.sendMessage(message.chat.id, "Non possiedi il pass selezionato.", dBack);
																														return;
																													}

																													connection.query('SELECT id FROM dungeon_status WHERE player_id = ' + new_playerid, function (err, rows, fields) {
																														if (err) throw err;
																														if (Object.keys(rows).length > 0) {
																															bot.sendMessage(message.chat.id, "L'utente selezionato Ã¨ attualmente in un dungeon", dBack);
																															return;
																														}
																														delItem(player_id, passId, 1);

																														connection.query('UPDATE dungeon_status SET pass = ' + player_id + ', player_id = ' + new_playerid + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																															if (err) throw err;

																															var d = new Date();
																															d.setHours(d.getHours() + wait_dungeon);
																															var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																															connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																																if (err) throw err;
																																bot.sendMessage(message.chat.id, "Hai completato lo scambio con il compagno di team!", back);
																																bot.sendMessage(chat_id, message.from.username + " ha richiesto lo scambio con te nel dungeon!", dBack_html);
																																setAchievement(message.chat.id, player_id, 46, 1);
																															});
																														});
																													});
																												}
																											}
																										});
																									}
																								});
																							};
																						});
																					}
																				});
																			}
																		});
																	}
																});
															}
														};
													});
												});
												return;
											} else if (answer.text == "Prosegui") {
												//Salta sotto
											} else if (last_dir == null) {
												return;
											}

											if (last_dir != null) {
												dir = last_dir;
											}

											var d = new Date();
											var sec = wait_room;

											if (abBonus > 0) {
												sec -= abBonus;
											}
											if ((player_class_id == 3) && (player_reborn == 3)) {
												sec = sec - 120;
											}
											if ((player_class_id == 9) && (player_reborn > 1)) {
												sec = sec - 120;
											}
											if ((player_class_id == 9) && (player_reborn == 5)) {
												sec = sec - 180;
											}
											if ((player_class_id == 3) && (player_reborn >= 4)) {
												sec = sec - 300;
											}
											if (crazyMode == 1) {
												sec = sec - 120;
											}

											if (boost_id == 8) {
												if (boost_mission - 1 == 0) {
													connection.query('UPDATE player SET boost_mission = 0, boost_id = 0 WHERE id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
													});
												} else {
													connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
													});
												}

												sec = Math.ceil(sec/2);
											}

											d.setSeconds(d.getSeconds() + sec);

											var room_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
											var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

											connection.query('UPDATE dungeon_status SET last_dir = ' + dir + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
											});

											if (dir > 10) {
												var monsterLev = dir - 10;

												connection.query('SELECT id, min_rank FROM dungeon_list WHERE id = ' + dungeon_id, function (err, rows, fields) {
													if (err) throw err;

													var min_rank = rows[0].min_rank;

													connection.query('SELECT id, name, min_rank FROM dungeon_list WHERE min_rank > ' + min_rank + ' ORDER BY min_rank ASC LIMIT 1', function (err, rows, fields) {
														if (err) throw err;

														var max_rank = 0;
														if (Object.keys(rows).length == 0) {
															max_rank = 250; //Controllare
														} else {
															max_rank = rows[0].min_rank;
														}

														var startrank = 50;
														var extra = "";
														if (player_rank >= startrank) {
															var perc = ((player_rank - min_rank) * 2);
															var rand = Math.random() * 100;
															if (perc >= rand) {
																var monster_boost = Math.round(Math.random() * 7 + 3);
																monsterLev += monster_boost;
																extra = "L'aria si fa piÃ¹ pesante verso la prossima stanza. ";
															}
														}

														if (nightMode == 1) {
															monsterLev += 5;
														}

														connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields) {
															if (err) throw err;
															if (Object.keys(rows).length == 0) {
																bot.sendMessage(message.chat.id, "Errore selezione mostro: " + monsterLev, back);
																return;
															}
															connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															bot.sendMessage(message.chat.id, extra + "Incontri un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text == "Scappa") {
																		bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function () {
																			answerCallbacks[message.chat.id] = function (answer) {
																				if (answer.text.toLowerCase() == "si") {

																					var rand = Math.random() * 100;
																					if (rand < 50) {
																						var dmg = Math.round(player_total_life * 20 / 100);
																					} else {
																						var dmg = Math.round(player_total_life * 30 / 100);
																					}

																					var exText = "";

																					connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});

																					if (player_life - dmg <= 0) {
																						exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																						var d = new Date();
																						d.setHours(d.getHours() + wait_dungeon_long);
																						var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																						connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						if (player_rank > 0) {
																							connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																						}
																					} else {
																						exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																						var d = new Date();
																						d.setHours(d.getHours() + (wait_dungeon - 1));
																						var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																						connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					}
																					connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																					bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																				}
																			}
																		});
																	}
																};
															});
														});
													});
												});
											} else if (dir == 1) {
												bot.sendMessage(message.chat.id, "Nella stanza sembra esserci uno *scrigno* pronto per essere aperto, cosa fai?", dChest).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Prendi") {
															var rand = Math.round((Math.random() * 99) + 1);
															var rand2 = Math.round((Math.random() * 99) + 1);

															if (rand2 < 50) {
																var chest_id = 0;
																if (rand <= 50) { //60%
																	chest_id = 3;
																} else if ((rand > 50) && (rand <= 70)) {
																	chest_id = 4;
																} else if ((rand > 70) && (rand <= 90)) {
																	chest_id = 5;
																} else if ((rand > 90) && (rand <= 95)) {
																	chest_id = 6;
																} else {
																	chest_id = 0;
																}

																if (chest_id > 0) {
																	connection.query('SELECT name FROM chest WHERE id = ' + chest_id, function (err, rows, fields) {
																		if (err) throw err;
																		var chestName = rows[0].name;
																		addChest(player_id, chest_id);
																		bot.sendMessage(message.chat.id, "Hai trovato uno *" + chestName + "*!", dNext);
																	});
																} else {
																	addItem(player_id, 604);
																	bot.sendMessage(message.chat.id, "Aprendo uno strano scrigno hai trovato una *Chiave Tipo 1*!", dNext);
																}
															} else {
																var monsterLev = Math.round(Math.random() * Math.round(room_num / 2) + Math.round(room_num / 2));

																connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields) {
																	if (err) throw err;
																	if (Object.keys(rows).length == 0) {
																		bot.sendMessage(message.chat.id, "Errore selezione mostro: " + monsterLev, back);
																		return;
																	}
																	connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	bot.sendMessage(message.chat.id, "Hai trovato uno Scrigno! Ma appena lo tocchi esso assume le sembianze di un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function () {
																		answerCallbacks[message.chat.id] = function (answer) {
																			if (answer.text == "Scappa") {
																				bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function () {
																					answerCallbacks[message.chat.id] = function (answer) {
																						if (answer.text.toLowerCase() == "si") {

																							var rand = Math.random() * 100;
																							if (rand < 50) {
																								var dmg = Math.round(player_total_life * 20 / 100);
																							} else {
																								var dmg = Math.round(player_total_life * 30 / 100);
																							}

																							var exText = "";

																							connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							if (player_life - dmg <= 0) {
																								exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																								var d = new Date();
																								d.setHours(d.getHours() + wait_dungeon_long);
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								if (player_rank > 0) {
																									connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																							} else {
																								exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																								var d = new Date();
																								d.setHours(d.getHours() + (wait_dungeon - 1));
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																							connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																							bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																						}
																					}
																				});
																			}
																		};
																	});
																});
																connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																return;
															}
														} else if (answer.text == "Ignora") {
															bot.sendMessage(message.chat.id, "Hai ignorato lo Scrigno", dNext);
														} else {
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
													}
												});
											} else if (dir == 2) {
												bot.sendMessage(message.chat.id, "Al centro della stanza vedi un mucchietto di monete, cosa fai?", dChest).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Prendi") {
															if (player_rank == 0) {
																player_rank = 1;
															}
															var rand = Math.round(Math.random() * (player_rank * 100)) + (player_rank * 100);
															connection.query('UPDATE player SET money = money+' + rand + ' WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai ricevuto *" + formatNumber(rand) + "* Â§!", dNext);
															});
														} else {
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
													}
												});
											} else if (dir == 3) {
												var dmg = Math.round(Math.random() * (player_life / 10 * 2) + 1);
												connection.query('UPDATE player SET life = life - ' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													var dText = [
														"Camminando per raggiungere la prossima stanza, una trappola per orsi ti ha ferito la gamba, hai perso " + formatNumber(dmg) + " hp!",
														"Percorrendo un corridoio scivoli su una pozzanghera giallognola e tiri una testata contro un muro in pietra, perdi " + formatNumber(dmg) + " hp!",
														"Uno strano pulsante rosso come un pomodoro ti incuriosisce, lo premi e ti cade addosso un pietrone, facendoti perdere " + formatNumber(dmg) + " hp!",
														"Vedi un Nano della terra di Grumpi e ti chiedi come faccia a trovarsi in un luogo del genere, girandosi si rivela essere un goblin che ti colpisce togliendoti " + formatNumber(dmg) + " hp!"
													];
													var len = parseInt(Object.keys(dText).length) - 1;
													var index = Math.round(Math.random() * len);

													text = dText[index];

													bot.sendMessage(message.chat.id, text, dNext);
												});
												connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
												connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											} else if (dir == 4) {
												var iKeys = [];
												var items = [];
												var prices = [];

												var text = "Nella stanza incontri un viandante, ti propone alcuni oggetti a buon prezzo, puoi acquistarne uno oppure ignorarlo e procedere.\n";

												connection.query('SELECT I.id As item1id, DM.price_1 As price1, DM.price_2 As price2, DM.price_3 As price3, I.value As item1val, I.name As item1n, I2.id As item2id, I2.value As item2val, I2.name As item2n, I3.id As item3id, I3.value As item3val, I3.name As item3n ' +
																 'FROM dungeon_market DM INNER JOIN item I ON DM.item_1 = I.id INNER JOIN item I2 ON DM.item_2 = I2.id INNER JOIN item I3 ON DM.item_3 = I3.id ' +
																 'WHERE DM.dungeon_id = ' + dungeon_id + ' AND DM.room_id = ' + room_id,
																 function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0) {
														connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Il viandante al momento non Ã¨ disponibile, la stanza viene saltata", dNext);
														});
														return;
													}

													var multi = 15;
													text += "\n> " + rows[0].item1n + " (" + formatNumber(rows[0].price1) + " Â§)";
													text += "\n> " + rows[0].item2n + " (" + formatNumber(rows[0].price2) + " Â§)";
													text += "\n> " + rows[0].item3n + " (" + formatNumber(rows[0].price3) + " Â§)";

													iKeys.push(["Accetta Oggetto 1"]);
													iKeys.push(["Accetta Oggetto 2"]);
													iKeys.push(["Accetta Oggetto 3"]);
													items.push(rows[0].item1id);
													items.push(rows[0].item2id);
													items.push(rows[0].item3id);
													prices.push(rows[0].price1);
													prices.push(rows[0].price2);
													prices.push(rows[0].price3);

													iKeys.push(["Ignora"]);
													iKeys.push(["Torna al menu"]);

													var dItems = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": iKeys
														}
													};

													bot.sendMessage(message.chat.id, text, dItems).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															var ogg = answer.text;
															if (ogg == "Ignora") {
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Decidi di ignorare il viandante e prosegui", dNext);
																	});
																});
																return;
															} else if (ogg == "Torna al menu") {
																return;
															} else {
																var itemN = parseInt(ogg.substring(Object.keys(ogg).length - 1));

																if ((itemN > 3) || (itemN < 1)) {
																	bot.sendMessage(message.chat.id, "Il viandante non possiede questo oggetto", back);
																	return;
																}

																var item_id = items[itemN - 1];
																var item_price = prices[itemN - 1];

																if (item_id == undefined) {
																	bot.sendMessage(message.chat.id, "Il viandante non possiede questo oggetto", back);
																	return;
																}
																if (item_price == undefined) {
																	bot.sendMessage(message.chat.id, "Il viandante non possiede questo oggetto", back);
																	return;
																}

																connection.query('SELECT id, name, value FROM item WHERE id = ' + item_id, function (err, rows, fields) {
																	if (err) throw err;

																	if (player_money - item_price < 0) {
																		bot.sendMessage(message.chat.id, "Non hai abbastanza monete", back);
																		return;
																	}

																	//console.log("PRICE: " + item_price);

																	bot.sendMessage(message.chat.id, "Acquistare " + rows[0].name + " per " + item_price + " Â§?", dYesNo).then(function () {
																		answerCallbacks[message.chat.id] = function (answer) {
																			if (answer.text.toLowerCase() == "si") {
																				addItem(player_id, item_id);
																				connection.query('UPDATE player SET money = money-' + item_price + ' WHERE id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;

																					connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});

																					connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});

																					bot.sendMessage(message.chat.id, "Acquisto completato!", dNext);
																				});
																			}
																		}
																	});
																});
															}
														}
													});
												});
											} else if (dir == 5) {
												var rand = Math.round(Math.random() * 100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Sinistra", "Centro", "Destra"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Al centro della stanza ci sono 3 leve, quale spingi?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if ((answer.text == "Sinistra") || (answer.text == "Centro") || (answer.text == "Destra")) {
															if (rand <= 50) {
																if (room_id > 2) {
																	room_id--;
																	bot.sendMessage(message.chat.id, "Spingendo una leva si Ã¨ aperto un varco sotto di te! Torni alla stanza precedente.", dNext);
																} else {
																	bot.sendMessage(message.chat.id, "Spingendo una leva senti degli strani rumori, ma non succede nulla!", dNext);
																}
															} else if ((rand > 50) && (rand <= 90)) {
																room_id++;
																bot.sendMessage(message.chat.id, "Spingendo una leva senti degli strani rumori, e si apre la porta della stanza!", dNext);
															} else if (rand > 90) {
																room_id += 2;
																bot.sendMessage(message.chat.id, "Spingendo una leva si apre un varco sul fianco della stanza, Ã¨ una scorciatoia che ti permette di avanzare di due stanze!", dNext);
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = ' + room_id + ', last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else {
															return;
														}
													}
												});
											} else if (dir == 6) {
												var dText = [
													"una ragazza che sembra essere in difficoltÃ ",
													"un bambino che piange",
													"un uomo ferito e sanguinante",
													"una donna impaurita",
													"un anziano dolorante"
												];
												var len = parseInt(Object.keys(dText).length) - 1;
												var index = Math.round(Math.random() * len);

												text = dText[index];

												bot.sendMessage(message.chat.id, "Appena entrato nella stanza vedi nell'angolo " + text + ", cosa fai?", dPeople).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Aiuta") {
															var rand = Math.random() * 100;
															if (rand < 50) {
																var monsterLev = Math.round(Math.random() * Math.round(room_num / 2) + Math.round(room_num / 2));

																connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields) {
																	if (err) throw err;
																	if (Object.keys(rows).length == 0) {
																		bot.sendMessage(message.chat.id, "Errore selezione mostro", back);
																		return;
																	}
																	connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});

																	bot.sendMessage(message.chat.id, "Decidi di toccare la persona davanti a te, ma questa si gira e sembra essere un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function () {
																		answerCallbacks[message.chat.id] = function (answer) {
																			if (answer.text == "Scappa") {
																				bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function () {
																					answerCallbacks[message.chat.id] = function (answer) {
																						if (answer.text.toLowerCase() == "si") {

																							var rand = Math.random() * 100;
																							if (rand < 50) {
																								var dmg = Math.round(player_total_life * 20 / 100);
																							} else {
																								var dmg = Math.round(player_total_life * 30 / 100);
																							}

																							var exText = "";

																							connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							if (player_life - dmg <= 0) {
																								exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																								var d = new Date();
																								d.setHours(d.getHours() + wait_dungeon_long);
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								if (player_rank > 0) {
																									connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																							} else {
																								exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																								var d = new Date();
																								d.setHours(d.getHours() + (wait_dungeon - 1));
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																							connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																							bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																						}
																					}
																				});
																			};
																		};
																	});
																});
																connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																return; // Non cancellare
															} else {
																if (rand > 85) {
																	addItem(player_id, 608);
																	bot.sendMessage(message.chat.id, "Decidi di toccare la persona davanti a te, si gira e ti ringrazia per averla trovata, regalandoti un *Pass Bronzo*!", dNext);
																} else {
																	connection.query('SELECT id, name FROM item WHERE rarity = "R" AND craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
																		var itemName = rows[0].name;
																		addItem(player_id, rows[0].id);
																		bot.sendMessage(message.chat.id, "Decidi di toccare la persona davanti a te, si gira e ti ringrazia per averla trovata, regalandoti: *" + itemName + "*!", dNext);
																	});
																}
															}
														} else if (answer.text == "Ignora") {
															bot.sendMessage(message.chat.id, "Hai ignorato la persona", dNext);
														} else {
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});

														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
													};
												});
											} else if (dir == 7) {
												var dText = [
													"Un'anziana signora in lontananza ti chiama",
													"Una vecchina poco affidabile in lontananza attira la tua attenzione"
												];
												var len = parseInt(Object.keys(dText).length) - 1;
												var index = Math.round(Math.random() * len);

												text = dText[index];

												bot.sendMessage(message.chat.id, "Aprendo la porta ti ritrovi in un ambiente aperto, con alberi e liane che ricoprono ogni cosa. " + text + ", cosa fai?", dPotions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Segui la Vecchia") {
															var rand = Math.random() * 100;

															if (rand < 60) {
																var potId = 94;
																var potN = "Pozione Grande";

																addItem(player_id, potId);
																bot.sendMessage(message.chat.id, "La vecchina ha preparato una Pozione, e decide di regalartene un po' per aver avuto fiducia in lei. Ottieni cosÃ¬ *" + potN + "*", dNext);
															} else {
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '", last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "La vecchina ha preparato una Pozione, e decidi di provarla, ma appena bevuta ti addormenti, al tuo risveglio sei nuovamente davanti alle 3 porte che ti avevano condotto in questa foresta.", dNext);
																});
																return; //NON CANCELLARE
															}
														} else if (answer.text == "Ignora") {
															bot.sendMessage(message.chat.id, "Hai ignorato la Vecchia", dNext);
														} else {
															return;
														}
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
													};
												});
											} else if (dir == 8) {
												var type = 0;
												var d = new Date();
												var rand = Math.round(d.getHours() / 4) % 2;

												if ((param == null) || (param == undefined)) {
													var randNum = Math.round(Math.random() * 5 + 1) + ",0";
													connection.query('UPDATE dungeon_status SET param = "' + randNum + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
													});
													param = randNum;
												}

												bot.sendMessage(message.chat.id, "Appena aperta la porta della stanza, un freddo polare ti avvolge, appare una pulsantiera congelata, probabilmente uno di quei bottoni potrebbe aprire la porta successiva.\n\nSalute: " + formatNumber(player_life) + " hp", dButtons).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {

														if (answer.text == "Torna al menu") {
															return;
														}

														if (answer.text == "Scappa") {
															bot.sendMessage(message.chat.id, "Sicuro di voler uscire dal dungeon? Se possiedi un Kit Fuga lo consumerai e non dovrai attendere prima di rientrare. In ogni caso perderai 1 punto rango.", dYesNo).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text.toLowerCase() == "si") {

																		var extra = "";
																		if (getItemCnt(player_id, 616) > 0) {
																			delItem(player_id, 616, 1);
																			extra = " scappando con un Kit Fuga!";
																		} else {
																			var d = new Date();
																			d.setHours(d.getHours() + wait_dungeon_long);
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																		if (player_rank > 0) {
																			connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																		connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai deciso di rinunciare al dungeon" + extra, back);
																		});
																	}
																}
															});
															return;
														}

														if ((parseInt(answer.text) < 1) || (parseInt(answer.text > 6))) {
															bot.sendMessage(message.chat.id, "Pulsante non valido, riprova", dBack);
															return;
														} else if ((parseInt(answer.text) >= 1) || (parseInt(answer.text <= 6))) {

															var rand = Math.random() * 200;

															if (parseInt(answer.text) != parseInt(param.split(",")[0])) {

																var damage = Math.round(Math.random() * (player_total_life / 15) + (player_total_life / 15));
																damage = Math.round(damage / 2);

																connection.query('UPDATE player SET life = life - ' + damage + ' WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	var randKey = Math.random() * 100;
																	if (randKey < 3) {
																		addItem(player_id, 605);
																		bot.sendMessage(message.chat.id, "Si apre una piastrella del muro dal quale cade una *Chiave Tipo 2*!", dNext);
																	}

																	//console.log(param);

																	if (param.split(",")[1] >= 5){
																		bot.sendMessage(message.chat.id, "Hai effettuato tutti i tentativi possibili! Uno strano suono rimbomba nelle pareti e si apre la porta per la prossima stanza!", dNext);
																		connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_status SET param = NULL, room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		return;
																	}

																	bot.sendMessage(message.chat.id, "Hai sbagliato pulsante! Il gelo ti provoca una perdita pari a " + formatNumber(damage) + " hp!", dNext);

																	if ((answer.text == (param.split(",")[0] / 2)) && (rand < 1) && (player_reborn >= 3)) {
																		addItem(player_id, 598);
																		bot.sendMessage(message.chat.id, "Si apre una crepa nella parete, da cui esce un soffio di vento ottieni cosÃ¬ un *Soffio di Morte*!", mark);
																	}

																	if (player_life - damage <= 0) {
																		bot.sendMessage(message.chat.id, "Sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.", back);

																		var d = new Date();
																		d.setHours(d.getHours() + wait_dungeon_long);
																		var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																		connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		if (player_rank > 0) {
																			connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																	}

																	randNum = param.split(",")[0] + "," + (parseInt(param.split(",")[1])+1);

																	connection.query('UPDATE dungeon_status SET param = "' + randNum + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																});
															} else {
																if (rand < 10) {
																	addItem(player_id, 609);
																	bot.sendMessage(message.chat.id, "Hai trovato il pulsante corretto! Sul soffitto si apre una botola dalla quale vedi scendere un foglietto, ottieni cosÃ¬ un *Pass Argento*!\nProsegui alla prossima stanza.", dNext);
																} else {
																	bot.sendMessage(message.chat.id, "Hai trovato il pulsante corretto! Prosegui alla prossima stanza.", dNext);
																}
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET param = NULL, room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															};
														};
													};
												});
											} else if (dir == 9) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["PiÃ¹ Raro", "Meno Raro"], ["Ignora"], ["Torna al menu"]]
													}
												};

												var rand = Math.random() * 100;

												bot.sendMessage(message.chat.id, "Raggiungi una stanza suddivisa in due, vedi un oggetto per lato, dove ti dirigi?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if ((answer.text == "PiÃ¹ Raro") || (answer.text == "Meno Raro")) {

															var monsterLev = room_num;
															var rarity = "";

															if (answer.text == "PiÃ¹ Raro") {
																if (rand > 30) {
																	rarity = "UR";
																} else {
																	rarity = "L";
																}
															} else if (answer.text == "Meno Raro") {
																if (rand > 50) {
																	rarity = "R";
																} else {
																	rarity = "NC";
																}
																monsterLev -= 5;
															}

															connection.query('SELECT name, id FROM item WHERE rarity = "' + rarity + '" AND craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
																if (err) throw err;
																var itemName = rows[0].name;
																var itemId = rows[0].id;

																connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields) {
																	if (err) throw err;
																	if (Object.keys(rows).length == 0) {
																		bot.sendMessage(message.chat.id, "Errore selezione mostro", back);
																		return;
																	}
																	connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	var mName = rows[0].name;
																	var mLevel = rows[0].level;

																	addItem(player_id, itemId);

																	var text = "Ti avvicini all'oggetto con calma, scopri che si tratta di *" + itemName + "*, ma appena lo prendi, appare di fronte a te un";
																	bot.sendMessage(message.chat.id, text + " *" + mName + "* di livello *" + mLevel + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function () {
																		answerCallbacks[message.chat.id] = function (answer) {
																			if (answer.text == "Scappa") {
																				bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function () {
																					answerCallbacks[message.chat.id] = function (answer) {
																						if (answer.text.toLowerCase() == "si") {

																							var rand = Math.random() * 100;
																							if (rand < 50) {
																								var dmg = Math.round(player_total_life * 20 / 100);
																							} else {
																								var dmg = Math.round(player_total_life * 30 / 100);
																							}

																							var exText = "";

																							connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							if (player_life - dmg <= 0) {
																								exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																								var d = new Date();
																								d.setHours(d.getHours() + wait_dungeon_long);
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								if (player_rank > 0) {
																									connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																							} else {
																								exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																								var d = new Date();
																								d.setHours(d.getHours() + (wait_dungeon - 1));
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																								connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																							connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																							bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																						}
																					}
																				});
																			}
																		};
																	});
																});
															});
															connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															return;
														} else if (answer.text == "Ignora") {
															bot.sendMessage(message.chat.id, "Hai ignorato gli oggetti", dNext);
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else {
															return;
														}
													}
												});
											} else if (dir == 10) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Accumula Monete", "Estrai Spada"], ["Torna al menu"]]
													}
												};

												if ((param == null) || (param == undefined)) {
													param = "0;0";
													connection.query('UPDATE dungeon_status SET param = "' + param + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
													});
												}

												var param_arr = param.split(";");
												var acc_money = param_arr[0];
												var acc_life = param_arr[1];

												bot.sendMessage(message.chat.id, "Entri in una stanza piena d'oro luccicante e una spada conficcata nel muro, puoi decidere di raccogliere monete ma un messaggio su un cartello raccomanda di non essere troppo avido, cosa fai?\nFin ora hai accumulato " + formatNumber(acc_money) + " Â§ per il " + acc_life + "% della salute.", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if ((answer.text == "Accumula Monete") || (answer.text == "Estrai Spada")) {

															var damage = Math.round(player_total_life / 100 * acc_life);

															if (answer.text == "Accumula Monete") {
																if (player_rank == 0) {
																	player_rank = 1;
																}

																var middle = Math.pow(player_rank, 0.55) * 1000
																var min = middle * 0.66;
																var max = middle * 1.33;
																var rand = Math.round(Math.random() * (max - min + 1) + min);

																acc_money = parseInt(acc_money) + rand;

																if (acc_life == 90) {
																	bot.sendMessage(message.chat.id, "Non ci sono piÃ¹ monete nella stanza!", dNext);
																	return;
																}

																if (player_life - damage <= 0) {
																	bot.sendMessage(message.chat.id, "Sei troppo stanco per riuscire a portare altre monete!", dNext);
																	return;
																}

																var randKey = Math.random() * 100;
																if (randKey < 1) {
																	addItem(player_id, 616);
																	bot.sendMessage(message.chat.id, "In mezzo ai mucchi trovi un *Kit Fuga*!", dNext);
																}

																acc_life = parseInt(acc_life) + 10;
																param = acc_money + ";" + acc_life;

																connection.query('UPDATE dungeon_status SET param = "' + param + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});

																bot.sendMessage(message.chat.id, "Hai deciso di accumulare altre monete, raggiungi cosÃ¬ un bottino di " + formatNumber(acc_money) + " Â§", dNext);
															} else if (answer.text == "Estrai Spada") {

																if (player_life - damage <= 0) {
																	connection.query('UPDATE player SET life = life - ' + damage + ' WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;

																		var d = new Date();
																		d.setHours(d.getHours() + wait_dungeon_long);
																		var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																		connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																			if (err) throw err;
																		});

																		bot.sendMessage(message.chat.id, "La porta si apre, ma un dolore lancinante al petto ti fa perdere i sensi, vieni cosÃ¬ portato fuori dal dungeon in orribili condizioni.", back);
																	});
																	return;
																}

																connection.query('UPDATE player SET money = money + ' + acc_money + ', life = life - ' + damage + ' WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	if (acc_money == 0) {
																		bot.sendMessage(message.chat.id, "La spada provoca un piccolo terremoto e si apre la porta! Immediatamente perÃ² senti una voce spiritica risuonare nell'aria.\nSi apre la porta e prosegui senza nessuna moneta!", dNext);
																	} else {
																		bot.sendMessage(message.chat.id, "La spada provoca un piccolo terremoto e si apre la porta! Immediatamente perÃ² senti una voce spiritica risuonare nell'aria e un dolore lancinante al petto.\nSi apre la porta e ottieni *" + formatNumber(acc_money) + "* Â§, ma perdi *" + formatNumber(damage) + "* hp.\nTi rimangono " + formatNumber(player_life-damage) + " hp", dNext);
																	}
																});

																connection.query('UPDATE dungeon_status SET param = NULL, room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
														} else {
															return;
														}
													};
												});
											} else if (dir == 0) {
												var rand = Math.round(Math.random() * 100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Esamina"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Appena entrato nella stanza noti subito una strana fontana situata nel centro, cosa fai?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Esamina") {
															connection.query('SELECT COUNT(*) As cnt FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;

																var color = "";
																var type = 0;
																if (rows[0].cnt > 0) {
																	if (rand <= 20) {
																		color = "Rosso";
																		type = 3;
																	} else if ((rand > 20) && (rand <= 40)) {
																		color = "Blu";
																		type = 1;
																	} else if ((rand > 40) && (rand <= 60)) {
																		color = "Giallo";
																		type = 2;
																	}
																}
																if (color != "") {
																	connection.query('UPDATE event_mana_status SET mana_' + type + ' = mana_' + type + '+100 WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Ti avvicini alla fontana e vedi che l'acqua ha uno strano colore, la esamini meglio ed ottieni 100 Mana " + color + "!", dNext);
																	});
																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																} else {
																	var monsterLev = Math.round(Math.random() * Math.round(room_num / 2) + Math.round(room_num / 2));

																	connection.query('SELECT * FROM dungeon_monsters WHERE level = ' + monsterLev + ' ORDER BY RAND()', function (err, rows, fields) {
																		if (err) throw err;
																		if (Object.keys(rows).length == 0) {
																			bot.sendMessage(message.chat.id, "Errore selezione mostro: " + monsterLev, back);
																			return;
																		}
																		connection.query('UPDATE dungeon_status SET monster_id = ' + rows[0].id + ', monster_life = ' + rows[0].life + ', monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		bot.sendMessage(message.chat.id, "Ti avvicini alla fontana per esaminarla meglio, appena provi a toccare l'acqua dal suo interno esce un *" + rows[0].name + "* di livello *" + rows[0].level + "*, puoi sfidarlo per ottenere il suo bottino e proseguire, oppure scappare.", dBattle).then(function () {
																			answerCallbacks[message.chat.id] = function (answer) {
																				if (answer.text == "Scappa") {
																					bot.sendMessage(message.chat.id, "Sicuro di voler tentare di tornare alla stanza precedente? Il mostro potrebbe colpirti durante la fuga", dYesNo).then(function () {
																						answerCallbacks[message.chat.id] = function (answer) {
																							if (answer.text.toLowerCase() == "si") {

																								var rand = Math.random() * 100;
																								if (rand < 50) {
																									var dmg = Math.round(player_total_life * 20 / 100);
																								} else {
																									var dmg = Math.round(player_total_life * 30 / 100);
																								}

																								var exText = "";

																								connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});

																								if (player_life - dmg <= 0) {
																									exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																									var d = new Date();
																									d.setHours(d.getHours() + wait_dungeon_long);
																									var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																									connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									if (player_rank > 0) {
																										connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																											if (err) throw err;
																										});
																									}
																								} else {
																									exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																									var d = new Date();
																									d.setHours(d.getHours() + (wait_dungeon - 1));
																									var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																									connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																								connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																							}
																						}
																					});
																				}
																			};
																		});
																	});
																}
															});
															/*
														}else if (answer.text == "Ignora"){
															bot.sendMessage(message.chat.id, "Hai ignorato la fontana", dNext);
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function(err, rows, fields) {
																if (err) throw err;
															});
														*/
														} else {
															return;
														}
													}
												});
											} else if (dir == -1) {
												var rand = Math.round(Math.random() * 100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Inserisci Monete"], ["Sfonda il Muro"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Questa stanza Ã¨ vuota, c'Ã¨ solo una piccola fessura sul muro di fronte, ha la forma di una monetina. E scorgi una sagoma di un portone subito a fianco. Cosa fai?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Inserisci Monete") {
															connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																var money = Math.round(rows[0].money * 0.05);
																if (money > 5000) {
																	money = 5000;
																}
																if (money <= 0) {
																	bot.sendMessage(message.chat.id, "Non hai monete, non puoi procedere, torna quando avrai qualche moneta da parte", dNext);
																	return;
																}
																connection.query('UPDATE player SET money = money - ' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Scegli di inserire nella fessura " + money + " Â§, il portone ti ringrazia con una voce inquietante, e si apre lentamente, cosÃ¬ da aprire la strada per la stanza seguente.", dNext);
																});
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															});
														} else if (answer.text == "Sfonda il Muro") {
															connection.query('SELECT life, total_life FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																var life = Math.round(rows[0].total_life * 0.2);
																if (rows[0].life - life <= 0) {

																	connection.query('UPDATE player SET life = life - ' + life + ' WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Tirando spallate troppo forti hai perso i sensi e quindi portato fuori dal dungeon", back);
																	});

																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																} else {
																	connection.query('UPDATE player SET life = life - ' + life + ' WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Scegli di tirare giÃ¹ il portone a spallate, perdi cosÃ¬ " + life + " hp, ma riesci ad aprire la strada per la stanza seguente.", dNext);
																	});
																}
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															});
														} else {
															return;
														}
													}
												});
											} else if (dir == -2) {
												var rand = Math.round(Math.random() * 100);

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Procedi"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Un cartello con un punto esclamativo ti preoccupa, al centro della stanza c'Ã¨ un taglio che la percorre per tutta la sua larghezza, l'unica alternativa Ã¨ procedere.", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Procedi") {
															connection.query('SELECT life FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																var life = Math.round(rows[0].life / 2);
																var rand = Math.random() * 100;

																connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	var combat = 0;
																	if (Object.keys(rows).length > 0) {
																		combat = rows[0].combat;
																	}

																	connection.query('SELECT level, life, sleep_h FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;

																		var prob = 0;
																		var lev = 0;
																		if ((Object.keys(rows).length > 0) && (combat == 0)) {
																			lev = rows[0].level;
																			if ((rows[0].life > 0) || ((rows[0].life == 0) && (rows[0].sleep_h > 0))) {
																				if (lev == 200) {
																					prob = 100;
																				} else if (lev >= 150) {
																					prob = 75;
																				} else if (lev >= 100) {
																					prob = 50;
																				} else if (lev >= 50) {
																					prob = 25;
																				} else {
																					prob = lev;
																				}
																			}
																		}

																		if (prob >= rand) {
																			addItem(player_id, 72);
																			bot.sendMessage(message.chat.id, "Come avanzi di due passi scatta un meccanismo e un'ascia gigantesca ti precipita addosso, fortunatamente il tuo drago riesce a difenderti bloccandola completamente e vicino alla porta trovi un sacchettino contenente una Pietra Cuore Leggendario!", dNext);
																		} else {
																			connection.query('UPDATE player SET life = life - ' + life + ' WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(message.chat.id, "Come avanzi di due passi scatta un meccanismo e un'ascia gigantesca ti precipita addosso, il tuo drago non Ã¨ abbastanza forte per proteggerti, l'ascia ti prende in pieno e perdi metÃ  della tua salute!", dNext);
																			});
																		}
																		connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	});
																});
															});
														} else {
															return;
														}
													}
												});
											} else if (dir == -3) {
												var min = room_id - 3;
												var max = room_id + 10;

												connection.query('SELECT room_id, dir_top, dir_right, dir_left FROM dungeon_rooms WHERE room_id BETWEEN ' + min + ' AND ' + max + ' AND room_id != ' + room_id + ' AND dungeon_id = ' + dungeon_id + ' ORDER BY RAND()', function (err, rows, fields) {
													if (err) throw err;

													if ((param == null) || (param == undefined)) {
														var i1 = rows[0].room_id;
														var i2 = rows[1].room_id;
														var i3 = rows[2].room_id;
														var d1 = "";
														var d2 = "";
														var d3 = "";
														var r1 = 0;
														var r2 = 0;
														var r3 = 0;
														var c1 = 0;
														var c2 = 0;
														var c3 = 0;

														var rand0 = Math.random() * 100;
														if (rand0 < 33) {
															c1 = 1;
															c2 = 0;
															c3 = 0;
														} else if (rand0 < 66) {
															c1 = 0;
															c2 = 1;
															c3 = 0;
														} else {
															c1 = 0;
															c2 = 0;
															c3 = 1;
														}

														var rand1 = Math.random() * 100;
														if (rand1 < 30) {
															r1 = rows[0].dir_top;
															d1 = "top";
														} else if (rand1 < 60) {
															r1 = rows[0].dir_right;
															d1 = "right";
														} else {
															r1 = rows[0].dir_left;
															d1 = "left";
														}
														if (c1 == 0) {
															if (r1 > 8)
																r1 = Math.round(getRandomArbitrary(-10, 9));
															else
																r1++;
														}

														var rand2 = Math.random() * 100;
														if (rand2 < 30) {
															r2 = rows[1].dir_top;
															d2 = "top";
														} else if (rand2 < 60) {
															r2 = rows[1].dir_right;
															d2 = "right";
														} else {
															r2 = rows[1].dir_left;
															d2 = "left";
														}
														if (c2 == 0) {
															if (r2 > 8)
																r2 = Math.round(getRandomArbitrary(-10, 9));
															else
																r2++;
														}

														var rand3 = Math.random() * 100;
														if (rand3 < 30) {
															r3 = rows[2].dir_top;
															d3 = "top";
														} else if (rand3 < 60) {
															r3 = rows[2].dir_right;
															d3 = "right";
														} else {
															r3 = rows[2].dir_left;
															d3 = "left";
														}
														if (c3 == 0) {
															if (r3 > 8)
																r3 = Math.round(getRandomArbitrary(-10, 9));
															else
																r3++;
														}

														var sequence = i1 + "," + r1 + "," + d1 + "," + c1 + "," +
															i2 + "," + r2 + "," + d2 + "," + c2 + "," +
															i3 + "," + r3 + "," + d3 + "," + c3;

														connection.query('UPDATE dungeon_status SET param = "' + sequence + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
														param = sequence;
													}

													var params = param.split(",");
													var iKeys = [];

													var dir1 = "";
													var dir2 = "";
													var dir3 = "";

													if (params[2] == "top") {
														dir1 = "Avanti";
													} else if (params[2] == "right") {
														dir1 = "Destra";
													} else {
														dir1 = "Sinistra";
													}
													if (params[6] == "top") {
														dir2 = "Avanti";
													} else if (params[6] == "right") {
														dir2 = "Destra";
													} else {
														dir2 = "Sinistra";
													}
													if (params[10] == "top") {
														dir3 = "Avanti";
													} else if (params[10] == "right") {
														dir3 = "Destra";
													} else {
														dir3 = "Sinistra";
													}
													iKeys.push(["1. Stanza " + params[0] + " (" + dir1 + "): " + dungeonToDesc(params[1])]);
													iKeys.push(["2. Stanza " + params[4] + " (" + dir2 + "): " + dungeonToDesc(params[5])]);
													iKeys.push(["3. Stanza " + params[8] + " (" + dir3 + "): " + dungeonToDesc(params[9])]);

													iKeys.push(["Cambia Incisione"]);
													iKeys.push(["Torna al menu"]);

													var dOptions = {
														parse_mode: "HTML",
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": iKeys
														}
													};

													var dYesNo = {
														parse_mode: "HTML",
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": [["Si"], ["Torna al dungeon"]]
														}
													};

													var next = -1;
													var winroom = 1;
													if (params[3] != 0) {
														winroom = params[0];
													} else if (params[7] != 0) {
														winroom = params[4];
													} else if (params[11] != 0) {
														winroom = params[8];
													} else {
														bot.sendMessage(message.chat.id, "Errore misterioso, contatta l'admin", back);
														return;
													}

													bot.sendMessage(message.chat.id, "In questa stanza non noti nessuna porta, al loro posto 3 incisioni con un pulsante ciascuna, le leggi e rifletti su quale premere.", dOptions).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {

															if (answer.text == "Cambia Incisione") {
																bot.sendMessage(message.chat.id, "Per cambiare le iscrizioni dovrai attendere 10 minuti, procedi?", dYesNo).then(function () {
																	answerCallbacks[message.chat.id] = function (answer) {
																		if (answer.text.toLowerCase() == "si") {

																			var d = new Date();
																			d.setMinutes(d.getMinutes() + 10);
																			var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																			var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

																			connection.query('UPDATE dungeon_status SET room_time = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});

																			if (timecheck >= 5) {
																				connection.query('UPDATE dungeon_status SET room_id = ' + winroom + ', last_dir = NULL, param = NULL, timevar = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;
																					bot.sendMessage(message.chat.id, "Hai esaurito i tentativi, vieni automaticamente sbalzato alla stanza corretta!", dNext);
																				});
																				return;
																			}

																			connection.query('UPDATE dungeon_status SET param = NULL, timevar = timevar+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(message.chat.id, "Le iscrizioni piano piano svaniscono...", dNext);
																			});
																		}
																	}
																});
																return;
															}

															if (answer.text.indexOf("1.") != -1) {
																if (params[3] == 0) {
																	win = 0;
																} else {
																	win = 1;
																}
																next = params[0];
															} else if (answer.text.indexOf("2.") != -1) {
																if (params[7] == 0) {
																	win = 0;
																} else {
																	win = 1;
																}
																next = params[4];
															} else if (answer.text.indexOf("3.") != -1) {
																if (params[11] == 0) {
																	win = 0;
																} else {
																	win = 1;
																}
																next = params[8];
															} else {
																return;
															}

															if (next == -1) {
																bot.sendMessage(message.chat.id, "Errore selezione stanza, riprova (" + next + ")", back);
																return;
															}

															if (next == 0)
																next++;

															if (win == 1) {
																connection.query('UPDATE dungeon_status SET param = NULL, timevar = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Premi un pulsante e sul muro appare un messaggio con scritto _'La stanza indicata corrisponde perfettamente alla sua descrizione!'_, vieni teletrasportato alla stanza " + next + " del dungeon", dNext);
																});
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = ' + next + ', last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															} else {
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '", timevar = timevar+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	if (timecheck >= 5) {
																		connection.query('UPDATE dungeon_status SET room_id = ' + winroom + ', last_dir = NULL, param = NULL, timevar = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai esaurito i tentativi, vieni automaticamente sbalzato alla stanza corretta!", dNext);
																		});
																		return;
																	}

																	bot.sendMessage(message.chat.id, "Premi un pulsante ma sul muro appare un messaggio con scritto _'La stanza indicata non corrisponde alla sua descrizione, non conosci abbastanza bene il dungeon'_, sei costretto ad aspettare un po' di tempo per riprovare.", dNext);
																});
															}
														}
													});
												});
											} else if (dir == -4) {
												var iKeys = [];

												var text = "Nella stanza incontri un predone del deserto dall'aria docile, ti propone uno scambio, puoi accettarlo o ignorarlo e procedere.\n";

												connection.query('SELECT I.id As item1id, I.name As item1n, I2.id As item2id, I2.name As item2n ' +
																 'FROM dungeon_trade DT INNER JOIN item I ON DT.item_1 = I.id INNER JOIN item I2 ON DT.item_2 = I2.id ' +
																 'WHERE DT.dungeon_id = ' + dungeon_id + ' AND DT.room_id = ' + room_id,
																 function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0) {
														connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Il predone al momento non Ã¨ disponibile, la stanza viene saltata", dNext);
														});
														return;
													}
													text += "Ti offre *" + rows[0].item1n + "* in cambio del tuo *" + rows[0].item2n + "*";

													iKeys.push(["Accetta"]);
													var item1id = rows[0].item1id;
													var item2id = rows[0].item2id;

													iKeys.push(["Ignora"]);
													iKeys.push(["Torna al menu"]);

													var dItems = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": iKeys
														}
													};

													bot.sendMessage(message.chat.id, text, dItems).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															var ogg = answer.text;
															if (ogg == "Ignora") {
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	connection.query('UPDATE dungeon_status SET last_dir = NULL, room_id = room_id+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Decidi di ignorare il predone e prosegui", dNext);
																	});
																});
																return;
															} else if (ogg == "Torna al menu") {
																return;
															} else {
																bot.sendMessage(message.chat.id, "Sicuro di voler accettare lo scambio?", dYesNo).then(function () {
																	answerCallbacks[message.chat.id] = function (answer) {
																		if (answer.text.toLowerCase() == "si") {

																			if (getItemCnt(player_id, item2id) < 1) {
																				bot.sendMessage(message.chat.id, "Non possiedi l'oggetto richiesto", back);
																				return;
																			}

																			addItem(player_id, item1id);
																			delItem(player_id, item2id, 1);

																			connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});

																			connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});

																			bot.sendMessage(message.chat.id, "Scambio effettuato!", dNext);
																		}
																	}
																});

															}
														}
													});
												});
											} else if (dir == -5) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Medita"], ["Termina Meditazione"], ["Torna al menu"]]
													}
												};

												if (param == null)
													param = 0;

												bot.sendMessage(message.chat.id, "Raggiungi una stanza con un'incisione profonda: Stanza della Meditazione, cosa vuoi fare?\nFin ora hai meditato " + param + " volte", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Medita") {
															if (param > 6) {
																bot.sendMessage(message.chat.id, "Non puoi meditare troppo a lungo", dNext);
																return;
															}
															if (param == 0) {
																connection.query('UPDATE dungeon_status SET param = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															} else {
																connection.query('UPDATE dungeon_status SET param = param+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}

															var rand = Math.random() * 100;
															if (rand < 4) {
																addItem(player_id, 610);
																bot.sendMessage(message.chat.id, "Per l'altissimo livello di meditazione hai ottenuto un *Pass Oro*!", mark);
															}

															var d = new Date();
															d.setMinutes(d.getMinutes() + 10 + (param * 10));
															var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
															var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

															connection.query('UPDATE dungeon_status SET room_time = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai iniziato a meditare, finirai alle " + short_date, dNext);
															});
															return;
														} else if (answer.text == "Termina Meditazione") {
															if ((param == null) || (param == 0)) {
																bot.sendMessage(message.chat.id, "Non hai meditato quindi non hai ricevuto nulla", dNext);
															} else {
																var rand = Math.random() * 100;
																if (rand < 30) {
																	addItem(player_id, 70, param);
																	bot.sendMessage(message.chat.id, "Per la meditazione prolungata, il saggio della montagna ti premia con " + param + "x Pietra Anima Preziosa!", dNext);
																} else if (rand < 60) {
																	addChest(player_id, 3, param);
																	bot.sendMessage(message.chat.id, "Per la meditazione prolungata, il saggio della montagna ti premia con " + param + "x Scrigni Preziosi!", dNext);
																} else {
																	param = param * 2;
																	addItem(player_id, 646, param);
																	bot.sendMessage(message.chat.id, "Per la meditazione prolungata, il saggio della montagna ti premia con " + param + "x Polvere!", dNext);
																}
															}

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET param = NULL, room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else {
															return;
														}
													}
												});
											} else if (dir == -6) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Tornare in piena salute"], ["Avere uno zaino pieno zeppo"], ["Essere ricco sfondato"], ["Completare il dungeon velocemente"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Davanti a te si erge un portale completamente rosso, una voce rimbomba al suo interno: esprimi un desiderio avventuriero! 'Vorrei...'", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														var rand = Math.random() * 100;
														if (answer.text == "Tornare in piena salute") {
															if (rand < 40) {
																connection.query('UPDATE player SET life = total_life WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Hai recuperato tutti gli hp!", dNext);
																});
															} else {
																connection.query('UPDATE player SET life = 1 WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Ti rimane 1 solo hp!", dNext);
																});
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else if (answer.text == "Avere uno zaino pieno zeppo") {
															connection.query('SELECT item.id, item.name FROM item, inventory WHERE item.id = inventory.item_id AND rarity = "UR" AND player_id = ' + player_id + ' AND inventory.quantity > 0 ORDER BY RAND()', function (err, rows, fields) {
																if (err) throw err;
																if (rand < 40) {
																	var name = rows[0].name;
																	addItem(player_id, rows[0].id);
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Hai ottenuto " + name + "!", dNext);
																} else {
																	if (Object.keys(rows).length == 0) {
																		bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Avendo lo zaino vuoto perÃ² non hai perso nulla!", dNext);
																	} else {
																		var name = rows[0].name;
																		delItem(player_id, rows[0].id, 1);
																		bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Hai perso " + name + "!", dNext);
																	}
																}
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															});
														} else if (answer.text == "Essere ricco sfondato") {
															if (player_rank == 0)
																player_rank = 1;
															var money = Math.round(getRandomArbitrary(100 * player_rank, 300 * player_rank));
															if (rand < 40) {
																connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Hai ottenuto " + formatNumber(money) + " Â§!", dNext);
																});
															} else {
																connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	if (rows[0].money < money)
																		money = rows[0].money;
																	connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Hai perso " + formatNumber(money) + " Â§!", dNext);
																	});
																});
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else if (answer.text == "Completare il dungeon velocemente") {
															if (rand < 40) {
																room_id += 2;
																bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ed Ã¨ stato ascoltato! Avanzi di due stanze!", dNext);
															} else {
																if (room_id < 3) {
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Essendo all'inizio del dungeon vieni sbalzato fuori perdendo un punto rango!", back);

																	var d = new Date();
																	d.setHours(d.getHours() + wait_dungeon_long);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																	connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	if (player_rank > 0) {
																		connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																} else {
																	room_id -= 2;
																	bot.sendMessage(message.chat.id, "Hai espresso il tuo desiderio... Ma non Ã¨ stato ascoltato! Retrocedi di due stanze!", dNext);
																}
															}
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = ' + room_id + ', last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else {
															return;
														}
													};
												});
											} else if (dir == -7) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Attacca con il Drago"], ["Ignora"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Entri nella stanza e per sbaglio pesti una mattonella leggermente rovinata, il muro si apre ed esce l'immenso drago di LastSoldier95, cosa fai?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Attacca con il Drago") {

															connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;

																var combat = 0;
																if (Object.keys(rows).length > 0) {
																	combat = rows[0].combat;
																}

																var rand = Math.random();
																connection.query('SELECT level, life, sleep_h FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	if ((Object.keys(rows).length == 0) || (combat == 1)) {
																		addItem(player_id, 70);
																		bot.sendMessage(message.chat.id, "Colpendo il drago scopri che si tratta in realtÃ  di un peluche, ma comunque ottieni una Pietra Anima Preziosa!", dNext);
																	} else {
																		if ((rows[0].life > 0) || ((rows[0].life == 0) && (rows[0].sleep_h > 0))) {
																			if (rows[0].level > rand) {
																				addItem(player_id, 72);
																				bot.sendMessage(message.chat.id, "Il tuo drago riesce a sconfiggere il grande Drago Darkrai, passi accanto al cadavere e prendi velocemente una Pietra Cuore Leggendario dal suo nascondiglio!", dNext);
																			} else if (rand < 60) {
																				connection.query('UPDATE dragon SET exp = exp-5 WHERE player_id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;
																					bot.sendMessage(message.chat.id, "Il tuo drago viene spazzato via dal grande Drago Darkrai, e cosÃ¬ perde 5 punti esperienza!", dNext);
																				});
																			}
																		} else {
																			addItem(player_id, 71);
																			bot.sendMessage(message.chat.id, "Colpendo il drago scopri che si tratta in realtÃ  di un peluche, ma comunque ottieni una Pietra Anima Preziosa!", dNext);
																		}
																	};
																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																});
															});
														} else if (answer.text == "Ignora") {
															bot.sendMessage(message.chat.id, "Corri velocemente verso l'uscita e passi alla stanza successiva", dNext);
															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else {
															return;
														}
													};
												});
											} else if (dir == -8) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["..."], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Entri in una stanza apparentemente vuota, cosa fai?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "...") {
															var rand = Math.random() * 200;
															var text = "";

															if (rand < 50) {
																addItem(player_id, 93);
																text = "qualcosa che in effetti potrebbe farti sentire meglio";
															} else if (rand < 70) {
																addItem(player_id, 619);
																text = "qualcosa che puÃ² farti rialzare una volta in piÃ¹";
															} else if (rand < 105) {
																connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																text = "qualcosa che luccica e riflette la luce in modo incredibile";
															} else if (rand < 140) {
																addItem(player_id, 33);
																text = "qualcosa che ti fa stare un po' piÃ¹ al caldo";
															} else if (rand < 170) {
																addItem(player_id, 646);
																text = "qualcosa che ti provoca un prurito fastidioso";
															} else if (rand < 199) {
																setExp(player_id, 10);
																text = "qualcosa che ti fa sentire un po' piÃ¹ esperto di prima";
															} else {
																addItem(player_id, 200);
																text = "qualcosa che ti provoca un brivido nella schiena";
															}

															bot.sendMessage(message.chat.id, "Succede qualcosa, " + text + ", procedi alla prossima stanza con aria interrogativa...", dNext);

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														};
													};
												});
											} else if (dir == -9) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Punta"], ["Ignora"], ["Torna al menu"]]
													}
												};

												var dOptions2 = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Gioca"], ["Torna al menu"]]
													}
												};

												if (param != null) {

													var id = param.split(":");

													connection.query('SELECT name FROM item WHERE id = ' + id[0], function (err, rows, fields) {
														if (err) throw err;

														var name1 = rows[0].name; //player

														connection.query('SELECT name FROM item WHERE id = ' + id[1], function (err, rows, fields) {
															if (err) throw err;

															var name2 = rows[0].name; //marinaio

															bot.sendMessage(message.chat.id, "Il marinaio aspetta il tuo turno avendo puntato *" + name2 + "*, mentre tu hai puntato *" + name1 + "*, inserisci un numero da 1 a 6 e lancia il dado, il vincitore sarÃ  colui che si avvicinerÃ  di piÃ¹ al risultato del dado", back).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text == "Torna al menu") {
																		return;
																	} else {
																		var num1 = Math.round(parseInt(answer.text));
																		if ((num1 < 1) || (num1 > 6) || (isNaN(num1))) {
																			bot.sendMessage(message.chat.id, "Il dado ha solo numeri da 1 a 6...", dBack);
																			return;
																		}
																		var num2 = Math.round(Math.random() * 5 + 1);
																		var dado = Math.round(Math.random() * 5 + 1);

																		var vic1 = Math.abs(dado - num1);
																		var vic2 = Math.abs(dado - num2);

																		var text = "Tu hai scelto il *" + num1 + "*\nIl marinaio ha scelto il *" + num2 + "*\n\nSul dado Ã¨ uscito il... *" + dado + "*!";
																		if (vic1 < vic2) {
																			bot.sendMessage(message.chat.id, text + "\n\nHai VINTO!", dNext);
																			addItem(player_id, id[0]);
																			addItem(player_id, id[1]);
																		} else if (vic1 == vic2) {
																			addItem(player_id, id[0]);
																			bot.sendMessage(message.chat.id, text + "\n\nPARITA'! Hai recuperato il tuo oggetto!", dNext);
																		} else {
																			bot.sendMessage(message.chat.id, text + "\n\nHai PERSO!", dNext);
																		}
																		connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL, param = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																}
															});
														});
													});
												} else {
													bot.sendMessage(message.chat.id, "Nella stanza incontri un marinaio con aria furba, ti propone una partita ai dadi, il vincitore otterrÃ  l'oggetto dell'avversario, vuoi partecipare?", dOptions).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text == "Punta") {
																bot.sendMessage(message.chat.id, "Inserisci il nome dell'oggetto da puntare, solo oggetti base e raritÃ  fino alla E", back).then(function () {
																	answerCallbacks[message.chat.id] = function (answer) {
																		if (answer.text == "Torna al menu") {
																			return;
																		} else {

																			connection.query('SELECT item.id, item.rarity, item.name FROM item, inventory WHERE item.id = inventory.item_id AND player_id = ' + player_id + ' AND name = "' + answer.text + '" AND craftable = 0 AND item.rarity IN ("C","NC","R","UR","L","E") AND inventory.quantity > 0', function (err, rows, fields) {
																				if (err) throw err;
																				if (Object.keys(rows).length == 0) {
																					bot.sendMessage(message.chat.id, "L'oggetto inserito non Ã¨ valido", back);
																					return;
																				}

																				var id1 = rows[0].id;
																				var name1 = rows[0].name;
																				var rar = rows[0].rarity;

																				delItem(player_id, id1, 1);

																				connection.query('SELECT id, name FROM item WHERE craftable = 0 AND item.rarity = "' + rar + '" AND id != ' + id1 + ' ORDER BY RAND()', function (err, rows, fields) {
																					if (err) throw err;

																					var id2 = rows[0].id;
																					var name2 = rows[0].name;

																					param = id1 + ":" + id2;

																					connection.query('UPDATE dungeon_status SET param = "' + param + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																					bot.sendMessage(message.chat.id, "Hai puntato il tuo oggetto", dNext);
																				});
																			});
																		}
																	};
																});
															} else if (answer.text == "Ignora") {
																bot.sendMessage(message.chat.id, "Ringrazi il marinaio dell'offerta e passi alla stanza successiva", dNext);
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
														}
													});
												}
											} else if (dir == -10) {
												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Porta Normale"], ["Porta Misteriosa"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Oltrepassando la porta ti trovi davanti ad altre due porte, una con un'aria familiare, l'altra con un grosso punto interrogativo scolpito sopra, quale apri?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Porta Normale") {

															bot.sendMessage(message.chat.id, "Scegli la solita porta arrugginita e procedi alla stanza successiva", dNext);

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else if (answer.text == "Porta Misteriosa") {
															connection.query('SELECT room_id FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;

																var room_id = parseInt(rows[0].room_id);

																connection.query('SELECT rooms FROM dungeon_list WHERE id = ' + dungeon_id, function (err, rows, fields) {
																	if (err) throw err;
																	var rooms = rows[0].rooms;

																	var min = room_id - 10;
																	var max = room_id + 10;

																	if (min <= 0) {
																		min = 1;
																	}
																	if (max > rooms) {
																		max = rooms;
																	}

																	var room = room_id;
																	while (room == room_id) {
																		room = Math.round(getRandomArbitrary(min, max));
																	}

																	bot.sendMessage(message.chat.id, "Apri lentamente la porta e la attraversi, ritrovandoti alla stanza numero *" + room + "* del dungeon!", dNext);

																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = ' + room + ', last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																});
															});
														}
													};
												});
											} else if (dir == -11) {

												connection.query('SELECT amount FROM dungeon_well WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, "Vedi un pozzo in lontananza, ma Ã¨ diroccato e non puoi far altro che proseguire", dNext);
														connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});
														return;
													}

													var stored_money = rows[0].amount;
													var min = player_rank * 12;

													if (min == 0) {
														min = 10;
													}

													var dOptions = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": [[min + " Â§"], ["Prova a raccoglierle"], ["Torna al menu"]]
														}
													};

													var text = "";
													if (stored_money == 0) {
														text = "_Neanche l'ombra di una monetina..._";
													} else if (stored_money < 10000) {
														text = "_Una piccola quantitÃ  di monetine..._";
													} else if (stored_money < 50000) {
														text = "_Alcune monetine..._";
													} else if (stored_money < 100000) {
														text = "_Un bel gruzzolo..._";
													} else {
														text = "_Un ottimo malloppo..._";
													}

													bot.sendMessage(message.chat.id, "Una luce esagerata ti avvolge, esci in un piccolo spiazzo di prato con un pozzo al centro ed uno schermino appoggiato sopra, puoi buttare una porzione di monetine al suo interno, sembra l'unico modo per proseguire, oppure puoi cercare di raccogliere tutto il malloppo.\n\nLo schermino segna: '" + text + "', butti...", dOptions).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text.indexOf("Â§") != -1) {

																var money = parseInt(answer.text.replace("Â§", ""));

																if (money < min) {
																	bot.sendMessage(message.chat.id, "Inserisci almeno il valore minimo: " + min + " Â§!", dBack);
																	return;
																}

																connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	var mymoney = rows[0].money;

																	if (mymoney < money) {
																		bot.sendMessage(message.chat.id, "Non hai cosÃ¬ tante monetine...", dBack);
																		return;
																	}

																	if (money <= 0) {
																		bot.sendMessage(message.chat.id, "Non essere cosÃ¬ tirchio!", dNext);
																		return;
																	}

																	if (mymoney == 0) {
																		bot.sendMessage(message.chat.id, "Non puoi procedere senza monete!", dBack);
																		return;
																	}

																	connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai gettato nel pozzo *" + money + "* monetine!\nOra prosegui alla prossima stanza", dNext);

																		connection.query('UPDATE dungeon_well SET amount = amount+' + money + ' WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	});
																});
															} else if (answer.text == "Prova a raccoglierle") {
																var rand = Math.random() * 100;

																if (stored_money == 0) {
																	bot.sendMessage(message.chat.id, "Il pozzo Ã¨ vuoto, Ã¨ inutile cercare di prendere qualcosa", dBack);
																	return;
																}

																connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	var mymoney = rows[0].money;
																	if (mymoney < Math.round(stored_money)) {
																		bot.sendMessage(message.chat.id, "Il pozzo Ã¨ troppo alto per te! Non puoi farcela, procedi in altro modo", dBack);
																		return;
																	}

																	if (mymoney == 0) {
																		bot.sendMessage(message.chat.id, "Non puoi procedere senza monete!", dBack);
																		return;
																	}

																	if (rand < 40) {
																		connection.query('UPDATE player SET money = money+' + stored_money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Sei tornato tutto intero con un sacchettino contenente *" + formatNumber(stored_money) + "* monetine!\nOra prosegui alla prossima stanza", dNext);
																		});
																		connection.query('UPDATE dungeon_well SET amount = 0 WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	} else {
																		connection.query('UPDATE player SET money = money-' + stored_money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Purtroppo sei caduto nel pozzo e per ritirarti su ti sono cadute delle monetine, ne hai perse quindi *" + formatNumber(stored_money) + "*!\nOra prosegui alla prossima stanza", dNext);
																		});
																		connection.query('UPDATE dungeon_well SET amount = amount+' + stored_money + ' WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																});
															}
														}
													});
												});
											} else if (dir == -12) {

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Consegna 1 ðŸ¦‹"], ["Ignora"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Al centro della stanza vedi un signore anziano con gli occhi sbarrati, si alza e ti porge la mano con un simbolo disegnato sopra: ðŸ¦‹. Cosa fai?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text.indexOf("Consegna") != -1) {

															connection.query('SELECT team_id FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																var team_id = 0;
																if (Object.keys(rows).length > 0) {
																	team_id = rows[0].team_id;
																	connection.query('SELECT point FROM team WHERE id = ' + team_id, function (err, rows, fields) {
																		if (err) throw err;

																		if (rows[0].point < 1){
																			bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ¦‹, ignori l'anziano saggio e prosegui", dNext);

																			connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}else{
																			connection.query('UPDATE team SET point = point-1 WHERE id = ' + team_id, function (err, rows, fields) {
																				if (err) throw err;

																				var rand = Math.round(Math.random()*2);
																				var sage_dir = "";
																				var text_dir = "";
																				if (rand == 0){
																					sage_dir = "dir_top";
																					text_dir = "dritto";
																				}else if (rand == 1){
																					sage_dir = "dir_left";
																					text_dir = "sinistra";
																				}else if (rand == 2){
																					sage_dir = "dir_right";
																					text_dir = "destra";
																				}

																				connection.query('SELECT room_id, ' + sage_dir + ' As dir FROM dungeon_rooms WHERE dungeon_id = ' + dungeon_id + ' AND room_id > ' + room_id + ' AND ' + sage_dir + ' < 11 ORDER BY RAND()', function (err, rows, fields) {
																					if (err) throw err;
																					if (Object.keys(rows).length > 0) {
																						bot.sendMessage(message.chat.id, "L'anziano si concentra e un'aura azzurrina si forma attorno a lui, dopo alcuni secondi spalanca gli occhi urlando: " + dungeonToDesc(rows[0].dir).toUpperCase() + " " + text_dir.toUpperCase() + " " + rows[0].room_id + "!!\nDopo di che se ne va a passo lento...", dNext);

																						connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					}else{
																						bot.sendMessage(message.chat.id, "L'anziano purtroppo non riesce a vedere alcuna stanza particolare davanti a te, ti restituisce il ðŸ¦‹ e ti congeda con un po' di malinconia sul volto...", dNext);

																						connection.query('UPDATE team SET point = point+1 WHERE id = ' + team_id, function (err, rows, fields) {
																							if (err) throw err;
																						});

																						connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					}
																				});
																			});
																		}
																	});
																} else {
																	bot.sendMessage(message.chat.id, "Entra in un team per possedere i ðŸ¦‹, ignori l'anziano saggio e prosegui", dNext);

																	connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
															});
														}else if (answer.text == "Ignora"){

															bot.sendMessage(message.chat.id, "Hai ignorato l'anziano saggio", dNext);

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}
													}
												});
											} else if (dir == -13) {

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Disturba"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "_Ehy amico lo sai chi sono?_. Si presenta cosÃ¬ un tipo strano in un angolino della stanza. _Posso fare solo ciÃ² che non vorresti!_. Si gira di schiena e digita qualcosa su un marchingegno strano...", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Disturba") {
															connection.query('SELECT id, room_id, dir_top, dir_right, dir_left FROM dungeon_rooms WHERE dungeon_id = ' + dungeon_id + ' AND room_id != ' + room_id + ' ORDER BY RAND()', function (err, rows, fields) {
																if (err) throw err;

																var arr = [rows[0].dir_top, rows[0].dir_left, rows[0].dir_right];
																arr = shuffle(arr);
																var newT = arr[0];
																var newL = arr[1];
																var newR = arr[2];

																connection.query('UPDATE dungeon_rooms SET dir_right = ' + newR + ', dir_left = ' + newL + ', dir_top = ' + newT + ' WHERE id = ' + rows[0].id, function (err, rows, fields) {
																	if (err) throw err;
																});
																bot.sendMessage(message.chat.id, "Tocchi lo strano tipo sulla schiena. Si gira di scatto: _Amico ho appena invertito le scelte della stanza " + rows[0].room_id + ", buon divertimento! ihih..._ Ti giri e continui seguendo il corridoio...", dNext);

																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															});
														}
													}
												});
											} else if (dir == -14) {

												var dOptions = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Si", "No"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Entri in una stanza con un piccolo specchio al centro, toccandolo senti che Ã¨ morbido, attraversabile, ti fai attirare?", dOptions).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text == "Si") {
															var new_dir = 0;
															if (Math.round(Math.random()) == 1){
																new_dir = Math.round(Math.random() * 10 + (room_num + 1));
															}else{
																// 4, -4, -11 escludere
																while ((new_dir == 0) || (new_dir == 4) || (new_dir == -4) || (new_dir == -11)){
																	new_dir = Math.round(Math.random() * 21 - max_rooms_neg);
																}
															}

															var my_dir = "";
															if (dir == dir_top){
																my_dir = "dir_top";
															}else if (dir == dir_right){
																my_dir = "dir_right";
															}else if (dir == dir_left){
																my_dir = "dir_left";
															}else{
																bot.sendMessage(message.chat.id, "Questa stanza Ã¨ giÃ  stata specchiata, retrocedi alla precedente", dNext);
																connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
																if (room_id > 1){
																	connection.query('UPDATE dungeon_status SET room_id = room_id-1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}else{
																	connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																return;
															}

															bot.sendMessage(message.chat.id, "Entri nello specchio, guardi verso il cielo e appare una scritta: _" + dungeonToDesc(new_dir) + "_.\nContinui a camminare per poi ritrovarti alla stanza precedente!", dNext);

															connection.query('UPDATE dungeon_rooms SET ' + my_dir + ' = ' + new_dir + ' WHERE room_id = ' + room_id + ' AND dungeon_id = ' + dungeon_id, function (err, rows, fields) {
																if (err) throw err;
															});

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															if (room_id > 1){
																connection.query('UPDATE dungeon_status SET room_id = room_id-1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}else{
																connection.query('UPDATE dungeon_status SET last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
														}else if (answer.text == "No") {

															bot.sendMessage(message.chat.id, "Ignori lo specchio e prosegui", dNext);

															connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}
													}
												});
											} else if (dir == -15) {

												connection.query('SELECT id FROM item WHERE craftable = 1 AND rarity IN ("NC","R","UR","L","E") ORDER BY RAND()', function (err, rows, fields) {
													if (err) throw err;

													var itemid = rows[0].id;

													connection.query('SELECT id FROM item WHERE name LIKE "Bevanda%" ORDER BY RAND()', function (err, rows, fields) {
														if (err) throw err;
														if (param == null){
															param = itemid + "," + rows[0].id;
															connection.query('UPDATE dungeon_status SET param = "' + param + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}

														var item1 = param.split(",")[0];	// Craft
														var item2 = param.split(",")[1];	// Bevanda

														connection.query('SELECT name FROM item WHERE id = ' + item1, function (err, rows, fields) {
															if (err) throw err;

															var item1_name = rows[0].name;

															connection.query('SELECT name FROM item WHERE id = ' + item2, function (err, rows, fields) {
																if (err) throw err;

																var item2_name = rows[0].name;

																var dOptions = {
																	parse_mode: "Markdown",
																	reply_markup: {
																		resize_keyboard: true,
																		//one_time_keyboard: true,
																		"keyboard": [["Si", "No"], ["Cerca " + item1_name], ["Torna al menu"]]
																	}
																};

																bot.sendMessage(message.chat.id, "Entri nella stanza e incontri l'Alchimista dell'Ovest, si dice sia il fratello del Contrabbandiere dell'Est. Ti offre una delle sue *" + item2_name + "* (attivata immediatamente) in cambio di *" + item1_name + "*, accetti?", dOptions).then(function () {
																	answerCallbacks[message.chat.id] = function (answer) {
																		if (answer.text == "Si") {

																			if (getItemCnt(player_id, item1) == 0){
																				bot.sendMessage(message.chat.id, "Non possiedi l'oggetto richiesto", dBack);
																				return;
																			}

																			connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 19', function (err, rows, fields) {
																				if (err) throw err;

																				var abBonusStone = 0;
																				if (Object.keys(rows).length > 0) {
																					abBonusStone = parseInt(rows[0].ability_level) * rows[0].val;
																				}

																				var rand3 = Math.random()*100;
																				var mplus = 0;
																				var m = 0;
																				if (rand3 < abBonusStone){
																					mplus = 1;
																				}

																				var boost_id = 0;
																				var m = 3;
																				if (item2 == 48) {
																					boost_id = 1;
																				} else if (item2 == 601) {
																					boost_id = 2;
																				} else if (item2 == 613) {
																					boost_id = 3;
																				} else if (item2 == 617) {
																					m = 2;
																					boost_id = 4;
																				} else if (item2 == 642) {
																					boost_id = 5;
																				} else if (item2 == 265) {
																					boost_id = 6;
																				} else if (item2 == 650) {
																					boost_id = 7;
																				} else if (item2 == 758) {
																					m = 2;
																					boost_id = 8;
																				} else {
																					bot.sendMessage(message.chat.id, "Bevanda non valida", back);
																					return;
																				}

																				m += mplus;

																				delItem(player_id, item1, 1);

																				connection.query('UPDATE player SET boost_id = ' + boost_id + ', boost_mission = ' + m + ' WHERE id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;

																					bot.sendMessage(message.chat.id, "Hai bevuto la " + item2_name + " e ti senti un po' meglio, prosegui il dungeon", dNext);

																					connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																					connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL, param = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																				});
																			});
																		}else if (answer.text == "No") {

																			bot.sendMessage(message.chat.id, "Ignori l'offerta e prosegui", dNext);

																			connection.query('UPDATE dungeon_status SET room_time = "' + room_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			connection.query('UPDATE dungeon_status SET room_id = room_id+1, last_dir = NULL, param = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																	}
																});
															});
														});
													});
												});
											} else {
												bot.sendMessage(message.chat.id, "Direzione non valida, segnala all'amministratore questo valore: " + dir, dBack);
											}
										}
									});
								});
							});
						};
					});
				}
			});
		});
	});
});

function dungeonToDesc(d) {
	if (d > 10) {
		return "Mostro";
	} else if (d == 1) {
		return "Scrigno";
	} else if (d == 2) {
		return "Monete";
	} else if (d == 3) {
		return "Trappola";
	} else if (d == 4) {
		return "Viandante";
	} else if (d == 5) {
		return "Leve";
	} else if (d == 6) {
		return "Persona in Pericolo";
	} else if (d == 7) {
		return "Vecchina";
	} else if (d == 8) {
		return "Pulsantiera";
	} else if (d == 9) {
		return "Stanza Divisa in Due";
	} else if (d == 10) {
		return "Spada o Bottino";
	} else if (d == 0) {
		return "Fontana di Mana";
	} else if (d == -1) {
		return "Fessura del Muro";
	} else if (d == -2) {
		return "Ascia Gigante";
	} else if (d == -3) {
		return "Tre Incisioni";
	} else if (d == -4) {
		return "Predone";
	} else if (d == -5) {
		return "Meditazione";
	} else if (d == -6) {
		return "Desideri";
	} else if (d == -7) {
		return "Dragone del Soldato";
	} else if (d == -8) {
		return "Stanza Vuota";
	} else if (d == -9) {
		return "Marinaio e Dado";
	} else if (d == -10) {
		return "Due Porte";
	} else if (d == -11) {
		return "Pozzo Ricco";
	} else if (d == -12) {
		return "Anziano Saggio";
	} else if (d == -13) {
		return "Mappatore Distratto";
	} else if (d == -14) {
		return "Specchio Magico";
	} else if (d == -15) {
		return "Alchimista dell'Ovest";
	}
}

function findMissing(numArray) {
	var miss = -1;
	numArray = numArray.map(Number);
	numArray = numArray.sort();
	var len = Object.keys(numArray).length;
	if (len == 0)
		return 1;
	for(var i=1;i<=len;i++) {
		if(numArray.indexOf(i) == -1){
			miss = i;
			break;
		}
	}
	if (miss == -1)
		miss = numArray[len-1]+1;
	return miss;
};

bot.onText(/attacca$|^Lancia ([a-zA-Z ]+) ([0-9]+)/i, function (message, match) {

	var dYesNo = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Si"], ["Torna al dungeon"]]
		}
	};

	var dungKb = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Attacca"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back);
			return;
		}

		var player_id = rows[0].id;
		var player_weapon_id = rows[0].weapon_id;
		var player_weapon2_id = rows[0].weapon2_id;
		var player_weapon3_id = rows[0].weapon3_id;
		var reborn = rows[0].reborn;
		var class_id = rows[0].class;
		var player_paralyzed = rows[0].paralyzed;
		var player_charm_id = rows[0].charm_id;
		var global_end = rows[0].global_end;

		var critical = parseInt(rows[0].weapon_crit);
		var critical_armor = parseInt(rows[0].weapon2_crit);
		var critical_shield = parseInt(rows[0].weapon3_crit);
		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;

		var power_dmg = rows[0].power_dmg;
		var power_def = rows[0].power_def;
		var power_weapon = rows[0].power_weapon;
		var power_armor = rows[0].power_armor;
		var power_shield = rows[0].power_shield;

		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;

		critical += power_weapon;
		critical_armor += power_armor;
		critical_shield += power_shield;

		if ((boost_mission == 0) && (boost_id != 0)) {
			connection.query('UPDATE player SET boost_id = 0 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		if (player_charm_id == 404) {
			critical += 6;
		}
		if (player_charm_id == 493) {
			critical += 2;
		}
		if (player_charm_id == 494) {
			critical += 4;
		}
		if (player_charm_id == 495) {
			critical_armor += 3;
		}
		if (player_charm_id == 496) {
			critical_shield += 3;
		}
		if (charm_id == 696) {
			critical += 5;
			critical_armor += 5;
			critical_shield += 3;
		}
		if ((class_id == 2) && (reborn == 3)) {
			critical_armor += 5;
		}
		if ((class_id == 2) && (reborn >= 4)) {
			critical_armor += 7;
			critical_shield += 7;
		}
		if ((class_id == 4) && (reborn == 3)) {
			critical += 2;
			critical_armor += 2;
			critical_shield += 2;
		}
		if ((class_id == 4) && (reborn >= 4)) {
			critical += 7;
			critical_armor += 7;
			critical_shield += 7;
		}
		if ((class_id == 5) && (reborn == 3)) {
			critical_shield += 4;
		}
		if ((class_id == 5) && (reborn >= 4)) {
			critical_shield += 8;
		}
		if ((class_id == 6) && (reborn == 3)) {
			critical_armor += 2;
		}
		if ((class_id == 6) && (reborn == 3)) {
			critical_shield += 2;
		}
		if ((class_id == 6) && (reborn >= 4)) {
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn >= 4)) {
			critical_shield += 7;
		}
		if ((class_id == 6) && (reborn == 5)) {
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn == 5)) {
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 3)) {
			critical_shield += 5;
		}
		if ((class_id == 8) && (reborn >= 4)) {
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 5)) {
			critical += 10;
		}
		if ((class_id == 9) && (reborn == 3)) {
			critical += 2;
			critical_shield += 2;
		}
		if ((class_id == 9) && (reborn >= 4)) {
			critical += 7;
			critical_shield += 7;
		}

		var danno = Math.round(Math.random() * (rows[0].exp / 15 + rows[0].weapon) + rows[0].weapon);
		danno += rows[0].weapon_enchant;
		danno += power_dmg;

		var charm_id = rows[0].charm_id;
		var player_exp = rows[0].exp;
		var player_life = rows[0].life;
		var player_total_life = rows[0].total_life;
		var rank = rows[0].rank;
		var automagic1 = rows[0].weapon_enchant_bonus;
		var automagic2 = rows[0].weapon2_enchant_bonus;
		var automagic3 = rows[0].weapon3_enchant_bonus;
		var boost_cast = rows[0].boost_cast;

		if (player_life <= 0) {
			bot.sendMessage(message.chat.id, "Non puoi combattere da morto!", revive);
			return;
		}

		if (charm_id == 62) {
			danno += 5;
		} else if (charm_id == 184) {
			danno += 15;
		} else if (charm_id == 188) {
			danno += 20;
		} else if (charm_id == 698) {
			danno += 30;
		}

		var bonus = 0;
		if (rows[0].weapon2 < 0) {
			var bonus = Math.abs(rows[0].weapon2) + Math.abs(rows[0].weapon3) + rows[0].weapon3_enchant + rows[0].weapon2_enchant;
			bonus += Math.round(Math.random() * ((rows[0].exp / 10 + bonus) / 2));
		}
		bonus += power_def;
		danno = parseInt(danno);
		bonus = parseInt(bonus);

		var critical_rand = Math.round(Math.random() * 100) + 1;
		var crit_bool = 0;
		var crit_txt = "";

		if (crazyMode == 1) {
			danno = danno * 2;
		}

		var magic = 0;
		var magicId = 0;
		var magicPow = 0;
		var magicPowBase = 0;

		if (message.text.indexOf("Lancia") != -1) {
			if (rows[0].magic_to == 2) {
				//match[1] = match[1].slice(0, -1);
				if (match[1] == "Furia dei Mari") {
					magic = 1;
				} else if (match[1] == "Tempesta Folgorante") {
					magic = 2;
				} else if (match[1] == "Impeto di Fiamme") {
					magic = 3;
				} else if (match[1] == "Ira Astrale") {
					magic = 4;
				}
			} else {
				return;
			}
		}

		if (rows[0].dungeon_time != null) {
			var d = new Date(rows[0].dungeon_time);
			var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

			bot.sendMessage(message.chat.id, "Puoi tornare nei dungeon alle " + short_date, back);
			return;
		}

		var pow = 0;
		if (match[2] != undefined) {
			pow = match[2];
		}

		var magicDouble = 0;
		connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 10', function (err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0) {
				abBonus = parseInt(rows[0].ability_level) * rows[0].val;
			}

			connection.query('DELETE FROM magic WHERE quantity <= 0 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				connection.query('SELECT type, id, power, quantity FROM magic WHERE player_id = ' + player_id + ' AND power = ' + pow + ' AND type = ' + magic, function (err, rows, fields) {
					if (err) throw err;

					if (magic != 0) {
						if (Object.keys(rows).length > 0) {
							if (rows[0].quantity <= 0) {
								bot.sendMessage(message.chat.id, "Hai terminato gli utilizzi dell'incantesimo selezionato!", dungKb);
								return;
							} else {
								magicId = rows[0].id;
								magicPow = rows[0].power;
								magicPowBase = magicPow;

								var rand = Math.random() * 100;
								if ((class_id == 4) && ((magic == 3) || (magic == 4)) && (reborn == 5)) {
									abBonus += 25;
								}
								if (rand < abBonus) {
									magicDouble = 1;
									//console.log("DUNG_DOUBLE");
								}
							}
						} else {
							bot.sendMessage(message.chat.id, "Non possiedi l'incantesimo selezionato!", dungKb);
							return;
						}
					}

					var automagic = 0;

					if (charm_id == 698) {
						boost_cast += 3;
					}

					if (magic == 0) {
						var magicrand = Math.random() * 100;
						if (magicrand < (5 + boost_cast)) {
							if (player_weapon_id == 630) {
								magic = 2;
								automagic = 1;
								magicPow = 50;
							} else if (player_weapon_id == 631) {
								magic = 3;
								automagic = 1;
								magicPow = 50;
							} else if (player_weapon_id == 632) {
								magic = 1;
								automagic = 1;
								magicPow = 50;
							}
						}
						if (magicrand < (10 + boost_cast)) {
							if (player_weapon_id == 638) {
								magic = 2;
								automagic = 1;
								magicPow = 200;
							} else if (player_weapon_id == 639) {
								magic = 3;
								automagic = 1;
								magicPow = 150;
							} else if (player_weapon_id == 640) {
								magic = 1;
								automagic = 1;
								magicPow = 150;
							}
						}
						if (magicrand < (30 + boost_cast)) {
							if (player_weapon_id == 754) {
								magic = 4;
								automagic = 1;
								magicPow = 150;
							}
						}

						// Incantesimo da enchant
						if ((magicrand > 80) && (automagic1 > 0) && (automagic == 0)) {
							var magicrand2 = Math.random() * 100;
							if (automagic1 == 1) {
								magic = 1;
								automagic = 1;
								magicPow = 50;
							} else if (automagic1 == 2) {
								magic = 2;
								automagic = 1;
								magicPow = 150;
							} else {
								magic = 3;
								automagic = 1;
								magicPow = 50;
							}
						}
					}

					var check = 0;
					if (magicDouble == 1) {
						if (automagic == 0) {	// per escludere lame
							if ((class_id == 2) && (reborn == 3)) {
								magicPow += magicPow * 0.1;
								magicPow += magicPowBase;
								check = 1;
							}
							if ((class_id == 2) && (reborn == 4)) {
								magicPow += magicPow * 0.25;
								magicPow += magicPowBase;
								check = 1;
							}
							if ((class_id == 2) && (reborn == 5)) {
								magicPow += magicPow * 0.75;
								magicPow += magicPowBase;
								check = 1;
							}
							if ((class_id == 3) && (reborn == 5)) {
								magicPow += magicPow * 0.3;
								magicPow += magicPowBase;
								check = 1;
							}
						}
						if (check == 0) {
							magicPow += magicPowBase;
						}
					} else {
						if (automagic == 0) {	// per escludere lame
							if ((class_id == 2) && (reborn == 3)) {
								magicPow += magicPow * 0.1;
							}
							if ((class_id == 2) && (reborn == 4)) {
								magicPow += magicPow * 0.25;
							}
							if ((class_id == 2) && (reborn == 5)) {
								magicPow += magicPow * 0.75;
							}
							if ((class_id == 3) && (reborn == 5)) {
								magicPow += magicPow * 0.3;
							}
						}
					}

					if ((class_id == 8) && (reborn > 1)) {
						magicPow -= magicPow * 0.1;
					}
					if ((class_id == 5) && (reborn == 3) && (magic == 1)) {
						magicPow += magicPow * 0.5;
					}
					if ((class_id == 5) && (reborn >= 4) && (magic == 1)) {
						magicPow += magicPow * 1;
					}

					connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 1', function (err, rows, fields) {
						if (err) throw err;

						var abBonus = 0;
						if (Object.keys(rows).length > 0) {
							abBonus = rows[0].ability_level * rows[0].val;
							critical += abBonus;
							critical_armor += abBonus;
							critical_shield += abBonus;
						}

						connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 3', function (err, rows, fields) {
							if (err) throw err;

							var abBonus2 = 0;
							if (Object.keys(rows).length > 0) {
								abBonus2 = parseInt(rows[0].ability_level) * rows[0].val;
							}

							connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;

								var combat = 0;
								if (Object.keys(rows).length > 0) {
									combat = rows[0].combat;
								}

								connection.query('SELECT damage, critical, defence, claws, saddle, life, sleep_h FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									if ((Object.keys(rows).length > 0) && (combat == 0)) {
										if ((rows[0].life > 0) || ((rows[0].life == 0) && (rows[0].sleep_h > 0))) {

											if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
												rows[0].claws += rows[0].claws * 1;
											}else if ((class_id == 7) && (reborn > 1)) {
												rows[0].claws += rows[0].claws * 0.5;
											}
											if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
												rows[0].saddle += rows[0].saddle * 1;
											}else if ((class_id == 7) && (reborn > 1)) {
												rows[0].saddle += rows[0].saddle * 0.5;
											}

											danno += parseInt(rows[0].damage);
											danno += parseInt(rows[0].claws);
											bonus += parseInt(rows[0].defence);
											bonus += parseInt(rows[0].saddle);
											var dragon_crit = rows[0].critical;
											if (charm_id == 602) {
												danno += 25;
												dragon_crit += 10;
											}
											if (charm_id == 695) {
												danno += 30;
												dragon_crit += 15;
											}

											if ((class_id == 7) && (reborn == 3)) {
												dragon_crit += 5;
											}
											if ((class_id == 7) && (reborn >= 4)) {
												dragon_crit += 7;
											}
											if ((class_id == 7) && (reborn == 5)) {
												critical += dragon_crit / 2;
											}
										}
									}

									if ((class_id == 8) && (reborn == 2)) {
										danno += danno * 0.10;
									}else if ((class_id == 8) && (reborn == 3)) {
										danno += danno * 0.15;
									}else if ((class_id == 8) && (reborn == 4)) {
										danno += danno * 0.17;
									}else if ((class_id == 8) && (reborn == 5)) {
										danno += danno * 0.30;
									}

									connection.query('SELECT * FROM dungeon_status WHERE player_id = ' + player_id + ' AND monster_id != 0', function (err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Non sei in combattimento contro un mostro!", back);
											return;
										}

										var monster_id = rows[0].monster_id;
										var monster_life = rows[0].monster_life;
										var boss_battle = rows[0].boss_battle;
										var room_id = rows[0].room_id;
										var dungeon_id = rows[0].dungeon_id;
										var pass_id = rows[0].pass;

										var paralyzed = rows[0].monster_paralyzed;
										var critic = rows[0].monster_critic;

										connection.query('SELECT * FROM dungeon_monsters WHERE id = ' + monster_id, function (err, rows, fields) {
											if (err) throw err;

											var monster_name = rows[0].name;
											var monster_total_life = rows[0].life;
											var monster_level = rows[0].level;
											var weapon_id = rows[0].weapon_id;
											var weapon2_id = rows[0].weapon2_id;
											var weapon3_id = rows[0].weapon3_id;
											var charm_id = rows[0].charm_id;

											connection.query('SELECT name, power, critical FROM item WHERE id = ' + weapon_id, function (err, rows, fields) {
												if (err) throw err;

												var weapon_dmg = rows[0].power;
												var weapon_name = rows[0].name + " (+" + rows[0].power + ")";
												var en_crit = rows[0].critical;

												if (weapon_id == 221) {
													weapon_dmg = Math.round(50 + (monster_level / 2));
												}

												connection.query('SELECT name, power_armor, critical FROM item WHERE id = ' + weapon2_id, function (err, rows, fields) {
													if (err) throw err;

													var weapon2_name = "-";
													var weapon2_dmg = 0;
													var en_crit2 = 0;
													if (Object.keys(rows).length > 0) {
														weapon2_dmg = rows[0].power_armor;
														weapon2_name = rows[0].name + " (" + rows[0].power_armor + ")";
														en_crit2 = rows[0].critical;
													}

													if (weapon2_id == 577) {
														power = Math.round(25 + (monster_level / 2));
														power = -Math.abs(power);
														extra = ", Probab. /2: " + crit + "%";
													}

													connection.query('SELECT name, power_shield, critical FROM item WHERE id = ' + weapon3_id, function (err, rows, fields) {
														if (err) throw err;

														var weapon3_name = "-";
														var weapon3_dmg = 0;
														var en_crit3 = 0;
														if (Object.keys(rows).length > 0) {
															weapon3_dmg = rows[0].power_shield;
															weapon3_name = rows[0].name + " (" + rows[0].power_shield + ")";
															en_crit3 = rows[0].critical;
														}

														if (weapon3_id == 600) {
															power = Math.round(20 + (monster_level / 2));
															power = -Math.abs(power);
														}

														connection.query('SELECT name FROM item WHERE id = ' + charm_id, function (err, rows, fields) {
															if (err) throw err;

															var charm_name = "-";
															if (Object.keys(rows).length > 0) {
																charm_name = rows[0].name;
															}

															var dBattleM = {
																parse_mode: "Markdown",
																reply_markup: {
																	resize_keyboard: true,
																	//one_time_keyboard: true,
																	"keyboard": [["Attacca " + monster_name], ["Incantesimi"], ["Scappa", "âš’", "Torna al menu"]]
																}
															};

															var dNext = {
																parse_mode: "Markdown",
																reply_markup: {
																	resize_keyboard: true,
																	//one_time_keyboard: true,
																	"keyboard": [["Prosegui il dungeon"], ["Torna al menu"]]
																}
															};

															var dBattle = {
																parse_mode: "Markdown",
																reply_markup: {
																	resize_keyboard: true,
																	//one_time_keyboard: true,
																	"keyboard": [["Attacca"], ["Torna al menu"]]
																}
															};

															var status = "Normale";
															var my_status = "Normale";

															if (paralyzed > 0) {
																status = "Paralizzato (" + paralyzed + " turni)";
															}
															if (critic > 0) {
																status = "Vulnerabile (" + critic + " turni)";
															}
															if ((paralyzed > 0) && (critic > 0)){
																status = "Paralizzato (" + paralyzed + " turni) e Vulnerabile (" + critic + " turni)";
															}

															if (player_paralyzed > 0){
																my_status = "Paralizzato (" + player_paralyzed + " turni)";
															}

															if ((paralyzed > 0) && (automagic == 1) && (magic == 2)) {
																automagic = 0;
																magic = 0;
																connection.query('UPDATE player SET boost_cast = boost_cast+5 WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
															if ((critic > 0) && (automagic == 1) && (magic == 4)){
																automagic = 0;
																magic = 0;
																connection.query('UPDATE player SET boost_cast = boost_cast+5 WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}

															bot.sendMessage(message.chat.id, "*" + monster_name + "*\nStato mob: " + status + "\n" +
																			"Salute mob: *" + formatNumber(monster_life) + "* hp\n" +
																			"Arma: " + weapon_name + "\n" +
																			"Armatura: " + weapon2_name + "\n" +
																			"Scudo: " + weapon3_name + "\n" +
																			"Talismano: " + charm_name + "\n" +
																			"Il tuo stato: " + my_status + "\n" +
																			"La tua salute: *" + formatNumber(player_life) + "* hp", dBattleM).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {

																	if (answer.text == "Scappa") {
																		bot.sendMessage(message.chat.id, "Sicuro di voler uscire dal dungeon?", dYesNo).then(function () {
																			answerCallbacks[message.chat.id] = function (answer) {
																				if (answer.text.toLowerCase() == "si") {

																					var rand = Math.random() * 100;
																					if (rand < 50) {
																						var dmg = Math.round(player_total_life * 50 / 100);
																					} else {
																						var dmg = Math.round(player_total_life * 40 / 100);
																					}

																					var exText = "";

																					connection.query('UPDATE player SET life = life-' + dmg + ' WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});

																					if (player_life - dmg <= 0) {
																						exText = "ma sei stato ucciso e quindi portato fuori dal dungeon ed il tuo rango viene ridotto.";

																						var d = new Date();
																						d.setHours(d.getHours() + wait_dungeon_long);
																						var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																						connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						if (rank > 0) {
																							connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																						}
																						connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					} else {
																						exText = "e sei sopravvissuto, di conseguenza torni alla stanza precedente, ma impiegherai un po' di tempo per riprenderti";

																						var d = new Date();
																						d.setHours(d.getHours() + (wait_dungeon - 1));
																						var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																						connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					}
																					connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																					bot.sendMessage(message.chat.id, "Tentando la fuga il mostro ti ha colpito e hai perso " + dmg + " hp, " + exText, back);
																				}
																			}
																		});
																		return;
																	}
																	if (answer.text.indexOf("Attacca") == -1) {
																		return;
																	}

																	if (paralyzed > 0) {
																		connection.query('UPDATE dungeon_status SET monster_paralyzed = monster_paralyzed-1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																	if (critic > 0) {
																		connection.query('UPDATE dungeon_status SET monster_critic = monster_critic-1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}

																	if ((magic != 0) && (player_paralyzed == 0)) {
																		setAchievement(message.chat.id, player_id, 6, 1);
																	}

																	var meParalyzed = 0;
																	if (player_paralyzed > 0) {
																		connection.query('UPDATE player SET paralyzed = paralyzed-1 WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		meParalyzed = 1;
																		danno = 0;
																		magic = 0;
																	}

																	if (magic != 1){
																		connection.query('UPDATE player SET boost_cast = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}

																	if ((magic == 2) && (meParalyzed == 0)) {
																		var turn = 0;
																		if (magicPow < 100) {
																			turn = 1;
																		} else if (magicPow < 200) {
																			turn = 2;
																		} else if (magicPow < 250) {
																			turn = 3;
																		} else if (magicPow < 300) {
																			turn = 4;
																		} else if (magicPow < 350) {
																			turn = 5;
																		} else if (magicPow < 400) {
																			turn = 6;
																		} else {
																			turn = 7;
																		}
																		var r = Math.random() * 100;
																		if ((automagic == 1) && (r < 50))
																			turn++;
																		paralyzed = turn;
																		connection.query('UPDATE dungeon_status SET monster_paralyzed = ' + (turn - 1) + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			if (magicDouble == 1) {
																				bot.sendMessage(message.chat.id, "Il mostro Ã¨ stato paralizzato per " + turn + " turni (x2)!");
																			} else {
																				bot.sendMessage(message.chat.id, "Il mostro Ã¨ stato paralizzato per " + turn + " turni!");
																			}

																			connection.query('UPDATE player SET boost_cast = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		});
																	}

																	if ((magic == 4) && (meParalyzed == 0)) {
																		var turn = 0;
																		if (magicPow < 100) {
																			turn = 1;
																		} else if (magicPow < 200) {
																			turn = 2;
																		} else if (magicPow < 250) {
																			turn = 3;
																		} else if (magicPow < 300) {
																			turn = 4;
																		} else if (magicPow < 350) {
																			turn = 5;
																		} else if (magicPow < 400) {
																			turn = 6;
																		} else {
																			turn = 7;
																		}
																		var r = Math.random() * 100;
																		if ((automagic == 1) && (r < 50))
																			turn++;
																		critic = turn;
																		connection.query('UPDATE dungeon_status SET monster_critic = ' + turn + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			if (magicDouble == 1) {
																				bot.sendMessage(message.chat.id, "Il mostro Ã¨ vulnerabile ai colpi critici per " + turn + " turni (x2)!");
																			} else {
																				bot.sendMessage(message.chat.id, "Il mostro Ã¨ vulnerabile ai colpi critici per " + turn + " turni!");
																			}
																		});
																	}

																	if ((magic != 0) && (automagic == 0) && (meParalyzed == 0)) {
																		connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields) {
																			if (err) throw err;
																			//console.log("Magia con ID " + magicId + " utilizzata");
																		});
																	}

																	connection.query('SELECT * FROM dungeon_status WHERE player_id = ' + player_id + ' AND monster_id != 0', function (err, rows, fields) {
																		if (err) throw err;

																		if (Object.keys(rows).length == 0){
																			console.log("Errore dungeon_status per player_id = " + player_id)
																			bot.sendMessage(message.chat.id, "Errore mob, contatta l'amministratore");
																			return;
																		}

																		if (paralyzed == 0)
																			paralyzed = rows[0].monster_paralyzed;
																		if (critic == 0)
																			critic = rows[0].monster_critic;

																		if (critic != 0) {
																			critical += 50;
																		}

																		var critical_rand = Math.round(Math.random() * 100) + 1;

																		if ((critical_rand <= critical) && (meParalyzed == 0)) {
																			danno = danno * 2;
																			crit_bool = 1;
																			setAchievement(message.chat.id, player_id, 33, 1);
																			crit_txt = " CRITICI";
																		}

																		var magic_txt = "";
																		if ((magic == 3) && (meParalyzed == 0)) {
																			danno = danno * (magicPow / 30);
																			if (magicDouble == 1) {
																				magic_txt = " con un incantesimo (x2)";
																			} else {
																				magic_txt = " con un incantesimo";
																			}
																		}

																		var damage = 100 + (Math.pow(monster_level, 2) * (1 + 1.5 * Math.random())) / 3.3 + Math.pow(weapon_dmg, 2) / 10.5 - bonus;

																		var heal = Math.round(((magicPow/350)*Math.abs(damage))*10);
																		if (magic == 1)
																			danno += heal;

																		if (charm_id == 404) {
																			en_crit += 6;
																		}
																		if (charm_id == 493) {
																			en_crit += 2;
																		}
																		if (charm_id == 494) {
																			en_crit += 4;
																		}
																		if (charm_id == 495) {
																			en_crit2 += 3;
																		}
																		if (charm_id == 496) {
																			en_crit3 += 3;
																		}
																		if (charm_id == 696) {
																			en_crit += 5;
																			en_crit2 += 5;
																			en_crit3 += 3;
																		}

																		if (charm_id == 63) {
																			damage = damage - 5;
																		} else if (charm_id == 186) {
																			damage = damage - 15;
																		} else if (charm_id == 189) {
																			damage = damage - 20;
																		}

																		if (player_charm_id == 698) {
																			en_crit -= 5;
																			en_crit2 -= 5;
																			en_crit3 -= 5;
																		}

																		var critical_rand2 = Math.round(Math.random() * 100) + 1;
																		var crit_txt2 = "";

																		if ((critical_rand2 <= critical_armor) && (meParalyzed == 0)) {
																			damage = damage / 1.5;
																			crit_txt2 = ", ridotti grazie alla tua corazza";
																			setAchievement(message.chat.id, player_id, 31, 1);
																		}

																		if (player_charm_id == 63) {
																			damage = damage - 5;
																		} else if (player_charm_id == 186) {
																			damage = damage - 15;
																		} else if (player_charm_id == 189) {
																			damage = damage - 20;
																		}

																		if (charm_id == 62) {
																			damage += 5;
																		} else if (charm_id == 184) {
																			damage += 15;
																		} else if (charm_id == 188) {
																			damage += 20;
																		} else if (charm_id == 698) {
																			damage += 30;
																		}

																		if ((class_id == 2) && (reborn > 1)) {
																			damage += damage * 0.05;
																		}
																		if ((class_id == 6) && (reborn > 1)) {
																			damage -= damage * 0.15;
																		}
																		if ((class_id == 8) && (reborn > 1)) {
																			damage += damage * 0.1;
																		}
																		if ((class_id == 9) && (reborn > 1)) {
																			damage += damage * 0.1;
																		}

																		damage = Math.round(damage);

																		var critical_rand = Math.random() * 100;
																		var en_crit_txt = "";
																		if ((critical_rand <= en_crit) && (paralyzed == 0)) {
																			damage = damage * 2;
																			en_crit_bool = 1;
																			en_crit_txt = " CRITICI ";
																		}

																		if (damage <= 0) {
																			damage = 0;
																		}

																		var critical_rand3 = Math.round(Math.random() * 100) + 1;
																		var crit_bool3 = 0;
																		var crit_txt3 = "";

																		if ((critical_rand3 <= critical_shield) && (meParalyzed == 0)) {
																			damage = 0;
																			crit_bool3 = 1;
																			crit_txt3 = ", assorbito completamente dallo scudo";
																			setAchievement(message.chat.id, player_id, 32, 1);
																		}

																		danno = danno - (Math.abs(weapon2_dmg) + Math.abs(weapon3_dmg));

																		var enemy_magic = "";
																		var enemy_magicRand = Math.random() * 100;
																		var heal_enemy = 0;
																		var restored = "";

																		if ((monster_level >= 50) && (paralyzed == 0)) {
																			if ((monster_level - 49) > enemy_magicRand) {
																				var rand = Math.random() * 100;

																				if (rand < 30) {
																					var r = 100;
																					rand = Math.random() * 100;
																					if ((player_weapon3_id == 672) || (automagic3 == 3)) {
																						r = 50;
																					}
																					if (r >= rand) {
																						enemy_magic = "Impeto di Fiamme";
																						damage = damage * 4;
																						if ((player_weapon2_id == 688) || (automagic2 == 3)) {
																							var r2 = Math.random() * 100;
																							if (r2 < 50) {
																								var restore = Math.round(getRandomArbitrary(100, 300));
																								restored = " Hai assorbito " + restore + " Mana Rosso dall'incantesimo!";
																								connection.query('UPDATE event_mana_status SET mana_3 = mana_3 + ' + restore + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																						}
																					}
																				} else if (rand < 60) {
																					var r = 100;
																					rand = Math.random() * 100;
																					if ((player_weapon3_id == 673) || (automagic3 == 1)) {
																						r = 50;
																					}
																					if (r >= rand) {
																						enemy_magic = "Furia dei Mari";
																						heal_enemy = getRandomArbitrary(monster_total_life * 0.01, monster_total_life * 0.1);
																						if (monster_life + heal_enemy > monster_total_life) {
																							heal_enemy = monster_total_life - monster_life;
																						}
																						if (heal_enemy < 0)
																							heal_enemy = Math.abs(heal_enemy);
																						if (heal_enemy > 50000) {
																							heal_enemy = 50000;
																						}
																						heal_enemy = Math.round(heal_enemy);
																						//console.log("heal_dungeon: " + heal_enemy);
																						connection.query('UPDATE dungeon_status SET monster_life = monster_life+' + heal_enemy + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						monster_life += heal_enemy;	// altrimenti non conta bene la riduzione o quando deve essere ucciso
																						if ((player_weapon2_id == 689) || (automagic2 == 1)) {
																							var r2 = Math.random() * 100;
																							if (r2 < 50) {
																								var restore = Math.round(getRandomArbitrary(100, 300));
																								restored = " Hai assorbito " + restore + " Mana Blu dall'incantesimo!";
																								connection.query('UPDATE event_mana_status SET mana_1 = mana_1 + ' + restore + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																						}
																					}
																				} else {
																					var r = 100;
																					rand = Math.random() * 100;
																					if ((player_weapon3_id == 671) || (automagic3 == 2)) {
																						r = 50;
																					}
																					if ((r >= rand) && (meParalyzed == 0)) {
																						enemy_magic = "Tempesta Folgorante";
																						connection.query('UPDATE player SET paralyzed = 2 WHERE id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						if ((player_weapon2_id == 690) || (automagic2 == 2)) {
																							var r2 = Math.random() * 100;
																							if (r2 < 50) {
																								var restore = Math.round(getRandomArbitrary(100, 300));
																								restored = " Hai assorbito " + restore + " Mana Giallo dall'incantesimo!";
																								connection.query('UPDATE event_mana_status SET mana_2 = mana_2 + ' + restore + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																						}
																					}
																				}
																			}
																		}

																		var multi = Math.round(Math.floor(player_exp / 10) / 10);
																		if (multi >= 3) {
																			danno = danno * 3;
																			//damage = damage*3;
																		} else {
																			danno = danno * multi;
																			//damage = damage*multi;
																		}

																		if ((boost_mission > 0) && (boost_id == 6) && (meParalyzed == 0)) {
																			connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																			danno = danno * 2;
																		}

																		var en_rand = Math.random() * 100;
																		var crit_en2 = "";
																		if (en_rand <= en_crit2) {
																			danno = danno / 2;
																			crit_en2 = ", ridotti a causa della sua corazza";
																		}

																		en_rand = Math.random() * 100;
																		if (en_rand <= en_crit3) {
																			danno = 0;
																		}

																		if (danno < 0)
																			danno = 0;

																		danno = Math.round(danno);

																		var lifesum = monster_life - danno;
																		if (lifesum <= 0) {
																			connection.query('UPDATE dungeon_status SET monster_id = 0, monster_life = 0, last_dir = NULL, monster_paralyzed = 0, monster_critic = 0, room_id = room_id+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;

																				var chest_id = Math.ceil(room_id / 10);
																				var money = 0;
																				var moneyText = "";
																				var rand = Math.random() * 100;
																				var exp = 1;

																				if (chest_id >= 4) {
																					chest_id = 4;
																				}

																				money = Math.round(Math.random() * (room_id * 10) + 100 + (rank * 2));
																				var now = new Date();
																				if (now.getHours() < 6) {
																					money = money * 2;
																				}
																				if ((class_id == 9) && (reborn == 5)) {
																					money += money * 0.1;
																				}

																				money = Math.round(money);
																				moneyText = formatNumber(money) + " Â§";

																				if (rand < 15) {
																					chest_id++;
																				}
																				if (boss_battle == 1) {
																					chest_id++;
																					exp++;
																				}
																				if (crazyMode == 1) {
																					if (chest_id < 6)
																						chest_id++;
																				}

																				connection.query('SELECT name FROM chest WHERE id = ' + chest_id, function (err, rows, fields) {
																					if (err) throw err;

																					var chestName = rows[0].name;
																					var randS = Math.random() * 100;
																					var chest = 0;
																					if (randS <= 90) {
																						addChest(player_id, chest_id);
																						chest = 1;
																					}
																					if ((boss_battle == 1) && (chest == 0)) {
																						addChest(player_id, chest_id);
																						chest = 1;
																					}

																					if (enemy_magic == "Tempesta Folgorante") {
																						bot.sendMessage(message.chat.id, "Prima di esalare l'ultimo respiro, lancia " + enemy_magic);
																					}
																					if (restored != "") {
																						bot.sendMessage(message.chat.id, restored.trim());
																					}

																					if (chest == 1) {
																						bot.sendMessage(message.chat.id, "Hai ucciso il mostro, infliggendo " + formatNumber(danno) + " danni e ottenuto " + exp + " exp.\nFrugando tra le sue cose hai ottenuto *" + moneyText + "* ed uno *" + chestName + "*!", dNext);
																					} else if (chest == 0) {
																						bot.sendMessage(message.chat.id, "Hai ucciso il mostro, infliggendo " + formatNumber(danno) + " danni e ottenuto " + exp + " exp.\nFrugando tra le sue cose hai ottenuto *" + moneyText + "*!", dNext);
																					}

																					if ((snowHouse == 1) && (snowHouseEnd == 0)){
																						var rand = Math.random()*100;
																						if (rand < 5){
																							connection.query('SELECT COUNT(id) As cnt FROM event_snowball_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																								if (rows[0].cnt > 0){
																									connection.query('SELECT COUNT(id) As cnt FROM event_snowball_list WHERE player_id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																										var snowball = 1+parseInt(rows[0].cnt);
																										connection.query('UPDATE event_snowball_status SET snowball = snowball+' + snowball + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																											if (err) throw err;
																											bot.sendMessage(message.chat.id, "Hai trovato " + snowball + " Palle di Neve!");
																											console.log(snowball + " palle di neve a " + message.from.username);
																										});
																									});
																								}
																							});
																						};
																					};

																					setAchievement(message.chat.id, player_id, 3, 1);

																					if (boss_battle == 1) {
																						connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;

																							var rankPoint = 1;
																							if (luckyMode == 1) {
																								var d = new Date();
																								if (d.getDay() == 6) {
																									var rand = Math.random() * 100;
																									if (rand < 25) {
																										rankPoint = 2;
																									}
																								} else if (d.getDay() == 0) {
																									var rand = Math.random() * 100;
																									if (rand < 25) {
																										rankPoint = 2;
																									} else if ((rand > 25) && (rand < 50)) {
																										rankPoint = 0;
																									}
																								}
																							}

																							var refill = "";
																							if (player_life < player_total_life / 2) {
																								connection.query('UPDATE player SET life = ROUND(total_life/2,0) WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								refill = "Inoltre la tua salute Ã¨ stata ricaricata fino al 50%!";
																							}

																							connection.query('SELECT chat_id, rank FROM player WHERE id = ' + pass_id, function (err, rows, fields) {
																								if (err) throw err;

																								var getrank1 = 0;

																								if (pass_id != 0) {

																									var getrank2 = 0;
																									if (rank - rows[0].rank >= 150){
																										connection.query('UPDATE player SET rank = rank+' + rankPoint + ' WHERE id = ' + pass_id, function (err, rows, fields) {
																											if (err) throw err;
																										});
																										getrank2 = 1;
																									}else{
																										connection.query('UPDATE player SET rank = rank+' + rankPoint + ' WHERE id = ' + player_id, function (err, rows, fields) {
																											if (err) throw err;
																										});
																										getrank1 = 1;
																										connection.query('UPDATE player SET rank = rank+' + rankPoint + ' WHERE id = ' + pass_id, function (err, rows, fields) {
																											if (err) throw err;
																										});
																										getrank2 = 1;
																									}

																									if (getrank2 == 1) {
																										bot.sendMessage(rows[0].chat_id, "Il tuo compagno " + message.from.username + " ha completato il dungeon ed hai ottenuto " + rankPoint + " punti rango!");
																									} else {
																										bot.sendMessage(rows[0].chat_id, "Il tuo compagno " + message.from.username + " ha completato il dungeon!");
																									}
																								} else {
																									connection.query('UPDATE player SET rank = rank+' + rankPoint + ' WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									getrank1 = 1;
																								}

																								setAchievement(message.chat.id, player_id, 26, 1);
																								if (getrank1 == 1) {
																									bot.sendMessage(message.chat.id, "Hai completato il dungeon! Hai ottenuto " + rankPoint + " punto rango!\n" + refill, back);
																								} else {
																									bot.sendMessage(message.chat.id, "Hai completato il dungeon!\n" + refill, back);
																								}

																								var rand = Math.round(Math.random() * 100);
																								if ((rand <= 5) && (rank > 20)) {
																									addItem(player_id, 618);
																									bot.sendMessage(message.chat.id, "Sul pavimento appena fuori dal dungeon hai trovato una *Capsula Estrazione*! Che fortuna!", mark);
																								}

																								var d = new Date();
																								d.setHours(d.getHours() + wait_dungeon);
																								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																								connection.query('UPDATE player SET dungeon_count = dungeon_count+1, dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																									setAchievementProgress(player_id, 3);
																								});

																								connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							});
																						});
																					}

																					var d = new Date();
																					var sec = wait_room;

																					if (abBonus2 > 0) {
																						sec -= abBonus2;
																					}
																					if ((class_id == 3) && (reborn == 3)) {
																						sec = sec - 120;
																					}
																					if ((class_id == 9) && (reborn > 1)) {
																						sec = sec - 120;
																					}
																					if ((class_id == 9) && (reborn == 5)) {
																						sec = sec - 180;
																					}
																					if ((class_id == 3) && (reborn >= 4)) {
																						sec = sec - 300;
																					}
																					if (crazyMode == 1) {
																						sec = sec - 120;
																					}

																					if (boost_id == 8) {
																						if (boost_mission - 1 == 0) {
																							connection.query('UPDATE player SET boost_mission = 0, boost_id = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																						} else {
																							connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																						}

																						sec = Math.ceil(sec/2);
																					}

																					d.setSeconds(d.getSeconds() + sec);

																					var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																					var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

																					connection.query('UPDATE dungeon_status SET room_time = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});

																					setExp(player_id, exp);
																					connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																				});
																			});
																			return;
																		} else {
																			if (meParalyzed == 0) {
																				if (danno == 0) {
																					bot.sendMessage(message.chat.id, "Il mostro ha evitato il tuo colpo!");
																				} else {
																					bot.sendMessage(message.chat.id, "Hai colpito il mostro e hai inferto *" + formatNumber(danno) + "* danni" + crit_txt + magic_txt + crit_en2 + "!", mark);
																				}
																			} else if (meParalyzed == 1) {
																				if ((player_paralyzed - 1) != 0) {
																					bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il mostro, sei ancora paralizzato per " + (player_paralyzed - 1) + " turni");
																				} else {
																					bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il mostro, e ora non sei piÃ¹ paralizzato");
																				}
																			}
																			connection.query('UPDATE dungeon_status SET monster_life = ' + lifesum + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}

																		if (paralyzed > 0) {
																			bot.sendMessage(message.chat.id, "Il mostro Ã¨ paralizzato!", dBattle);
																			return;
																		}

																		var extra = "";
																		if (enemy_magic != "") {
																			extra = "ha lanciato *" + enemy_magic + "*";
																			if (heal_enemy != 0) {
																				extra += " (+" + formatNumber(heal_enemy) + " hp)";
																			}
																		}

																		if (magic == 1)
																			damage = 0;

																		var mylifesum = player_life - damage;
																		if (mylifesum <= 0) {
																			connection.query('UPDATE player SET life = life-' + damage + ', paralyzed = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																				connection.query('DELETE FROM dungeon_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;

																					if (extra != "") {
																						bot.sendMessage(message.chat.id, "Il mostro " + extra + " e ti ha ucciso, vieni riportato all'entrata del dungeon.\nIl tuo rango viene ridotto.", back);
																					} else {
																						bot.sendMessage(message.chat.id, "Sei stato ucciso dal mostro, vieni riportato all'entrata del dungeon.\nIl tuo rango viene ridotto.", back);
																					}

																					var d = new Date();
																					d.setHours(d.getHours() + wait_dungeon_long);
																					var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																					connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																					connection.query('UPDATE player SET dungeon_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																					});

																					if (rank > 0) {
																						connection.query('UPDATE player SET rank = rank-1 WHERE id = ' + player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					}
																				});
																			});
																			return;
																		} else {
																			var text2 = " hai perso *" + formatNumber(damage) + "* hp" + en_crit_txt + crit_txt2 + "!" + restored;
																			var magic_txt2 = "";

																			connection.query('UPDATE player SET life = life-' + damage + ' WHERE id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;
																				if (magic == 1) {
																					connection.query('UPDATE player SET life = life+' + heal + ' WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;
																						calcLife(message);
																						//console.log("Ricarica salute dungeon: " + heal);
																					});
																					if (magicDouble == 1) {
																						magic_txt2 += " (+" + formatNumber(heal) + " hp e danni - x2)";
																					} else {
																						magic_txt2 += " (+" + formatNumber(heal) + " hp e danni)";
																					}
																				}

																				if (damage == 0) {
																					if (extra != "") {
																						bot.sendMessage(message.chat.id, "Il mostro " + extra + ", ma il suo attacco successivo ha colpito a vuoto" + magic_txt2 + "!" + restored, dBattle);
																					}else if (magic == 1){
																						bot.sendMessage(message.chat.id, "Hai lanciato Furia dei Mari, previeni il danno del mostro e ne rifletti una parte potenziando il tuo attacco (subisce *" + formatNumber(danno) + "* danni), inoltre ti curi di *" + formatNumber(heal) + "* hp", dBattle);
																					} else {
																						bot.sendMessage(message.chat.id, "Il mostro ha colpito a vuoto" + crit_txt3 + magic_txt2 + "!", dBattle);
																					}
																				} else {

																					if (extra != "")
																						extra += " e ";

																					bot.sendMessage(message.chat.id, "Il mostro " + extra + "ti ha ferito," + text2 + magic_txt2, dBattle);
																				}
																			});
																		}
																	});
																};
															});
														});
													});
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
});

bot.onText(/cassa rinascita|torna alla cassa/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var exp = rows[0].exp;

		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla cassa"]]
			}
		};

		var kbConf = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Conferma"], ["Torna al menu"]]
			}
		};

		if (reborn > 3){
			bot.sendMessage(message.chat.id, "Non puoi utilizzare la Cassa a questa rinascita!", back);
			return;
		}

		connection.query('SELECT 1 FROM reborn_save WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				bot.sendMessage(message.chat.id, "Hai giÃ  attivato il salvataggio zaino per questa rinascita", back);
				return;
			}

			bot.sendMessage(message.chat.id, "La Cassa Rinascita manterrÃ  per te tutti gli oggetti nello zaino per sole 5 ðŸ’Ž durante la rinascita, continuare?", kbConf).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text == "Conferma"){

						connection.query('SELECT gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							if (rows[0].gems < 5){
								bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž, ne servono 5", back);
								return;
							}

							connection.query('UPDATE player SET gems = gems-5 WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								connection.query('INSERT INTO reborn_save (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Salvataggio completato! Hai speso 5 ðŸ’Ž", back);
									return;
								});
							});
						});
					}
				}
			});
		});
	});
});

bot.onText(/rinasci/i, function (message) {
	if (message.text.toLowerCase() == "cassa rinascita") {
		return;
	}

	if (message.text.indexOf("Rinascita") != -1) {
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var maxlev = 150;

		if (reborn == 1) {
			maxlev = 150;
			if (rows[0].exp < 1000) {
				bot.sendMessage(message.chat.id, "Raggiungi il livello 100 per accedere alla rinascita.", back);
				return;
			}
		} else if (reborn == 2) {
			maxlev = 200;
			if (rows[0].exp < 1500) {
				bot.sendMessage(message.chat.id, "Raggiungi il livello 150 per accedere alla rinascita.", back);
				return;
			}
		} else if (reborn == 3) {
			maxlev = 300;
			if (rows[0].exp < 2000) {
				bot.sendMessage(message.chat.id, "Raggiungi il livello 200 per accedere alla rinascita.", back);
				return;
			}
		} else if (reborn == 4) {
			maxlev = 1000;
			if (rows[0].exp < 3000) {
				bot.sendMessage(message.chat.id, "Raggiungi il livello 300 per accedere alla rinascita.", back);
				return;
			}
		} else {
			bot.sendMessage(message.chat.id, "Hai raggiunto il massimo livello di rinascita.", back);
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Avvia Rinascita " + reborn], ["Cassa Rinascita"], ["Torna al menu"]]
			}
		};

		var kbYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna al menu"]]
			}
		};

		var text = "*Vuoi rinascere?*\nIl tuo personaggio perderÃ  exp e zaino (se non salvato nella Cassa Rinascita)!\nRiceverai il simbolo di rinascita nelle informazioni del tuo account, inoltre un premio in Â§ e una grande quantitÃ  di Scrigni per ricominciare a creare oggetti!\nDopo la rinascita il livello massimo sarÃ  " + maxlev + "!";

		if (reborn == 4) {
			text = "Vuoi rinascere?\nIl tuo personaggio stavolta non perderÃ  nulla, riceverai il simbolo speciale e il massimo livello sarÃ  il 1000. Tuttavia per iniziare la rinascita ti servono almeno due Artefatti!\nProcedi?";
		}

		bot.sendMessage(message.chat.id, text, kb).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				var resp = answer.text;
				if (resp == "Avvia Rinascita " + reborn) {
					connection.query('SELECT 1 FROM reborn_save WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						var rebornSave = 0;
						var save = "\nNon hai salvato gli oggetti nella Cassa Rinascita, perderai tutto lo zaino, scrigni, monete ed exp.";
						if (Object.keys(rows).length == 1){
							rebornSave = 1;
							save = "\nHai salvato gli oggetti nella Cassa Rinascita, non perderai lo zaino ma solo scrigni, monete ed exp.";
						}
						if (reborn == 4){
							rebornSave = 1;
							save = "\nNon Ã¨ necessario salvare gli oggetti, non perderai nulla.";
						}

						bot.sendMessage(message.chat.id, "Sei veramente sicuro di voler continuare?" + save, kbYesNo).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase() != "si") {
									return;
								}
								if (reborn == 1) {
									var money = 250000;
									var reborn_val = 2;
									var chest1 = 30;
									var chest2 = 25;
									var chest3 = 20;
									var chest4 = 15;
									var chest5 = 10;
									var chest6 = 5;
									var chest7 = 1;

									connection.query('SELECT player_id FROM referral_list WHERE new_player = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length > 0) {
											connection.query('SELECT chat_id, id FROM player WHERE id = ' + rows[0].player_id, function (err, rows, fields) {
												if (err) throw err;
												var chat_id = rows[0].chat_id;
												connection.query('UPDATE player SET gems = gems+1, money = money+500000, gems = gems+10 WHERE id = ' + rows[0].id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(chat_id, "L'utente " + message.from.username + " che hai invitato ha appena raggiunto la Rinascita 1! Hai ottenuto cosÃ¬ 10 ðŸ’Ž e 500.000 Â§!");
												});
											});
										}
									});

								} else if (reborn == 2) {
									var money = 500000;
									var reborn_val = 3;
									var chest1 = 50;
									var chest2 = 45;
									var chest3 = 35;
									var chest4 = 30;
									var chest5 = 20;
									var chest6 = 10;
									var chest7 = 1;

									connection.query('SELECT player_id FROM referral_list WHERE new_player = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length > 0) {
											connection.query('SELECT chat_id, id FROM player WHERE id = ' + rows[0].player_id, function (err, rows, fields) {
												if (err) throw err;
												var chat_id = rows[0].chat_id;
												connection.query('UPDATE player SET gems = gems+1, money = money+1000000, gems = gems+10 WHERE id = ' + rows[0].id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(chat_id, "L'utente " + message.from.username + " che hai invitato ha appena raggiunto la Rinascita 2! Hai ottenuto cosÃ¬ 10 ðŸ’Ž e 1.000.000 Â§!");
												});
											});
										}
									});
								} else if (reborn == 3) {
									var money = 750000;
									var reborn_val = 4;
									var chest1 = 100;
									var chest2 = 70;
									var chest3 = 60;
									var chest4 = 50;
									var chest5 = 40;
									var chest6 = 20;
									var chest7 = 2;

									connection.query('SELECT player_id FROM referral_list WHERE new_player = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length > 0) {
											connection.query('SELECT chat_id, id FROM player WHERE id = ' + rows[0].player_id, function (err, rows, fields) {
												if (err) throw err;
												var chat_id = rows[0].chat_id;
												connection.query('UPDATE player SET gems = gems+1, money = money+2000000, gems = gems+10 WHERE id = ' + rows[0].id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(chat_id, "L'utente " + message.from.username + " che hai invitato ha appena raggiunto la Rinascita 3! Hai ottenuto cosÃ¬ 10 ðŸ’Ž e 2.000.000 Â§!");
												});
											});
										}
									});
								} else if (reborn == 4) {
									var reborn_val = 5;

									connection.query('SELECT COUNT(id) As num FROM artifacts WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										if (rows[0].num < 2) {
											bot.sendMessage(message.chat.id, "Devi prima ottenere almeno due artefatti!", back);
											return;
										}

										connection.query('UPDATE player SET exp = 1, life = 100, total_life = 100, mission_auto_id = 1, reborn = ' + reborn_val + ' WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Hai completato l'ultima rinascita! Ma la strada Ã¨ ancora lunga!", back);
										});
									});
									return;
								} else {
									bot.sendMessage(message.chat.id, "Rinascita non valida!", back);
									return;
								}

								connection.query('UPDATE player SET exp = 10, life = 100, total_life = 100, money = ' + money + ', mission_auto_id = 1, reborn = ' + reborn_val + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									console.log("Player resettato e soldi consegnati");

									if (rebornSave == 0){
										delAllInventory(player_id);
										console.log("Inventario svuotato");
									}else{
										connection.query('DELETE FROM reborn_save WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
										console.log("Inventario saltato");
									}

									delAllChestInventory(player_id);
									console.log("Inventario scrigni svuotato");

									addChest(player_id, 1, chest1);
									addChest(player_id, 2, chest2);
									addChest(player_id, 3, chest3);
									addChest(player_id, 4, chest4);
									addChest(player_id, 5, chest5);
									addChest(player_id, 6, chest6);
									addChest(player_id, 7, chest7);
									console.log("Scrigni consegnati");

									bot.sendMessage(message.chat.id, "Complimenti, " + message.from.username + "!\n" +
													"Hai completato la rinascita " + reborn + " e hai ottenuto:\n" +
													chest1 + " Scrigni di Legno\n" +
													chest2 + " Scrigni di Ferro\n" +
													chest3 + " Scrigni Preziosi\n" +
													chest4 + " Scrigni di Diamante\n" +
													chest5 + " Scrigni Leggendari\n" +
													chest6 + " Scrigni Epici\n" +
													chest7 + " Scrigni Capsula\n" +
													"Oltre a " + money + " Â§\n" +
													"Ed ora continua la tua incredibile avventura! Buon game!", back_html);
									console.log("Finito :)");
									calcLife(message);
								});
							};
						});
					});
				}
			};
		});
	});
});

bot.onText(/link invito/i, function (message) {
	connection.query('SELECT id, invite_code, exp, reborn FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		code = "*Il tuo codice invito*: https://telegram.me/lootgamebot?start=" + rows[0].invite_code + "\n\nAssicurati che il nickname sia impostato prima di  utilizzare il link!";
		bot.sendMessage(message.chat.id, code, no_preview_back).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text == "Torna al menu") {
					return;
				}
			};
		});
	});
});

bot.onText(/Ritorna/i, function (message) {
	connection.query('SELECT holiday, travel_id, travel_time_end, travel_limit, cave_id, cave_time_end, cave_limit, exp, gems FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var travel_time_end = rows[0].travel_time_end;
		var cave_time_end = rows[0].cave_time_end;

		if ((rows[0].travel_id == 0) && (rows[0].cave_id == 0)) {
			bot.sendMessage(message.chat.id, "Non sei in viaggio.", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var travel_id = rows[0].travel_id;
		var cave_id = rows[0].cave_id;
		var cave_limit = rows[0].cave_limit;
		var travel_limit = rows[0].travel_limit;

		if (rows[0].exp < 5) {
			bot.sendMessage(message.chat.id, "Non hai abbastanza exp!", back)
			return;
		}

		bot.sendMessage(message.chat.id, "Sicuro di voler annullare il viaggio? Ti costerÃ  5 exp", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					if (travel_id != 0) {
						if (travel_limit > 1) {
							bot.sendMessage(message.chat.id, "Sei giÃ  ritornato da un viaggio troppe volte!", back)
							return;
						}
						connection.query('SELECT duration FROM travel WHERE id = ' + travel_id, function (err, rows, fields) {
							if (err) throw err;
							connection.query('UPDATE player SET travel_id = 0, travel_time_end = NULL, exp = exp-5, travel_limit = travel_limit+1 WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Sei rientrato dal viaggio senza averlo completato.", back);
							});
						});
					} else if (cave_id != 0) {
						if (cave_limit > 1) {
							bot.sendMessage(message.chat.id, "Sei giÃ  ritornato da una cava troppe volte!", back)
							return;
						}
						connection.query('SELECT duration FROM cave WHERE id = ' + cave_id, function (err, rows, fields) {
							if (err) throw err;
							connection.query('UPDATE player SET cave_id = 0, cave_time_end = NULL, exp = exp-5, cave_limit = cave_limit+1 WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Sei rientrato dalla cava senza averla completata.", back);
							});
						});
					}
				}
			};
		});
	});
});

bot.onText(/Termina subito/i, function (message) {
	connection.query('SELECT holiday, mission_id, mission_time_end, id, gems FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var mission_time_end = rows[0].mission_time_end;
		var player_id = rows[0].id;

		if (rows[0].mission_id == 0) {
			bot.sendMessage(message.chat.id, "Non sei in missione.", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var d = new Date(mission_time_end);
		var now = new Date();
		var diff = Math.round(((now - d) / 1000) / 60); //minuti
		diff = Math.abs(diff);

		if (diff < 1) {
			bot.sendMessage(message.chat.id, "Manca meno di un minuto al termine della missione, pazienta!", back)
			return;
		}

		bot.sendMessage(message.chat.id, "Sicuro di voler terminare subito la missione? Consumerai una ðŸ’Ž. Ne possiedi " + rows[0].gems, yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {
					connection.query('SELECT gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						if (rows[0].gems < 1) {
							bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž.", back);
							return;
						}

						setAchievement(message.chat.id, player_id, 24, 1);

						var d2 = new Date();
						var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

						connection.query('UPDATE player SET gems = gems-1, mission_time_end = "' + long_date + '", mission_gem = 1, event = 1 WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Fatto! Attendi qualche secondo per ricevere il premio.", back);
						});
					});
				}
			};
		});
	});
});

bot.onText(/Completa immediatamente/i, function (message) {

	if (wanted == 1) {
		bot.sendMessage(message.chat.id, "Le ispezioni durante il ricercato non possono essere velocizzate!", back)
		return;
	}

	connection.query('SELECT holiday, id, gems FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var gems = rows[0].gems;

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		connection.query('SELECT id, datetime FROM heist WHERE from_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non hai un ispezione in corso", back);
				return;
			}

			var d = new Date(rows[0].datetime);
			var now = new Date();
			var diff = Math.round(((now - d) / 1000) / 60); //minuti
			diff = Math.abs(diff);

			if (diff < 1) {
				bot.sendMessage(message.chat.id, "Manca meno di un minuto al termine dell'ispezione, pazienta!", back)
				return;
			}

			bot.sendMessage(message.chat.id, "Sicuro di voler terminare subito l'ispezione?\nConsumerai due ðŸ’Ž. Ne possiedi " + gems, yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('SELECT gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							if (rows[0].gems < 2) {
								bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž.", back);
								return;
							}

							var d2 = new Date();
							var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

							connection.query('UPDATE heist SET datetime = "' + long_date + '" WHERE from_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								connection.query('UPDATE player SET gems = gems-2 WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Fatto! Attendi qualche secondo per conoscere il risultato.", back);
								});
							});
						});
					}
				};
			});
		});
	});
});

bot.onText(/Concludi immediatamente/i, function (message) {
	/*
	if (message.from.id != 20471035){
		return;
	}
	*/

	connection.query('SELECT id, holiday, boost_id, boost_mission, cave_id, cave_time_end, gems FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var gems = rows[0].gems;

		if (rows[0].cave_id == 0) {
			bot.sendMessage(message.chat.id, "Non sei in cava.", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var d = new Date(rows[0].cave_time_end);
		var now = new Date();
		var diff = Math.round(((now - d) / 1000) / 60); //minuti
		diff = Math.abs(diff);

		if (diff < 1) {
			bot.sendMessage(message.chat.id, "Manca meno di un minuto al termine dell'esplorazione della cava, pazienta!", back)
			return;
		}

		var cave_id = rows[0].cave_id;

		if (cave_id != 0) {
			var num = 0;
			if ((rows[0].boost_id == 3) && (rows[0].boost_mission > 0)) {
				num = (3 + cave_id) * 2;
			} else {
				num = (3 + cave_id);
			}
			bot.sendMessage(message.chat.id, "Sicuro di voler terminare subito l'esplorazione della cava? Ti costerÃ  " + num + " ðŸ’Ž. Ne possiedi " + gems, yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('SELECT gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							if (rows[0].gems < num) {
								bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž.", back);
								return;
							}

							setAchievement(message.chat.id, player_id, 24, 1);

							var d2 = new Date();
							var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

							connection.query('UPDATE player SET gems = gems-' + num + ', cave_time_end = "' + long_date + '", cave_gem = 1 WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Fatto! Attendi qualche minuto per ricevere il premio.", back);
							});
						});
					}
				};
			});
		}
	});
});

bot.onText(/Scomponi/i, function (message) {

	if (eventFestival == 1) {
		bot.sendMessage(message.chat.id, "Durante il festival non Ã¨ possibile utilizzare questa funzione!", back);
		return;
	}

	connection.query('SELECT id, exp, reborn, holiday, gems, account_id, craft_count FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;

		if ((Math.floor(exp / 10) < 50) && (reborn == 1)) {
			bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ troppo basso", back);
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Niente"]]
			}
		};

		bot.sendMessage(message.chat.id, "Puoi scomporre un oggetto nei suoi oggetti di creazione in base a questi criteri:\n\n" +
						"NC: 5.000 Â§\n" +
						"R: 10.000 Â§\n" +
						"UR: 25.000 Â§ + 4 Punti Creazione\n" +
						"L-E: 1 ðŸ’Ž + 6-10 Punti Creazione\n" +
						"UE-U: 2 ðŸ’Ž + 50-70 Punti Creazione\n\n" +
						"I punti vengono controllati sulle creazioni settimanali. Scrivi il nome completo dell'oggetto da scomporre.", kb).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text == "Niente") {
					return;
				} else {
					var ogg = answer.text.trim();

					var kbQnt = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["1", "5", "10"], ["Annulla"]]
						}
					};

					bot.sendMessage(message.chat.id, "Quante copie dell'oggetto vuoi scomporre?", kbQnt).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text != "Annulla") {

								var qnt = answer.text;

								connection.query('SELECT item.id, item.rarity, item.craftable, inventory.quantity FROM item, inventory WHERE item.id = inventory.item_id AND inventory.player_id = ' + player_id + ' AND item.name = "' + ogg + '" AND inventory.quantity > 0', function (err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato", back);
										return;
									}

									if (rows[0].craftable == 0) {
										bot.sendMessage(message.chat.id, "L'oggetto selezionato non Ã¨ creabile", back);
										return;
									}

									if ((qnt < 1) || (re.test(qnt) == false)) {
										bot.sendMessage(message.chat.id, "QuantitÃ  non valida", back);
										return;
									}

									qnt = parseInt(qnt);

									if (rows[0].quantity < qnt) {
										bot.sendMessage(message.chat.id, "Non possiedi abbastanza copie dell'oggetto selezionato.", back);
										return;
									}

									var craft = 0;
									var money = 0;
									var gems = 0;
									if (rows[0].rarity == "NC") {
										money = 5000;
									} else if (rows[0].rarity == "R") {
										money = 10000;
									} else if (rows[0].rarity == "UR") {
										money = 25000;
										craft = 2;
										craft = craft * 2;
									} else if (rows[0].rarity == "L") {
										gems = 1;
										craft = 3;
										craft = craft * 2;
									} else if (rows[0].rarity == "E") {
										gems = 1;
										craft = 5;
										craft = craft * 2;
									} else if (rows[0].rarity == "UE") {
										gems = 2;
										craft = 25;
										craft = craft * 2;
									} else if (rows[0].rarity == "U") {
										gems = 2;
										craft = 35;
										craft = craft * 2;
									} else {
										bot.sendMessage(message.chat.id, "Questa raritÃ  non Ã¨ scomponibile", back);
										return;
									}

									money = money*qnt;
									gems = gems*qnt;
									craft = craft*qnt;

									var cons = "";
									if (money > 0) {
										cons += "> " + formatNumber(money) + " Â§\n";
									}
									if (gems > 0) {
										cons += "> " + formatNumber(gems) + " ðŸ’Ž\n";
									}
									if (craft > 0) {
										cons += "> " + formatNumber(craft) + " punti creazione\n";
									}

									bot.sendMessage(message.chat.id, "Sei sicuro? Consumerai:\n" + cons, yesno).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text == "Torna al menu") {
												return;
											} else if (answer.text.toLowerCase() == "si") {

												connection.query('SELECT item.id, item.rarity, item.craftable, inventory.quantity FROM item, inventory WHERE item.id = inventory.item_id AND inventory.player_id = ' + player_id + ' AND item.name = "' + ogg + '" AND inventory.quantity > 0', function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato", back);
														return;
													}

													if (rows[0].quantity < qnt) {
														bot.sendMessage(message.chat.id, "Non possiedi abbastanza copie dell'oggetto selezionato.", back);
														return;
													}

													var material_result = rows[0].id;
													var rarity = rows[0].rarity;

													connection.query('SELECT gems, craft_count, money, craft_week FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
														if (err) throw err;

														if (rows[0].craft_week < craft) {
															bot.sendMessage(message.chat.id, "Non hai abbastanza punti creazione settimanali", back);
															return;
														}

														if (rows[0].gems < gems) {
															bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž", back);
															return;
														}

														if (rows[0].money < money) {
															bot.sendMessage(message.chat.id, "Non hai abbastanza monete", back);
															return;
														}

														connection.query('UPDATE player SET money = money - ' + money + ', craft_week = craft_week - ' + craft + ', craft_count = craft_count - ' + craft + ', gems = gems - ' + gems + ' WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															connection.query('SELECT material_1, material_2, material_3 FROM craft WHERE material_result = ' + material_result, function (err, rows, fields) {
																if (err) throw err;

																addItem(player_id, rows[0].material_1);
																addItem(player_id, rows[0].material_2);
																addItem(player_id, rows[0].material_3);

																delItem(player_id, material_result, 1);

																setAchievement(message.chat.id, player_id, 25, 1);

																var kb = {
																	parse_mode: "Markdown",
																	reply_markup: {
																		resize_keyboard: true,
																		//one_time_keyboard: true,
																		"keyboard": [["Scomponi Ancora"], ["Torna al menu"]]
																	}
																};

																bot.sendMessage(message.chat.id, "Hai completato con successo la scomposizione!", kb);
															});
														});
													});
												});
											}
										}
									});
								});
							}
						}
					});
				}
			};
		});
	});
});

bot.onText(/^Incanta/i, function (message) {

	if (message.text == "Incantaspade") {
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var gems = rows[0].gems;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;
		var w1 = parseInt(rows[0].weapon);
		var w2 = parseInt(rows[0].weapon2);
		var w3 = parseInt(rows[0].weapon3);
		var e1 = rows[0].weapon_enchant;
		var e2 = rows[0].weapon2_enchant;
		var e3 = rows[0].weapon3_enchant;
		var t1 = rows[0].weapon_enchant_end;
		var t2 = rows[0].weapon2_enchant_end;
		var t3 = rows[0].weapon3_enchant_end;
		var b1 = rows[0].weapon_enchant_bonus;
		var b2 = rows[0].weapon2_enchant_bonus;
		var b3 = rows[0].weapon3_enchant_bonus;

		if ((t1 != null) && (t2 != null) && (t3 != null)) {
			setAchievement(message.chat.id, player_id, 23, 999);
		}

		if ((message.text.indexOf("Arma") != -1) || (message.text.indexOf("Armatura") != -1) || (message.text.indexOf("Scudo") != -1)) {
			connection.query('SELECT item.name, item.rarity, inventory.quantity As num FROM player, inventory, item WHERE player.id = inventory.player_id AND item.rarity IN ("E") AND inventory.item_id = item.id AND item.name LIKE "Runa%" AND player.id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
				if (err) throw err;

				var iKeys = [];

				if (Object.keys(rows).length > 0) {
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						iKeys.push([rows[i].name + " (" + rows[i].rarity + ", " + rows[i].num + ")"]);
					}
				}

				iKeys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				var type = message.text.substring(message.text.indexOf(" ") + 1);
				var text = "";
				var w_dmg = 0;
				var w_enc = 0;

				if (type == "Arma") {
					text = "dell'arma";
					w_dmg = w1;
					if (t1 != null) {
						var d = new Date(t1);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
						bot.sendMessage(message.chat.id, "L'incantamento su questo oggetto Ã¨ ancora efficace fino alle " + short_date, back);
						return;
					}
				}
				if (type == "Armatura") {
					text = "dell'armatura";
					w_dmg = w2;
					if (t2 != null) {
						var d = new Date(t2);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
						bot.sendMessage(message.chat.id, "L'incantamento su questo oggetto Ã¨ ancora efficace fino alle " + short_date, back);
						return;
					}
				}
				if (type == "Scudo") {
					text = "dello scudo";
					w_dmg = w3;
					if (t3 != null) {
						var d = new Date(t3);
						var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
						bot.sendMessage(message.chat.id, "L'incantamento su questo oggetto Ã¨ ancora efficace fino alle " + short_date, back);
						return;
					}
				}

				var kb2 = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Gemme", "Runa"], ["Torna al menu"]]
					}
				};

				connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 20', function (err, rows, fields) {
					if (err) throw err;

					var abBonus = 0;
					if (Object.keys(rows).length > 0) {
						abBonus = parseInt(rows[0].ability_level) * rows[0].val;
					}

					var d = new Date();
					var duration = 0;
					if (crazyMode == 1) {
						duration = Math.round((10080+abBonus)/60);
					} else {
						duration = Math.round((2880+abBonus)/60);
					}

					bot.sendMessage(message.chat.id, "Il valore attuale " + text + " Ã¨ *" + w_dmg + "*, puoi aumentarne temporaneamente il valore e attribuirle l'abilitÃ   di lancio incantesimi, il tipo di incantesimo verrÃ  attribuito casualmente." +
									"\nL'effetto dell'incantamento durerÃ  *" + duration + " ore*\n" +
									"Vuoi utilizzare due ðŸ’Ž oppure una runa?", kb2).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {

							if (answer.text == "Torna al menu") {
								return;
							} else if (answer.text == "Runa") {
								bot.sendMessage(message.chat.id, "Quale Runa vuoi utilizzare?", kb).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text == "Torna al menu"){
											return;
										}

										var runa = "";
										var pos = answer.text.indexOf("(");
										if (pos != -1) {
											runa = answer.text.substr(0, pos - 1);
										}

										connection.query('SELECT item.name, item.id, item.rarity FROM inventory, item WHERE inventory.item_id = item.id AND item.name = "' + runa + '" AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
											if (err) throw err;
											if (Object.keys(rows).length == 0) {
												bot.sendMessage(message.chat.id, "Non possiedi abbastanza Rune!", back);
												return;
											}

											var rand = 0;
											if (rows[0].rarity == "UR") {
												rand = Math.random() * 5 + 5; //5-10
											} else if (rows[0].rarity == "L") {
												rand = Math.random() * 5 + 10; //10-15
											} else if (rows[0].rarity == "E") {
												rand = Math.random() * 5 + 20; //20-25
											} else {
												bot.sendMessage(message.chat.id, "Non possiedi la Runa selezionata!", back);
												return;
											}

											rand = Math.round(rand);
											delItem(player_id, rows[0].id, 1);
											setEnchant(message, player_id, type, rand, class_id, reborn);
										});
									};
								});
							} else if (answer.text == "Gemme") {
								bot.sendMessage(message.chat.id, "Sicuro di voler utilizzare due ðŸ’Ž?", yesno).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "si"){
											if (gems < 2) {
												bot.sendMessage(message.chat.id, "Non possiedi abbastanza ðŸ’Ž", kb);
												return;
											} else {
												connection.query('UPDATE player SET gems = gems-2 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}
											var rand = 0;
											rand = Math.random() * 5 + 25; //5-30
											rand = Math.round(rand);

											setEnchant(message, player_id, type, rand, class_id, reborn);
										}
									}
								});
							}
						}
					});
				});
			});
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Incanta Arma", "Incanta Armatura", "Incanta Scudo"], ["Torna al menu"]]
			}
		};

		var status = "";

		if (t1 != null) {
			var d = new Date(t1);
			var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

			status += "\n> Arma Incantata +" + e1 + " " + numToMana(b1) + " (" + short_date + ")";
		}

		if (t2 != null) {
			var d = new Date(t2);
			var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

			status += "\n> Armatura Incantata +" + e2 + " " + numToMana(b2) + " (" + short_date + ")";
		}

		if (t3 != null) {
			var d = new Date(t3);
			var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

			status += "\n> Scudo Incantato +" + e3 + " " + numToMana(b3) + " (" + short_date + ")";
		}

		bot.sendMessage(message.chat.id, "Per incantare un oggetto dell'equipaggiamento ti serve una Runa E oppure 2 ðŸ’Ž, aumenterai il valore dell'oggetto e la probabilitÃ  di lanciare incantesimi.\n" + status, kb);
	});
});

function numToMana(num) {
	if (num == 1) {
		return "Blu";
	} else if (num == 2) {
		return "Giallo";
	} else {
		return "Rosso";
	}
}

function setEnchant(message, player_id, type, rand, class_id, reborn) {
	setAchievement(message.chat.id, player_id, 23, 1);

	connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 20', function (err, rows, fields) {
		if (err) throw err;

		var abBonus = 0;
		if (Object.keys(rows).length > 0) {
			abBonus = parseInt(rows[0].ability_level) * rows[0].val;
		}

		var d = new Date();
		if (crazyMode == 1) {
			d.setMinutes(d.getMinutes() + (10080+abBonus));
		} else {
			d.setMinutes(d.getMinutes() + (2880+abBonus));
		}
		var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
		var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

		var rand2 = Math.random() * 100;
		var magicN = "";
		var magic = 0;
		if (rand2 < 30) {
			magic = 1; //Blu
			magicN = "Blu";
		} else if (rand2 < 60) {
			magic = 2; //Giallo
			magicN = "Giallo";
		} else {
			magic = 3; //Rosso
			magicN = "Rosso";
		}

		var extra = "";
		extra = ", inoltre ora puÃ² utilizzare il potere del mana *" + magicN + "*!";
		extra += "\nL'effetto terminerÃ   alle " + short_date;

		if (type == "Arma") {
			if ((class_id == 4) && (reborn == 5)) {
				rand += rand*1;
			}
			connection.query('UPDATE player SET weapon_enchant_bonus = ' + magic + ', weapon_enchant_end = "' + long_date + '", weapon_enchant = weapon_enchant + ' + rand + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Il valore incantamento arma Ã¨ aumentato di *" + rand + "*" + extra, back);
			});
		} else if (type == "Armatura") {
			if ((class_id == 5) && (reborn == 5)) {
				rand += rand*1;
			}
			connection.query('UPDATE player SET weapon2_enchant_bonus = ' + magic + ', weapon2_enchant_end = "' + long_date + '", weapon2_enchant = weapon2_enchant + ' + rand + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Il valore incantamento armatura Ã¨ aumentato di *" + rand + "*" + extra, back);
			});
		} else if (type == "Scudo") {
			if ((class_id == 5) && (reborn == 5)) {
				rand += rand*1;
			}
			connection.query('UPDATE player SET weapon3_enchant_bonus = ' + magic + ', weapon3_enchant_end = "' + long_date + '", weapon3_enchant = weapon3_enchant + ' + rand + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Il valore incantamento scudo Ã¨ aumentato di *" + rand + "*" + extra, back);
			});
		}
	});
};

bot.onText(/fai nascere il drago|accudisci drago|nutri ancora|^drago$|^drago ðŸ‰$|torna al drago/i, function (message) {
	connection.query('SELECT holiday, id, exp, charm_id, account_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var exp = rows[0].exp;

		helpMsg(message.chat.id, player_id, 5);

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length <= 0) {
				// Non possiede ancora il drago

				if (exp < 100) {
					bot.sendMessage(message.chat.id, "Devi aver raggiunto 100 exp per far nascere il drago.", back);
					return;
				}

				var dragon = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Dai un nome al drago!"], ["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Vuoi far nascere il drago?\nIl drago Ã¨ utile in varie situazioni:\n- Ti aiuta nelle lotte contro i boss\n- Riduce i tempi dei viaggi\n- Incrementa la protezione del tuo rifugio\n- Consente di produrre bevande per le missioni o i viaggi\n\nTi serviranno le seguenti pietre:\n> Pietra Anima di Legno\n> Pietra Anima di Ferro\n> Pietra Anima Preziosa\n> Pietra Cuore di Diamante\n> Pietra Cuore Leggendario\n> Pietra Spirito Epico\nSi possono trovare nelle cave dei viaggi (dal livello 10).", dragon);
			} else {
				var dragon_name = rows[0].name;
				var dragon_lev = rows[0].level;
				var dragon_exp = rows[0].exp;
				var dragon_evolved = rows[0].evolved;
				var dragon_claws = rows[0].claws;
				var dragon_saddle = rows[0].saddle;
				var dragon_saddle_id = rows[0].saddle_id;
				var dragon_claws_id = rows[0].claws_id;
				var dragon_arms_id = rows[0].arms_id;
				var dragon_type = rows[0].type;
				var dragon_arms_duration = rows[0].arms_duration;

				var dragon_claws_name = "";
				var dragon_claws_desc = "";
				var dragon_saddle_name = "";
				var dragon_saddle_desc = "";
				var dragon_arms_name = "";
				var dragon_arms_desc = "";

				if (dragon_evolved == 0) {
					if (dragon_lev >= 100) {
						setAchievement(message.chat.id, player_id, 4, 999);
					}
				} else {
					if (dragon_lev >= 200) {
						setAchievement(message.chat.id, player_id, 4, 999);
					}
				}

				connection.query('SELECT name, description FROM item WHERE id = ' + dragon_claws_id, function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						dragon_claws_name = rows[0].name;
						dragon_claws_desc = rows[0].description;
						if (dragon_claws_desc == null)
							dragon_claws_desc = "Nessun effetto aggiuntivo";
					}
					connection.query('SELECT name, description FROM item WHERE id = ' + dragon_saddle_id, function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0) {
							dragon_saddle_name = rows[0].name;
							dragon_saddle_desc = rows[0].description;
							if (dragon_saddle_desc == null)
								dragon_saddle_desc = "Nessun effetto aggiuntivo";
						}
						connection.query('SELECT name, description FROM item WHERE id = ' + dragon_arms_id, function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length > 0) {
								dragon_arms_name = rows[0].name;
								dragon_arms_desc = rows[0].description;
								if (dragon_arms_desc == null)
									dragon_arms_desc = "Nessun effetto aggiuntivo";
							}


							connection.query('SELECT item.name, inventory.quantity As num FROM item, inventory WHERE inventory.player_id = ' + player_id + ' AND item.id = inventory.item_id AND item.name LIKE "Pietra%" AND item.rarity = "D" AND inventory.quantity > 0 ORDER BY item.id', function (err, rows, fields) {
								if (err) throw err;
								var iKeys = [];
								if (Object.keys(rows).length > 0) {
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										iKeys.push(["Dai " + rows[i].name + " (" + rows[i].num + ")"]);
									}
									iKeys.push(["Dai tutte"]);
								}

								iKeys.push(["Equipaggia Drago ðŸ‰"]);
								if ((dragon_lev == 100) && (dragon_evolved == 0)) {
									iKeys.push(["Scaglia Evolutiva â˜„ï¸"]);
								}
								iKeys.push(["Rinomina Drago ðŸ’¬", "Cambia Tipo " + dragonSym(dragon_type)]);
								iKeys.push(["Bevande ðŸ¶", "Riposa ðŸ’¤", "Risorse ðŸµ"]);
								iKeys.push(["Torna al menu"]);

								var kb = {
									parse_mode: "HTML",
									reply_markup: {
										resize_keyboard: true,
										//one_time_keyboard: true,
										"keyboard": iKeys
									}
								};

								var claws_text = "";
								if (dragon_claws_id > 0) {
									claws_text = "\n<b>Artigli</b>: " + dragon_claws_name + " +" + dragon_claws + " (" + dragon_claws_desc + ")";
								}
								var saddle_text = "";
								if (dragon_saddle_id > 0) {
									saddle_text = "\n<b>Sella</b>: " + dragon_saddle_name + " -" + dragon_saddle + " (" + dragon_saddle_desc + ")";
								}
								var arms_text = "";
								if (dragon_arms_id > 0) {
									arms_text = "\n<b>Stemma</b>: " + dragon_arms_name + " (" + dragon_arms_duration + " scontri residui, " + dragon_arms_desc + ")";
								}

								var bonustext = "";

								var sInfernale = 0;
								var sGlaciale = 0;
								var sOscuro = 0;
								var sCeleste = 0;
								var sAbissale = 0;
								var sVette = 0;

								if ((dragon_saddle_id == 213) || (dragon_saddle_id == 718) || (dragon_saddle_id == 719) || (dragon_saddle_id == 720)) { //Infernale
									sInfernale++;
								} else if ((dragon_saddle_id == 214) || (dragon_saddle_id == 724) || (dragon_saddle_id == 725) || (dragon_saddle_id == 726)) { //Glaciale
									sGlaciale++;
								} else if ((dragon_saddle_id == 215) || (dragon_saddle_id == 730) || (dragon_saddle_id == 731) || (dragon_saddle_id == 732)) { //Oscuro
									sOscuro++;
								} else if ((dragon_saddle_id == 216) || (dragon_saddle_id == 736) || (dragon_saddle_id == 737) || (dragon_saddle_id == 738)) { //Celeste
									sCeleste++;
								} else if ((dragon_saddle_id == 217) || (dragon_saddle_id == 742) || (dragon_saddle_id == 743) || (dragon_saddle_id == 744)) { //Abissale
									sAbissale++;
								} else if ((dragon_saddle_id == 218) || (dragon_saddle_id == 748) || (dragon_saddle_id == 749) || (dragon_saddle_id == 750)) { //Vette
									sVette++;
								}

								if ((dragon_claws_id == 207) || (dragon_claws_id == 715) || (dragon_claws_id == 716) || (dragon_claws_id == 717)) { //Infernale
									sInfernale++;
								} else if ((dragon_claws_id == 208) || (dragon_claws_id == 721) || (dragon_claws_id == 722) || (dragon_claws_id == 723)) { //Glaciale
									sGlaciale++;
								} else if ((dragon_claws_id == 209) || (dragon_claws_id == 727) || (dragon_claws_id == 728) || (dragon_claws_id == 729)) { //Oscuro
									sOscuro++;
								} else if ((dragon_claws_id == 210) || (dragon_claws_id == 733) || (dragon_claws_id == 734) || (dragon_claws_id == 735)) { //Celeste
									sCeleste++;
								} else if ((dragon_claws_id == 211) || (dragon_claws_id == 739) || (dragon_claws_id == 740) || (dragon_claws_id == 741)) { //Abissale
									sAbissale++;
								} else if ((dragon_claws_id == 212) || (dragon_claws_id == 745) || (dragon_claws_id == 746) || (dragon_claws_id == 747)) { //Vette
									sVette++;
								}

								if (sInfernale == 2) {
									bonustext = "\nSet Infernale equipaggiato!";
								} else if (sGlaciale == 2) {
									bonustext = "\nSet Glaciale equipaggiato!";
								} else if (sOscuro == 2) {
									bonustext = "\nSet Oscuro equipaggiato!";
								} else if (sCeleste == 2) {
									bonustext = "\nSet Celeste equipaggiato!";
								} else if (sAbissale == 2) {
									bonustext = "\nSet Abissale equipaggiato!";
								} else if (sVette == 2) {
									bonustext = "\nSet delle Vette equipaggiato!";
								}

								var remain_exp = (70 * (dragon_lev+1)) - dragon_exp;
								var remain_text = "";

								if (remain_exp == 0)
									remain_exp = 70;

								if (((dragon_lev < 200) && (dragon_evolved == 1)) || ((dragon_lev < 100) && (dragon_evolved == 0)))
									remain_text = " (ancora " + remain_exp + " punti pietra)";

								if ((dragon_lev == 100) && (dragon_evolved == 0))
									remain_text = " (Scaglia Evolutiva necessaria!)";


								connection.query('SELECT item.name, item.id, inventory.quantity FROM item, inventory WHERE inventory.player_id = ' + player_id + ' AND item.id = inventory.item_id AND item.name LIKE "Pietra%" AND item.rarity = "D" AND inventory.quantity > 0', function (err, rows, fields) {
									if (err) throw err;
									var stonePnt = 0;
									var stoneQnt = 0;
									if (Object.keys(rows).length > 0) {
										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											stonePnt += (rows[i].id-67)*rows[i].quantity;
											stoneQnt += rows[i].quantity;
										}
									}

									bot.sendMessage(message.chat.id, "Cosa vuoi fare con il tuo drago?\n\n<b>Nome</b>: " + dragon_name + " " + dragon_type + " " + dragonSym(dragon_type) + "\n<b>Crescita</b>: Livello " + dragon_lev + remain_text + claws_text + saddle_text + arms_text + bonustext + "\nPossiedi <b>" + stoneQnt + "</b> pietre per <b>" + stonePnt + "</b> punti", kb).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.indexOf("Scaglia Evolutiva") != -1) {

												if (dragon_evolved == 1) {
													bot.sendMessage(message.chat.id, "Il tuo drago Ã¨ giÃ  stato evoluto", back);
													return;
												}

												bot.sendMessage(message.chat.id, "La Scaglia Evolutiva consente di aumentare il livello massimo del tuo drago, vuoi utilizzarla?", yesno).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text.toLowerCase() == "si") {
															if (getItemCnt(player_id, 649) == 0) {
																bot.sendMessage(message.chat.id, "Non possiedi la Scaglia Evolutiva", back);
																return;
															}
															delItem(player_id, 649, 1);
															connection.query('UPDATE dragon SET evolved = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Il tuo drago si Ã¨ evoluto e puÃ² superare il suo livello massimo!", back);
															});
														}
													};
												});
											}
										};
									});
								});
							});
						});
					});
				});
			}
		});
	});
});

bot.onText(/Dai un nome al drago/i, function (message) {
	connection.query('SELECT id, holiday, exp, account_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var exp = rows[0].exp;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length <= 0) {

				if (exp < 100) {
					bot.sendMessage(message.chat.id, "Devi aver raggiunto 100 exp per far nascere il drago.", back);
					return;
				}


				connection.query('SELECT id FROM inventory WHERE player_id = ' + player_id + ' AND item_id IN (68, 69, 70, 71, 72, 73) AND quantity > 0', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length >= 6) {
						var d = new Date();
						var rand = Math.round(d.getDate() / 5);
						var type = "";
						if (rand == 1) {
							type = "delle Montagne";
						} else if (rand == 2) {
							type = "dei Cieli";
						} else if (rand == 3) {
							type = "Infernale";
						} else if (rand == 4) {
							type = "dell'OscuritÃ ";
						} else if (rand == 5) {
							type = "dei Mari";
						} else {
							type = "dei Ghiacci";
						}

						bot.sendMessage(message.chat.id, "Il drago " + type + " Ã¨ nato!\nCome vorresti chiamarlo?", back).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								var name = answer.text.trim();

								if (name == "Torna al menu") {
									return;
								}

								if ((name == "Si") || (name == "") || (name.indexOf("_") != -1)) {
									bot.sendMessage(message.chat.id, "Il nome inserito non Ã¨ valido, riprova.", back);
									return;
								}

								if (re4.test(name) == false) {
									bot.sendMessage(message.chat.id, "I simboli non sono consentiti o il nome Ã¨ troppo lungo (max 40 caratteri).", back);
									return;
								}

								for (var i = 1, len = 7; i < len; i++) {
									delItem(player_id, (67+i), 1);
								}
								connection.query('INSERT INTO dragon (id, player_id, name, exp, level, damage, defence, type) VALUES (DEFAULT, ' + player_id + ', "' + name + '", 70, 1, 1, 1, "' + type + '")', function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Complimenti, Ã¨ nato *" + name + "*, puoi nutrirlo per farlo crescere e trarne vantaggi!", back);
									checkDragon(player_id);
								});
							};
						});
					} else {
						bot.sendMessage(message.chat.id, "Non hai abbastanza pietre per far nascere il drago!", back);
					}
				});
			} else {
				bot.sendMessage(message.chat.id, "Possiedi giÃ  il drago!", back);
				return;
			}
		});
	});
});

bot.onText(/^bevande|torna alle bevande/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;

			if (rows[0].boost_time != null) {
				var boost_time = new Date(rows[0].boost_time);
				var now = new Date();

				if (boost_time < now) {
					var boost_id = rows[0].boost_id;
					if (boost_id == 0) {
						boost_id = Math.round(Math.random() * 7 + 1);
						connection.query('UPDATE dragon SET boost_id = ' + boost_id + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					}

					connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 19', function (err, rows, fields) {
						if (err) throw err;

						var abBonusStone = 0;
						if (Object.keys(rows).length > 0) {
							abBonusStone = parseInt(rows[0].ability_level) * rows[0].val;
						}

						var rand3 = Math.random()*100;
						var mplus = 0;
						var m = 0;
						if (rand3 < abBonusStone){
							mplus = 1;
						}

						var itemId = 0;
						var m = 3;
						if (boost_id == 1) {
							itemId = 48;
						} else if (boost_id == 2) {
							itemId = 601;
						} else if (boost_id == 3) {
							itemId = 613;
						} else if (boost_id == 4) {
							itemId = 617;
							m = 2;
						} else if (boost_id == 5) {
							itemId = 642;
						} else if (boost_id == 6) {
							itemId = 265;
						} else if (boost_id == 7) {
							itemId = 650;
						} else if (boost_id == 8) {
							itemId = 758;
							m = 2;
						} else {
							bot.sendMessage(message.chat.id, "Bevanda non valida", back);
							return;
						}

						m += mplus;

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Attiva", "Scarta"], ["Torna al menu"]]
							}
						};

						var kb3 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Torna alle bevande"], ["Torna al menu"]]
							}
						};

						connection.query('SELECT name FROM item WHERE id = ' + itemId, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "La *" + rows[0].name + "* Ã¨ pronta, cosa vuoi fare? Attivandola andrÃ  a rimpiazzare la bevanda eventualmente attiva", kb2).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Attiva") {
										connection.query('UPDATE player SET boost_id = ' + boost_id + ', boost_mission = ' + m + ' WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											connection.query('UPDATE dragon SET boost_id = 0, boost_time = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Bevanda attivata!", kb3);
											});
										});
									} else if (answer.text == "Scarta") {
										connection.query('UPDATE dragon SET boost_id = 0, boost_time = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Bevanda scartata!", kb3);
										});
									}
								};
							});
						});
					});
				} else {
					var short_date = addZero(boost_time.getHours()) + ':' + addZero(boost_time.getMinutes());
					bot.sendMessage(message.chat.id, "La bevanda Ã¨ ancora in produzione, attendi fino alle " + short_date, back);
				}
				return;
			}

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Inizia Produzione"], ["Torna al menu"]]
				}
			};

			connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 17', function (err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				if (Object.keys(rows).length > 0) {
					abBonus = parseInt(rows[0].ability_level) * rows[0].val;
				}

				var timem = 0;
				/*
				if ((class_id == 7) && (reborn > 1)){
					timem = 120;
				}
				*/

				var time = Math.round((1440-abBonus-timem)*60);

				bot.sendMessage(message.chat.id, "Puoi far produrre una bevanda casuale al drago, ci impiegherÃ  " + toTime(time, 0) + " e ti costerÃ  una Pietra Spirito Epico", kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text == "Inizia Produzione") {

							if (getItemCnt(player_id, 73) == 0) {
								bot.sendMessage(message.chat.id, "Non hai nessuna Pietra Spirito Epico da consumare!", back);
								return;
							}

							var d = new Date();
							d.setMinutes(d.getMinutes() + (1440-abBonus-timem));
							var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
							var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

							connection.query('UPDATE dragon SET boost_time = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Produzione iniziata, dovrai attendere fino alle " + short_date + ", poi torna a recuperare la bevanda", back);
							});
							delItem(player_id, 73, 1);
							setAchievement(message.chat.id, player_id, 38, 1);
						}
					}
				});
			});
		});
	});
});

bot.onText(/cambia tipo/i, function (message) {
	var tipo = message.text.substring(message.text.indexOf(":") + 2);

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			if ((dragon_saddle_id != 0) || (dragon_claws_id != 0)) {
				bot.sendMessage(message.chat.id, "Prima di cambiare tipo al drago devi rimuovere tutti i suoi equipaggiamenti.", back);
				return;
			}

			connection.query('SELECT id FROM dragon_top_status WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0) {
					bot.sendMessage(message.chat.id, "Non puoi cambiare tipo al drago finchÃ¨ sei iscritto alla Vetta.", back);
					return;
				}

				var kbD = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["dei Mari"], ["dei Ghiacci"], ["Infernale"], ["dei Cieli"], ["delle Montagne"], ["dell'OscuritÃ "], ["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Inserisci il nuovo tipo del drago, verrÃ  consumato un Mutaforma e *il suo livello verrÃ  azzerato*.", kbD).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						var newtype = answer.text;

						if (getItemCnt(player_id, 219) == 0) {
							bot.sendMessage(message.chat.id, "Ti serve il Mutaforma per cambiare tipo al drago.", back);
							return;
						}

						if ((newtype == "") || (newtype == "Torna al menu") || (newtype == "Cambia Tipo")) {
							bot.sendMessage(message.chat.id, "Tipo non valido!", back);
							return;
						}
						if ((newtype != "dei Mari") && (newtype != "dei Ghiacci") && (newtype != "Infernale") && (newtype != "dei Cieli") && (newtype != "delle Montagne") && (newtype != "dell'OscuritÃ ")) {
							bot.sendMessage(message.chat.id, "Tipo non valido!", back);
							return;
						}

						connection.query('UPDATE dragon SET exp = 70, level = 1, type = "' + newtype + '", evolved = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							delItem(player_id, 219, 1);
							bot.sendMessage(message.chat.id, "Hai cambiato tipo al drago!", back);
							checkDragon(player_id);
						});
					};
				});
			});
		});
	});
});

bot.onText(/rinomina drago/i, function (message) {
	var name = message.text.substring(message.text.indexOf(":") + 1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}
			bot.sendMessage(message.chat.id, "Inserisci il nuovo nome del drago, verrÃ  consumato un Rinominatore.", back).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					var newname = answer.text;

					if ((newname == "") || (newname == "Torna al menu") || (newname == "Rinomina")) {
						bot.sendMessage(message.chat.id, "Nome non valido!", back);
						return;
					}

					if (re4.test(newname) == false) {
						bot.sendMessage(message.chat.id, "I simboli non sono consentiti oppure il nome Ã¨ troppo lungo (max 40 caratteri).", back);
						return;
					}

					bot.sendMessage(message.chat.id, "Sei sicuro di voler rinominare il drago: " + newname + "?", yesno).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text.toLowerCase() == "si"){
								if (getItemCnt(player_id, 199) == 0) {
									bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per rinominare il drago.", back);
									return;
								}
								connection.query('UPDATE dragon SET name = "' + newname.trim() + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									delItem(player_id, 199, 1);
									bot.sendMessage(message.chat.id, "Hai rinominato il drago!", back);
								});
							}
						}
					});
				};
			});
		});
	});
});

bot.onText(/cambia nome/i, function (message) {
	var name = message.text.substring(message.text.indexOf(":") + 1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = player_id;

				if (rows[0].role == 1) {
					isAdmin = 1;
				}

				if (isAdmin == 0) {
					bot.sendMessage(message.chat.id, "Devi essere amministratore per rinominare il team.", back);
					return;
				}

				if (getItemCnt(player_id, 199) == 0) {
					bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per rinominare il team.", back);
					return;
				}

				bot.sendMessage(message.chat.id, "Inserisci il nuovo nome del team, verrÃ  consumato un Rinominatore.", back).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						var newname = answer.text;

						if (getItemCnt(player_id, 199) == 0) {
							bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per rinominare il team.", back);
							return;
						}

						if ((newname.indexOf("Team") != -1) || (newname.indexOf("team") != -1) || (newname == "") || (newname.indexOf("_") != -1) || (newname.indexOf("*") != -1) || (newname.toLowerCase() == "Torna al menu") || (newname == "") || (newname == "Torna al menu") || (newname == "Rinomina") || (newname.toLowerCase().indexOf("madre") != -1) || (newname.toLowerCase().indexOf("accademia") != -1)) {
							bot.sendMessage(message.chat.id, "Nome non valido.", back);
							return;
						}

						if (re4.test(newname) == false) {
							bot.sendMessage(message.chat.id, "I simboli non sono consentiti o il nome Ã¨ troppo lungo (max 40 caratteri).", back);
							return;
						}

						connection.query('UPDATE team SET name = "' + newname.trim() + '" WHERE id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
						});
						delItem(player_id, 199, 1);
						bot.sendMessage(message.chat.id, "Hai rinominato il team!", team);
					};
				});
			});
		});
	});
});

bot.onText(/slogan/i, function (message) {
	var name = message.text.substring(message.text.indexOf(":") + 1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = player_id;

				if (rows[0].role == 1) {
					isAdmin = 1;
				}

				if (isAdmin == 0) {
					bot.sendMessage(message.chat.id, "Devi essere amministratore per modificare lo slogan.", back);
					return;
				}

				if (getItemCnt(player_id, 199) == 0) {
					bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per modificare lo slogan.", back);
					return;
				}

				bot.sendMessage(message.chat.id, "Inserisci il nuovo slogan del team, verrÃ  consumato un Rinominatore.", back).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						var newname = answer.text;

						if (getItemCnt(player_id, 199) == 0) {
							bot.sendMessage(message.chat.id, "Ti serve il Rinominatore per modificare lo slogan.", back);
							return;
						}

						if ((newname == "") || (newname == "Torna al menu") || (newname == "Rinomina")) {
							bot.sendMessage(message.chat.id, "Nome non valido!", back);
							return;
						}

						if (re5.test(newname) == false) {
							bot.sendMessage(message.chat.id, "I simboli non sono consentiti o lo slogan Ã¨ troppo lungo (max 255 caratteri).", back);
							return;
						}

						connection.query('UPDATE team SET slogan = "' + newname.trim() + '" WHERE id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
						});
						delItem(player_id, 199, 1);
						bot.sendMessage(message.chat.id, "Hai modificato lo slogan!", team);
					};
				});
			});
		});
	});
});

bot.onText(/dai pietra/i, function (message) {
	var foodmore = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Nutri Ancora"], ["Torna al menu"]]
		}
	};

	var pietra = message.text.substring(message.text.indexOf(" ") + 1);

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var charm_id = rows[0].charm_id;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_evolved = rows[0].evolved;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			if (dragon_evolved == 0) {
				if (dragon_lev >= 100) {
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			} else {
				if (dragon_lev >= 200) {
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			}

			connection.query('SELECT COUNT(*) As cnt FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var pos = pietra.indexOf("(");
				if (pos != -1) {
					pietra = pietra.substr(0, pos - 1);
				}

				connection.query('SELECT inventory.quantity As cnt, item.id FROM item, inventory WHERE inventory.player_id = ' + player_id + ' AND item.id = inventory.item_id AND item.name = "' + pietra + '" AND item.rarity = "D" AND quantity > 0', function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Non possiedi questa pietra.", back);
						return;
					}

					var cnt = rows[0].cnt;
					var stoneId = rows[0].id;

					cnt = cnt.toString();

					if (cnt > 1) {
						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["1"], [cnt], ["Torna al menu"]]
							}
						};
					} else {
						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["1"], ["Torna al menu"]]
							}
						};
					}

					bot.sendMessage(message.chat.id, "Quante pietre vuoi utilizzare?", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text != "Torna al menu") {

								var qnt = answer.text;

								if ((qnt < 1) || (re.test(qnt) == false)) {
									bot.sendMessage(message.chat.id, "QuantitÃ  non valida", foodmore);
									return;
								}

								qnt = parseInt(qnt);

								if (getItemCnt(player_id, stoneId) < qnt) {
									bot.sendMessage(message.chat.id, "Non possiedi abbastanza pietre.", foodmore);
									return;
								}

								var val = stoneId - 67;
								val = val * qnt;

								var exp = (dragon_exp + val);
								var lev = Math.floor((dragon_exp + val) / 70);
								if (dragon_evolved == 0) {
									if (exp > 7000) {
										bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 100", foodmore);
										return;
									}
								} else {
									if (exp > 14000) {
										bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 200", foodmore);
										return;
									}
								}
								lev = lev + 1;

								delItem(player_id, stoneId, qnt);
								connection.query('UPDATE dragon SET exp = exp+' + val + ' WHERE player_id=' + player_id, function (err, rows, fields) {
									if (err) throw err;

									var plur = "e";
									if (qnt == 1)
										plur = "a";

									bot.sendMessage(message.chat.id, "Hai nutrito il drago con " + qnt + " pietr" + plur + " (" + val + " punti pietra)!", foodmore);
									checkDragon(player_id);
								});

								setAchievement(message.chat.id, player_id, 4, val);
							};
						};
					});
				});
			});
		});
	});
});

bot.onText(/^\/checkDragonTop$/i, function (message, match) {
	checkDragonTop();
	bot.sendMessage(message.chat.id, "Fatto");
});

bot.onText(/^\/checkDragon (.+)|^\/checkdragon$/i, function (message, match) {
	if (match[1] == undefined) {
		connection.query('SELECT name, player_id FROM dragon', function (err, rows, fields) {
			if (err) throw err;
			for (i = 0; i < Object.keys(rows).length; i++) {
				checkDragon(rows[i].player_id);
				console.log("Ricalcolo di " + rows[i].name);
			}
			bot.sendMessage(message.chat.id, "Fatto");
		});
	} else {
		connection.query('SELECT id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
			if (err) throw err;
			checkDragon(rows[0].id);
			bot.sendMessage(message.chat.id, "Fatto");
		});
	}
});

function checkDragon(player_id, is_dummy = 0) {

	var target_table = "dragon";
	var where = "player_id";
	if (is_dummy == 1){
		target_table = "dragon_dummy";
		where = "id";	// se dummy il player_id diventa il dragon id
	}

	connection.query('SELECT level, exp, evolved, saddle_id, claws_id FROM ' + target_table + ' WHERE ' + where + ' = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0) {
			return;
		}
		var dragon_evolved = rows[0].evolved;
		var dragon_level = rows[0].level;
		var dragon_exp = rows[0].exp;

		var dragon_claws_id = rows[0].claws_id;
		var dragon_saddle_id = rows[0].saddle_id;

		dragon_level = Math.floor(dragon_exp / 70);

		var sInfernale = 0;
		var sGlaciale = 0;
		var sOscuro = 0;
		var sCeleste = 0;
		var sAbissale = 0;
		var sVette = 0;

		if ((dragon_saddle_id == 213) || (dragon_saddle_id == 718) || (dragon_saddle_id == 719) || (dragon_saddle_id == 720)) { //Infernale
			sInfernale++;
		} else if ((dragon_saddle_id == 214) || (dragon_saddle_id == 724) || (dragon_saddle_id == 725) || (dragon_saddle_id == 726)) { //Glaciale
			sGlaciale++;
		} else if ((dragon_saddle_id == 215) || (dragon_saddle_id == 730) || (dragon_saddle_id == 731) || (dragon_saddle_id == 732)) { //Oscuro
			sOscuro++;
		} else if ((dragon_saddle_id == 216) || (dragon_saddle_id == 736) || (dragon_saddle_id == 737) || (dragon_saddle_id == 738)) { //Celeste
			sCeleste++;
		} else if ((dragon_saddle_id == 217) || (dragon_saddle_id == 742) || (dragon_saddle_id == 743) || (dragon_saddle_id == 744)) { //Abissale
			sAbissale++;
		} else if ((dragon_saddle_id == 218) || (dragon_saddle_id == 748) || (dragon_saddle_id == 749) || (dragon_saddle_id == 750)) { //Vette
			sVette++;
		}

		if ((dragon_claws_id == 207) || (dragon_claws_id == 715) || (dragon_claws_id == 716) || (dragon_claws_id == 717)) { //Infernale
			sInfernale++;
		} else if ((dragon_claws_id == 208) || (dragon_claws_id == 721) || (dragon_claws_id == 722) || (dragon_claws_id == 723)) { //Glaciale
			sGlaciale++;
		} else if ((dragon_claws_id == 209) || (dragon_claws_id == 727) || (dragon_claws_id == 728) || (dragon_claws_id == 729)) { //Oscuro
			sOscuro++;
		} else if ((dragon_claws_id == 210) || (dragon_claws_id == 733) || (dragon_claws_id == 734) || (dragon_claws_id == 735)) { //Celeste
			sCeleste++;
		} else if ((dragon_claws_id == 211) || (dragon_claws_id == 739) || (dragon_claws_id == 740) || (dragon_claws_id == 741)) { //Abissale
			sAbissale++;
		} else if ((dragon_claws_id == 212) || (dragon_claws_id == 745) || (dragon_claws_id == 746) || (dragon_claws_id == 747)) { //Vette
			sVette++;
		}

		var damage = 0;
		var defence = 0;
		var critical = 0;
		if (sInfernale == 2) {
			damage = 25;
		} else if (sGlaciale == 2) {
			defence = 25;
		} else if (sOscuro == 2) {
			damage = 15;
			defence = 10;
			critical = 5;
		} else if (sCeleste == 2) {
			defence = 15;
			damage = 10;
			critical = 5;
		} else if (sAbissale == 2) {
			damage = 10;
			defence = 5;
			critical = 10;
		} else if (sVette == 2) {
			damage = 5;
			defence = 10;
			critical = 10;
		}

		if (dragon_evolved == 0) {
			if (dragon_level >= 100) {
				dragon_level = 100;
				dragon_exp = 7000;
			}
		} else {
			if (dragon_level >= 200) {
				dragon_level = 200;
				dragon_exp = 14000;
			}
		}

		connection.query('UPDATE ' + target_table + ' SET level = ' + dragon_level + ', exp = ' + dragon_exp + ' WHERE ' + where + ' = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var max_life = (dragon_exp * 20) + 100000;

			connection.query('UPDATE ' + target_table + ' SET total_life = ' + max_life + ', critical = ' + critical + ', damage = ' + (dragon_level + damage) + ', defence = ' + (Math.floor(dragon_level / 2) + defence) + ' WHERE ' + where + ' = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				if ((dragon_level < 15) || (is_dummy == 1)) {
					connection.query('UPDATE ' + target_table + ' SET life = total_life WHERE ' + where + ' = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});
				}
			});
		});
	});
};

bot.onText(/dai tutte/i, function (message) {

	var foodmore = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Nutri Ancora"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var charm_id = rows[0].charm_id;

		connection.query('SELECT * FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_evolved = rows[0].evolved;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_type = rows[0].type;

			if (dragon_evolved == 0) {
				if (dragon_lev >= 100) {
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			} else {
				if (dragon_lev >= 200) {
					bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del drago!", back);
					return;
				}
			}

			connection.query('SELECT COUNT(*) As cnt FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				bot.sendMessage(message.chat.id, "Sei sicuro?", yesno).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text.toLowerCase() == "si") {
							connection.query('SELECT item.name, item.id, inventory.quantity FROM item, inventory WHERE inventory.player_id = ' + player_id + ' AND item.id = inventory.item_id AND item.name LIKE "Pietra%" AND item.rarity = "D"', function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length > 0) {
									var val = 0;
									var qnt = 0;

									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										val += (rows[i].id - 67)*rows[i].quantity;
										qnt += parseInt(rows[i].quantity);
									}

									var lev = Math.floor((dragon_exp + val) / 70);
									if (dragon_evolved == 0) {
										if (lev > 100) {
											bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 100", foodmore);
											return;
										}
									} else {
										if (lev > 200) {
											bot.sendMessage(message.chat.id, "Non puoi dare cosÃ¬ tante pietre al drago, il livello massimo Ã¨ 200", foodmore);
											return;
										}
									}
									lev = lev + 1;

									connection.query('UPDATE inventory, item SET inventory.quantity = 0 WHERE inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND item.rarity = "D" AND item.name LIKE "Pietra%"', function (err, rows, fields) {
										if (err) throw err;
										connection.query('UPDATE dragon SET exp = exp+' + val + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											var plur = "e";
											if (qnt == 1)
												plur = "a";

											bot.sendMessage(message.chat.id, "Hai nutrito il drago con " + qnt + " pietr" + plur + " (" + val + " punti pietra)!", foodmore);
											checkDragon(player_id);
										});
									});

									setAchievement(message.chat.id, player_id, 4, val);
								} else {
									bot.sendMessage(message.chat.id, "Non hai nessuna pietra nello zaino.", back);
									return;
								}
							});
						};
					};
				});
			});
		});
	});
});

bot.onText(/equipaggia drago/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT * FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}
			var dragon_lev = rows[0].level;
			var dragon_exp = rows[0].exp;
			var dragon_evolved = rows[0].evolved;
			var dragon_claws = rows[0].claws;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_arms_id = rows[0].arms_id;
			var dragon_type = rows[0].type;
			var arms_duration = rows[0].arms_duration;

			connection.query('SELECT item.name, item.dragon_power, item.description FROM item, inventory WHERE inventory.player_id = ' + player_id + ' AND item.id = inventory.item_id AND (item.dragon_power <> 0 OR (item.name LIKE "Stemma%" AND rarity = "UE")) AND inventory.quantity > 0', function (err, rows, fields) {
				if (err) throw err;
				var Keys = [];

				if (Object.keys(rows).length > 0) {
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].dragon_power > 0) {
							Keys.push([rows[i].name + " (+" + rows[i].dragon_power + " attacco)"]);
						} else if (rows[i].dragon_power < 0) {
							Keys.push([rows[i].name + " (+" + Math.abs(rows[i].dragon_power) + " difesa)"]);
						} else {
							Keys.push([rows[i].name + " (Efficace solo sulla Vetta)"]);
						}
					}
				}

				Keys.push(["Stacca Artigli"], ["Stacca Sella"], ["Stacca Stemma"]);
				Keys.push(["Torna al drago"]);
				Keys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": Keys
					}
				};

				var kbBack = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Torna al drago"], ["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Cosa vuoi equipaggiare al drago? ðŸ‰", kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if ((answer.text == "Torna al menu") || (answer.text == "Torna al drago")) {
							return;
						} else if (answer.text.indexOf("Stacca") != -1) {
							var necess = 70;
							var lev = ((dragon_exp) / necess).toFixed(2);
							if ((lev == "100") || (lev == "100.00")) {
								lev = "100.00";
							}
							var dPerc = (lev + "").split(".")[1];
							lev = parseFloat(lev) + 1;
							var dLev = (lev + "").split(".")[0];

							var action = "";
							if (answer.text.indexOf("Artigli") != -1) {
								action = "Artigli";
							} else if (answer.text.indexOf("Sella") != -1) {
								action = "Sella";
							} else if (answer.text.indexOf("Stemma") != -1) {
								action = "Stemma";
							} else {
								bot.sendMessage(message.chat.id, "Equipaggiamento da staccare non valido", kbBack);
								return;
							}

							bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									var resp = answer.text;
									if (resp.toLowerCase() != "si") {
										return;
									}

									connection.query('SELECT saddle_id, claws_id, arms_id FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
										if (err) throw err;

										dragon_saddle_id = rows[0].saddle_id;
										dragon_claws_id = rows[0].claws_id;
										dragon_arms_id = rows[0].arms_id;

										if (action == "Sella") {
											if (dragon_saddle_id != 0) {
												addItem(player_id, dragon_saddle_id);
												bot.sendMessage(message.chat.id, "Hai rimosso l'equipaggiamento sella dal drago.", kbBack);

												connection.query('UPDATE dragon SET damage = ' + dLev + ', defence = ' + Math.floor(dLev / 2) + ', saddle_id = 0, saddle = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});

												checkDragon(player_id);
											} else {
												bot.sendMessage(message.chat.id, "La sella non Ã¨ equipaggiata.", kbBack);
											}
										} else if (action == "Artigli") {
											if (dragon_claws_id != 0) {
												addItem(player_id, dragon_claws_id);
												bot.sendMessage(message.chat.id, "Hai rimosso l'equipaggiamento artigli dal drago.", kbBack);

												connection.query('UPDATE dragon SET damage = ' + dLev + ', defence = ' + Math.floor(dLev / 2) + ', claws_id = 0, claws = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});

												checkDragon(player_id);
											} else {
												bot.sendMessage(message.chat.id, "Gli artigli non sono equipaggiati.", kbBack);
											}
										} else if (action == "Stemma") {
											if (dragon_arms_id != 0) {

												if (arms_duration <= 29) {
													bot.sendMessage(message.chat.id, "Potrai rimuovere lo stemma solamente tra " + arms_duration + ' scontri', kbBack);
													return;
												}

												addItem(player_id, dragon_arms_id);
												bot.sendMessage(message.chat.id, "Hai rimosso l'equipaggiamento stemma dal drago.", kbBack);

												connection.query('UPDATE dragon SET arms_id = 0, arms_duration = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});

												checkDragon(player_id);
											} else {
												bot.sendMessage(message.chat.id, "Lo stemma non Ã¨ equipaggiato.", kbBack);
											}
										}
									});
								};
							});
						} else {
							var equip = answer.text;
							var pos = answer.text.indexOf("(");
							if (pos != -1) {
								equip = equip.substr(0, pos - 1);
							}

							connection.query('SELECT item.id, item.dragon_power FROM item, inventory WHERE inventory.player_id = ' + player_id + ' AND item.id = inventory.item_id AND (item.dragon_power <> 0 OR (item.name LIKE "Stemma%" AND rarity = "UE")) AND name = "' + equip + '" AND inventory.quantity > 0', function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0) {
									bot.sendMessage(message.chat.id, "L'oggetto specificato non Ã¨ consentito", kbBack);
									return;
								}

								bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "si") {
											var itemid = rows[0].id;
											var dragon_power = rows[0].dragon_power;

											if (getItemCnt(player_id, itemid) == 0) {
												bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato.", kbBack);
												return;
											}

											if (dragon_power == 0) {
												connection.query('SELECT arms_id FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													if (rows[0].arms_id != 0) {
														if (arms_duration <= 29) {
															bot.sendMessage(message.chat.id, "Potrai sostituire lo stemma solamente tra " + arms_duration + ' scontri', kbBack);
															return;
														}
														addItem(player_id, rows[0].arms_id);
														bot.sendMessage(message.chat.id, "Lo stemma precedentemente equipaggiato Ã¨ tornato nell'inventario");
													}

													delItem(player_id, itemid, 1);

													var dur = 30;

													connection.query('UPDATE dragon SET arms_id = ' + itemid + ', arms_duration = ' + dur + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Stemma equipaggiato! DurerÃ  30 scontri, dopo il primo scontro non potrai rimuoverlo fino a che non si romperÃ ", kbBack);
													});
												});
												return;
											}

											var type = ["Infernal", "Oscur", "Glacial", "Celest", "Abissal", "delle Vett"];
											var this_type = "";

											if (dragon_type == "Infernale") {
												this_type = "Infernal";
											} else if (dragon_type == "dei Ghiacci") {
												this_type = "Glacial";
											} else if (dragon_type == "dell'OscuritÃ ") {
												this_type = "Oscur";
											} else if (dragon_type == "dei Cieli") {
												this_type = "Celest";
											} else if (dragon_type == "dei Mari") {
												this_type = "Abissal";
											} else if (dragon_type == "delle Montagne") {
												this_type = "delle Vett";
											}

											var isSet = 0;
											var setText = "";

											if (searchArrayInString(equip, type) != -1) {
												if (equip.indexOf(this_type) != -1) {
													isSet = 1;
													setText = "\nQuesto oggetto fa parte di un set, equipaggia anche l'altro per ottenere ulteriori benefici";
												} else {
													bot.sendMessage(message.chat.id, "Questo oggetto puÃ² solo essere equipaggiato al tipo del drago corrispondente", back);
													return;
												}
											}

											if (dragon_power > 0) {
												connection.query('SELECT claws_id FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													if (rows[0].claws_id != 0) {
														addItem(player_id, rows[0].claws_id);
														bot.sendMessage(message.chat.id, "Gli artigli precedentemente equipaggiati sono tornati nell'inventario");
													}

													var damage = 0;
													var defence = 0;
													var critical = 0;
													if (isSet == 1) {
														if ((dragon_saddle_id == 213) || (dragon_saddle_id == 718) || (dragon_saddle_id == 719) || (dragon_saddle_id == 720)) { //Infernale
															damage = 25;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno!", kbBack);
														} else if ((dragon_saddle_id == 214) || (dragon_saddle_id == 724) || (dragon_saddle_id == 725) || (dragon_saddle_id == 726)) { //Glaciale
															defence = 25;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + defence + " difesa!", kbBack);
														} else if ((dragon_saddle_id == 215) || (dragon_saddle_id == 730) || (dragon_saddle_id == 731) || (dragon_saddle_id == 732)) { //Oscuro
															damage = 15;
															defence = 10;
															critical = 5;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defence + " difesa e " + critical + "% critico!", kbBack);
														} else if ((dragon_saddle_id == 216) || (dragon_saddle_id == 736) || (dragon_saddle_id == 737) || (dragon_saddle_id == 738)) { //Celeste
															defence = 15;
															damage = 10;
															critical = 5;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defence + " difesa e " + critical + "% critico!", kbBack);
														} else if ((dragon_saddle_id == 217) || (dragon_saddle_id == 742) || (dragon_saddle_id == 743) || (dragon_saddle_id == 744)) { //Abissale
															damage = 10;
															defence = 5;
															critical = 10;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno, +" + defence + " difesa e " + critical + "% critico!", kbBack);
														} else if ((dragon_saddle_id == 218) || (dragon_saddle_id == 748) || (dragon_saddle_id == 749) || (dragon_saddle_id == 750)) { //Vette
															damage = 5;
															defence = 10;
															critical = 10;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defence + " difesa e " + critical + "% critico!", kbBack);
														}
													}

													delItem(player_id, itemid, 1);

													connection.query('UPDATE dragon SET claws_id = ' + itemid + ', critical = ' + critical + ', defence = defence + ' + defence + ', damage = damage + ' + damage + ', claws = ' + dragon_power + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Artigli equipaggiati!" + setText, kbBack);
														checkDragon(player_id);
													});
												});
											} else if (dragon_power < 0) {
												connection.query('SELECT saddle_id FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													if (rows[0].saddle_id != 0) {
														addItem(player_id, rows[0].saddle_id);
														bot.sendMessage(message.chat.id, "La sella precedentemente equipaggiata Ã¨ tornata nell'inventario");
													}
													var damage = 0;
													var defence = 0;
													var critical = 0;

													if (isSet == 1) {
														if ((dragon_claws_id == 207) || (dragon_claws_id == 715) || (dragon_claws_id == 716) || (dragon_claws_id == 717)) { //Infernale
															damage = 25;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno!", kbBack);
														} else if ((dragon_claws_id == 208) || (dragon_claws_id == 721) || (dragon_claws_id == 722) || (dragon_claws_id == 723)) { //Glaciale
															defence = 25;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + defence + " difesa!", kbBack);
														} else if ((dragon_claws_id == 209) || (dragon_claws_id == 727) || (dragon_claws_id == 728) || (dragon_claws_id == 729)) { //Oscuro
															damage = 15;
															defence = 10;
															critical = 5;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defence + " difesa e " + critical + "% critico!", kbBack);
														} else if ((dragon_claws_id == 210) || (dragon_claws_id == 733) || (dragon_claws_id == 734) || (dragon_claws_id == 735)) { //Celeste
															defence = 15;
															damage = 10;
															critical = 5;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defence + " difesa e " + critical + "% critico!", kbBack);
														} else if ((dragon_claws_id == 211) || (dragon_claws_id == 739) || (dragon_claws_id == 740) || (dragon_claws_id == 741)) { //Abissale
															damage = 10;
															defence = 5;
															critical = 10;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno, +" + defence + " difesa e " + critical + "% critico!", kbBack);
														} else if ((dragon_claws_id == 212) || (dragon_claws_id == 745) || (dragon_claws_id == 746) || (dragon_claws_id == 747)) { //Vette
															damage = 5;
															defence = 10;
															critical = 10;
															bot.sendMessage(message.chat.id, "Set equipaggiato! Bonus: +" + damage + " danno e +" + defence + " difesa e " + critical + "% critico!", kbBack);
														}
													}

													delItem(player_id, itemid, 1);
													connection.query('UPDATE dragon SET damage = damage + ' + damage + ', critical = ' + critical + ', defence = defence + ' + defence + ', saddle_id = ' + itemid + ', saddle = ' + Math.abs(dragon_power) + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Sella equipaggiata!" + setText, kbBack);
														checkDragon(player_id);
													});
												});
											};
										};
									};
								});
							});
						};
					};
				});
			});
		});
	});
});

bot.onText(/^\/pagateam (.+)|^\/pagateam/i, function (message, match) {

	if (!checkSpam(message)) {
		return;
	}

	var syntax = "Sintassi: '/pagateam monete' per inviare una certa quantitÃ  di monete ad ogni compagno di team, tranne te stesso";
	var text = "";

	if (message.text.indexOf(" ") != -1) {
		text = message.text.substring(message.text.indexOf(" ") + 1, message.text.lenght);
	} else {
		bot.sendMessage(message.from.id, syntax);
		return;
	}

	var elements = text.split(",");

	if (Object.keys(elements).length != 1) {
		bot.sendMessage(message.from.id, "Numero parametri errato: " + Object.keys(elements).length + " su 1\n" + syntax);
		return;
	}

	var price = parseInt(elements[0].replace(/[^\w\s]/gi, '').trim());

	if (isNaN(price)) {
		bot.sendMessage(message.from.id, "Il parametro prezzo non Ã¨ valido");
		return;
	}
	if (price <= 0) {
		bot.sendMessage(message.from.id, "Il parametro prezzo deve essere maggiore di zero");
		return;
	}
	if (price > 100000000) {
		bot.sendMessage(message.from.id, "Il parametro prezzo non puÃ² essere piÃ¹ alto di 100kk");
		return;
	}

	connection.query('SELECT id, money FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var money = rows[0].money;

		connection.query('SELECT team_id FROM team_player WHERE player_id = ' + rows[0].id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.from.id, "Devi essere in un team per utilizzare questo comando");
				return;
			}

			connection.query('SELECT nickname, player_id, chat_id FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + rows[0].team_id + ' AND player_id != ' + player_id + ' AND suspended = 0', function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.from.id, "Non ci sono compagni validi a cui inviare monete");
					return;
				}

				var total_price = (price * Object.keys(rows).length);
				if (money < total_price) {
					bot.sendMessage(message.from.id, "Non hai abbastanza monete, te ne servono " + formatNumber(total_price));
					return;
				}

				var d2 = new Date();
				var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					connection.query('UPDATE player SET money = money+' + price + ' WHERE id = ' + rows[i].player_id, function (err, rows, fields) {
						if (err) throw err;
					});
					bot.sendMessage(rows[i].chat_id, "Hai ricevuto <b>" + price + " Â§</b> da " + message.from.username + " del tuo team!", html);

					connection.query('INSERT INTO pay_history (from_id, to_id, price, hist_time) VALUES (' + player_id + ',' + rows[i].player_id + ',' + price + ',"' + long_date + '")', function (err, rows, fields) {
						if (err) throw err;
					});
				}

				connection.query('UPDATE player SET money = money-' + total_price + ' WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Hai inviato correttamente *" + formatNumber(total_price) + " Â§* al team!", mark);
				});
			});
		});
	});
});

bot.onText(/vette dei draghi|vetta|^vette|^interrompi$/i, function (message) {

	if (message.text.toLowerCase().indexOf("vetta delle anime") != -1) {
		return;
	}

	if (Object.keys(message.text).length > 30) {
		return;
	}

	connection.query('SELECT id, account_id, reborn, top_first, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var top_first = rows[0].top_first;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		if (reborn < 2) {
			bot.sendMessage(message.chat.id, "Devi raggiungere almeno la Rinascita 1 (Livello 100) per utilizzare questa funzione! Dopo di che potrai combattere in incredibili arene comandando il tuo drago! Ma solo quando sia tu che lui avrete abbastanza esperienza per farlo. Forza!", back);
			return;
		}

		connection.query('SELECT * FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}

			var dragon_id = rows[0].id;
			var dragon_name = rows[0].name;
			var my_dragon_type = rows[0].type;
			var dragon_level = rows[0].level;
			var dragon_life = rows[0].life;
			var dragon_total_life = rows[0].total_life;
			var dragon_arms_id = rows[0].arms_id;
			var sleep_time = rows[0].sleep_time_end;
			var dragon_status = "In salute";

			if (dragon_life <= 0)
				dragon_status = "Esausto";

			if (rows[0].sleep_h > 0) {
				var d = new Date(sleep_time);
				var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());
				dragon_status = "Dorme fino alle " + short_date;
			}

			if (dragon_level < 15) {
				bot.sendMessage(message.chat.id, "E' richiesto almeno il livello 15 del drago per partecipare.", back);
				return;
			}

			if (player_id != 1){
				if (checkDragonTopOn == 0) {
					bot.sendMessage(message.chat.id, "\nProssima stagione: 4 aprile 12:00 - 11 aprile 12:00\nSe hai partecipato alla stagione precedente, riceverai i premi a breve!", back_html);
					return;
				}
			}

			var kb2 = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Entra nella Vetta'], ['Torna al menu']]
				}
			};

			var kbBack = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Torna alla vetta'], ['Torna al menu']]
				}
			};

			var kbBack_html = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Torna alla vetta'], ['Torna al menu']]
				}
			};

			var kbCombat = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Entra in combattimento'], ['Torna al menu']]
				}
			};

			var kbYesNo = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Si'], ['Torna alla vetta']]
				}
			};

			var kbWake = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Si'], ['Torna alla vetta']]
				}
			};

			connection.query('SELECT id, top_id, enemy_dragon_id, wait_time, no_match_time, is_dummy FROM dragon_top_status WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var finishD = new Date("2018-04-11 12:00:00");
				var finish_date = addZero(finishD.getHours()) + ':' + addZero(finishD.getMinutes()) + " del " + addZero(finishD.getDate()) + "/" + addZero(finishD.getMonth() + 1) + "/" + finishD.getFullYear();

				if (Object.keys(rows).length == 0) {
					connection.query('INSERT INTO dragon_top_status (player_id, dragon_id) VALUES (' + player_id + ',' + dragon_id + ')', function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nelle <b>Vette dei Draghi</b> ðŸ²!\nIn questo luoghi dovrai sottoporre il tuo <i>" + dragon_name + "</i> all'ardua sfida di raggiungere le cime dei monti piÃ¹ alti di Lootia! Durante questa sfida incontrerai altri draghi, dovrai sfidarli ed essere un bravo domatore per salire fino alla vetta. Le battaglie si svolgono in diversi Monti, tutti iniziano dal primo e man mano che si ottengono vittorie si passa al successivo!\nRicorda che quando il drago combatte, non ti potrÃ  aiutare nelle battaglie al di fuori della vetta.\n\n<b>Funzionamento</b>:\n\n- Il drago da sfidare verrÃ  scelto casualmente in base al Monte in cui si viene inseriti\n- Una volta sconfitto si ottiene 1 Ã o piÃ¹, se si viene sconfitti lo si perde\n- Al termine della giornata per avanzare di Monte Ã¨ necessario raggiungere almeno 12 Ã, mentre se ne possiedi 2 o meno tornerai al precedente, inoltre spostandoti di monte le Ã si resettano\n- Ogni mossa consuma un certo numero di Scaglie âšœï¸ e ne ottieni una alla fine di ogni turno, per un massimo di 5, puoi ottenerne una anche solo Saltando il turno\n- Riceverai un premio in base al posizionamento ottenuto alla fine della stagione.\n- Al primo accesso otterrai Ã in base al livello del tuo drago\n\nLa stagione attuale scadrÃ  alle " + finish_date, kb2);
					});
				} else {
					var top_id = rows[0].top_id;
					var enemy_dragon_id = rows[0].enemy_dragon_id;
					var wait_time = rows[0].wait_time;
					var no_match_time = rows[0].no_match_time;
					var is_dummy = rows[0].is_dummy;

					if (enemy_dragon_id != null) {
						bot.sendMessage(message.chat.id, "Stai combattendo contro un drago!", kbCombat);
						return;
					}

					if (top_id == 0) {
						var top_id = 1;
						connection.query('SELECT name FROM dragon_top_list WHERE id = ' + top_id, function (err, rows, fields) {
							if (err) throw err;
							var name = rows[0].name;

							var d = new Date();
							d.setMinutes(d.getMinutes() + 5);
							var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

							connection.query('UPDATE dragon_top_status SET top_id = ' + top_id + ', no_match_time = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;

								var start_rank = Math.floor(dragon_level / 25);

								if (top_first == 1) {
									start_rank = 0;
								} else {
									connection.query('UPDATE player SET top_first = 1 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
									});
								}

								connection.query('INSERT INTO dragon_top_rank (player_id, top_id, dragon_id, rank) VALUES (' + player_id + ',' + top_id + ',' + dragon_id + ',' + start_rank + ')', function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Sei stato assegnato al monte di partenza, il *" + name + "*!", kbBack);
								});
							});
						});
					} else {
						connection.query('SELECT combat, rank FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							var inCombat = 0;
							if (rows[0].combat == 1) {
								inCombat = 1;
							}

							var my_dragon_rank = rows[0].rank;

							connection.query('SELECT R.id, R.dragon_id, R.rank, D.name, D.type FROM dragon_top_rank R, dragon D, player P WHERE P.id = D.player_id AND R.dragon_id = D.id AND top_id = ' + top_id + ' ORDER BY rank DESC, D.level ASC, P.id ASC', function (err, rows, fields) {
								if (err) throw err;

								var range = 5;
								var leaderboard = [];
								var dragon_names = [];
								var dragon_type = [];
								var dragon_rank = [];
								var mypos = 0;
								var text = "";

								var dragon_num = Object.keys(rows).length;

								for (var i = 0, len = dragon_num; i < len; i++) {
									leaderboard.push(rows[i].id);
									dragon_names.push(rows[i].name);
									dragon_type.push(rows[i].type);
									dragon_rank.push(rows[i].rank);
									if (dragon_id == rows[i].dragon_id) {
										mypos = i;
									}
								}
								for (var i = (mypos - range); i < (mypos + (range + 1)); i++) {
									if (dragon_names[i] != undefined) {
										if (i == mypos) {
											text += (i + 1) + "Â° <b>" + dragon_names[i] + " " + dragon_type[i] + "</b> " + dragonSym(dragon_type[i]) + " (" + dragon_rank[i] + " Ã)\n";
										} else {
											text += (i + 1) + "Â° " + dragon_names[i] + " " + dragon_type[i] + " " + dragonSym(dragon_type[i]) + " (" + dragon_rank[i] + " Ã)\n";
										}
									}
								}

								connection.query('SELECT name, pnt FROM dragon_top_list WHERE id = ' + top_id, function (err, rows, fields) {
									if (err) throw err;

									var kb = {
										parse_mode: "HTML",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": [['Combatti ðŸ‰'], ['Riposa ðŸ’¤', 'Abbandona ðŸš«'], ['Risorse ðŸµ', 'Log ðŸ“ƒ'], ['Torna al menu']]
										}
									};
									var kbSleep = {
										parse_mode: "HTML",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": [['10', '20', '30', '40'], ['50', '60', '70', '80'], ['90', '100'], ['Torna alla vetta'], ['Torna al menu']]
										}
									};

									var arena = rows[0].name;
									var arenaPnt = rows[0].pnt;

									connection.query('SELECT D.name, D.id, D.arms_id, D.type, D.level, D.life, D.total_life, S.battle_time, P.chat_id, P.id As player_id, R.rank, R.top_id FROM dragon D, dragon_top_status S, player P, dragon_top_rank R WHERE R.player_id = P.id AND P.id = D.player_id AND D.id = S.dragon_id AND S.enemy_dragon_id = ' + dragon_id, function (err, rows, fields) {
										if (err) throw err;
										var inCombatText = "";
										var enemy_dragon_id = null;
										var enemy_dragon_life = 0;
										var enemy_dragon_total_life = 0;
										var enemy_dragon_name = "";
										var enemy_dragon_type = "";
										var enemy_dragon_level = 0;
										var enemy_dragon_arms_id = 0;
										var enemy_dragon_rank = 0;
										var enemy_top_id = 0;
										var player_id2 = 0;
										var chat_id2 = 0;
										if ((inCombat == 1) && (Object.keys(rows).length > 0)) {
											var d = new Date(rows[0].battle_time);
											var battle_time = addZero(d.getHours()) + ':' + addZero(d.getMinutes());
											enemy_dragon_id = rows[0].id;
											enemy_dragon_life = rows[0].life;
											enemy_dragon_total_life = rows[0].total_life;
											enemy_dragon_name = rows[0].name;
											enemy_dragon_type = rows[0].type;
											enemy_dragon_level = rows[0].level;
											enemy_dragon_arms_id = rows[0].arms_id;
											chat_id2 = rows[0].chat_id;
											player_id2 = rows[0].player_id;
											enemy_dragon_rank = rows[0].rank;
											enemy_top_id = rows[0].top_id;
											inCombatText = "\nIl tuo drago Ã¨ in combattimento nell'arena contro " + rows[0].name + ", scadrÃ  alle " + battle_time + "!";

											kb = {
												parse_mode: "HTML",
												reply_markup: {
													resize_keyboard: true,
													//one_time_keyboard: true,
													"keyboard": [['Risorse ðŸµ', 'Scruta ðŸ”Ž'], ['Rinuncia ðŸš«', 'Log ðŸ“ƒ'], ['Torna al menu']]
												}
											};
										}

										var status = "<i>" + dragon_name + " " + my_dragon_type + " " + dragonSym(my_dragon_type) +
											"</i>\nSalute: |" + calcDragonLife(dragon_life, dragon_total_life) + "| " + formatNumber(dragon_life) + " ðŸ”º\nStato: " + dragon_status + "\n";

										var toptext = "";
										if (top_id == 1)
											toptext = arenaPnt + " Ã o piÃ¹ per salire";
										else if (top_id == 5)
											toptext = "2 Ã o meno per scendere, nessun limite massimo";
										else
											toptext = arenaPnt + " Ã o piÃ¹ per salire, 2 Ã o meno per scendere";

										bot.sendMessage(message.chat.id, status + "\nClassifica attuale <b>" + arena + "</b>\n(" + dragon_num + " draghi,  " + toptext + ")\n\n" + text + inCombatText + "\nLa stagione attuale scadrÃ  alle " + finish_date + "\nI Monti verranno aggiornati alle 3:00 di ogni notte", kb).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text.indexOf("Combatti") != -1) {
													connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;

														if (rows[0].combat == 1) {
															bot.sendMessage(message.chat.id, "Il drago Ã¨ giÃ  impegnato in uno scontro!", kbBack);
															return;
														}

														var d = new Date();
														var err = 0;
														if (d.getHours() == 2) {
															if (d.getMinutes() > 30)
																err = 1;
														}
														if ((d.getHours() >= 3) && (d.getHours() < 9))
															err = 1;
														if (err == 1) {
															bot.sendMessage(message.chat.id, "Non puoi avviare scontri tra le 2.30 e le 9.00!", kbBack);
															return;
														}

														bot.sendMessage(message.chat.id, "Cercare un drago avversario? Durante la battaglia il tuo drago non potrÃ  accompagnarti nelle tue avventure", kbYesNo).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if (answer.text.toLowerCase() == "si") {

																	var now = new Date();

																	if (finishD < now) {
																		bot.sendMessage(message.chat.id, "La stagione Ã¨ terminata! A breve riceverai il premio finale ma nel frattempo non puoi cercare altre battaglie", kbBack);
																		return;
																	}

																	connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;

																		if (rows[0].combat == 1) {
																			bot.sendMessage(message.chat.id, "Il drago Ã¨ stato appena sfidato!", kbBack);
																			return;
																		}

																		connection.query('SELECT sleep_time_end FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;

																			if (rows[0].sleep_time_end != null) {
																				bot.sendMessage(message.chat.id, "Il tuo drago sta riposando...", kbBack);
																				return;
																			}

																			connection.query('SELECT wait_time, no_match_time FROM dragon_top_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																				if (err) throw err;

																				if (rows[0].wait_time != null) {
																					var d = new Date(rows[0].wait_time);
																					var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());
																					bot.sendMessage(message.chat.id, "Il tuo drago ha appena concluso uno scontro, attendi fino alle " + short_date, kbBack);
																					return;
																				}

																				if (rows[0].no_match_time != null) {
																					connection.query('UPDATE dragon_top_status SET no_match_time = NULL WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																				}

																				var kbSleep = {
																					parse_mode: "HTML",
																					reply_markup: {
																						resize_keyboard: true,
																						//one_time_keyboard: true,
																						"keyboard": [['Riposa'], ["Torna alla vetta"]]
																					}
																				};

																				if (dragon_life <= 0) {
																					bot.sendMessage(message.chat.id, "Il tuo drago Ã¨ esausto, fallo riposare per tornare a combattere!", kbSleep);
																					return;
																				}

																				var kbStop = {
																					parse_mode: "HTML",
																					reply_markup: {
																						resize_keyboard: true,
																						//one_time_keyboard: true,
																						"keyboard": [['Interrompi']]
																					}
																				};

																				connection.query('SELECT COUNT(*) As cnt FROM player, dragon_top_rank d WHERE player.id = d.player_id AND status > 0 AND d.top_id = ' + top_id, function (err, rows, fields) {
																					if (err) throw err;

																					var cnt = rows[0].cnt;
																					connection.query('UPDATE player SET status = IFNULL((SELECT * FROM (SELECT MAX(status) As mx FROM player, dragon_top_rank d WHERE player.id = d.player_id AND status IS NOT NULL AND d.top_id = ' + top_id + ') As a),0)+1 WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;

																						var queue = cnt + " draghi in coda";
																						if (cnt == 1)
																							queue = "1 drago in coda";
																						else if (cnt == 0)
																							queue = "Nessun drago in coda";

																						bot.sendMessage(message.chat.id, "Ricerca avversario in corso... Scrivendo qualsiasi cosa la ricerca sarÃ  interrotta o scadrÃ  tra 10 minuti. (" + queue + ")", kbStop);
																					});
																				});
																			});
																		});
																	});
																};
															};
														});
													});
												} else if (answer.text == "ricarica") {
													if (player_id != 1)
														return;
													connection.query('UPDATE dragon SET life = total_life WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Ricaricato!", kbBack);
													});
												} else if (answer.text.indexOf("Rinuncia") != -1) {

													// Solo se in difesa

													if (inCombat == 0) {
														bot.sendMessage(message.chat.id, "Puoi rinunciare ad uno scontro solo mentre sei in combattimento", kbBack);
														return;
													}

													bot.sendMessage(message.chat.id, "Sei veramente sicuro di voler abbandonare la battaglia? VerrÃ  conteggiata come persa.", kbYesNo).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text.toLowerCase() == "si") {
																connection.query('SELECT combat, rank FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	if (rows[0].combat == 0) {
																		bot.sendMessage(message.chat.id, "Puoi rinunciare ad uno scontro solo mentre sei in combattimento", kbBack);
																		return;
																	}

																	var d = new Date();
																	d.setMinutes(d.getMinutes() + 5);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																	var d = new Date();
																	d.setMinutes(d.getMinutes() + 15);
																	var long_date2 = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																	connection.query('UPDATE dragon_top_status SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date + '" WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																		connection.query('UPDATE dragon_top_status SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date2 + '" WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																				if (err) throw err;
																				connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																					if (err) throw err;

																					var chest = 1;

																					if (enemy_dragon_level > (dragon_level + 50)) {
																						chest = 0;
																					}

																					if (enemy_dragon_arms_id == 714) {
																						var randS = Math.random() * 100;
																						if (randS < 50) {
																							chest++;
																						}
																					}

																					if (my_dragon_rank == 0){		// exploit
																						chest = 0;
																					}

																					var extra = "";
																					if (chest == 1) {
																						extra = " uno Scrigno Scaglia!";

																						addChest(player_id2, 9);
																					} else if (chest > 1) {
																						extra = " " + chest + " Scrigni Scaglia!";
																						addChest(player_id2, 9, chest);
																					}

																					if (my_dragon_rank > 0) {
																						connection.query('UPDATE dragon_top_rank SET rank = rank-1 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																						var win_rank = 0;
																						if (enemy_top_id < 5){
																							if (enemy_dragon_rank + 1 <= rank_cap)
																								win_rank = 1;
																						}else{
																							win_rank = 1;
																						}

																						connection.query('UPDATE dragon_top_rank SET rank = rank+' + win_rank + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																							if (err) throw err;
																						});

																						bot.sendMessage(message.chat.id, "Hai abbandonato la battaglia e hai perso 1 Ã!", kbBack);

																						if (extra != "")
																							extra = " e" + extra;
																						bot.sendMessage(chat_id2, "Il tuo sfidante " + dragon_name + " ha abbandonato lo scontro, hai ottenuto " + win_rank + " Ã" + extra + "!");
																					} else {
																						bot.sendMessage(message.chat.id, "Hai abbandonato la battaglia!", kbBack);

																						if (extra != "")
																							extra = " e hai ricevuto" + extra;
																						bot.sendMessage(chat_id2, "Il tuo sfidante " + dragon_name + " ha abbandonato lo scontro" + extra + "!");
																					}

																					var d = new Date();
																					var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																					connection.query('INSERT INTO dragon_top_log (player_id, dragon_id, enemy_player_id, enemy_dragon_id, time, win, note) VALUES (' + player_id + ',' + dragon_id + ',' + player_id2 + ',' + enemy_dragon_id + ',"' + long_date + '",2,"Rinuncia")', function (err, rows, fields) {
																						if (err) throw err;
																					});
																				});
																			});
																		});
																	});
																});
															};
														};
													});
												} else if (answer.text.indexOf("Scruta") != -1) {
													if (inCombat == 0) {
														bot.sendMessage(message.chat.id, "Puoi visualizzare info sul drago avversario solo mentre sei in combattimento", kbBack);
														return;
													}
													bot.sendMessage(message.chat.id, "<b>Informazioni sul drago avversario:</b>\nSalute: " + calcDragonLife(enemy_dragon_life, enemy_dragon_total_life) + "\nNome: " + enemy_dragon_name + " " + enemy_dragon_type + " " + dragonSym(enemy_dragon_type) + "\nLivello: " + enemy_dragon_level, kbBack_html);
													return;
												} else if (answer.text.indexOf("Abbandona") != -1) {

													if (inCombat == 1) {
														bot.sendMessage(message.chat.id, "Non puoi abbandonare la vetta mentre il tuo drago Ã¨ impegnato in uno scontro", kbBack);
														return;
													}

													bot.sendMessage(message.chat.id, "Sei veramente sicuro di voler abbandonare? Al tuo rientro sarai costretto a ricominciare", kbYesNo).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text.toLowerCase() == "si") {

																connection.query('SELECT combat, rank FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;

																	if (rows[0].combat == 1) {
																		bot.sendMessage(message.chat.id, "Non puoi abbandonare la vetta mentre il tuo drago Ã¨ impegnato in uno scontro", kbBack);
																		return;
																	}

																	connection.query('DELETE FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai abbandonato la vetta", kbBack);
																	});

																	connection.query('UPDATE dragon_top_status SET top_id = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																});
															};
														};
													});
												} else if (answer.text.indexOf("Log") != -1) {
													connection.query('SELECT L.id, P1.nickname As nick1, P2.nickname As nick2, D1.name As dragon1, D2.name As dragon2, D1.type As type1, D2.type As type2, win, note, time FROM dragon_top_log L INNER JOIN player P1 ON P1.id = L.player_id INNER JOIN player P2 ON P2.id = L.enemy_player_id INNER JOIN dragon D1 ON D1.id = L.dragon_id INNER JOIN dragon D2 ON D2.id = L.enemy_dragon_id WHERE (dragon_id = ' + dragon_id + ' OR enemy_dragon_id = ' + dragon_id + ') ORDER BY L.id DESC LIMIT 20', function (err, rows, fields) {
														if (err) throw err;

														if (Object.keys(rows).length > 0) {
															var text = "";
															for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																if (rows[i].win == 1) {
																	rows[i].dragon1 = "<b>" + rows[i].dragon1 + " " + rows[i].type1 + " " + dragonSym(rows[i].type1) + "</b>";
																	rows[i].dragon2 = rows[i].dragon2 + " " + rows[i].type2 + " " + dragonSym(rows[i].type2);
																} else {
																	rows[i].dragon2 = "<b>" + rows[i].dragon2 + " " + rows[i].type2 + " " + dragonSym(rows[i].type2) + "</b>";
																	rows[i].dragon1 = rows[i].dragon1 + " " + rows[i].type1 + " " + dragonSym(rows[i].type1);
																}

																var d = new Date(rows[i].time);
																var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

																text += rows[i].dragon1 + " vs " + rows[i].dragon2 + " (" + rows[i].note + " alle " + short_date + ")\n";
															}
															bot.sendMessage(message.chat.id, "Ultime 20 battaglie:\n\n" + text, kbBack_html);
														} else {
															bot.sendMessage(message.chat.id, "Non hai ancora completato alcuna battaglia!", kbBack);
														}
													});
												}
											};
										});
									});
								});
							});
						});
					};
				};
			});
		});
	});
});

bot.onText(/riposa/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;

		if (reborn < 2) {
			bot.sendMessage(message.chat.id, "Accedi alle Vette dei Draghi per sbloccare questa funzione!", back);
			return;
		}

		connection.query('SELECT id, sleep_time_end, life, total_life FROM dragon WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}

			var dragon_id = rows[0].id;
			var sleep_time = rows[0].sleep_time_end;
			var dragon_life = rows[0].life;
			var dragon_total_life = rows[0].total_life;

			var kbBack = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Torna alla vetta'], ['Torna al drago'], ['Torna al menu']]
				}
			};

			var kbSleep = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['10', '20', '30', '40'], ['50', '60', '70', '80'], ['90', '100'], ['Torna alla vetta'], ['Torna al drago'], ['Torna al menu']]
				}
			};

			connection.query('SELECT id, top_id, enemy_dragon_id, wait_time FROM dragon_top_status WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0) {
					if (rows[0].enemy_dragon_id != null) {
						bot.sendMessage(message.chat.id, "Il drago Ã¨ impegnato in uno scontro, non puÃ² riposarsi", kbBack);
						return;
					}
				}

				connection.query('SELECT id FROM dragon_top_status WHERE enemy_dragon_id = ' + dragon_id, function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length > 0) {
						bot.sendMessage(message.chat.id, "Il drago Ã¨ impegnato in uno scontro, non puÃ² riposarsi", kbBack);
						return;
					}

					if (sleep_time != null) {
						bot.sendMessage(message.chat.id, "Il tuo drago sta riposando...", kbBack);
						return;
					}

					if (dragon_life >= dragon_total_life) {
						bot.sendMessage(message.chat.id, "Il tuo drago Ã¨ in piena salute, non serve riposare", kbBack);
						return;
					}

					var full = 100 - (dragon_life / dragon_total_life * 100);
					full = Math.ceil(full / 10) * 10;

					bot.sendMessage(message.chat.id, "Puoi far riposare il tuo drago per fargli recuperare salute, recupererÃ  il 10% per ogni 10 min riposo, per quanti minuti vuoi farlo riposare? Per tornare a piena salute dovrÃ  riposare " + full + " minuti", kbSleep).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text == "Torna al menu") {
								return;
							}
							var h = parseInt(answer.text);
							if (isNaN(h) || (h < 10) || (h > 100)) {
								bot.sendMessage(message.chat.id, "Valore non valido: minimo 10 minuti, massimo 100", kbBack);
								return;
							}

							if (h > full) {
								bot.sendMessage(message.chat.id, "Non puoi riposare piÃ¹ del necessario, massimo " + full + " minuti", kbBack);
								return;
							}

							var d = new Date();
							d.setMinutes(d.getMinutes() + h);
							var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
							var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

							connection.query('UPDATE dragon SET sleep_h = ' + h + ', sleep_time_end = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Il tuo drago si riposerÃ  fino alle " + short_date, kbBack);
							});
						};
					});
				});
			});
		});
	});
});

function calcDragonLife(dragon_life, dragon_total_life) {
	var perc_life = "";
	var perc = Math.round((100 / dragon_total_life * dragon_life) / 10);
	for (i = 0; i < perc; i++) {
		perc_life += "â– ";
	}
	var perc2 = 10 - perc;
	for (i = 0; i < perc2; i++) {
		perc_life += "â–¡";
	}
	return perc_life;
}

function dragonToId(type) {
	if (type == "dei Mari") {
		dragon_type = 1;
	} else if (type == "delle Montagne") {
		dragon_type = 2;
	} else if (type == "Infernale") {
		dragon_type = 3;
	} else if (type == "dell'OscuritÃ ") {
		dragon_type = 4;
	} else if (type == "dei Cieli") {
		dragon_type = 5;
	} else if (type == "dei Ghiacci") {
		dragon_type = 6;
	}
	return dragon_type;
}

function typeWeak(type1, type2, isMove = 0, enemy = 0) {
	var weak = [];

	weak["myDmg"] = 0;
	weak["enemyDmg"] = 0;

	if ((type1 == 1) && (type2 == 3)) { // Abissale > Infernale
		if (enemy == 0)
			weak["myDmg"] = 0.1;
		else
			weak["enemyDmg"] = 0.1;
	}
	if ((type1 == 3) && (type2 == 6)) { // Infernale > Glaciale
		if (enemy == 0)
			weak["myDmg"] = 0.1;
		else
			weak["enemyDmg"] = 0.1;
	}
	if ((type1 == 6) && (type2 == 5)) { // Glaciale > Celeste
		if (enemy == 0)
			weak["myDmg"] = 0.1;
		else
			weak["enemyDmg"] = 0.1;
	}
	if ((type1 == 5) && (type2 == 4)) { // Celeste > OscuritÃ 
		if (enemy == 0)
			weak["myDmg"] = 0.1;
		else
			weak["enemyDmg"] = 0.1;
	}
	if ((type1 == 4) && (type2 == 2)) { // OscuritÃ  > Vette
		if (enemy == 0)
			weak["myDmg"] = 0.1;
		else
			weak["enemyDmg"] = 0.1;
	}
	if ((type1 == 2) && (type2 == 1)) { // Vette > Abissale
		if (enemy == 0)
			weak["myDmg"] = 0.1;
		else
			weak["enemyDmg"] = 0.1;
	}

	if (enemy == 0) {
		if (weak["myDmg"] > 0) {
			if (isMove == 1)
				weak["myDmg"] = 0.3;
		}
	} else {
		if (weak["enemyDmg"] > 0) {
			if (isMove == 1)
				weak["enemyDmg"] = 0.3;
		}
	}

	return weak;
}

bot.onText(/^Risorse/i, function (message) {
	connection.query('SELECT account_id, id, reborn, charm_id, holiday FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var charm_id = rows[0].charm_id;

		var kbBack = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [['Torna alla vetta'], ['Torna al menu']]
			}
		};

		var kbNext = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [['Continua a Combattere'], ['Torna alla vetta'], ['Torna al menu']]
			}
		};

		var kbYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [['Si'], ['Torna alla vetta'], ['Continua a Combattere']]
			}
		};

		connection.query('SELECT * FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}

			var dragon_id = rows[0].id;
			var dragon_life = rows[0].life;
			var dragon_total_life = rows[0].total_life;
			var dragon_scale = rows[0].scale;
			var dragon_level = rows[0].level;

			connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var inCombat = 0;
				var iscritto = Object.keys(rows).length;

				if (iscritto > 0){
					if (rows[0].combat == 1) {
						inCombat = 1;
					}
				}

				connection.query('SELECT dragon.name, dragon.type FROM dragon, dragon_top_status WHERE dragon.id = dragon_top_status.dragon_id AND enemy_dragon_id = ' + dragon_id, function (err, rows, fields) {
					if (err) throw err;
					var inCombatText = "";
					var combatSubito = Object.keys(rows).length;
					if ((inCombat == 1) && (combatSubito > 0)) {
						inCombatText = "Il tuo drago Ã¨ in combattimento nell'arena contro " + rows[0].name + " " + rows[0].type + ", attendi che lo scontro finisca prima di utilizzare questo oggetto!";
					}

					connection.query('SELECT item.name, inventory.quantity As cnt FROM item, inventory WHERE item.id = inventory.item_id AND item.category = 6 AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
						if (err) throw err;

						var iKeys = [];

						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							iKeys.push([rows[i].name + " (" + rows[i].cnt + ")"]);
						};

						iKeys.push(["Continua a combattere"]);
						iKeys.push(["Torna al menu"]);

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, "Quale oggetto vuoi utilizzare?", kb).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if ((answer.text == "Continua a combattere") || (answer.text == "Torna al menu")) {
									return;
								}
								var item = answer.text.substring(0, answer.text.indexOf("(") - 1);
								connection.query('SELECT id FROM item WHERE name = "' + item + '"', function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "L'oggetto selezionato non esiste", kbNext);
										return;
									}
									var item_id = rows[0].id;
									if (getItemCnt(player_id, item_id) == 0) {
										bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato", kbNext);
										return;
									}

									if (item_id != 706) {
										if (inCombat == 0) {
											bot.sendMessage(message.chat.id, "Questo oggetto puÃ² essere utilizzato solo se il drago si trova in combattimento nella vetta!", kbNext);
											return;
										}
										if (iscritto == 0) {
											bot.sendMessage(message.chat.id, "Questo oggetto puÃ² essere utilizzato solo se il drago Ã¨ iscritto alle Vette", back);
											return;
										}
										if ((item_id == 700) || (item_id == 701) || (item_id == 702)) {
											if (inCombatText != "") {
												bot.sendMessage(message.chat.id, inCombatText, kbNext);
												return;
											}
										};
									}else{
										if ((inCombat == 1) || ((inCombat == 1) && (combatSubito > 0))) {
											bot.sendMessage(message.chat.id, "Questo oggetto non puÃ² essere utilizzato se il drago si trova in combattimento nella vetta!", kbNext);
											return;
										}
									}

									delItem(player_id, item_id, 1);

									if ((item_id == 700) || (item_id == 701) || (item_id == 702)) {

										var scale = 0;
										if (item_id == 700) {
											scale = 1;
										} else if (item_id == 701) {
											scale = 2;
										} else if (item_id == 702) {
											scale = 3;
										}

										if (dragon_scale + scale > 5)
											scale = 5 - dragon_scale;

										connection.query('UPDATE dragon SET scale = scale+' + scale + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Hai ottenuto " + scale + " âšœï¸!", kbNext);
										});
									} else if ((item_id == 703) || (item_id == 704) || (item_id == 705)) {

										var life = 0;
										if (item_id == 703) {
											life = 0.05;
										} else if (item_id == 704) {
											life = 0.1;
										} else if (item_id == 705) {
											life = 0.2;
										}

										dragon_life += dragon_total_life * life;

										if (dragon_life > dragon_total_life) {
											dragon_life = dragon_total_life;
										}

										dragon_life = Math.round(dragon_life);

										connection.query('UPDATE dragon SET life = ' + dragon_life + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											life = life * 100;
											bot.sendMessage(message.chat.id, "Il tuo drago ha recuperato la salute e ora possiede " + dragon_life + " hp!", kbNext);
										});
									} else if (item_id == 706) {

										var sign = "+";
										var text = "ottenuto";
										var rand = Math.random() * 100;
										var extra = "";
										if ((rand < 50) && (dragon_level > 5)) {
											sign = "-";
											text = "perso";
											extra = ", level = level-1";
										}

										connection.query('UPDATE dragon SET exp = exp' + sign + '70' + extra + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Il tuo drago ha " + text + " un livello!", kbNext);
											checkDragon(player_id);
										});
									};
								});
							};
						});
					});
				});
			});
		});
	});
});

bot.onText(/Entra in combattimento|Continua a combattere/i, function (message) {
	connection.query('SELECT account_id, id, reborn, charm_id, holiday, class FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var charm_id = rows[0].charm_id;
		var class_id = rows[0].class;

		var kbBack = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [['Torna alla vetta'], ['Torna al menu']]
			}
		};

		var kbNext = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [['Continua a Combattere'], ['Torna al menu']]
			}
		};

		var kbNext = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [['Continua a Combattere'], ['Torna al menu']]
			}
		};

		var kbYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [['Si'], ['Continua a Combattere']]
			}
		};

		var d = new Date();
		d.setMinutes(d.getMinutes() + 15);
		var dragon_time = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
		var dragon_time_short = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

		connection.query('SELECT * FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi il drago.", back);
				return;
			}

			var dragon_id = rows[0].id;
			var dragon_name = rows[0].name;
			var dragon_level = rows[0].level;
			var dragon_type = rows[0].type;
			var dragon_scale = rows[0].scale;
			var dragon_life = rows[0].life;
			var dragon_total_life = rows[0].total_life;

			var dragon_damage = rows[0].damage;
			var dragon_defence = rows[0].defence;
			var dragon_claws = rows[0].claws;
			var dragon_claws_id = rows[0].claws_id;
			var dragon_saddle = rows[0].saddle;
			var dragon_saddle_id = rows[0].saddle_id;
			var dragon_arms_id = rows[0].arms_id;
			var dragon_arms_duration = rows[0].arms_duration;
			var dragon_crit = rows[0].critical;

			if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
				dragon_claws += dragon_claws * 1;
			}else if ((class_id == 7) && (reborn > 1)) {
				dragon_claws += dragon_claws * 0.5;
			}
			if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
				dragon_saddle += dragon_saddle * 1;
			}else if ((class_id == 7) && (reborn > 1)) {
				dragon_saddle += dragon_saddle * 0.5;
			}

			if ((class_id == 7) && (reborn == 3)) {
				dragon_crit += 5;
			}
			if ((class_id == 7) && (reborn >= 4)) {
				dragon_crit += 7;
			}

			connection.query('SELECT * FROM dragon_move WHERE type = ' + dragonToId(dragon_type) + ' ORDER BY scale ASC', function (err, rows, fields) {
				if (err) throw err;

				var move = [];
				var dragon_moves = [];

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					dragon_moves.push(rows[i].name);
				}

				move.push([dragonSymId(rows[0].move_type) + " " + rows[0].name + " (" + rows[0].scale + " âšœï¸)",
						   dragonSymId(rows[1].move_type) + " " + rows[1].name + " (" + rows[1].scale + " âšœï¸)"]);
				move.push([dragonSymId(rows[2].move_type) + " " + rows[2].name + " (" + rows[2].scale + " âšœï¸)",
						   dragonSymId(rows[3].move_type) + " " + rows[3].name + " (" + rows[3].scale + " âšœï¸)"]);
				move.push(["Salta (+1 âšœï¸)", "Risorse ðŸµ"]);
				move.push(["Scruta ðŸ”Ž", "Rinuncia ðŸš«", "Torna al menu"]);

				var kbCombat = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": move
					}
				};

				connection.query('SELECT id, is_dummy, top_id, enemy_dragon_id, poison, dmg_boost, ice, protection, wait_dmg, confusion, battle_time FROM dragon_top_status WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Non sei iscritto alla vetta", kbBack);
						return;
					}

					if (rows[0].enemy_dragon_id == null) {
						bot.sendMessage(message.chat.id, "Non sei piÃ¹ in combattimento", kbBack);
						return;
					}

					var enemy_dragon_id = rows[0].enemy_dragon_id;

					var d = new Date(rows[0].battle_time);
					var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());
					var top_id = rows[0].top_id;

					var dmg_boost = rows[0].dmg_boost;
					var poison = rows[0].poison;
					var ice = rows[0].ice;
					var protection = rows[0].protection;
					var wait_dmg = rows[0].wait_dmg;
					var confusion = rows[0].confusion;

					var is_dummy = rows[0].is_dummy;
					var target_table_status = "dragon_top_status";
					var target_table_dragon = "dragon";
					if (is_dummy == 1){
						target_table_status = "dragon_top_dummy";
						target_table_dragon = "dragon_dummy";
					}

					var altered = "";
					var alteredCnt = 0;
					if (dmg_boost > 0) {
						altered += "Aumento danni";
						alteredCnt = 1;
					}
					if (poison > 0) {
						if (alteredCnt == 1)
							altered += ", ";
						altered += "Avvelenato";
						alteredCnt = 1;
					}
					if (ice > 0) {
						if (alteredCnt == 1)
							altered += ", ";
						altered += "Congelato";
						alteredCnt = 1;
					}
					if (protection > 0) {
						if (alteredCnt == 1)
							altered += ", ";
						altered += "Protetto";
						alteredCnt = 1;
					}
					if (wait_dmg > 0) {
						if (alteredCnt == 1)
							altered += ", ";
						altered += "Colpo pesante";
						alteredCnt = 1;
					}
					if (confusion > 0) {
						if (alteredCnt == 1)
							altered += ", ";
						altered += "Confuso";
						alteredCnt = 1;
					}
					if (alteredCnt == 0)
						altered = "Normale";

					connection.query('SELECT top_id, dmg_boost, poison, ice, protection, wait_dmg, confusion FROM ' + target_table_status + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "Il drago avversario non esiste, contatta l'amministratore", kbBack);
							return;
						}

						var enemy_dmg_boost = rows[0].dmg_boost;
						var enemy_poison = rows[0].poison;
						var enemy_ice = rows[0].ice;
						var enemy_protection = rows[0].protection;
						var enemy_wait_dmg = rows[0].wait_dmg;
						var enemy_confusion = rows[0].confusion;

						var enemy_top_id = rows[0].top_id;

						var enemy_altered = "";
						var alteredCnt = 0;
						if (enemy_dmg_boost > 0) {
							enemy_altered += "Aumento danni";
							alteredCnt = 1;
						}
						if (enemy_poison > 0) {
							if (alteredCnt == 1)
								enemy_altered += ", ";
							enemy_altered += "Avvelenato";
							alteredCnt = 1;
						}
						if (enemy_ice > 0) {
							if (alteredCnt == 1)
								enemy_altered += ", ";
							enemy_altered += "Congelato";
							alteredCnt = 1;
						}
						if (enemy_protection > 0) {
							if (alteredCnt == 1)
								enemy_altered += ", ";
							enemy_altered += "Protetto";
							alteredCnt = 1;
						}
						if (enemy_wait_dmg > 0) {
							if (alteredCnt == 1)
								enemy_altered += ", ";
							enemy_altered += "Colpo pesante";
							alteredCnt = 1;
						}
						if (enemy_confusion > 0) {
							if (alteredCnt == 1)
								enemy_altered += ", ";
							enemy_altered += "Confuso";
							alteredCnt = 1;
						}
						if (alteredCnt == 0)
							enemy_altered = "Normale";

						connection.query('SELECT combat, rank FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Accedi alla vetta prima di entrare in combattimento", kbBack);
								return;
							}

							if (rows[0].combat == 0) {
								bot.sendMessage(message.chat.id, "Cerca un avversario prima di entrare in combattimento", kbBack);
								return;
							}

							var dragon_rank = rows[0].rank;

							connection.query('SELECT player.id, player.charm_id, player.chat_id, player.class, player.reborn FROM player, dragon WHERE player.id = dragon.player_id AND dragon.id = ' + enemy_dragon_id, function (err, rows, fields) {
								if (err) throw err;

								var player_id2 = 0;
								var enemy_charm_id = 0;
								var chat_id2 = 0;
								var reborn2 = 0;
								var class_id2 = 0;

								if (is_dummy == 0){
									player_id2 = rows[0].id;
									enemy_charm_id = rows[0].charm_id;
									chat_id2 = rows[0].chat_id;
									reborn2 = rows[0].reborn;
									class_id2 = rows[0].class;
								}else{
									enemy_charm_id = 695;
									if (class_id == 7)
										class_id2 = 7;
								}

								connection.query('SELECT combat, rank FROM dragon_top_rank WHERE player_id = ' + player_id2, function (err, rows, fields) {
									if (err) throw err;

									var enemy_dragon_rank = 0;
									if (is_dummy == 0){
										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Il drago avversario non Ã¨ piÃ¹ disponibile", kbBack);
											return;
										}

										enemy_dragon_rank = rows[0].rank;
									}else{
										enemy_dragon_rank = dragon_rank;
									}

									connection.query('SELECT * FROM ' + target_table_dragon + ' WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
										if (err) throw err;

										var enemy_dragon_name = rows[0].name;
										var enemy_dragon_level = rows[0].level;
										var enemy_dragon_type = rows[0].type;
										var enemy_dragon_life = rows[0].life;
										var enemy_dragon_total_life = rows[0].total_life;
										var enemy_dragon_scale = rows[0].scale;

										var enemy_dragon_damage = rows[0].damage;
										var enemy_dragon_defence = rows[0].defence;
										var enemy_dragon_claws = rows[0].claws;
										var enemy_dragon_claws_id = rows[0].claws_id;
										var enemy_dragon_saddle = rows[0].saddle;
										var enemy_dragon_saddle_id = rows[0].saddle_id;
										var enemy_dragon_arms_id = rows[0].arms_id;
										var enemy_dragon_arms_duration = rows[0].arms_duration;
										var enemy_dragon_crit = rows[0].critical;

										if ((class_id2 == 7) && (reborn2 > 1) && (reborn2 == 5)) {
											enemy_dragon_claws += enemy_dragon_claws * 1;
										}else if ((class_id2 == 7) && (reborn2 > 1)) {
											enemy_dragon_claws += enemy_dragon_claws * 0.5;
										}
										if ((class_id2 == 7) && (reborn2 > 1) && (reborn2 == 5)) {
											enemy_dragon_saddle += enemy_dragon_saddle * 1;
										}else if ((class_id2 == 7) && (reborn2 > 1)) {
											enemy_dragon_saddle += enemy_dragon_saddle * 0.5;
										}
										if ((class_id2 == 7) && (reborn2 == 3)) {
											enemy_dragon_crit += 5;
										}
										if ((class_id2 == 7) && (reborn2 >= 4)) {
											enemy_dragon_crit += 7;
										}

										var scale = "";
										if (dragon_scale > 0) {
											for (var i = 0; i < dragon_scale; i++) {
												scale += "âšœï¸ ";
											}
										} else {
											scale = "-";
										}

										var status = "Tuo drago " + dragonSym(dragon_type) + ": " + formatNumber(dragon_life) + " ðŸ”º (" + altered + ")\n|" + calcDragonLife(dragon_life, dragon_total_life) + "|\n\n";

										status += "Avversario " + dragonSym(enemy_dragon_type) + ": " + formatNumber(enemy_dragon_life) + " ðŸ”º (" + enemy_altered + ")\n|" + calcDragonLife(enemy_dragon_life, enemy_dragon_total_life) + "|\n\n";

										status += "Scaglie: " + scale + "\n";
										status += "Si conclude alle " + short_date;

										bot.sendMessage(message.chat.id, status + "\nQuale mossa utilizzare?", kbCombat).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {

												if (answer.text == "Torna al menu") {
													return;
												}

												if (answer.text.indexOf("Risorse") != -1) {
													return;
												}

												if (answer.text.indexOf("Scruta") != -1) {
													bot.sendMessage(message.chat.id, "<b>Informazioni sul drago avversario:</b>\n" + "Nome: " + enemy_dragon_name + " " + enemy_dragon_type + " " + dragonSym(enemy_dragon_type) + "\nLivello: " + enemy_dragon_level, kbNext);
													return;
												}

												if (answer.text.indexOf("Rinuncia") != -1) {
													bot.sendMessage(message.chat.id, "Sei veramente sicuro di voler abbandonare la battaglia? VerrÃ  conteggiata come persa.", kbYesNo).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text.toLowerCase() == "si") {

																var d = new Date();
																d.setMinutes(d.getMinutes() + 5);
																var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																var d = new Date();
																d.setMinutes(d.getMinutes() + 15);
																var long_date2 = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																connection.query('UPDATE dragon_top_status SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date + '", is_dummy = 0 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																	if (err) throw err;
																	connection.query('UPDATE ' + target_table_status + ' SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date2 + '" WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																		connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																				if (err) throw err;

																				var chest = 1;

																				if (enemy_dragon_level > (dragon_level + 50)) {
																					chest = 0;
																				}

																				if (enemy_dragon_arms_id == 714) {
																					var randS = Math.random() * 100;
																					if (randS < 50) {
																						chest++;
																					}
																				}

																				var extra = "";
																				if (chest == 1) {
																					extra = " uno Scrigno Scaglia!";

																					if (is_dummy == 0){
																						addChest(player_id2, 9);
																					}
																				} else if (chest > 1) {
																					extra = " " + chest + " Scrigni Scaglia!";

																					if (is_dummy == 0){
																						addChest(player_id2, 9, chest);
																					}
																				}

																				if (dragon_rank > 0) {
																					connection.query('UPDATE dragon_top_rank SET rank = rank-1 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																					if (enemy_top_id < 5){
																						connection.query('UPDATE dragon_top_rank SET rank = rank+1 WHERE rank < ' + rank_cap + ' AND dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					}

																					bot.sendMessage(message.chat.id, "Hai abbandonato la battaglia e hai perso 1 Ã!", kbBack);

																					if (extra != "")
																						extra = " e" + extra;
																					if (is_dummy == 0)
																						bot.sendMessage(chat_id2, "Il tuo sfidante " + dragon_name + " ha abbandonato lo scontro, hai ottenuto 1 Ã" + extra + "!");
																				} else {
																					bot.sendMessage(message.chat.id, "Hai abbandonato la battaglia!", kbBack);

																					if (extra != "")
																						extra = " e hai ricevuto" + extra;
																					if (is_dummy == 0)
																						bot.sendMessage(chat_id2, "Il tuo sfidante " + dragon_name + " ha abbandonato lo scontro" + extra + "!");
																				}

																				var d = new Date();
																				var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																				if (is_dummy == 0){
																					connection.query('INSERT INTO dragon_top_log (player_id, dragon_id, enemy_player_id, enemy_dragon_id, time, win, note) VALUES (' + player_id + ',' + dragon_id + ',' + player_id2 + ',' + enemy_dragon_id + ',"' + long_date + '",2,"Rinuncia")', function (err, rows, fields) {
																						if (err) throw err;
																					});
																				}else if (is_dummy == 1){
																					connection.query('DELETE FROM dragon_top_dummy WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																						if (err) throw err;
																						connection.query('DELETE FROM dragon_dummy WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					});
																				}
																			});
																		});
																	});
																});
															};
														};
													});
													return;
												}

												var skip = 0;
												if (answer.text.indexOf("Salta") != -1) {
													skip = 1;
												}

												var move = answer.text.substring(3, answer.text.indexOf("(") - 1);
												if ((dragon_moves.indexOf(move) == -1) && (skip == 0)) {
													return;
												}

												connection.query('SELECT enemy_dragon_id FROM dragon_top_status WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													var enemy_dragon_id = rows[0].enemy_dragon_id;
													if (enemy_dragon_id == null) {
														bot.sendMessage(message.chat.id, "Non sei piÃ¹ in combattimento", kbBack);
														return;
													}

													connection.query('SELECT name, scale, damage, move_type FROM dragon_move WHERE name = "' + move + '"', function (err, rows, fields) {
														if (err) throw err;

														var move_damage = 0;
														var move_name = "";
														var move_scale = 0;
														var move_type = 0;

														if (Object.keys(rows).length > 0) {
															if (dragon_scale < rows[0].scale) {
																bot.sendMessage(message.chat.id, "Non hai abbastanza âšœï¸ per utilizzare questa mossa (" + rows[0].scale + " necessarie)", kbNext);
																return;
															}

															move_damage = rows[0].damage;
															move_name = rows[0].name;
															move_scale = rows[0].scale;
															move_type = rows[0].move_type;
														}

														var enemySkip = 0;

														//Per saltare i turni a volte
														var rand = Math.random() * 100;
														var prob = 50 - 10 * enemy_dragon_scale;
														if (prob > rand)
															enemySkip = 1;

														connection.query('SELECT name, scale, damage, move_type FROM dragon_move WHERE scale <= ' + enemy_dragon_scale + ' AND type = ' + dragonToId(enemy_dragon_type) + ' ORDER BY RAND()', function (err, rows, fields) {

															var enemy_move_name = "";
															var enemy_move_damage = 0;
															var enemy_move_type = 0;
															var enemy_move_scale = 0;

															if ((Object.keys(rows).length > 0) && (enemySkip == 0)) {
																enemy_move_name = rows[0].name;
																enemy_move_damage = rows[0].damage;
																enemy_move_type = rows[0].move_type;
																enemy_move_scale = rows[0].scale;

																connection.query('UPDATE ' + target_table_dragon + ' SET scale = scale-' + rows[0].scale + ' WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
																	if (err) throw err;
																});

																enemy_dragon_scale -= rows[0].scale;
															} else {
																enemySkip = 1;
															}

															dragon_scale -= move_scale;

															connection.query('UPDATE dragon SET scale = scale-' + move_scale + ' WHERE id = ' + dragon_id, function (err, rows, fields) {
																if (err) throw err;

																var rand = Math.random() * 100;
																var crit_txt = "";

																var weak1 = typeWeak(dragonToId(dragon_type), dragonToId(enemy_dragon_type), 0, 0);
																var weak2 = typeWeak(dragonToId(enemy_dragon_type), dragonToId(dragon_type), 0, 1);
																var moveWeak1 = typeWeak(move_type, dragonToId(enemy_dragon_type), 1, 0);
																var moveWeak2 = typeWeak(enemy_move_type, dragonToId(dragon_type), 1, 1);

																var moveCrit1 = 0;
																var moveCrit2 = 0;

																var dmg_multi = 50;

																//Mio

																if ((move_type == 1) && (enemy_poison == 0) && (ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (move_scale * 2) * 8;
																	if (enemy_dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (enemy_dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (enemy_dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (enemy_dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		enemy_poison = 2;
																		if (dragon_claws_id == 741) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				enemy_poison++;
																			}
																		}
																		connection.query('UPDATE ' + target_table_status + ' SET poison = ' + enemy_poison + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai avvelenato il drago nemico!");
																		});
																	}
																}
																if ((move_type == 2) && (protection == 0) && (ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (move_scale * 2) * 8;
																	if (enemy_dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (enemy_dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (enemy_dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (enemy_dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		protection = 2;
																		if (dragon_claws_id == 746) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				protection++;
																			}
																		}
																		connection.query('UPDATE dragon_top_status SET protection = ' + protection + ' WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai attivato la protezione dai danni!");
																		});
																	}
																}
																if ((move_type == 3) && (dmg_boost == 0) && (ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (move_scale * 2) * 8;
																	if (enemy_dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (enemy_dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (enemy_dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (enemy_dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		dmg_boost = 3;
																		if (dragon_claws_id == 717) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				dmg_boost++;
																			}
																		}
																		connection.query('UPDATE dragon_top_status SET dmg_boost = ' + dmg_boost + ' WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai attivato il danno incrementato!");
																		});
																	}
																}
																if ((move_type == 4) && (enemy_confusion == 0) && (ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (move_scale * 2) * 6;
																	if (enemy_dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (dragon_claws_id == 716) {
																		randC += 10;
																	}
																	if (enemy_dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (enemy_dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (enemy_dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (enemy_dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		enemy_confusion = 1;
																		if (dragon_claws_id == 727) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				enemy_confusion++;
																			}
																		}
																		connection.query('UPDATE ' + target_table_status + ' SET confusion = ' + enemy_confusion + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai confuso il drago nemico!");
																		});
																	}
																}
																if ((move_type == 5) && (wait_dmg == 0) && (ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (move_scale * 2) * 8;
																	if (enemy_dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (enemy_dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (enemy_dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (enemy_dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		connection.query('UPDATE dragon_top_status SET wait_dmg = 2 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Colpo pesante in caricamento (2 turni)!");
																		});
																		wait_dmg = 2;
																	}
																}
																if ((move_type == 6) && (enemy_ice == 0) && (ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (move_scale * 2) * 8;
																	if (enemy_dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (enemy_dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (enemy_dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (enemy_dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (enemy_dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		enemy_ice = 2;
																		if (dragon_claws_id == 721) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				enemy_ice++;
																			}
																		}
																		connection.query('UPDATE ' + target_table_status + ' SET ice = ' + enemy_ice + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Hai congelato il drago nemico!");
																		});
																	}
																}

																var damage = dragon_damage + dragon_claws;
																var max = damage + (damage * 0.1);
																var min = damage - (damage * 0.1);
																damage = getRandomArbitrary(min, max);
																damage -= (enemy_dragon_defence + enemy_dragon_saddle);

																if (charm_id == 602) {
																	damage += 25;
																	dragon_crit += 10;
																}
																if (charm_id == 695) {
																	damage += 30;
																	dragon_crit += 15;
																}
																if (dragon_claws_id == 747) {
																	dragon_crit += 5;
																}

																//Nemico

																if ((enemy_move_type == 1) && (poison == 0) && (enemySkip == 0) && (enemy_ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (enemy_move_scale * 2) * 8;

																	if (dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (dragon_claws_id == 749) {
																		randC -= 5;
																	}

																	if (rand < randC) {
																		poison = 2;
																		if (enemy_dragon_claws_id == 741) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				poison++;
																			}
																		}
																		connection.query('UPDATE dragon_top_status SET poison = ' + poison + ' WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Sei stato avvelenato dal drago nemico!");
																		});
																	}
																}
																if ((enemy_move_type == 2) && (enemy_protection == 0) && (enemySkip == 0) && (enemy_ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (enemy_move_scale * 2) * 8;
																	if (dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		enemy_protection = 2;
																		if (enemy_dragon_claws_id == 746) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				enemy_protection++;
																			}
																		}
																		connection.query('UPDATE ' + target_table_status + ' SET protection = ' + enemy_protection + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il drago nemico ha attivato la protezione!");
																		});
																	}
																}
																if ((enemy_move_type == 3) && (enemy_dmg_boost == 0) && (enemySkip == 0) && (enemy_ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (enemy_move_scale * 2) * 8;
																	if (dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		enemy_dmg_boost = 3;
																		if (enemy_dragon_claws_id == 717) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				enemy_dmg_boost++;
																			}
																		}
																		connection.query('UPDATE ' + target_table_status + ' SET dmg_boost = ' + enemy_dmg_boost + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il drago nemico ha attivato il danno incrementato!");
																		});
																	}
																}
																if ((enemy_move_type == 4) && (confusion == 0) && (enemySkip == 0) && (enemy_ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (enemy_move_scale * 2) * 6;
																	if (dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (enemy_dragon_claws_id == 716) {
																		randC += 10;
																	}
																	if (dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (dragon_claws_id == 749) {
																		randC -= 5;
																	}

																	if (rand < randC) {
																		confusion = 1;
																		if (enemy_dragon_claws_id == 727) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				confusion++;
																			}
																		}
																		connection.query('UPDATE dragon_top_status SET confusion = ' + confusion + ' WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il drago nemico ti ha confuso!");
																		});
																	}
																}
																if ((enemy_move_type == 5) && (enemy_wait_dmg == 0) && (enemySkip == 0) && (enemy_ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (enemy_move_scale * 2) * 8;
																	if (dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		connection.query('UPDATE ' + target_table_status + ' SET wait_dmg = 2 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il drago nemico sta caricando un colpo!");
																		});
																		enemy_wait_dmg = 2;
																	}
																}
																if ((enemy_move_type == 6) && (ice == 0) && (enemySkip == 0) && (enemy_ice == 0)) {
																	var rand = Math.random() * 100;
																	var randC = (enemy_move_scale * 2) * 8;
																	if (dragon_arms_id == 710) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 720) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 725) {
																		randC -= 5;
																	}
																	if (dragon_saddle_id == 732) {
																		randC -= 10;
																	}
																	if (dragon_saddle_id == 738) {
																		randC -= 10;
																	}
																	if (dragon_claws_id == 744) {
																		randC -= 5;
																	}
																	if (dragon_claws_id == 749) {
																		randC -= 5;
																	}
																	if (rand < randC) {
																		ice = 2;
																		if (enemy_dragon_claws_id == 721) {
																			var rand = Math.random() * 100;
																			if (rand < 10) {
																				ice++;
																			}
																		}
																		connection.query('UPDATE dragon_top_status SET ice = ' + ice + ' WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Il drago nemico ti ha congelato!");
																		});
																	}
																}

																rand = Math.random() * 100;
																var enemy_crit_txt = "";

																var enemy_damage = enemy_dragon_damage + enemy_dragon_claws;
																var max = enemy_damage + (enemy_damage * 0.1);
																var min = enemy_damage - (enemy_damage * 0.1);
																enemy_damage = getRandomArbitrary(min, max);
																enemy_damage -= (dragon_defence + dragon_saddle);

																if (enemy_charm_id == 602) {
																	enemy_damage += 25;
																	enemy_dragon_crit += 10;
																}
																if (enemy_charm_id == 695) {
																	enemy_damage += 30;
																	enemy_dragon_crit += 15;
																}
																if (enemy_dragon_claws_id == 747) {
																	enemy_dragon_crit += 5;
																}

																// Mie mosse

																if ((dmg_boost > 0) && (skip == 0) && (wait_dmg <= 1)) {
																	damage += damage * 0.25;
																	connection.query('UPDATE dragon_top_status SET dmg_boost = dmg_boost-1 WHERE dmg_boost > 0 AND dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																var enemy_poison_dmg = 0;
																if (enemy_poison > 0) {
																	enemy_poison_dmg = damage * getRandomArbitrary(0.5, 0.65);
																	damage += enemy_poison_dmg;
																	connection.query('UPDATE ' + target_table_status + ' SET poison = poison-1 WHERE poison > 0 AND dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																if ((ice > 0) && (skip == 0)) {
																	damage = 0;
																	connection.query('UPDATE dragon_top_status SET ice = ice-1 WHERE ice > 0 AND dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																if ((enemy_protection > 0) && (skip == 0)) {
																	damage -= damage * 0.5;
																	connection.query('UPDATE ' + target_table_status + ' SET protection = protection-1 WHERE protection > 0 AND dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																var high_dmg = 0;
																if ((wait_dmg > 0) && (skip == 0) && (ice == 0)) {
																	if (wait_dmg == 1) {
																		high_dmg = damage;
																		damage += high_dmg;
																	} else {
																		skip = 1;
																	}
																	connection.query('UPDATE dragon_top_status SET wait_dmg = wait_dmg-1 WHERE wait_dmg > 0 AND dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																var enemy_conf_dmg = 0;
																if ((enemy_confusion > 0) && (enemySkip == 0)) {
																	enemy_conf_dmg = damage * 0.5;
																	damage += enemy_conf_dmg;
																	connection.query('UPDATE ' + target_table_status + ' SET confusion = confusion-1 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	enemySkip = 1;
																}

																var rand = Math.random() * 100;
																var crit_val = 0;
																if (dragon_crit > rand) {
																	if ((dragon_arms_id == 712) || (dragon_claws_id == 733)) {
																		if (dragon_arms_id == 712) {
																			crit_val = 1.5;
																			damage += damage * crit_val;
																		}
																		if (dragon_claws_id == 733) {
																			crit_val = 1.3;
																			damage += damage * crit_val;
																		}
																	} else {
																		crit_val = 1;
																		damage += damage * crit_val;
																	}
																	crit_txt = " CRITICI";
																}

																damage += damage * weak1["myDmg"];
																damage += damage * moveWeak1["myDmg"];

																if (moveWeak1["myDmg"] != 0)
																	moveCrit1 = 1;

																//Mosse nemico

																if ((enemy_dmg_boost > 0) && (enemySkip == 0) && (enemy_wait_dmg <= 1)) {
																	enemy_damage += enemy_damage * 0.25;
																	connection.query('UPDATE ' + target_table_status + ' SET dmg_boost = dmg_boost-1 WHERE dmg_boost > 0 AND dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																var conf_dmg = 0;
																if ((confusion > 0) && (skip == 0)) {
																	conf_dmg = enemy_damage * 0.5;
																	enemy_damage += conf_dmg;
																	connection.query('UPDATE dragon_top_status SET confusion = confusion-1 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	skip = 1;
																}
																var poison_dmg = 0;
																if (poison > 0) {
																	poison_dmg = enemy_damage * getRandomArbitrary(0.5, 0.65);
																	enemy_damage += poison_dmg;
																	connection.query('UPDATE dragon_top_status SET poison = poison-1 WHERE poison > 0 AND dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																if ((enemy_ice > 0) && (enemySkip == 0)) {
																	enemy_damage = 0;
																	connection.query('UPDATE ' + target_table_status + ' SET ice = ice-1 WHERE ice > 0 AND dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}
																if ((protection > 0) && (enemySkip == 0)) {
																	enemy_damage -= enemy_damage * 0.5;
																	connection.query('UPDATE dragon_top_status SET protection = protection-1 WHERE protection > 0 AND dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}

																var enemy_high_dmg = 0;
																if ((enemy_wait_dmg > 0) && (enemySkip == 0) && (enemy_ice == 0)) {
																	if (enemy_wait_dmg == 1) {
																		enemy_high_dmg = enemy_damage;
																		enemy_damage += enemy_high_dmg;
																	} else {
																		enemySkip = 1;
																	}
																	connection.query('UPDATE ' + target_table_status + ' SET wait_dmg = wait_dmg-1 WHERE wait_dmg > 0 AND dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																}

																var rand = Math.random() * 100;
																var enemy_crit_val = 0;
																if (enemy_dragon_crit > rand) {
																	if ((enemy_dragon_arms_id == 712) || (enemy_dragon_claws_id == 733)) {
																		if (enemy_dragon_arms_id == 712) {
																			enemy_crit_val = 1.5;
																			enemy_damage += enemy_damage * enemy_crit_val;
																		}
																		if (enemy_dragon_claws_id == 733) {
																			enemy_crit_val = 1.3;
																			enemy_damage += enemy_damage * enemy_crit_val;
																		}
																	} else {
																		enemy_crit_val = 1;
																		enemy_damage += enemy_damage * enemy_crit_val;
																	}
																	enemy_crit_txt = " CRITICI";
																}

																enemy_damage += enemy_damage * weak2["myDmg"];
																enemy_damage += enemy_damage * moveWeak2["myDmg"];

																if (moveWeak2["myDmg"] != 0)
																	moveCrit2 = 1;

																//Riduzioni e aumenti di danno
																if (dragon_arms_id == 711) {
																	damage += damage * 0.1;
																}
																if (enemy_dragon_arms_id == 711) {
																	enemy_damage += enemy_damage * 0.1;
																}
																if (enemy_dragon_arms_id == 713) {
																	damage -= damage * 0.1;
																}
																if (dragon_arms_id == 713) {
																	enemy_damage -= enemy_damage * 0.1;
																}
																if (enemy_dragon_claws_id == 722) {
																	damage -= damage * 0.1;
																}
																if (dragon_claws_id == 722) {
																	enemy_damage -= enemy_damage * 0.1;
																}
																if (dragon_arms_id == 728) {
																	damage += damage * 0.05;
																}
																if (enemy_dragon_arms_id == 728) {
																	enemy_damage += enemy_damage * 0.05;
																}

																if (enemy_dragon_type == 3) {
																	if (dragon_saddle_id == 726) {
																		enemy_damage -= enemy_damage * 0.1;
																	}
																}
																if (dragon_type == 3) {
																	if (enemy_dragon_saddle_id == 726) {
																		damage -= damage * 0.1;
																	}
																}
																if (enemy_dragon_type == 1) {
																	if (dragon_saddle_id == 731) {
																		enemy_damage -= enemy_damage * 0.1;
																	}
																}
																if (dragon_type == 1) {
																	if (enemy_dragon_saddle_id == 731) {
																		damage -= damage * 0.1;
																	}
																}
																if (dragon_claws_id == 735) {
																	enemy_damage -= enemy_damage * 0.05;
																}
																if (enemy_dragon_claws_id == 735) {
																	damage -= damage * 0.05;
																}
																if (dragon_claws_id == 739) {
																	enemy_damage -= enemy_damage * 0.1;
																}
																if (enemy_dragon_claws_id == 739) {
																	damage -= damage * 0.1;
																}

																// Resistenze tipo
																if ((dragon_type == 1) && (enemy_dragon_type == 4)) {
																	if (enemy_dragon_saddle_id == 743) {
																		enemy_damage -= enemy_damage * 0.5;
																	}
																}
																if ((dragon_type == 3) && (enemy_dragon_type == 2)) {
																	if (enemy_dragon_saddle_id == 719) {
																		enemy_damage -= enemy_damage * 0.5;
																	}
																}
																if ((dragon_type == 6) && (enemy_dragon_type == 1)) {
																	if (enemy_dragon_saddle_id == 726) {
																		enemy_damage -= enemy_damage * 0.5;
																	}
																}
																if ((dragon_type == 5) && (enemy_dragon_type == 3)) {
																	if (enemy_dragon_saddle_id == 737) {
																		enemy_damage -= enemy_damage * 0.5;
																	}
																}
																if ((dragon_type == 4) && (enemy_dragon_type == 6)) {
																	if (enemy_dragon_saddle_id == 731) {
																		enemy_damage -= enemy_damage * 0.5;
																	}
																}
																if ((dragon_type == 2) && (enemy_dragon_type == 5)) {
																	if (enemy_dragon_saddle_id == 750) {
																		enemy_damage -= enemy_damage * 0.5;
																	}
																}
																//nemico
																if ((enemy_dragon_type == 1) && (dragon_type == 4)) {
																	if (dragon_saddle_id == 743) {
																		damage -= damage * 0.5;
																	}
																}
																if ((enemy_dragon_type == 3) && (dragon_type == 2)) {
																	if (dragon_saddle_id == 719) {
																		damage -= damage * 0.5;
																	}
																}
																if ((enemy_dragon_type == 6) && (dragon_type == 1)) {
																	if (dragon_saddle_id == 726) {
																		damage -= damage * 0.5;
																	}
																}
																if ((enemy_dragon_type == 5) && (dragon_type == 3)) {
																	if (dragon_saddle_id == 737) {
																		damage -= damage * 0.5;
																	}
																}
																if ((enemy_dragon_type == 4) && (dragon_type == 6)) {
																	if (dragon_saddle_id == 731) {
																		damage -= damage * 0.5;
																	}
																}
																if ((enemy_dragon_type == 2) && (dragon_type == 5)) {
																	if (dragon_saddle_id == 750) {
																		damage -= damage * 0.5;
																	}
																}

																if (damage < 0)
																	damage = 0;

																if (enemy_damage < 0)
																	enemy_damage = 0;

																damage += damage * move_damage;
																enemy_damage += enemy_damage * enemy_move_damage;

																if (skip == 1) {
																	damage = 0;
																	if (enemy_poison_dmg > 0){
																		enemy_poison_dmg = (enemy_poison_dmg * dmg_multi) + (enemy_poison_dmg * enemy_crit_val);
																		damage = enemy_poison_dmg;
																	}
																}

																if (enemySkip == 1) {
																	enemy_damage = 0;
																	if (poison_dmg > 0){
																		poison_dmg = (poison_dmg * dmg_multi) + (poison_dmg * crit_val);
																		enemy_damage = poison_dmg;
																	}
																}

																// Effettivi
																if (skip == 0) {
																	damage = damage * dmg_multi;
																}
																if (enemySkip == 0) {
																	enemy_damage = enemy_damage * dmg_multi;
																}

																// Solo visualizzazione
																damage = Math.round(damage);
																enemy_damage = Math.round(enemy_damage);
																if (enemySkip == 0) {
																	poison_dmg = poison_dmg * dmg_multi;
																	poison_dmg += poison_dmg * crit_val;
																}
																if (skip == 0) {
																	enemy_poison_dmg = enemy_poison_dmg * dmg_multi;
																	enemy_poison_dmg += enemy_poison_dmg * enemy_crit_val;
																}
																high_dmg = high_dmg * dmg_multi;
																high_dmg += high_dmg * crit_val;
																enemy_high_dmg = enemy_high_dmg * dmg_multi;
																enemy_high_dmg += enemy_high_dmg * enemy_crit_val;
																conf_dmg = conf_dmg * dmg_multi;
																conf_dmg += conf_dmg * crit_val;
																enemy_conf_dmg = enemy_conf_dmg * dmg_multi;
																enemy_conf_dmg += enemy_conf_dmg * enemy_crit_val;

																poison_dmg = Math.round(poison_dmg);
																enemy_poison_dmg = Math.round(enemy_poison_dmg);
																high_dmg = Math.round(high_dmg);
																enemy_high_dmg = Math.round(enemy_high_dmg);
																conf_dmg = Math.round(conf_dmg);
																enemy_conf_dmg = Math.round(enemy_conf_dmg);

																var over = 0;
																var enemy_over = 0;
																if (high_dmg > damage)
																	over = 1;
																if (enemy_high_dmg > enemy_damage)
																	enemy_over = 1;

																if (damage >= enemy_dragon_life) {
																	var d = new Date();
																	d.setMinutes(d.getMinutes() + 15);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																	connection.query('UPDATE dragon_top_status SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date + '" WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																		connection.query('UPDATE ' + target_table_status + ' SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date + '" WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																				if (err) throw err;
																				connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																					if (err) throw err;
																					connection.query('UPDATE ' + target_table_dragon + ' SET life = 0 WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
																						if (err) throw err;

																						var rank = 1;
																						var rank_lost = 1;
																						if (dragon_level < (enemy_dragon_level - 20)) {
																							rank = 2;
																							rank_lost = 2;
																						}

																						// Il vincitore vince sempre il rango anche se il perdente non lo possiede, mentre quest'ultimo lo perde solo se lo possiede
																						if (enemy_dragon_rank >= rank_lost) {
																							connection.query('UPDATE dragon_top_rank SET rank = rank-' + rank_lost + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																						} else {
																							rank_lost = 1;
																							if (enemy_dragon_rank >= rank_lost) {
																								connection.query('UPDATE dragon_top_rank SET rank = rank-' + rank_lost + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							} else {
																								rank_lost = 0;
																							}
																						}

																						if (top_id < 5){
																							if (dragon_rank + rank >= rank_cap) {
																								rank = rank_cap - dragon_rank;
																								if (rank < 0)
																									rank = 0;
																							}
																						}

																						connection.query('UPDATE dragon_top_rank SET rank = rank+' + rank + ' WHERE  dragon_id = ' + dragon_id, function (err, rows, fields) {
																							if (err) throw err;

																							var money = 0;
																							var chest = 1;
																							var randM = Math.random() * 100;
																							var bonus_money = "";
																							if (randM < 30) {
																								money = dragon_level * getRandomArbitrary(15, 30);
																								money = Math.round(money);
																								bonus_money = " (Bonus: " + formatNumber(money) + " Â§)";
																							}

																							if (dragon_level > (enemy_dragon_level + 50)) {
																								chest = 0;
																							}

																							if (dragon_arms_id == 714) {
																								var randS = Math.random() * 100;
																								if (randS < 50) {
																									chest++;
																								}
																							}

																							var randP = Math.random() * 100;
																							if (randP < 2) {
																								var randP2 = Math.random() * 100;
																								if (randP2 < 70) {
																									addItem(player_id, 608);
																									bot.sendMessage(message.chat.id, "Per l'abilitÃ  dimostrata nel combattere con il tuo drago, hai ottenuto un *Pass Bronzo*!", mark);
																								} else if (randP2 < 90) {
																									addItem(player_id, 609);
																									bot.sendMessage(message.chat.id, "Per l'abilitÃ  dimostrata nel combattere con il tuo drago, hai ottenuto un *Pass Argento*!", mark);
																								} else {
																									addItem(player_id, 610);
																									bot.sendMessage(message.chat.id, "Per l'abilitÃ  dimostrata nel combattere con il tuo drago, hai ottenuto un *Pass Oro*!", mark);
																								}
																							}

																							var extra = "";
																							if (chest == 1) {
																								extra = " ed uno Scrigno Scaglia!";
																								addChest(player_id, 9);
																							} else if (chest > 1) {
																								extra = " e " + chest + " Scrigni Scaglia!";
																								addChest(player_id, 9, chest);
																							}

																							connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							bot.sendMessage(message.chat.id, "Hai sconfitto <b>" + enemy_dragon_name + "</b>, hai ottenuto " + rank + " Ã" + extra + bonus_money, kbBack);

																							if (is_dummy == 0){
																								bot.sendMessage(chat_id2, "Il tuo drago Ã¨ stato sconfitto nella vetta da " + dragon_name + " ed hai perso " + rank_lost + " Ã! Fallo riposare per tornare a combattere!");
																							}

																							if (dragon_arms_id != 0){
																								if (dragon_arms_duration <= 1) {
																									connection.query('UPDATE dragon SET arms_duration = 0, arms_id = 0 WHERE id = ' + dragon_id, function (err, rows, fields) {
																										if (err) throw err;
																										bot.sendMessage(message.chat.id, "Lo stemma equipaggiato si Ã¨ rotto!");
																									});
																								} else {
																									connection.query('UPDATE dragon SET arms_duration = arms_duration-1 WHERE id = ' + dragon_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																							}

																							connection.query('UPDATE dragon_top_status SET wait_time = "' + dragon_time + '", is_dummy = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							var d = new Date();
																							var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																							if (is_dummy == 0){
																								connection.query('INSERT INTO dragon_top_log (player_id, dragon_id, enemy_player_id, enemy_dragon_id, time, win, note) VALUES (' + player_id + ',' + dragon_id + ',' + player_id2 + ',' + enemy_dragon_id + ',"' + long_date + '",1,"Battaglia")', function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}else if (is_dummy == 1){
																								connection.query('DELETE FROM dragon_top_dummy WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																									if (err) throw err;
																									connection.query('DELETE FROM dragon_dummy WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								});
																							}
																						});
																					});
																				});
																			});
																		});
																	});
																	return;
																}

																if (enemy_damage >= dragon_life) {
																	var d = new Date();
																	d.setMinutes(d.getMinutes() + 15);
																	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																	connection.query('UPDATE dragon_top_status SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date + '" WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																		connection.query('UPDATE ' + target_table_status + ' SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date + '" WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																				if (err) throw err;
																				connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																					if (err) throw err;
																					connection.query('UPDATE dragon SET life = 0 WHERE id = ' + dragon_id, function (err, rows, fields) {
																						if (err) throw err;

																						var rank = 1;
																						var rank_lost = 1;
																						if ((enemy_dragon_level + 20) < dragon_level) {
																							rank = 2;
																							rank_lost = 2;
																						}

																						// Il vincitore vince sempre il rango anche se il perdente non lo possiede, mentre quest'ultimo lo perde solo se lo possiede
																						if (dragon_rank >= rank_lost) {
																							connection.query('UPDATE dragon_top_rank SET rank = rank-' + rank_lost + ' WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																								if (err) throw err;
																							});
																						} else {
																							rank_lost = 1;
																							if (dragon_rank >= rank_lost) {
																								connection.query('UPDATE dragon_top_rank SET rank = rank-' + rank_lost + ' WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							} else {
																								rank_lost = 0;
																							}
																						}

																						if (enemy_top_id < 5){
																							if (enemy_dragon_rank + rank >= rank_cap) {
																								rank = rank_cap - enemy_dragon_rank;
																								if (rank < 0)
																									rank = 0;
																							}
																						}

																						connection.query('UPDATE dragon_top_rank SET rank = rank+' + rank + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																							if (err) throw err;

																							bot.sendMessage(message.chat.id, "Sei stato sconfitto da <b>" + enemy_dragon_name + "</b> ed hai perso " + rank_lost + " Ã!", kbBack);

																							if (is_dummy == 0){
																								addChest(player_id2, 9);
																							}

																							if (is_dummy == 0)
																								bot.sendMessage(chat_id2, "Il tuo drago ha vinto durante il combattimento contro " + dragon_name + " " + dragon_type + "!\nHai ottenuto uno Scrigno Scaglia e " + rank + " Ã!");

																							if (dragon_arms_id != 0){
																								if (dragon_arms_duration <= 1) {
																									connection.query('UPDATE dragon SET arms_duration = 0, arms_id = 0 WHERE id = ' + dragon_id, function (err, rows, fields) {
																										if (err) throw err;
																										bot.sendMessage(message.chat.id, "Lo stemma equipaggiato si Ã¨ rotto!");
																									});
																								} else {
																									connection.query('UPDATE dragon SET arms_duration = arms_duration-1 WHERE id = ' + dragon_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								}
																							}

																							connection.query('UPDATE dragon_top_status SET wait_time = "' + dragon_time + '", is_dummy = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																							});

																							var d = new Date();
																							var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

																							if (is_dummy == 0){
																								connection.query('INSERT INTO dragon_top_log (player_id, dragon_id, enemy_player_id, enemy_dragon_id, time, win, note) VALUES (' + player_id + ',' + dragon_id + ',' + player_id2 + ',' + enemy_dragon_id + ',"' + long_date + '",2,"Battaglia")', function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}else if (is_dummy == 1){
																								connection.query('DELETE FROM dragon_top_dummy WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
																									if (err) throw err;
																									connection.query('DELETE FROM dragon_dummy WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																								});
																							}
																						});
																					});
																				});
																			});
																		});
																	});
																	return;
																}

																connection.query('UPDATE ' + target_table_dragon + ' SET life = life-' + damage + ' WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
																	if (err) throw err;
																	if (enemy_poison_dmg > 0){
																		bot.sendMessage(message.chat.id, "Per avvelenamento il nemico ha perso " + formatNumber(enemy_poison_dmg) + " hp!");
																		damage -= enemy_poison_dmg;
																	}

																	if ((skip == 1) && (conf_dmg == 0)) {
																		if (ice > 0)
																			bot.sendMessage(message.chat.id, "Il tuo drago ha saltato il turno per congelamento!");
																		else if (wait_dmg > 0)
																			bot.sendMessage(message.chat.id, "Il tuo drago salta il turno! Si sta caricando!", kbNext);
																		else
																			bot.sendMessage(message.chat.id, "Il tuo drago ha saltato il turno!");
																	} else if (damage <= 0) {
																		bot.sendMessage(message.chat.id, "Il tuo drago non ha inflitto alcun danno all'avversario!", kbNext);
																	} else {
																		var extra = "";
																		if (moveCrit1 == 1) {
																			extra = " E' superefficace!";
																		}
																		var moveEffect = ""
																		if (dmg_boost > 0) {
																			moveEffect = "Aumentati grazie al potere della mossa di fuoco!\n";
																		}
																		if (enemy_protection > 0) {
																			moveEffect = "Ridotti a causa della protezione!\n";
																		}
																		if (high_dmg > 0) {
																			if (over == 0)
																				moveEffect += "Dei quali " + formatNumber(high_dmg) + " per colpo pesante!\n";
																			else
																				moveEffect += "Dei quali " + formatNumber(high_dmg) + " per colpo pesante (con i quali hai superato la difesa)!\n";
																		}
																		if (enemy_conf_dmg > 0) {
																			moveEffect += "Dei quali " + formatNumber(enemy_conf_dmg) + " derivano dall'essersi colpito da solo!\n";
																		}
																		bot.sendMessage(message.chat.id, "Il tuo drago ha inflitto " + formatNumber(damage) + " danni" + crit_txt + " all'avversario con " + move_name + "!" + extra + "\n" + moveEffect);
																	}

																	connection.query('UPDATE dragon SET life = life-' + enemy_damage + ' WHERE id = ' + dragon_id, function (err, rows, fields) {
																		if (err) throw err;
																		if (poison_dmg > 0){
																			bot.sendMessage(message.chat.id, "Per avvelenamento hai perso " + formatNumber(poison_dmg) + " hp!");
																			enemy_damage -= poison_dmg;
																		}

																		if ((enemySkip == 1) && (enemy_conf_dmg == 0)) {
																			if (enemy_ice > 0)
																				bot.sendMessage(message.chat.id, "Il drago avversario salta il turno per congelamento!", kbNext);
																			else if (enemy_wait_dmg > 0)
																				bot.sendMessage(message.chat.id, "Il drago avversario salta il turno! Si sta caricando!", kbNext);
																			else
																				bot.sendMessage(message.chat.id, "Il drago avversario salta il turno!", kbNext);
																		} else if (enemy_damage <= 0) {
																			bot.sendMessage(message.chat.id, "Il drago avversario non ha inflitto alcun danno!", kbNext);
																		} else {
																			var extra = "";
																			if (moveCrit2 == 1) {
																				extra = " E' superefficace!";
																			}
																			var moveEffect = ""
																			if (enemy_dmg_boost > 0) {
																				moveEffect = "Aumentati grazie al potere della mossa di fuoco!\n";
																			}
																			if (protection > 0) {
																				moveEffect = "Ridotti a causa della protezione!\n";
																			}
																			if (enemy_high_dmg > 0) {
																				if (enemy_over == 0)
																					moveEffect += "Dei quali " + formatNumber(enemy_high_dmg) + " per colpo pesante!\n";
																				else
																					moveEffect += "Dei quali " + formatNumber(enemy_high_dmg) + " per colpo pesante (con i quali ha superato la difesa)!\n";
																			}
																			if (conf_dmg > 0) {
																				moveEffect += "Dei quali " + formatNumber(conf_dmg) + " derivano dall'esserti colpito da solo!\n";
																			}
																			bot.sendMessage(message.chat.id, "Il drago avversario ti infligge " + formatNumber(enemy_damage) + " danni" + enemy_crit_txt + " con " + enemy_move_name + "!" + extra + "\n" + moveEffect, kbNext);
																		}

																		if ((dragon_scale + 1) <= 5) {
																			connection.query('UPDATE dragon SET scale = ' + (dragon_scale + 1) + ' WHERE id = ' + dragon_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																		if ((enemy_dragon_scale + 1) <= 5) {
																			connection.query('UPDATE ' + target_table_dragon + ' SET scale = ' + (enemy_dragon_scale + 1) + ' WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		};
																	});
																});
															});
														});
													});
												});
											};
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
});

function esitoScontro(message, dragon_level, enemy_dragon_level, dragon_arms_id, player_id, enemy_dragon_name, rank, chat_id2) {
	var money = 0;
	var chest = 1;
	var randM = Math.random() * 100;
	var bonus_money = "";
	if (randM < 30) {
		money = dragon_level * getRandomArbitrary(15, 30);
		money = Math.round(money);
		bonus_money = " (Bonus: " + formatNumber(money) + " Â§)";
	}

	if (dragon_level > (enemy_dragon_level + 50)) {
		chest = 0;
	}

	if (dragon_arms_id == 714) {
		var randS = Math.random() * 100;
		if (randS < 50) {
			chest++;
		}
	}

	var extra = "";
	if (chest == 1) {
		extra = " ed uno Scrigno Scaglia!";
		addChest(player_id, 9);
	} else if (chest > 1) {
		extra = " e " + chest + " Scrigni Scaglia!";
		addChest(player_id, 9, chest);
	}

	connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
	});

	bot.sendMessage(message.chat.id, "Hai sconfitto <b>" + enemy_dragon_name + "</b>, hai ottenuto " + rank + " Ã" + extra + bonus_money, kbBack);

	bot.sendMessage(chat_id2, "Il tuo drago Ã¨ stato sconfitto nella vetta da " + dragon_name + "! Fallo riposare per tornare a combattere!");
}

bot.onText(/team/i, function (message) {

	if (message.text.indexOf("paga") != -1) {
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		helpMsg(message.chat.id, player_id, 4);

		var new_price = 5000;
		var price_drop = 0;
		var price_drop_msg = "";
		var n = new Date().getDay()
		var n2 = new Date().getDate();

		if (rows[0].team_time != null) {
			var d = new Date(rows[0].team_time);
			var long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Liste Membri', 'Hall of Fame'], ['Torna al menu']]
				}
			};

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + long_date, kb);
			return;
		}

		if (n == 0) {
			price_drop = 1;
			new_price = 3500;
			price_drop_msg = "*SOLO OGGI* ";
		}

		connection.query('SELECT team.id As team_id, name FROM team, team_player WHERE team.id = team_player.team_id AND player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [['Fonda nuovo'], ['Entra in uno esistente'], ['Liste Membri', 'Hall of Fame'], ['Torna al menu']]
					}
				};

				bot.sendMessage(message.chat.id, "I Team sono dei gruppi di battaglia utili negli per affrontare la temibile Scalata Boss e negli Incarichi, puoi crearlo (" + price_drop_msg + "ti costerÃ  " + new_price + " Â§) oppure entrare in uno giÃ  esistente!", kb);
			} else {
				var team_id = rows[0].team_id;
				connection.query('SELECT T2.name, T2.players FROM team T1 JOIN team T2 ON T1.child_team = T2.id WHERE T1.id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;

					var childName = "";
					var childPlayers = 0;
					if (Object.keys(rows).length > 0) {
						childName = rows[0].name;
						childPlayers = rows[0].players;
					}

					connection.query('SELECT T2.name, T2.players FROM team T1 JOIN team T2 ON T1.id = T2.id WHERE T1.child_team = ' + team_id, function (err, rows, fields) {
						if (err) throw err;

						var motherName = "";
						var motherPlayers = 0;
						if (Object.keys(rows).length > 0) {
							motherName = rows[0].name;
							motherPlayers = rows[0].players;
						}

						connection.query('SELECT team_player.role, team_player.player_id, player.nickname FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							var isAdmin = 0;
							var isViceAdmin = 0;

							if (rows[0].role == 1) {
								isAdmin = 1;
							}else if (rows[0].role == 2) {
								isViceAdmin = 1;
							}

							connection.query('SELECT player.id, player.nickname FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + team_id + ' AND role = 1', function (err, rows, fields) {
								if (err) throw err;

								var adminId = 0;
								var adminName = "";

								if (Object.keys(rows).length == 0) {
									connection.query('UPDATE team_player SET role = 1 WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
									});
									adminName = message.from.username;
									adminId = player_id;
								} else {
									adminName = rows[0].nickname;
									adminId = rows[0].id;
								}

								connection.query('SELECT player.id, player.nickname FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + team_id + ' AND role = 2', function (err, rows, fields) {
									if (err) throw err;

									var viceAdminId = 0;
									var viceAdminName = "";

									if (Object.keys(rows).length > 0) {
										viceAdminName = rows[0].nickname;
										viceAdminId = rows[0].id;
									}

									connection.query('SELECT id FROM boss_team WHERE team_id = ' + team_id + ' AND unlocked = 1 AND killedby IS NULL ORDER BY id ASC', function (err, rows, fields) {
										if (err) throw err;

										var att_boss = 0;
										if (Object.keys(rows).length > 0) {
											att_boss = rows[0].id;
										}

										connection.query('SELECT team_player.player_id, role, boss_damage.boss_id, SUM(damage) As dmg, COUNT(damage) As dmg_cnt FROM player, boss_damage RIGHT JOIN team_player ON team_player.player_id = boss_damage.player_id WHERE player.id = team_player.player_id AND team_player.team_id = ' + team_id + ' AND boss_damage.boss_id = ' + att_boss + ' GROUP BY team_player.player_id ORDER BY player.reborn DESC, player.exp DESC', function (err, rows, fields) {
											if (err) throw err;

											var list_dmg = [];
											var list_dmg_cnt = [];

											if (Object.keys(rows).length > 0) {
												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													list_dmg[rows[i].player_id] = rows[i].dmg;
													list_dmg_cnt[rows[i].player_id] = rows[i].dmg_cnt;
												}
											}

											connection.query('SELECT mission_team_party_player.party_id, team.mission_count, team.slogan, team.kill_num1, team.kill_num2, team.boost_id, team.point, class.name As class_name, team_player.*, last_command.time, team.craft_count As team_craft, (SELECT COUNT(*) FROM team_player WHERE team_id = ' + team_id + ') As cnt, player.id As player_id, player.rank, player.weapon, player.mission_time_end, player.travel_time_end, player.cave_time_end, player.holiday, player.ability, player.reborn, player.nickname, player.craft_count, player.life, player.total_life, player.exp, team.name, team.players, team.details, team.max_players, team.boss_count, team.level, team.closed, SUM(boss_damage.damage) As dmg, COUNT(boss_damage.damage) As dmg_cnt FROM last_command, team_player LEFT JOIN boss_damage ON boss_damage.player_id = team_player.player_id LEFT JOIN mission_team_party_player ON team_player.player_id = mission_team_party_player.player_id, player, team, class WHERE player.class = class.id AND team.id = team_player.team_id AND team_player.player_id = player.id AND team_player.team_id = ' + team_id + ' AND player.account_id = last_command.account_id GROUP BY nickname ORDER BY team_player.role = 0, team_player.role, player.reborn DESC, player.exp DESC', function (err, rows, fields) {
												if (err) throw err;
												var iKeys = [];
												var teamName = rows[0].name;
												var closed = rows[0].closed;
												var details = rows[0].details;
												var team_craft = rows[0].team_craft;
												var mission_count = rows[0].mission_count;

												var num_members = rows[0].cnt;
												connection.query('UPDATE team SET players = ' + num_members + ' WHERE id = ' + team_id, function (err, rows, fields) {
													if (err) throw err;
												});

												if (rows[0].max_players == 19) {
													connection.query('UPDATE team SET max_players = 20 WHERE id = ' + team_id, function (err, rows, fields) {
														if (err) throw err;
													});
												}

												var user_text = "\n\n\n<b>Membri nel team:</b>\n\n";
												var user_text2 = "";
												var partial_text = "\n\n<b>AttivitÃ  membri:</b>\n\n";

												var stars = "";
												var lev = 0;
												var weapon_d = 0;
												var dragon_claws = 0;
												var act = "";
												var d = new Date();
												var long_date = "";
												var last = "";
												var suspended = "";
												var nickname = "";
												var class_name = "";
												var life = 0;
												var total_life = 0;
												var craft_count = 0;
												var ability = 0;
												var dmg = 0;
												var dmg_cnt = 0;
												var dmg2 = 0;
												var dmg_cnt2 = 0;
												var base_text = "";
												var party = "";
												var party_line = "";
												var admin = "";

												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													if (rows[i].dmg == null) {
														rows[i].dmg = 0;
													}
													stars = "";
													if (rows[i].reborn >= 2) {
														stars = rebSym(rows[i].reborn);
													}
													admin = "";
													if (rows[i].role == 1)
														admin = "ðŸ‘‘ ";
													else if (rows[i].role == 2)
														admin = "ðŸ”° ";
													else
														admin = "ðŸ‘¤ ";

													lev = Math.floor(rows[i].exp / 10);

													if (rows[i].mission_time_end != null) {
														d = new Date(rows[i].mission_time_end);
														long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
														act = "ðŸƒðŸ½ Missione (" + long_date + ")";
													} else if (rows[i].travel_time_end != null) {
														d = new Date(rows[i].travel_time_end);
														long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
														act = "ðŸƒ ðŸ½Viaggio (" + long_date + ")";
													} else if (rows[i].cave_time_end != null) {
														d = new Date(rows[i].cave_time_end);
														long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
														act = "ðŸƒðŸ½ Cava (" + long_date + ")";
													} else if (rows[i].holiday == 1) {
														act = "â›± Vacanza";
													} else {
														act = "";
													}

													if (rows[i].role == 0) {
														d = new Date(rows[i].time);
														last = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();
													} else {
														last = "Nascosto";
													}

													if (rows[i].suspended == 1) {
														suspended = " ðŸ’¬";
													} else {
														suspended = "";
													}

													var act_line = "";
													if ((act != "") || (suspended != "")) {
														act_line = act + suspended + "\n";
													}

													nickname = rows[i].nickname;
													class_name = rows[i].class_name;
													life = rows[i].life;
													total_life = rows[i].total_life;
													craft_count = rows[i].craft_count;
													ability = rows[i].ability;
													dmg = rows[i].dmg;
													dmg_cnt = rows[i].dmg_cnt;
													rank = rows[i].rank;
													party = rows[i].party_id;

													if (party != null){
														party_line = "ðŸ‘¥ Assegnato al Party " + party + "\n";
													}else{
														party_line = "";
													}

													if (list_dmg[rows[i].player_id] == undefined) {
														dmg2 = 0;
														dmg_cnt2 = 0;
													} else {
														dmg2 = list_dmg[rows[i].player_id];
														dmg_cnt2 = list_dmg_cnt[rows[i].player_id];
													}

													if (dmg2 == null) {
														dmg2 = 0;
													}

													base_text = admin + "<i>" + nickname + "</i> " + stars + " " + lev + " \n" +
														"ðŸ¹ " + class_name + "\n" +
														act_line +
														party_line +
														"ðŸ• " + last + "\n" +
														"â¤ï¸ " + life + "/" + total_life + " hp\n" +
														"ðŸ“¦ " + craft_count + " pnt creazione\n" +
														"ðŸ”¦ " + ability + " abilitÃ \n" +
														"ðŸ›¡ " + rank + " rango\n" +
														"ðŸ“ˆ " + dmg + " danni/" + dmg_cnt + " colpi scalata\n" +
														"ðŸ— " + dmg2 + " danni/" + dmg_cnt2 + " colpi boss attuale\n\n";

													partial_text += admin + "<i>" + nickname + "</i> " + stars + " " + lev + " \n" +
														act_line + "ðŸ— " + dmg2 + " danni/" + dmg_cnt2 + " colpi boss attuale\n\n";

													if (i < 10) {
														user_text += base_text;
													} else {
														user_text2 += base_text;
													}
												}

												if (isAdmin == 1) {
													// ADMIN
													var show_type = "Aperto";
													var show_details = "Visibili";
													iKeys.push(["Scalata Boss ðŸ—", "Incarichi ðŸ“œ (Beta)"]);
													iKeys.push(["Dettaglio Membri ðŸ‘¥"]);
													iKeys.push(["Aumenta Posti âœš", "Accademia ðŸ£"]);
													iKeys.push(["Potenziamenti Anima ðŸ¦‹"]);
													iKeys.push(["Cambia Admin ðŸ‘‘", "Cambia Nome ðŸ’¬", "Slogan ðŸ“ƒ"]);
													iKeys.push(["Hall of Fame ðŸ†", "Liste Membri ðŸ”Ž"]);
													iKeys.push(["Sciogli âŒ", "Limite ðŸš«", "Notifiche ðŸ’¤"]);
													if (closed == 1)
														show_type = "Chiuso";
													if (details == 1)
														show_details = "Non Visibili";
													iKeys.push(["Tipo: " + show_type, "Dettagli: " + show_details]);

													iKeys.push(["Torna al menu"]);
												} else {
													// UTENTE
													iKeys.push(["Scalata Boss ðŸ—", "Incarichi ðŸ“œ (Beta)"]);
													if (details == 1)
														iKeys.push(["Dettaglio Membri ðŸ‘¥"]);
													iKeys.push(["Potenziamenti Anima ðŸ¦‹"]);
													iKeys.push(["Hall of Fame ðŸ†", "Notifiche ðŸ’¤"]);
													iKeys.push(["Liste Membri ðŸ”Ž", "Lascia âŒ"]);
													iKeys.push(["Torna al menu"]);
												}

												var kb = {
													parse_mode: "HTML",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": iKeys
													}
												};

												var level = rows[0].level;
												var bonus = 0;
												var bonus_parz = 0;
												var bonus_compl = 0;

												if (rows[0].kill_num1 > 0)
													bonus_parz = Math.floor(Math.log(rows[0].kill_num1) * 1000) + 800;

												if (rows[0].kill_num2 > 0)
													bonus_compl = Math.floor(Math.log2(rows[0].kill_num2) * 1500) + 1500;

												bonus = (100 * rows[0].level) + bonus_parz + bonus_compl;

												var boost_name = "";
												if (rows[0].boost_id == 1) {
													boost_name = " (Temporaneo: Unione Fatale)";
												} else if (rows[0].boost_id == 2) {
													boost_name = " (Temporaneo: Bottino Ricco)";
												} else if (rows[0].boost_id == 3) {
													boost_name = " (Temporaneo: Formazione Impenetrabile)";
												}

												var text = "ðŸ† <b>" + teamName + "</b>\n";
												if (rows[0].slogan != null)
													text += "ðŸ“ƒ <i>" + rows[0].slogan + "</i>\n";
												text += "ðŸ‘¥ " + rows[0].players + "/" + rows[0].max_players + " (+" + bonus + " Â§ + bonus)\n";
												text += "ðŸ— " + rows[0].boss_count + " sconfitti\n";
												text += "ðŸ“¦ " + formatNumber(team_craft) + " punti\n";
												text += "ðŸ“Š " + rows[0].kill_num1 + " Parziali\n";
												text += "ðŸ“ˆ " + rows[0].kill_num2 + " Complete\n";
												text += "ðŸ“œ " + mission_count + " Incarichi\n";
												text += "ðŸ¦‹ " + rows[0].point + " ðŸ¦‹" + boost_name + "\n";
												if (isAdmin == 1) {
													text += "Usa '/messaggio testo' per scrivere al team";
												} else {
													text += "ðŸ‘‘ " + adminName;
												}
												if (viceAdminId != 0)
													text += "\nðŸ”° " + viceAdminName;
												if (childName != "") {
													text += "\n\nAccademia " + childName + " (+1 ðŸ¦‹/boss)";
												}
												if (motherName != "") {
													if (childName == "")
														text += "\n";
													text += "\nTeam Madre " + motherName;
												}

												if ((isAdmin == 1) || (isViceAdmin == 1) || (details == 1)) {
													text += partial_text;
												}

												bot.sendMessage(message.chat.id, text, kb).then(function () {
													answerCallbacks[message.chat.id] = function (answer) {
														if (answer.text.indexOf("Dettaglio Membri") != -1) {
															var extra = 0;
															var text = "";

															if (isAdmin == 1){
																var kb = {
																	parse_mode: "HTML",
																	reply_markup: {
																		resize_keyboard: true,
																		//one_time_keyboard: true,
																		"keyboard": [['Gestisci Membri'], ['Torna al team']]
																	}
																};
															}else{
																var kb = {
																	parse_mode: "HTML",
																	reply_markup: {
																		resize_keyboard: true,
																		//one_time_keyboard: true,
																		"keyboard": [['Torna al team']]
																	}
																};
															}

															if ((isAdmin == 1) || (isViceAdmin == 1) || (details == 1)) {
																text += user_text;
																extra = 1;
																bot.sendMessage(message.chat.id, text, kb);
																if ((rows[0].players >= 11) && (extra == 1)) {
																	setTimeout(function () {
																		bot.sendMessage(message.chat.id, user_text2, kb);
																	}, 500);
																}
															} else {
																bot.sendMessage(message.chat.id, "Non sei abilitato a visualizzare la lista dei membri", team);
															}
														}
													};
												});
											});
										});
									});
								});
							});
						});
					});
				});
			}
		});
	});
});

bot.onText(/^incarichi|torna agli incarichi/i, function (message) {
	connection.query('SELECT id, holiday, gender, travel_id, cave_id, mission_id, mission_special_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		var travel_id = rows[0].travel_id;
		var cave_id = rows[0].cave_id;
		var mission_id = rows[0].mission_id;
		var mission_special_id = rows[0].mission_special_id;

		connection.query('SELECT * FROM team_player WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT mission_day_count FROM team WHERE id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
				var mission_day_count = rows[0].mission_day_count;

				connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					var isAdmin = 0;

					if ((rows[0].role == 1) || (rows[0].role == 2)) {
						isAdmin = 1;
					}

					connection.query('SELECT P1.assigned_to FROM mission_team_party P1, mission_team_party_player P2 WHERE P1.team_id = P2.team_id AND P1.party_id = P2.party_id AND P2.player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						var my_assigned_to = 0;
						if (Object.keys(rows).length > 0)
							my_assigned_to = rows[0].assigned_to;

						connection.query('SELECT T.id, T.parts, T.title, T.description, T.duration, M.party_id, T.requirement_id, M.part_id, T.mandator FROM mission_team_list T LEFT JOIN mission_team_party M ON T.id = M.assigned_to AND T.ready = 1 AND M.team_id = ' + team_id + ' ORDER BY T.duration ASC', function (err, rows, fields) {
							if (err) throw err;

							var iKeys = [];
							var assigned = "";
							var text = "Benvenut" + gender_text + " negli <b>Incarichi</b> ðŸ“œ!\nIl team puÃ² iniziare al massimo " + missionDayLimit + " incarichi al giorno (" + (missionDayLimit-mission_day_count) + " rimanenti), forma un party per inviarlo in missione. A maggiori difficoltÃ  si ottengono migliori ricompense!\nIncarichi disponibili per il tuo team:\n\n";
							var progress = "";
							var my_assigned = "";
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								if (rows[i].id == my_assigned_to){
									my_assigned = "ðŸ“";
								}else{
									my_assigned = "";
								}
								if (rows[i].party_id != null) {
									assigned = " âœ… (Assegnato al Party " + rows[i].party_id + ") " + my_assigned;
									progress = "Progresso: " + rows[i].part_id + "/" + rows[i].parts;
								} else {
									assigned = " ðŸš« (Non assegnato)";
									progress = "Scelte: " + rows[i].parts;
								}
								var rowsCnt = connection_sync.query('SELECT AVG(complex) As cnt FROM mission_team_requirement WHERE requirement_id = ' + rows[i].requirement_id);
								text += "<b>" + rows[i].title + "</b>" + assigned + "\nMandante: " + rows[i].mandator + "\n<i>" + truncate(rows[i].description, 100) + "</i>\nDurata: " + toTime(rows[i].duration*(rows[i].parts+1)) + " (" + toTime(rows[i].duration) + "/scelta) â³\nDifficoltÃ : " + Math.round(rowsCnt[0].cnt*10)/10 + "/10 ðŸ“ˆ\n" + progress + " ðŸ—º\n\n";
								iKeys.push([rows[i].title]);
							}

							text += "Gli incarichi vengono aggiornati ogni tanto, considera la versione Beta per segnalare i problemi che riscontri. Durante gli incarichi non puoi svolgere missioni, viaggi o itinerari.";

							if (isAdmin == 1)
								iKeys.push(["Gestisci Party ðŸ‘¥", "Il mio Party ðŸ‘¥"], ["Torna al team", "Torna al menu"])
							else
								iKeys.push(["Il mio Party ðŸ‘¥"], ["Torna al team", "Torna al menu"])

							var kb = {
								parse_mode: "HTML",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": iKeys
								}
							};

							var kbBack = {
								parse_mode: "HTML",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Torna ai party"], ["Torna al team"]]
								}
							};

							var kbBack2 = {
								parse_mode: "HTML",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Torna agli incarichi"], ["Torna al team"]]
								}
							};

							var kbBack3 = {
								parse_mode: "HTML",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Torna agli incarichi"], ["Torna al team"], ["Torna al menu"]]
								}
							};

							var kbBack4 = {
								parse_mode: "HTML",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Torna ai party"], ["Torna agli incarichi"], ["Torna al team"]]
								}
							};

							bot.sendMessage(message.chat.id, text, kb).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if ((answer.text.toLowerCase().indexOf("il mio party") != -1) || (answer.text.toLowerCase().indexOf("gestisci party") != -1) || (answer.text == "Torna al team") || (answer.text == "Torna al menu")) {
										return;
									} else {

										if (teamMission == 0){
											bot.sendMessage(message.chat.id, "L'ufficio incarichi non ha ancora terminato le nuove missioni, torna tra poco!", kbBack2);
											return;
										}

										connection.query('SELECT id, title, description, duration, parts, ready FROM mission_team_list WHERE title = "' + answer.text + '"', function (err, rows, fields) {
											if (err) throw err;
											if (Object.keys(rows).length == 0) {
												bot.sendMessage(message.chat.id, "Incarico non valido, riprova", kbBack);
												return;
											}
											if (rows[0].ready == 0){
												bot.sendMessage(message.chat.id, "Questo incarico non Ã¨ ancora pronto, torna tra poco!", kbBack2);
												return;
											}
											var mission_title = rows[0].title;
											var mission_text = rows[0].description;
											var mission_id = rows[0].id;
											var mission_duration = rows[0].duration;
											var mission_parts = rows[0].parts;

											connection.query('SELECT type, value, member FROM mission_team_requirement WHERE requirement_id = ' + mission_id, function (err, req, fields) {
												if (err) throw err;
												var text = "Requisiti per l'incarico:\n";
												var textReq = "";
												var type = "";
												var member = "";
												var value = 0;
												var reqLen = Object.keys(req).length;

												for (var i = 0; i < reqLen; i++) {

													value = req[i].value;

													if (req[i].type == "level")
														type = "Livello minimo (assoluto): ";
													else if (req[i].type == "reborn") {
														type = "Rinascita minima: ";
														value -= 1;
													} else if (req[i].type == "members")
														type = "Membri minimi: ";
													else if (req[i].type == "class") {
														type = "Vocazione: ";
														value = idToClass(value);
													} else if (req[i].type == "craft")
														type = "Punti creazione: ";
													else if (req[i].type == "rank")
														type = "Rango: ";
													else if (req[i].type == "team_boss")
														type = "Boss uccisi (team): ";
													else if (req[i].type == "team_parz")
														type = "Scalate parziali (team): ";
													else if (req[i].type == "team_compl")
														type = "Scalate complete (team): ";
													else if (req[i].type == "dragon_lev")
														type = "Livello minimo drago: ";

													if (req[i].type.indexOf("team") != -1){
														member = " per il team";
													}else{
														if (req[i].member == "all")
															member = " per tutti i membri del party";
														else if (req[i].member > 1)
															member = " per almeno " + req[i].member + " membri del party";
														else if (req[i].member == 1)
															member = " per almeno 1 membro del party";
													}

													text += type + value + member + "\n";
													textReq += "> " + type + value + member + "\n";
												}

												connection.query('SELECT party_id, team_id, part_id, mission_start, mission_time_end, mission_time_limit FROM mission_team_party WHERE team_id = ' + team_id + ' AND assigned_to = ' + mission_id, function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length > 0) {
														var textMiss = "";
														var part_id = rows[0].part_id;
														var start_date = new Date(rows[0].mission_start);
														var part_date = new Date(rows[0].mission_time_end);
														var end_date = new Date(rows[0].mission_time_limit);

														connection.query('SELECT P.nickname FROM player P, mission_team_party_player M WHERE P.id = M.player_id AND M.team_id = ' + team_id + ' AND M.party_id = ' + rows[0].party_id, function (err, rows, fields) {
															if (err) throw err;

															var nickname_list = "";
															for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																nickname_list += rows[i].nickname + ", ";
															}
															nickname_list = nickname_list.slice(0, -2);

															textMiss += "<i>" + mission_title + "</i>\n";
															textMiss += "<b>Partecipanti</b>: " + nickname_list + "\n";
															textMiss += "<b>Requisiti</b>:\n" + textReq;
															//textMiss += "<b>Ricompense</b>:\n?\n";
															textMiss += "<b>Progresso</b>: " + part_id + "/" + mission_parts + "\n";
															textMiss += "<b>Inizio</b>: " + addZero(start_date.getHours()) + ":" + addZero(start_date.getMinutes()) + "\n";
															textMiss += "<b>Prossima parte</b>: " + addZero(part_date.getHours()) + ":" + addZero(part_date.getMinutes()) + "\n";
															textMiss += "<b>Scadenza</b>: " + addZero(end_date.getHours()) + ":" + addZero(end_date.getMinutes());

															bot.sendMessage(message.chat.id, textMiss, kbBack2);
														});
														return;
													}else if (isAdmin == 0){
														bot.sendMessage(message.chat.id, "Solo l'amministratore puÃ² assegnare un Incarico", kbBack2);
														return;
													}

													connection.query('SELECT id, party_id FROM mission_team_party WHERE assigned_to IS NULL AND team_id = ' + team_id, function (err, rows, fields) {
														if (err) throw err;

														var iKeys = [];
														if (Object.keys(rows).length > 0){
															for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																iKeys.push(["Assegna a Party " + rows[i].party_id]);
															}
														}
														iKeys.push(["Torna agli incarichi"]);
														iKeys.push(["Torna al menu"]);

														var kb2 = {
															parse_mode: "HTML",
															reply_markup: {
																resize_keyboard: true,
																//one_time_keyboard: true,
																"keyboard": iKeys
															}
														};

														connection.query('SELECT mission_day_count FROM team WHERE id = ' + team_id, function (err, rows, fields) {
															if (err) throw err;
															if (rows[0].mission_day_count >= missionDayLimit){
																bot.sendMessage(message.chat.id, "Hai raggiunto il limite giornaliero di incarichi", kbBack);
																return;
															}

															bot.sendMessage(message.chat.id, text, kb2).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if ((answer.text == "Torna agli incarichi") || (answer.text == "Torna al menu")) {
																		return;
																	}

																	var split = answer.text.split(" ");
																	var party_id = split[3];

																	if (party_id == undefined){
																		bot.sendMessage(message.chat.id, "Party non valido, riprova", kbBack);
																		return;
																	}

																	connection.query('SELECT id, party_id FROM mission_team_party WHERE assigned_to IS NULL AND team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
																		if (err) throw err;

																		if (Object.keys(rows).length == 0) {
																			bot.sendMessage(message.chat.id, "Party non valido, riprova", kbBack);
																			return;
																		}

																		connection.query('SELECT boss_count, kill_num1, kill_num2 FROM team WHERE id = ' + team_id, function (err, teamRows, fields) {
																			if (err) throw err;

																			connection.query('SELECT mission_team_party_player.player_id, player.chat_id, player.exp, player.reborn, player.craft_count, player.class, player.rank, player.mission_id, player.nickname, player.life, dragon.level, player.cave_id, player.travel_id, player.holiday FROM mission_team_party_player, player LEFT JOIN dragon ON player.id = dragon.player_id WHERE player.id = mission_team_party_player.player_id AND team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
																				if (err) throw err;
																				var err = 0;
																				var errMsg = "";
																				var partyLen = Object.keys(rows).length;
																				var reqVal = 0;
																				var reqValMax = 0;

																				var inMiss = "";
																				for (var j = 0; j < partyLen; j++) {
																					if (rows[j].mission_id != 0) {
																						inMiss += "> " + rows[j].nickname + "\n";
																					}
																				}
																				var inTravel = "";
																				for (var j = 0; j < partyLen; j++) {
																					if (rows[j].travel_id != 0) {
																						inTravel += "> " + rows[j].nickname + "\n";
																					}
																				}
																				var inCave = "";
																				for (var j = 0; j < partyLen; j++) {
																					if (rows[j].cave_id != 0) {
																						inCave += "> " + rows[j].nickname + "\n";
																					}
																				}
																				var inHoliday = "";
																				for (var j = 0; j < partyLen; j++) {
																					if (rows[j].holiday != 0) {
																						inHoliday += "> " + rows[j].nickname + "\n";
																					}
																				}

																				if (team_id != 2){
																					var inMissTxt = "";
																					if (inMiss != "")
																						inMissTxt = "Membri impegnati in missione:\n" + inMiss + "\n";
																					var inTravelTxt = "";
																					if (inTravel != "")
																						inTravelTxt = "Membri impegnati in viaggio:\n" + inTravel + "\n";
																					var inCaveTxt = "";
																					if (inCave != "")
																						inCaveTxt = "Membri impegnati in cava:\n" + inCave + "\n";
																					var inHolidayTxt = "";
																					if (inHoliday != "")
																						inHolidayTxt = "Membri in vacanza:\n" + inHoliday + "\n";

																					if ((inMiss != "") || (inTravel != "") || (inCave != "") || (inHoliday != "")){
																						bot.sendMessage(message.chat.id, inMissTxt + inTravelTxt + inCaveTxt + inHolidayTxt, kbBack4);
																						return;
																					}
																				}

																				var noHealth = "";
																				for (var j = 0; j < partyLen; j++) {
																					if (rows[j].life == 0) {
																						noHealth += "> " + rows[j].nickname + "\n";
																					}
																				}

																				if (noHealth != "") {
																					bot.sendMessage(message.chat.id, "Membri non in salute:\n" + noHealth, kbBack);
																					return;
																				}

																				for (var i = 0; i < reqLen; i++) {
																					if (req[i].type == "level") {
																						reqVal = 0;
																						reqValMax = req[i].member;
																						if (reqValMax == "all")
																							reqValMax = partyLen;
																						for (var j = 0; j < partyLen; j++) {
																							if (getRealLevel(rows[j].reborn, Math.floor(rows[j].exp / 10)) >= req[i].value)
																								reqVal++;
																						}
																						if (reqVal < reqValMax) {
																							err = 1;
																							errMsg = "Livello non soddisfatto (" + reqVal + " su " + reqValMax + " necessari)";
																						}
																					}
																					if (req[i].type == "reborn") {
																						reqVal = 0;
																						reqValMax = req[i].member;
																						if (reqValMax == "all")
																							reqValMax = partyLen;
																						for (var j = 0; j < partyLen; j++) {
																							if (rows[j].reborn >= req[i].value)
																								reqVal++;
																						}
																						if (reqVal < reqValMax) {
																							err = 1;
																							errMsg = "Rinascita non soddisfatta (" + reqVal + " su " + reqValMax + " necessari)";
																						}
																					}
																					if (req[i].type == "members") {
																						reqVal = 0;
																						if (partyLen < req[i].value) {
																							err = 1;
																							errMsg = "Membri non soddisfatti (" + partyLen + " su " + req[i].value + " necessari)";
																						}
																					}
																					if (req[i].type == "class") {
																						reqVal = 0;
																						reqValMax = req[i].member;
																						if (reqValMax == "all")
																							reqValMax = partyLen;
																						for (var j = 0; j < partyLen; j++) {
																							if (rows[j].class == req[i].value)
																								reqVal++;
																						}
																						if (reqVal < reqValMax) {
																							err = 1;
																							errMsg = "Vocazione non soddisfatta (" + reqVal + " su " + reqValMax + " necessari)";
																						}
																					}
																					if (req[i].type == "craft") {
																						reqVal = 0;
																						reqValMax = req[i].member;
																						if (reqValMax == "all")
																							reqValMax = partyLen;
																						for (var j = 0; j < partyLen; j++) {
																							if (rows[j].craft_count >= req[i].value)
																								reqVal++;
																						}
																						if (reqVal < reqValMax) {
																							err = 1;
																							errMsg = "Punti creazioni non soddisfatti (" + reqVal + " su " + reqValMax + " necessari)";
																						}
																					}
																					if (req[i].type == "rank") {
																						reqVal = 0;
																						reqValMax = req[i].member;
																						if (reqValMax == "all")
																							reqValMax = partyLen;
																						for (var j = 0; j < partyLen; j++) {
																							if (rows[j].rank >= req[i].value)
																								reqVal++;
																						}
																						if (reqVal < reqValMax) {
																							err = 1;
																							errMsg = "Rango non soddisfatto (" + reqVal + " su " + reqValMax + " necessari)";
																						}
																					}
																					if (req[i].type == "team_boss") {
																						reqVal = 0;
																						if (teamRows[0].boss_count < req[i].value) {
																							err = 1;
																							errMsg = "Uccisioni boss non soddisfatte (" + teamRows[0].boss_count + " su " + req[i].value + " necessari)";
																						}
																					}
																					if (req[i].type == "team_parz") {
																						reqVal = 0;
																						if (teamRows[0].kill_num1 < req[i].value) {
																							err = 1;
																							errMsg = "Scalate parziali non soddisfatte (" + teamRows[0].kill_num1 + " su " + req[i].value + " necessari)";
																						}
																					}
																					if (req[i].type == "team_compl") {
																						reqVal = 0;
																						if (teamRows[0].kill_num2 < req[i].value) {
																							err = 1;
																							errMsg = "Scalate complete non soddisfatte (" + teamRows[0].kill_num2 + " su " + req[i].value + " necessari)";
																						}
																					}
																					if (req[i].type == "dragon_lev") {
																						reqVal = 0;
																						reqValMax = req[i].member;
																						if (reqValMax == "all")
																							reqValMax = partyLen;
																						for (var j = 0; j < partyLen; j++) {
																							if (rows[j].level != null)
																								if (rows[j].level >= req[i].value)
																									reqVal++;
																						}
																						if (reqVal < reqValMax) {
																							err = 1;
																							errMsg = "Livello drago non soddisfatto (" + reqVal + " su " + reqValMax + " necessari)";
																						}
																					}
																				}

																				if (err == 0) {
																					var d = new Date();
																					d.setSeconds(d.getSeconds() + mission_duration);
																					var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
																					var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

																					var d2 = new Date();
																					d2.setSeconds(d2.getSeconds() + (mission_duration*(mission_parts*3)));
																					var long_date2 = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());
																					var short_date2 = addZero(d2.getHours()) + ':' + addZero(d2.getMinutes());

																					for (var j = 0; j < partyLen; j++) {
																						bot.sendMessage(rows[j].chat_id, "Il tuo party Ã¨ stato assegnato all'incarico <b>" + mission_title + "</b> fino alle " + short_date + ", scadrÃ  alle " + short_date2 + "!\n\n<i>" + mission_text + "</i>\nSe non vedi la schermata di votazione dopo il tempo di attesa usa /incarico.", html);
																						connection.query('UPDATE player SET mission_party = 1 WHERE id = ' + rows[j].player_id, function (err, rows, fields) {
																							if (err) throw err;
																						});
																					}

																					connection.query('UPDATE mission_team_party SET wait = 0, part_id = 0, mission_start = "' + toDate("en", new Date()) + '", mission_time_limit = "' + long_date2 + '", mission_time_end = "' + long_date + '", assigned_to = ' + mission_id + ' WHERE team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
																						if (err) throw err;
																						bot.sendMessage(message.chat.id, "Party assegnato all'incarico, inizierÃ  alle " + short_date + "!\nCompletatelo prima delle " + short_date2 + "!", kbBack3);
																					});
																					connection.query('UPDATE team SET mission_day_count = mission_day_count+1 WHERE id = ' + team_id, function (err, rows, fields) {
																						if (err) throw err;
																					});
																				} else {
																					bot.sendMessage(message.chat.id, "Errore requisiti: " + errMsg, kbBack2);
																				}
																			});
																		});
																	});
																};
															});
														});
													});
												});
											});
										});
									};
								};
							});
						});
					});
				});
			});
		});
	});
});

function truncate(text, maxlen) {
	var len = Object.keys(text).length;
	if (len > maxlen) {
		text = text.substr(0, maxlen) + "...";
	}
	return text;
}

function idToClass(classId) {
	const rows = connection_sync.query("SELECT name FROM class WHERE id = " + classId);
	return rows[0].name;
}

bot.onText(/^il mio party/i, function (message) {

	var kbBack = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna agli incarichi"]]
		}
	};

	connection.query('SELECT id, holiday FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		connection.query('SELECT * FROM team_player WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT party_id FROM mission_team_party_player WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Non sei in un party, contatta l'amministratore del team per essere aggiunto", kbBack);
					return;
				}
				var party_id = rows[0].party_id;
				connection.query('SELECT P.nickname, M.answ_id, M2.assigned_to, M2.wait FROM mission_team_party_player M, mission_team_party M2, player P WHERE M.player_id = P.id AND M2.party_id = M.party_id AND M2.team_id = M.team_id AND M.team_id = ' + team_id + ' AND M.party_id = ' + party_id, function (err, rows, fields) {
					if (err) throw err;
					var text = "Il tuo Party " + party_id + " Ã¨ formato da " + Object.keys(rows).length + " membri:\n\n";
					var voted = "";
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].assigned_to != null){
							if (rows[i].answ_id == 0){
								voted = " âŒ";
							}else{
								voted = " âœ…";
							}
							if (rows[i].wait == 0){
								voted = " â³";
							}
						}
						text += "> " + rows[i].nickname + voted + "\n";
					}
					bot.sendMessage(message.chat.id, text, kbBack);
				});	
			});
		});
	});
});

bot.onText(/^party$|gestisci party|torna ai party/i, function (message) {

	/*
	if (message.from.id != 20471035){
		bot.sendMessage(message.chat.id, "Manutenzione", back);
		return;
	}
	*/

	var kbBack = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna agli incarichi"]]
		}
	};

	var kbBack2 = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna ai party"]]
		}
	};

	var kbBack3 = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna ai party"],["Torna agli incarichi"]]
		}
	};

	var kbYesNo = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Si"], ["Torna ai party"]]
		}
	};

	connection.query('SELECT id, holiday FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		connection.query('SELECT * FROM team_player WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;

				if ((rows[0].role == 1) || (rows[0].role == 2)) {
					isAdmin = 1;
				} else {
					bot.sendMessage(message.chat.id, "Solo l'amministratore o il vice possono gestire i party", kbBack);
					return;
				}

				connection.query('SELECT P.nickname, M1.party_id, M1.assigned_to FROM mission_team_party M1, mission_team_party_player M2, player P WHERE M1.team_id = M2.team_id AND M2.player_id = P.id AND M1.party_id = M2.party_id AND M1.team_id = ' + team_id + ' ORDER BY M1.party_id', function (err, rows, fields) {
					if (err) throw err;

					var iKeys = [];
					var assigned = "";
					var text = "";
					var party_id_break = 0;
					if (Object.keys(rows).length > 0){
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (party_id_break != rows[i].party_id){
								if (rows[i].assigned_to != null){
									assigned = " âœ…";
								}else{
									assigned = " ðŸš«";
								}
								text += "\n<b>Party " + rows[i].party_id + "</b>" + assigned + ":\n";
								iKeys.push(["Party " + rows[i].party_id + assigned]);
								party_id_break = rows[i].party_id;
							}
							text += "> " + rows[i].nickname + "\n";
						}
					}else{
						text = "\n\nNessun party creato";
					}
					iKeys.push(["Nuovo âœš","Torna agli incarichi"]);
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona il party da gestire, non puoi eliminare un party che sta svolgendo un incarico.\nIl simbolo a fianco al numero indica se Ã¨ impegnato o meno." + text, kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if ((answer.text == "Torna agli incarichi") || (answer.text == "Torna al menu")) {
								return;
							} else if (answer.text.toLowerCase().indexOf("party") != -1) {
								var split = answer.text.split(" ");
								var party_id = parseInt(split[1]);

								if (isNaN(party_id)){
									bot.sendMessage(message.chat.id, "Il party richiesto non Ã¨ valido", kbBack);
									return;
								}

								connection.query('SELECT party_id, assigned_to FROM mission_team_party WHERE team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "Il party richiesto non esiste", kbBack);
										return;
									}

									var assigned = rows[0].assigned_to;

									connection.query('SELECT P.nickname, M.player_id FROM mission_team_party_player M, player P WHERE M.player_id = P.id AND M.team_id = ' + team_id + ' AND M.party_id = ' + party_id, function (err, rows, fields) {
										if (err) throw err;

										var iKeys = [];

										var text = "Il Party " + party_id + " Ã¨ formato da " + Object.keys(rows).length + " membri:\n\n";
										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											text += "> " + rows[i].nickname + "\n";
											iKeys.push(["Spia: " + rows[i].nickname])
										}

										iKeys.push(["Elimina âŒ", "Annulla Incarico ðŸš«"],["Torna ai party"])

										var kbDel = {
											parse_mode: "HTML",
											reply_markup: {
												resize_keyboard: true,
												//one_time_keyboard: true,
												"keyboard": iKeys
											}
										};

										bot.sendMessage(message.chat.id, text, kbDel).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text.indexOf("Elimina") != -1) {

													bot.sendMessage(message.chat.id, "Sei sicuro di voler eliminare il party?", kbYesNo).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text.toLowerCase() == "si"){
																if (assigned != null) {
																	bot.sendMessage(message.chat.id, "Non puoi eliminare un party assegnato ad un incarico!", kbBack);
																	return;
																}

																connection.query('SELECT P.id, P.chat_id FROM player P, mission_team_party_player M WHERE P.id = M.player_id AND M.party_id = ' + party_id + ' AND M.team_id = ' + team_id, function (err, rows, fields) {
																	if (err) throw err;
																	for(i = 0; i < Object.keys(rows).length; i++){
																		bot.sendMessage(rows[i].chat_id, "Il tuo Party Ã¨ stato sciolto dall'amministratore");
																	}
																	connection.query('DELETE FROM mission_team_report WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('DELETE FROM mission_team_party WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
																		if (err) throw err;
																		connection.query('DELETE FROM mission_team_party_player WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
																			bot.sendMessage(message.chat.id, "Party " + party_id + " eliminato!", kbBack3);
																			return;
																		});
																	});
																});
															}
														}
													});
												}else if (answer.text.indexOf("Annulla") != -1) {
													bot.sendMessage(message.chat.id, "Sei sicuro di voler annullare l'incarico del party?", kbYesNo).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text.toLowerCase() == "si"){
																connection.query('SELECT report_id, assigned_to FROM mission_team_party WHERE team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
																	if (err) throw err;

																	if (rows[0].assigned_to == null){
																		bot.sendMessage(message.chat.id, "Non puoi annullare un incarico se non Ã¨ stato assegnato", kbBack);
																		return;
																	}

																	connection.query('SELECT P.id, P.chat_id FROM player P, mission_team_party_player M WHERE P.id = M.player_id AND M.party_id = ' + party_id + ' AND M.team_id = ' + team_id, function (err, rows, fields) {
																		if (err) throw err;
																		for(i = 0; i < Object.keys(rows).length; i++){
																			bot.sendMessage(rows[i].chat_id, "L'incarico Ã¨ stato annullato dall'amministratore del team! Tutto il party torna al villaggio...");
																			connection.query('UPDATE player SET mission_party = 0 WHERE id = ' + rows[i].id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}
																	});

																	bot.sendMessage(message.chat.id, "Incarico annullato!", kbBack3);

																	connection.query('UPDATE team SET mission_day_count = mission_day_count-1 WHERE id = ' + team_id, function (err, rows, fields) {
																		if (err) throw err;
																	});

																	// Pulizia (aggiorna anche l'altra)
																	connection.query('UPDATE mission_team_party SET part_id = 0, assigned_to = NULL, report_id = NULL, mission_start = NULL, mission_time_end = NULL, wait = 0, mission_time_limit = NULL WHERE team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	connection.query('UPDATE mission_team_party_player SET answ_id = 0 WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
																		if (err) throw err;
																	});
																	var report_id = rows[0].report_id;
																	if (report_id != null){
																		connection.query('DELETE FROM mission_team_report WHERE team_id = ' + team_id + ' AND party_id = ' + party_id + ' AND report_id = ' + report_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}
																});
															}
														}
													});
												}
											}
										});
									});
								});
							} else if (answer.text.indexOf("Nuovo") != -1) {
								connection.query('SELECT P.nickname FROM player P, team_player T WHERE P.id NOT IN (SELECT player_id FROM mission_team_party_player) AND P.id = T.player_id AND T.team_id = ' + team_id, function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "Tutti i membri del team sono giÃ  in un party, eliminane prima di crearne uno nuovo", kbBack3);
										return;
									}

									if (team_id != 2) {
										if (Object.keys(rows).length < 3) {
											bot.sendMessage(message.chat.id, "Non ci sono abbastanza membri disponibili per formare un party", kbBack3);
											return;
										}
									}

									var text = "Membri disponibili:\n";
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										text += "> " + rows[i].nickname + "\n";
									}
									text += "\nScrivi la lista dei membri per il party separati da virgola, possono essere composti massimo da 5 giocatori, minimo da 3.";

									bot.sendMessage(message.chat.id, text, kbBack2).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text == "Torna ai party") {
												return;
											}

											var split = answer.text.split(",");
											var cnt = split.length;

											if (team_id != 2) {
												if (cnt < 3) {
													bot.sendMessage(message.chat.id, "Un party deve essere composto almeno da 3 persone", kbBack3);
													return;
												}
												if (cnt > 5) {
													bot.sendMessage(message.chat.id, "Un party puÃ² essere composto massimo da 5 persone", kbBack3);
													return;
												}
											}

											connection.query('SELECT party_id FROM mission_team_party WHERE team_id = ' + team_id, function (err, rows, fields) {
												if (err) throw err;

												var idList = [];
												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													idList.push(rows[i].party_id);
												}

												var miss = 1;
												if (Object.keys(rows).length > 0)
													miss = findMissing(idList);

												var tot = 0;
												var idArray = [];
												var nickArray = [];
												var chatIdArray = [];

												for (var i = 0; i < cnt; i++) {
													nickArray[i] = split[i].trim().toLowerCase();	// per confronto se piÃ¹ uguali
												}

												if (hasDuplicates(nickArray)){
													bot.sendMessage(message.chat.id, "Non puoi inserire lo stesso membro piÃ¹ di una volta", kbBack3);
													return;
												}

												for (var i = 0; i < cnt; i++) {
													var rows = connection_sync.query('SELECT P.id, P.chat_id FROM player P WHERE P.nickname = "' + nickArray[i] + '"');
													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, nickArray[i] + " non esiste", kbBack3);
														return;
													}
													idArray.push(rows[0].id);
													chatIdArray.push(rows[0].chat_id);
												}

												for (var i = 0; i < cnt; i++) {
													rows = connection_sync.query('SELECT id FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + idArray[i]);
													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, nickArray[i] + " non Ã¨ un membro del tuo team", kbBack3);
														return;
													}
												}

												for (var i = 0; i < cnt; i++) {
													rows = connection_sync.query('SELECT id FROM mission_team_party_player WHERE player_id = ' + idArray[i]);
													if (Object.keys(rows).length > 0) {
														bot.sendMessage(message.chat.id, nickArray[i] + " Ã¨ giÃ  impegnato in un party", kbBack3);
														return;
													}
												}

												connection_sync.query('INSERT INTO mission_team_party (team_id, party_id) VALUES (' + team_id + ',' + miss + ')');

												for (var i = 0; i < cnt; i++) {
													connection.query('INSERT INTO mission_team_party_player (team_id, party_id, player_id) VALUES (' + team_id + ',' + miss + ',' + idArray[i] + ')', function (err, rows, fields) {
														if (err) throw err;
													});
													bot.sendMessage(chatIdArray[i], "Sei stato assegnato al Party " + miss + " dall'amministratore del team!");
												}

												bot.sendMessage(message.chat.id, cnt + " membri assegnati al Party " + miss + "!", kbBack3);
											});
										};
									});
								});
							};
						};
					});
				});
			});
		});
	});
});

function hasDuplicates(array) {
	var valuesSoFar = Object.create(null);
	for (var i = 0; i < array.length; ++i) {
		var value = array[i];
		if (value in valuesSoFar) {
			return true;
		}
		valuesSoFar[value] = true;
	}
	return false;
}

bot.onText(/Potenziamenti Anima/i, function (message) {

	/*
	if (message.from.id != 20471035){
		bot.sendMessage(message.chat.id, "Pazienta", back)
		return;
	}
	*/

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT boost_id, level FROM team_boost WHERE team_id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var boost_list = "";
					if (Object.keys(rows).length > 0) {
						boost_list += "Potenziamenti permanenti:\n";
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if ((rows[i].boost_id == 1) && (rows[i].level > 0)) {
								boost_list += "> Unione Fatale (Livello " + rows[i].level + ", +" + (3 * rows[i].level) + "%)\n";
							}
							if ((rows[i].boost_id == 2) && (rows[i].level > 0)) {
								boost_list += "> Bottino Ricco (Livello " + rows[i].level + ", +" + (3 * rows[i].level) + "%)\n";
							}
							if ((rows[i].boost_id == 3) && (rows[i].level > 0)) {
								boost_list += "> Formazione Impenetrabile (Livello " + rows[i].level + ", -" + (3 * rows[i].level) + "%)\n";
							}
						}
					}

					connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
						if (err) throw err;
						var level = rows[0].level;
						var closed = rows[0].closed;
						var details = rows[0].details;
						var point = rows[0].point;
						var boost_id = rows[0].boost_id;

						if (isAdmin == 0) {
							bot.sendMessage(message.chat.id, "Il team possiede *" + point + "* ðŸ¦‹. Puoi ottenerne altri uccidendo i boss oppure partecipando agli eventi di team. Solo l'amministratore puÃ² procedere con i potenziamenti.\n\n" + boost_list, team)
							return;
						}

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Unione Fatale (40/200 ðŸ¦‹)"],
											 ["Bottino Ricco (60/300 ðŸ¦‹)"],
											 ["Formazione Impenetrabile (50/250 ðŸ¦‹)"],
											 ["Richiamo dei Guerrieri (200 ðŸ¦‹)"],
											 ["Torna al team"],
											 ["Torna al menu"]]
							}
						};

						var kbSel = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Temporaneo"], ["Permanente"], ["Torna ai potenziamenti anima"]]
							}
						};

						var kbYesNo = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Si"], ["Torna ai potenziamenti anima"]]
							}
						};

						var kbBack = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Torna ai potenziamenti anima"]]
							}
						};

						bot.sendMessage(message.chat.id, "Il tuo team possiede *" + point + "* ðŸ¦‹. Puoi ottenerne altri uccidendo i boss oppure partecipando agli eventi di team. Seleziona un potenziamento da attivare.\n\n" + boost_list, kb).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if ((answer.text == "Torna al team") || (answer.text == "Torna al menu")) {
									return;
								}

								if (answer.text.indexOf("Richiamo dei Guerrieri") != -1) {

									if (crazyMode == 1) {
										bot.sendMessage(message.chat.id, "Durante il folle non puoi usare questo potenziamento!", kbBack);
										return;
									}

									bot.sendMessage(message.chat.id, "Questo potenziamento Ã¨ istantaneo, se utilizzato quando si attende il respawn, questo avviene all'istante. Procedere spendendo 200 ðŸ¦‹?", kbYesNo).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.toLowerCase() == "si") {
												connection.query('SELECT point FROM team WHERE id = ' + team_id, function (err, rows, fields) {
													if (err) throw err;
													var point = rows[0].point;

													if (point < 200) {
														bot.sendMessage(message.chat.id, "Il tuo team non ha abbastanza ðŸ¦‹!", kbBack);
														return;
													}

													connection.query('UPDATE team SET point = point-200 WHERE id = ' + team_id, function (err, rows, fields) {
														if (err) throw err;

														respawnBossMan(team_id);
														bot.sendMessage(message.chat.id, "I boss sono stati riportati in vita!", kbBack);

														connection.query('SELECT player_id, chat_id FROM `team_player`, player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' ORDER BY team_player.id', function (err, rows, fields) {
															if (err) throw err;

															for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																if (rows[i].chat_id != message.chat.id) {
																	bot.sendMessage(rows[i].chat_id, "I boss sono stati riportati in vita! Torna a combattere!");
																}
															}
														});
													});
												});
											}
										};
									});
									return;
								}

								var p = 0;
								var p2 = 0;
								var id = 0;
								var desc = "";

								if (answer.text.indexOf("Unione Fatale") != -1) {
									p = 40;
									p2 = 200;
									id = 1;
									desc = "Questa opzione permette di scegliere tra un potenziamento temporaneo per il team, che darÃ  la possibilitÃ  di infliggere +50% di danno ai boss fino al respawn e costerÃ  " + p + " ðŸ¦‹ oppure un potenziamento permanente di +3% per livello al danno inflitto a tutti i boss, che costerÃ  " + p2 + " ðŸ¦‹, continuare?";
								} else if (answer.text.indexOf("Bottino Ricco") != -1) {
									p = 60;
									p2 = 300;
									id = 2;
									desc = "Questa opzione permette di scegliere tra un potenziamento temporaneo del team, che darÃ  la possibilitÃ  di guadagnare +50% Â§ dalla sconfitta dei boss fino al respawn e costerÃ  " + p + " ðŸ¦‹ oppure un potenziamento permanente di +3% per livello dei Â§ guadagnati per ogni boss, che costerÃ  " + p2 + " ðŸ¦‹, continuare?"
								} else if (answer.text.indexOf("Formazione Impenetrabile") != -1) {
									p = 50;
									p2 = 250;
									id = 3;
									desc = "Questa opzione permette di scegliere tra un potenziamento temporaneo per il team, che darÃ  la possibilitÃ  di subire -50% di danno dai boss fino al respawn e costerÃ  " + p + " ðŸ¦‹ oppure un potenziamento permanente di -3% per livello al danno subito da tutti i boss, che costerÃ  " + p2 + " ðŸ¦‹, continuare?";
								}
								if (id == 0) {
									bot.sendMessage(message.chat.id, "Potenziamento non valido", team);
									return;
								}
								bot.sendMessage(message.chat.id, desc, kbSel).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "temporaneo") {

											if (boost_id != 0) {
												bot.sendMessage(message.chat.id, "Puoi attivare solo un potenziamento temporaneo alla volta, attendi il respawn", team);
												return;
											}

											bot.sendMessage(message.chat.id, "Spenderai " + p + " ðŸ¦‹, continuare?", kbYesNo).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													if (answer.text.toLowerCase() == "si") {
														connection.query('SELECT point FROM team WHERE id = ' + team_id, function (err, rows, fields) {
															if (err) throw err;
															var point = rows[0].point;

															if (point < p) {
																bot.sendMessage(message.chat.id, "Il tuo team non ha abbastanza ðŸ¦‹!", kbBack);
																return;
															}

															connection.query('UPDATE team SET boost_id = ' + id + ', point = point-' + p + ' WHERE id = ' + team_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Potenziamento attivato! TerminerÃ  al respawn.", kbBack);
															});
														});
													}
												}
											});
										} else if (answer.text.toLowerCase() == "permanente") {
											bot.sendMessage(message.chat.id, "Spenderai " + p2 + " ðŸ¦‹, continuare?", kbYesNo).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													if (answer.text.toLowerCase() == "si") {
														connection.query('SELECT point FROM team WHERE id = ' + team_id, function (err, rows, fields) {
															if (err) throw err;
															var point = rows[0].point;

															if (point < p2) {
																bot.sendMessage(message.chat.id, "Il tuo team non ha abbastanza ðŸ¦‹!", kbBack);
																return;
															}

															connection.query('SELECT level FROM team_boost WHERE boost_id = ' + id + ' AND team_id = ' + team_id, function (err, rows, fields) {
																if (Object.keys(rows).length > 0) {
																	var level = rows[0].level;

																	if (level > 10) {
																		bot.sendMessage(message.chat.id, "Questo potenziamento ha raggiunto il livello massimo!", kbBack);
																		return;
																	}

																	connection.query('UPDATE team_boost SET level=level+1 WHERE boost_id = ' + id + ' AND team_id = ' + team_id, function (err, rows, fields) {
																		if (err) throw err;
																		connection.query('UPDATE team SET point = point-' + p2 + ' WHERE id = ' + team_id, function (err, rows, fields) {
																			if (err) throw err;
																			bot.sendMessage(message.chat.id, "Potenziamento migliorato al livello " + (level + 1) + "!", kbBack);
																		});
																	});
																} else {
																	connection.query('INSERT INTO team_boost (team_id, boost_id, level) VALUES (' + team_id + ',' + id + ',1)', function (err, rows, fields) {
																		if (err) throw err;
																		connection.query('UPDATE team SET point = point-' + p2 + ' WHERE id = ' + team_id, function (err, rows, fields) {
																			bot.sendMessage(message.chat.id, "Potenziamento attivato!", kbBack);
																		});
																	});
																}
															});
														});
													}
												}
											});
										}
									};
								});
								//Fine
							};
						});
					});
				});
			});
		});
	});
});

bot.onText(/liste membri/i, function (message) {
	var keynull = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Nessuno"]]
		}
	};

	var kbBack = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna alle Liste Membri"], ["Torna al team"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		bot.sendMessage(message.chat.id, "Inserisci il nome del team da cercare, anche parziale. Per una ricerca precisa aggiungi l'asterisco al fondo.", keynull).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if ((answer.text != "Torna al menu") && (answer.text != "Nessuno")) {

					var query = 'LIKE "%' + answer.text + '%"';
					if (answer.text.indexOf("*") != -1) {
						answer.text = answer.text.replace("*", "");
						query = '= "' + answer.text + '"';
					}

					connection.query('SELECT * FROM team WHERE name ' + query, function (err, rows, fields) {
						if (err) throw err;

						var search1 = Object.keys(rows).length;
						var res1 = rows;

						var terms = "";
						if (search1 > 1) {
							terms += "\n\n";
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								terms += rows[i].name + "\n";
							}
						}

						connection.query('SELECT id, name, players, max_players, slogan, boss_count, kill_num1, kill_num2 FROM team WHERE name LIKE "' + answer.text + '"', function (err, rows, fields) {
							if (err) throw err;

							var search2 = Object.keys(rows).length;
							var res2 = rows;

							if ((search1 == 0) && (search2 == 0)) {
								bot.sendMessage(message.chat.id, "Il team che hai richiesto non esiste", kbBack);
								return;
							}
							if ((search1 > 1) && (search2 == 0)) {
								bot.sendMessage(message.chat.id, "Troppi risultati, riprova con termini di ricerca piÃ¹ precisi" + terms, kbBack);
								return;
							}

							if (search1 == 1) {
								rows = res1;
							} else {
								rows = res2;
							}

							var slogan = "";
							if (rows[0].slogan != null)
								slogan = "Slogan: <i>" + rows[0].slogan + "</i>\n";

							var text = "Il team <b>" + rows[0].name + "</b>:\n" + slogan + "Boss uccisi: " + formatNumber(rows[0].boss_count) + "\nScalate: " + rows[0].kill_num1 + " parziali e " + rows[0].kill_num2 + " complete\nMembri: " + rows[0].players + "/" + rows[0].max_players + "\n\n";
							connection.query('SELECT player.nickname, player.reborn, player.exp, team_player.role FROM team_player, player WHERE player.id = team_player.player_id AND team_id = ' + rows[0].id + ' ORDER BY team_player.role = 0, team_player.role, player.reborn DESC, player.exp DESC', function (err, rows, fields) {
								if (err) throw err;
								var stars = "";
								var admin = "";
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									admin = "";
									if (rows[i].role == 1)
										admin = " ðŸ‘‘";
									else if (rows[i].role == 2)
										admin = " ðŸ”°";
									else
										admin = " ðŸ‘¤";
									text += rows[i].nickname + " " + rebSym(rows[i].reborn) + " (" + Math.floor(rows[i].exp / 10) + ")" + admin + "\n";
								}
								bot.sendMessage(message.chat.id, text, kbBack);
							});
						});
					});
				}
			}
		});
	});
});

bot.onText(/Fonda nuovo/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		var new_price = 5000;
		var price_drop = 0;
		var price_drop_msg = "";
		var n = new Date().getDay()
		var n2 = new Date().getDate();

		if (rows[0].team_time != null) {
			var d = new Date(rows[0].team_time);
			var long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + long_date, back);
			return;
		}

		if (n == 0) {
			price_drop = 1;
			new_price = 3500;
			price_drop_msg = "*SOLO OGGI* ";
		}

		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				bot.sendMessage(message.chat.id, "Sei giÃ  in un team!", team);
				return;
			}

			if (money < new_price) {
				bot.sendMessage(message.chat.id, "Non hai abbastanza soldi.", back);
				return;
			}

			bot.sendMessage(message.chat.id, "Scegli un nome per il tuo Team, ma fai attenzione non potrai cambiarlo. Inoltre non usare simboli ne la parola 'Team'.", mark).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					var name = answer.text.trim();

					if ((name.indexOf("Team") != -1) || (name.indexOf("team") != -1) || (name == "") || (name.indexOf("_") != -1) || (name.indexOf("*") != -1) || (name.toLowerCase() == "Torna al menu") || (name == "") || (name == "Torna al menu") || (name == "Rinomina") || (name.toLowerCase().indexOf("madre") != -1) || (name.toLowerCase().indexOf("accademia") != -1)) {
						bot.sendMessage(message.chat.id, "Nome non valido.", back);
						return;
					}

					if (re4.test(name) == false) {
						bot.sendMessage(message.chat.id, "I simboli non sono consentiti o il nome Ã¨ troppo lungo (max 40 caratteri).", back);
						return;
					}

					connection.query('SELECT id FROM team WHERE name = "' + name + '"', function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length == 0) {
							connection.query('INSERT INTO team (id, name, players, max_players) VALUES (DEFAULT, "' + name + '", 1, 7)', function (err, rows, fields) {
								if (err) throw err;
								connection.query('UPDATE player SET money = money - ' + new_price + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Team " + name + " creato!\nPuoi ospitare 5 membri totali compreso te, torna su questa pagina per gestire il team e potenziarlo.", team);
								});
								connection.query('SELECT id FROM team WHERE name = "' + name + '"', function (err, rows, fields) {
									if (err) throw err;
									connection.query('INSERT INTO team_player (id, player_id, team_id) VALUES (DEFAULT,' + player_id + ',' + rows[0].id + ')', function (err, rows, fields) {
										if (err) throw err;
									});
									spawnTeamBoss(rows[0].id);
								});
							});
						} else {
							bot.sendMessage(message.chat.id, "Il nome che hai inserito esiste giÃ , riprova.", team);
							return;
						}
					});
				};
			});
		});
	});
});

bot.onText(/Entra in uno esistente|^Pagina (.+)/i, function (message, match) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (rows[0].team_time != null) {
			var d = new Date(rows[0].team_time);
			var long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + long_date, back);
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		var lev = Math.floor(rows[0].exp / 10);
		var reborn = rows[0].reborn;

		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				bot.sendMessage(message.chat.id, "Sei giÃ  in un team!", team);
				return;
			}
			var iKeys = [];

			var thisPage = 1;
			var limMin = 0;
			var limMax = 50;
			if (match[1] != undefined) {
				thisPage = parseInt(match[1]);
				limMin = 50 * (thisPage - 1);
				limMax = 50 * thisPage;
			}

			connection.query('SELECT * FROM team WHERE closed = 0 AND players < max_players AND ' + getRealLevel(reborn, lev) + ' >= min_lev ORDER BY name LIMIT ' + limMin + ', ' + limMax, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Non ci sono piÃ¹ team disponibili o hanno raggiunto il limite di membri.", back);
					return;
				}

				var closed_text = "";

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					iKeys.push(["Entra in " + rows[i].name + " (" + rows[i].players + "/" + rows[i].max_players + ")"]);
				};

				if (Object.keys(rows).length >= 50) {
					iKeys.push(["Pagina " + (thisPage + 1)]);
				}
				iKeys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				bot.sendMessage(message.chat.id, "Seleziona il team al quale desideri unirti.", kb);
			});
		});
	});
});

bot.onText(/Hall of Fame/i, function (message) {
	connection.query('SELECT team.name FROM team, team_player WHERE team.id = team_player.team_id AND team_player.player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function (err, rows, fields) {
		if (err) throw err;

		var myTeam = "";
		if (Object.keys(rows).length > 0) {
			myTeam = rows[0].name;
		}

		connection.query('SELECT top_min FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].top_min == 1) {
				connection.query('SELECT name As name, (craft_count+(boss_count*(SELECT COUNT(*) FROM team_player WHERE team_id = T.id))) As pnt FROM team T GROUP BY id ORDER BY pnt DESC', function (err, rows, fields) {
					if (err) throw err;
					var text = "Classifica Team:\n";
					var c = 1;
					var mypos = "";
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (c <= 15) {
							text += c + "Â° " + rows[i].name + " (" + formatNumber(Math.floor(rows[i].pnt)) + " pnt)\n";
						}
						if (myTeam != "") {
							if (rows[i].name == myTeam) {
								mypos = "\nIl tuo team:\n";
								mypos += c + "Â° " + rows[i].name + " (" + formatNumber(Math.floor(rows[i].pnt)) + " pnt)";
							}
						}
						c++;
					}
					bot.sendMessage(message.chat.id, text + mypos, team);
				});
			}else{
				connection.query('SELECT name As name, (craft_count+(boss_count*(SELECT COUNT(*) FROM team_player WHERE team_id = T.id))) As pnt FROM team T GROUP BY id ORDER BY pnt DESC', function (err, rows, fields) {
					if (err) throw err;
					var text = "Classifica Team:\n";
					var range = 5;

					var name = [];
					var points = [];
					var mypos = 0;

					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						name.push(rows[i].name);
						points.push(rows[i].pnt);
						if (myTeam == rows[i].name) {
							mypos = i;
						}
					}

					for (var i = (mypos - range); i < (mypos + (range + 1)); i++) {
						if (name[i] != undefined) {
							if (i == mypos) {
								text += (i + 1) + "Â° <b>" + name[i] + "</b> (" + formatNumber(Math.floor(points[i])) + ")\n";
							} else {
								text += (i + 1) + "Â° " + name[i] + " (" + formatNumber(Math.floor(points[i])) + ")\n";
							}
						}
					}

					bot.sendMessage(message.chat.id, text, team_html);
				});
			}
		});
	});
});

bot.onText(/Dettagli: |Dettagli: /i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					var closed = rows[0].closed;
					var details = rows[0].details;

					if (isAdmin == 0) {
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}
					if (details == 1) {
						connection.query('UPDATE team SET details = 0 WHERE id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Ora i membri non visualizzano piÃ¹ la lista dei membri.", team);
						});
					} else {
						connection.query('UPDATE team SET details = 1 WHERE id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Ora i membri possono visualizzare la lista dei membri.", team);
						});
					}
				});
			});
		});
	});
});

bot.onText(/Tipo: Aperto|Tipo: Chiuso/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					var closed = rows[0].closed;
					var details = rows[0].details;

					if (isAdmin == 0) {
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}

					if (closed == 1) {
						connection.query('UPDATE team SET closed = 0 WHERE id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Il team Ã¨ stato impostato su Aperto, gli utenti possono accedere liberamente.", team);
						});
					} else {
						connection.query('UPDATE team SET closed = 1 WHERE id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Il team Ã¨ stato impostato su Chiuso, nessun utente puÃ² accedere.", team);
						});
					}
				});
			});
		});
	});
});

bot.onText(/Gestisci Membri/i, function (message) {

	/*
	if (message.from.id != 20471035){
		bot.sendMessage(message.chat.id, "Manutenzione", back);
		return;
	}
	*/

	var player = message.text.substring(message.text.indexOf(" ") + 1);
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_player.role = 0 AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}

			var iKeys = [];
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push([rows[i].nickname]);
			}
			iKeys.push(["Torna al menu"]);

			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT level FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					if (isAdmin == 0) {
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					var kb2 = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Espelli", "Sospendi"], ["Sposta in Madre"], ["Sposta in Accademia"], ["Torna al menu"]]
						}
					};

					var kbBack = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Gestisci membri"], ["Torna al team"], ["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona il membro del team da gestire", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text != "Torna al menu") {

								var player = answer.text;

								bot.sendMessage(message.chat.id, "Cosa vuoi fare?\nSe sospendi il giocatore non riceverÃ  ricompense per i boss o per gli incarichi completati!", kb2).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text == "Espelli") {

											connection.query('SELECT chat_id, player.id FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function (err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length == 0) {
													bot.sendMessage(message.chat.id, "Non ho trovato il giocatore selezionato.", kbBack);
													return;
												}
												var chat_id = rows[0].chat_id;
												var playerId = rows[0].id;

												if (player_id == playerId) {
													bot.sendMessage(message.chat.id, "Non puoi espellere te stesso", kbBack);
													return;
												}

												connection.query('SELECT 1 FROM mission_team_party_player WHERE player_id = ' + playerId, function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length > 0) {
														bot.sendMessage(message.chat.id, "Non puoi cacciare un membro inserito in un party!");
														return;
													}

													connection.query('DELETE FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + playerId + ' LIMIT 1', function (err, rows, fields) {
														if (err) throw err;
														connection.query('UPDATE team SET players = players-1 WHERE id = ' + team_id, function (err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, player + " Ã¨ stato cacciato dal team!", kbBack);
															bot.sendMessage(chat_id, "Sei stato cacciato dal team!");
														});

														var d2 = new Date();
														d2.setHours(d2.getHours() + 72);
														var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

														connection.query('UPDATE player SET boss_id = NULL, team_time = "' + long_date + '" WHERE id = ' + playerId, function (err, rows, fields) {
															if (err) throw err;
														});
													});
												});
											});
										} else if (answer.text == "Sospendi") {
											connection.query('SELECT chat_id, player.id, team_player.suspended FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function (err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length == 0) {
													bot.sendMessage(message.chat.id, "Non ho trovato il giocatore selezionato.", kbBack);
													return;
												}
												var chat_id = rows[0].chat_id;
												var playerId = rows[0].id;

												if (player_id == playerId) {
													bot.sendMessage(message.chat.id, "Non puoi sospendere te stesso", kbBack);
													return;
												}

												var s = 0;
												if (rows[0].suspended == 0) {
													s = 1;
												}

												connection.query('UPDATE player SET boss_id = NULL WHERE id = ' + playerId, function (err, rows, fields) {
													if (err) throw err;
													connection.query('UPDATE team_player SET suspended = ' + s + ' WHERE player_id = ' + playerId, function (err, rows, fields) {
														if (err) throw err;
														if (s == 1) {
															bot.sendMessage(message.chat.id, player + " Ã¨ stato sospeso dal team!", kbBack);
															bot.sendMessage(chat_id, "Sei stato sospeso dal team!");
														} else {
															bot.sendMessage(message.chat.id, player + " non Ã¨ piÃ¹ sospeso dal team!", kbBack);
															bot.sendMessage(chat_id, "Non sei piÃ¹ sospeso dal team!");
														}
													});
												});
											});
										} else if (answer.text == "Sposta in Madre") {
											connection.query('SELECT chat_id, player.id, player.nickname, team_player.role FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function (err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length == 0) {
													bot.sendMessage(message.chat.id, "Non ho trovato il giocatore selezionato.", kbBack);
													return;
												}
												var chat_id = rows[0].chat_id;
												var playerId = rows[0].id;
												var nick = rows[0].nickname;

												if (rows[0].role > 0){
													bot.sendMessage(message.chat.id, "Devi togliere i poteri a questo membro prima di spostarlo in un altro team", kbBack);
													return;
												}

												connection.query('SELECT id, name FROM team WHERE child_team = ' + team_id, function (err, rows, fields) {
													if (err) throw err;

													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, "Questo team non possiede un team madre", kbBack);
														return;
													}

													var motherId = rows[0].id;
													var teamName = rows[0].name;

													if (crazyMode == 1) {
														bot.sendMessage(message.chat.id, "Durante l'evento folle non puoi trasferire", kbBack);
														return;
													}

													if (player_id == playerId) {
														bot.sendMessage(message.chat.id, "Non puoi trasferire te stesso", kbBack);
														return;
													}

													connection.query('SELECT 1 FROM mission_team_party_player WHERE player_id = ' + playerId, function (err, rows, fields) {
														if (err) throw err;

														if (Object.keys(rows).length > 0) {
															bot.sendMessage(message.chat.id, "Non puoi spostare un membro inserito in un party!");
															return;
														}

														connection.query('SELECT players, max_players FROM team WHERE id = ' + motherId, function (err, rows, fields) {
															if (err) throw err;

															if (rows[0].players >= rows[0].max_players) {
																bot.sendMessage(message.chat.id, "Il team Ã¨ pieno!", kbBack);
																return;
															}

															var d2 = new Date();
															d2.setHours(d2.getHours() + 48);
															var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

															connection.query('UPDATE player SET boss_time = "' + long_date + '", boss_id = NULL WHERE id = ' + playerId, function (err, rows, fields) {
																if (err) throw err;
																connection.query('UPDATE team_player SET kill_streak = 0, team_id = ' + motherId + ' WHERE player_id = ' + playerId, function (err, rows, fields) {
																	if (err) throw err;
																	connection.query('DELETE FROM boss_damage WHERE player_id = ' + playerId, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai trasferito il membro nel Team Madre!", kbBack);
																		bot.sendMessage(chat_id, "Sei stato trasferito nel Team Madre dall'amministratore");

																		connection.query('UPDATE team SET players = players-1 WHERE id = ' + team_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE team SET players = players+1 WHERE id = ' + motherId, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('SELECT player_id FROM team_player WHERE team_id = ' + motherId + ' AND role = 1', function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function (err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(rows[0].chat_id, "<b>" + nick + "</b> Ã¨ stato trasferito nel tuo team", html);
																			});
																		});
																	});
																});
															});
														});
													});
												});
											});
										} else if (answer.text == "Sposta in Accademia") {
											connection.query('SELECT player.chat_id, player.id, player.nickname, team_player.role FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function (err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length == 0) {
													bot.sendMessage(message.chat.id, "Non ho trovato il giocatore selezionato.", kbBack);
													return;
												}
												var chat_id = rows[0].chat_id;
												var playerId = rows[0].id;
												var nick = rows[0].nickname;

												if (rows[0].role > 0){
													bot.sendMessage(message.chat.id, "Devi togliere i poteri a questo membro prima di spostarlo in un altro team", kbBack);
													return;
												}

												connection.query('SELECT name, child_team FROM team WHERE id = ' + team_id, function (err, rows, fields) {
													if (err) throw err;

													var childId = rows[0].child_team;

													if (childId == 0) {
														bot.sendMessage(message.chat.id, "Questo team non possiede un'accademia", kbBack);
														return;
													}

													var teamName = rows[0].name;

													if (crazyMode == 1) {
														bot.sendMessage(message.chat.id, "Durante l'evento folle non puoi trasferire", kbBack);
														return;
													}

													if (player_id == playerId) {
														bot.sendMessage(message.chat.id, "Non puoi trasferire te stesso", kbBack);
														return;
													}

													connection.query('SELECT 1 FROM mission_team_party_player WHERE player_id = ' + playerId, function (err, rows, fields) {
														if (err) throw err;

														if (Object.keys(rows).length > 0) {
															bot.sendMessage(message.chat.id, "Non puoi spostare un membro inserito in un party!");
															return;
														}

														connection.query('SELECT players, max_players FROM team WHERE id = ' + childId, function (err, rows, fields) {
															if (err) throw err;

															if (rows[0].players >= rows[0].max_players) {
																bot.sendMessage(message.chat.id, "Il team Ã¨ pieno!", kbBack);
																return;
															}

															var d2 = new Date();
															d2.setHours(d2.getHours() + 48);
															var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

															connection.query('UPDATE player SET boss_time = "' + long_date + '", boss_id = NULL WHERE id = ' + playerId, function (err, rows, fields) {
																if (err) throw err;
																connection.query('UPDATE team_player SET kill_streak = 0, team_id = ' + childId + ' WHERE player_id = ' + playerId, function (err, rows, fields) {
																	if (err) throw err;
																	connection.query('DELETE FROM boss_damage WHERE player_id = ' + playerId, function (err, rows, fields) {
																		if (err) throw err;
																		bot.sendMessage(message.chat.id, "Hai trasferito il membro in Accademia!", kbBack);
																		bot.sendMessage(chat_id, "Sei stato trasferito in Accademia dall'amministratore");

																		connection.query('UPDATE team SET players = players-1 WHERE id = ' + team_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('UPDATE team SET players = players+1 WHERE id = ' + childId, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		connection.query('SELECT player_id FROM team_player WHERE team_id = ' + childId + ' AND role = 1', function (err, rows, fields) {
																			if (err) throw err;
																			connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function (err, rows, fields) {
																				if (err) throw err;
																				bot.sendMessage(rows[0].chat_id, "<b>" + nick + "</b> Ã¨ stato trasferito nel tuo team", html);
																			});
																		});
																	});
																});
															});
														});
													});
												});
											});
										}
									};
								});
							}
						}
					});
				});
			});
		});
	});
});

bot.onText(/^limite$/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					var closed = rows[0].closed;
					var details = rows[0].details;

					if (isAdmin == 0) {
						bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
						return;
					}

					bot.sendMessage(message.chat.id, "Inserisci il livello minimo di accesso al tuo team, sommando i livelli per rinascita corrispondente. Inserisci 0 per eliminare il controllo.", team).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var num = parseInt(answer.text);

							if ((num > 1750) || (num < 0)){
								bot.sendMessage(message.chat.id, "Livello non valido: minimo 0, massimo 1750", team);
								return;
							}

							if (isNaN(num)) {
								bot.sendMessage(message.chat.id, "Livello non valido, riprova", team);
								return;
							}

							connection.query('UPDATE team SET min_lev = ' + num + ' WHERE id = ' + team_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Livello minimo (" + getLevel(num) + ") impostato correttamente", team);
							});
						};
					});
				});
			});
		});
	});
});

bot.onText(/^Accademia/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		connection.query('SELECT team_player.*, player.nickname FROM `team_player`, player WHERE player.id = team_player.player_id AND team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT id FROM team WHERE child_team = ' + team_id, function (err, rows, fields) {
					if (err) throw err;

					var motherId = 0;
					if (Object.keys(rows).length > 0) {
						motherId = rows[0].id;
					}

					connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
						if (err) throw err;

						var now = new Date();
						var child_time = rows[0].child_time;
						var teamName = rows[0].name;

						if (rows[0].child_team != 0)
							bot.sendMessage(message.chat.id, "Questo team Ã¨ giÃ  collegato ad un'accademia, se continui andrai a rimpiazzarla", team);

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Scollega"], ["Annulla"]]
							}
						};

						if (isAdmin == 0) {
							bot.sendMessage(message.chat.id, "Questa funzione Ã¨ riservata all'amministratore!", team);
							return;
						}

						bot.sendMessage(message.chat.id, "Collegare un accademia a questo team aumenterÃ  il premio per uccisione boss. Inserisci il nome completo del team da rendere accademia di questo.\nNota: Inizierai a ottenere bonus solo se l'accademia Ã¨ almeno al livello 5, lo stesso nell'altro senso\nNon potrai cambiare accademia per una settimana", kb).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text == "Scollega") {
									connection.query('UPDATE team SET child_team = 0 WHERE child_team = ' + team_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Il tuo team non Ã¨ piÃ¹ un'accademia", team);
									});
									return;
								}
								if ((answer.text != "Annulla") && (answer.text != "Torna al menu")) {

									if (child_time != null) {
										var d = new Date(child_time);
										if (d > now) {
											var long_date = addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear() + " alle " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

											bot.sendMessage(message.chat.id, "Prima di cambiare accademia devi aspettare fino al " + long_date, team);
											return;
										}
									}

									connection.query('SELECT * FROM team WHERE name = "' + answer.text + '"', function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Questo team non esiste", team);
											return;
										}

										var teamName2 = rows[0].name;

										if (team_id == rows[0].id) {
											bot.sendMessage(message.chat.id, "Lo stesso team non puÃ² essere sia madre che accademia di se stesso", team);
											return;
										}

										if ((motherId != 0) && (motherId == rows[0].id)) {
											bot.sendMessage(message.chat.id, "Non puoi definire accademia il tuo team madre", team);
											return;
										}

										var d = new Date();
										d.setDate(d.getDate() + 7);
										var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

										connection.query('UPDATE team SET child_team = ' + rows[0].id + ', child_time = "' + long_date + '" WHERE id = ' + team_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, teamName2 + " Ã¨ ora accademia di " + teamName + "!", team);
										});
									});
								};
							};
						});
					});
				});
			});
		});
	});
});

bot.onText(/^Lascia/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ' LIMIT 1) ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
				var level = rows[0].level;

				connection.query('SELECT 1 FROM mission_team_party_player WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length > 0) {
						bot.sendMessage(message.chat.id, "Non puoi uscire dal team finchÃ¨ sei in un party!");
						return;
					}

					bot.sendMessage(message.chat.id, "Sei sicuro di voler uscire dal team? Dovrai attendere 72 ore prima di entrare in un altro!", conf).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var action = answer.text;
							if (action == "Torna al Team") {
								return;
							} else if (action == "Conferma") {
								connection.query('SELECT player.chat_id FROM player, team_player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND role = 1', function (err, rows, fields) {
									if (err) throw err;
									var chat_id = rows[0].chat_id;
									connection.query('DELETE FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id + ' LIMIT 1', function (err, rows, fields) {
										if (err) throw err;
										connection.query('UPDATE team SET players = players-1 WHERE id = ' + team_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Sei uscito dal team!", back);
											bot.sendMessage(chat_id, message.from.username + " Ã¨ uscito dal team!");
										});

										var d2 = new Date();
										d2.setHours(d2.getHours() + 72);
										var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

										connection.query('UPDATE player SET boss_id = NULL, team_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
									});
								});
							}
						};
					});
				});
			});
		});
	});
});

bot.onText(/^Notifiche/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ' LIMIT 1) ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT notification FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				var notify = rows[0].notification;

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;

					bot.sendMessage(message.chat.id, "Cambiare l'impostazione notifiche da parte del team?", conf).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var action = answer.text;
							if (action == "Torna al Team") {
								return;
							} else if (action == "Conferma") {
								if (notify == 1) {
									notify = 0;
								} else {
									notify = 1;
								}
								connection.query('UPDATE team_player SET notification = ' + notify + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									if (notify == 0) {
										bot.sendMessage(message.chat.id, "Hai disattivato le notifiche team!", back);
									} else {
										bot.sendMessage(message.chat.id, "Hai attivato le notifiche team!", back);
									}
								});
							}
						};
					});
				});
			});
		});
	});
});

bot.onText(/Sciogli/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		connection.query('SELECT * FROM `team_player` WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					if (isAdmin == 0) {
						bot.sendMessage(message.chat.id, "Questa operazione Ã¨ consentita solo all'amministratore.", back);
						return;
					}

					bot.sendMessage(message.chat.id, "Sei sicuro di voler eliminare il team?", conf).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var action = answer.text;
							if (action == "Conferma") {
								connection.query('SELECT * FROM team_player WHERE team_id = ' + team_id, function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length > 1) {
										bot.sendMessage(message.chat.id, "Devi prima espellere tutti i membri del team!", team);
										return;	
									}
									connection.query('DELETE FROM team_player WHERE team_id = ' + team_id, function (err, rows, fields) {
										if (err) throw err;
										connection.query('DELETE FROM team WHERE id = ' + team_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Team eliminato! Non puoi crearlo o accedere ad un altro team prima che siano passate 72 ore!", back);
											return;
										});
									});
									var d2 = new Date();
									d2.setHours(d2.getHours() + 72);
									var long_date = d2.getFullYear() + "-" + addZero(d2.getMonth() + 1) + "-" + addZero(d2.getDate()) + " " + addZero(d2.getHours()) + ':' + addZero(d2.getMinutes()) + ':' + addZero(d2.getSeconds());

									connection.query('UPDATE player SET boss_id = NULL, team_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
									});
									connection.query('DELETE FROM boss_team WHERE team_id = ' + team_id, function (err, rows, fields) {
										if (err) throw err;
									});
									connection.query('DELETE FROM mission_team_party_player WHERE team_id = ' + team_id, function (err, rows, fields) {
										if (err) throw err;
									});
									connection.query('DELETE FROM mission_team_party WHERE team_id = ' + team_id, function (err, rows, fields) {
										if (err) throw err;
									});
								});
							}
						};
					});
				});
			});
		});
	});
});

bot.onText(/cambia admin/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM team_player WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT * FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var level = rows[0].level;
					if (isAdmin == 1) {
						var iKeys = [];

						connection.query('SELECT player.nickname FROM team_player, player WHERE team_player.player_id = player.id AND player_id != ' + player_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								if (rows[i].nickname != message.from.username) {
									iKeys.push([rows[i].nickname]);
								}
							}

							iKeys.push(["Torna al team"]);

							var kb = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": iKeys
								}
							};

							var kb2 = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Amministratore", "Vice-Amministratore"],["Torna al team"]]
								}
							};

							bot.sendMessage(message.chat.id, "Quale autoritÃ  vuoi gestire?", kb2).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Torna al team")
										return;

									if (answer.text == "Amministratore"){
										bot.sendMessage(message.chat.id, "Chi vuoi eleggere amministratore al posto tuo?\nOtterrÃ  tutti i poteri di gestione del team", kb).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text == "Torna al team")
													return;

												var player = answer.text;
												connection.query('SELECT player.nickname FROM team_player, player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function (err, rows, fields) {
													if (err) throw err;
													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, "Questo giocatore non esiste o non si trova in questo team.", back);
														return;
													}
													connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + player + '"', function (err, rows, fields) {
														if (err) throw err;
														var newAdmin = rows[0].id;
														if (adminId == newAdmin){
															bot.sendMessage(message.chat.id, "Sei giÃ  amministratore!", back);
															return;
														}
														connection.query('UPDATE team_player SET role = 0 WHERE role = 1 AND team_id = ' + team_id, function (err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE team_player SET role = 1 WHERE player_id = ' + newAdmin, function (err, rows, fields) {
															if (err) throw err;
														});
														bot.sendMessage(message.chat.id, "Cambio admin completato!", back);
														bot.sendMessage(rows[0].chat_id, "Sei stato nominato Amministratore del Team!", back);
													});
												});
											}
										});
									}else if (answer.text == "Vice-Amministratore"){
										bot.sendMessage(message.chat.id, "Chi vuoi eleggere vice-amministratore al posto dell'attuale?\nOtterrÃ  i poteri per gestire gli incarichi", kb).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text == "Torna al team")
													return;

												var player = answer.text;
												connection.query('SELECT player.nickname FROM team_player, player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' AND nickname = "' + player + '"', function (err, rows, fields) {
													if (err) throw err;
													if (Object.keys(rows).length == 0) {
														bot.sendMessage(message.chat.id, "Questo giocatore non esiste o non si trova in questo team.", back);
														return;
													}
													connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + player + '"', function (err, rows, fields) {
														if (err) throw err;
														var newAdmin = rows[0].id;
														if (adminId == newAdmin){
															bot.sendMessage(message.chat.id, "Sei giÃ  amministratore!", back);
															return;
														}
														connection.query('UPDATE team_player SET role = 0 WHERE role = 2 AND team_id = ' + team_id, function (err, rows, fields) {
															if (err) throw err;
														});
														connection.query('UPDATE team_player SET role = 2 WHERE player_id = ' + newAdmin, function (err, rows, fields) {
															if (err) throw err;
														});
														bot.sendMessage(message.chat.id, "Cambio vice-admin completato!", back);
														bot.sendMessage(rows[0].chat_id, "Sei stato nominato Vice-Amministratore del Team!", back);
													});
												});
											}
										});
									}
								}
							});
						});
					} else {
						bot.sendMessage(message.chat.id, "Questa operazione Ã¨ consentita solo all'amministratore.", back);
						return;
					}
				});
			});
		});
	});
});

bot.onText(/^aumenta posti/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var money = rows[0].money;
		connection.query('SELECT * FROM team_player WHERE team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team", team);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				connection.query('SELECT life, total_life FROM boss_team WHERE team_id = ' + team_id + ' ORDER BY boss_id', function (err, rows, fields) {
					if (err) throw err;

					if (rows[0].life != rows[0].total_life) {
						bot.sendMessage(message.chat.id, "Puoi potenziare il team solo a fine scalata, dopo il respawn.", team);
						return;
					}

					connection.query('SELECT level, point FROM team WHERE id = ' + team_id, function (err, rows, fields) {
						if (err) throw err;
						var level = rows[0].level;
						var point = rows[0].point;

						if (isAdmin == 1) {
							if (level >= 7) {
								bot.sendMessage(message.chat.id, "Hai raggiunto il livello massimo del Team.", team);
								return;
							}

							var kb = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [['Conferma'], ['Torna al Team']]
								}
							};

							var price = 100000;
							var price_p = 35;

							price = price * level;
							price_p = price_p + (16 * (level));

							bot.sendMessage(message.chat.id, "Il potenziamento al livello " + (level + 1) + " ti costerÃ  " + formatNumber(price) + " Â§ e " + price_p + " ðŸ¦‹. AumenterÃ  lo spazio per i membri del team e ti consentirÃ  di affrontare piÃ¹ boss", kb).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									var action = answer.text;
									if (action == "Conferma") {
										if (money < price) {
											bot.sendMessage(message.chat.id, "Non hai abbastanza monete", team);
											return;
										}
										if (point < price_p) {
											bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ¦‹", team);
											return;
										}
										var upd = 2;
										if (level == 6) {
											upd = 3;
										}
										connection.query('UPDATE team SET point = point-' + price_p + ', level = level+1, max_players = max_players+' + upd + ' WHERE id = ' + team_id, function (err, rows, fields) {
											if (err) throw err;
											connection.query('UPDATE player SET money=money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												connection.query('SELECT level, max_players FROM team WHERE id = ' + team_id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Potenziamento al livello " + rows[0].level + " completato, ora puÃ² ospitare un massimo di " + rows[0].max_players + " membri", team);
												});
											});
										});
									}
								};
							});
						} else {
							bot.sendMessage(message.chat.id, "Questa operazione Ã¨ consentita solo all'amministratore.", back);
							return;
						}
					});
				});
			});
		});
	});
});

bot.onText(/Entra in(?! uno esistente)/i, function (message) {
	var name = message.text.substring(message.text.indexOf("in") + 3, message.text.lenght);

	if (name == "Torna al menu") {
		return;
	}

	var pos = name.indexOf("(");
	if (pos != -1) {
		name = name.substr(0, pos - 1);
	}

	if ((name.toLowerCase() == "uno esistente") || (name.toLowerCase() == "combattimento")) {
		return;
	}

	connection.query('SELECT id, team_time, holiday, account_id, exp, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (rows[0].team_time != null) {
			var d = new Date(rows[0].team_time);
			var long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

			bot.sendMessage(message.chat.id, "Non puoi ancora entrare in un team, ne hai appena lasciato uno. Attendi fino alle " + long_date, back);
			return;
		}

		var player_id = rows[0].id;
		var lev = Math.floor(rows[0].exp / 10);
		var reborn = rows[0].reborn;

		connection.query('SELECT * FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				bot.sendMessage(message.chat.id, "Sei giÃ  in un team.", back);
				return;
			}

			connection.query('SELECT * FROM team WHERE name = "' + name + '"', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					if (rows[0].players < rows[0].max_players) {
						var team_id = rows[0].id;
						var team_name = rows[0].name;
						var min_lev = rows[0].min_lev;
						var slogan = rows[0].slogan;
						if (rows[0].closed == 1) {
							bot.sendMessage(message.chat.id, "Non puoi entrare in un team che non accetta altri membri.", back);
							return;
						}

						var extra = "";
						if (min_lev > 0) {
							extra = "\nPer l'accesso Ã¨ richiesto almeno il livello " + getLevel(min_lev);
						}
						var slogantxt = "";
						if (slogan != null)
							slogantxt = "\nSlogan: " + slogan;

						bot.sendMessage(message.chat.id, "Team: *" + team_name + "* (" + rows[0].players + "/" + rows[0].max_players + ")" + slogantxt + extra, yesno).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase() == "si") {
									if (getRealLevel(reborn, lev) < min_lev) {
										bot.sendMessage(message.chat.id, "Il tuo livello non Ã¨ ancora sufficiente per entrare in questo team, torna al " + getLevel(min_lev), back);
										return;
									}
									connection.query('INSERT INTO `team_player`(`id`, `player_id`, `team_id`) VALUES (DEFAULT,' + player_id + ',' + team_id + ')', function (err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT player_id FROM team_player WHERE team_id = ' + team_id + ' AND role = 1', function (err, rows, fields) {
											if (err) throw err;
											connection.query('SELECT chat_id FROM player WHERE id = ' + rows[0].player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(rows[0].chat_id, message.from.username + " Ã¨ entrato nel tuo team!");
											});
										});
										bot.sendMessage(message.chat.id, "Sei entrato nel team " + name + "!", team);
										return;
									});
									connection.query('UPDATE team SET players = players+1 WHERE id = ' + team_id, function (err, rows, fields) {
										if (err) throw err;
									});
								};
							};
						});
					} else {
						bot.sendMessage(message.chat.id, "Il team specificato Ã¨ pieno, chiedi al fondatore di potenziarlo per aumentare gli slot.", back);
						return;
					}
				} else {
					bot.sendMessage(message.chat.id, "Il team che hai richiesto non esiste.", back);
					return;
				}
			});
		});
	});
});

function spawnTeamBoss(team_id) {
	connection.query('SELECT * FROM boss', function (err, rows, fields) {
		if (err) throw err;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			if (rows[i].id == 1) {
				connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',1,' + team_id + ')', function (err, rows, fields) {
					if (err) throw err;
				});
			} else {
				connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',0,' + team_id + ')', function (err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
}

bot.onText(/^Robot/i, function (message) {
	if ((eventRobot == 0) && (message.from.id != 20471035)) {
		return;
	}

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		var kb = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Continua"], ["Torna al menu"]]
			}
		};

		connection.query('SELECT player_id, phase FROM event_robot_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO event_robot_status (player_id, phase) VALUES (' + player_id + ',1)', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "intro", kb);
				});
			} else {
				connection.query('SELECT * FROM event_robot_list WHERE id = ' + rows[0].phase, function (err, rows, fields) {
					if (err) throw err;

					var next = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [[rows[0].r1], [rows[0].r2], [rows[0].r3], ["Torna al menu"]]
						}
					};

					var text = rows[0].text;

					bot.sendMessage(message.chat.id, text.replace(new RegExp("%player%", "g"), message.from.username), next).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text != "Torna al menu") {
								var sel = 0;
								if (answer.text == rows[0].r1) {
									sel = rows[0].p1;
								} else if (answer.text == rows[0].r2) {
									sel = rows[0].p2;
								} else if (answer.text == rows[0].r3) {
									sel = rows[0].p3;
								} else {
									return;
								}
								connection.query('UPDATE event_robot_status SET phase = ' + sel + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
								});
							};
						};
					});
				});
			}
		});
	});
});

bot.onText(/^Villa|Villa di Last|Torna alla Villa|Entra nella Villa/i, function (message) {

	var today = new Date();
	if ((today.getDay() > 2) && (today.getDay() < 6)) {
		villa = 0;
	}

	if (villa == 0) {
		connection.query("SELECT nickname, COUNT(item_id) As cnt FROM event_villa_gift, player WHERE event_villa_gift.from_id = player.id GROUP BY from_id ORDER BY COUNT(item_id) DESC LIMIT 50", function (err, rows, fields) {
			if (err) throw err;

			var text = "";
			var c = 1;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				text += c + "Â° " + rows[i].nickname + " (" + rows[i].cnt + ")\n";
				c++;
			}

			connection.query("SELECT nickname, COUNT(item_id) As cnt FROM event_villa_gift, player WHERE event_villa_gift.to_id = player.id GROUP BY to_id ORDER BY COUNT(item_id) DESC LIMIT 50", function (err, rows, fields) {
				if (err) throw err;

				text += "\n\nE quella di chi ne ha ricevute di piÃ¹:\n";
				c = 1;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					text += c + "Â° " + rows[i].nickname + " (" + rows[i].cnt + ")\n";
					c++;
				}

				bot.sendMessage(message.chat.id, "L'evento Ã¨ terminato! Grazie per aver partecipato, ecco la classifica di chi ha donato piÃ¹ casse:\n" + text, back_html);
			});
		});
		return;
	}

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Invia una Cassa ðŸ“¦"], ["Torna al menu"]]
		}
	};

	var kb1 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Entra nella Villa ðŸ°"], ["Torna al menu"]]
		}
	};

	var kb2 = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna alla Villa"], ["Torna al menu"]]
		}
	};

	var kb3 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna alla Villa"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, account_id, reborn, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		connection.query('SELECT COUNT(*) As cnt, (SELECT COUNT(*) FROM event_villa_gift WHERE from_id = ' + player_id + ') As mycnt FROM event_villa_gift', function (err, rows, fields) {
			if (err) throw err;

			var count = rows[0].cnt;
			var mycount = rows[0].mycnt;

			connection.query('SELECT player_id, points FROM event_villa_status WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					connection.query('UPDATE player SET boost_id = 1, boost_mission = 6 WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						connection.query('INSERT INTO event_villa_status (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella *Villa di LastSoldier95* ðŸ°!\nDurante questa settimana, questo facoltoso cavaliere ti premierÃ  per il completamento di *piÃ¹ missioni possibili*, piÃ¹ missioni verranno completate, piÃ¹ il padrone di casa sarÃ  soddisfatto.\nTi suggerisce anche un modo per coinvolgere piÃ¹ avventurieri possibili regalando loro *Casse Misteriose*!\nImmediatamente egli ti assegna una Bevanda Energetica Plus per partire con piÃ¹ carica e ti augura buona fortuna!", kb1);
						});
					});
					return;
				}

				var gift = Math.floor(rows[0].points / 5);
				var bonusText = "";

				var text = "Benvenut" + gender_text + " nella *Villa di LastSoldier95* ðŸ°!\nSvolgi missioni da questo momento ed ogni 5 punti otterrai la possibilitÃ  di inviare una *Cassa Misteriosa* ðŸ“¦ ad un altro avventuriero!\n\nHai a disposizione *" + gift + "* Casse da inviare\nFin ora sono state inviate *" + count + "* Casse, *" + mycount + "* da parte tua\n\nNota: Se non invierai tutte le casse entro la fine dell'evento, il padrone di casa se le riprenderÃ  scontento del tuo operato" + bonusText;
				bot.sendMessage(message.chat.id, text, kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text.indexOf("Cassa") != -1) {

							if (gift <= 0) {
								bot.sendMessage(message.chat.id, "Non hai Casse a disposizione! Svolgi missioni per ottenere punti!", kb2);
								return;
							}

							bot.sendMessage(message.chat.id, "A chi vuoi inviare la Cassa? Puoi inviarne solamente 5 per persona! Scrivi il suo nome utente").then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									var nick = answer.text.replace("@", "");
									connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + nick + '"', function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Il nome utente inserito non esiste!", kb2);
											return;
										}
										var player_id2 = rows[0].id;
										var chat_id = rows[0].chat_id;

										if (player_id != 1){
											if (player_id2 == player_id) {
												bot.sendMessage(message.chat.id, "Quanto Ã¨ orribile inviare un dono a se stessi?! Daiii!", kb2);
												return;
											}

											if (player_id2 == 1) {
												bot.sendMessage(message.chat.id, "Grazie per il pensiero ma il sommo ha giÃ  tutto ciÃ² che gli serve â¤ï¸ ", kb2);
												return;
											}
										}

										connection.query('SELECT * FROM event_villa_gift WHERE from_id = ' + player_id + ' AND to_id = ' + player_id2, function (err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length > 4) {
												bot.sendMessage(message.chat.id, "Non puoi inviare piÃ¹ di 5 regali alla stessa persona!", kb2);
												return;
											}

											connection.query('UPDATE event_villa_status SET points = points-5 WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												connection.query('SELECT id, name FROM item WHERE rarity NOT IN ("C","U","UE","A","X","NC","S","D","H","IN") AND craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
													if (err) throw err;

													var item_id = rows[0].id;
													var item_name = rows[0].name;

													var uArray = [200, 201, 532, 598];
													var nArray = ["Necronucleo", "Respiro di Morte", "Urlo di Morte", "Soffio di Morte"];
													var rand = Math.random() * 500;
													if ((rand < 1) && (reborn < 5)) {
														var i = Math.floor(Math.random() * uArray.length);
														item_id = uArray[i];
														item_name = nArray[i];
														console.log("CASSA U");
													}

													connection.query('INSERT INTO event_villa_gift (from_id, to_id, item_id) VALUES (' + player_id + ',' + player_id2 + ',' + item_id + ')', function (err, rows, fields) {
														if (err) throw err;
														addItem(player_id2, item_id);
														bot.sendMessage(message.chat.id, "Hai inviato una Cassa Misteriosa a <b>" + nick + "</b>!", kb2);
														bot.sendMessage(chat_id, "Hai ricevuto una Cassa Misteriosa contenente <b>" + item_name + "</b> da <b>" + message.from.username + "</b>!", html);
													});
												});
											});
										});
									});
								};
							});
						}
					};
				});
			});
		});
	});
});

bot.onText(/Casa nella Neve|Torna alla Casa$|Entra nella Casa$|villaggio innevato/i, function (message) {

	if (snowHouseEnd == 1){
		bot.sendMessage(message.chat.id, "L'evento Ã¨ terminato! A breve verranno distribuiti i premi, grazie per aver partecipato.", back);
		return;
	}

	if ((snowHouse == 0) && (message.from.id != 20471035)){
		//bot.sendMessage(message.chat.id, "I giocatori si stanno lentamente riunendo nel villaggio innevato... Pazienta!", back);
		bot.sendMessage(message.chat.id, "La neve lentamente si scioglie...", back);
		return;
	}

	connection.query('SELECT id, account_id, life, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].life <= 0){
			bot.sendMessage(message.chat.id, "Recupera salute prima di partecipare!", revive);
			return;
		}

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		var kbBack = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla Casa"], ["Torna al menu"]]
			}
		};

		var kb = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Lancia Palla di Neve â„ï¸"], ["Costruisci un Pupazzo â›„ï¸"], ["Classifica ðŸ”", "Torna al menu"]]
			}
		};

		var kb2 = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Casuale"], ["Torna alla Casa"]]
			}
		};

		var kb3 = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Entra nella Casa"], ["Torna alla Casa"]]
			}
		};

		var kbYesNo = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna alla Casa"]]
			}
		};

		connection.query('SELECT snowball FROM event_snowball_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO event_snowball_status (player_id, snowball) VALUES (' + player_id + ', 5)', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella <b>Casa nella Neve</b> ðŸŒ¨, l'evento Natalizio!\nSi tratta in tutto per tutto di una competizione per chi riuscirÃ  a costruire piÃ¹ Pupazzi di Neve in tutto il regno di Lootia. Con le Palle di Neve puoi costruirne sempre di piÃ¹, oppure danneggiare quelli avversari per far perdere loro punti. Puoi accumulare la Neve attraverso Missioni, Ispezioni o nei Dungeon.\nBuona fortuna!\nHai ricevuto <b>5 Palle di Neve</b> per l'iscrizione.", kb3);
				});
				return;
			}

			var snowball = rows[0].snowball;

			connection.query('SELECT SUM(snowball) As cnt FROM event_snowball_status', function (err, rows, fields) {
				if (err) throw err;

				var snowball_tot = rows[0].cnt;

				connection.query('SELECT COUNT(id) As cnt FROM event_snowball_list', function (err, rows, fields) {
					if (err) throw err;

					var snowman_cnt_tot = parseInt(rows[0].cnt);

					connection.query('SELECT COUNT(id) As cnt FROM event_snowball_list WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						var snowman_cnt = parseInt(rows[0].cnt);

						bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella tua <b>Casa nella Neve</b> ðŸŒ¨!\nDurante questa settimana si svolge una gara che premierÃ  chi riuscirÃ  a costruire piÃ¹ Pupazzi di Neve degli altri partecipanti!\nPer costruirne un altro ti servono <b>" + (10+(snowman_cnt*10)) + " Palle di Neve</b>, puoi lanciarne una per danneggiare gli avversari oppure i loro pupazzi.\n\nPossiedi <b>" + snowball + "</b> Palle di Neve â„ï¸ e <b>" + snowman_cnt + "</b> Pupazzi di Neve â›„ï¸!\nIn totale sono stati creati <b>" + snowman_cnt_tot + "</b> Pupazzi e ci sono " + snowball_tot + " Palle di Neve!\n\nC'Ã¨ una probabilitÃ  di ottenerne altre tramite missioni, ispezioni o sconfiggendo mostri nel dungeon, ogni Pupazzo ti fornirÃ  +1 Palla di Neve per ogni azione\n\nL'evento termina il 31 alle 12:00!", kb).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text == "Lancia Palla di Neve â„ï¸"){
									bot.sendMessage(message.chat.id, "Puoi lanciare una Palla di Neve ad un giocatore in particolare (scrivendo il nickname) oppure ad uno casuale, nel primo caso consumerai 2 Palle di Neve. Nel caso in cui il bersaglio avesse un Pupazzo di Neve, quest'ultimo verrÃ  colpito al posto del giocatore e danneggiato o distrutto. PuÃ² capitare inoltre che il giocatore avversario recuperi la tua Palla di Neve!", kb2).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text == "Torna alla Casa"){
												return;
											}									
											var enemy_player_id = 0;
											var enemy_chat_id = 0;
											var enemy_life = 0;
											var enemy_nickname = "";
											var enemy_snowman_id = 0;

											var isSnowMan = 0;

											if (answer.text == "Casuale"){
												var rows = connection_sync.query('SELECT event_snowball_status.player_id, player.chat_id, player.life, player.nickname FROM event_snowball_status, player WHERE event_snowball_status.player_id = player.id AND event_snowball_status.player_id != ' + player_id + ' AND player.life > 0 ORDER BY RAND()');

												if (Object.keys(rows).length > 0){
													enemy_player_id = rows[0].player_id;
													enemy_chat_id = rows[0].chat_id;
													enemy_life = rows[0].life;
													enemy_nickname = rows[0].nickname;
												}

												rows = connection_sync.query('SELECT event_snowball_list.id, event_snowball_list.player_id, player.chat_id, event_snowball_list.life, player.nickname FROM event_snowball_list, player WHERE event_snowball_list.player_id = player.id AND player_id = ' + enemy_player_id + ' AND event_snowball_list.life > 0 ORDER BY RAND()');

												if (Object.keys(rows).length > 0){
													enemy_player_id = rows[0].player_id;
													enemy_chat_id = rows[0].chat_id;
													enemy_life = rows[0].life;
													enemy_nickname = rows[0].nickname;
													enemy_snowman_id = rows[0].id;
													isSnowMan = 1;
												}

												if ((Object.keys(rows).length == 0) && (enemy_player_id == 0)){
													bot.sendMessage(message.chat.id, "Non Ã¨ disponibile alcun bersaglio in salute!", kbBack);
													return;
												}


												if (snowball < 1){
													bot.sendMessage(message.chat.id, "Non hai abbastanza Palle di Neve!", kbBack);
													return;
												}

												connection.query('UPDATE event_snowball_status SET snowball = snowball-1 WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}else{

												answer.text = answer.text.replace("@","");

												if (answer.text.toLowerCase() == message.from.username){
													bot.sendMessage(message.chat.id, "Non lanciare le Palle di Neve a te stesso!", kbBack);
													return;
												}

												var rows = connection_sync.query('SELECT event_snowball_list.id, event_snowball_list.player_id, player.chat_id, event_snowball_list.life, player.nickname FROM event_snowball_list, player WHERE event_snowball_list.player_id = player.id AND nickname = "' + answer.text + '" AND event_snowball_list.life > 0');

												if (Object.keys(rows).length > 0){
													enemy_player_id = rows[0].player_id;
													enemy_chat_id = rows[0].chat_id;
													enemy_life = rows[0].life;
													enemy_nickname = rows[0].nickname;
													enemy_snowman_id = rows[0].id;
													isSnowMan = 1;
												}

												rows = connection_sync.query('SELECT event_snowball_status.player_id, player.chat_id, player.life, player.nickname FROM event_snowball_status, player WHERE event_snowball_status.player_id = player.id AND player.nickname = "' + answer.text + '"');

												if (isSnowMan == 0){
													if (Object.keys(rows).length == 0){
														bot.sendMessage(message.chat.id, "Il giocatore non esiste o non Ã¨ registrato all'evento", kbBack);
														return;
													}

													if (rows[0].life <= 0){
														bot.sendMessage(message.chat.id, "Il giocatore Ã¨ troppo stanco per essere colpito", kbBack);
														return;
													}
													enemy_player_id = rows[0].player_id;
													enemy_chat_id = rows[0].chat_id;
													enemy_life = rows[0].life;
													enemy_nickname = rows[0].nickname;
												}

												if (snowball < 2){
													bot.sendMessage(message.chat.id, "Non hai abbastanza Palle di Neve! Ne servono due per mirare con piÃ¹ accuretezza un giocatore", kbBack);
													return;
												}

												connection.query('UPDATE event_snowball_status SET snowball = snowball-2 WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}

											var text = "";
											var text2 = "";
											var rand = Math.random()*100;
											if (rand < 30){
												if (isSnowMan == 0){
													text = " Ma ha recuperato la tua Palla di Neve!";
													text2 = " Ma hai recuperato la sua Palla di Neve!";
												}else{
													text = " Il giocatore ha recuperato la tua Palla di Neve!";
													text2 = " Hai recuperato la sua Palla di Neve!";
												}

												connection.query('UPDATE event_snowball_status SET snowball = snowball+1 WHERE player_id = ' + enemy_player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}

											if (isSnowMan == 0){
												var damage = Math.round(getRandomArbitrary(enemy_life*0.05, enemy_life*0.1));

												bot.sendMessage(message.chat.id, "Hai lanciato una Palla di Neve e hai colpito <b>" + enemy_nickname + "</b> che ha perso " + formatNumber(damage) + " hp!" + text, kbBack);
												bot.sendMessage(enemy_chat_id, "Sei stato colpito dalla Palla di Neve di <b>" + message.from.username + "</b> e hai perso " + formatNumber(damage) + " hp!" + text2, html);

												connection.query('UPDATE player SET life = life-' + damage + ' WHERE id = ' + enemy_player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}else{
												var destroy = 0;
												if (enemy_life <= 2){
													connection.query('DELETE FROM event_snowball_list WHERE id = ' + enemy_snowman_id, function (err, rows, fields) {
														if (err) throw err;
													});
													bot.sendMessage(message.chat.id, "Hai lanciato una Palla di Neve e hai colpito il Pupazzo di Neve di <b>" + enemy_nickname + "</b> distruggendolo!" + text, kbBack);
													bot.sendMessage(enemy_chat_id, "Il tuo Pupazzo di Neve Ã¨ stato distrutto dalla Palla di Neve di <b>" + message.from.username + "</b>!" + text2, html);
												}else{
													connection.query('UPDATE event_snowball_list SET life = life-2 WHERE id = ' + enemy_snowman_id, function (err, rows, fields) {
														if (err) throw err;
													});
													bot.sendMessage(message.chat.id, "Hai lanciato una Palla di Neve e hai colpito il Pupazzo di Neve di <b>" + enemy_nickname + "</b> che ha perso 2 porzione di neve!" + text, kbBack);
													bot.sendMessage(enemy_chat_id, "Il tuo Pupazzo di Neve Ã¨ stato colpito dalla Palla di Neve di <b>" + message.from.username + "</b> e ha perso 2 porzione di neve!" + text2, html);
												}
											}
										};
									});
								}else if (answer.text == "Costruisci un Pupazzo â›„ï¸"){
									var cost = (10+(snowman_cnt*10));
									bot.sendMessage(message.chat.id, "Costruire un Pupazzo di Neve â›„ï¸ ti costerÃ  " + cost + " Palle di Neve, in piÃ¹ ti proteggerÃ  dalle Palle di Neve avversarie, procedi?", kbYesNo).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text == "Si"){
												if (snowball < cost){
													bot.sendMessage(message.chat.id, "Non hai abbastanza Palle di Neve!", kbBack);
													return;
												}
												connection.query('UPDATE event_snowball_status SET snowball = snowball-' + cost + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													connection.query('INSERT INTO event_snowball_list (player_id, life) VALUES (' + player_id + ', 10)', function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Consumando " + cost + " Palle di Neve hai costruito un <b>Pupazzo di Neve</b>!", kbBack);
													});
												});
											}
										};
									});
								}else if (answer.text == "Classifica ðŸ”"){

									var text = "Classifica per Pupazzi di Neve in vita:\n";

									connection.query('SELECT P.nickname, COUNT(E.id) As points FROM event_snowball_list E, player P WHERE P.id = E.player_id AND P.account_id NOT IN (SELECT account_id FROM banlist) AND P.id NOT IN (1,3) GROUP BY E.player_id ORDER BY points DESC', function (err, rows, fields) {
										if (err) throw err;

										var range = 10;
										var nickname = [];
										var points = [];
										var mypos = 0;

										if (Object.keys(rows).length < 100){
											bot.sendMessage(message.chat.id, "La classifica sarÃ  disponibile con piÃ¹ giocatori iscritti!", kbBack);
											return;
										}

										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											nickname.push(rows[i].nickname);
											points.push(rows[i].points);
											if (message.from.username.toLowerCase() == rows[i].nickname.toLowerCase()) {
												mypos = i;
											}
										}

										for (var i = (mypos - range); i < (mypos + (range + 1)); i++) {
											if (nickname[i] != undefined) {
												if (i == mypos) {
													text += (i + 1) + "Â° <b>" + nickname[i] + "</b> (" + points[i] + ")\n";
												} else {
													text += (i + 1) + "Â° " + nickname[i] + " (" + points[i] + ")\n";
												}
											}
										}

										bot.sendMessage(message.chat.id, text, kbBack);
									});
								}
							};
						});
					});
				});
			});
		});
	});
});

bot.onText(/eventi/i, function (message) {

	var text = "*Eventi Weekend Casuali:\n\n*" +
		//"> *Storia Interattiva* - 1 Settimana\n" +
		"> *Arena dei Draghi* - Weekend\n" +
		"> *Lootteria* - Weekend\n" +
		"> *Weekend della Follia* - Weekend\n" +
		"> *Evento della Luna* - Weekend\n" +
		"> *Il Ricercato* - Weekend\n" +
		"> *Crafting Festival* - Weekend\n" +
		"> *Itinerario Propizio* - Weekend\n" +
		"> *Villa di LastSoldier95* - 4 Giorni\n" +
		"> *Il Canto del Bardo* - Weekend\n" +
		"\n*Eventi Settimanali Ricorrenti:\n\n*" +
		"> *Miniere di Mana* - GiovedÃ¬/VenerdÃ¬ \n" +
		"> *Generatore di Polvere* - LunedÃ¬/MartedÃ¬\n" +
		"> *Casa dei Giochi* - MercoledÃ¬\n" +
		"\nGli eventi vengono modificati di volta in volta per essere migliorati, e non avvengono per forza in questo ordine!\n" +
		"Per partecipare compariranno gli appositi pulsanti nel menÃ¹.";

	bot.sendMessage(message.chat.id, text, back);
});

bot.onText(/festival/i, function (message) {

	if (eventFestival == 0) {
		bot.sendMessage(message.chat.id, "Evento non disponibile!", back);
		return;
	}

	var today = new Date();
	if ((today.getDay() != 6) && (today.getDay() != 0)) {
		bot.sendMessage(message.chat.id, "L'evento non Ã¨ piÃ¹ disponibile!", back);
		return;
	}

	connection.query('SELECT id, holiday, account_id, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back);
			return;
		}

		var player_id = rows[0].id;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		connection.query('SELECT * FROM event_crafting_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Entra nel festival"], ["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO event_crafting_status (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "*Benvenut" + gender_text + " nel Crafting Festival v2!*\nIn questo evento ogni 2 ore viene selezionato un oggetto da creare, e chi lo crea, allo scadere del tempo, o al raggiungimento di un valore massimo, riceverÃ  un premio in base alla quantitÃ  delle sue creazioni!\nInoltre piÃ¹ volte l'oggetto viene creato, piÃ¹ salirÃ  il suo valore. Preparati a consumare fino all'ultimo pezzettino di legno del tuo zaino, buon crafting!", eventKb);
					return;
				});
			} else {
				connection.query('SELECT event_crafting_item.completed, event_crafting_item.cnt, event_crafting_item.increm, event_crafting_item.start_price, event_crafting_item.incremDelta, event_crafting_item.total_price, event_crafting_item.time, event_crafting_item.wait_time, event_crafting_item.full_price, item.name, item.rarity, event_crafting_item.increm, rarity.id As rarity_id FROM event_crafting_item, item, rarity WHERE item.id = event_crafting_item.item_id AND rarity.shortname = item.rarity ORDER BY event_crafting_item.id DESC LIMIT 1', function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Non Ã¨ disponibile ancora nessun oggetto da creare", rKb);
					} else {
						if (rows[0].wait_time != null) {

							var rKb = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Aggiorna festival"], ["Cerca " + rows[0].name], ["Torna al menu"]]
								}
							};

							var d = new Date(rows[0].wait_time);
							var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());
							bot.sendMessage(message.chat.id, "In attesa per l'oggetto *" + rows[0].name + " (" + rows[0].rarity + ")*.\nSarÃ  disponibile alle " + short_date + " con un prezzo di partenza di *" + formatNumber(rows[0].start_price) + " Â§*.", rKb);
						} else {
							var plur = "e";
							if (rows[0].cnt == 1) {
								plur = "a";
							}

							var rKb = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Aggiorna festival"], ["Cerca " + rows[0].name], ["Crea " + rows[0].name], ["Torna al menu"]]
								}
							};

							var incremDelta = rows[0].incremDelta;
							var cap = rows[0].start_price * 5 * (7 - rows[0].rarity_id);
							cap += cap * (rows[0].increm / 100);

							var extra = "";
							if (player_id == 1)
								extra = "\nCap: " + formatNumber(incremDelta) + "/" + formatNumber(cap);

							if (rows[0].completed == 1){
								bot.sendMessage(message.chat.id, "L'oggetto da creare Ã¨ terminato! Attendi per ricevere la ricompensa.", rKb);
								return;
							}

							var d = new Date(rows[0].time);
							var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());
							bot.sendMessage(message.chat.id, "L'oggetto da creare Ã¨:\n\n*" + rows[0].name + " (" + rows[0].rarity + ")*, il gruzzolone ha raggiunto la quota di *" + formatNumber(rows[0].total_price) + 
											" Â§*\n\nCreato *" + rows[0].cnt + "* volt" + plur + ", verrÃ  aggiornato alle *" + short_date + "* o al raggiungimento di un valore massimo (bonus cap: *" + rows[0].increm + "%*)!\n\nCompletamento: " + calcBar(incremDelta, cap) + 
											"\n\nCompleta l'oggetto per incrementare il bonus cap! In caso contrario verrÃ  resettato." + extra, rKb);
						}
					}
				});
			}
		});
	});
});

function calcBar(parz, tot) {
	var perc_life = "";
	var perc = Math.round((100 / tot * parz) / 10);
	for (i = 0; i < perc; i++) {
		perc_life += "â– ";
	}
	var perc2 = 10 - perc;
	for (i = 0; i < perc2; i++) {
		perc_life += "â–¡";
	}
	return perc_life;
}

bot.onText(/Miniere di Mana|Raccolta/i, function (message) {
	if (eventMana == 0) {
		bot.sendMessage(message.chat.id, "L'evento non Ã¨ disponibile oggi!", back);
		return;
	}

	var back2 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Sintesi"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, class, reborn, holiday, account_id, travel_id, cave_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back);
			return;
		}

		if (rows[0].cave_id != 0) {
			bot.sendMessage(message.chat.id, "Non puoi raccogliere mana mentre sei in cava", back2);
			return;
		}
		if (rows[0].travel_id != 0) {
			bot.sendMessage(message.chat.id, "Non puoi raccogliere mana mentre sei in viaggio", back2);
			return;
		}

		var player_id = rows[0].id;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		var mBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla Raccolta"], ["Torna al menu"]]
			}
		};

		var mYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna alla Raccolta"], ["Torna al menu"]]
			}
		};
		var mYesNo2 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Sintesi"], ["Torna al menu"]]
			}
		};

		connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Inizia Raccolta"], ["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO event_mana_status (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Ti sei iscritto alla comunitÃ  di *Estrattori di Mana*!\nQuesto evento Ã¨ l'unica possibilitÃ  di recuperare mana allo scopo di sintetizzare incantesimi e creare oggetti particolarmente utili, inizia ad estrarre mana da una miniera e poi raccogli quando sei soddisfatto, si riempirÃ  col trascorrere del tempo.", eventKb);
					return;
				});
			} else {
				if (rows[0].zone_id != 0) {
					var time_start = new Date(rows[0].time_start);
					var time_creation = time_start.setHours(time_start.getHours());
					var now = new Date();
					var diff = Math.round(((now - time_creation) / 1000) / 60);
					diff = Math.abs(diff);

					connection.query('SELECT * FROM event_mana_zone WHERE id = ' + rows[0].zone_id, function (err, rows, fields) {
						if (err) throw err;

						var rate = rows[0].rate;
						var name = rows[0].mana_name;
						var type = rows[0].type;
						var quantity = Math.floor(diff / 60 * rate);

						if ((class_id == 2) && (reborn > 1)) {
							quantity += quantity * 0.3;
						}
						if ((class_id == 3) && (type == 2) && (reborn > 1)) {
							quantity += quantity * 0.5;
						}
						if ((class_id == 3) && (type != 2) && (reborn > 1)) {
							quantity -= quantity * 0.2;
						}
						if ((class_id == 4) && (type == 3) && (reborn > 1)) {
							quantity += quantity * 0.5;
						}
						if ((class_id == 4) && (type != 3) && (reborn > 1)) {
							quantity -= quantity * 0.2;
						}
						if ((class_id == 5) && (type == 1) && (reborn > 1)) {
							quantity += quantity * 1;
						}
						if ((class_id == 5) && (type != 1) && (reborn > 1)) {
							quantity -= quantity * 0.1;
						}
						if ((class_id == 6) && (reborn > 1)) {
							quantity -= quantity * 0.1;
						}

						connection.query('SELECT mana.name, chat_id, nickname, player_id, rate, type, ROUND(TIMESTAMPDIFF(MINUTE,time_start,NOW())/60*rate,0) As quantity FROM event_mana_status, event_mana_zone, player, mana WHERE mana.id = event_mana_zone.type AND player.id = player_id AND event_mana_status.time_start IS NOT NULL AND event_mana_status.zone_id = event_mana_zone.id AND player.id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							//console.log(quantity + " - " + rows[0].quantity);

							//quantity = rows[0].quantity;
							quantity = Math.floor(quantity);

							bot.sendMessage(message.chat.id, "Attualmente stai estraendo da una miniera, vuoi interrompere e ottenere " + quantity + " Mana " + name + "?", mYesNo2).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text.toLowerCase() == "si") {
										connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if (rows[0].zone_id == 0) {
												bot.sendMessage(message.chat.id, "Attualmente non stai estraendo", mBack);
												return;
											}

											var mana_type = 'mana_' + type;
											connection.query('UPDATE event_mana_status SET ' + mana_type + ' = ' + mana_type + ' + ' + quantity + ', zone_id = 0, time_start = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai ricevuto " + quantity + " Mana " + name + "!", mBack);
											});
										});
									}
								};
							});
						});
					});

					return;
				}

				var text = "Blu: " + formatNumber(rows[0].mana_1) + "\n" +
					"Giallo: " + formatNumber(rows[0].mana_2) + "\n" +
					"Rosso: " + formatNumber(rows[0].mana_3);

				connection.query('SELECT * FROM event_mana_zone', function (err, rows, fields) {
					if (err) throw err;

					var iKeys = [];
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						iKeys.push([rows[i].name + " (" + rows[i].mana_name + " " + rows[i].rate + "/ora)"]);
					}

					iKeys.push(["Sintesi"]);
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona la miniera dalla quale iniziare a estrarre mana.\nAl momento possiedi:\n" + text + "\nAvrai possibilitÃ  di estrarre ogni giovedÃ¬ e venerdÃ¬ della settimana", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if ((answer.text == "Torna al menu") || (answer.text == "Sintesi")) {
								return;
							}

							var zone = answer.text.substring(0, answer.text.indexOf("(") - 1);

							connection.query('SELECT * FROM event_mana_zone WHERE name = "' + zone + '"', function (err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0) {
									bot.sendMessage(message.chat.id, "Miniera non valida", mBack);
									return;
								}

								var zone_id = rows[0].id;

								bot.sendMessage(message.chat.id, "Iniziare l'estrazione nella " + zone + "?", mYesNo).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "si") {

											var d = new Date();
											if ((d.getDay() != 4) && (d.getDay() != 5)) {
												bot.sendMessage(message.chat.id, "Non puoi estrarre oggi", back);
												return;
											}

											var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

											connection.query('UPDATE event_mana_status SET time_start = "' + long_date + '", zone_id = ' + zone_id + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Estrazione iniziata, torna qui tra qualche ora per concluderla e ricevere ciÃ² che hai estratto", mBack);
											});
										}
									};
								});
							});
						};
					});
				});
			}
		});
	});
});

bot.onText(/generatore di polvere|torna al generatore/i, function (message) {
	if (eventDust == 0) {
		bot.sendMessage(message.chat.id, "L'evento non Ã¨ disponibile oggi!", back);
		return;
	}

	connection.query('SELECT id, class, reborn, holiday, account_id, travel_id, cave_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Account non trovato", back);
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back);
			return;
		}

		if (rows[0].cave_id != 0) {
			bot.sendMessage(message.chat.id, "Non puoi raccogliere polvere mentre sei in cava", back);
			return;
		}
		if (rows[0].travel_id != 0) {
			bot.sendMessage(message.chat.id, "Non puoi raccogliere polvere mentre sei in viaggio", back);
			return;
		}

		var player_id = rows[0].id;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		var gBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna al Generatore di Polvere"], ["Torna al menu"]]
			}
		};

		var gYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna al Generatore di Polvere"]]
			}
		};

		var eventKb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Vai al Generatore di Polvere"], ["Torna al menu"]]
			}
		};

		var eventKb2 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Aziona Generatore"], ["Aumenta Deposito", "Utilizza Polvere"], ["Genera Scaglia Evolutiva"], ["Torna al menu"]]
			}
		};

		var eventKb3 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Ritira", "Spegni"], ["Torna al menu"]]
			}
		};

		connection.query('UPDATE event_dust_status SET `generated` = max_qnt WHERE `generated` > max_qnt AND player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			connection.query('SELECT * FROM event_dust_status WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					connection.query('INSERT INTO event_dust_status (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Hai ricevuto il tuo *Generatore di Polvere*!\nPotrai utilizzare la polvere prodotta per generare un oggetto a tua scelta, il cui costo aumenterÃ  in base al valore dello stesso, Ã¨ disponibile ogni lunedÃ¬ e martedÃ¬!", eventKb);
						return;
					});
				} else {
					var max_qnt = parseInt(rows[0].max_qnt);
					var qnt = parseInt(rows[0].qnt);

					if (rows[0].extracting == 1) {
						var generated = rows[0].generated;
						var updateTime = rows[0].last_update;
						bot.sendMessage(message.chat.id, "Hai generato fin ora " + generated + "/" + max_qnt + " unitÃ  di polvere, vuoi spegnere il generatore o ritirarla?\n\nUltima attivitÃ : " + toDate("it", updateTime), eventKb3).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text == "Torna al menu") {
									return;
								}
								if (answer.text == "Ritira") {
									connection.query('SELECT `generated` FROM event_dust_status WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										if (rows[0].generated == 0) {
											bot.sendMessage(message.chat.id, "Non c'Ã¨ ancora abbastanza Polvere per poterla ritirare!", gBack);
											return;
										}

										addItem(player_id, 646, rows[0].generated);
										var d = new Date();
										var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
										connection.query('UPDATE event_dust_status SET `generated` = 0, notified = 0, last_update = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
										bot.sendMessage(message.chat.id, "Hai ottenuto " + rows[0].generated + "x Polvere!", gBack);
									});
								} else if (answer.text == "Spegni") {
									connection.query('UPDATE event_dust_status SET extracting = 0, last_update = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai spento il generatore", gBack);
									});
								}
							};
						});
					} else {
						connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 14', function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length > 0) {
								qnt += parseInt(rows[0].ability_level);
							}


							var unit = getItemCnt(player_id, 646);

							bot.sendMessage(message.chat.id, "*Gestione Generatore*\n\nProdurrai " + qnt + "x Polvere/ora e il deposito ti consente massimo " + max_qnt + " unitÃ \n" +
											"Al momento possiedi " + unit + " unitÃ  nello zaino", eventKb2).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Torna al menu") {
										return;
									}
									if (answer.text == "Aziona Generatore") {
										var d = new Date();
										var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
										connection.query('UPDATE event_dust_status SET extracting = 1, last_update = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Generatore azionato! Torna tra un po' di tempo per ritirare la polvere prodotta!", back);
										});
									} else if (answer.text == "Aumenta Deposito") {
										if (max_qnt >= 54) {
											bot.sendMessage(message.chat.id, "Il deposito del generatore Ã¨ giÃ  potenziato al massimo", gBack);
											return;
										}

										bot.sendMessage(message.chat.id, "Aggiungere 2 unitÃ  al tuo deposito ti costerÃ  50.000 Â§, procedi?", gYesNo).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text.toLowerCase() == "si") {
													connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														if (rows[0].money < 50000) {
															bot.sendMessage(message.chat.id, "Non hai abbastanza monete", gBack);
															return;
														}
														connection.query('UPDATE player SET money = money-50000 WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															connection.query('UPDATE event_dust_status SET max_qnt = max_qnt + 2 WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Hai potenziato il deposito e hai raggiunto " + (max_qnt + 2) + " unitÃ  di spazio disponibile!", gBack);
															});
														});
													});
												}
											}
										});
									}
								};
							});
						});
					}
				}
			});
		});
	});
});

bot.onText(/^\/sintesi (.+),(.+),(.+)|^\/sintesi/i, function (message, match) {
	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		if ((match[1] == undefined) || (match[2] == undefined) || (match[3] == undefined)) {
			bot.sendMessage(message.chat.id, "Utilizza la sintassi '/sintesi 100,200,300' (blu, giallo, rosso) per continuare", back);
			return;
		}

		connection.query('DELETE FROM magic WHERE quantity <= 0 AND player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 13', function (err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				if (Object.keys(rows).length > 0) {
					abBonus = rows[0].ability_level * rows[0].val;
				}
				var maxUnit = 200;
				maxUnit += abBonus;

				connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Non possiedi alcuna riserva di mana", back)
						return;
					}

					var mana_1 = rows[0].mana_1;
					var mana_2 = rows[0].mana_2;
					var mana_3 = rows[0].mana_3;

					connection.query('SELECT COUNT(*) As cnt FROM magic WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						if (rows[0].cnt >= 5) {
							bot.sendMessage(message.chat.id, "Non puoi sintetizzare altre magie prima di averle consumate", back);
							return;
						}

						var m1 = parseInt(match[1]); //BLU
						if ((isNaN(m1)) || (m1 < 0) || (re.test(m1) == false)) {
							bot.sendMessage(message.chat.id, "QuantitÃ  non valida", back);
							return;
						}

						if (m1 > mana_1) {
							bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", back);
							return;
						}

						var m2 = parseInt(match[2]); //GIALLO
						if (isNaN(m2) || (m2 < 0) || (re.test(m2) == false)) {
							bot.sendMessage(message.chat.id, "QuantitÃ  non valida", back);
							return;
						}

						if (m2 > mana_2) {
							bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", back);
							return;
						}


						var m3 = parseInt(match[3]); //ROSSO
						if (isNaN(m3) || (m3 < 0) || (re.test(m3) == false)) {
							bot.sendMessage(message.chat.id, "QuantitÃ  non valida", back);
							return;
						}

						if (m3 > mana_3) {
							bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", back);
							return;
						}

						bot.sendMessage(message.chat.id, "Iniziare la sintesi utilizzando le unitÃ  selezionate?", yesno).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {

								if (answer.text.toLowerCase() == "si") {
									connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										if (m1 > rows[0].mana_1) {
											bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Blu", back);
											return;
										}
										if (m2 > rows[0].mana_2) {
											bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Giallo", back);
											return;
										}
										if (m3 > rows[0].mana_3) {
											bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Rosso", back);
											return;
										}

										m1 = parseInt(m1);
										m2 = parseInt(m2);
										m3 = parseInt(m3);
										var power = m1 + m2 + m3;

										if (power > maxUnit) {
											bot.sendMessage(message.chat.id, "Il valore complessivo di Mana non puÃ² superare i " + maxUnit + " punti, ora Ã¨ pari a " + power);
											return;
										}
										if (power < 50) {
											bot.sendMessage(message.chat.id, "Minimo 50 di potenza, ora " + power, back);
											return;
										}

										var type = 0;
										var quantity = 3;
										var magic_name = "";

										if ((m1 == m2) && (m2 == m3) && (m1 == m3)) {
											type = 4;
											magic_name = "Ira Astrale";
										} else if ((m1 >= m2) && (m1 >= m3)) {
											type = 1;
											magic_name = "Furia dei Mari";
										} else if ((m2 >= m1) && (m2 >= m3)) {
											type = 2;
											magic_name = "Tempesta Folgorante";
										} else if ((m3 >= m1) && (m3 >= m2)) {
											type = 3;
											magic_name = "Impeto di Fiamme";
										} else {
											bot.sendMessage(message.chat.id, "Configurazione non valida, riprova", back);
											return;
										}



										connection.query('UPDATE event_mana_status SET mana_1 = mana_1 - ' + m1 + ', mana_2 = mana_2 - ' + m2 + ', mana_3 = mana_3 - ' + m3 + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											connection.query('INSERT INTO magic (player_id, type, power, quantity) VALUES (' + player_id + ',' + type + ',' + power + ',' + quantity + ')', function (err, rows, fields) {
												if (err) throw err;

												var kb = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [["Torna al dungeon", "Affronta boss"], ["Torna al menu"]]
													}
												};

												bot.sendMessage(message.chat.id, "Hai sintetizzato *" + magic_name + " " + power + "*!", kb);
												setAchievement(message.chat.id, player_id, 28, 1);
											});
										});
									});
								};
							};
						});
					});
				});
			});
		});
	});
});

bot.onText(/^sintesi|Torna alla Sintesi/i, function (message) {
	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non possiedi alcuna riserva di mana", back)
				return;
			}

			var mana_1 = rows[0].mana_1;
			var mana_2 = rows[0].mana_2;
			var mana_3 = rows[0].mana_3;

			var text = "Blu: " + formatNumber(mana_1) + "\n" +
				"Giallo: " + formatNumber(mana_2) + "\n" +
				"Rosso: " + formatNumber(mana_3);

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Inizia Sintesi"], ["Sintetizza Materiali Finali"], ["Torna al menu"]]
				}
			};

			var kbBack = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Torna alla Sintesi"], ["Torna al menu"]]
				}
			};

			var kbYesNo = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Si"], ["Torna alla Sintesi"]]
				}
			};

			var kb2 = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["0", "10", "20"], ["50", "100", "200"], ["Annulla"]]
				}
			};

			connection.query('DELETE FROM magic WHERE quantity <= 0 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				connection.query('SELECT type, power, quantity FROM magic WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length > 0) {
						text = text + "\n\n*Incantesimi posseduti:*\n\n";
						var n = "";
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].type == 1) {
								n = "Furia dei Mari";
							} else if (rows[i].type == 2) {
								n = "Tempesta Folgorante";
							} else if (rows[i].type == 3) {
								n = "Impeto di Fiamme";
							} else if (rows[i].type == 4) {
								n = "Ira Astrale";
							}
							text = text + "> " + n + " " + rows[i].power + " (" + rows[i].quantity + ")\n";
						}
						text = text + "\n";
					} else {
						text = text + "\n\nNessun incantesimo posseduto\n";
					}

					connection.query('SELECT name, quantity FROM inventory, item WHERE item.id IN (623, 624, 625, 635, 636, 637) AND item.id = inventory.item_id AND quantity > 0 AND player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length > 0) {
							text = text + "\n\n*Materiali finali posseduti:*\n\n";
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								text = text + "> " + rows[i].name + " (" + rows[i].quantity + ")\n";
							}
							text = text + "\n";
						} else {
							text = text + "\n\nNessun materiale finale posseduto\n";
						}

						connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 13', function (err, rows, fields) {
							if (err) throw err;

							var abBonus = 0;
							if (Object.keys(rows).length > 0) {
								abBonus = rows[0].ability_level * rows[0].val;
							}
							var maxUnit = 200;
							maxUnit += abBonus;

							bot.sendMessage(message.chat.id, "*Le tue riserve di mana:*\n\n" + text, kb).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Torna al menu") {
										return;
									}

									if (answer.text == "Sintetizza Materiali Finali") {
										connection.query('SELECT name FROM item WHERE id IN (623, 624, 625, 635, 636, 637)', function (err, rows, fields) {
											if (err) throw err;

											var iKeys = [];

											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												iKeys.push([rows[i].name]);
											}

											iKeys.push(["Torna alla Sintesi"]);
											var kb_f = {
												parse_mode: "Markdown",
												reply_markup: {
													resize_keyboard: true,
													//one_time_keyboard: true,
													"keyboard": iKeys
												}
											};
											bot.sendMessage(message.chat.id, "Questa sezione Ã¨ riservata alla sintesi dei componenti finali per le armi, seleziona il componente da sintetizzare", kb_f).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													if (answer.text == "Torna alla Sintesi") {
														return;
													}
													connection.query('SELECT name, id, value FROM item WHERE id IN (623, 624, 625, 635, 636, 637) AND name = "' + answer.text + '"', function (err, rows, fields) {
														if (err) throw err;
														if (Object.keys(rows).length > 0) {
															var qnt = 0;
															var type = 0;
															var itemId = rows[0].id;
															var itemName = rows[0].name;
															var name = "";
															if (rows[0].value == 25000) {
																qnt = 2500;
															} else if (rows[0].value == 100000) {
																qnt = 5000;
															}
															if ((rows[0].id == 623) || (rows[0].id == 635)) {
																type = 2;
																name = "Giallo";
															} else if ((rows[0].id == 624) || (rows[0].id == 636)) {
																type = 3;
																name = "Rosso";
															} else if ((rows[0].id == 625) || (rows[0].id == 637)) {
																type = 1;
																name = "Blu";
															} else {
																bot.sendMessage(message.chat.id, "Errore", kbBack);
																return;
															}
															bot.sendMessage(message.chat.id, "Sintetizzare questo oggetto richiederÃ  " + qnt + " Mana " + name + ", continuare?", kbYesNo).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text.toLowerCase() == "si") {
																		if (type == 1) {
																			if (mana_1 < qnt) {
																				bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Blu", kbBack);
																				return;
																			}
																		} else if (type == 2) {
																			if (mana_2 < qnt) {
																				bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Giallo", kbBack);
																				return;
																			}
																		} else if (type == 3) {
																			if (mana_3 < qnt) {
																				bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Rosso", kbBack);
																				return;
																			}
																		}

																		connection.query('UPDATE event_mana_status SET mana_' + type + ' = mana_' + type + ' - ' + qnt + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																			addItem(player_id, itemId);
																			bot.sendMessage(message.chat.id, "Hai sintetizzato " + itemName + "!", kbBack);
																		});
																	}
																}
															});
														} else {
															bot.sendMessage(message.chat.id, "Oggetto non valido", kbBack);
														}
													});
												}
											});
										});
										return;
									} else if (answer.text == "Inizia Sintesi") {
										bot.sendMessage(message.chat.id, "Puoi sintetizzare un incantesimo utilizzando qualsiasi quantitÃ  di mana per tipo, per un massimo di " + maxUnit + " unitÃ  complessive, piÃ¹ Ã¨ alto il valore, piÃ¹ sarÃ  efficace l'incantesimo\n" +
														"Ogni incantesimo ha una durata pari a 3 utilizzi, indipendentemente dalla sua potenza, puoi possedere solamente 5 incantesimi contemporaneamente\n" +
														"Quanto Mana Blu vuoi utilizzare? Ne possiedi *" + mana_1 + "* unitÃ , puoi anche scrivere il numero manualmente", kb2).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text == "Annulla") {
													return;
												}

												connection.query('SELECT COUNT(*) As cnt FROM magic WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													if (rows[0].cnt >= 5) {
														bot.sendMessage(message.chat.id, "Non puoi sintetizzare altre magie prima di averle consumate", kbBack);
														return;
													}

													var m1 = parseInt(answer.text);
													if ((isNaN(m1)) || (m1 < 0) || (re.test(m1) == false)) {
														bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbBack);
														return;
													}

													if (m1 > mana_1) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", kbBack);
														return;
													}

													bot.sendMessage(message.chat.id, "Quanto Mana Giallo vuoi utilizzare? Ne possiedi *" + mana_2 + "* unitÃ , puoi anche scrivere il numero manualmente", kb2).then(function () {
														answerCallbacks[message.chat.id] = function (answer) {
															if (answer.text == "Annulla") {
																return;
															}
															var m2 = parseInt(answer.text);
															if (isNaN(m2) || (m2 < 0) || (re.test(m2) == false)) {
																bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbBack);
																return;
															}

															if (m2 > mana_2) {
																bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", kbBack);
																return;
															}

															bot.sendMessage(message.chat.id, "Quanto Mana Rosso vuoi utilizzare? Ne possiedi *" + mana_3 + "* unitÃ , puoi anche scrivere il numero manualmente", kb2).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text == "Annulla") {
																		return;
																	}
																	var m3 = parseInt(answer.text);
																	if (isNaN(m3) || (m3 < 0) || (re.test(m3) == false)) {
																		bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbBack);
																		return;
																	}

																	if (m3 > mana_3) {
																		bot.sendMessage(message.chat.id, "Non hai abbastanza mana di quel tipo", kbBack);
																		return;
																	}

																	bot.sendMessage(message.chat.id, "Iniziare la sintesi utilizzando le unitÃ  selezionate?", yesno).then(function () {
																		answerCallbacks[message.chat.id] = function (answer) {

																			if (answer.text.toLowerCase() == "si") {
																				connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
																					if (err) throw err;

																					if (m1 > rows[0].mana_1) {
																						bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Blu", kbBack);
																						return;
																					}
																					if (m2 > rows[0].mana_2) {
																						bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Giallo", kbBack);
																						return;
																					}
																					if (m3 > rows[0].mana_3) {
																						bot.sendMessage(message.chat.id, "Non hai abbastanza Mana Rosso", kbBack);
																						return;
																					}

																					m1 = parseInt(m1);
																					m2 = parseInt(m2);
																					m3 = parseInt(m3);
																					var power = m1 + m2 + m3;

																					if (power > maxUnit) {
																						bot.sendMessage(message.chat.id, "Il valore complessivo di Mana non puÃ² superare i " + maxUnit + " punti, ora Ã¨ pari a " + power, kbBack);
																						return;
																					}
																					if (power < 50) {
																						bot.sendMessage(message.chat.id, "Minimo 50 di potenza, ora " + power, kbBack);
																						return;
																					}

																					var type = 0;
																					var quantity = 3;
																					var magic_name = "";

																					if ((m1 == m2) && (m2 == m3) && (m1 == m3)) {
																						type = 4;
																						magic_name = "Ira Astrale";
																					} else if ((m1 >= m2) && (m1 >= m3)) {
																						type = 1;
																						magic_name = "Furia dei Mari";
																					} else if ((m2 >= m1) && (m2 >= m3)) {
																						type = 2;
																						magic_name = "Tempesta Folgorante";
																					} else if ((m3 >= m1) && (m3 >= m2)) {
																						type = 3;
																						magic_name = "Impeto di Fiamme";
																					} else {
																						bot.sendMessage(message.chat.id, "Configurazione non valida, riprova", mBack);
																						return;
																					}

																					connection.query('UPDATE event_mana_status SET mana_1 = mana_1 - ' + m1 + ', mana_2 = mana_2 - ' + m2 + ', mana_3 = mana_3 - ' + m3 + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;

																						connection.query('INSERT INTO magic (player_id, type, power, quantity) VALUES (' + player_id + ',' + type + ',' + power + ',' + quantity + ')', function (err, rows, fields) {
																							if (err) throw err;
																							bot.sendMessage(message.chat.id, "Hai sintetizzato *" + magic_name + " " + power + "*!", kbBack);
																							setAchievement(message.chat.id, player_id, 28, 1);
																						});
																					});
																				});
																			};
																		};
																	});
																};
															});
														};
													});
												});
											};
										});
									};
								};
							});
						});
					});
				});
			});
		});
	});
});

bot.onText(/Il Canto del Bardo|Iscrizione dal Bardo|Torna dal Bardo/i, function (message) {

	if (eventTeamStory == 0) {
		return;
	}

	connection.query('SELECT id, holiday, account_id, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		connection.query('SELECT * FROM `team_player`where team_id = (SELECT team_id FROM team_player WHERE player_id = ' + player_id + ') ORDER BY id', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Per partecipare a questo evento devi essere in un team", back);
				return;
			}
			var team_id = rows[0].team_id;

			connection.query('SELECT role FROM team_player WHERE team_id = ' + team_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var isAdmin = 0;
				var adminId = 0;

				if (rows[0].role == 1) {
					isAdmin = 1;
					adminId = player_id;
				}

				if (isAdmin == 0) {
					bot.sendMessage(message.chat.id, "Questo evento Ã¨ gestito dall'amministratore del tuo team, contattalo tramite il gruppo del team per continuare!", back);
					return;
				}

				connection.query('SELECT * FROM event_team_story WHERE team_id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					var eventKb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Iscrizione dal Bardo"], ["Torna al menu"]]
						}
					};

					var kb = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Torna al menu"]]
						}
					};

					var kb2 = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Invia Scrittura"], ["Torna al menu"]]
						}
					};

					var rBack = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Torna dal Bardo"], ["Torna al menu"]]
						}
					};

					var rSend = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Torna dal Bardo"]]
						}
					};

					if (Object.keys(rows).length == 0) {
						connection.query('INSERT INTO event_team_story (team_id) VALUES (' + team_id + ')', function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella gara che tutti i team attendono, il *Canto del Bardo*!\n" +
											"In questa battaglia di scrittura tu ed il tuo team dovrete utilizzare le vostre migliori doti letterarie per stupire il Bardo, e non sarÃ  un'impresa semplice. In base alla vostra abilitÃ  riceverete dei ðŸ¦‹, anche solo partecipando! Le istruzioni saranno disponibili accedendo all'evento.", eventKb);
						});
					} else {

						var win = "";
						if (rows[0].point_1 > 0) {
							win = "\n\nPremio primo giorno: " + rows[0].point_1 + " ðŸ¦‹";
						} else {
							if (rows[0].story_1 != null) {
								win = "\n\nTesto del primo giorno inviato con successo";
							} else {
								win = "\n\nTesto del primo giorno in attesa...";
							}
						}
						if (rows[0].point_2 > 0) {
							win += "\nPremio secondo giorno: " + rows[0].point_2 + " ðŸ¦‹";
						} else {
							if (rows[0].story_2 != null) {
								win += "\nTesto del secondo giorno inviato con successo";
							} else {
								win += "\nTesto del secondo giorno in attesa...";
							}
						}

						var text = "";
						var n = new Date().getDay();
						if (n == 6) {
							text = "<b>Bentornat" + gender_text + "!</b>\nIl Bardo ti suggerisce le istruzioni per la scrittura di oggi, puoi scegliere una delle tre tracce:\n" +
								"> Traccia 1: In un'esplorazione di una delle tante cave di Lootia incontri un uomo altissimo che ti guarda e ti chiede 'Cosa vorresti esplorare nella tua avventura giovane?', ci pensi un po' e dici...\n" +
								"> Traccia 2: Lungo la strada di ritorno da una missione trovi a terra un tronchetto blu duro come l'acciaio, lo guardi con aria interrogativa, a cosa potrebbe servire?\n" +
								"> Traccia 3: Il treno sul quale stai viaggiando si ferma improvvisamente in mezzo al deserto, cosa fai?\n" +
								"- Massimo 4.000 caratteri -\n\n" +
								"Ricorda di inviare la storia prima di mezzanotte, domani cambieranno i temi!";
						} else if (n == 0) {
							text = "<b>Bentornat" + gender_text  + "!</b>\nIl Bardo ti suggerisce le istruzioni per la scrittura di oggi, puoi scegliere una delle tre tracce:\n" +
								"> Traccia 1: Sei ad una festa in maschera, solo che hai dimenticato la maschera! Come te la cavi?\n" +
								"> Traccia 2: Devi spartire un tesoro tra te ed il tuo compagno di avventure, ma la nave su cui ti trovi sta affondando, cosa fai?\n" +
								"> Traccia 3: Vieni trasformato in un Troll di mezza etÃ  con la bava alla bocca per una scommessa persa, come decidi di vivere la tua giornata?\n" +
								"- Massimo 4.000 caratteri -\n\n" +
								"Ricorda di inviare la storia di prima di mezzanotte! Le valutazioni arriveranno il prima possibile";
						} else {
							bot.sendMessage(message.chat.id, "Oggi non Ã¨ disponibile il Bardo, torna quando l'evento Ã¨ attivo", back);
							return;
						}

						bot.sendMessage(message.chat.id, text + win, kb2).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text == "Invia Scrittura") {

									bot.sendMessage(message.chat.id, "Incolla qua il testo completo e attendi la fine della giornata! Ricordati di non utilizzare bestemmie, insulti, argomenti spiacevoli, ecc. (le solite cose), pena il ban di tutto il team dal bot. Forza!", rSend).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text == "Torna dal Bardo") {
												return;
											}

											var text = answer.text;
											/*
											var reg = new RegExp("^[a-zA-Z0-9 \-\;\,\.Ã Ã¹Ã¨Ã¬Ã©Ã²Ã³_\Â§\!\\\n?]{1,4000}$");

											if (!reg.test(text)){
												bot.sendMessage(message.chat.id, "Il testo contiene caratteri non ammessi, riprova", rBack);
												return;
											}
											*/

											var n = new Date().getDay();
											if (n == 6) { //Sabato

												if (rows[0].point_1 > 0) {
													bot.sendMessage(message.chat.id, "Il primo giorno dell'evento Ã¨ terminato", rBack);
													return;
												}

												connection.query('UPDATE event_team_story SET story_1 = "' + connection.escape(text) + '" WHERE team_id = ' + team_id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "La scrittura Ã¨ stata inviata, attendi la fine della giornata per ricevere una valutazione", rSend);
												});
											} else if (n == 0) { //Domenica

												if (rows[0].point_2 > 0) {
													bot.sendMessage(message.chat.id, "Il secondo giorno dell'evento Ã¨ terminato", rBack);
													return;
												}

												connection.query('UPDATE event_team_story SET story_2 = "' + connection.escape(text) + '" WHERE team_id = ' + team_id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "La scrittura Ã¨ stata inviata, attendi la fine della giornata per ricevere una valutazione", rSend);
												});
											}
										};
									});
								}
							};
						});
					}
				});
			});
		});
	});
});

bot.onText(/dai_punti/i, function (message) {
	if (message.from.id != 20471035) {
		return;
	}
	bot.sendMessage(message.chat.id, "Sei sicuro?", yesno).then(function () {
		answerCallbacks[message.chat.id] = function (answer) {
			if (answer.text.toLowerCase() == "si") {
				connection.query('SELECT team_id, point_1, point_2 FROM event_team_story WHERE point_1 > 0 OR point_2 > 0', function (err, rows, fields) {
					if (err) throw err;
					var point = 0;
					var n = new Date().getDay();
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						point = 0;
						point = parseInt(rows[i].point_1 + rows[i].point_2);
						console.log(rows[i].team_id + " -> " + point);
						connection.query('UPDATE team SET point = point+' + point + ' WHERE id = ' + rows[i].team_id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
					bot.sendMessage(message.chat.id, "Consegnati punti anima a " + Object.keys(rows).length + " team", back);
				});
			};
		};
	});
});

bot.onText(/ricercato|evento/i, function (message) {

	if (wanted == 0) {
		return;
	}

	connection.query('SELECT id, holiday, account_id, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		connection.query('SELECT * FROM event_wanted_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Vai all'Evento"], ["Torna al menu"]]
				}
			};

			var kb = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Torna al menu"]]
				}
			};

			var rBack = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Torna al Ricercato"], ["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO event_wanted_status (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nell'*Evento Ricercato*!\nA breve ti verrÃ  assegnato un fuorilegge che dovrai stanare irrompendo nel suo rifugio, potrai ottenere grosse taglie in caso di successo, forza!\nAlla fine visualizzerai una classifica quindi cerca di vincerne il piÃ¹ possibile!\nLe ispezioni al ricercato sono molto veloci, in piÃ¹ solo in questo weekend i tempi generali di ispezione sono ridotti!", eventKb);
				});
			} else {
				connection.query('SELECT E.wanted_id, E.heist_win, E.heist_lost, E.heist_win_2, E.heist_lost_2, player.nickname, player.id, player.ability, player.house_id FROM event_wanted_status E, player WHERE E.wanted_id = player.id AND E.player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					if (Object.keys(rows).length == 0) {
						connection.query('SELECT nickname, from_id, COUNT(from_id) FROM heist_history, player, event_wanted_status WHERE account_id NOT IN (SELECT account_id FROM banlist) AND fail = 0 AND event_wanted_status.player_id = player.id AND player.id = heist_history.from_id AND player.id != ' + player_id + ' AND time between DATE_SUB(now(),INTERVAL 2 MONTH) AND NOW() GROUP BY from_id ORDER BY COUNT(from_id) DESC LIMIT 200', function (err, rows, fields) {
							if (err) throw err;

							var len = Object.keys(rows).length;
							var rand = Math.round(Math.random() * len - 1);

							if (len < 2){
								bot.sendMessage(message.chat.id, "Non ci sono abbastanza cacciatori di taglie, torna tra qualche minuto!!", back);
								return;
							}

							var sel = rows[rand].from_id;
							connection.query('UPDATE event_wanted_status SET wanted_id = ' + sel + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Il ricercato non Ã¨ ancora stato reso pubblico, torna tra qualche secondo!", back);
							});
						});
						return;
					}

					var win = rows[0].heist_win;
					var lost = rows[0].heist_lost;
					var win2 = rows[0].heist_win_2;
					var lost2 = rows[0].heist_lost_2;

					var nick = rows[0].nickname;
					var ab = rows[0].ability;
					var house = rows[0].house_id;

					connection.query('SELECT heist_win_2 FROM event_wanted_status WHERE player_id = ' + rows[0].wanted_id, function (err, rows, fields) {
						if (err) throw err;

						var value1 = ((parseInt(win2) * 100) + 1000);
						var value2 = ((parseInt(rows[0].heist_win_2) * 100) + 1000)
						if (value1 > 15000) {
							value1 = 15000;
						}
						if (value2 > 15000) {
							value2 = 15000;
						}

						var text = "<b>Il tuo status da ricercato</b>:\nVittorie/Sconfitte: " + win + " / " + lost + "\nSubite/Respinte: " + lost2 + " / " + win2 + "\nLa tua taglia: " +
							value1 + " Â§\n\n" +
							"ðŸ‘º Il ricercato Ã¨ <b>" + nick + "</b> con abilitÃ  " + ab + " ed un rifugio al livello " + house + "!\n" +
							"Ispeziona il suo rifugio per catturarlo e ottenere la taglia!\nTaglia attuale: " + value2 + " Â§";
						var kb2 = {
							parse_mode: "HTML",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Ispeziona: " + nick], ["I piÃ¹ pericolosi"], ["Torna al menu"]]
							}
						};
						bot.sendMessage(message.chat.id, text, kb2).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase().indexOf("pericolosi") != -1) {
									connection.query('SELECT nickname, event_wanted_status.heist_win FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_win DESC LIMIT 5', function (err, rows, fields) {
										if (err) throw err;
										var text = "Utenti che hanno catturato piÃ¹ ricercati:\n";
										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											text += "> " + rows[i].nickname + " (" + rows[i].heist_win + ")	\n";
										};
										connection.query('SELECT nickname, event_wanted_status.heist_lost FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_lost DESC LIMIT 5', function (err, rows, fields) {
											if (err) throw err;
											text += "\nUtenti che hanno fallito piÃ¹ volte:\n";
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												text += "> " + rows[i].nickname + " (" + rows[i].heist_lost + ") \n";
											};

											connection.query('SELECT nickname, event_wanted_status.heist_win_2 FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_win_2 DESC LIMIT 5', function (err, rows, fields) {
												if (err) throw err;
												text += "\nUtenti che hanno subito e vinto piÃ¹ tentativi:\n";
												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													text += "> " + rows[i].nickname + " (" + rows[i].heist_win_2 + ") \n";
												};
												connection.query('SELECT nickname, event_wanted_status.heist_lost_2 FROM event_wanted_status, player WHERE event_wanted_status.player_id = player.id ORDER BY event_wanted_status.heist_lost_2 DESC LIMIT 5', function (err, rows, fields) {
													if (err) throw err;
													text += "\nUtenti che hanno subito e perso piÃ¹ tentativi:\n";
													for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
														text += "> " + rows[i].nickname + " (" + rows[i].heist_lost_2 + ") \n";
													};
													bot.sendMessage(message.chat.id, text, rBack);
												});
											});
										});
									});
								}
							};
						});
					});
				});
			}
		});
	});
});

bot.onText(/Il Tesoro di Arthur|Evento/i, function (message) {

	return;

	if (eventStory == 0) {
		bot.sendMessage(message.chat.id, "L'evento sarÃ  disponibile a breve!", back);
		return;
	}

	connection.query('SELECT id, holiday, account_id, mission_id, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		connection.query('SELECT * FROM mission_event_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var eventKb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Vai all'Evento"], ["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length == 0) {
				// Prima volta

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Iscriviti al Registro"], ["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella Storia Interattiva!\nQuesto evento Ã¨ composto da missioni che sono collegate fra di loro con scelte che dovrai intraprendere, a seconda del percorso comporrai una storia diversa e arriverai ad un finale diverso, con un premio diverso.\n\nTuttavia Ã¨ possibile completare il percorso solamente una volta, e l'evento ha una durata limitata. Quando vuoi iniziare clicca sul pulsante Iscriviti al Registro. Buon divertimento!\n\n_Questo evento Ã¨ il primo di due parti_", kb);
			} else {
				if (rows[0].mission_end != null) {
					var d = new Date(rows[0].mission_end);
					var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes());
					bot.sendMessage(message.chat.id, "Stai svolgendo una missione dell'evento fino alle " + short_date, back);
					return;
				}

				var choice_id = rows[0].choice_id;
				var mission_time = rows[0].mission_time;
				var mission_id = rows[0].mission_id;
				var flag = rows[0].flag;

				var pos = rows[0].pos;
				var neg = rows[0].neg;

				var event_end = rows[0].event_end;
				var var_end = rows[0].var_end;

				if (event_end == 0) {
					if (choice_id >= 200) {
						bot.sendMessage(message.chat.id, "Riscattare la ricompensa?", yesno).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase() == "si") {

									var text = "";
									var chest = 0;
									var num = 0;
									var end_exp = 0;

									if ((pos != 0) && (neg != 0)) {
										if (pos > neg) {
											if (pos < 5) {
												num = 5;
												end_exp = 10;
											} else if (pos <= 10) {
												num = 7;
												end_exp = 10;
											} else if (pos > 10) {
												epic = 10;
												end_exp = 10;
											}
										} else {
											if (neg < 5) {
												num = 3;
												end_exp = 15;
											} else if (pos <= 10) {
												num = 5;
												end_exp = 25;
											} else if (pos > 10) {
												num = 7;
												end_exp = 40;
											}
										}
										chest = 6;
										text = "Hai ricevuto *" + num + " Scrigni Epici* e *" + end_exp + " exp*!";
									} else {
										if (var_end != 1) {
											if (var_end == 6) {
												text = "Purtroppo ti hanno distrutto il solo modo per trovare il tesoro e non hai ottenuto ricompense.";
											}
											if (var_end == 8) {
												chest = 4;
												num = 3;
												text = "Ricevi 3 Scrigni di Diamante!";
											}
											if ((var_end == 11) || (var_end == 13) || (var_end == 14)) {
												chest = 5;
												num = 3;
												text = "Ti restano soltanto gli scrigni che hai in soffitta, ottieni quindi 3 Scrigni Leggendari!";
											}
											if (var_end == 25) {
												chest = 6;
												num = 3;
												text = "All'interno della stanza trovi 3 Scrigni Epici!";
											}
											if (var_end == 26) {
												connection.query('UPDATE player SET life = total_life*0.1 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
												text = "Fortunatamente non sei morto, ma torni al tuo rifugio con il 10% dei tuoi hp.";
											}
										}
									}

									addChest(player_id, chest, num);
									connection.query('UPDATE mission_event_status SET event_end = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
									});
									setExp(player_id, end_exp);
									connection.query('SELECT COUNT(*) As num FROM `mission_event_status` WHERE event_end = 1', function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Evento completato!\n*" + text + "*\nUn enorme grazie per aver partecipato!\nSei l'utente numero " + rows[0].num + " ad aver completato l'evento.\nSi ringrazia @AlexCortinovis per aver ideato la storia e mi raccomando, se avete idee proponetele e magari la prossima storia sarÃ  ideata da voi!\nCi vediamo al prossimo!", back);
									});
								}
							}
						});
						return;
					}
				} else if (event_end == 1) {
					bot.sendMessage(message.chat.id, "Hai giÃ  riscattato le ricompense dell'evento!", back);
					return;
				}

				connection.query('SELECT * FROM mission_event_choice WHERE id = ' + choice_id, function (err, rows, fields) {
					if (err) throw err;
					console.log("Scelta: " + choice_id);

					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Si Ã¨ verificato un errore, contatta l'admin indicando questo codice: " + choice_id + "!", back);
						return;
					}

					var text = rows[0].text;
					text = text.replace(new RegExp("%player%", "g"), message.from.username);

					var var1 = "";
					var var2 = "";
					var var3 = "";

					if ((rows[0].text1 == undefined) || (rows[0].text1 == "")) {
						rows[0].text1 = "1. Favoloso!";
						rows[0].text2 = "2. CosÃ¬ cosÃ¬";
						rows[0].text3 = "3. Non mi Ã¨ piaciuto";

						connection.query('UPDATE mission_event_status SET choice_id = 200, var_end = ' + choice_id + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});

						text += "\n\nLascia un voto, e procedi per ottenere la tua ricompensa!";
					}

					var c1 = rows[0].text1;
					var c2 = rows[0].text2;
					var c3 = rows[0].text3;

					var eventChoice = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [[c1], [c2], [c3], ["Torna al menu"]]
						}
					};

					// RIMUOVERE NEI PROSSIMI EVENTI!

					if ((choice_id == 9) && (flag == 0)) {
						connection.query('UPDATE player SET money = money-10000 WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
						connection.query('UPDATE mission_event_status SET flag = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					}

					bot.sendMessage(message.chat.id, text, eventChoice);
				});
			}
		});
	});
});

bot.onText(/^Iscriviti al Registro$/i, function (message) {

	if (eventStory == 0) {
		return;
	}

	var eventKb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Vai all'evento"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT mission_id, id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		connection.query('SELECT * FROM mission_event_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO mission_event_status (player_id,choice_id,mission_end) VALUES (' + player_id + ',1,NULL)', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Sei stato aggiunto al registro eventi!", eventKb);
					return;
				});
			} else {
				bot.sendMessage(message.chat.id, "Sei giÃ  stato aggiunto al registro eventi!", eventKb);
			}
		});
	});
});

bot.onText(/[1-9][.] [a-z1-9\s]+/i, function (message) {

	return;

	if (eventStory == 0) {
		return;
	}

	var num = parseInt(message.text.charAt(0));
	var choice = message.text.substring(message.text.indexOf(" ") + 1, message.text.lenght);

	connection.query('SELECT id, mission_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		connection.query('SELECT * FROM mission_event_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non ti sei ancora iscritto al registro eventi!", back);
				return;
			}
			var choice_id = rows[0].choice_id;
			var epic = 0;
			var event_end = rows[0].event_end;

			console.log("choice_id = " + choice_id);

			if (event_end == 0) {
				if (choice_id >= 200) {
					var eventKb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Riscatta ricompensa evento"], ["Torna al menu"]]
						}
					};

					connection.query('UPDATE mission_event_status SET vote = "' + choice + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});

					bot.sendMessage(message.chat.id, "Evento completato! Torna all'evento per ricevere la ricompensa!", eventKb);
					return;
				}
			} else if (event_end == 1) {
				bot.sendMessage(message.chat.id, "Hai giÃ  riscattato le ricompense dell'evento!", back);
				return;
			}

			connection.query('SELECT * FROM mission_event_choice WHERE id = ' + choice_id + ' AND (text1 LIKE "%' + choice + '" OR text2 LIKE "%' + choice + '" OR text3 LIKE "%' + choice + '")', function (err, rows, fields) {
				if (err) throw err;
				console.log("Scelta: " + num);

				var nextMission = 0;

				if (Object.keys(rows).length > 0) {
					if (num == 1) {
						nextMission = rows[0].to_mission1;
					} else if (num == 2) {
						nextMission = rows[0].to_mission2;
					} else if (num == 3) {
						nextMission = rows[0].to_mission3;
					} else {
						bot.sendMessage(message.chat.id, "Errore, la corrispondenza della scelta non Ã¨ stata trovata", back);
						return;
					}

					connection.query('SELECT * FROM mission_event_text WHERE id = ' + nextMission, function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0) {
							var text = "*" + rows[0].title + "*\n";
							text += rows[0].text + "\n";
							text += "Questa parte di storia durerÃ  *" + toTime(rows[0].duration) + "*";

							var d = new Date();
							d.setSeconds(d.getSeconds() + rows[0].duration);
							var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

							var pos = rows[0].pos;
							var neg = rows[0].neg;

							connection.query('UPDATE mission_event_status SET pos = pos + ' + pos + ', neg = neg + ' + neg + ', mission_id = ' + rows[0].id + ', mission_end = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, text, back);
							});
						}
					});
				} else {
					bot.sendMessage(message.chat.id, "Scelta non valida", back);
					return;
				}
			});
		});
	});
});

function randomChest() {
	var rand = Math.round((Math.random() * 100) + 1);

	var chest1 = 100;
	var chest2 = 70;
	var chest3 = 50;
	var chest4 = 20;
	var chest5 = 10;
	var chest6 = 3;

	if (rand <= chest6) {
		var rarity = 6;
	} else if (rand <= chest5) {
		var rarity = 5;
	} else if (rand <= chest4) {
		var rarity = 4;
	} else if (rand <= chest3) {
		var rarity = 3;
	} else if (rand <= chest2) {
		var rarity = 2;
	} else if (rand <= chest1) {
		var rarity = 1;
	}

	return rarity;
}

bot.onText(/piazza di lootia|piazza/i, function (message) {

	if (message.text == "Piazza degli Affilamenti") {
		return;
	}

	connection.query('SELECT account_id, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		var iKeys = [];
		iKeys.push(["Emporio ðŸ’¸","Mercante Pazzo ðŸ‘"]);
		iKeys.push(["Contrabbandiere dell'Est ðŸ‘£"]);
		iKeys.push(["Affari Passati ðŸ’¬", "Poste ðŸŽ"]);
		iKeys.push(['Biblioteca ðŸ›']);
		iKeys.push(["Torna al menu"]);

		var kb = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": iKeys
			}
		};

		bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella <b>Piazza di Lootia</b>, cosa vorresti fare?", kb);
	});
});

bot.onText(/contrabbandiere|vedi offerte/i, function (message) {

	if (message.text == "Classifica Contrabbandiere") {
		return;
	}

	connection.query('SELECT account_id, market_ban, holiday, id, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		var d = new Date();
		if ((d.getHours() < 9) || (d.getHours() > 22)) { //9-23
			bot.sendMessage(message.chat.id, "Il Contrabbandiere non Ã¨ in piazza a quest'ora...", back);
			return;
		}

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		connection.query('SELECT id, item_id, price, total_cnt, day_cnt, time_end FROM merchant_offer WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Vedi Offerte"], ["Torna al menu"]]
					}
				};

				connection.query('INSERT INTO merchant_offer (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Sei stato aggiunto alla *Lista Iscrizioni* del Contrabbandiere, accetta i suoi incarichi per ottenere dei pagamenti in cambio delle tue dimostrazioni di creazione!", kb);
					refreshMerchant(player_id);
				});
			} else {

				var price = rows[0].price;
				var total_cnt = rows[0].total_cnt;
				var day_cnt = rows[0].day_cnt;
				var item_id = rows[0].item_id;

				if (rows[0].time_end != null) {
					var time_end = new Date(rows[0].time_end);
					var short_date = addZero(time_end.getHours()) + ":" + addZero(time_end.getMinutes());

					if ((time_end.getHours() > 22) || (day_cnt >= merchant_limit)) {
						bot.sendMessage(message.chat.id, "Il Contrabbandiere non ha ancora nulla per te, riprova domani", back);
					} else {
						bot.sendMessage(message.chat.id, "Il Contrabbandiere non ha ancora nulla per te, riprova alle " + short_date, back);
					}
					return;
				}

				var poss = "";
				var qnt = getItemCnt(player_id, item_id);
				if (qnt > 0) {
					poss = " âœ…";
				}

				connection.query('SELECT name, rarity FROM item WHERE id = ' + item_id, function (err, rows, fields) {
					if (err) throw err;

					var name = rows[0].name;
					var rarity = rows[0].rarity;

					var kb = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Accetta Vendita di " + name + " (" + qnt + ")"], ["Cerca *" + name], ["Cambia offerta", "Torna al menu"]]
						}
					};

					var kbYesNo = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Si"], ["Torna dal contrabbandiere"], ["Torna al menu"]]
						}
					};

					var kbBack = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Torna dal contrabbandiere"], ["Torna al menu"]]
						}
					};

					var kbBack2 = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Torna dal contrabbandiere"], ["Torna al menu"]]
						}
					};

					var kbSel = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Istantaneo", "Aspetta 4 ore"], ["Torna al menu"]]
						}
					};

					if (day_cnt == merchant_limit) {
						bot.sendMessage(message.chat.id, "Il Contrabbandiere non ha piÃ¹ bisogno di nulla per oggi", back);
						return;
					}

					var activeCoupon = "";
					if (getItemCnt(player_id, 677) > 0)
						activeCoupon = " Il coupon Ã¨ attivo.";

					bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " <b>" + message.from.username + "</b>!\nPuoi creare oggetti per il <b>Contrabbandiere</b> ed egli provvederÃ  a valutarli e ricompensarti adeguatamente, purtroppo perÃ² Ã¨ disponibile solamente di giorno. Quando lascia la piazza, aggiorna la sua fornitura e quando torna ti propone affari diversi.\n\n<b>" + name + " (" + rarity + ")</b> al prezzo di <i>" + formatNumber(price) + "</i> Â§" + poss + "\n\nAccetti l'incarico di questo oggetto? Se l'offerta che ti propone non ti sembra valida, puoi cambiarla. Hai ancora a disposizione <b>" + (merchant_limit - day_cnt) + " offerte</b> per oggi." + activeCoupon, kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text == "Torna al menu") {
								return;
							} else if (answer.text == "Cambia offerta") {
								bot.sendMessage(message.chat.id, "Per chiedere un nuovo oggetto istantaneamente ti servirÃ  una ðŸ’Ž, oppure puoi attendere 4 ore per dare il tempo al contrabbandiere di rifornirsi, cosa vuoi fare?", kbSel).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text == "Istantaneo") {

											var d = new Date();
											if ((d.getHours() < 9) || (d.getHours() > 22)) { //9-23
												bot.sendMessage(message.chat.id, "Il Contrabbandiere non Ã¨ in piazza a quest'ora...", back);
												return;
											}

											bot.sendMessage(message.chat.id, "Sei sicuro?", kbYesNo).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													if (answer.text.toLowerCase() == "si") {
														connection.query('SELECT gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															if (rows[0].gems < 1) {
																bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž", back);
																return;
															}
															connection.query('UPDATE player SET gems = gems-1 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																refreshMerchant(player_id);
																bot.sendMessage(message.chat.id, "E' arrivata la nuova offerta!", kbBack);
															});
														});
													};
												};
											});
										} else if (answer.text == "Aspetta 4 ore") {

											var d = new Date();
											if ((d.getHours() < 9) || (d.getHours() > 22)) { //9-23
												bot.sendMessage(message.chat.id, "Il Contrabbandiere non Ã¨ in piazza a quest'ora...", back);
												return;
											}

											var now = new Date();
											now.setMinutes(now.getMinutes() + 240);
											var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
											var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());

											if ((now.getHours() > 22) || (now.getHours() < 5)) {
												bot.sendMessage(message.chat.id, "A quell'ora il viandante sarÃ  giÃ  andato via, non puoi aspettare cosÃ¬ tanto", kbBack);
												return;
											}

											connection.query('UPDATE merchant_offer SET time_end = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;

												refreshMerchant(player_id);
												bot.sendMessage(message.chat.id, "Hai chiesto una nuova offerta, dovrai attendere fino alle " + short_date + "!", kbBack);
											});
										}
									};
								});
							} else if (answer.text.toLowerCase().indexOf("accetta") != -1) {
								bot.sendMessage(message.chat.id, "Sei sicuro di voler vendere il tuo " + name + " per " + formatNumber(price) + " Â§?", kbYesNo).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "si") {

											var d = new Date();
											if ((d.getHours() < 9) || (d.getHours() > 22)) { //9-23
												bot.sendMessage(message.chat.id, "Il Contrabbandiere non Ã¨ in piazza a quest'ora...", back);
												return;
											}

											if (getItemCnt(player_id, item_id) == 0) {
												bot.sendMessage(message.chat.id, "Non possiedi l'oggetto richiesto!", kbBack);
												return;
											}

											var noUse = 0;
											if ((total_cnt % 40 == 0) && (total_cnt > 0)) {
												addItem(player_id, 677);
												bot.sendMessage(message.chat.id, "Per la tua costanza il contrabbandiere ti regala un *Coupon*, valido dalla prossima offerta!", mark);
												noUse = 1;
											}

											var bonus = ""
											if ((getItemCnt(player_id, 677) > 0) && (noUse == 0)) {
												price += Math.round(price / 3);
												bonus = ", aumentati grazie al Coupon";
												var rand = Math.random() * 100;
												if (rand < 20) {
													bonus += " (Scaduto)";
													delItem(player_id, 677, 1);
												}
											}

											if (luckyMode == 1) {
												var d = new Date();
												if (d.getDay() == 6) {
													var rand = Math.random() * 100;
													if (rand < 10) {
														price = price * 2;
													}
												} else if (d.getDay() == 0) {
													var rand = Math.random() * 100;
													if (rand < 20) {
														price = price * 2;
													} else if ((rand > 20) && (rand < 30)) {
														price = Math.round(price / 2);
													}
												}
											}

											connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 18', function (err, rows, fields) {
												if (err) throw err;

												var abBonus = 0;
												if (Object.keys(rows).length > 0) {
													abBonus = parseInt(rows[0].ability_level) * rows[0].val;
												}

												var now = new Date();
												now.setMinutes(now.getMinutes() + 30);
												var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
												var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());

												var extra = "\nTorna tra 30 minuti per provare a commerciare di nuovo!";
												if ((day_cnt + 1) >= merchant_limit) {
													extra = "\nPer oggi il contrabbandiere ha terminato le sue offerte per te!";
												}

												if (now.getHours() > 22) {
													extra = "\nPer oggi il contrabbandiere ha terminato le sue offerte!";
												}

												var bonus_text = "";
												if (abBonus > 0){
													var priceBonus = Math.round(price/100*abBonus);
													price += priceBonus;
													bonus_text = " (" + formatNumber(priceBonus) + " Â§ grazie al talento)";
												}

												delItem(player_id, item_id, 1);

												connection.query('UPDATE player SET money = money + ' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													connection.query('UPDATE merchant_offer SET time_end = "' + long_date + '", total_cnt = total_cnt+1, day_cnt = day_cnt+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;

														bot.sendMessage(message.chat.id, "Vendita completata! Hai venduto *" + name + "* per *" + formatNumber(price) + "* Â§" + bonus + bonus_text + extra, kbBack);
														refreshMerchant(player_id);
														setAchievement(message.chat.id, player_id, 49, 1);
													});
												});
											});
										};
									};
								});
							};
						};
					});
				});
			}
		});
	});
});

/*
bot.onText(/ricalcolaValore/i, function (message, match) {
	var calcVal = 0;

	connection.query('UPDATE item SET value = 0 WHERE craftable = 1', function (err, rows, fields) {
		if (err) throw err;
		connection.query('SELECT id, name, value FROM item WHERE craftable = 1', function (err, rows, fields) {
			if (err) throw err;
			var len = Object.keys(rows).length
			for (var i = 0; i < len; i++) {
				connection.query('SELECT material_result, i1.value As v1, i2.value As v2, i3.value As v3 FROM craft c INNER JOIN item i1 ON c.material_1 = i1.id INNER JOIN item i2 ON c.material_2 = i2.id INNER JOIN item i3 ON c.material_3 = i3.id', function (err, rows, fields) {
					if (err) throw err;
					var val = rows[0].v1+rows[0].v2+rows[0].v3;
					var tot = val*0.7;

					console.log("Valore per " + this.name + ": " + tot);

					//connection.query('UPDATE item SET value = ' + tot + ' WHERE id = ' + rows[0].material_result, function (err, rows, fields) {
					//	if (err) throw err;
					//});
				}.bind({
					name: name
				}));
			}
		});
	});
});
*/

bot.onText(/refreshBase (.+)|refreshBase/i, function (message, match) {
	if (match[1] == undefined) {
		bot.sendMessage(message.chat.id, "0 = value, 1 = estimate")
		return;
	} else {
		estimate = match[1];
	}

	calcBaseFunc(estimate);
});

function calcBaseFunc(estimate) {
	var calcVal = 0;

	connection.query('UPDATE item SET base_sum = 0', function (err, rows, fields) {
		if (err) throw err;
		connection.query('SELECT id, name, estimate, value FROM item WHERE estimate > 0 AND rarity IN ("C","NC","R","UR","L","E","U") AND craftable = 1', function (err, rows, fields) {
			if (err) throw err;
			var len = Object.keys(rows).length
			console.log("Somma base per " + len  + " oggetti");
			for (var i = 0; i < len; i++) {
				calcBase(rows[i].id, rows[i].id, estimate);

				/*	ESCLUDE SE STESSO DAL CALCOLO, TOGLI IL COMMENTO PER INCLUDERE
				if (estimate == 0){
					calcVal = rows[i].value;
				}else{
					calcVal = rows[i].estimate;
				}

				connection.query('UPDATE item SET base_sum = base_sum+' + calcVal + ' WHERE id = ' + rows[i].id, function(err, rows, fields) {
					if (err) throw err;
				});
				*/
			}
		});
	});
}

function calcBase(base_id, item_id, estimate = 0) {
	connection.query('SELECT I1.id As i1, I1.name As n1, I1.value As v1, I1.estimate As e1, I1.craftable As c1, I2.id As i2, I2.name As n2, I2.craftable As c2, I2.value As v2, I2.estimate As e2, I3.id As i3, I3.name As n3, I3.value As v3, I3.estimate As e3, I3.craftable As c3 FROM craft C INNER JOIN item I1 ON C.material_1 = I1.id INNER JOIN item I2 ON C.material_2 = I2.id INNER JOIN item I3 ON C.material_3 = I3.id WHERE C.material_result = ' + item_id, function (err, rows, fields) {
		if (err) throw err;

		var calcVal = 0;

		if (rows[0].c1 == 1) {
			calcBase(base_id, rows[0].i1);
		} else {
			if (estimate == 0) {
				calcVal = rows[0].v1;
			} else {
				calcVal = rows[0].e1;
			}
			connection.query('UPDATE item SET base_sum = base_sum+' + calcVal + ' WHERE id = ' + base_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}
		if (rows[0].c2 == 1) {
			calcBase(base_id, rows[0].i2);
		} else {
			if (estimate == 0) {
				calcVal = rows[0].v2;
			} else {
				calcVal = rows[0].e2;
			}
			connection.query('UPDATE item SET base_sum = base_sum+' + calcVal + ' WHERE id = ' + base_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}
		if (rows[0].c3 == 1) {
			calcBase(base_id, rows[0].i3);
		} else {
			if (estimate == 0) {
				calcVal = rows[0].v3;
			} else {
				calcVal = rows[0].e3;
			}
			connection.query('UPDATE item SET base_sum = base_sum+' + calcVal + ' WHERE id = ' + base_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}
	});
}

bot.onText(/^\/refreshPrice/i, function (message, match) {
	connection.query('UPDATE item SET pnt_sum = 0, price_sum = 0', function (err, rows, fields) {
		if (err) throw err;

		connection.query('SELECT id, name, rarity FROM item WHERE rarity IN ("R", "UR","L","E","UE","X","U") AND craftable = 1', function (err, rows, fields) {
			if (err) throw err;
			var len = Object.keys(rows).length;
			var calcVal = 0;
			var calcVal2 = 0;
			for (var i = 0; i < len; i++) {
				console.log(i + "/" + len + " Somma punti craft e costi per " + rows[i].name);
				calcPnt(rows[i].id, rows[i].id);

				if (rows[i].rarity == "UR") {
					calcVal = 2;
					calcVal2 = 500;
				} else if (rows[i].rarity == "L") {
					calcVal = 3;
					calcVal2 = 750;
				} else if (rows[i].rarity == "E") {
					calcVal = 5;
					calcVal2 = 1000;
				} else if (rows[i].rarity == "UE") {
					calcVal = 25;
					calcVal2 = 10000;
				} else if (rows[i].rarity == "X") {
					calcVal = 50;
					calcVal2 = 100000;
				} else if (rows[i].rarity == "U") {
					calcVal = 35;
					calcVal2 = 50000;
				} else {
					calcVal = 0;
				}
				connection.query('UPDATE item SET pnt_sum = pnt_sum+' + calcVal + ', price_sum = price_sum+' + calcVal2 + ' WHERE id = ' + rows[i].id, function (err, rows, fields) {
					if (err) throw err;
				});
			}
		});
	});
});


function calcPnt(base_id, item_id) {
	connection.query('SELECT I1.id As i1, I1.name As n1, I1.rarity As r1, I1.craftable As c1, I2.id As i2, I2.name As n2, I2.craftable As c2, I2.rarity As r2, I3.id As i3, I3.name As n3, I3.rarity As r3, I3.craftable As c3 FROM craft C INNER JOIN item I1 ON C.material_1 = I1.id INNER JOIN item I2 ON C.material_2 = I2.id INNER JOIN item I3 ON C.material_3 = I3.id WHERE C.material_result = ' + item_id, function (err, rows, fields) {
		if (err) throw err;

		var calcVal = 0;
		var calcVal2 = 0;

		if (rows[0].c1 == 1) {
			calcPnt(base_id, rows[0].i1);
			if (rows[0].r1 == "UR") {
				calcVal = 2;
				calcVal2 = 500;
			} else if (rows[0].r1 == "L") {
				calcVal = 3;
				calcVal2 = 750;
			} else if (rows[0].r1 == "E") {
				calcVal = 5;
				calcVal2 = 1000;
			} else if (rows[0].r1 == "UE") {
				calcVal = 25;
				calcVal2 = 10000;
			} else if (rows[0].r1 == "X") {
				calcVal = 50;
				calcVal2 = 100000;
			} else if (rows[0].r1 == "U") {
				calcVal = 35;
				calcVal2 = 50000;
			} else {
				calcVal = 0;
				calcVal2 = 0;
			}
			connection.query('UPDATE item SET pnt_sum = pnt_sum+' + calcVal + ', price_sum = price_sum+' + calcVal2 + ' WHERE id = ' + base_id, function (err, rows, fields) {
				if (err) throw err;
			});

			console.log(rows[0].n1 + " " + calcVal);
		}
		if (rows[0].c2 == 1) {
			calcPnt(base_id, rows[0].i2);
			if (rows[0].r2 == "UR") {
				calcVal = 2;
				calcVal2 = 500;
			} else if (rows[0].r2 == "L") {
				calcVal = 3;
				calcVal2 = 750;
			} else if (rows[0].r2 == "E") {
				calcVal = 5;
				calcVal2 = 1000;
			} else if (rows[0].r2 == "UE") {
				calcVal = 25;
				calcVal2 = 10000;
			} else if (rows[0].r2 == "X") {
				calcVal = 50;
				calcVal2 = 100000;
			} else if (rows[0].r2 == "U") {
				calcVal = 35;
				calcVal2 = 50000;
			} else {
				calcVal = 0;
				calcVal2 = 0;
			}
			connection.query('UPDATE item SET pnt_sum = pnt_sum+' + calcVal + ', price_sum = price_sum+' + calcVal2 + ' WHERE id = ' + base_id, function (err, rows, fields) {
				if (err) throw err;
			});

			console.log(rows[0].n2 + " " + calcVal);
		}
		if (rows[0].c3 == 1) {
			calcPnt(base_id, rows[0].i3);
			if (rows[0].r3 == "UR") {
				calcVal = 2;
				calcVal2 = 500;
			} else if (rows[0].r3 == "L") {
				calcVal = 3;
				calcVal2 = 750;
			} else if (rows[0].r3 == "E") {
				calcVal = 5;
				calcVal2 = 1000;
			} else if (rows[0].r3 == "UE") {
				calcVal = 25;
				calcVal2 = 10000;
			} else if (rows[0].r3 == "X") {
				calcVal = 50;
				calcVal2 = 100000;
			} else if (rows[0].r3 == "U") {
				calcVal = 35;
				calcVal2 = 50000;
			} else {
				calcVal = 0;
				calcVal2 = 0;
			}
			connection.query('UPDATE item SET pnt_sum = pnt_sum+' + calcVal + ', price_sum = price_sum+' + calcVal2 + ' WHERE id = ' + base_id, function (err, rows, fields) {
				if (err) throw err;
			});

			console.log(rows[0].n3 + " " + calcVal);
		}
	});
}

bot.onText(/refreshMerchant/i, function (message, match) {
	refreshMerchant(0);
	bot.sendMessage(message.chat.id, "Fatto!");
	return;
});

function merchantPrice(item_id) {
	const rows = connection_sync.query('SELECT id, base_sum, price_sum, name, value FROM item WHERE id = ' + item_id);

	var val = parseInt(rows[0].base_sum);
	var price_sum = parseInt(rows[0].price_sum);

	var price = val + price_sum + rows[0].value;
	var mid = price;
	price = price * (1.3 + (Math.random() * 0.6));

	return Math.round(price);
}

function refreshMerchant(player_id) {
	if (player_id == 0) {
		connection.query('SELECT id FROM merchant_offer', function (err, rows, fields) {
			if (err) throw err;

			var id = 0;
			var val = 0;
			var perc = 0;
			var price = 0;
			var name = "";
			var price_sum = 0;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				id = rows[i].id;
				connection.query('SELECT item_id FROM merchant_offer WHERE id = ' + id, function (err, rows, fields) {
					if (err) throw err;
					connection.query('SELECT id, base_sum, price_sum, name, value FROM item WHERE estimate > 0 AND id != ' + rows[0].item_id + ' AND rarity IN ("C","NC","R","UR","L","E") AND craftable = 1 AND base_sum > 0 AND price_sum > 0 AND ORDER BY RAND()', function (err, rows, fields) {
						if (err) throw err;
						val = parseInt(rows[0].base_sum);
						price_sum = parseInt(rows[0].price_sum);

						price = val + price_sum;// + rows[0].value;
						price = price * (1.5 + (Math.random() * 0.5));

						name = rows[0].name;
						connection.query('UPDATE merchant_offer SET item_id = ' + rows[0].id + ', price = ' + price + ' WHERE id = ' + this.id, function (err, rows, fields) {
							if (err) throw err;
						});
					}.bind({
						id: this.id
					}));
				}.bind({
					id: id
				}));
			}
			//console.log("Contrabbandiere auto per " + Object.keys(rows).length + " player");
		});
	} else {
		connection.query('SELECT item_id FROM merchant_offer WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			connection.query('SELECT id, base_sum, price_sum, name, value FROM item WHERE estimate > 0 AND id != ' + rows[0].item_id + ' AND rarity IN ("C","NC","R","UR","L","E") AND craftable = 1 AND base_sum > 0 AND price_sum > 0 ORDER BY RAND()', function (err, rows, fields) {
				if (err) throw err;
				var val = parseInt(rows[0].base_sum);
				var price_sum = parseInt(rows[0].price_sum);

				var price = val + price_sum;// + rows[0].value;
				price = price * (1.5 + (Math.random() * 0.5));

				var name = rows[0].name;
				connection.query('UPDATE merchant_offer SET item_id = ' + rows[0].id + ', price = ' + price + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
				});
			});
		});
	}
}

bot.onText(/offerte giornaliere|^mercante pazzo|mercante/i, function (message) {

	if (message.text.indexOf("Cerca") != -1) {
		return;
	}

	if (message.text.toLowerCase().indexOf("statuetta") != -1) {
		return;
	}

	var price_drop = 0;
	var price_drop_msg = "";
	var n = new Date().getDay()
	var n2 = new Date().getDate();

	if (n == 0) {
		if (n2 <= 7) {
			sconto = 20;
		}
		price_drop = 1;
		price_drop_msg = "*Oggi il prezzo Ã¨ ridotto del " + sconto + "%!*\n";
	}

	if (sconto_evento > 0) {
		sconto = sconto_evento;
		price_drop = 1;
		price_drop_msg = "*Oggi il prezzo Ã¨ ridotto del " + sconto + "%!*\n";
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}
		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		var player_id = rows[0].id;

		if (crazyMode == 0) {
			if (rows[0].market_pack > 0) {
				bot.sendMessage(message.chat.id, "Oggi hai giÃ  acquistato un pacchetto, torna domani", back);
				return;
			}
		} else {
			if (rows[0].market_pack > 2) {
				bot.sendMessage(message.chat.id, "Oggi hai giÃ  acquistato tre pacchetti grazie al folle, torna domani", back);
				return;
			}
		}

		connection.query('SELECT rarity.name, SUM(price) As tot FROM market_pack, rarity WHERE market_pack.pack_id = rarity.id GROUP BY pack_id', function (err, rows, fields) {
			if (err) throw err;

			var iKeys = [];
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push(["Pacchetto " + rows[i].name + " (" + formatNumber(rows[i].tot) + " Â§)"]);
			}
			iKeys.push(["Torna al menu"]);

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			bot.sendMessage(message.chat.id, price_drop_msg + "Il *Mercante Pazzo* oggi offre alcuni pacchetti dall'aspetto interessante, selezionali per vedere il loro contenuto, ma attenzione, puoi acquistare solamente un pacchetto al giorno!", kb).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text == "Torna al menu") {
						return;
					}
					var reg3 = /Pacchetto (.+) \(/i;
					var rarity = answer.text.match(reg3);

					if (rarity == null)
						return;
					if (rarity[1] == undefined)
						return;
					connection.query('SELECT pack_id, SUM(price) As tot FROM market_pack, rarity WHERE market_pack.pack_id = rarity.id AND rarity.name = "' + rarity[1] + '"', function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "Pacchetto non valido", back);
							return;
						}
						if (rows[0].tot == null) {
							bot.sendMessage(message.chat.id, "Pacchetto non valido", back);
							return;
						}

						var pack_id = rows[0].pack_id;
						var price = rows[0].tot;

						connection.query('SELECT pack_id, item.name, item.id, price FROM market_pack, item WHERE market_pack.item_id = item.id AND pack_id = ' + pack_id, function (err, rows, fields) {
							if (err) throw err;
							var text = "Oggetti contenuti nel pacchetto:\n";
							var items = [];
							var prices = [];
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								text += "> " + rows[i].name + "\n";
								items.push(rows[i].id);
								if (price_drop == 1) {
									prices.push(Math.round(rows[i].price - (rows[i].price / 100 * sconto)));
								} else {
									prices.push(rows[i].price);
								}
							}
							if (price_drop == 1) {
								price = Math.round(price - (price / 100 * sconto));
							}
							text += "\nAl prezzo di: *" + formatNumber(price) + "* Â§";

							var kb2 = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["Accetta"], ["Torna dal mercante"], ["Torna al menu"]]
								}
							};
							bot.sendMessage(message.chat.id, text + "\n\nAcquisti il pacchetto?", kb2).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Accetta") {
										connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											if (rows[0].money < price) {
												bot.sendMessage(message.chat.id, "Non hai abbatanza monete!", back);
												return;
											}
											connection.query('UPDATE player SET market_pack = market_pack+1, money = money - ' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												var d = new Date();
												var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
												for (var i = 0, len = Object.keys(items).length; i < len; i++) {
													addItem(player_id, items[i]);
													connection.query('INSERT INTO market_direct_history (item_id, price, time, from_id, to_id, type) VALUES (' + items[i] + ',' + prices[i] + ',"' + long_date + '",' + player_id + ',NULL,4)', function (err, rows, fields) {
														if (err) throw err;
													});
												}
												bot.sendMessage(message.chat.id, "Acquisto pacchetto *" + rarity[1] + "* completato! Hai speso *" + formatNumber(price) + "* Â§!", back);
												//console.log("Pacchetto acquistato");
												setAchievement(message.chat.id, player_id, 45, 1);
											});
										});
									}
								}
							});
						});
					});
				};
			});
		});
	});
});

bot.onText(/^Poste/, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}
		if (rows[0].market_ban == 1) {
			bot.sendMessage(message.chat.id, "Sei bannato dal mercato", back);
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla piazza"], ["Torna al menu"]]
			}
		};

		var player_id = rows[0].id;

		connection.query('SELECT time FROM market_gift WHERE player_id = ' + player_id + ' ORDER BY time DESC', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length > 0) {
				var d = new Date(rows[0].time);
				var now = new Date();
				var diff = Math.round(((now - d) / 1000) / 60 / 60); //in ore
				diff = Math.abs(diff);

				if (diff < 24 * 2) {
					d.setDate(d.getDate() + 2);
					var long_date = addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear() + " alle " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

					bot.sendMessage(message.chat.id, "Prima di spedire ancora devi aspettare fino al " + long_date, back);
					return;
				}
			}

			bot.sendMessage(message.chat.id, "Inserisci il nickname del giocatore al quale spedire l'oggetto, puoi farlo solamente una volta ogni 2 giorni", kb).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if ((answer.text == "Torna al menu") || (answer.text == "Torna alla piazza")) {
						return;
					}

					var user = answer.text.replace("@", "").trim();

					connection.query('SELECT id, chat_id FROM player WHERE nickname = "' + user + '"', function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "Il giocatore specificato non esiste", kb);
							return;
						}
						var player_id2 = rows[0].id;
						var chat_id2 = rows[0].chat_id;

						if (player_id == player_id2) {
							bot.sendMessage(message.chat.id, "Non puoi inviare oggetti a te stesso", kb);
							return;
						}

						bot.sendMessage(message.chat.id, "Inserisci il nome dell'oggetto da spedire", kb).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if ((answer.text == "Torna al menu") || (answer.text == "Torna alla piazza")) {
									return;
								}
								var itemName = answer.text;
								connection.query('SELECT id, name, allow_sell FROM item WHERE name = "' + itemName + '"', function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste", kb);
										return;
									}
									if (rows[0].allow_sell == 0) {
										bot.sendMessage(message.chat.id, "L'oggetto specificato non puÃ² essere spedito", kb);
										return;
									}

									var itemId = rows[0].id;
									itemName = rows[0].name;
									if (getItemCnt(player_id, itemId) == 0) {
										bot.sendMessage(message.chat.id, "L'oggetto specificato non Ã¨ presente nel tuo inventario", kb);
										return;
									}

									bot.sendMessage(message.chat.id, "Inserisci il messaggio da inviare (senza andare a capo e senza usare simboli)", back).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text == "Torna al menu") {
												return;
											}
											var msg = answer.text;

											var reg = new RegExp("[<>]+");
											if (reg.test(msg) == true) {
												bot.sendMessage(message.chat.id, "Non utilizzare caratteri come <, o >", kb);
												return;
											}

											bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													if (answer.text.toLowerCase() == "si") {
														if (getItemCnt(player_id, itemId) == 0) {
															bot.sendMessage(message.chat.id, "L'oggetto specificato non Ã¨ presente nel tuo inventario", back);
															return;
														}

														setAchievement(message.chat.id, player_id, 36, 1);

														var d = new Date();
														var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

														connection.query('INSERT INTO market_gift (player_id, to_id, item_id, time) VALUES (' + player_id + ',' + player_id2 + ',' + itemId + ',"' + long_date + '")', function (err, rows, fields) {
															if (err) throw err;
														});

														addItem(player_id2, itemId);
														delItem(player_id, itemId, 1);

														bot.sendMessage(message.chat.id, "Spedizione inviata!", kb);
														bot.sendMessage(chat_id2, "Hai ricevuto <b>" + itemName + "</b> da <b>" + message.from.username + "</b>, e ti scrive:\n<i>" + msg + "</i>", html);
													}
												}
											});
										};
									});
								});
							}
						});
					});
				}
			});
		});
	});
});

bot.onText(/cron (.+)/i, function (message, match) {

	if (message.from.id != 20471035) {
		return;
	}

	connection.query('SELECT id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		connection.query('SELECT item.name, M.price, M.type, time, from_id, to_id, P1.nickname As from_nick, P2.nickname As to_nick, quantity FROM market_direct_history M INNER JOIN player P1 ON P1.id = M.from_id INNER JOIN player P2 ON P2.id = M.to_id, item WHERE item.id = M.item_id AND (from_id = ' + player_id + ' OR to_id = ' + player_id + ') ORDER BY M.id DESC LIMIT 50', function (err, rows, fields) {
			if (err) throw err;

			var text = "<b>Cronologia vendite utente</b>\n\n";
			var long_date;
			var d;

			var tipo = "";

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				d = new Date(rows[i].time);
				long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1);

				if (rows[i].type == 1) {
					tipo = "Mercato";
				} else if (rows[i].type == 2) {
					tipo = "Negozi";
				} else {
					tipo = "?";
				}

				if (rows[i].from_id == player_id) {
					text += "â© " + rows[i].quantity + "x <b>" + rows[i].name + "</b> a " + rows[i].price + " Â§ a " + rows[i].to_nick + " " + long_date + " (" + tipo + ")\n";
				} else if (rows[i].to_id == player_id) {
					text += "âª " + rows[i].quantity + "x <b>" + rows[i].name + "</b> a " + rows[i].price + " Â§ da " + rows[i].from_nick + " " + long_date + " (" + tipo + ")\n";
				}
			}
			bot.sendMessage(message.chat.id, text, html);
		});
	});
});

bot.onText(/Affari Passati/i, function (message) {

	var kb = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna alla piazza"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		connection.query('SELECT item.name, M.price, M.type, time, from_id, to_id, P1.nickname As from_nick, P2.nickname As to_nick, quantity FROM market_direct_history M INNER JOIN player P1 ON P1.id = M.from_id INNER JOIN player P2 ON P2.id = M.to_id, item WHERE item.id = M.item_id AND (from_id = ' + player_id + ' OR to_id = ' + player_id + ') ORDER BY M.id DESC LIMIT 25', function (err, rows, fields) {
			if (err) throw err;

			var text = "<b>Vendite/acquisti personali</b>:\n\n";
			var long_date;
			var d;
			var tipo = "";

			if (Object.keys(rows).length == 0)
				text += "Nessun acquisto/vendita\n";

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				d = new Date(rows[i].time);
				long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1);

				if (rows[i].type == 1) {
					tipo = "Mercato";
				} else if (rows[i].type == 2) {
					tipo = "Negozi";
				} else {
					tipo = "?";
				}

				if (rows[i].from_id == player_id) {
					text += "â© " + rows[i].quantity + "x <b>" + rows[i].name + "</b> a " + formatNumber(rows[i].price) + " Â§ a " + rows[i].to_nick + " - " + long_date + " (" + tipo + ")\n";
				} else if (rows[i].to_id == player_id) {
					text += "âª " + rows[i].quantity + "x <b>" + rows[i].name + "</b> a " + formatNumber(rows[i].price) + " Â§ da " + rows[i].from_nick + " - " + long_date + " (" + tipo + ")\n";
				}
			}

			connection.query('SELECT P1.nickname As from_nick, P2.nickname As to_nick, price, hist_time, from_id, to_id FROM pay_history H INNER JOIN player P1 ON H.from_id = P1.id INNER JOIN player P2 ON H.to_id = P2.id WHERE (from_id = ' + player_id + ' OR to_id = ' + player_id + ') ORDER BY H.id DESC LIMIT 25', function (err, rows, fields) {
				if (err) throw err;

				text += "\n<b>Monete pagate/ricevute</b>:\n\n";

				if (Object.keys(rows).length == 0)
					text += "Nessuna monete pagata/ricevuta\n";

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					d = new Date(rows[i].hist_time);
					long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1);

					if (rows[i].from_id == player_id) {
						text += "â© <b>" + formatNumber(rows[i].price) + " Â§</b> a " + rows[i].to_nick + " - " + long_date + "\n";
					} else if (rows[i].to_id == player_id) {
						text += "âª <b>" + formatNumber(rows[i].price) + " Â§</b> da " + rows[i].from_nick + " - " + long_date + "\n";
					}
				}

				connection.query('SELECT P1.nickname As creator, P2.nickname As winner, price, I.name, time FROM auction_history A INNER JOIN player P1 ON P1.id = A.creator_id INNER JOIN player P2 ON P2.id = A.player_id INNER JOIN item I ON A.item_id = I.id WHERE A.player_id = ' + player_id + ' ORDER BY A.id DESC LIMIT 25', function (err, rows, fields) {
					if (err) throw err;

					text += "\n<b>Aste vinte</b>:\n\n";

					if (Object.keys(rows).length == 0)
						text += "Nessuna asta vinta\n";

					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						d = new Date(rows[i].time);
						long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1);

						text += "<b>" + rows[i].name + "</b> per " + formatNumber(rows[i].price) + " Â§ - " + long_date + "\n";
					}

					connection.query('SELECT P1.nickname As creator, P2.nickname As winner, I.name, time FROM public_lottery_history A INNER JOIN player P1 ON P1.id = A.creator_id INNER JOIN player P2 ON P2.id = A.player_id INNER JOIN item I ON A.item_id = I.id WHERE A.player_id = ' + player_id + ' ORDER BY A.id DESC LIMIT 25', function (err, rows, fields) {
						if (err) throw err;

						text += "\n<b>Lotterie vinte</b>:\n\n";

						if (Object.keys(rows).length == 0)
							text += "Nessuna lotteria vinta\n";

						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							d = new Date(rows[i].time);
							long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1);

							text += "<b>" + rows[i].name + "</b> - " + long_date + "\n";
						}

						bot.sendMessage(message.chat.id, text, kb);
					});
				});
			});
		});
	});
});

bot.onText(/^cerca/i, function (message) {

	if (message.text.toLowerCase().indexOf("ricercato") != -1) {
		return;
	}

	if (!checkSpam(message)) {
		return;
	}

	if (message.text.indexOf(" ") != -1) {
		var oggetto = message.text.substring(message.text.indexOf(" ") + 1);
		if ((oggetto == "Ancora") || (oggetto == "ðŸ”Ž")) {
			cerca(message);
			return;
		}

		connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
			if (err) throw err;
			var player_id = rows[0].id;

			helpMsg(message.chat.id, player_id, 10);

			cercaTermine(message, oggetto, player_id);
		});
	} else {
		cerca(message);
	}
});

bot.onText(/Torna a /i, function (message) {
	var oggetto = message.text.substring(getPosition(message.text, " ", 2) + 1);

	if (oggetto == "Crea") {
		return;
	}

	if (!checkSpam(message)) {
		return;
	}

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		cercaTermine(message, oggetto, player_id);
	});
});

function cercaTermine(message, param, player_id) {

	var search = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Cerca Ancora"], ["Torna al menu"]]
		}
	};

	if (re6.test(param) == false) {
		bot.sendMessage(message.chat.id, "Criteri di ricerca non validi.", back);
		return;
	}

	connection.query('INSERT INTO search_history (player_id, term) VALUES (' + player_id + ',"' + param + '")', function (err, rows, fields) {
		if (err) throw err;
	});

	connection.query('SELECT id, term FROM search_history WHERE player_id = ' + player_id + ' ORDER BY id DESC LIMIT 2', function (err, rows, fields) {
		if (err) throw err;

		var prev = 0;
		var prevtxt = "";
		if (Object.keys(rows).length == 2) {
			prevtxt = "Torna a " + rows[1].term;
			prev = 1;
		}

		connection.query('SELECT exp, weapon_id, weapon2_id, weapon3_id, charm_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var lev = Math.floor(rows[0].exp / 10);

			var weapon1 = rows[0].weapon_id;
			var weapon2 = rows[0].weapon2_id;
			var weapon3 = rows[0].weapon3_id;
			var weapon4 = rows[0].charm_id;

			param = param.trim();

			var rarity = ["C", "NC", "R", "UR", "L", "E", "S", "D", "UE", "U", "X", "IN"];
			var check = rarity.indexOf(param.split(" ")[0]);

			//console.log(check, param);

			if ((Object.keys(param).length <= 4) && (check != -1)) {
				if (param.startsWith(rarity[check])) {
					var craftable = -1;
					var extra = "";
					var extra_txt = "";
					if (param.indexOf(" ") != -1) {
						craftable = param.substring(Object.keys(param).length - 1, Object.keys(param).length);
						extra = " AND craftable = " + craftable;
						if (craftable == 1) {
							extra_txt = " creabili";
						} else {
							extra_txt = " base"
						}
						param = param.slice(0, -2);
					}

					connection.query('SELECT name, rarity FROM item WHERE rarity = "' + param + '"' + extra + ' ORDER BY name', function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0) {
							var bottext = "Risultati per raritÃ  '" + param + "'" + extra_txt + ":\n";
							var iKeys = [];
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								bottext = bottext + rows[i].name + " (" + rows[0].rarity + ")\n";
								iKeys.push(["Cerca " + rows[i].name]);
							}

							iKeys.push(["Cerca Ancora"]);
							if (prev == 1) {
								iKeys.push([prevtxt]);
							}
							iKeys.push(["Torna al menu"]);

							var kb2 = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": iKeys
								}
							};

							bot.sendMessage(message.chat.id, bottext, kb2);
						} else {
							bot.sendMessage(message.chat.id, "Non ci sono oggetti" + extra_txt + " con quel livello di raritÃ .", search);
						}
					});
					return;
				}
			}

			if (param.toLowerCase() == "armi") {
				connection.query('SELECT name, rarity, power FROM item WHERE power > 0 ORDER BY name', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].name.indexOf("Necrolama") != -1) {
								rows[i].power = Math.round(50 + (lev / 2));
							}
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")   +" + rows[i].power + "\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Cerca Ancora"]);
						if (prev == 1) {
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}
			if (param.toLowerCase() == "armature") {
				connection.query('SELECT name, rarity, power_armor FROM item WHERE power_armor < 0 ORDER BY name', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].name.indexOf("Corazza Necro") != -1) {
								rows[i].power_armor = Math.round(25 + (lev / 2));
								rows[i].power_armor = -Math.abs(rows[i].power_armor);
							}

							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")   " + rows[i].power_armor + "\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Cerca Ancora"]);
						if (prev == 1) {
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}
			if (param.toLowerCase() == "scudi") {
				connection.query('SELECT name, rarity, power_shield FROM item WHERE power_shield < 0 ORDER BY name', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].name.indexOf("Scudo Necro") != -1) {
								rows[i].power_shield = Math.round(20 + (lev / 2));
								rows[i].power_shield = -Math.abs(rows[i].power_shield);
							}

							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")   " + rows[i].power_shield + "\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Cerca Ancora"]);
						if (prev == 1) {
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}
			if (param.toLowerCase() == "drago") {
				connection.query('SELECT name, rarity FROM item WHERE dragon_power <> 0 OR item.rarity = "D" OR (rarity = "UE" AND name LIKE "Stemma%") OR name = "Scaglia Evolutiva" ORDER BY name', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Cerca Ancora"]);
						if (prev == 1) {
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}

			if (param.toLowerCase() == "talismani") {
				connection.query('SELECT name, rarity FROM item WHERE name LIKE "Talismano%" ORDER BY name', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Cerca Ancora"]);
						if (prev == 1) {
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}

			if (param.toLowerCase() == "consumabili") {
				connection.query('SELECT name, rarity FROM item WHERE category IN (1,4) ORDER BY name', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Cerca Ancora"]);
						if (prev == 1) {
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}

			if (param.toLowerCase() == "rifugio") {
				connection.query('SELECT name, rarity FROM item WHERE category IN (5) ORDER BY name', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var bottext = "Risultati per categoria '" + param + "':\n";
						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							bottext = bottext + rows[i].name + " (" + rows[i].rarity + ")\n";
							iKeys.push(["Cerca " + rows[i].name]);
						}

						iKeys.push(["Cerca Ancora"]);
						if (prev == 1) {
							iKeys.push([prevtxt]);
						}
						iKeys.push(["Torna al menu"]);

						var kb2 = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, bottext, kb2);
					}
				});
				return;
			}

			var query = 'LIKE "%' + param + '%"';
			if (param.indexOf("*") != -1) {
				param = param.replace("*", "");
				query = ' = "' + param + '"';
			}

			connection.query('SELECT * FROM item WHERE name ' + query, function (err, rows, fields) {
				if (err) throw err;
				var result = 0;

				var bottext = "Risultati per '" + param + "':\n";
				if (Object.keys(rows).length > 0) {
					var iKeys = [];

					var key = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					var itemsArr = [];
					var j = 0;
					var found = 0;
					var name = "";

					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {

						name = rows[i].name;
						//console.log("Name: " + name);

						if (name != "") {
							if (len == 1) {
								bottext = bottext + "\n_" + name + "_\n";
							} else {
								bottext = bottext + name + " (" + rows[i].rarity + ")\n";
							}

							j = 0;
							found = 0;

							itemsArr.push([name.toLowerCase()]);

							while (j < Object.keys(itemsArr).length) {
								if (found == 0) {
									if (itemsArr[j].indexOf(param.toLowerCase()) > -1) {
										found = 1;
									} else {
										found = 0;
									}
								}
								j++;
							}

							if (found == 0) {
								iKeys.push(["Cerca " + name]);
							} else if (found == 1) {
								iKeys.push(["Cerca *" + name]);
							}
						}
					}

					iKeys.push(["Cerca Ancora"]);
					if (prev == 1) {
						iKeys.push([prevtxt]);
					}
					iKeys.push(["Torna al menu"]);

					if (Object.keys(rows).length == 1) {

						if (rows[0].searchable == 0) {
							bot.sendMessage(message.chat.id, "Le informazioni su questo oggetto sono nascoste ðŸ‘€ ", search);
							return;
						}

						var name = rows[0].name;
						var power = 0;
						var crit = rows[0].critical;
						var rarity = rows[0].rarity;
						var level_nec = 0;
						var item_id = rows[0].id;

						if (rows[0].power != 0) {
							if (crit > 0) {
								power = rows[0].power + " (Arma), Probab. x2: " + crit + "%";
							} else {
								power = rows[0].power + " (Arma)";
							}
						} else if (rows[0].power_armor != 0) {
							if (crit > 0) {
								power = rows[0].power_armor + " (Armatura), Probab. /2: " + crit + "%";
							} else {
								power = rows[0].power_armor + " (Armatura)";
							}
						} else if (rows[0].power_sheld != 0) {
							if (crit > 0) {
								power = rows[0].power_shield + " (Scudo), Probab. annull: " + crit + "%";
							} else {
								power = rows[0].power_shield + " (Scudo)";
							}
						}
						if (rarity == "UR") {
							level_nec = "15";
						} else if (rarity == "L") {
							level_nec = "30";
						} else if (rarity == "E") {
							level_nec = "50";
						} else if (rarity == "UE") {
							level_nec = "60";
						}

						var price = rows[0].value;
						var dragon_power = rows[0].dragon_power;
						var reborn = rows[0].reborn;
						var category = rows[0].category;
						var est = rows[0].estimate;
						var consumable = rows[0].cons;
						var sellable = rows[0].allow_sell;
						var craft_pnt = rows[0].pnt_sum;
						var reload_est = rows[0].reload_est;
						var est = rows[0].estimate;
						var cons_val = rows[0].cons_val;

						var cons = "No";
						var cons_pnt = "";
						if (consumable == 1) {
							cons = "Si";
							if (category == 1) {
								cons_pnt = " - " + Math.round(cons_val) + "% salute";
							}else if (category == 4){
								cons_pnt = " - " + Math.round(cons_val*10) + " gigatoni";
							}
						}

						if (category == 2) {
							tal = "*Potere Talismano*: " + rows[0].description;
						}

						var desc = "";
						if (rows[0].description != null) {
							if ((category == 3) || (category == 2)) {
								desc = "*Potere Oggetto*: " + rows[0].description;
							} else {
								desc = "*Descrizione*: " + rows[0].description;
							}
						}

						stars = "Nessuna";
						if (reborn >= 2) {
							stars = rebSym(reborn);
						}

						var extra = "";

						if ((rows[0].power != 0) || (rows[0].power_armor != 0) || (rows[0].power_shield)) {
							if (name.indexOf("Necrolama") != -1) {
								power = Math.round(50 + (lev / 2));
								extra = ", Probab. x2: " + crit + "%";
							} else if (name.indexOf("Corazza Necro") != -1) {
								power = Math.round(25 + (lev / 2));
								power = -Math.abs(power);
								extra = ", Probab. /2: " + crit + "%";
							} else if (name.indexOf("Scudo Necro") != -1) {
								power = Math.round(20 + (lev / 2));
								power = -Math.abs(power);
								extra = ", Probab. annull: " + crit + "%";
							}
							bottext += "\n*Giocatore*: " + power + extra;
							if ((level_nec != 0) && (reborn == 1)) {
								bottext += "\n*Livello richiesto*: " + level_nec;
							}
						}
						bottext += "\n*Rinascita richiesta*: " + stars;
						if (dragon_power != 0) {
							bottext += "\n*Drago*: " + dragon_power;
						}
						bottext += "\n*RaritÃ *: " + rarity + " (" + formatNumber(price) + " Â§, all'emporio: " + formatNumber(Math.round(price / 2)) + " Â§)";
						bottext += "\n*Consumabile*: " + cons + cons_pnt;
						bottext += "\n*Punti creazione*: " + craft_pnt;

						if (reload_est >= 50) {
							connection.query('SELECT DISTINCT(from_id), price FROM market_direct_history WHERE time BETWEEN date_sub(NOW(),INTERVAL 1 WEEK) AND NOW() AND price != (SELECT value FROM item WHERE id = ' + item_id + ') AND item_id = ' + item_id + ' AND type = 2', function (err, rows, fields) {
								if (err) throw err;
								var price = 0;
								var arr = [];
								var arrCnt = 0;
								if (Object.keys(rows).length > 1) {
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										if ((rows[i].price < (est) * 3) && (rows[i].price > (est) / 3)){
											arr.push(rows[i].price);
											arrCnt++;
										}
									}
									if (arrCnt > 1){
										price = estimate(arr);
										if (!isNaN(price)) {
											connection.query('UPDATE item SET estimate = ' + price + ' WHERE id = ' + item_id, function (err, rows, fields) {
												if (err) throw err;
											});
										}
									}else{
										console.log("Reload est saltato, non ci sono abbastanza vendite per " + item_id);
									}
								}
							});
							connection.query('UPDATE item SET reload_est = 0 WHERE id = ' + item_id, function (err, rows, fields) {
								if (err) throw err;
							});
						} else {
							connection.query('UPDATE item SET reload_est = reload_est+1 WHERE id = ' + item_id, function (err, rows, fields) {
								if (err) throw err;
							});
						}


						var poss = getItemCnt(player_id, item_id);

						connection.query('SELECT (SELECT COUNT(id) FROM player) As player, COUNT(id) As cnt FROM inventory WHERE item_id = ' + item_id, function (err, rows, fields) {
							if (err) throw err;

							bottext += "\n*Posseduti*: " + poss + " (" + Math.round((rows[0].cnt / rows[0].player) * 100) + "%)";
							if ((desc != "") && (desc != null)) {
								bottext += "\n" + desc;
							}
							if (sellable == 0) {
								bottext += "\nQuesto oggetto non puÃ² essere venduto o scambiato con i giocatori";
							}
							//bottext += "\n";

							connection.query('SELECT material_result FROM craft, item WHERE craft.material_result = item.id AND item.name = "' + name + '"', function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0) {
									connection.query('SELECT id FROM item WHERE  item.name="' + name + '"', function (err, rows, fields) {
										if (err) throw err;
										result = rows[0].id;
										connection.query('SELECT craft.*, item.name, item.rarity FROM `craft`, item where material_result = item.id AND ((material_1 = ' + result + ' AND material_2 = ' + result + ' AND material_3 = ' + result + ') OR (material_1 = ' + result + ' AND material_2 = ' + result + ') OR (material_1 = ' + result + ' AND material_3 = ' + result + ') OR (material_2 = ' + result + ' AND material_3 = ' + result + ') OR material_1 = ' + result + ' OR material_2 = ' + result + ' OR material_3 = ' + result + ')', function (err, rows, fields) {
											if (err) throw err;
											if (Object.keys(rows).length > 0) {
												bottext = bottext + "\n\nCon questo oggetto puoi creare:\n";

												var iKeys2 = [];

												var kb2 = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": iKeys2
													}
												};

												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													if (rows[i].name != "") {
														bottext = bottext + "> " + rows[i].name + " (" + rows[i].rarity + ")\n";
														iKeys2.push(["Cerca *" + rows[i].name]);
														/*
															if (rows[i].name.indexOf(" ") != -1) {
																iKeys2.push(["Cerca " + rows[i].name]);
															} else {
																iKeys2.push(["Cerca *" + rows[i].name]);
															}
															*/
													}
												}

												iKeys2.push(["Cerca Ancora"]);
												if (prev == 1) {
													iKeys2.push([prevtxt]);
												}
												iKeys2.push(["Torna al menu"]);

												bot.sendMessage(message.chat.id, bottext, kb2);
											} else {
												bot.sendMessage(message.chat.id, bottext, search);
											}
										});
									});
									return;
								}
								result = rows[0].material_result;

								connection.query('SELECT claws_id, saddle_id FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;

									var claws_id = 999;
									var saddle_id = 999;

									if (Object.keys(rows).length > 0) {
										claws_id = rows[0].claws_id;
										saddle_id = rows[0].saddle_id;
									}

									var mat1 = "";
									var mat1id = "";
									var mat1p = "";
									var mat1r = "";
									var mat1q = "";
									var mat1ex = "";

									var mat2 = "";
									var mat2id = "";
									var mat2p = "";
									var mat2r = "";
									var mat2q = "";
									var mat2ex = "";

									var mat3 = "";
									var mat3id = "";
									var mat3p = "";
									var mat3r = "";
									var mat3q = "";
									var mat3ex = "";

									var mat4 = "";
									var mat4id = "";
									var mat4p = "";
									var mat4r = "";
									var mat4q = "";
									var mat4ex = "";

									connection.query('SELECT item.id, item.name, item.craftable, item.rarity FROM craft, item WHERE craft.material_1 = item.id AND craft.material_result = ' + result, function (err, rows, fields) {
										if (err) throw err;
										mat1 = rows[0].name;
										if (rows[0].craftable == 1) {
											mat1p = rows[0].name;
										} else {
											mat1p = "*" + rows[0].name + "*";
										}
										mat1id = rows[0].id;
										mat1r = rows[0].rarity;
										connection.query('SELECT item.id, item.name, item.craftable, item.rarity FROM craft, item WHERE craft.material_2 = item.id AND craft.material_result = ' + result, function (err, rows, fields) {
											if (err) throw err;
											mat2 = rows[0].name;
											if (rows[0].craftable == 1) {
												mat2p = rows[0].name;
											} else {
												mat2p = "*" + rows[0].name + "*";
											}
											mat2id = rows[0].id;
											mat2r = rows[0].rarity;
											connection.query('SELECT item.id, item.name, item.craftable, item.rarity FROM craft, item WHERE craft.material_3 = item.id AND craft.material_result = ' + result, function (err, rows, fields) {
												if (err) throw err;
												mat3 = rows[0].name;
												if (rows[0].craftable == 1) {
													mat3p = rows[0].name;
												} else {
													mat3p = "*" + rows[0].name + "*";
												}
												mat3id = rows[0].id;
												mat3r = rows[0].rarity;

												mat1q = getItemCnt(player_id, mat1id);
												if (mat1q > 0) {
													mat1ex = "âœ…";
												} else if ((mat1id == weapon1) || (mat1id == weapon2) || (mat1id == weapon3) || (mat1id == weapon4)) {
													mat1ex = "ðŸ—¡";
												} else if ((mat1id == claws_id) || (mat1id == saddle_id)) {
													mat1ex = "ðŸ‰";
												}

												mat2q = getItemCnt(player_id, mat2id);
												if (mat2q > 0) {
													mat2ex = "âœ…";
												} else if ((mat2id == weapon1) || (mat2id == weapon2) || (mat2id == weapon3) || (mat2id == weapon4)) {
													mat2ex = "ðŸ—¡";
												} else if ((mat2id == claws_id) || (mat2id == saddle_id)) {
													mat2ex = "ðŸ‰";
												}

												mat3q = getItemCnt(player_id, mat3id);
												if (mat3q > 0) {
													mat3ex = "âœ…";
												} else if ((mat3id == weapon1) || (mat3id == weapon2) || (mat3id == weapon3) || (mat3id == weapon4)) {
													mat3ex = "ðŸ—¡";
												} else if ((mat3id == claws_id) || (mat3id == saddle_id)) {
													mat3ex = "ðŸ‰";
												}

												bottext = bottext + "\n\nMateriali necessari:\n> " + mat1p + " (" + mat1r + ", " + mat1q + ") " + mat1ex + "\n> " + mat2p + " (" + mat2r + ", " + mat2q + ") " + mat2ex + "\n> " + mat3p + " (" + mat3r + ", " + mat3q + ") " + mat3ex;

												connection.query('SELECT craft.*, item.name, item.rarity FROM craft, item where material_result = item.id AND ((material_1 = ' + result + ' AND material_2 = ' + result + ' AND material_3 = ' + result + ') OR (material_1 = ' + result + ' AND material_2 = ' + result + ') OR (material_1 = ' + result + ' AND material_3 = ' + result + ') OR (material_2 = ' + result + ' AND material_3 = ' + result + ') OR material_1 = ' + result + ' OR material_2 = ' + result + ' OR material_3 = ' + result + ')', function (err, rows, fields) {
													if (err) throw err;

													var iKeys3 = [];

													iKeys3.push(["Crea " + name]);

													iKeys3.push(["Cerca *" + mat1]);
													iKeys3.push(["Cerca *" + mat2]);
													iKeys3.push(["Cerca *" + mat3]);

													var kb = {
														parse_mode: "Markdown",
														reply_markup: {
															resize_keyboard: true,
															//one_time_keyboard: true,
															"keyboard": iKeys3
														}
													};

													if (Object.keys(rows).length > 0) {
														bottext = bottext + "\n\nCon questo oggetto puoi creare:\n";
														for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
															bottext = bottext + "> " + rows[i].name + " (" + rows[i].rarity + ")\n";
															iKeys3.push(["Cerca *" + rows[i].name]);
														}

														iKeys3.push(["Cerca Ancora"]);
														if (prev == 1) {
															iKeys3.push([prevtxt]);
														}
														iKeys3.push(["Torna al menu"]);
														bot.sendMessage(message.chat.id, bottext, kb);
													} else {
														iKeys3.push(["Cerca Ancora"]);
														if (prev == 1) {
															iKeys3.push([prevtxt]);
														}
														iKeys3.push(["Torna al menu"]);
														bot.sendMessage(message.chat.id, bottext, kb);
													}
												});
											});
										});
									});
								});
							});
						});
					} else {
						if (Object.keys(bottext).length > 4000) {
							bottext = "La ricerca ha prodotto troppi risultati, prova a restringere il campo";
							bot.sendMessage(message.chat.id, bottext, search);
						} else {
							bot.sendMessage(message.chat.id, bottext, key);
						}
					}
				} else {
					bot.sendMessage(message.chat.id, "Nessun risultato, riprova con una parola chiave diversa. Se cerchi il nome preciso dell\'oggetto visualizzerai anche gli oggetti necessari per crearlo.", search);
				}
			});
		});
	});
}

bot.onText(/lista ricerche/i, function (message) {
	connection.query('SELECT id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		connection.query('SELECT term FROM search_history WHERE player_id = ' + player_id + ' ORDER BY id DESC LIMIT 100', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length > 0) {
				var iKeys = [];
				for (var i = 0, len = Object.keys(rows).length - 1; i < len; i++) {
					iKeys.push(["Cerca " + rows[i].term]);
				}
				iKeys.push(["Torna al menu"]);

				var kb = {
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				bot.sendMessage(message.chat.id, "Seleziona la ricerca precedente", kb);
			} else {
				bot.sendMessage(message.chat.id, "Nessuna cronologia presente", back);
			}
		});
	});
});

function cerca(message) {
	connection.query('SELECT id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var iKeys = [["Cerca Armi"], ["Cerca Armature", "Cerca Scudi"], ["Cerca Talismani", "Cerca Drago"], ["Cerca Consumabili", "Cerca Rifugio"], ["Cerca C", "Cerca NC"], ["Cerca R", "Cerca UR"], ["Cerca L", "Cerca E"], ["Cerca UE", "Cerca S"], ["Cerca U", "Cerca X"], ["Cerca D", "Lista Ricerche"], ["Torna al menu"]];

		var kb = {
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": iKeys
			}
		};

		bot.sendMessage(message.chat.id, "Cosa vuoi cercare?\nPuoi cercare per raritÃ  o categoria o scrivere Cerca NomeOggetto da qualsiasi schermata del bot. Per forzare la ricerca di un oggetto preciso scrivi Cerca *NomeOggetto", kb);
	});
};

bot.onText(/alchimia/i, function (message) {

	var alchemy = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [['Sintesi âœ¨'], ['Incanta ðŸ’Ž ', 'Scomponi ðŸ’Ž '], ['Utilizza Polvere ðŸŒª', 'Trasmogrificazione ðŸŒ€'], ["Rimodulatore di Flaridion ðŸ”—"], ['Torna al menu']]
		}
	}

	bot.sendMessage(message.chat.id, "Quale operazione vuoi effettuare?", alchemy);
});

bot.onText(/genera scaglia evolutiva/i, function (message) {
	connection.query('SELECT id, class, reborn, holiday, account_id, travel_id, cave_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back);
			return;
		}

		var player_id = rows[0].id;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		if (reborn < 4) {
			bot.sendMessage(message.chat.id, "Devi essere almeno Rinascita 3 per creare questo oggetto", alchemy);
			return;
		}

		var gYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna all'alchimia"], ['Torna al menu']]
			}
		}

		var alchemy = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna all'alchimia"], ['Torna al generatore'], ['Torna al menu']]
			}
		}

		bot.sendMessage(message.chat.id, "Per creare questo particolare oggetto, *estremamente raro* ti servirÃ :\n> 1000 Polvere\n> 7500 Mana per tipo\nProcedi?", gYesNo).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "si") {

					if (getItemCnt(player_id, 646) < 1000) {
						bot.sendMessage(message.chat.id, "Non hai abbastanza Polvere", alchemy);
						return;
					}
					connection.query('SELECT mana_1, mana_2, mana_3 FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						if ((rows[0].mana_1 < 7500) || (rows[0].mana_2 < 7500) || (rows[0].mana_3 < 7500)) {
							bot.sendMessage(message.chat.id, "Non hai abbastanza Mana", alchemy);
							return;
						}

						delItem(player_id, 646, 1000);
						connection.query('UPDATE event_mana_status SET mana_1 = mana_1 - 7500, mana_2 = mana_2 - 7500, mana_3 = mana_3 - 7500 WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							addItem(player_id, 649);
							bot.sendMessage(message.chat.id, "Dalle Polveri e dal potere Magico, si innalza un oggetto curioso: Ã¨ una *Scaglia Evolutiva*!", alchemy);
						});
					});
				}
			}
		});
	});
});

bot.onText(/utilizza polvere/i, function (message) {
	connection.query('SELECT id, class, reborn, holiday, account_id, travel_id, cave_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back);
			return;
		}

		var player_id = rows[0].id;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		var alchemy = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna all'alchimia"], ['Torna al generatore'], ['Torna al menu']]
			}
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Genera Oggetto", 'Genera Scaglia Evolutiva'], ["Torna all'alchimia"], ['Torna al menu']]
			}
		}

		var gYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna al Generatore di Polvere"]]
			}
		};

		var kbNum = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["1", "10", "100"],["Torna al Generatore di Polvere"]]
			}
		};


		var dust = getItemCnt(player_id, 646);

		bot.sendMessage(message.chat.id, "Cosa vuoi fare con la polvere? Ne possiedi *" + dust + "* unitÃ ", kb).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {

				if (answer.text == "Genera Oggetto") {

					if (getItemCnt(player_id, 646) == 0) {
						bot.sendMessage(message.chat.id, "Non hai Polvere da utilizzare", alchemy);
						return;
					}

					var rar1 = 40;
					var rar2 = 60;
					var rar3 = 80;
					var rar4 = 100;

					bot.sendMessage(message.chat.id, "Puoi creare un oggetto utilizzando la Polvere (ad esclusione degli equipaggiamenti):\n" +
									"Raro -> " + rar1 + "\n" +
									"Ultra Raro -> " + rar2 + "\n" +
									"Leggendario -> " + rar3 + "\n" +
									"Epico -> " + rar4 + "\n" +
									"Se l'oggetto Ã¨ craftato, richiederÃ  il *doppio* della polvere + una quantitÃ  dipendente dal valore\n\n" +
									"Inserisci il nome dell'oggetto, al momento c'Ã¨ una piccolissima probabilitÃ  di fallimento nella creazione.", alchemy).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text.indexOf("Torna al") != -1) {
								return;
							}

							var item_sel = answer.text;

							connection.query('SELECT id, estimate, craftable, rarity, name FROM item WHERE rarity IN ("R","UR","L","E") AND power = 0 AND power_shield = 0 AND power_armor = 0 AND dragon_power = 0 AND name = "' + item_sel + '"', function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0) {
									bot.sendMessage(message.chat.id, "L'oggetto non esiste o la raritÃ  non Ã¨ consentita", alchemy);
									return;
								}
								var itemId = rows[0].id;
								var itemName = rows[0].name;
								var rarity = rows[0].rarity;
								var craft = rows[0].craftable;
								var estimate = rows[0].estimate;

								var nec = 0;

								if (rarity == "R") {
									nec = rar1;
								} else if (rarity == "UR") {
									nec = rar2;
								} else if (rarity == "L") {
									nec = rar3;
								} else if (rarity == "E") {
									nec = rar4;
								}
								if (craft == 1) {
									nec = nec * 2;
									nec += Math.round(estimate / 10000);
								}

								bot.sendMessage(message.chat.id, "Quante copie dell'oggetto vuoi creare? Una copia di questo oggetto ti costerÃ  " + nec + " unitÃ  di Polvere", kbNum).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {

										var qnt = parseInt(answer.text);
										if (isNaN(qnt)){
											bot.sendMessage(message.chat.id, "QuantitÃ  non valida", alchemy);
											return;
										}

										if ((qnt < 1) || (qnt > 100)){
											bot.sendMessage(message.chat.id, "QuantitÃ  non valida", alchemy);
											return;
										}

										nec = nec*qnt;

										bot.sendMessage(message.chat.id, "Sicuro di voler generare " + formatNumber(qnt) + "x  *" + itemName + "* (" + rarity + ")?\nTi costerÃ  *" + formatNumber(nec) + "* unitÃ  di Polvere", gYesNo).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text.toLowerCase() == "si") {

													var dustcnt = getItemCnt(player_id, 646);
													if (dustcnt < nec) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza Polvere per generare questi oggetti, " + dustcnt + "/" + nec, alchemy);
														return;
													}

													var rand = Math.random() * 100;
													if (rand > 5) {
														delItem(player_id, 646, nec);
														addItem(player_id, itemId, qnt);
														bot.sendMessage(message.chat.id, "Hai generato " + qnt + "x " + itemName + " (" + rarity + ") con successo!", alchemy);
														setAchievement(message.chat.id, player_id, 48, qnt);
													} else {
														delItem(player_id, 646, nec);
														bot.sendMessage(message.chat.id, "Dannazione! La generazione Ã¨ fallita e hai perso la polvere necessaria, che sfortuna!", alchemy);
													}
												};
											};
										});
									}
								});
							});
						}
					});
				}
			}
		});
	});
});

bot.onText(/filtro/i, function (message) {
	var backpackFilter = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [['Solo Base', 'Solo Creati'], ['Solo C', 'Solo NC', 'Solo R'], ['Solo UR', 'Solo L', 'Solo E'], ['Solo UE', 'Solo U', 'Solo S'], ['Solo I', 'Solo D'], ['Torna allo zaino']]
		}
	};

	bot.sendMessage(message.chat.id, "Seleziona il filtro per visualizzare solo una parte dello zaino", backpackFilter);
});

bot.onText(/cambia visualizzazione/i, function (message) {

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna allo Zaino"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, bag_min FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		if (rows[0].bag_min == 0) {
			connection.query('UPDATE player SET bag_min = 1 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Hai attivato la visualizzazione _riassunta_ dello zaino", kb);
			});
		} else {
			connection.query('UPDATE player SET bag_min = 0 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Hai attivato la visualizzazione _estesa_ dello zaino", kb);
			});
		}
	});
});

bot.onText(/Bacheca IN/i, function (message) {
	connection.query('SELECT id, global_event FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var pnt = rows[0].global_event;
		var text = "";

		var backPack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna allo Zaino"], ["Torna al menu"]]
			}
		};


		connection.query('SELECT inventory.player_id, item.name, item.craftable, rarity.id, rarity.name As rname, inventory.quantity As num FROM inventory, item, rarity WHERE player_id = ' + player_id + ' AND rarity.shortname = item.rarity AND inventory.item_id = item.id AND rarity = "IN" AND inventory.quantity > 0 ORDER BY rarity.id DESC, item.name ASC', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				text = "*" + rows[0].rname + "*:\n\n";

				for (i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].craftable == 0) {
						rows[i].name = "*" + rows[i].name + "*";
					}
					text = text + "> " + rows[i].name + " (" + rows[i].num + ")\n";
				}
			} else {
				text += "Nessun oggetto inestimabile disponibile\n";
			}

			text += "\nPunti Imprese Globali con alta partecipazione: " + pnt + " / 5";

			bot.sendMessage(message.chat.id, text + "\nQuesti oggetti sono unici e vengono ottenuti solamente al termine delle imprese globali!", backPack);
		});
	});
});

bot.onText(/zaino/i, function (message) {

	if (message.text.toLowerCase().indexOf("zeppo") != -1) {
		return;
	}

	if (message.text.toLowerCase().indexOf("completo") != -1) {
		return;
	}

	var backpack = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [['Zaino Completo ðŸŽ’'], ['Filtro ðŸ“ƒ', 'Pozioni ðŸ¶', 'Cerca ðŸ”Ž'], ['Equipaggia ðŸ—¡', 'Set ðŸ’£', 'Rimuovi ðŸš«'], ['Scrigni ðŸ”‘', 'Torna al menu']]
		}
	};

	var backpackB = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna allo Zaino"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, holiday, total_life, life, account_id, bag_min, money, gems, mkeys, moon_coin, necro_pnt, gain_exp FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var bottext = message.from.username + ", apri il tuo zaino ed al suo interno trovi:\n\n";
		var bag_min = rows[0].bag_min;

		bottext += "Monete: " + formatNumber(rows[0].money) + " Â§\n";
		if (rows[0].gems > 0)
			bottext += "Gemme: " + formatNumber(rows[0].gems) + " ðŸ’Ž\n";
		if (rows[0].mkeys > 0)
			bottext += "Chiavi Mistiche: " + formatNumber(rows[0].mkeys) + " ðŸ—\n";
		if (rows[0].moon_coin > 0)
			bottext += "Monete Lunari: " + formatNumber(rows[0].moon_coin) + " ðŸŒ•\n";
		if (rows[0].necro_pnt > 0)
			bottext += "Necrospiriti: " + formatNumber(rows[0].necro_pnt) + " ðŸ’ \n";
		if (rows[0].gain_exp > 0)
			bottext += "Esperienza accumulata: " + formatNumber(rows[0].gain_exp) + " âœ¨\n";
		bottext += "\n";

		connection.query('SELECT chest.name As name, quantity As num FROM inventory_chest, chest WHERE player_id = ' + player_id + ' AND chest.id = inventory_chest.chest_id AND quantity > 0 ORDER BY chest.id', function (err, rows, fields) {
			if (err) throw err;

			bottext = bottext + "<b>Scrigni:</b>\n";

			if ((new Date().getDate() == 1) && (new Date().getMonth() == 3)){
				bottext += "Nessuno scrigno disponibile ðŸ‘€\n";
			}else{
				if (Object.keys(rows).length > 0) {
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						bottext += "> " + rows[i].name + " (" + formatNumber(rows[i].num) + ")\n";
					}
				} else {
					bottext += "Nessuno scrigno disponibile\n";
				}
			}

			bottext += "\n";

			connection.query('DELETE FROM magic WHERE quantity <= 0 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				connection.query('SELECT type, power, quantity FROM magic WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					bottext += "<b>Incantesimi:</b>\n";
					if (Object.keys(rows).length > 0) {
						var n = "";
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].type == 1) {
								n = "Furia dei Mari";
							} else if (rows[i].type == 2) {
								n = "Tempesta Folgorante";
							} else if (rows[i].type == 3) {
								n = "Impeto di Fiamme";
							} else if (rows[i].type == 4) {
								n = "Ira Astrale";
							}
							bottext += "> " + n + " " + rows[i].power + " (" + rows[i].quantity + ")\n";
						}
						bottext += "\n";
					} else {
						bottext += "Nessun incantesimo disponibile\n";
					}
					bot.sendMessage(message.chat.id, bottext, backpack);
				});
			});
		});
	});
});

bot.onText(/zaino completo/i, function (message) {

	var backpackB = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Cambia Visualizzazione ðŸ’¼"], ["Bacheca IN ðŸŒŸ", "Torna allo Zaino"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, holiday, total_life, life, account_id, bag_min FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var bottext = message.from.username + ", ecco il contenuto del tuo zaino:\n\n";
		var player_total_life = rows[0].total_life;
		var player_life = rows[0].life;
		var bag_min = rows[0].bag_min;

		connection.query('SELECT inventory.player_id, item.craftable, item.name, rarity.id, rarity.name As rname, inventory.quantity As num FROM inventory, item, rarity WHERE player_id = ' + player_id + ' AND rarity.shortname = item.rarity AND inventory.item_id = item.id AND rarity.shortname != "IN" AND inventory.quantity > 0 ORDER BY rarity.id DESC, item.name ASC', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {

				var i = 0;
				var raritypre = rows[0].id;

				if (bag_min == 0) {
					bottext = bottext + "<b>" + rows[0].rname + "</b>:\n";
					for (i = 0, len = Object.keys(rows).length; i < len; i++) {

						if (rows[i].id != raritypre) {
							bottext = bottext + "\n<b>" + rows[i].rname + "</b>:\n";
						}
						if (rows[i].craftable == 0) {
							rows[i].name = "<b>" + rows[i].name + "</b>";
						}
						bottext = bottext + "> " + rows[i].name + " (" + formatNumber(rows[i].num) + ")\n";
						raritypre = rows[i].id;
					}
				} else {
					var raritycnt = 0;
					bottext = bottext + "<b>" + rows[0].rname + "</b>: ";
					for (i = 0, len = Object.keys(rows).length; i < len; i++) {

						if (rows[i].id != raritypre) {
							bottext += raritycnt + "\n<b>" + rows[i].rname + "</b>: ";
							raritycnt = 0;
						}

						raritycnt += rows[i].num;
						raritypre = rows[i].id;
					}
					bottext += raritycnt;
				}
			} else {
				bottext = bottext + "Lo zaino Ã¨ vuoto\n";
			}

			var max = 3000;
			if (Object.keys(bottext).length > max) {
				var arr = bottext.split("\n");
				var text = "";
				for (var i = 0, len = Object.keys(arr).length; i < len; i++) {
					text += arr[i] + "\n";
					if ((Object.keys(text).length + Object.keys(arr[i]).length) >= max) {
						bot.sendMessage(message.chat.id, text, backpackB);
						text = "";
					}
				}
				if (text != "") {
					setTimeout(function () {
						bot.sendMessage(message.chat.id, text, backpackB);
					}, 300);
				}
			} else {
				bot.sendMessage(message.chat.id, bottext, backpackB);
			}
		});
	});
});

bot.onText(/^set$|^set ðŸ’£$|torna ai set|^Imposta (.+)/i, function (message) {
	if (message.text == "Nuovo Set") {
		return;
	}

	connection.query('SELECT id, holiday, account_id, exp, reborn FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var player_level = Math.floor(rows[0].exp / 10);
		var player_reborn = rows[0].reborn;

		var setBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna ai set"], ["Torna al menu"]]
			}
		};

		var setYesno = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Elimina"], ["Torna ai set"], ["Torna al menu"]]
			}
		};

		var setYesNo2 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si"], ["Torna ai set"], ["Torna al menu"]]
			}
		};

		if (message.text.toLowerCase().indexOf("imposta") != -1) {

			if (message.text.indexOf("(") != -1) {
				message.text = message.text.substring(0, message.text.indexOf("("));
			}

			var reg = /Imposta (.+)/i;
			var found = message.text.match(reg);
			var set = found[1];

			connection.query('SELECT id FROM set_list WHERE name = "' + set + '" AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Set non valido", setBack);
					return;
				}

				var setId = rows[0].id;

				connection.query('SELECT S.id, S.name, I1.name As weapon, I1.id As wId, I1.power As power1, I1.critical As crit1, I1.rarity As rarity1, I1.reborn As reborn1, I2.name As armor, I2.id As aId, I2.power_armor As power2, I2.critical As crit2, I2.rarity As rarity2, I2.reborn As reborn2, I3.name As shield, I3.id As sId, I3.power_shield As power3, I3.critical As crit3, I3.rarity As rarity3, I3.reborn As reborn3, I4.name As charm, I4.id As cId, I4.rarity As rarity4, I4.reborn As reborn4 FROM set_list S LEFT JOIN item I1 ON I1.id = S.item_weapon LEFT JOIN item I2 ON I2.id = S.item_armor LEFT JOIN item I3 ON I3.id = S.item_shield LEFT JOIN item I4 ON I4.id = S.item_charm WHERE S.id = ' + setId, function (err, rows, fields) {
					if (err) throw err;

					var setId = rows[0].id;
					var text = "Set *" + rows[0].name + "* (" + setId + ")\n\n";

					if (rows[0].weapon != null) {
						text += "Arma: " + rows[0].weapon + "\n";
					}
					if (rows[0].armor != null) {
						text += "Armatura: " + rows[0].armor + "\n";
					}
					if (rows[0].shield != null) {
						text += "Scudo: " + rows[0].shield + "\n";
					}
					if (rows[0].charm != null) {
						text += "Talismano: " + rows[0].charm + "\n";
					}

					var wName = rows[0].weapon;
					var aName = rows[0].armor;
					var sName = rows[0].shield;
					var cName = rows[0].charm;

					var wId = rows[0].wId;
					var aId = rows[0].aId;
					var sId = rows[0].sId;
					var cId = rows[0].cId;

					var pow1 = rows[0].power1;
					var pow2 = rows[0].power2;
					var pow3 = rows[0].power3;

					var crit1 = rows[0].crit1;
					var crit2 = rows[0].crit2;
					var crit3 = rows[0].crit3;

					var reborn1 = rows[0].reborn1;
					var reborn2 = rows[0].reborn2;
					var reborn3 = rows[0].reborn3;
					var reborn4 = rows[0].reborn4;

					var rarity1 = rows[0].rarity1;
					var rarity2 = rows[0].rarity2;
					var rarity3 = rows[0].rarity3;
					var rarity4 = rows[0].rarity4;

					bot.sendMessage(message.chat.id, text + "\nConfermi il set?", setYesno).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text.toLowerCase() == "si") {

								if ((getItemCnt(player_id, wId) == 0) && (wName != null)) {
									bot.sendMessage(message.chat.id, "Non possiedi " + wName, setBack);
									return;
								}

								var level_nec = 0;
								if (rarity1 == "UR") {
									level_nec = 15;
								} else if (rarity1 == "L") {
									level_nec = 30;
								} else if (rarity1 == "E") {
									level_nec = 50;
								} else if (rarity1 == "UE") {
									level_nec = 60;
								}

								if ((player_level < level_nec) && (player_reborn == 1)) {
									bot.sendMessage(message.chat.id, "Non hai il livello necessario per equipaggiare " + wName + ". (" + level_nec + ")", setBack);
									return;
								}

								if (player_reborn < reborn1) {
									bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario per equipaggiare " + wName + ".", setBack);
									return;
								}


								if ((getItemCnt(player_id, aId) == 0) && (aName != null)) {
									bot.sendMessage(message.chat.id, "Non possiedi " + aName, setBack);
									return;
								}

								var level_nec = 0;
								if (rarity2 == "UR") {
									level_nec = 15;
								} else if (rarity2 == "L") {
									level_nec = 30;
								} else if (rarity2 == "E") {
									level_nec = 50;
								} else if (rarity2 == "UE") {
									level_nec = 60;
								}

								if ((player_level < level_nec) && (player_reborn == 1)) {
									bot.sendMessage(message.chat.id, "Non hai il livello necessario per equipaggiare " + aName + ". (" + level_nec + ")", setBack);
									return;
								}

								if (player_reborn < reborn2) {
									bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario per equipaggiare " + aName + ".", setBack);
									return;
								}


								if ((getItemCnt(player_id, sId) == 0) && (sName != null)) {
									bot.sendMessage(message.chat.id, "Non possiedi " + sName, setBack);
									return;
								}

								var level_nec = 0;
								if (rarity3 == "UR") {
									level_nec = 15;
								} else if (rarity3 == "L") {
									level_nec = 30;
								} else if (rarity3 == "E") {
									level_nec = 50;
								} else if (rarity3 == "UE") {
									level_nec = 60;
								}

								if ((player_level < level_nec) && (player_reborn == 1)) {
									bot.sendMessage(message.chat.id, "Non hai il livello necessario per equipaggiare " + sName + ". (" + level_nec + ")", setBack);
									return;
								}

								if (player_reborn < reborn3) {
									bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario per equipaggiare " + sName + ".", setBack);
									return;
								}


								if ((getItemCnt(player_id, cId) == 0) && (cName != null)) {
									bot.sendMessage(message.chat.id, "Non possiedi " + cName, setBack);
									return;
								}

								var level_nec = 0;
								if (rarity4 == "UR") {
									level_nec = 15;
								} else if (rarity4 == "L") {
									level_nec = 30;
								} else if (rarity4 == "E") {
									level_nec = 50;
								} else if (rarity4 == "UE") {
									level_nec = 60;
								}

								if ((player_level < level_nec) && (player_reborn == 1)) {
									bot.sendMessage(message.chat.id, "Non hai il livello necessario per equipaggiare " + cName + ". (" + level_nec + ")", setBack);
									return;
								}

								if (player_reborn < reborn4) {
									bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario per equipaggiare " + cName + ".", setBack);
									return;
								}

								connection.query('SELECT weapon_id, weapon2_id, weapon3_id, charm_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;

									if (wId != null) {
										if (rows[0].weapon_id != 0) {
											addItem(player_id, rows[0].weapon_id);
										}
									}
									if (aId != null) {
										if (rows[0].weapon2_id != 0) {
											addItem(player_id, rows[0].weapon2_id);
										}
									}
									if (sId != null) {
										if (rows[0].weapon3_id != 0) {
											addItem(player_id, rows[0].weapon3_id);
										}
									}
									if (cId != null) {
										if (rows[0].charm_id != 0) {
											addItem(player_id, rows[0].charm_id);
										}
									}

									connection.query('SELECT weapon, weapon_id, weapon_crit, weapon2, weapon2_id, weapon2_crit, weapon3, weapon3_id, weapon3_crit, charm_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										if (wId == null) {
											wId = rows[0].weapon_id;
										} else {
											delItem(player_id, wId, 1);
										}
										if (aId == null) {
											aId = rows[0].weapon2_id;
										} else {
											delItem(player_id, aId, 1);
										}
										if (sId == null) {
											sId = rows[0].weapon3_id;
										} else {
											delItem(player_id, sId, 1);
										}
										if (cId == null) {
											cId = rows[0].charm_id;
										} else {
											delItem(player_id, cId, 1);
										}

										if (pow1 == null) {
											pow1 = rows[0].weapon;
										}
										if (pow2 == null) {
											pow2 = rows[0].weapon2;
										}
										if (pow3 == null) {
											pow3 = rows[0].weapon3;
										}

										if (crit1 == null) {
											crit1 = rows[0].weapon_crit;
										}
										if (crit2 == null) {
											crit2 = rows[0].weapon2_crit;
										}
										if (crit3 == null) {
											crit3 = rows[0].weapon3_crit;
										}

										connection.query('UPDATE player SET weapon_id = ' + wId + ', weapon = ' + pow1 + ', weapon_crit = ' + crit1 + ', ' +
														 'weapon2_id = ' + aId + ', weapon2 = ' + pow2 + ', weapon2_crit = ' + crit2 + ', ' +
														 'weapon3_id = ' + sId + ', weapon3 = ' + pow3 + ', weapon3_crit = ' + crit3 + ', ' +
														 'charm_id = ' + cId + ' WHERE id = ' + player_id,
														 function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Set equipaggiato!", setBack);
										});
									});
								});
							} else if (answer.text == "Elimina") {
								bot.sendMessage(message.chat.id, "Sei sicuro di voler eliminare il set?", setYesNo2).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "si") {
											connection.query('DELETE FROM set_list WHERE id = ' + setId, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Set eliminato!", setBack);
											});
										}
									};
								});
							}
						};
					});
				});
			});
			return;
		};

		connection.query('SELECT name, quantity FROM set_list WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			iKeys = [];
			if (Object.keys(rows).length > 0) {
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					iKeys.push(["Imposta " + rows[i].name + " (" + rows[i].quantity + " oggetti)"]);
				}
			}
			iKeys.push(["Nuovo Set", "Carica Set"]);
			iKeys.push(["Torna allo zaino"]);
			iKeys.push(["Torna al menu"]);

			var setList = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			bot.sendMessage(message.chat.id, "Imposta o modifica un set di equipaggiamento", setList).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					var resp = answer.text.toLowerCase();
					if (resp == "nuovo set") {
						bot.sendMessage(message.chat.id, "Aggiungi un nuovo set utilizzando questo formato:\nNOMESET: ARMA,ARMATURA,SCUDO,TALISMANO\n" +
										"_Esempio:_ Guerriero: Spada Antimateria,Armatura Nova,Scudo Statico,Talismano Guerriero\n" +
										"Se salti un campo, verrÃ  mantenuto l'oggetto attuale equipaggiato\n" +
										"_Esempio:_ Contadino: Coltello a Baionetta,Protezione di Stoffa,,Talismano della Forza\n\nAttenzione: Non usare parole chiave come 'viaggio' o 'missione', o non riuscirai piÃ¹ ad impostarlo!", setBack).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								var resp = answer.text;

								if ((resp == "Torna al menu") || (resp == "Torna ai set")) {
									return;
								}

								var reg = new RegExp("([a-zA-Z0-9 ]+): *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*)");
								var reg2 = /([a-zA-Z0-9 ]+): *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*), *([a-zA-Z\- 'Ã Ã¨Ã©Ã¬Ã²Ã¹]*)/i;
								if (reg.test(resp) == false) {
									bot.sendMessage(message.chat.id, "Sintassi non valida, riprova", setBack);
									return;
								}

								var found = resp.match(reg);

								if (found == null) {
									bot.sendMessage(message.chat.id, "Errore di sintassi, riprova", setBack);
									return;
								}

								var title = found[1].trim();
								var weapon1 = found[2].trim();
								var weapon2 = found[3].trim();
								var weapon3 = found[4].trim();
								var weapon4 = found[5].trim();

								var text = "Set *" + title + "*:\n";

								if (weapon1 != "") {
									text += weapon1;
								}
								if (weapon2 != "") {
									text += weapon2;
								}
								if (weapon3 != "") {
									text += weapon3;
								}
								if (weapon4 != "") {
									text += weapon4;
								}

								var w1 = null;
								var w2 = null;
								var w3 = null;
								var w4 = null;
								var qnt = 0;

								connection.query('SELECT name FROM set_list WHERE name = "' + title + '" AND player_id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length > 0) {
										bot.sendMessage(message.chat.id, "Non puoi utilizzare due nomi uguali", setBack);
										return;
									}

									connection.query('SELECT id FROM item WHERE name = "' + weapon1 + '" AND power > 0', function (err, rows, fields) {
										if (err) throw err;
										if ((Object.keys(rows).length == 0) && (weapon1 != "")) {
											bot.sendMessage(message.chat.id, "L'arma non Ã¨ valida", setBack);
											return;
										} else if (weapon1 == "") {
											w1 = 0;
										} else {
											w1 = rows[0].id;
											qnt++;
										}
										connection.query('SELECT id FROM item WHERE name = "' + weapon2 + '" AND power_armor < 0', function (err, rows, fields) {
											if (err) throw err;
											if ((Object.keys(rows).length == 0) && (weapon2 != "")) {
												bot.sendMessage(message.chat.id, "L'armatura non Ã¨ valida", setBack);
												return;
											} else if (weapon2 == "") {
												w2 = 0;
											} else {
												w2 = rows[0].id;
												qnt++;
											}
											connection.query('SELECT id FROM item WHERE name = "' + weapon3 + '" AND power_shield < 0', function (err, rows, fields) {
												if (err) throw err;
												if ((Object.keys(rows).length == 0) && (weapon3 != "")) {
													bot.sendMessage(message.chat.id, "Lo scudo non Ã¨ valido", setBack);
													return;
												} else if (weapon3 == "") {
													w3 = 0;
												} else {
													w3 = rows[0].id;
													qnt++;
												}
												connection.query('SELECT id FROM item WHERE name = "' + weapon4 + '" AND name LIKE "Talismano%"', function (err, rows, fields) {
													if (err) throw err;
													if ((Object.keys(rows).length == 0) && (weapon4 != "")) {
														bot.sendMessage(message.chat.id, "Il talismano non Ã¨ valido", setBack);
														return;
													} else if (weapon4 == "") {
														w4 = 0;
													} else {
														w4 = rows[0].id;
														qnt++;
													}

													connection.query('INSERT INTO set_list (player_id, quantity, name, item_weapon, item_armor, item_shield, item_charm) ' +
																	 'VALUES (' + player_id + ',' + qnt + ',"' + title + '",' + w1 + ',' + w2 + ',' + w3 + ',' + w4 + ')',
																	 function (err, rows, fields) {
														if (err) throw err;
														connection.query('SELECT MAX(id) As maxid FROM set_list WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Set *" + title + "* creato! (Codice importazione: " + rows[0].maxid + ")", setBack);
														});
													});
												});
											});
										});
									});
								});
							}
						});
					} else if (resp == "carica set") {
						bot.sendMessage(message.chat.id, "Inserisci il codice del set da importare", setBack).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text == "Torna al set") {
									return;
								}
								var code = parseInt(answer.text);

								if (isNaN(code)) {
									bot.sendMessage(message.chat.id, "Questo codice set non esiste", setBack);
									return;
								}

								connection.query('SELECT * FROM set_list WHERE id = ' + code, function (err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "Questo codice set non esiste", setBack);
										return;
									}

									var title = rows[0].name;

									connection.query('INSERT INTO set_list (player_id, quantity, name, item_weapon, item_armor, item_shield, item_charm) ' +
													 'VALUES (' + player_id + ',' + rows[0].quantity + ',"' + rows[0].name + '",' + rows[0].item_weapon + ',' + rows[0].item_armor + ',' + rows[0].item_shield + ',' + rows[0].item_charm + ')',
													 function (err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT MAX(id) As maxid FROM set_list WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Set *" + title + "* importato! (Codice condivisione: " + rows[0].maxid + ")", setBack);
										});
									});
								});
							}
						});
					}
				}
			});
		});
	});
});

bot.onText(/^solo (.){1,10}$/i, function (message) {

	var backPack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna allo Zaino"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var soloRarity = message.text.substring(message.text.indexOf(" ") + 1);
		var text = "";

		if (soloRarity.toLowerCase() == "i") {
			connection.query('SELECT type, power, quantity FROM magic WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0) {
					text = "*Incantesimi:*\n\n";
					var n = "";
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].type == 1) {
							n = "Furia dei Mari";
						} else if (rows[i].type == 2) {
							n = "Tempesta Folgorante";
						} else if (rows[i].type == 3) {
							n = "Impeto di Fiamme";
						} else if (rows[i].type == 4) {
							n = "Ira Astrale";
						}
						text = text + "> " + n + " " + rows[i].power + " (" + rows[i].quantity + ")\n";
					}
				} else {
					text = text + "Nessun incantesimo disponibile\n";
				}

				if (Object.keys(text).length > 8000) {
					bot.sendMessage(message.chat.id, "Questo filtro mostra troppi risultati, riprova", backPack);
				} else if (Object.keys(text).length > 4000) {
					var arr = text.split("\n");
					text = "";
					for (var i = 0, len = Object.keys(arr).length; i < len; i++) {
						text += arr[i] + "\n";
						if ((Object.keys(text).length + Object.keys(arr[i]).length) >= 4000) {
							bot.sendMessage(message.chat.id, text, backPack);
							text = "";
						}
					}
					if (text != "") {
						setTimeout(function () {
							bot.sendMessage(message.chat.id, text, backPack);
						}, 300);
					}
				} else {
					bot.sendMessage(message.chat.id, text, backPack);
				}
			});
		} else if (soloRarity.toLowerCase() == "base") {

			connection.query('SELECT inventory.player_id, item.name, item.craftable, rarity.id, rarity.name As rname, inventory.quantity As num FROM inventory, item, rarity WHERE player_id = ' + player_id + ' AND rarity.shortname = item.rarity AND inventory.item_id = item.id AND craftable = 0 AND inventory.quantity > 0 ORDER BY item.name ASC', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					text = "*Oggetti base:*\n\n";
					for (i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].craftable == 0) {
							rows[i].name = "*" + rows[i].name + "*";
						}
						text = text + "> " + rows[i].name + " (" + rows[i].num + ")\n";
					}
				} else {
					text = text + "Nessun oggetto base disponibile\n";
				}
				if (Object.keys(text).length > 8000) {
					bot.sendMessage(message.chat.id, "Questo filtro mostra troppi risultati, riprova", backPack);
				} else if (Object.keys(text).length > 4000) {
					var arr = text.split("\n");
					text = "";
					for (var i = 0, len = Object.keys(arr).length; i < len; i++) {
						text += arr[i] + "\n";
						if ((Object.keys(text).length + Object.keys(arr[i]).length) >= 4000) {
							bot.sendMessage(message.chat.id, text, backPack);
							text = "";
						}
					}
					if (text != "") {
						setTimeout(function () {
							bot.sendMessage(message.chat.id, text, backPack);
						}, 300);
					}
				} else {
					bot.sendMessage(message.chat.id, text, backPack);
				}
			});
		} else if (soloRarity.toLowerCase() == "creati") {
			connection.query('SELECT inventory.player_id, item.name, item.craftable, rarity.id, rarity.name As rname, inventory.quantity As num FROM `inventory`, item, rarity WHERE player_id = ' + player_id + ' AND rarity.shortname = item.rarity AND inventory.item_id = item.id AND craftable = 1 AND inventory.quantity > 0 ORDER BY item.name ASC', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					text = "*Oggetti creati:*\n\n";
					for (i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].craftable == 0) {
							rows[i].name = "*" + rows[i].name + "*";
						}
						text = text + "> " + rows[i].name + " (" + rows[i].num + ")\n";
					}
				} else {
					text = text + "Nessun oggetto creato disponibile\n";
				}
				if (Object.keys(text).length > 8000) {
					bot.sendMessage(message.chat.id, "Questo filtro mostra troppi risultati, riprova", backPack);
				} else if (Object.keys(text).length > 4000) {
					var arr = text.split("\n");
					text = "";
					for (var i = 0, len = Object.keys(arr).length; i < len; i++) {
						text += arr[i] + "\n";
						if ((Object.keys(text).length + Object.keys(arr[i]).length) >= 4000) {
							bot.sendMessage(message.chat.id, text, backPack);
							text = "";
						}
					}
					if (text != "") {
						setTimeout(function () {
							bot.sendMessage(message.chat.id, text, backPack);
						}, 300);
					}
				} else {
					bot.sendMessage(message.chat.id, text, backPack);
				}
			});
		} else {

			connection.query('SELECT inventory.player_id, item.name, item.craftable, rarity.id, rarity.name As rname, inventory.quantity As num FROM inventory, item, rarity WHERE player_id = ' + player_id + ' AND rarity.shortname = item.rarity AND inventory.item_id = item.id AND rarity = "' + soloRarity + '" AND inventory.quantity > 0 ORDER BY rarity.id DESC, item.name ASC', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					text = "*" + rows[0].rname + "*:\n\n";

					for (i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].craftable == 0) {
							rows[i].name = "*" + rows[i].name + "*";
						}
						text = text + "> " + rows[i].name + " (" + rows[i].num + ")\n";
					}
				} else {
					text = text + "Nessun oggetto di questa raritÃ  disponibile\n";
				}
				if (Object.keys(text).length > 8000) {
					bot.sendMessage(message.chat.id, "Questo filtro mostra troppi risultati, riprova", backPack);
				} else if (Object.keys(text).length > 4000) {
					var arr = text.split("\n");
					text = "";
					for (var i = 0, len = Object.keys(arr).length; i < len; i++) {
						text += arr[i] + "\n";
						if ((Object.keys(text).length + Object.keys(arr[i]).length) >= 4000) {
							bot.sendMessage(message.chat.id, text, backPack);
							text = "";
						}
					}
					if (text != "") {
						setTimeout(function () {
							bot.sendMessage(message.chat.id, text, backPack);
						}, 300);
					}
				} else {
					bot.sendMessage(message.chat.id, text, backPack);
				}
			});
		}
	});
});

bot.onText(/^Top|Torna alle top/i, function (message) {
	var kb = {
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [['Le Mie Classifiche'], ['Creazioni', 'Settimanale'], ['AbilitÃ ', 'Rango'], ['Imprese Completate', 'Missioni'], ['Albo Artefatti', 'Classifica Contrabbandiere'], ['Impresa Globale', 'Globali Contribuite'], ['Potenziamenti Flaridion'], ['Cambia Top', 'Torna al menu']]
		}
	};

	bot.sendMessage(message.chat.id, "Seleziona il tipo di classifica da visualizzare", kb);
});

bot.onText(/^Cambia Top/i, function (message) {
	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna alle Top"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, top_min FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;

		if (rows[0].top_min == 0) {
			connection.query('UPDATE player SET top_min = 1 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Hai attivato la visualizzazione delle prime posizioni in classifica", kb);
			});
		} else {
			connection.query('UPDATE player SET top_min = 0 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(message.chat.id, "Hai attivato la visualizzazione della tua posizione in classifica", kb);
			});
		}
	});
});

bot.onText(/^Le Mie Classifiche/i, function (message) {

	var text = "La tua posizione nelle varie classifiche:\n";
	var c = 1;
	var mypnt = 0;
	var mypos = 0;

	connection.query('SELECT nickname, craft_count As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, craft_count, exp, weapon ORDER BY points DESC', function (err, rows, fields) {
		if (err) throw err;
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
				mypnt = rows[i].points;
				mypos = c;
			}
			c++;
		}
		text = text + "\n*Punti crafting*: " + mypos + "Â° con " + mypnt;
		c = 1;
		mypnt = 0;
		mypos = 0;

		connection.query('SELECT nickname, craft_week As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, craft_week, exp, weapon ORDER BY points DESC', function (err, rows, fields) {
			if (err) throw err;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
					mypnt = rows[i].points;
					mypos = c;
				}
				c++;
			}
			text = text + "\n*Punti crafting settimanali*: " + mypos + "Â° con " + mypnt + " pnt";
			c = 1;
			mypnt = 0;
			mypos = 0;

			connection.query('SELECT nickname, rank As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, rank, exp, weapon ORDER BY points DESC', function (err, rows, fields) {
				if (err) throw err;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
						mypnt = rows[i].points;
						mypos = c;
					}
					c++;
				}
				text = text + "\n*Punti rango*: " + mypos + "Â° con " + mypnt;
				c = 1;
				mypnt = 0;
				mypos = 0;

				connection.query('SELECT nickname, achievement_count As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, achievement_count, exp, weapon ORDER BY points DESC', function (err, rows, fields) {
					if (err) throw err;
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
							mypnt = rows[i].points;
							mypos = c;
						}
						c++;
					}
					text = text + "\n*Imprese giornaliere*: " + mypos + "Â° con " + mypnt + " pnt";
					c = 1;
					mypnt = 0;
					mypos = 0;

					connection.query('SELECT nickname, mission_count As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, mission_count, exp, weapon ORDER BY points DESC', function (err, rows, fields) {
						if (err) throw err;
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
								mypnt = rows[i].points;
								mypos = c;
							}
							c++;
						}
						text = text + "\n*Missioni completate*: " + mypos + "Â° con " + mypnt;
						c = 1;
						mypnt = 0;
						mypos = 0;

						connection.query('SELECT nickname, ability As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, ability, exp, weapon ORDER BY points DESC', function (err, rows, fields) {
							if (err) throw err;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
									mypnt = rows[i].points;
									mypos = c;
								}
								c++;
							}
							text = text + "\n*AbilitÃ *: " + mypos + "Â° con " + mypnt;
							c = 1;
							mypnt = 0;
							mypos = 0;

							connection.query('SELECT nickname, total_cnt FROM merchant_offer, player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND merchant_offer.player_id = player.id AND player.id NOT IN (1,3) ORDER BY total_cnt DESC', function (err, rows, fields) {
								if (err) throw err;
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
										mypos = c;
										mypnt = rows[i].total_cnt;
									}
									c++;
								}
								text = text + "\n*Contrabbandiere*: " + mypos + "Â° con " + mypnt + " offerte";
								c = 1;
								mypnt = 0;
								mypos = 0;

								connection.query('SELECT nickname, SUM(value) As cnt FROM achievement_global A, player P WHERE account_id NOT IN (SELECT account_id FROM banlist) AND P.id NOT IN (1,3) AND A.player_id = P.id GROUP BY player_id ORDER BY SUM(value) DESC', function (err, rows, fields) {
									if (err) throw err;
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
										if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
											mypos = c;
											mypnt = rows[i].cnt;
										}
										c++;
									}

									connection.query('SELECT global_eventwait FROM config', function (err, rows, fields) {
										if (err) throw err;

										if (rows[0].global_eventwait == 0) {
											if (mypos > 0)
												text = text + "\n*Impresa Globale*: " + mypos + "Â° con " + mypnt + " punti";
										}

										c = 1;
										mypnt = 0;
										mypos = 0;

										connection.query('SELECT nickname, global_event As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, global_event, exp, weapon ORDER BY points DESC', function (err, rows, fields) {
											if (err) throw err;
											for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
												if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
													mypos = c;
													mypnt = rows[i].points;
												}
												c++;
											}
											text = text + "\n*Globali*: " + mypos + "Â° con " + mypnt;
											c = 1;
											mypnt = 0;
											mypos = 0;

											connection.query('SELECT nickname, power_used As total_cnt FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) HAVING total_cnt > 0 ORDER BY total_cnt DESC', function (err, rows, fields) {
												if (err) throw err;
												for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
													if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
														mypos = c;
														mypnt = rows[i].total_cnt;
													}
													c++;
												}
												text = text + "\n*Potenziamenti Flaridion*: " + mypos + "Â° con " + mypnt;
												c = 1;
												mypnt = 0;
												mypos = 0;

												var keyrank = {
													parse_mode: "Markdown",
													reply_markup: {
														resize_keyboard: true,
														//one_time_keyboard: true,
														"keyboard": [['Top'], ['Torna al menu']]
													}
												};

												bot.sendMessage(message.chat.id, text, keyrank);
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
});

bot.onText(/^Creazioni/i, function (message) {
	getRank(message, 20, 0);
});

bot.onText(/^Settimanale/i, function (message) {
	getRank(message, 20, 1);
});

bot.onText(/^AbilitÃ $/i, function (message) {
	getRank(message, 20, 6);
});

/*
bot.onText(/^Draghi$/i, function(message) {
	getRankDr(message, 20);
});
*/

bot.onText(/^Rango$/i, function (message) {
	getRank(message, 20, 2);
});

bot.onText(/^Imprese Completate$/i, function (message) {
	getRank(message, 20, 4);
});

bot.onText(/^Missioni$/i, function (message) {
	getRank(message, 20, 5);
});

bot.onText(/^Albo Artefatti$/i, function (message) {
	getRankArt(message, 100);
});

bot.onText(/^Potenziamenti Flaridion$/i, function (message) {
	getRankAt(message, 20);
});

bot.onText(/^Impresa Globale$/i, function (message) {
	getRankAch(message, 20);
});

bot.onText(/^Globali Contribuite/i, function (message) {
	getRank(message, 20, 7);
});

function getRank(message, size, type) {
	var t = "craft_count";
	var tx = "sui punti creazione";
	var tval = "pnt";
	if (type == 1) {
		t = "craft_week";
		tx = "sui punti creazione settimanali";
	} else if (type == 2) {
		t = "rank";
		tx = "sui punti rango dungeon";
	} else if (type == 4) {
		t = "achievement_count";
		tx = "sulle imprese giornaliere completate";
	} else if (type == 5) {
		t = "mission_count";
		tx = "sulle missioni completate";
	} else if (type == 6) {
		t = "ability";
		tx = "sull'abilitÃ ";
	} else if (type == 7) {
		t = "global_event";
		tx = "sul contributo alle imprese globali";
	}

	var text = "Classifica basata " + tx + ":\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var mypos = 0;

	connection.query('SELECT top_min FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (rows[0].top_min == 1) {
			connection.query('SELECT nickname, ' + t + ' As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, ' + t + ', exp, weapon ORDER BY points DESC', function (err, rows, fields) {
				if (err) throw err;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (c < size + 1) {
						rows[i].points = formatNumber(rows[i].points);
						text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].points + " " + tval + ")\n";
					}
					if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
						mypnt = formatNumber(rows[i].points);
						mypos = c;
					}
					c++;
				}
				text = text + "\nTu:\n" + mypos + "Â° " + message.from.username + " (" + mypnt + " " + tval + ")";

				bot.sendMessage(message.chat.id, text, keyrank);
			});
		} else {
			connection.query('SELECT nickname, ' + t + ' As points FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) GROUP BY nickname, ' + t + ', exp, weapon ORDER BY points DESC', function (err, rows, fields) {
				if (err) throw err;

				var range = 5;

				var nickname = [];
				var points = [];
				var mypos = 0;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					nickname.push(rows[i].nickname);
					points.push(rows[i].points);
					if (message.from.username.toLowerCase() == rows[i].nickname.toLowerCase()) {
						mypos = i;
					}
				}

				for (var i = (mypos - range); i < (mypos + (range + 1)); i++) {
					if (nickname[i] != undefined) {
						if (i == mypos) {
							text += (i + 1) + "Â° <b>" + nickname[i] + "</b> (" + points[i] + " " + tval + ")\n";
						} else {
							text += (i + 1) + "Â° " + nickname[i] + " (" + points[i] + " " + tval + ")\n";
						}
					}
				}

				bot.sendMessage(message.chat.id, text, keyrank);
			});
		};
	});
};

function getRankAt(message, size) {
	var text = "Classifica potenziamenti Flaridion:\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var myinfo = 0;
	var size = 20;

	connection.query('SELECT top_min FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (rows[0].top_min == 1) {
			connection.query('SELECT nickname, power_used As total_cnt FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) HAVING total_cnt > 0 ORDER BY total_cnt DESC', function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Ancora nessuno ha utilizzato un potenziamento Flaridion", keyrank);
					return;
				}

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (c < 31) {
						if (c < size + 1) {
							text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].total_cnt + ")\n";
						}
					}
					if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
						mypnt = rows[i].total_cnt;
						myinfo = c + "Â° " + rows[i].nickname + " (" + rows[i].total_cnt + ")\n";
					}
					c++;
				}
				text = text + "\nTu:\n" + myinfo;

				bot.sendMessage(message.chat.id, text, keyrank);
			});
		} else {
			connection.query('SELECT nickname, power_used As total_cnt FROM player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) HAVING total_cnt > 0 ORDER BY total_cnt DESC', function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Ancora nessuno ha utilizzato un potenziamento Flaridion", keyrank);
					return;
				}

				var range = 5;

				var nickname = [];
				var total_cnt = [];
				var mypos = 0;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					nickname.push(rows[i].nickname);
					total_cnt.push(rows[i].total_cnt);
					if (message.from.username.toLowerCase() == rows[i].nickname.toLowerCase()) {
						mypos = i;
					}
				}
				for (var i = (mypos - range); i < (mypos + (range + 1)); i++) {
					if (nickname[i] != undefined) {
						if (i == mypos) {
							text += (i + 1) + "Â° <b>" + nickname[i] + "</b> (" + total_cnt[i] + ")\n";
						} else {
							text += (i + 1) + "Â° " + nickname[i] + " (" + total_cnt[i] + ")\n";
						}
					}
				}

				bot.sendMessage(message.chat.id, text, keyrank);
			});
		}
	});
}

function getRankArt(message, size) {
	var text = "Albo artefatti:\n";
	var totpnt = 0;

	connection.query('SELECT P.nickname, A.get_date FROM artifacts A, player P WHERE P.account_id NOT IN (SELECT account_id FROM banlist) AND P.id NOT IN (1,3) AND A.player_id = P.id AND item_id = 675', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Ancora nessun giocatore ha ottenuto tutti gli artefatti", back);
			return;
		}

		var get_time = new Date();
		var short_date = "";
		for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
			get_time = new Date(rows[i].get_date);
			short_date = addZero(get_time.getHours()) + ':' + addZero(get_time.getMinutes()) + " del " + addZero(get_time.getDate()) + "/" + addZero(get_time.getMonth() + 1) + "/" + get_time.getFullYear();
			text += "> " + rows[i].nickname + " (" + short_date + ")\n";
		}

		bot.sendMessage(message.chat.id, text, keyrank);
	});
};

function getRankAch(message, size) {
	var text = "Classifica Impresa Globale:\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var mypos = 0;
	var size = 20;

	connection.query('SELECT global_eventwait FROM config', function (err, rows, fields) {
		if (err) throw err;

		if (rows[0].global_eventwait == 1) {
			bot.sendMessage(message.chat.id, "La classifica sarÃ  disponibile a breve", keyrank);
			return;
		}

		connection.query('SELECT top_min, global_event, id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
			if (err) throw err;

			var global_event = rows[0].global_event;
			var top_min = rows[0].top_min;
			var player_id = rows[0].id;

			var kb = {
				parse_mode: "HTML",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [['Top'], ['Imprese'], ['Torna al menu']]
				}
			};

			connection.query('SELECT IFNULL(SUM(value),0) As cnt FROM achievement_global WHERE player_id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;

				if (rows[0].cnt == 0) {
					bot.sendMessage(message.chat.id, "Contribuisci all'obbiettivo dell'impresa globale per visualizzarne la classifica", keyrank);
					return;
				}

				if (top_min == 1) {
					connection.query('SELECT nickname, SUM(value) As cnt FROM achievement_global A, player P WHERE account_id NOT IN (SELECT account_id FROM banlist) AND P.id NOT IN (1,3) AND A.player_id = P.id GROUP BY player_id ORDER BY SUM(value) DESC', function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "La classifica Ã¨ ancora vuota", keyrank);
							return;
						}

						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (c < size + 1) {
								text += c + "Â° " + rows[i].nickname + " (" + formatNumber(rows[i].cnt) + ")\n";
							}
							if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
								mypnt = rows[i].cnt;
								mypos = c;
							}
							c++;
						}
						text += "\nTu:\n" + mypos + "Â° " + message.from.username + " (" + formatNumber(mypnt) + ")";

						connection.query('(SELECT nickname, SUM(A.value) As cnt FROM player P, achievement_global A WHERE P.id = A.player_id AND P.account_id NOT IN (SELECT account_id FROM banlist) GROUP BY A.player_id ORDER BY SUM(A.value) DESC LIMIT 100) UNION (SELECT nickname, SUM(A.value) As cnt FROM player P, achievement_global A WHERE P.id = A.player_id AND P.account_id NOT IN (SELECT account_id FROM banlist) AND P.global_event < 5 GROUP BY A.player_id ORDER BY SUM(A.value) DESC LIMIT 100)', function (err, rows, fields) {
							if (err) throw err;

							var found = 0;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
									found = 1;
									break;
								}
							}

							if (found == 1) {
								text += "\nA questo punteggio la partecipazione all'impresa <b>verrÃ  considerata</b> nelle tue statistiche!";
							} else {
								text += "\nA questo punteggio la partecipazione all'impresa <b>NON verrÃ </b> considerata nelle tue statistiche, impegnati di piÃ¹ per aumentare i tuoi punti!";
							}

							bot.sendMessage(message.chat.id, text, kb);
						});
					});
				} else {
					connection.query('SELECT nickname, SUM(value) As cnt FROM achievement_global A, player P WHERE account_id NOT IN (SELECT account_id FROM banlist) AND P.id NOT IN (1,3) AND A.player_id = P.id GROUP BY player_id ORDER BY SUM(value) DESC', function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "La classifica Ã¨ ancora vuota", keyrank);
							return;
						}

						var range = 5;

						var nickname = [];
						var point = [];
						var mypos = 0;

						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							nickname.push(rows[i].nickname);
							point.push(rows[i].cnt);
							if (message.from.username.toLowerCase() == rows[i].nickname.toLowerCase()) {
								mypos = i;
							}
						}

						for (var i = (mypos - range); i < (mypos + (range + 1)); i++) {
							if (nickname[i] != undefined) {
								if (i == mypos) {
									text += (i + 1) + "Â° <b>" + nickname[i] + "</b> (" + formatNumber(point[i]) + ")\n";
								} else {
									text += (i + 1) + "Â° " + nickname[i] + " (" + formatNumber(point[i]) + ")\n";
								}
							}
						}

						connection.query('(SELECT nickname, SUM(A.value) As cnt FROM player P, achievement_global A WHERE P.id = A.player_id AND P.account_id NOT IN (SELECT account_id FROM banlist) GROUP BY A.player_id ORDER BY SUM(A.value) DESC LIMIT 100) UNION (SELECT nickname, SUM(A.value) As cnt FROM player P, achievement_global A WHERE P.id = A.player_id AND P.account_id NOT IN (SELECT account_id FROM banlist) AND P.global_event < 5 GROUP BY A.player_id ORDER BY SUM(A.value) DESC LIMIT 100)', function (err, rows, fields) {
							if (err) throw err;

							var found = 0;
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
									found = 1;
									break;
								}
							}

							if (found == 1) {
								text += "\nA questo punteggio la partecipazione all'impresa <b>verrÃ  considerata</b> nelle tue statistiche!";
							} else {
								text += "\nA questo punteggio la partecipazione all'impresa <b>NON verrÃ </b> considerata nelle tue statistiche, impegnati di piÃ¹ per aumentare i tuoi punti!";
							}

							bot.sendMessage(message.chat.id, text, kb);
						});
					});
				}
			});
		});
	});
}

bot.onText(/Classifica Contrabbandiere/i, function (message) {
	var text = "Classifica offerte accettate:\n";
	var c = 1;
	var mypnt = 0;
	var totpnt = 0;
	var myinfo = 0;
	var size = 20;

	connection.query('SELECT top_min FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (rows[0].top_min == 1) {
			connection.query('SELECT nickname, total_cnt FROM merchant_offer, player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND merchant_offer.player_id = player.id AND player.id NOT IN (1,3) ORDER BY total_cnt DESC', function (err, rows, fields) {
				if (err) throw err;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (c < 31) {
						if (c < size + 1) {
							text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].total_cnt + ")\n";
						}
					}
					if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
						mypnt = rows[i].total_cnt;
						myinfo = c + "Â° " + rows[i].nickname + " (" + rows[i].total_cnt + ")\n";
					}
					c++;
				}
				text = text + "\nTu:\n" + myinfo;

				bot.sendMessage(message.chat.id, text, keyrank);
			});
		} else {
			connection.query('SELECT nickname, total_cnt FROM merchant_offer, player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND merchant_offer.player_id = player.id AND player.id NOT IN (1,3) ORDER BY total_cnt DESC', function (err, rows, fields) {
				if (err) throw err;

				var range = 5;

				var nickname = [];
				var total_cnt = [];
				var mypos = 0;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					nickname.push(rows[i].nickname);
					total_cnt.push(rows[i].total_cnt);
					if (message.from.username.toLowerCase() == rows[i].nickname.toLowerCase()) {
						mypos = i;
					}
				}
				for (var i = (mypos - range); i < (mypos + (range + 1)); i++) {
					if (nickname[i] != undefined) {
						if (i == mypos) {
							text += (i + 1) + "Â° <b>" + nickname[i] + "</b> (" + total_cnt[i] + ")\n";
						} else {
							text += (i + 1) + "Â° " + nickname[i] + " (" + total_cnt[i] + ")\n";
						}
					}
				}

				bot.sendMessage(message.chat.id, text, keyrank);
			});
		}
	});
});

bot.onText(/emporio/i, function (message) {
	var oggetto = "";
	var iKeys = [];

	var price_drop = 0;
	var price_drop_msg = "";
	var n = new Date().getDay()
	var n2 = new Date().getDate();

	if (n == 0) {
		if (n2 <= 7) {
			sconto = 20;
		}
		price_drop = 1;
		price_drop_msg = "*Oggi il prezzo Ã¨ ridotto del " + sconto + "%!*\n";
	}

	if (sconto_evento > 0) {
		sconto = sconto_evento;
		price_drop = 1;
		price_drop_msg = "*Oggi il prezzo Ã¨ ridotto del " + sconto + "%!*\n";
	}

	connection.query('SELECT id, holiday, money, account_id, mission_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		helpMsg(message.chat.id, player_id, 6);

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Compra", "Vendi", "Ricicla"], ["Torna alla piazza"], ["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, price_drop_msg + "Hai a disposizione " + formatNumber(money) + " Â§, cosa vuoi fare?", kb).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text.toLowerCase() == "compra") {
					connection.query('SELECT value, name FROM chest WHERE id < 7', function (err, rows, fields) {
						if (err) throw err;
						if (price_drop == 1) {
							iKeys.push(["Compra Pozione Piccola (" + formatNumber(parseInt(1200 - Math.round((1200 / 100) * sconto))) + " Â§)"]);
							iKeys.push(["Compra Pozione Media (" + formatNumber(parseInt(2400 - Math.round((2400 / 100) * sconto))) + " Â§)"]);
							iKeys.push(["Compra Pozione Grande (" + formatNumber(parseInt(4800 - Math.round((4800 / 100) * sconto))) + " Â§)"]);
							iKeys.push(["Compra Piuma di Fenice (" + formatNumber(parseInt(6000 - Math.round((6000 / 100) * sconto))) + " Â§)"]);
							iKeys.push(["Compra Cenere di Fenice (" + formatNumber(parseInt(25000 - Math.round((25000 / 100) * sconto))) + " Â§)"]);
							iKeys.push(["Compra Bevanda Energetica (" + formatNumber(parseInt(20000 - Math.round((20000 / 100) * sconto))) + " Â§)"]);
							iKeys.push(["Compra Bevanda Energetica Plus (" + formatNumber(parseInt(38000 - Math.round((38000 / 100) * sconto))) + " Â§)"]);
						} else {
							iKeys.push(["Compra Pozione Piccola (1.200 Â§)"]);
							iKeys.push(["Compra Pozione Media (2.400 Â§)"]);
							iKeys.push(["Compra Pozione Grande (4.800 Â§)"]);
							iKeys.push(["Compra Piuma di Fenice (6.000 Â§)"]);
							iKeys.push(["Compra Cenere di Fenice (25.000 Â§)"]);
							iKeys.push(["Compra Bevanda Energetica (20.000 Â§)"]);
							iKeys.push(["Compra Bevanda Energetica Plus (38.000 Â§)"]);
						}

						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (price_drop == 1) {
								rows[i].value = rows[i].value - Math.round((rows[i].value / 100) * sconto);
							}
							iKeys.push(["Compra " + rows[i].name + " (" + formatNumber(rows[i].value) + " Â§)"]);
						}
						iKeys.push(["Compra Gemma (300.000 Â§)"]);
						iKeys.push(["Torna all'emporio"]);
						iKeys.push(["Torna al menu"]);

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, "Seleziona l'oggetto da acquistare.", kb);
					});
				} else if (answer.text.toLowerCase() == "vendi") {
					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Valore < 250", "Valore < 500"], ["Valore < 1000", "Valore < 2000"], ["Valore < 7000", "Valore < 10000"], ["Valore < 20000", "Valore > 20000"], ["Vendi C", "Vendi NC"], ["Vendi R", "Vendi UR"], ["Vendi L", "Vendi E"], ["Torna all'emporio"], ["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona una categoria", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {

							if (answer.text.indexOf("Valore") == -1) {
								return;
							}

							var filter = answer.text.substring(answer.text.indexOf(" ") + 1);
							if (filter == "< 250") {
								filter = "<= 250";
							}else if (filter == "< 500") {
								filter = "<= 500 AND ROUND(value/2) > 250";
							} else if (filter == "< 1000") {
								filter = "<= 1000 AND ROUND(value/2) > 500";
							} else if (filter == "< 2000") {
								filter = "<= 2000 AND ROUND(value/2) > 1000";
							} else if (filter == "< 7000") {
								filter = "<= 7000 AND ROUND(value/2) > 2000";
							} else if (filter == "< 10000") {
								filter = "<= 10000 AND ROUND(value/2) > 7000";
							} else if (filter == "< 20000") {
								filter = "<= 20000 AND ROUND(value/2) > 10000";
							} else if (filter == "> 20000") {
								filter = "> 20000";
							}

							connection.query('SELECT ROUND(item.value/2) As value, item.name, inventory.quantity As num FROM inventory, item WHERE ROUND(value/2) ' + filter + ' AND inventory.player_id = ' + player_id + ' AND inventory.item_id = item.id AND inventory.quantity > 0 ORDER BY item.name', function (err, rows, fields) {
								if (err) throw err;
								for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
									iKeys.push(["Vendi " + rows[i].name + " (" + rows[i].value + " Â§) posseduti: " + rows[i].num]);
								}

								if (Object.keys(iKeys).length > 0) {
									iKeys.push(["Torna all'emporio"]);
									iKeys.push(["Torna al menu"]);

									var kb = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": iKeys
										}
									};

									bot.sendMessage(message.chat.id, "Seleziona l'oggetto da vendere", kb);
								} else {

									var kb = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": [["Torna all'emporio"], ["Torna al menu"]]
										}
									};

									bot.sendMessage(message.chat.id, "Nessun oggetto nello zaino.", kb);
								};
							});
						};
					});
				}
			};
		});
	});
});

bot.onText(/ricicla/i, function (message) {
	connection.query('SELECT id, holiday, money, account_id, mission_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;

		var kbR = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["C", "NC", "R"], ["UR", "L", "E"], ["D"], ["Torna all'emporio"], ["Torna al menu"]]
			}
		};

		var kb2 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Ricicla Ancora"], ["Torna al menu"]]
			}
		};

		var kbC = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Stessa RaritÃ "], ["RaritÃ  Superiore"], ["Torna al menu"]]
			}
		};

		if (message.text.indexOf("Ricicla:") != -1) {
			bot.sendMessage(message.chat.id, "Usa la nuova sintassi: /ricicla nome,quantitÃ ", back);
			return;
		}

		if (message.text.indexOf("/") != -1) {
			message.text = message.text.replace("/ricicla ", "");
			var oggetto = message.text.split(",")[0].trim();
			if (message.text.indexOf(",") == -1) {
				bot.sendMessage(message.chat.id, "Sintassi non valida: /ricicla nome,quantitÃ ", back);
				return;
			}
			var qnt = parseInt(message.text.split(",")[1].trim());

			if (isNaN(qnt)){
				bot.sendMessage(message.chat.id, "QuantitÃ  non valida.", back);
				return;
			}

			if ((qnt < 1) || (qnt > 10)){
				bot.sendMessage(message.chat.id, "QuantitÃ  non valida: minimo 1, massimo 10.", back);
				return;
			}

			bot.sendMessage(message.chat.id, "Con quale modalitÃ  vuoi riciclare " + (qnt*5) + "x " + oggetto + "?", kbC).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if ((answer.text == "Stessa RaritÃ ") || (answer.text == "RaritÃ  Superiore")) {
						connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							connection.query('SELECT inventory.item_id, item.name, inventory.quantity, item.rarity FROM inventory, item WHERE inventory.item_id = item.id AND player_id = ' + player_id + ' AND item.name = "' + oggetto + '"', function (err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0){
									bot.sendMessage(message.chat.id, "L'oggetto non esiste.", back);
									return;
								}

								if (rows[0].quantity < (qnt*5)) {
									bot.sendMessage(message.chat.id, "Non possiedi abbastanza oggetti, ne servono " + (qnt*5) + ".", back);
									return;
								}

								var rarity = rows[0].rarity;
								var nRarity = rarity;

								var price = 0;

								if (answer.text == "RaritÃ  Superiore") {
									if (nRarity == "C") {
										nRarity = "NC";
										price = 1000;
									} else if (nRarity == "NC") {
										nRarity = "R";
										price = 1500;
									} else if (nRarity == "R") {
										nRarity = "UR";
										price = 2000;
									} else if (nRarity == "UR") {
										nRarity = "L";
										price = 2500;
									} else if (nRarity == "L") {
										nRarity = "E";
										price = 3000;
									} else {
										bot.sendMessage(message.chat.id, "Non puoi riciclare questa raritÃ !", back);
										return;
									}
								}else{
									if ((nRarity != "C") && (nRarity != "NC") && (nRarity != "R") && (nRarity != "UR") && (nRarity != "L") && (nRarity != "E") && (nRarity != "D")){
										bot.sendMessage(message.chat.id, "Non puoi riciclare questa raritÃ !", back);
										return;
									}
								}

								price = price*qnt;

								if (money < price) {
									bot.sendMessage(message.chat.id, "Non hai abbastanza monete (" + price + " Â§)", back);
									return;
								}

								connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
								});

								setAchievement(message.chat.id, player_id, 15, qnt);

								delItem(player_id, rows[0].item_id, (5*qnt));
								var text = "Hai riciclato " + (qnt*5) + "x " + oggetto + " ed hai ottenuto:\n";

								for (var i = 0; i < qnt; i++) {
									var rows = connection_sync.query('SELECT id, name FROM item WHERE rarity = "' + nRarity + '" AND name != "' + oggetto + '" AND craftable = 0 ORDER BY RAND()');

									text += rows[0].name + " (" + nRarity + ")\n";

									addItem(player_id, rows[0].id);
								};
								bot.sendMessage(message.chat.id, text, kb2);
							});
						});
					};
				};
			});
			return;
		}

		var iKeys = [];

		bot.sendMessage(message.chat.id, "Seleziona la raritÃ  dell'oggetto da riciclare, puoi anche usare /ricicla NomeOggetto,quantitÃ ", kbR).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				var r = answer.text;

				if ((r == "Torna al menu") || (r == "Torna all'emporio")) {
					return;
				}

				if ((r != "C") && (r != "NC") && (r != "R") && (r != "UR") && (r != "L") && (r != "E") && (r != "D")) {
					bot.sendMessage(message.chat.id, "RaritÃ  non valida", back);
					return;
				}

				connection.query('SELECT item.name, inventory.quantity, item.rarity FROM inventory, item WHERE item.id = inventory.item_id AND item.rarity = "' + r + '" AND player_id = ' + player_id + ' AND inventory.quantity >= 5', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Non hai oggetti di raritÃ  " + r + " riciclabili.", back);
						return;
					}
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						iKeys.push([rows[i].name + " (" + rows[i].rarity + ", " + rows[i].quantity + ")"]);
					}

					iKeys.push(["Torna all'emporio"]);
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona gli oggetti da riciclare, consumandone 5 riceverai un oggetto della stessa raritÃ , o superiore (in questo caso ti costerÃ  C: 500, NC: 750, R: 1.000, UR: 1.500, L: 2.000 Â§, E: 5.000 Â§).", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var oggetto = answer.text;

							if ((oggetto == "Torna al menu") || (oggetto == "Torna all'emporio")) {
								return;
							}

							var pos = oggetto.indexOf("(");
							oggetto = oggetto.substr(0, pos - 1);

							bot.sendMessage(message.chat.id, "Con quale modalitÃ  vuoi riciclare " + oggetto + "?", kbC).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if ((answer.text == "Stessa RaritÃ ") || (answer.text == "RaritÃ  Superiore")) {
										connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											connection.query('SELECT item.name, inventory.quantity, item.rarity, item.id FROM inventory, item WHERE item.id = inventory.item_id AND item.rarity = "' + r + '" AND player_id = ' + player_id + ' AND inventory.quantity >= 5 AND item.name = "' + oggetto + '"', function (err, rows, fields) {
												if (err) throw err;
												if (Object.keys(rows).length == 0) {
													bot.sendMessage(message.chat.id, "Non possiedi l'oggetto specificato.", back);
													return;
												}

												var rarity = rows[0].rarity;
												var nRarity = rarity;
												var item_id = rows[0].id;

												var price = 0;

												if (answer.text == "RaritÃ  Superiore") {
													if (nRarity == "C") {
														nRarity = "NC";
														price = 1000;
													} else if (nRarity == "NC") {
														nRarity = "R";
														price = 1500;
													} else if (nRarity == "R") {
														nRarity = "UR";
														price = 2000;
													} else if (nRarity == "UR") {
														nRarity = "L";
														price = 2500;
													} else if (nRarity == "L") {
														nRarity = "E";
														price = 3000;
													} else {
														bot.sendMessage(message.chat.id, "Non puoi riciclare questa raritÃ !", back);
														return;
													}
												}else{
													if ((nRarity != "C") && (nRarity != "NC") && (nRarity != "R") && (nRarity != "UR") && (nRarity != "L") && (nRarity != "E") && (nRarity != "D")){
														bot.sendMessage(message.chat.id, "Non puoi riciclare questa raritÃ !", back);
														return;
													}
												}

												if (money < price) {
													bot.sendMessage(message.chat.id, "Non hai abbastanza monete (" + price + " Â§)", back);
													return;
												}

												connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});

												setAchievement(message.chat.id, player_id, 15, 1);

												delItem(player_id, item_id, 5);
												connection.query('SELECT id, name FROM item WHERE rarity = "' + nRarity + '" AND name != "' + oggetto + '" AND craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
													if (err) throw err;
													var itemName = rows[0].name;
													addItem(player_id, rows[0].id);
													bot.sendMessage(message.chat.id, "Hai riciclato gli oggetti e ricevuto *" + itemName + "* (" + nRarity + ")!", kb2);
												});
											});
										});
									};
								};
							});
						};
					});
				});
			};
		});
	});
});

bot.onText(/^vendi/i, function (message) {
	var oggetto = message.text.substring(message.text.indexOf(" ") + 1);

	if (oggetto.indexOf("(") != -1) {
		oggetto = oggetto.substring(0, oggetto.indexOf("(") - 1);
	}

	if (crazyMode == 1) {
		bot.sendMessage(message.chat.id, "Durante il weekend folle non puoi vendere oggetti", back);
		return;
	}

	if (message.text.toLowerCase() == "vendi") {
		return;
	}

	if (oggetto.trim() == "") {
		return;
	}

	var conf = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Conferma"], ["Torna all'emporio"]]
		}
	};
	var store = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna all'emporio"]]
		}
	};

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["1"], ["2"], ["3"], ["4"], ["5"], ["10"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, money, holiday FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if ((oggetto == "C") || (oggetto == "NC") || (oggetto == "R") || (oggetto == "UR") || (oggetto == "L") || (oggetto == "E")) {
			bot.sendMessage(message.chat.id, "Sei veramente sicuro di voler vendere tutta la raritÃ  " + oggetto + " alla metÃ  del valore?\nIl coupon non funziona in questa modalitÃ  di vendita", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('SELECT ROUND(SUM(item.value/2*inventory.quantity)) As total FROM inventory, item WHERE inventory.item_id = item.id AND item.rarity = "' + oggetto + '" AND player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Non hai oggetti da vendere!", store);
								return;
							}

							var total = rows[0].total;

							if (crazyMode == 1) {
								total = total + (total * 10 / 100);
							}

							if (total == null) {
								bot.sendMessage(message.chat.id, "Non hai oggetti da vendere!", store);
								return;
							}

							bot.sendMessage(message.chat.id, "Prezzo calcolato: " + formatNumber(total) + " Â§, continuare?", yesno).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text.toLowerCase() == "si") {
										connection.query('SELECT ROUND(SUM(item.value/2*inventory.quantity)) As total FROM inventory, item WHERE inventory.item_id = item.id AND item.rarity = "' + oggetto + '" AND player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
											if (err) throw err;
											if (Object.keys(rows).length == 0) {
												bot.sendMessage(message.chat.id, "Non hai oggetti di questa raritÃ  da vendere!", store);
												return;
											}

											total = parseInt(rows[0].total);

											if (crazyMode == 1) {
												total = total * 3;
											}

											total = Math.round(total);

											if ((total == null) || (total == 0)) {
												bot.sendMessage(message.chat.id, "Non hai oggetti da vendere!", store);
												return;
											}

											connection.query('UPDATE inventory, item SET inventory.quantity = 0 WHERE inventory.item_id = item.id AND rarity = "' + oggetto + '" AND player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												connection.query('UPDATE player SET money = money + ' + total + ' WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Hai venduto tutta la raritÃ  *" + oggetto + "* per *" + formatNumber(total) + "* Â§!", store);
												});
											});
										});
									}
								}
							});
						});
					}
				}
			});
			return;
		}

		connection.query('SELECT item.id, quantity FROM item, inventory WHERE inventory.item_id = item.id AND item.name = "' + oggetto + '" AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Oggetto non valido.", store);
				return;
			}

			var item_id = rows[0].id;

			bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di " + oggetto + " da vendere, ne possiedi " + formatNumber(rows[0].quantity), kb).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					var quantity = parseInt(answer.text);
					if ((quantity <= 0) || (isNaN(quantity)) || (re.test(quantity) == false)) {
						bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
						return;
					}
					connection.query('SELECT id, holiday, money, account_id, mission_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						var banReason = isBanned(rows[0].account_id);
						if (banReason != null) {
							var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
							bot.sendMessage(message.chat.id, text, mark);
							return;
						}
						if (rows[0].holiday == 1) {
							bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
							return;
						}

						var player_id = rows[0].id;
						var money = parseInt(rows[0].money);

						connection.query('SELECT item.name, item.value, inventory.quantity FROM item, inventory WHERE inventory.item_id = item.id AND item.id = ' + item_id + ' AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Non possiedi l'oggetto selezionato", store);
								return;
							}
							if (rows[0].quantity < quantity) {
								bot.sendMessage(message.chat.id, "Non hai abbastanza oggetti", store);
								return;
							}

							var itemName = rows[0].name;
							var singleValue = Math.round(parseInt(rows[0].value) / 2);
							var value = singleValue * quantity;

							if (crazyMode == 1)
								value = value + (value * 10 / 100);

							var bonus = ""
							if (getItemCnt(player_id, 677) > 0) {
								value = value + Math.round(value / 3);
								bonus = ", aumentati grazie al Coupon";
								var rand = Math.random() * 100;
								if (rand < 20) {
									bonus += " (Scaduto)";
									delItem(player_id, 677, 1);
								}
							}

							setAchievement(message.chat.id, player_id, 7, value);

							var newmoney = money + value;

							connection.query('UPDATE player SET money = ' + newmoney + ' WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;

								var d = new Date();
								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
								for (var i = 0; i < quantity; i++) {
									connection.query('INSERT INTO market_direct_history(item_id, price, time, from_id, type) VALUES (' + item_id + ',' + singleValue + ',"' + long_date + '",' + player_id + ',3)', function (err, rows, fields) {
										if (err) throw err;
									});
								};

								delItem(player_id, item_id, quantity);
								bot.sendMessage(message.chat.id, "Hai venduto " + quantity + "x " + itemName + " per " + formatNumber(value) + " Â§" + bonus, store);
							});
						});
					});
				};
			});
		});
	});
});

bot.onText(/compra/i, function (message) {

	if (crazyMode == 1) {
		bot.sendMessage(message.chat.id, "Non puoi acquistare durante il weekend folle", back);
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var money = rows[0].money;
		var player_id = rows[0].id;

		var oggetto = message.text.substring(message.text.indexOf(" ") + 1);
		var price_drop = 0;
		var n = new Date().getDay()
		var n2 = new Date().getDate();

		if (n == 0) {
			if (n2 <= 7) {
				sconto = 20;
			}
			price_drop = 1;
		}
		if (sconto_evento > 0) {
			sconto = sconto_evento;
			price_drop = 1;
		}

		if ((oggetto == "") || (oggetto == " ")) {
			return;
		}

		var store = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna all'emporio"], ["Torna al menu"]]
			}
		};

		var storeYesNo = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Si", "Torna all'emporio"], ["Torna al menu"]]
			}
		};

		var chest = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Vai agli scrigni", "Torna all'emporio"], ["Torna al menu"]]
			}
		};

		var pos = oggetto.indexOf("(");
		if (pos != -1) {
			oggetto = oggetto.substr(0, pos - 1);
		}

		connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 7', function (err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0) {
				abBonus = rows[0].ability_level * rows[0].val;

				var rand = Math.random() * 100;
				if (rand < abBonus) {
					abBonus = 1;
				}
			}

			if (oggetto.indexOf("Scrigno") != -1) {
				connection.query('SELECT value, id FROM chest WHERE `name`="' + oggetto + '" AND id < 7', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Scrigno non valido.", store);
						return;
					}
					var chest_id = rows[0].id;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["1"], ["2"], ["3"], ["4"], ["5"], ["10"], ["Torna all'emporio"], ["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di scrigni da acquistare", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var quantity = answer.text;
							if ((quantity == "Torna al menu") || (quantity == "Torna all'emporio")) {
								return;
							}
							if ((quantity < 1) || (re.test(quantity) == false)) {
								bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
								return;
							}

							var price = rows[0].value;

							if (price_drop == 1) {
								price -= Math.round((rows[0].value / 100) * sconto);
							}

							quantity = Math.floor(quantity);
							price = price * parseInt(quantity);

							connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;

								if (rows[0].money - price < 0) {
									bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
									return;
								}

								var bonus_text = "";
								if (abBonus == 1) {
									price = Math.round(price / 2);
									bonus_text = " grazie al tuo talento!";
								}

								setAchievement(message.chat.id, player_id, 14, quantity, chest_id);

								connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									addChest(player_id, chest_id, quantity);
									bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + formatNumber(price) + " Â§" + bonus_text, chest);
								});
							});
						};
					});
				});
			} else if (oggetto.indexOf("Pozione") != -1) {
				if (crazyMode == 1) {
					bot.sendMessage(message.chat.id, "Non puoi acquistare pozioni durante il weekend folle", back);
					return;
				}
				connection.query('SELECT id FROM item WHERE name = "' + oggetto + '"', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Pozione non valida.", store);
						return;
					}
					var potion_id = rows[0].id;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["1"], ["2"], ["3"], ["4"], ["5"], ["10"], ["Torna all'emporio"], ["Torna al menu"]]
						}
					};


					bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di pozioni da acquistare", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var quantity = answer.text;
							if ((quantity == "Torna al menu") || (quantity == "Torna all'emporio")) {
								return;
							}
							if ((quantity < 1) || (re.test(quantity) == false)) {
								bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
								return;
							}

							quantity = parseInt(quantity);
							quantity = Math.floor(quantity);

							var value = 0;
							if (potion_id == "92") {
								value = 1200;
							} else if (potion_id == "93") {
								value = 2400;
							} else if (potion_id == "94") {
								value = 4800;
							} else {
								bot.sendMessage(message.chat.id, "Errore sconosciuto", store);
								return;
							}

							var price = parseInt(value);

							if (price_drop == 1) {
								price -= Math.round(value / 100) * sconto;
							}

							price = price * quantity;
							connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;

								if (rows[0].money - price < 0) {
									bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
									return;
								}

								var bonus_text = "";
								if (abBonus == 1) {
									price = Math.round(price / 2);
									bonus_text = " grazie al tuo talento!";
								}

								connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									addItem(player_id, potion_id, quantity);
									bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
								});
							});
						};
					});
				});
			} else if (oggetto.toLowerCase().indexOf("bevanda energetica") != -1) {
				bot.sendMessage(message.chat.id, "Acquistare? La bevanda verrÃ  attivata immediatamente! Attento, se hai una bevanda (di qualsiasi tipo) giÃ  attiva, l'acquisto della nuova la rimpiazzerÃ .", yesno).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text.toLowerCase() == "si") {
							var price = 20000;
							var missions = 3;

							if (oggetto.toLowerCase().indexOf("plus") != -1) {
								price = 38000;
								missions = 6;
							}

							if (price_drop == 1) {
								price -= Math.round((price / 100) * sconto);
							}

							connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;

								if (rows[0].money - price < 0) {
									bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
									return;
								}

								var bonus_text = "";
								if (abBonus == 1) {
									price = Math.round(price / 2);
									bonus_text = " grazie al tuo talento!";
								}

								setAchievement(message.chat.id, player_id, 16, 1);

								connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									connection.query('UPDATE `player` SET `boost_id`=1, boost_mission = ' + missions + ' WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
									});
								});
							});
						}
					};
				});
			} else if ((oggetto.toLowerCase().indexOf("piuma di fenice") != -1) || (oggetto.toLowerCase().indexOf("cenere di fenice") != -1)) {
				if (crazyMode == 1) {
					bot.sendMessage(message.chat.id, "Non puoi acquistare piume o cenere durante il weekend folle", back);
					return;
				}
				connection.query('SELECT id, name FROM item WHERE `name`="' + oggetto + '"', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0) {
						bot.sendMessage(message.chat.id, "Oggetto non valido.", store);
						return;
					}
					var item_id = rows[0].id;

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["1"], ["2"], ["3"], ["4"], ["5"], ["10"], ["Torna all'emporio"], ["Torna al menu"]]
						}
					};

					var name = rows[0].name;
					bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di " + name + " da acquistare", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var quantity = answer.text;
							if ((quantity == "Torna al menu") || (quantity == "Torna all'emporio")) {
								return;
							}
							if ((quantity < 1) || (re.test(quantity) == false)) {
								bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
								return;
							}

							quantity = parseInt(quantity);
							quantity = Math.floor(quantity);

							var value = 0;
							if (name == "Piuma di Fenice") {
								value = 6000;
							} else if (name == "Cenere di Fenice") {
								value = 25000;
							}
							var price = parseInt(value);

							if (price_drop == 1) {
								price -= Math.round(value / 100) * sconto;
							}

							price = price * quantity;

							connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;

								if (rows[0].money - price < 0) {
									bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
									return;
								}

								var bonus_text = "";
								if (abBonus == 1) {
									price = Math.round(price / 2);
									bonus_text = " grazie al tuo talento!";
								}

								setAchievement(message.chat.id, player_id, 17, quantity);

								connection.query('UPDATE player SET money = money-' + price + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									addItem(player_id, item_id, quantity);
									bot.sendMessage(message.chat.id, "Acquisto di " + quantity + "x " + name + " completato con successo! Hai speso " + formatNumber(price) + " Â§" + bonus_text, store);
								});
							});
						};
					});
				});
			} else if (oggetto.indexOf("Gemma") != -1) {
				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["1"], ["2"], ["3"], ["4"], ["5"], ["10"], ["Torna all'emporio"], ["Torna al menu"]]
					}
				};

				if (player_id != 1) {
					var d = new Date();
					if (d.getDay != 3) {
						if ((d.getHours < 9) || (d.getHours > 12)) {
							bot.sendMessage(message.chat.id, "Le ðŸ’Ž possono essere acquistate solamente il mercoledÃ¬ mattina (9-12)", store);
							return;
						}
					}
				}

				bot.sendMessage(message.chat.id, "Seleziona la quantitÃ  di ðŸ’Ž da acquistare", kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						var quantity = answer.text;
						if ((quantity == "Torna al menu") || (quantity == "Torna all'emporio")) {
							return;
						}
						if ((quantity < 1) || (re.test(quantity) == false)) {
							bot.sendMessage(message.chat.id, "QuantitÃ  non valida", store);
							return;
						}

						quantity = parseInt(quantity);
						quantity = Math.floor(quantity);

						bot.sendMessage(message.chat.id, "Sei sicuro di voler acquistare " + quantity + " ðŸ’Ž?", storeYesNo).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase() == "si"){
									var value = 300000;
									var price = parseInt(value);

									if (price_drop == 1) {
										//	price -= Math.round(value/100)*sconto;
									}

									price = price * quantity;

									connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										if (rows[0].money - price < 0) {
											bot.sendMessage(message.chat.id, "Non hai abbastanza credito a disposizione.", store);
											return;
										}

										var bonus_text = "";
										if (abBonus == 1) {
											price = Math.round(price / 2);
											bonus_text = " grazie al tuo talento!";
										}

										connection.query('UPDATE player SET money = money-' + price + ', gems = gems + ' + quantity + ' WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(message.chat.id, "Acquisto completato con successo! Hai speso " + price + " Â§" + bonus_text, store);
										});
									});
								}
							}
						});
					};
				});
			}
		});
	});
});

bot.onText(/^Artefatti|Torna agli artefatti/i, function (message) {
	var artifacts = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Artefatto Fiammeggiante"], ["Artefatto Elettrico"], ["Artefatto Tempesta"], ["Artefatto Buio"], ["Artefatto Divinatorio"], ["Torna al menu"]]
		}
	};

	var get = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Ottieni Artefatto"], ["Torna agli artefatti"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;

		if (rows[0].reborn < 4) {
			bot.sendMessage(message.chat.id, "Per accedere agli artefatti devi aver raggiunto almeno la Rinascita 3", back);
			return;
		}

		connection.query('SELECT COUNT(id) As cnt FROM artifacts WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (rows[0].cnt == 5) {
				bot.sendMessage(message.chat.id, "Hai ottenuto tutti gli Artefatti!", back);
				return;
			}

			bot.sendMessage(message.chat.id, "Gli Artefatti ðŸ”± sono degli strumenti di *incredibile potenza*, che una volta uniti insieme possono fornire una forza sovraumana.\n" +
							"Tuttavia per ottenerli Ã¨ necessario completare diverse *'prove'* riservate solo ai migliori combattenti.\n" +
							"A quale artefatto vuoi aspirare?", artifacts).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text == "Artefatto Fiammeggiante") {
						bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi raggiungere 85 punti dungeon e possedere 5.000.000 Â§, questi ultimi ti verranno sottratti per completare il rituale.", get).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text == "Ottieni Artefatto") {
									connection.query('SELECT id FROM artifacts WHERE item_id = 614 AND player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length > 0) {
											bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
											return;
										}

										connection.query('SELECT * FROM player WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											var money = rows[0].money;
											var rank = rows[0].rank;

											if (money < 5000000) {
												bot.sendMessage(message.chat.id, "Non hai abbastanza monete (" + formatNumber(money) + "/5.000.000)", back);
												return;
											}

											if (rank < 85) {
												bot.sendMessage(message.chat.id, "Non hai abbastanza punti rango (" + rank + "/85)", back);
												return;
											}

											connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',614)', function (err, rows, fields) {
												if (err) throw err;
												connection.query('UPDATE player SET money = money - ' + 5000000 + ' WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													addItem(player_id, 614);
													bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Fiammeggiante*!", back);
												});
											});
										});
									});
								}
							}
						});
					} else if (answer.text == "Artefatto Elettrico") {
						connection.query('SELECT id FROM artifacts WHERE item_id = 614 AND player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Fiammeggiante*!", back);
								return;
							}

							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi raggiungere 10.000 punti creazione, il drago al livello 100 e possedere 10.000.000 Â§, questi ultimi ti verranno sottratti per completare il rituale.", get).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Ottieni Artefatto") {
										connection.query('SELECT id FROM artifacts WHERE item_id = 615 AND player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length > 0) {
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('SELECT level FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;

												if ((Object.keys(rows).length > 0) && (rows[0].level < 100)) {
													bot.sendMessage(message.chat.id, "Il tuo drago non Ã¨ ad un livello abbastanza alto", back);
													return;
												}

												connection.query('SELECT * FROM player WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													var money = rows[0].money;
													var craft_count = rows[0].craft_count;

													if (money < 10000000) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza monete (" + formatNumber(money) + "/10.000.000)", back);
														return;
													}

													if (craft_count < 10000) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza punti creazione (" + craft_count + "/10.000)", back);
														return;
													}

													connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',615)', function (err, rows, fields) {
														if (err) throw err;
														connection.query('UPDATE player SET money = money - ' + 10000000 + ' WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															addItem(player_id, 615);
															bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Elettrico*!", back);
														});
													});
												});
											});
										});
									}
								}
							});
						});
					} else if (answer.text == "Artefatto Tempesta") {
						connection.query('SELECT id FROM artifacts WHERE item_id = 615 AND player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Elettrico*!", back);
								return;
							}
							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi portare al livello 10 almeno 5 Talenti, possedere 20 ðŸ’Ž (verranno consumate) e raggiungere le 200 Imprese giornaliere completate.", get).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Ottieni Artefatto") {
										connection.query('SELECT id FROM artifacts WHERE item_id = 644 AND player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length > 0) {
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('SELECT COUNT(id) As num FROM ability WHERE player_id = ' + player_id + ' AND ability_level = 10', function (err, rows, fields) {
												if (err) throw err;

												if (rows[0].num < 5) {
													bot.sendMessage(message.chat.id, "I Talenti non sono ancora ad un livello sufficiente", back);
													return;
												}

												connection.query('SELECT * FROM player WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													if (rows[0].achievement_count < 200) {
														bot.sendMessage(message.chat.id, "Non hai completato abbastanza imprese giornaliere (" + rows[0].achievement_count + "/200)", back);
														return;
													}

													if (rows[0].gems < 20) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž (" + rows[0].gems + "/20)", back);
														return;
													}

													connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',644)', function (err, rows, fields) {
														if (err) throw err;
														connection.query('UPDATE player SET gems = gems - ' + 20 + ' WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															addItem(player_id, 644);
															bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Tempesta*!", back);
														});
													});
												});
											});
										});
									}
								}
							});
						});
					} else if (answer.text == "Artefatto Buio") {
						connection.query('SELECT id FROM artifacts WHERE item_id = 644 AND player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Tempesta*!", back);
								return;
							}
							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi aver completato 2000 missioni, vinto 500 ispezioni (effettuate o respinte), e ottenuto 2000 Polvere (S).", get).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Ottieni Artefatto") {
										connection.query('SELECT id FROM artifacts WHERE item_id = 648 AND player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length > 0) {
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('SELECT mission_count FROM player WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;

												if (rows[0].mission_count < 2000) {
													bot.sendMessage(message.chat.id, "Non hai completato abbastanza missioni (" + rows[0].mission_count + "/2000)", back);
													return;
												}

												connection.query('SELECT from_id, COUNT(from_id) As cnt FROM heist_history WHERE from_id = ' + player_id + ' AND fail = 0', function (err, rows, fields) {
													if (err) throw err;

													var cnt = 0;
													cnt = parseInt(rows[0].cnt);

													connection.query('SELECT to_id, COUNT(to_id) As cnt FROM heist_history WHERE to_id = ' + player_id + ' AND fail > 0', function (err, rows, fields) {
														if (err) throw err;

														cnt = cnt + parseInt(rows[0].cnt);
														if (cnt < 500) {
															bot.sendMessage(message.chat.id, "Non hai vinto abbastanza ispezioni (" + cnt + "/500)", back);
															return;
														}

														if (getItemCnt(player_id, 646) < 2000) {
															bot.sendMessage(message.chat.id, "Non hai raccolto abbastanza polvere (" + rows[0].qnt + "/2000)", back);
															return;
														}

														connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',648)', function (err, rows, fields) {
															if (err) throw err;
															delItem(player_id, 646, 2000);
															addItem(player_id, 648);
															bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Buio*!", back);
														});
													});
												});
											});
										});
									}
								}
							});
						});
					} else if (answer.text == "Artefatto Divinatorio") {
						connection.query('SELECT id FROM artifacts WHERE item_id = 648 AND player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Devi prima ottenere l'*Artefatto Buio*!", back);
								return;
							}

							bot.sendMessage(message.chat.id, "Per ottenere questo artefatto devi:\n" +
											"> Raggiungere il livello 1000 R4\n" +
											"> Aver raggiunto rango 350 _OPPURE_ rango 200 e 150 incarichi completati\n" +
											"> Aver completato 20 scalate complete nello stesso team (una volta raggiunte non vengono piÃ¹ resettate)\n" +
											"> Aver venduto almeno 500 oggetti al Contrabbandiere\n" +
											"> Aver partecipato attivamente ad almeno 5 imprese globali\n\n" +
											"L'ottenimento di questo artefatto porterÃ  notevoli benefici!", get).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Ottieni Artefatto") {
										connection.query('SELECT id FROM artifacts WHERE item_id = 675 AND player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											if (Object.keys(rows).length > 0) {
												bot.sendMessage(message.chat.id, "Hai giÃ  ottenuto questo artefatto!", back);
												return;
											}

											connection.query('SELECT exp, rank, kill_streak_ok, global_event, mission_team_count FROM player WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;

												if (Math.floor(rows[0].exp / 10) < 1000) {
													bot.sendMessage(message.chat.id, "Non hai raggiunto il livello necessario (" + Math.floor(rows[0].exp / 10) + "/1000)", back);
													return;
												}

												var err = 1;
												if ((rows[0].rank >= 200) && (rows[0].mission_team_count >= 150))
													err = 0;

												if ((err == 1) && (rows[0].rank >= 350))
													err = 0;

												if (err == 1){
													bot.sendMessage(message.chat.id, "Non hai raggiunto il rango necessario (" + rows[0].rank + "/200-350) e/o gli incarichi necessari (" + rows[0].mission_team_count + "/150)", back);
													return;
												}

												if (rows[0].kill_streak_ok == 0) {
													bot.sendMessage(message.chat.id, "Non hai completato almeno 20 scalate nello stesso team", back);
													return;
												}

												if (rows[0].global_event < 5) {
													bot.sendMessage(message.chat.id, "Non hai aiutato a completare abbastanza imprese globali (" + rows[0].global_event + "/5)", back);
													return;
												}

												connection.query('SELECT total_cnt FROM merchant_offer WHERE player_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													if (rows[0].total_cnt < 500) {
														bot.sendMessage(message.chat.id, "Non hai completato raggiunto le offerte contrabbandiere necessarie (" + rows[0].total_cnt + "/500)", back);
														return;
													}

													connection.query('INSERT INTO artifacts (player_id, item_id) VALUES (' + player_id + ',675)', function (err, rows, fields) {
														if (err) throw err;
														addItem(player_id, 675);
														bot.sendMessage(message.chat.id, "Hai ottenuto l'*Artefatto Divinatorio*!\n\nHai ottenuto tutti gli Artefatti!", back);
														console.log(message.from.username + " Artefatto 5")
													});
												});
											});
										});
									}
								}
							});
						});
					}
				}
			});
		});
	});
});

bot.onText(/^Biblioteca|Torna alla biblioteca/i, function (message) {
	connection.query('SELECT id, lore_mission, exp, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var lore_mission = rows[0].lore_mission;
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;

		var textArr = ["Ottobre, quieta folata.", "Novembre, brezza vivace.", "Dicembre, fredda bonaccia.", "Gennaio, vento propizio.", "Nelle sale che vi si formano si intravedono macabri tavoli pieni.", "In Biblioteca, erra per file sempiterne.", "DÃ©jÃ  vu.", "Indaga oltre.", "Un folle analfabeta si sente deloooso.", "La Biblioteca Ã¨ contraria al 'liud' draconico.", "Un'oculata ricerca sul colore blu presenta una copertina di colore rosso.", "A Un Nuovo Inizio sorge in albore.", "La Sala Holden Ã¨ gremita di scrittori.", "Ottobre Ã¨ trino."];

		var rand = Math.round(Math.random() * (Object.keys(textArr).length - 1));

		connection.query('SELECT name, type FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var dragon_name = "";
			if (Object.keys(rows).length > 0) {
				dragon_name = rows[0].name + " " + rows[0].type;
			}

			connection.query('SELECT id, title FROM library ORDER BY view_order ASC', function (err, rows, fields) {
				if (err) throw err;

				var iKeys = [];
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if ((lore_mission < 3) && ((rows[i].id == 4) || (rows[i].id == 5) || (rows[i].id == 19))) {
						continue;
					}
					if ((lore_mission < 2) && ((rows[i].id == 15) || (rows[i].id == 16) || (rows[i].id == 17))) {
						continue;
					}
					if ((lore_mission >= 2) && (rows[i].id == 18)) {
						continue;
					}
					if (rows[i].id == 7) // enciclopedia delle armi r
						continue;
					iKeys.push([rows[i].title]);
				}

				iKeys.push(["Torna al menu"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				var kbBack = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Torna alla Biblioteca"], ["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, textArr[rand], kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text == "Torna al menu") {
							return;
						}
						connection.query('SELECT id, title, text, alt_text FROM library WHERE title = "' + answer.text + '"', function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length > 0) {
								var text = "";
								var alt = 0;

								if ((rows[0].id == 18) && (lore_mission < 2)) {
									alt = 1;
								}

								if ((rows[0].id == 3) && (lore_mission < 3)) {
									alt = 1;
								}
								if ((rows[0].id == 19) && (lore_mission < 4)) {
									alt = 1;
								}

								if ((rows[0].id == 12) && ((exp < 100) && (reborn == 1))) {
									alt = 1;
								}

								if ((lore_mission < 3) && ((rows[0].id == 4) || (rows[0].id == 5))) {
									bot.sendMessage(message.chat.id, "Non consultabile", kbBack);
									return;
								}
								if ((lore_mission < 2) && ((rows[0].id == 15) || (rows[0].id == 16) || (rows[0].id == 17))) {
									bot.sendMessage(message.chat.id, "Non consultabile", kbBack);
									return;
								}
								if ((lore_mission >= 2) && (rows[0].id == 18)) {
									bot.sendMessage(message.chat.id, "Non consultabile", kbBack);
									return;
								}


								if (rows[0].text == null) {
									alt = 1;
								}
								if (alt == 1) {
									text = rows[0].alt_text;
									title += " (Bloccata)";
								} else {
									text = rows[0].text;
								}

								text = text.replace(new RegExp("%player%", "g"), message.from.username);
								text = text.replace(new RegExp("%dragon%", "g"), dragon_name);

								var title = rows[0].title;

								if (Object.keys(text).length > 4000) {
									var text1 = "";
									var text2 = "";
									text1 = text.substr(0, 4000);
									text2 = text.substr(4000, 8000);

									bot.sendMessage(message.chat.id, "<b>" + title + "</b>\n\n" + text1, html);
									setTimeout(function () {
										bot.sendMessage(message.chat.id, text2, kbBack);
									}, 500);
								} else {
									bot.sendMessage(message.chat.id, "<b>" + title + "</b>\n\n" + text, kbBack);
								}
							}
						});
					};
				});
			});
		});
	});
});

bot.onText(/^Edificio/i, function (message) {
	connection.query('SELECT id, lore_page FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var next = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Indaga oltre"], ["Torna al menu"]]
			}
		};

		var prev = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["DÃ©jÃ  vu"], ["Torna al menu"]]
			}
		};

		var house = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Edificio"], ["Torna al menu"]]
			}
		};


		var page = rows[0].lore_page;
		var player_id = rows[0].id;

		if (page == 0) {
			bot.sendMessage(message.chat.id, "Vi Ã¨, in lontananza, un edificio che non avevi mai scorto prima di adesso; una strana forza magica ti attrae verso quel posto. Ti ci dirigi, per scoprire i segreti celati dietro a tale edificio.\n" +
							"Esso Ã¨ fatto da Assi di Legno Lavorato, disposte in modo asimmetrico, e dai buchi che vi si formano si intravedono macabri tavoli vuoti. La porta Ã¨ barricata con altre Assi di Legno, e di fronte a essa vi Ã¨ affisso un cartello; la scritta, perÃ², Ã¨ completamente erosa dal tempo, e vi si legge una sola parola: Lore.\n" +
							"L'insieme di questi aspetti ti fa pienamente comprendere che quest'edificio sia abbandonato da molti anni, e nonostante il tuo istinto d'avventuriero ti dica che il suddetto posto celi dei macabri misteri, decidi di non indagare oltre.", next).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text == "Indaga oltre") {
						connection.query('UPDATE player SET lore_page = 1 WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "...", house);
						});
					}
				}
			});
		} else { //Importante che l'ultima sia else e non abbia update
			bot.sendMessage(message.chat.id, "Un sol monito, pregno di ignoto, ne sovrasta la fragile entrata:\n\n'In missione, erra per effimeri sempiterni'.", prev).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text == "DÃ©jÃ  vu") {
						connection.query('UPDATE player SET lore_page = 0 WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "...", house);
						});
					}
				};
			});
		}

	});
});

bot.onText(/^Albero Talenti$|Albero/i, function (message) {

	var next = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Albero Talenti"], ["Torna al menu"]]
		}
	};

	var prev = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna all'Albero"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var my_money = rows[0].money;
		var my_gems = rows[0].gems;
		var iKeys = [];

		if ((Math.floor(rows[0].exp / 10) < 50) && (rows[0].reborn == 1)) {
			bot.sendMessage(message.chat.id, "Devi aver raggiunto almeno il livello 50 per accedere a questa funzionalitÃ ", back);
			return;
		}

		connection.query('SELECT ability.ability_id, ability.ability_level, ability_list.name, ability_list.val, ability_list.det FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' ORDER BY ability_list.name', function (err, rows, fields) {
			if (err) throw err;

			var ablist = "";
			var abarr = [];
			var abname = [];

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				if ((rows[i].ability_id == 20) || (rows[i].ability_id == 17)){
					if (rows[i].ability_level == 10) {
						ablist += "> *" + rows[i].name + "* (Liv " + rows[i].ability_level + ", " + toTime(rows[i].ability_level * rows[i].val * 60, 0) + ")\n";
					} else {
						ablist += "> " + rows[i].name + " (Liv " + rows[i].ability_level + ", " + toTime(rows[i].ability_level * rows[i].val * 60, 0) + ")\n";
					}
				}else{
					if (rows[i].ability_level == 10) {
						ablist += "> *" + rows[i].name + "* (Liv " + rows[i].ability_level + ", " + (rows[i].ability_level * rows[i].val) + rows[i].det + ")\n";
					} else {
						ablist += "> " + rows[i].name + " (Liv " + rows[i].ability_level + ", " + (rows[i].ability_level * rows[i].val) + rows[i].det + ")\n";
					}
				}
				abarr[rows[i].ability_id] = rows[i].ability_level;
			}

			connection.query('SELECT name, id FROM ability_list ORDER BY name', function (err, rows, fields) {
				if (err) throw err;

				var tot = 0;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					iKeys.push([rows[i].name]);
					abname[rows[i].id] = rows[i].name;
					tot++;
				}
				iKeys.push(["Torna al menu"]);

				var ability_list = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				connection.query("SELECT SUM(ability_level) As cnt FROM ability WHERE player_id = " + player_id, function (err, rows, fields) {
					if (err) throw err;

					if (rows[0].cnt == (tot * 10)) {
						setAchievement(message.chat.id, player_id, 18, 999);
					}

					bot.sendMessage(message.chat.id, "Seleziona il Talento da apprendere o potenziare\n" + ablist, ability_list).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text == "Torna al menu") {
								return;
							}
							connection.query('SELECT * FROM ability_list WHERE name = "' + answer.text + '"', function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0) {
									bot.sendMessage(message.chat.id, "Talento non valido", prev);
									return;
								}

								var ability_id = rows[0].id;
								var ability_desc = rows[0].description;
								var ability_prev = rows[0].prev;
								var ability_name = rows[0].name;
								var val = rows[0].val;
								var sym = rows[0].det;

								if (ability_prev != 0) {
									if (abarr[ability_prev] == undefined) {
										bot.sendMessage(message.chat.id, "Questo Talento richiede prima il potenziamento di: " + abname[ability_prev], prev);
										return;
									} else {
										if (abarr[ability_prev] < 10) {
											bot.sendMessage(message.chat.id, "Questo Talento richiede prima il potenziamento al livello massimo di: " + abname[ability_prev], prev);
											return;
										}
									}
								}

								connection.query('SELECT ability_level FROM ability WHERE player_id = ' + player_id + ' AND ability_id = ' + ability_id, function (err, rows, fields) {
									if (err) throw err;

									var text = "Caratteristiche Talento " + ability_name + ":\n" + ability_desc;
									var text2 = "";
									var text3 = "\n\nFornisce: ";
									var text4 = "\nLivello massimo: 10";
									var money = 0;
									var itemid = 0;
									var itemqnt = 0;
									var gems = 0;
									var learn = "apprendere questo talento";
									var level = 0;
									var maxlev = 10;
									var forlevel = "per livello";

									if (Object.keys(rows).length > 0) {
										level = parseInt(rows[0].ability_level);
										learn = "potenziare questo talento al livello " + (level + 1);
									}

									if (ability_id == 1) { // 1% ogni livello
										text3 += val + sym + " " + forlevel;
										if (level == 0) {
											money = 300000;
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Scheggia di Hatrurite";
											itemid = 91;
										} else if (level == 1) {
											money = 400000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Scheggia di Palladio";
											itemid = 151;
										} else if (level >= 2) {
											money = 500000;
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Componente Ultra Cristallo";
											itemid = 562;
										}
									} else if (ability_id == 2) { // 100 monete ogni livello
										text3 += val + sym + " " + forlevel;
										if (level < 10) {
											money = 5000 * (level + 1);
											itemqnt = (level + 1);
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Ala della Fenice";
											itemid = 345;
										}
									} else if (ability_id == 3) { // -30 secondi ogni livello
										text3 += val + sym + " " + forlevel;
										if (level < 10) {
											money = 50000 * (level + 1);
											itemqnt = (level * 2);
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Lama Maledetta";
											itemid = 104;
										}
									} else if (ability_id == 4) { // +2% riuscita ispezione
										text3 += val + sym + " " + forlevel;
										if (level < 5) {
											money = 50000 * (level + 1);
											itemqnt = (level * 2);
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Sfera Tempesta";
											itemid = 296;
										} else if (level < 10) {
											money = 25000 * (level + 1);
											itemqnt = (level * 2);
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Spirito di Palladio";
											itemid = 357;
										}
									} else if (ability_id == 5) {
										text3 += val + sym + " " + forlevel;
										if (level < 5) {
											money = 10000 * (level + 1);
											itemqnt = level;
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Frammento Divino";
											itemid = 190;
										} else if (level < 10) {
											money = 10000 * (level + 1);
											itemqnt = level;
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Nucleo Supernova";
											itemid = 565;
										}
									} else if (ability_id == 6) {
										text3 += "+1 utilizzo ogni 2 livelli, " + val + sym + " salute recuperata quando si torna in vita " + forlevel;
										if (level < 2) {
											money = 25000 * (level + 1);
											itemqnt = 300;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Polvere";
											itemid = 646;
										} else if (level < 4) {
											money = 50000 * (level + 1);
											itemqnt = 30;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Oro Bianco";
											itemid = 276;
										} else if (level < 5) {
											money = 50000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Urlo di Morte";
											itemid = 532;
										} else if (level < 6) {
											money = 50000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Respiro di Morte";
											itemid = 201;
										} else if (level < 7) {
											money = 75000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Soffio di Morte";
											itemid = 598;
										} else if (level < 8) {
											money = 50000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Necronucleo";
											itemid = 200;
										} else if (level < 9) {
											money = 100000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Concentrato Ultraterreno Vulcano";
											itemid = 636;
										} else if (level < 10) {
											money = 100000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Concentrato Ultraterreno Tsunami";
											itemid = 637;
										}
									} else if (ability_id == 7) {
										text3 += val + sym + " " + forlevel;
										if (level < 1) {
											money = 50000 * (level + 1);
											itemqnt = 50;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Cuscino";
											itemid = 10;
										} else if (level < 2) {
											money = 50000 * (level + 1);
											itemqnt = 40;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Molla";
											itemid = 11;
										} else if (level < 3) {
											money = 50000 * (level + 1);
											itemqnt = 30;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Metallo";
											itemid = 23;
										} else if (level < 4) {
											money = 50000 * (level + 1);
											itemqnt = 30;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Carta";
											itemid = 1;
										} else if (level < 6) {
											money = 50000 * (level + 1);
											itemqnt = 30;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Cordino Fragile";
											itemid = 5;
										} else if (level < 8) {
											money = 50000 * (level + 1);
											itemqnt = 25;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Diamante";
											itemid = 9;
										} else if (level < 10) {
											money = 50000 * (level + 1);
											itemqnt = 25;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Pietra del Sangue";
											itemid = 20;
										}
									} else if (ability_id == 8) {
										text3 += val + sym + " " + forlevel;
										if (level < 1) {
											money = 50000 * (level + 1);
											itemqnt = 3;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Rubino del Dio Vulcano";
											itemid = 451;
										} else if (level < 2) {
											money = 50000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Pendolo";
											itemid = 403;
										} else if (level < 4) {
											money = 50000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Spirito del Fato";
											itemid = 288;
										} else if (level < 5) {
											money = 50000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Struttura della Piramide Meteorite";
											itemid = 427;
										} else if (level < 6) {
											money = 60000 * (level + 1);
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Frammento di Osmio";
											itemid = 663;
										} else if (level < 7) {
											money = 60000 * (level + 1);
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Zaffiro del Dio Eolo";
											itemid = 450;
										} else if (level < 8) {
											money = 60000 * (level + 1);
											itemqnt = 20;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Smeraldo della Dea Gea";
											itemid = 452;
										} else if (level < 9) {
											money = 70000 * (level + 1);
											itemqnt = 20;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Mithril";
											itemid = 311;
										} else if (level < 10) {
											money = 90000 * (level + 1);
											itemqnt = 40;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Laccio Antico";
											itemid = 406;
										}
									} else if (ability_id == 9) {
										text3 += val + sym + " " + forlevel;
										if (level < 5) {
											money = 15000 * (level + 1);
											itemqnt = (level + 1);
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Propulsore X";
											itemid = 202;
										} else if (level < 10) {
											money = 15000 * (level + 1);
											itemqnt = (level + 1) - 5;
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Generatore del Vuoto";
											itemid = 321;
										}
									} else if (ability_id == 10) {
										text3 += val + sym + " " + forlevel;
										if (level < 5) {
											money = 20000 * (level + 1);
											itemqnt = (level + 1);
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Anima delle Ere";
											itemid = 317;
										} else if (level < 10) {
											money = 30000 * (level + 1);
											itemqnt = (level + 1) - 5;
											if (itemqnt == 0) {
												itemqnt = 1;
											}
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Batteria Infinita";
											itemid = 479;
										}
									} else if (ability_id == 11) {
										text3 += val + sym + " " + forlevel;
										if (level < 10) {
											money = 30000 * (level + 1);
											itemqnt = (level + 1);
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Plutonio";
											itemid = 238;
										}
									} else if (ability_id == 12) {
										text3 += val + sym + " " + forlevel;
										if (level < 5) {
											money = 30000 * (level + 1);
											itemqnt = (level + 1);
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Lama Celeste";
											itemid = 102;
										} else if (level < 10) {
											money = 35000 * (level + 1);
											itemqnt = (level + 1);
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Manico Diabolico";
											itemid = 103;
										}
									} else if (ability_id == 13) {
										text3 += val + sym + " " + forlevel;
										if (level < 3) {
											money = 10000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Respiro di Morte";
											itemid = 201;
										} else if (level < 6) {
											money = 10000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Urlo di Morte";
											itemid = 532;
										} else if (level < 8) {
											money = 10000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Soffio di Morte";
											itemid = 598;
										} else if (level < 10) {
											money = 10000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Necronucleo";
											itemid = 200;
										}
									} else if (ability_id == 14) {
										text3 += val + sym + " " + forlevel;
										if (level < 2) {
											money = 50000 * (level + 1);
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Gesso";
											itemid = 142;
										} else if (level < 6) {
											money = 100000 * (level + 1);
											itemqnt = 5;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Ambra";
											itemid = 223;
										} else if (level < 8) {
											money = 100000 * (level + 1);
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Mithril";
											itemid = 311;
										} else if (level < 10) {
											money = 150000 * (level + 1);
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Generatore di Ioni";
											itemid = 165;
										}
									} else if (ability_id == 15) {
										text3 += val + sym + " " + forlevel;
										if (level < 5) {
											money = 20000 * (level + 1);
											itemqnt = 5;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Anfora di Vento";
											itemid = 428;
										} else if (level < 10) {
											money = 50000 * (level + 1);
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Stemma Ciclonico";
											itemid = 434;
										}
									} else if (ability_id == 16) {
										text3 += val + sym + " " + forlevel;
										if (level < 3) {
											money = 100000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Runa Supernova";
											itemid = 343;
										} else if (level < 5) {
											money = 200000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Carica G";
											itemid = 529;
										} else if (level < 8) {
											money = 300000 * (level + 1);
											itemqnt = 3;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Nucleo Celeste";
											itemid = 625;
										} else if (level < 9) {
											money = 400000 * (level + 1);
											itemqnt = 3;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Nucleo Cremisi";
											itemid = 624;
										} else if (level < 10) {
											money = 500000 * (level + 1);
											itemqnt = 3;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Nucleo Elettrico";
											itemid = 623;
										}
									} else if (ability_id == 17) {
										text3 += toTime(val*60,0) + " " + forlevel;
										if (level < 1) {
											money = 1000000;
											itemqnt = 4;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Liquido Draconico Intermedio";
											itemid = 704;
										} else if (level < 2) {
											money = 2000000;
											itemqnt = 5;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Potenziatore Anormale";
											itemid = 702;
										} else if (level < 3) {
											money = 3000000;
											itemqnt = 6;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Liquido Draconico Avanzato";
											itemid = 705;
										} else if (level < 4) {
											money = 4000000;
											itemqnt = 7;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Gemma Draconica Instabile";
											itemid = 706;
										} else if (level < 5) {
											money = 5000000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Artigli Infernali Divini";
											itemid = 717;
										} else if (level < 6) {
											money = 6000000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Sella delle Vette Ancestrale";
											itemid = 748;
										} else if (level < 7) {
											money = 7000000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Sella Glaciale Neutrale";
											itemid = 726;
										} else if (level < 8) {
											money = 8000000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Artigli Celesti X";
											itemid = 733;
										} else if (level < 9) {
											money = 9000000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Artigli Abissali Divini";
											itemid = 741;
										} else if (level < 10) {
											money = 10000000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Artigli Oscuri Neutrali";
											itemid = 728;
										}
									} else if (ability_id == 18) {
										text3 += val + sym + " " + forlevel;
										if (level < 1) {
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Innesto Ardente";
											itemid = 628;
										}else if (level < 2){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Innesto Celeste";
											itemid = 629;
										}else if (level < 3){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Innesto di Efesto";
											itemid = 666;
										}else if (level < 4){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Catalizzatore Necro";
											itemid = 222;
										}else if (level < 5){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Innesto Folgorante";
											itemid = 627;
										}else if (level < 6){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Innesto di Poseidone";
											itemid = 667;
										}else if (level < 7){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Talismano Magico";
											itemid = 496;
										}else if (level < 8){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Talismano Artiglio";
											itemid = 602;
										}else if (level < 9){
											money = 500000 * (level + 1);
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Talismano del Pendolo";
											itemid = 404;
										}else if (level < 10){
											money = 500000 * (level + 1);
											itemqnt = 1;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Alabarda Elementale";
											itemid = 634;
										}
									} else if (ability_id == 19) {
										text3 += val + sym + " " + forlevel;
										if (level < 1){
											money = 200000;
											itemqnt = 30;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Frammento di Osmio";
											itemid = 663;
										}else if (level < 2){
											money = 500000;
											itemqnt = 50;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Frammento di Osmio";
											itemid = 663;
										}else if (level < 3){
											money = 750000;
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Kit Fuga";
											itemid = 616;
										}else if (level < 4){
											money = 1000000;
											itemqnt = 5;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Chiave Tipo 1";
											itemid = 604;
										}else if (level < 5){
											money = 1250000;
											itemqnt = 2;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Pass Argento";
											itemid = 609;
										}else if (level < 6){
											money = 1500000;
											itemqnt = 3;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Capsula Estrazione";
											itemid = 618;
										}else if (level < 7){
											money = 1750000;
											itemqnt = 10;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Chiave Tipo 2";
											itemid = 605;
										}else if (level < 8){
											money = 2250000;
											itemqnt = 25;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Varco Temporale";
											itemid = 645;
										}else if (level < 9){
											money = 3000000;
											itemqnt = 150;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Piuma di Fenice";
											itemid = 619;
										}else if (level < 10){
											money = 5000000;
											itemqnt = 3;
											text2 += "\n> " + formatNumber(money) + " Â§";
											text2 += "\n> " + itemqnt + "x Trasduttore dell'Apocalisse";
											itemid = 626;
										}
									} else if (ability_id == 20) {
										text3 += toTime(val*60,0) + " " + forlevel;
										if (level < 10){
											gems = 5 * (level+1);
											itemqnt = 1;
											text2 += "\n> " + gems + " ðŸ’Ž";
											text2 += "\n> " + itemqnt + "x Runa Supernova";
											itemid = 343;
										}
									} else {
										bot.sendMessage(message.chat.id, "Talento non valido", prev);
										return;
									}

									if (level >= maxlev) {
										bot.sendMessage(message.chat.id, text + text3 + "\nLivello massimo raggiunto", prev);
										return;
									}

									var text5 = "";
									var check = 0;
									if (money > 0){
										if (my_money < money) {
											text5 = "\nðŸš« Monete non sufficienti (" + formatNumber(my_money) + " su " + formatNumber(money) + ")";
											check++;
										}
									}else{
										if (my_gems < gems) {
											text5 = "\nðŸš« Gemme non sufficienti (" + my_gems + " su " + gems + ")";
											check++;
										}
									}

									connection.query('SELECT name FROM item WHERE id = ' + itemid, function (err, rows, fields) {
										if (err) throw err;

										var item_name = rows[0].name;
										var cnt = getItemCnt(player_id, itemid);
										if (cnt < itemqnt){
											text5 = "\nðŸš« Oggetti non sufficienti (" + cnt + " su " + itemqnt + ")";
											check++;
										}

										if (check == 2) {
											text5 = "\nðŸš« Oggetti e monete/ðŸ’Ž non sufficienti";
										}
										if (check == 0) {
											text5 = "\nâœ… Possiedi tutto il necessario";
										}

										var ability_pot = {
											parse_mode: "Markdown",
											reply_markup: {
												resize_keyboard: true,
												//one_time_keyboard: true,
												"keyboard": [["Conferma"], ["Cerca " + item_name], ["Torna all'Albero"]]
											}
										};

										bot.sendMessage(message.chat.id, text + "\n\nPer " + learn + " sono necessari:" + text2 + text5 + text3 + text4, ability_pot).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text.toLowerCase() == "conferma") {
													connection.query('SELECT money, gems FROM player WHERE id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;

														if (rows[0].money - money < 0) {
															bot.sendMessage(message.chat.id, "Non hai abbastanza monete", prev);
															return;
														}

														if (rows[0].gems - gems < 0) {
															bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’Ž", prev);
															return;
														}

														if (level >= maxlev) {
															bot.sendMessage(message.chat.id, "Questo talento Ã¨ stato potenziato al massimo", prev);
															return;
														}

														if (getItemCnt(player_id, itemid) < itemqnt) {
															bot.sendMessage(message.chat.id, "Non hai abbastanza oggetti necessari", prev);
															return;
														}

														setAchievement(message.chat.id, player_id, 18, 1);

														connection.query('UPDATE player SET money = money-' + money + ', gems = gems-' + gems + ' WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;

															connection.query('SELECT * FROM ability WHERE player_id = ' + player_id + ' AND ability_id = ' + ability_id, function (err, rows, fields) {
																if (err) throw err;

																if (Object.keys(rows).length > 0) {
																	connection.query('UPDATE ability SET ability_level = ability_level+1 WHERE player_id = ' + player_id + ' AND ability_id = ' + ability_id, function (err, rows, fields) {
																		if (err) throw err;
																		delItem(player_id, itemid, itemqnt);
																		bot.sendMessage(message.chat.id, "Talento potenziato! Livello: *" + level + " -> " + (level + 1) + "*", prev);
																	});
																} else {
																	connection.query('INSERT INTO ability (player_id, ability_level, ability_id) VALUES (' + player_id + ',1,' + ability_id + ')', function (err, rows, fields) {
																		if (err) throw err;
																		delItem(player_id, itemid, itemqnt);
																		bot.sendMessage(message.chat.id, "Talento appreso!", prev);
																	});
																}
															});
														});
													});
												}
											};
										});
									});
								});
							});
						};
					});
				});
			});
		});
	});
});

bot.onText(/equipaggia/i, function (message) {

	if (message.text.indexOf("Equipaggia Drago") != -1){
		return;
	}

	var equip = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Equipaggia Ancora"], ["Torna allo zaino"], ["Torna al menu"]]
		}
	};

	var oggetto = message.text.substring(message.text.indexOf(" ") + 1, message.text.lenght);
	if ((message.text.indexOf(" ") != -1) && (oggetto != "Ancora") && (oggetto != "ðŸ—¡")) {
		connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
			if (err) throw err;

			var banReason = isBanned(rows[0].account_id);
			if (banReason != null) {
				var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
				bot.sendMessage(message.chat.id, text, mark);
				return;
			}

			var player_id = rows[0].id;
			var player_reborn = rows[0].reborn;
			var player_level = Math.floor(rows[0].exp / 10);

			if (rows[0].holiday == 1) {
				bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
				return;
			}

			bot.sendMessage(message.chat.id, "Confermi?", yesno).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					var resp = answer.text;
					if (resp.toLowerCase() != "si") {
						return;
					}

					oggetto = oggetto.toLowerCase();

					if (re6.test(oggetto) == false) {
						bot.sendMessage(message.chat.id, "Non puoi equipaggiare l'oggetto specificato.", equip);
						return;
					}

					if (oggetto.indexOf("talismano") != -1) {
						connection.query('SELECT * FROM player WHERE charm_id != 0 AND id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;

							var charm_id = 0;
							if (Object.keys(rows).length > 0) {
								charm_id = rows[0].charm_id;
							}
							connection.query('SELECT reborn, id FROM item WHERE name = "' + oggetto + '"', function (err, rows, fields) {
								if (err) throw err;
								if (getItemCnt(player_id, rows[0].id) > 0) {
									if (player_reborn < rows[0].reborn) {
										bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario.", equip);
										return;
									}

									var itemid = rows[0].id;

									if (charm_id != 0) {
										addItem(player_id, charm_id);
										bot.sendMessage(message.chat.id, "Il Talismano precedentemente equipaggiato Ã¨ tornato nell'inventario", equip);
									}

									connection.query('UPDATE player SET charm_id = ' + itemid + ' WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										delItem(player_id, itemid, 1);
										bot.sendMessage(message.chat.id, "Talismano equipaggiato!", equip);
									});
								} else {
									bot.sendMessage(message.chat.id, "Non puoi equipaggiare questo talismano.", equip);
								}
							});
						});
					} else {
						connection.query('SELECT reborn, critical, power, power_armor, power_shield, id, rarity FROM item WHERE name = "' + oggetto + '" AND (power <> 0 OR power_armor <> 0 OR power_shield <> 0)', function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste", equip);
								return;
							}

							if (getItemCnt(player_id, rows[0].id) > 0) {
								var itemid = rows[0].id;
								var power = rows[0].power;
								var power_a = rows[0].power_armor;
								var power_s = rows[0].power_shield;
								var critical = rows[0].critical;
								var reborn = rows[0].reborn;
								var rarity = rows[0].rarity;

								var level_nec = 0;
								if (rarity == "UR") {
									level_nec = 15;
								} else if (rarity == "L") {
									level_nec = 30;
								} else if (rarity == "E") {
									level_nec = 50;
								} else if (rarity == "UE") {
									level_nec = 60;
								}
								if ((player_level < level_nec) && (player_reborn == 1)) {
									bot.sendMessage(message.chat.id, "Non hai il livello necessario. (" + level_nec + ")", equip);
									return;
								}

								if (player_reborn < reborn) {
									bot.sendMessage(message.chat.id, "Non hai il livello rinascita necessario.", equip);
									return;
								}

								if (power != 0) { //Arma
									connection.query('SELECT weapon_id FROM player WHERE weapon_id != 0 AND id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										var weapon_id = 0;
										if (Object.keys(rows).length > 0) {
											weapon_id = rows[0].weapon_id;
										}

										if ((itemid == 221) || (itemid == 638) || (itemid == 639) || (itemid == 640) || (itemid == 754)) {
											power = Math.round(50 + (player_level / 2));
										}

										if (weapon_id != 0) {
											addItem(player_id, weapon_id);
											bot.sendMessage(message.chat.id, "L'Arma precedentemente equipaggiata Ã¨ tornata nell'inventario", equip);
										}

										connection.query('UPDATE player SET weapon=' + power + ', weapon_id=' + itemid + ', weapon_crit=' + critical + ' WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
											if (err) throw err;
											delItem(player_id, itemid, 1);
											bot.sendMessage(message.chat.id, "Arma equipaggiata!", equip);
										});
									});
								} else if (power_a != 0) { //Armatura
									connection.query('SELECT weapon2_id FROM player WHERE weapon2_id != 0 AND id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										var weapon2_id = 0;
										if (Object.keys(rows).length > 0) {
											weapon2_id = rows[0].weapon2_id;
										}

										if ((itemid == 577) || (itemid == 688) || (itemid == 689) || (itemid == 690)) {
											power_a = Math.round(25 + (player_level / 2));
											power_a = -Math.abs(power_a);
										}

										if (weapon2_id != 0) {
											addItem(player_id, weapon2_id);
											bot.sendMessage(message.chat.id, "L'Armatura precedentemente equipaggiata Ã¨ tornata nell'inventario", equip);
										}

										connection.query('UPDATE player SET weapon2=' + power_a + ', weapon2_id=' + itemid + ', weapon2_crit=' + critical + ' WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
											if (err) throw err;
											delItem(player_id, itemid, 1);
											bot.sendMessage(message.chat.id, "Armatura equipaggiata!", equip);
										});
									});
								} else if (power_s != 0) { //Scudo
									connection.query('SELECT weapon3_id FROM player WHERE weapon3_id != 0 AND id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										var weapon3_id = 0;
										if (Object.keys(rows).length > 0) {
											weapon3_id = rows[0].weapon3_id;
										}

										if ((itemid == 600) || (itemid == 671) || (itemid == 672) || (itemid == 673)) {
											power_s = Math.round(20 + (player_level / 2));
											power_s = -Math.abs(power_s);
										}

										if (weapon3_id != 0) {
											addItem(player_id, weapon3_id);
											bot.sendMessage(message.chat.id, "Lo Scudo precedentemente equipaggiato Ã¨ tornato nell'inventario", equip);
										}

										connection.query('UPDATE player SET weapon3 = ' + power_s + ', weapon3_id = ' + itemid + ', weapon3_crit = ' + critical + ' WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
											if (err) throw err;
											delItem(player_id, itemid, 1);
											bot.sendMessage(message.chat.id, "Scudo equipaggiato!", equip);
										});
									});
								} else {
									bot.sendMessage(message.chat.id, "Non puoi equipaggiare l'oggetto specificato.", equip);
								}
							} else {
								bot.sendMessage(message.chat.id, "Non puoi equipaggiare l'oggetto specificato.", equip);
							}
						});
					}
				};
			});
		});
		return;
	}

	var bottext = "*Oggetti equipaggiabili:*\n";

	connection.query('SELECT id, charm_id, weapon_id, account_id, weapon2_id, exp, weapon3_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var player_level = Math.floor(rows[0].exp / 10);
		var charm_id = rows[0].charm_id;
		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var noequip = 0;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		connection.query('SELECT item.power, item.power_armor, item.power_shield, item.critical, item.name, item.id FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND (item.power <> 0 OR item.power_armor <> 0 OR item.power_shield <> 0) AND inventory.quantity > 0', function (err, rows, fields) {
			if (err) throw err;
			var iKeys = [];
			if (Object.keys(rows).length > 0) {
				bottext = bottext + "\n*Armi/Protezioni:*\n";
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if ((rows[i].id == 221) || (rows[i].id == 638) || (rows[i].id == 639) || (rows[i].id == 640) || (rows[i].id == 754)) {
						rows[i].power = Math.round(50 + (player_level / 2));
					}
					if ((rows[i].id == 577) || (rows[i].id == 688) || (rows[i].id == 689) || (rows[i].id == 690)) {
						rows[i].power_armor = -Math.round(25 + (player_level / 2));
					}
					if ((rows[i].id == 600) || (rows[i].id == 671) || (rows[i].id == 672) || (rows[i].id == 673)) {
						rows[i].power_shield = -Math.round(20 + (player_level / 2));
					}

					if (rows[i].power != 0) {
						if ((rows[i].id == weapon_id) || (rows[i].id == weapon2_id) || (rows[i].id == weapon3_id)) {
							bottext = bottext + "> " + rows[i].name + " (+" + rows[i].power + " danno, " + rows[i].critical + ") âœ…\n";
						} else {
							bottext = bottext + "> " + rows[i].name + " (+" + rows[i].power + " danno, " + rows[i].critical + ")\n";
						}
					} else if (rows[i].power_armor != 0) {
						if ((rows[i].id == weapon_id) || (rows[i].id == weapon2_id) || (rows[i].id == weapon3_id)) {
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_armor + " danno subito, " + rows[i].critical + ") âœ…\n";
						} else {
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_armor + " danno subito, " + rows[i].critical + ")\n";
						}
					} else if (rows[i].power_shield != 0) {
						if ((rows[i].id == weapon_id) || (rows[i].id == weapon2_id) || (rows[i].id == weapon3_id)) {
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_shield + " danno subito, " + rows[i].critical + ") âœ…\n";
						} else {
							bottext = bottext + "> " + rows[i].name + " (" + rows[i].power_shield + " danno subito, " + rows[i].critical + ")\n";
						}
					}
					iKeys.push(["Equipaggia " + rows[i].name]);
				}
			} else {
				bottext = bottext + "Nessun arma o protezione equipaggiabile.";
				noequip = 1;
			}
			bottext = bottext + "\n";

			connection.query('SELECT item.name, item.id FROM inventory, item WHERE inventory.item_id = item.id AND inventory.player_id = ' + player_id + ' AND item.name LIKE "Talismano%" AND inventory.quantity > 0', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					bottext = bottext + "*Talismani:*\n";
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].id == charm_id) {
							bottext = bottext + "> " + rows[i].name + " âœ…\n";
						} else {
							bottext = bottext + "> " + rows[i].name + "\n";
						}
						iKeys.push(["Equipaggia " + rows[i].name]);
					}
				} else {
					bottext = bottext + "Nessun talismano equipaggiabile.";
					noequip = noequip + 1;
				}

				if (noequip == 2) {
					bot.sendMessage(message.chat.id, bottext, back);
					return;
				}

				iKeys.push(["Niente"]);
				iKeys.push(["Torna allo zaino"]);

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": iKeys
					}
				};

				if (Object.keys(bottext).length > 3800) {
					bot.sendMessage(message.chat.id, "Hai troppi oggetti equipaggiabili, usa Equipaggia NomeOggetto per procedere ugualmente", back);
					return;
				}

				bot.sendMessage(message.chat.id, bottext + "\nCosa vuoi equipaggiare?\nQuando equipaggiato l'oggetto verrÃ  rimosso dall'inventario, usa Rimuovi per disequipaggiarlo", kb);
			});
		});
	});
});

bot.onText(/rimuovi/i, function (message) {
	var oggetto = "";

	var kbEquip = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Equipaggia"], ["Rimuovi"], ["Torna allo zaino"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT id, holiday, account_id, weapon_id, weapon2_id, weapon3_id, charm_id, mission_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var charm_id = rows[0].charm_id;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		connection.query('SELECT name FROM item WHERE id = ' + weapon_id, function (err, rows, fields) {
			if (err) throw err;

			var weapon_name = "";
			if (Object.keys(rows).length > 0)
				weapon_name = rows[0].name;

			connection.query('SELECT name FROM item WHERE id = ' + weapon2_id, function (err, rows, fields) {
				if (err) throw err;

				var weapon2_name = "";
				if (Object.keys(rows).length > 0)
					weapon2_name = rows[0].name;

				connection.query('SELECT name FROM item WHERE id = ' + weapon3_id, function (err, rows, fields) {
					if (err) throw err;

					var weapon3_name = "";
					if (Object.keys(rows).length > 0)
						weapon3_name = rows[0].name;

					connection.query('SELECT name FROM item WHERE id = ' + charm_id, function (err, rows, fields) {
						if (err) throw err;

						var charm_name = "";
						if (Object.keys(rows).length > 0)
							charm_name = rows[0].name;

						var oggetto = message.text.substring(message.text.indexOf(" ") + 1);

						if ((message.text.indexOf(" ") != -1) && (oggetto != " ") && (oggetto != "") && (oggetto != "ðŸš«")) {

							oggetto = oggetto.toLowerCase();

							var desc = " di tutto l'equip";
							if (oggetto == "arma") {
								desc = " di " + weapon_name;
							} else if (oggetto == "armatura") {
								desc = " di " + weapon2_name;
							} else if (oggetto == "scudo") {
								desc = " di " + weapon3_name;
							} else if (oggetto == "talismano") {
								desc = " di " + charm_name;
							}

							bot.sendMessage(message.chat.id, "Confermi la rimozione" + desc + "?", yesno).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									var resp = answer.text;
									if (resp.toLowerCase() != "si") {
										return;
									}

									if (oggetto == "arma") {
										if (weapon_id != 0) {
											connection.query('UPDATE player SET weapon=0, weapon_id=0 WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, weapon_id);
												bot.sendMessage(message.chat.id, "Arma (" + weapon_name + ") rimossa dall'equipaggiamento.", kbEquip);
											});
										} else {
											bot.sendMessage(message.chat.id, "Non hai nessun arma equipaggiata.", kbEquip);
										}
									} else if (oggetto == "armatura") {
										if (weapon2_id != 0) {
											connection.query('UPDATE player SET weapon2=0, weapon2_id=0 WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, weapon2_id);
												bot.sendMessage(message.chat.id, "Armatura (" + weapon2_name + ") rimossa dall'equipaggiamento.", kbEquip);
											});
										} else {
											bot.sendMessage(message.chat.id, "Non hai nessun armatura equipaggiata.", kbEquip);
										}
									} else if (oggetto == "scudo") {
										if (weapon3_id != 0) {
											connection.query('UPDATE player SET weapon3=0, weapon3_id=0 WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, weapon3_id);
												bot.sendMessage(message.chat.id, "Scudo (" + weapon3_name + ") rimosso dall'equipaggiamento.", kbEquip);
											});
										} else {
											bot.sendMessage(message.chat.id, "Non hai nessuno scudo equipaggiato.", kbEquip);
										}
									} else if (oggetto == "talismano") {
										if (charm_id != 0) {
											connection.query('UPDATE player SET charm_id=0 WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, charm_id);
												bot.sendMessage(message.chat.id, "Talismano (" + charm_id + ") rimosso dall'equipaggiamento.", kbEquip);
											});
										} else {
											bot.sendMessage(message.chat.id, "Non hai nessun talismano equipaggiato", kbEquip);
										}
									} else if (oggetto == "tutto") {
										var text = "";
										if (weapon_id != 0) {
											text += "> Arma (" + weapon_name + ")\n";
											connection.query('UPDATE player SET weapon=0, weapon_id=0 WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, weapon_id);
											});
										}
										if (weapon2_id != 0) {
											text += "> Armatura (" + weapon2_name + ")\n";
											connection.query('UPDATE player SET weapon2 = 0, weapon2_id = 0 WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, weapon2_id);
											});
										}
										if (weapon3_id != 0) {
											text += "> Scudo (" + weapon3_name + ")\n";
											connection.query('UPDATE player SET weapon3 = 0, weapon3_id = 0 WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, weapon3_id);
											});
										}
										if (charm_id != 0) {
											text += "> Talismano (" + charm_name + ")\n";
											connection.query('UPDATE player SET charm_id = 0 WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												addItem(player_id, charm_id);
											});
										}

										if (text == "") {
											bot.sendMessage(message.chat.id, "Non hai alcun oggetto equipaggiato", back);
										} else {
											bot.sendMessage(message.chat.id, text + "\nRimossi e reinseriti nello zaino", back);
										}
									} else {
										bot.sendMessage(message.chat.id, "Equipaggiamento non valido.", back);
										return;
									}
								};
							});
							return;
						}

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Rimuovi Arma", "Rimuovi Armatura"], ["Rimuovi Scudo", "Rimuovi Talismano"], ["Rimuovi Tutto"], ["Torna allo zaino"], ["Torna al menu"]]
							}
						};

						bot.sendMessage(message.chat.id, "Cosa vuoi rimuovere?", kb);
					});
				});
			});
		});
	});
});


bot.onText(/^crea (.+)/i, function (message, match) {
	connection.query('SELECT id, holiday, money, reborn, account_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var money = rows[0].money;
		var reborn = rows[0].reborn;

		var oggetto = match[1];
		if ((oggetto.indexOf("Oggetto") == -1) && (oggetto != "Ancora")) {
			var parts = oggetto.split(",");
			var qnt = 1;
			if (Object.keys(parts).length > 1) {
				oggetto = parts[0];
				qnt = parseInt(parts[1].trim());
			}

			creaOggetto(message, player_id, oggetto, money, reborn, qnt);
		}
	});
});

function creaOggetto(message, player_id, oggetto, money, reborn, quantity = 1) {
	var inventario = "";

	if (!checkSpam(message)) {
		return;
	}

	if (isNaN(quantity)) {
		bot.sendMessage(message.chat.id, "QuantitÃ  non valida", back);
		return;
	}

	quantity = parseInt(quantity);

	if (player_id != 1) {
		if ((quantity < 1) || (quantity > 3)) {
			bot.sendMessage(message.chat.id, "Puoi creare al massimo 3 copie dello stesso oggetto contemporaneamente", back);
			return;
		}
	}

	if ((eventFestival == 1) && (quantity > 1)) {
		bot.sendMessage(message.chat.id, "Non puoi creare oggetti multipli durante il festival", back);
		return;
	}

	connection.query('SELECT id, term FROM search_history WHERE player_id = ' + player_id + ' ORDER BY id DESC LIMIT 2', function (err, rows, fields) {
		if (err) throw err;

		var iKeys = [];

		iKeys.push(["Crea " + oggetto, "Crea " + oggetto + ", 3"]);

		if (Object.keys(rows).length == 2) {
			iKeys.push(["Torna a " + rows[1].term]);
		}

		iKeys.push(["Torna a *" + oggetto]);

		var craft_fail = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Cerca " + oggetto], ["Torna al menu"]]
			}
		};

		connection.query('SELECT craft.material_1, craft.material_2, craft.material_3, craft.material_result, item.name FROM craft, item WHERE craft.material_result = item.id AND item.name = "' + oggetto + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste", craft_fail);
			} else {
				var mat1 = rows[0].material_1;
				var mat2 = rows[0].material_2;
				var mat3 = rows[0].material_3;
				var matR = rows[0].material_result;
				var craftexp = 0;

				oggetto = rows[0].name;

				connection.query('SELECT name, rarity, reborn, power FROM item WHERE id = ' + matR, function (err, rows, fields) {
					if (err) throw err;

					var result_name = rows[0].name;
					var result_rarity = rows[0].rarity;
					var result_reborn = rows[0].reborn;
					var result_power = rows[0].power;

					if (reborn < result_reborn) {
						bot.sendMessage(message.chat.id, "La tua rinascita non Ã¨ sufficente per creare questo oggetto.", back);
						return;
					}

					connection.query('SELECT name, rarity, reborn FROM item WHERE id IN (' + mat1 + ',' + mat2 + ',' + mat3 + ')', function (err, rows, fields) {
						if (err) throw err;

						var cost = 0;
						var Rmoney = "";
						if (result_rarity == "L") {
							cost = 750;
							craftexp = 3;
						} else if (result_rarity == "UR") {
							cost = 500;
							craftexp = 2;
						} else if (result_rarity == "E") {
							cost = 1000;
							craftexp = 5;
						} else if (result_rarity == "X") {
							cost = 100000;
							craftexp = 50;
						} else if (result_rarity == "UE") {
							cost = 10000;
							craftexp = 25;
						} else if (result_rarity == "U") {
							cost = 50000;
							craftexp = 35;
						}

						cost = cost * quantity;
						craftexp = craftexp * quantity;

						if (cost > 0)
							Rmoney = "\n> " + formatNumber(cost) + " Â§";

						var n1 = rows[0].name;
						var n2 = rows[1].name;
						var n3 = rows[2].name;

						bot.sendMessage(message.chat.id, "Stai per consumare i seguenti oggetti:\n> " + quantity + "x " + n1 + "\n> " + quantity + "x " + n2 + "\n> " + quantity + "x " + n3 + Rmoney + "\n\nProcedi?", yesno).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {

								var res = answer.text.toLowerCase();
								if (res == "Torna al menu") {
									return;
								} else if (res == "si") {
									connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										money = rows[0].money;
										connection.query('SELECT name FROM item WHERE id = ' + mat1, function (err, rows, fields) {
											if (err) throw err;
											var cnt = getItemCnt(player_id, mat1);
											if (cnt < quantity) {
												bot.sendMessage(message.chat.id, "Non possiedi abbastanza " + rows[0].name + " (" + cnt + " su " + quantity + ")", craft_fail);
												return;
											}
											connection.query('SELECT name FROM item WHERE id = ' + mat2, function (err, rows, fields) {
												if (err) throw err;
												var cnt2 = getItemCnt(player_id, mat2);
												if (cnt2 < quantity) {
													bot.sendMessage(message.chat.id, "Non possiedi abbastanza " + rows[0].name + " (" + cnt2 + " su " + quantity + ")", craft_fail);
													return;
												}
												connection.query('SELECT name FROM item WHERE id = ' + mat3, function (err, rows, fields) {
													if (err) throw err;
													var cnt3 = getItemCnt(player_id, mat3);
													if (cnt3 < quantity) {
														bot.sendMessage(message.chat.id, "Non possiedi abbastanza " + rows[0].name + " (" + cnt3 + " su " + quantity + ")", craft_fail);
														return;
													}

													if (cost > 0) {
														if (money < cost) {
															bot.sendMessage(message.chat.id, "Ti servono " + cost + " Â§ per creare questo oggetto.", craft_fail);
															return;
														} else {
															connection.query('UPDATE `player` SET money = money-' + cost + ' WHERE `nickname` = "' + message.from.username + '"', function (err, rows, fields) {
																if (err) throw err;
															});
														}
													};

													delItem(player_id, mat1, quantity);
													delItem(player_id, mat2, quantity);
													delItem(player_id, mat3, quantity);

													addItem(player_id, matR, quantity);

													if (result_power > 0) {
														setAchievement(message.chat.id, player_id, 34, quantity);
													}

													setAchievementProgress(player_id, 4);

													connection.query('SELECT item.name FROM craft, item WHERE item.id = craft.material_result AND (material_1 = ' + matR + ' OR material_2 = ' + matR + ' OR material_3 = ' + matR + ') LIMIT 20', function (err, rows, fields) {
														if (err) throw err;

														if (Object.keys(rows).length > 0) {
															for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
																iKeys.push(["Crea " + rows[i].name]);
															}
														}

														iKeys.push(["Contrabbandiere", "Torna al menu"]);

														var craft = {
															parse_mode: "Markdown",
															reply_markup: {
																resize_keyboard: true,
																//one_time_keyboard: true,
																"keyboard": iKeys
															}
														};

														if (quantity == 1) {
															bot.sendMessage(message.chat.id, "Hai creato *" + oggetto + "*!", craft);
														} else {
															bot.sendMessage(message.chat.id, "Hai creato " + quantity + "x *" + oggetto + "*!", craft);
														}

														connection.query('UPDATE player SET craft_week = craft_week + ' + craftexp + ', craft_count = craft_count + ' + craftexp + ' WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
															if (err) throw err;
														});

														connection.query('SELECT team_id FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															if (Object.keys(rows).length > 0) {
																connection.query('UPDATE team SET craft_count = craft_count+' + craftexp + ' WHERE id = ' + rows[0].team_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
														});

														setAchievement(message.chat.id, player_id, 10, craftexp);
														setAchievement(message.chat.id, player_id, 12, quantity, matR);
														var today = new Date();
														if ((today.getDay() == 6) || (today.getDay() == 0)) {
															checkFestival(message.chat.id, player_id, matR);
														}
													});
												});
											});
										});
									});
								};
							};
						});
					});
				});
			}
		});
		//}
		//});	
	});
}

function checkFestival(chat_id, player_id, item_id) {
	if (eventFestival == 0) {
		return;
	}

	connection.query('SELECT event_crafting_item.completed, event_crafting_item.cnt, event_crafting_item.total_price, event_crafting_item.full_price, event_crafting_item.wait_time, event_crafting_item.start_price, event_crafting_item.increm, event_crafting_item.id As eventId, event_crafting_item.cnt, item.id, rarity.id As rarity_id, event_crafting_item.incremDelta FROM event_crafting_item, item, rarity WHERE item.rarity = rarity.shortname AND item.id = event_crafting_item.item_id ORDER BY event_crafting_item.id DESC LIMIT 1', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if ((rows[0].id == item_id) && (rows[0].wait_time == null) && (rows[0].completed == 0)) {
				var start_price = rows[0].start_price;
				var full_price = rows[0].full_price;
				var delta = start_price/100;
				var incremDelta = rows[0].incremDelta;

				//var increm = start_price+incremDelta;
				var ricompensa = start_price+delta*rows[0].cnt;

				var total_price = Math.round(rows[0].total_price + ricompensa);
				var cnt = rows[0].cnt;
				var eventId = rows[0].eventId;
				var rarityId = rows[0].rarity_id;
				var incremPrice = rows[0].increm;

				connection.query('UPDATE event_crafting_item SET total_price = total_price+' + ricompensa + ', cnt = cnt+1, incremDelta = ' + ricompensa + ' WHERE id = ' + eventId, function (err, rows, fields) {
					if (err) throw err;
					connection.query('UPDATE event_crafting_status SET cnt = cnt+1, total_cnt = total_cnt+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						var plur = "e";
						if ((parseInt(cnt) + 1) == 1) {
							plur = "a";
						}
						bot.sendMessage(chat_id, "Hai creato l'oggetto per il festival! Il gruzzolone ha raggiunto un totale di *" + formatNumber(total_price) + " Â§*, Ã¨ stato creato " + formatNumber(parseInt(cnt) + 1) + " volt" + plur + "!", mark);
						console.log("Gruzzolone +" + ricompensa);
						console.log("Gruzzolone a " + total_price);

						var cap = start_price * 5 * (7 - rarityId);
						cap += cap * (incremPrice / 100);

						if (ricompensa >= cap) {
							connection.query('UPDATE event_crafting_item SET completed = 1 WHERE id = ' + eventId, function (err, rows, fields) {
								if (err) throw err;
							});
						}
					});
				});
			}
		}
	});
}

function setAchievementProgress(player_id, type, manual = 0) {
	connection.query('SELECT * FROM player WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;

		var chat_id = rows[0].chat_id;
		var lev = Math.floor(rows[0].exp / 10);
		var reb = rows[0].reborn;

		if (type == 1) {
			for (var i = 0, len = Object.keys(progLev).length; i < len; i++) {
				if (getRealLevel(reb, lev) >= progLev[i]) {
					achievementDetail(player_id, chat_id, type, i, progLevRew[i], "Hai raggiunto il livello " + formatNumber(progLev[i]));
				}
			}
		} else if (type == 2) {
			var miss = rows[0].mission_count;
			for (var i = 0, len = Object.keys(progMis).length; i < len; i++) {
				if (miss >= progMis[i]) {
					achievementDetail(player_id, chat_id, type, i, progMisRew[i], "Hai completato " + formatNumber(progMis[i]) + " missioni");
				}
			}
		} else if (type == 3) {
			var dung = rows[0].dungeon_count;
			for (var i = 0, len = Object.keys(progDung).length; i < len; i++) {
				if (dung >= progDung[i]) {
					achievementDetail(player_id, chat_id, type, i, progDungRew[i], "Hai completato " + formatNumber(progDung[i]) + " dungeon");
				}
			}
		} else if (type == 4) {
			var craft = rows[0].craft_count;
			for (var i = 0, len = Object.keys(progCraft).length; i < len; i++) {
				if (craft >= progCraft[i]) {
					achievementDetail(player_id, chat_id, type, i, progCraftRew[i], "Hai raggiunto " + formatNumber(progCraft[i]) + " punti creazione");
				}
			}
		}
	});
};

function achievementDetail(player_id, chat_id, type, subtype, reward, msg) {
	connection.query('SELECT COUNT(id) As cnt FROM achievement_progressive_status WHERE subtype = ' + subtype + ' AND type = ' + type + ' AND player_id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		if (rows[0].cnt == 0) {
			bot.sendMessage(chat_id, msg + " e ottenuto <i>" + formatNumber(reward) + "</i> Â§!", html);
			connection.query('UPDATE player SET money = money + ' + reward + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				connection.query('INSERT INTO achievement_progressive_status (player_id, type, subtype) VALUES (' + player_id + ',' + type + ',' + subtype + ')', function (err, rows, fields) {
					if (err) throw err;
				});
			});
		}
	});
};

function setAchievement(chat_id, player_id, type, increment, itemId = 0) {
	connection.query('SELECT achievement_count, reborn FROM player WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;

		var achievement_count = parseInt(rows[0].achievement_count) + 1;
		var reborn = rows[0].reborn;

		connection.query('SELECT name, value, type, achievement_id, item_id, reward, multiply FROM achievement_daily, achievement_list WHERE achievement_daily.achievement_id = achievement_list.id AND achievement_list.type = ' + type, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				var count_ach = rows[0].value;
				var reward = rows[0].reward;
				if (rows[0].multiply == 1){
					count_ach = count_ach*reborn;
					reward = reward*reborn;
				}
				var ach_id = rows[0].achievement_id;
				var item_id = rows[0].item_id;
				var name = rows[0].name;

				if (item_id != 0) {
					if ((item_id == 0) || (item_id != itemId)) {
						return;
					}
				}

				connection.query('SELECT progress, completed FROM achievement_status WHERE achievement_id = ' + ach_id + ' AND player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;

					var completed = 0;
					var progress = 0;
					if (Object.keys(rows).length == 0) {
						connection.query('INSERT INTO achievement_status (player_id, achievement_id, progress) VALUES (' + player_id + ',' + ach_id + ',0)', function (err, rows, fields) {
							if (err) throw err;

							if ((progress + increment >= count_ach) && (completed == 0)) {
								connection.query('UPDATE player SET achievement_count = achievement_count+1, money = money+' + reward + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE achievement_status SET completed = 1 WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai completato l'impresa giornaliera *" + name + "* e hai ricevuto *" + formatNumber(reward) + "  Â§*!", mark);
									setAchievement(chat_id, player_id, 40, 1);
								});
								if ((achievement_count % 10) == 0) {
									var randChest = Math.random() * 100;
									var chest_id = 0;
									var chest_name = "";
									if (randChest <= 60) {
										chest_id = 4;
										chest_name = "Scrigno di Diamante";
									} else if (randChest <= 90) {
										chest_id = 5;
										chest_name = "Scrigno Leggendario";
									} else {
										chest_id = 6;
										chest_name = "Scrigno Epico";
									}
									addChest(player_id, chest_id);
									bot.sendMessage(chat_id, "Hai completato *10 imprese* e hai ricevuto *" + chest_name + "*!", mark);
								}
							}
							connection.query('UPDATE achievement_status SET progress = progress+' + increment + ' WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function (err, rows, fields) {
								if (err) throw err;
							});
						});
					} else {
						completed = rows[0].completed;
						progress = rows[0].progress;

						if ((progress + increment >= count_ach) && (completed == 0)) {
							//console.log("Impresa: " + player_id + " - " + type + " - " + increment + " - " + itemId);

							connection.query('UPDATE player SET achievement_count = achievement_count+1, money = money+' + reward + ' WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
							});
							connection.query('UPDATE achievement_status SET completed = 1 WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Hai completato l'impresa giornaliera *" + name + "* e hai ricevuto *" + formatNumber(reward) + " Â§*!", mark);
								setAchievement(chat_id, player_id, 40, 1);
							});

							if ((achievement_count % 10) == 0) {
								var randChest = Math.random() * 100;
								var chest_id = 0;
								var chest_name = "";
								if (randChest <= 60) {
									chest_id = 4;
									chest_name = "Scrigno di Diamante";
								} else if (randChest <= 90) {
									chest_id = 5;
									chest_name = "Scrigno Leggendario";
								} else {
									chest_id = 6;
									chest_name = "Scrigno Epico";
								}
								addChest(player_id, chest_id);
								bot.sendMessage(chat_id, "Hai completato *10 imprese* e hai ricevuto *" + chest_name + "*!", mark);
							}
						}
						if (completed == 0) {
							connection.query('UPDATE achievement_status SET progress = progress+' + increment + ' WHERE player_id = ' + player_id + ' AND achievement_id = ' + ach_id, function (err, rows, fields) {
								if (err) throw err;
							});
						}
					}
				});
			};
		});
	});
}

bot.onText(/^scrigni|torna agli scrigni|vai agli scrigni/i, function (message) {
	s = message.text;
	var scrigno = "";
	var iKeys = [];

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		connection.query('SELECT chest.name As name, quantity As num, (SELECT SUM(quantity) FROM inventory_chest WHERE player_id = ' + player_id + ') As tot FROM inventory_chest, chest WHERE inventory_chest.player_id=' + player_id + ' AND inventory_chest.chest_id = chest.id AND quantity > 0 ORDER BY chest.id', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {

				var kb = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Vai all'emporio"],["Torna al menu"]]
					}
				};

				bot.sendMessage(message.chat.id, "Non possiedi nessuno scrigno.", kb);
				return;
			}

			if (rows[0].tot > 1) {
				iKeys.push(["Apri tutti"]);
			}

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push(["Apri " + rows[i].name + " (" + rows[i].num + ")"]);
			}

			iKeys.push(["Torna al menu"]);

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			var plur = "i";
			if (rows[0].tot == 1)
				plur = "o";

			if ((new Date().getDate() == 1) && (new Date().getMonth() == 3))
				rows[0].tot = 0;

			bot.sendMessage(message.chat.id, "Possiedi " + rows[0].tot + " scrign" + plur, kb);
		});
	});
});

bot.onText(/^apri/i, function (message) {
	connection.query('SELECT id, reborn, account_id, holiday, mkeys FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var reborn = rows[0].reborn;
		var mkeys = rows[0].mkeys;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var chestMore = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna agli scrigni"], ["Torna al menu"]]
			}
		};

		var scrigno = message.text.substring(message.text.indexOf(" ") + 1);
		if (scrigno.indexOf("(") != -1)
			scrigno = scrigno.substring(0, scrigno.indexOf("(") - 1);
		if ((scrigno == "") || (scrigno == " "))
			return;

		var all = "";
		if (scrigno != "tutti") {
			all = ' AND chest.name = "' + scrigno + '"';
		} else {
			all = ' AND chest.id != 8';
		}

		connection.query('SELECT chest.id, chest.name, quantity FROM chest, inventory_chest WHERE chest.id = inventory_chest.chest_id AND inventory_chest.player_id = ' + player_id + ' AND quantity > 0' + all, function (err, rows, fields) {
			if (err) throw err;

			var qnt = 0;
			for (i = 0; i < Object.keys(rows).length; i++) {
				qnt += parseInt(rows[i].quantity);
			}
			if (qnt == 0) {
				if (scrigno != "tutti") {
					bot.sendMessage(message.chat.id, "Non possiedi lo scrigno selezionato", chestMore);
				} else {
					bot.sendMessage(message.chat.id, "Non possiedi nessuno scrigno apribile", chestMore);
				}
				return;
			}

			qnt = qnt.toString();
			var rarity = rows[0].id;

			if (scrigno != "tutti") {
				if (rarity == 8) {
					var chestYesNo = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Si"], ["Torna agli scrigni"], ["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, "Vuoi aprire lo Scrigno Mistico? ConterrÃ  una certa quantitÃ  di copie di un oggetto Base (R-E) di alto valore ed una ðŸ’Ž. Ti costerÃ  15/" + mkeys + " ðŸ—.", chestYesNo).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							var resp = answer.text;
							if ((resp == "Torna al menu") || (resp == "Torna agli scrigni")) {
								return;
							}
							if (answer.text.toLowerCase() == "si") {
								connection.query('SELECT mkeys FROM player WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									if (rows[0].mkeys < 15) {
										bot.sendMessage(message.chat.id, "Non hai abbastanza Chiavi Mistiche, te ne servono 15", chestMore);
										return;
									}

									delChest(player_id, 8, 1);

									connection.query('UPDATE player SET mkeys = mkeys-15 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										connection.query('SELECT shortname FROM rarity WHERE id > 2 AND id < 7 ORDER BY RAND()', function (err, rows, fields) {
											if (err) throw err;
											var rarity = rows[0].shortname;
											connection.query('SELECT I.name, I.id, I.estimate FROM item I INNER JOIN (SELECT id FROM item WHERE craftable = 0 AND rarity = "' + rarity + '" ORDER BY estimate DESC LIMIT 10) I2 ON I.id = I2.id ORDER BY RAND()', function (err, rows, fields) {
												if (err) throw err;
												var qnt = 0;
												if (rarity == "R") {
													qnt = 20;
												} else if (rarity == "UR") {
													qnt = 15;
												} else if (rarity == "L") {
													qnt = 10;
												} else if (rarity == "E") {
													qnt = 5;
												}

												addItem(player_id, rows[0].id, qnt);

												bot.sendMessage(message.chat.id, "Nello Scrigno Mistico hai trovato " + qnt + "x *" + rows[0].name + "* ed una ðŸ’Ž!", chestMore);
												connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											});
										});
									});
								});
							};
						};
					});
					return;
				}
			}

			var maxChest = 1000;
			var d = new Date();

			if ((d.getHours() > 1) && (d.getHours() < 7))
				maxChest = 2000;

			if (scrigno == "tutti") {
				var chestNum = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Si"], ["Torna agli scrigni"], ["Torna al menu"]]
					}
				};
			} else if (qnt > maxChest) {
				var chestNum = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["1"], [Math.min(qnt, maxChest).toString()], ["Torna agli scrigni"], ["Torna al menu"]]
					}
				};
			} else if (qnt > 1) {
				var chestNum = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["1"], [qnt], ["Torna agli scrigni"], ["Torna al menu"]]
					}
				};
			} else {
				var chestNum = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["1"], ["Torna agli scrigni"], ["Torna al menu"]]
					}
				};
			}

			var alltxt = "Sicuro di voler aprire tutti gli scrigni?";
			if (scrigno != "tutti")
				alltxt = "Possiedi " + qnt + "x *" + scrigno + "*, quanti ne vuoi aprire?";

			bot.sendMessage(message.chat.id, alltxt, chestNum).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					var resp = answer.text;
					if ((resp == "Torna al menu") || (resp == "Torna agli scrigni")) {
						return;
					} else if ((!isNaN(parseInt(answer.text))) || (answer.text.toLowerCase() == "si")) {
						resp = parseInt(resp);

						if ((scrigno != "tutti") && (!isNaN(resp))) {
							if (resp < 1) {
								bot.sendMessage(message.chat.id, "Devi aprire almeno uno scrigno", chestMore);
								return;
							}
							if (resp > qnt) {
								bot.sendMessage(message.chat.id, "Non possiedi cosÃ¬ tanti scrigni di questo tipo", chestMore);
								return;
							}
						} else {
							resp = 9999999;
						}

						var quantity = resp;

						var allsql = "";
						if (scrigno != "tutti") {
							allsql = 'inventory_chest.chest_id = ' + rarity + ' AND ';
						} else {
							allsql = 'chest.id != 8 AND ';
						}

						var query = 'SELECT inventory_chest.id, inventory_chest.chest_id, chest.rarity_shortname, inventory_chest.quantity FROM inventory_chest, chest WHERE ' + allsql + 'inventory_chest.chest_id = chest.id AND player_id = "' + player_id + '" AND quantity > 0 ORDER BY chest.id';
						connection.query(query, function (err, rows, fields) {
							if (err) throw err;

							var itemqnt = 0;
							for (i = 0; i < Object.keys(rows).length; i++) {
								itemqnt += parseInt(rows[i].quantity);
							}

							if (itemqnt == 0) {
								bot.sendMessage(message.chat.id, "Non possiedi gli scrigni indicati", chestMore);
								return;
							}
							if (scrigno == "tutti") {
								if (itemqnt > maxChest) {
									bot.sendMessage(message.chat.id, "Purtroppo non puoi aprire cosÃ¬ tanti scrigni insieme, massimo " + maxChest + " alla volta", chestMore);
									return;
								}
							}else{
								if (quantity > maxChest) {
									bot.sendMessage(message.chat.id, "Purtroppo non puoi aprire cosÃ¬ tanti scrigni insieme, massimo " + maxChest + " alla volta", chestMore);
									return;
								}
							}

							var chest_rarity = "";
							var chest_id = 0;
							var item_name = "";
							var item_rarity = "";
							var item_id = 0;
							var itemsArray = [];
							var special = 0;
							var opened = 0;

							var itemSql = "";

							for (j = 0; j < Object.keys(rows).length; j++) {	// per ogni raritÃ 
								if (scrigno == "tutti")
									quantity = rows[j].quantity;

								//console.log("Apertura di " + quantity + " scrigni raritÃ  " + rows[j].rarity_shortname);

								for (i = 0; i < quantity; i++) {	// quantity oggetti estratti
									chest_rarity = rows[j].rarity_shortname;
									chest_id = rows[j].chest_id;

									itemSql = connection_sync.query('SELECT id, name, rarity FROM item WHERE rarity = "' + chest_rarity + '" AND craftable = 0 ORDER BY RAND()');

									special = 0;
									item_name = itemSql[0].name;
									item_rarity = itemSql[0].rarity;
									item_id = itemSql[0].id;

									if (item_rarity == "U") {
										var randU = Math.random() * 100;
										var perc = 0;
										if (reborn <= 2) {
											perc = 5;
										} else if (reborn == 3) {
											perc = 10;
										} else if (reborn == 4) {
											perc = 15;
										} else if (reborn == 5) {
											perc = 20;
										}
										if (perc >= randU) {
											item_name = "Gemma";
											item_rarity = "ðŸ’Ž";
											special = 1;
										}
									}
									itemsArray.push(item_name + " (" + item_rarity + ")");

									if (special == 0) {
										addItem(player_id, itemSql[0].id);
									} else {
										connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
									}

									delChest(player_id, chest_id);

									opened++;
								}
							}

							var arrLen = itemsArray.join().toString();
							var plur = "i";
							if (opened == 1)
								plur = "o";
							var msg = "Hai trovato " + opened + " oggett" + plur + ":";
							var hist = {};
							var histLen = 0;
							itemsArray.map(function (a) {
								if (a in hist) {
									hist[a]++;
								} else {
									hist[a] = 1;
									histLen++;
								}
							});
							Object.keys(hist).forEach(function (key, idx) {
								msg += "\n> " + hist[key] + "x " + key;
								if (idx == histLen - 1) { // Ultima iterazione
									if (msg.length > 4000)
										msg = "Hai trovato " + opened + " oggetti!";
									bot.sendMessage(message.chat.id, msg, chestMore);
								}
							});

							setAchievement(message.chat.id, player_id, 5, opened);
						});
					};
				};
			});
		});
	});
});

bot.onText(/weekend della follia/i, function (message) {
	if (crazyMode == 0) {
		bot.sendMessage(message.chat.id, "La modalitÃ  follia non Ã¨ attiva!", back);
		return;
	}

	var bonus = "> Tutte le missioni velocizzate\n" +
		"> Ricompense scrigni doppi nelle missioni\n" +
		"> Danno raddoppiato in boss e dungeon\n" +
		"> Monete raddoppiate nelle ispezioni\n" +
		"> PossibilitÃ  maggiore di trovare U Base e missioni U!\n" +
		"> Eventi in missione particolari e curiosi\n" +
		"> Il tempo di attesa tra una stanza e l'altra del dungeon Ã¨ ridotto di 2 minuti\n" +
		"> Uccidendo i mob nel dungeon otterrai scrigni piÃ¹ rari!\n" +
		"> Nessun limite all'utilizzo di Varchi nei dungeon\n" +
		"> Ottieni una gemma per ogni missione L/E iniziata nell'evento\n" +
		"> I tempi delle ispezioni sono ridotti (non quelle iniziate dal plus)\n" +
		"> La probabilitÃ  di trovare bevande e oggetti speciali in missione Ã¨ aumentata\n" +
		"> Puoi vendere piÃ¹ oggetti al Contrabbandiere\n" +
		"> Gli incantamenti iniziati nel folle durano 1 settimana\n" +
		"> Possono essere acquistati 3 pacchetti delle Offerte Giornaliere\n" +

		"\nI bonus possono cambiare di volta in volta!";

	bot.sendMessage(message.chat.id, "*Follia!*\nQuesto evento dura fino a domenica a mezzanotte, fornendo questi *bonus*:\n\n" + bonus, back);
});

bot.onText(/evento della luna/i, function (message) {
	if (luckyMode == 0) {
		bot.sendMessage(message.chat.id, "L'evento della luna non Ã¨ attivo!", back);
		return;
	}

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Ruota della Luna"], ["Torna al menu"]]
		}
	};

	var kbBack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna all'evento della luna"], ["Torna al menu"]]
		}
	};

	var kbYesNo = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Si"], ["Torna all'evento della luna"], ["Torna al menu"]]
		}
	};

	var mode = 0;
	var d = new Date();
	if (d.getDay() == 6) {
		mode = 1;
	} else if (d.getDay() == 0) {
		mode = 2;
	} else {
		bot.sendMessage(message.chat.id, "L'evento della luna non Ã¨ attivo oggi!", back);
		return;
	}

	if (mode == 1) {
		var bonus = "Durante la giornata _odierna_ la *Luna Dorata* si erge sopra di voi e vi porge il suo lato piuÌ€ luminoso, variando la fortuna attorno a voi, donandovi questi benefici:\n\n" +
			"> Senti che troverai di meglio nelle tue *missioni* con grande probabilitaÌ€ e fortuna\n" +
			"> Avverti i consigli della Luna Dorata e ti sovvengono in sogno mete con *tesori* piu grandi\n" +
			"> Lâ€™influenza della Luna Dorata ha aumentato la possibilitaÌ€ di trovare piu *pietre*\n" +
			"> La luce della Luna Dorata dona ai viaggiatori di *Dungeon* la possibilitaÌ€ di raddoppiare il loro Rango\n" +
			"> Il *Contrabbandiere* non ama molto la Luce della Luna Dorata e questo evento raro, in vista dellâ€™aumento degli avventurieri, lo porta a valutare, in alcuni momenti, le sue offerte al doppio del prezzo\n" +
			"> *Ruota* della Luna Dorata\n" +
			"\n*Vuoi accedere alla Ruota?*";
	} else if (mode == 2) {
		var bonus = "La Luna Dorata che illuminava il vostro cammino viene invasa da una luce purpurea e la sua luce ora emette un opaco bagliore violaceo, le leggende narrano che il giorno dopo la Luna Dorata vi sia la nefasta *Luna Nera*:\n\n" +
			"> Il bagliore della Luna Nera puoÌ€ far percorrere strade oscure che miglioreranno le vostre *missioni*, ma potrebbe anche far causare brutti avvenimenti traumatici\n" +
			"> Oscuri sono i percorsi irradiati dalla Luna Nera, possono portare a maggiori *tesori* o a piccoli guadagni\n" +
			"> Lâ€™influenza della Luna Nera puoÌ€ portarvi a grandi ritrovamenti o a vicoli ciechi senza ritorno nelle Cave di *Pietre*\n" +
			"> La Luna Nera puoÌ€ dare consigli corretti o sbagliati ai viaggiatori di Dungeon che concludono le loro avventure sotto la sua influenza. Vi eÌ€ possibilitaÌ€ di raddoppiare i loro *Punti Rango* o di Annullarli\n" +
			"> Il *Contrabbandiere* adora la Luce della Luna Nera e aumenta notevolmente rispetto alla Luna Dorata la probabilitaÌ€ di raddoppiare i soldi dati per un oggetti, ma a volte puoÌ€ essere piuÌ€ guardingo e conclude in fretta le sue transazioni dimezzando il guadagno\n" +
			"> *Ruota* della Luna Nera\n" +
			"\n*Vuoi accedere alla Ruota?*";
	}

	bot.sendMessage(message.chat.id, bonus, kb);

	connection.query('SELECT id, holiday, account_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		connection.query('SELECT player_id FROM contest WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				connection.query('UPDATE player SET moon_coin = moon_coin+4 WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					connection.query('INSERT INTO contest (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Hai ricevuto 4 Monete Lunari per girare la ruota della fortuna!", mark);
					});
				});
			}
		});
	});
});

bot.onText(/ruota della luna|ruota/i, function (message) {

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna al menu"]]
		}
	};

	var kbBack = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna alla ruota"], ["Torna al menu"]]
		}
	};

	var kbYesNo = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Si"], ["Torna al menu"]]
		}
	};

	var d = new Date();
	if (luckyMode == 0) {
		if ((d.getDay() == 0) || (d.getDay() == 6)) {
			bot.sendMessage(message.chat.id, "Puoi tentare la fortuna solamente in settimana!", back);
			return;
		}
	}

	connection.query('SELECT id, holiday, account_id, exp, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var lev = Math.floor(rows[0].exp / 10);
		var reborn = rows[0].reborn;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (reborn == 1) {
			bot.sendMessage(message.chat.id, "La ruota Ã¨ utilizzabile solo dopo la Rinascita 1 (Livello 100)! Potrai tentare la fortuna vincendo interessanti premi con le ðŸŒ• trovate in giro per Lootia!", back)
			return;
		}

		connection.query('SELECT evolved, level FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var dragon_lev = 0;
			var evolved = 0;
			if (Object.keys(rows).length > 0){
				dragon_lev = rows[0].level;
				evolved = rows[0].evolved;
			}

			bot.sendMessage(message.chat.id, "Un raggio della *Luna Dorata* colpisce il luogo dove risiedi ed una ruota magica appare dinnanzi a te.\n\nNell'insenatura vi eÌ€ lo spazio per un qualcosa grande come una moneta e le iscrizioni su essa recitano le seguenti parole:\n_'Tu che sei baciato dalla Luna Dorata inserisci 2 ðŸŒ•; in essa e potrai ricevere Piu Forza (+1 Livello giocatore/drago), La mia Luce (ðŸ’Ž), PiuÌ€ Potere Arcano dalle molteplici sfaccettature (Mana di ogni tipo), Mappe del Tesoro (Molte Monete), Oggetti Unici (Scrigno Capsula), La mia luce nella tua arma, nel tuo scudo o nella tua armatura per una settimana (Incantamento su Arma,Scudo o Armatura per 7 Giorni), una grande quantitaÌ€ di Polvere, il potere dellâ€™anima per il tuo Team (ðŸ¦‹), uno spirito utile nel tuo cammino (ðŸ’ ) o se il tuo destino saraÌ€ nefasto, nulla.'_\n\nSe ti trovi giÃ  al livello massimo, quella ricompensa non potrÃ  essere ottenuta. Procedi?", kbYesNo).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase() == "si") {
						connection.query('SELECT id, moon_coin FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
							if (err) throw err;

							if (rows[0].moon_coin < 2) {
								bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸŒ•, te ne servono 2 per girare la ruota, puoi trovarle durante le missioni o ottenerle attraverso le donazioni!", kbBack);
								return;
							}

							var rand = Math.round(Math.random() * 20);
							var player_id = rows[0].id;

							var skip = 0;
							if ((lev == 100) && (reborn == 1)){
								skip = 1;
							}else if ((lev == 150) && (reborn == 2)){
								skip = 1;
							}else if ((lev == 200) && (reborn == 3)){
								skip = 1;
							}else if ((lev == 300) && (reborn == 4)){
								skip = 1;
							}else if ((lev == 1000) && (reborn == 5)){
								skip = 1;
							}

							if ((dragon_lev == 200) || ((dragon_lev == 100) && (evolved == 0)))
								skip = 2;

							var rand2 = Math.random() * 100;
							var magicN = "";
							var magic = 0;
							if (rand2 < 30) {
								magic = 1; //Blu
								magicN = "Blu";
							} else if (rand2 < 60) {
								magic = 2; //Giallo
								magicN = "Giallo";
							} else {
								magic = 3; //Rosso
								magicN = "Rosso";
							}

							connection.query('UPDATE player SET moon_coin = moon_coin-2 WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								if (rand <= 1) {
									if ((skip == 1) || (skip == 2)){
										connection.query('UPDATE player SET moon_coin = moon_coin+2 WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
										bot.sendMessage(message.chat.id, "Avresti ottenuto 1 livello, ma hai raggiunto il cap, ritira!", kbBack);
										return;
									}
									setExp(player_id, 10);
									bot.sendMessage(message.chat.id, "Hai ricevuto +1 livello!", kbBack);
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if ((rand >= 2) && (rand <= 3)) {
									if (skip == 2){
										connection.query('UPDATE player SET moon_coin = moon_coin+2 WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
										bot.sendMessage(message.chat.id, "Avresti ottenuto 1 livello drago, ma hai raggiunto il cap, ritira!", kbBack);
										return;
									}
									connection.query('UPDATE dragon SET exp = exp+70, level = level+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai ricevuto +1 livello drago!", kbBack);
										checkDragon(player_id);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if ((rand >= 4) && (rand <= 6)) {
									connection.query('UPDATE player SET gems = gems+2 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai ricevuto 2ðŸ’Ž!", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if ((rand >= 7) && (rand <= 8)) {
									connection.query('UPDATE event_mana_status SET mana_1 = mana_1+500, mana_2 = mana_2+500, mana_3 = mana_3+500 WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai ricevuto +500 Mana per tipo!", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 10) {
									connection.query('UPDATE event_mana_status SET mana_1 = mana_1+1000, mana_2 = mana_2+1000, mana_3 = mana_3+1000 WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai ricevuto +1.000 Mana per tipo!", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 11) {
									connection.query('UPDATE player SET money = money+1000000 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai ricevuto 1.000.000 Â§!", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 12) {
									addChest(player_id, 7);
									bot.sendMessage(message.chat.id, "Hai ricevuto uno Scrigno Capsula!", kbBack);
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 13) {
									var d = new Date();
									d.setHours(d.getHours() + 168);
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
									var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

									connection.query('UPDATE player SET weapon_enchant_bonus = ' + magic + ', weapon_enchant_end = "' + long_date + '", weapon_enchant = 30 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai un incantamento +30 " + magicN + " all'arma per una settimana!", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 14) {
									var d = new Date();
									d.setHours(d.getHours() + 168);
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
									var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

									connection.query('UPDATE player SET weapon2_enchant_bonus = ' + magic + ', weapon2_enchant_end = "' + long_date + '", weapon2_enchant = 30 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai un incantamento +30 " + magicN + " all'armatura per una settimana!", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 15) {
									var d = new Date();
									d.setHours(d.getHours() + 168);
									var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
									var short_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

									connection.query('UPDATE player SET weapon3_enchant_bonus = ' + magic + ', weapon3_enchant_end = "' + long_date + '", weapon3_enchant = 30 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai un incantamento +30 " + magicN + " allo scudo per una settimana!", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 16) {
									for (var i = 0; i < 200; i++) {
										addItem(player_id, 646);
									}
									bot.sendMessage(message.chat.id, "Hai ricevuto 200x Polvere!", kbBack);
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 17) {
									connection.query('SELECT team_player.team_id FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										var team_id = 0;
										if (Object.keys(rows).length > 0) {
											team_id = rows[0].team_id;
											connection.query('UPDATE team SET point = point+50 WHERE id = ' + team_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Il tuo team ha ricevuto 50x ðŸ¦‹!", kbBack);
											});
										} else {
											bot.sendMessage(message.chat.id, "Non sei in un team! Di conseguenza stavolta non ottieni nessun premio...", kbBack);
										}
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else if (rand == 18) {
									connection.query('UPDATE player SET necro_pnt = necro_pnt+1 WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai ricevuto 1 ðŸ’ !", kbBack);
									});
									setAchievement(message.chat.id, player_id, 21, 1);
								} else {
									console.log("Ruota: " + rand);
									bot.sendMessage(message.chat.id, "Purtroppo la ruota si Ã¨ fermata su un punto vuoto e non hai ricevuto nulla!", kbBack);
								}
								setAchievement(message.chat.id, player_id, 43, 1);
							});
						});
					};
				};
			});
		});
	});
});

bot.onText(/arena/i, function (message) {
	if (arena == 0) {
		bot.sendMessage(message.chat.id, "L'arena Ã¨ chiusa!", back);
		return;
	}

	var today = new Date();
	if ((today.getDay() != 6) && (today.getDay() != 0)) {
		var text = "Classifica vittorie:\n";
		var c = 1;
		var mypnt = 0;
		var totpnt = 0;
		var mypos = 0;
		var size = 20;

		connection.query('SELECT nickname, win As points FROM event_arena_status, player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) AND player.id = event_arena_status.player_id ORDER BY win DESC', function (err, rows, fields) {
			if (err) throw err;
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				if (c < size + 1) {
					rows[i].points = formatNumber(rows[i].points);
					text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].points + ")\n";
				}
				if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
					mypnt = rows[i].points;
					mypos = c;
				}
				c++;
			}
			text = text + "\nTu:\n" + mypos + "Â° " + message.from.username + " (" + mypnt + ")";

			c = 1;

			text += "\n\nClassifica sconfitte:\n";

			connection.query('SELECT nickname, lose As points FROM event_arena_status, player WHERE account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) AND player.id = event_arena_status.player_id ORDER BY lose DESC', function (err, rows, fields) {
				if (err) throw err;
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (c < size + 1) {
						rows[i].points = formatNumber(rows[i].points);
						text = text + c + "Â° " + rows[i].nickname + " (" + rows[i].points + ")\n";
					}
					if (rows[i].nickname.toLowerCase() == message.from.username.toLowerCase()) {
						mypnt = rows[i].points;
						mypos = c;
					}
					c++;
				}
				text = text + "\nTu:\n" + mypos + "Â° " + message.from.username + " (" + mypnt + ")";

				bot.sendMessage(message.chat.id, text, back_html);
			});
		});
		return;
	}

	connection.query('SELECT id, holiday, account_id, gender FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Continua all'arena"], ["Torna al menu"]]
			}
		};
		var kb2 = {
			parse_mode: "HTML",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Scegli Drago 1", "Scegli Drago 2"], ["Punta Pietre"], ["Torna al menu"]]
			}
		};
		var kb3 = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Entra nell'arena"], ["Torna al menu"]]
			}
		};
		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna all'arena"], ["Torna al menu"]]
			}
		};

		connection.query('SELECT * FROM event_arena_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				connection.query('INSERT INTO event_arena_status (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nell'Arena dei Draghi 2.0!\nIn questa arena i draghi si sfideranno, avrai l'occasione di vincere le Pietre per potenziare il tuo drago scegliendo quale sarÃ  il probabile vincitore dello scontro, inizia!", kb);
				});
			} else {

				if (rows[0].extracted == 0) {
					connection.query('SELECT id, level FROM dragon WHERE level > 10 ORDER BY RAND()', function (err, rows, fields) {
						if (err) throw err;

						var id1 = parseInt(rows[0].id);
						var level1 = parseInt(rows[0].level);

						connection.query('SELECT dragon.id, dragon.level FROM dragon, player WHERE dragon.player_id = player.id AND dragon.level BETWEEN ' + (level1 - 10) + ' AND ' + (level1 + 10) + ' AND dragon.id != ' + id1 + ' AND player.account_id NOT IN (SELECT account_id FROM banlist) ORDER BY RAND()', function (err, rows, fields) {
							if (err) throw err;

							if (Object.keys(rows).length == 0) {
								bot.sendMessage(message.chat.id, "Non sono riuscito a trovare uno sfidante valido, riprova tra poco", kbBack);
								return;
							}

							var id2 = parseInt(rows[0].id);
							var level2 = parseInt(rows[0].level);

							var landType = 0;
							var landRand = Math.random() * 60;
							if (landRand < 10) {
								landType = 1;
							} else if (landRand < 20) {
								landType = 2;
							} else if (landRand < 30) {
								landType = 3;
							} else if (landRand < 40) {
								landType = 4;
							} else if (landRand < 50) {
								landType = 5;
							} else {
								landType = 6;
							}

							var now = new Date();
							now.setMinutes(now.getMinutes() + Math.round(Math.random() * 15 + 15));
							var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
							var short_time = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + ":" + addZero(now.getSeconds());

							connection.query('UPDATE event_arena_status SET extracted = 1, dragon_1 = ' + id1 + ', dragon_2 = ' + id2 + ', land_type = ' + landType + ', fight_time = "' + long_date + '" WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "I draghi sfidanti sono stati estratti!", kb3);
							});
						});
					});
				} else {

					var d1 = rows[0].dragon_1;
					var d2 = rows[0].dragon_2;
					var choice = rows[0].choice;
					var bet_id = rows[0].bet_id;
					var landType = rows[0].land_type;

					var d = new Date(rows[0].fight_time);
					var short_time = addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + ":" + addZero(d.getSeconds());

					connection.query('SELECT id, name, level, type FROM dragon WHERE id = ' + d1, function (err, rows, fields) {
						if (err) throw err;

						var name1 = rows[0].name;
						var type1 = rows[0].type;
						var id = rows[0].id;
						var level1 = rows[0].level;

						connection.query('SELECT name, level, type FROM dragon WHERE id = ' + d2, function (err, rows, fields) {
							if (err) throw err;

							var name2 = rows[0].name;
							var type2 = rows[0].type;
							var level2 = rows[0].level;

							var landDesc = "";
							if (landType == 1) {
								landDesc = "Scottatura";
							} else if (landType == 2) {
								landDesc = "Congelamento;"
							} else if (landType == 3) {
								landDesc = "Avvelenamento";
							} else if (landType == 4) {
								landDesc = "Sonno";
							} else if (landType == 5) {
								landDesc = "Rallentamento";
							} else {
								landDesc = "Terrore";
							}

							if (choice == 0) {
								choice = "-";
							} else if (choice == 1) {
								choice = "â‘ ";
							} else if (choice == 2) {
								choice = "â‘¡";
							}

							bot.sendMessage(message.chat.id, "La prossima Sfida si tiene in un'Arena con un terreno che provoca <b>" + landDesc + "</b> " + landSym(landType) + " tra:\n\n" +
											"â‘  <b>" + name1 + " " + type1 + "</b> (LV " + level1 + ") " + dragonSym(type1) + "\n\n" +
											"               âš”ï¸\n\n" +
											"â‘¡ <b>" + name2 + " " + type2 + "</b> (LV " + level2 + ") " + dragonSym(type2) + "\n\n" +
											"Hai puntato su: " + choice + "\n\n" +
											"Lo scontro inizierÃ  alle " + short_time, kb2).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Torna al menu") {
										return;
									}

									connection.query('SELECT extracted FROM event_arena_status WHERE player_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;

										if (rows[0].extracted == 0) {
											bot.sendMessage(message.chat.id, "I draghi non sono ancora stati estratti!", kbBack);
											return;
										}

										if (answer.text == "Scegli Drago 1") {
											connection.query('UPDATE event_arena_status SET choice = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai scelto il drago 1!", kbBack);
											});
										} else if (answer.text == "Scegli Drago 2") {
											connection.query('UPDATE event_arena_status SET choice = 2 WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai scelto il drago 2!", kbBack);
											});
										} else if (answer.text == "Punta Pietre") {
											if (choice == 0) {
												bot.sendMessage(message.chat.id, "Prima scegli il drago su cui puntare!", kbBack);
												return;
											}
											if (bet_id != 0) {
												bot.sendMessage(message.chat.id, "Hai giÃ  puntato su questo scontro!", kbBack);
												return;
											}
											bot.sendMessage(message.chat.id, "Specifica la pietra che vuoi puntare sul drago scrivendo il codice, " +
															"se vinci otterrai 2 pietre del tipo puntato, altrimenti la perderai. A volte puoi vincerne anche 3.\n" +
															"Pietra Anima di Legno -> 1\n" +
															"Pietra Anima di Ferro -> 2\n" +
															"Pietra Anima Preziosa -> 3\n" +
															"Pietra Cuore di Diamante -> 4\n" +
															"Pietra Cuore Leggendario -> 5\n" +
															"Pietra Spirito Epico -> 6\n\n" +
															"Attenzione, puoi puntare solamente una volta", kbBack).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													if ((answer.text == "Torna all'arena") || (answer.text == "Torna al menu")) {
														return;
													}

													var stone = (67 + parseInt(answer.text));
													if ((parseInt(answer.text) < 1) || (parseInt(answer.text) > 6) || (re.test(parseInt(answer.text)) == false)) {
														bot.sendMessage(message.chat.id, "Codice pietra non valido!", kbBack);
														return;
													}
													var qnt = 1;

													if (getItemCnt(player_id, stone) < qnt) {
														bot.sendMessage(message.chat.id, "Non hai abbastanza pietre di quel tipo", kbBack);
														return;
													}

													delItem(player_id, stone, qnt);
													connection.query('UPDATE event_arena_status SET bet_id = ' + stone + ', bet_qnt = ' + qnt + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(message.chat.id, "Puntata completata!", kbBack);
													});
												};
											});
										}
									});
								};
							});
						});
					});
				}
			};
		});
	});
});

function dragonSym(type) {
	if (type == "delle Montagne") {
		return "ðŸ”";
	} else if (type == "dei Cieli") {
		return "â˜ï¸";
	} else if (type == "Infernale") {
		return "ðŸ”¥";
	} else if (type == "dell'OscuritÃ ") {
		return "ðŸ”®";
	} else if (type == "dei Mari") {
		return "ðŸŒŠ";
	} else if (type == "dei Ghiacci") {
		return "â„ï¸";
	}
}

function dragonSymId(type) {
	if (type == 2) {
		return "ðŸ”";
	} else if (type == 5) {
		return "â˜ï¸";
	} else if (type == 3) {
		return "ðŸ”¥";
	} else if (type == 4) {
		return "ðŸ”®";
	} else if (type == 1) {
		return "ðŸŒŠ";
	} else if (type == 6) {
		return "â„ï¸";
	}
}

function landSym(type) {
	if (type == 1) {
		return "ðŸ’¥";
	} else if (type == 2) {
		return "â›„ï¸";
	} else if (type == 3) {
		return "ðŸ’€";
	} else if (type == 4) {
		return "ðŸ’¤";
	} else if (type == 5) {
		return "ðŸš¶";
	} else if (type == 6) {
		return "ðŸ‘º";
	}
}

function setFinishedArena(element, index, array) {
	var watcher_id = element.player_id;
	var chat_id = element.chat_id;

	connection.query('SELECT player_id, win, lose, land_type, dragon_1, dragon_2, choice, bet_id, bet_qnt FROM event_arena_status WHERE player_id = ' + watcher_id, function (err, rows, fields) {
		if (err) throw err;

		var dragon1 = rows[0].dragon_1;
		var dragon2 = rows[0].dragon_2;
		var choice = rows[0].choice;
		var landType = rows[0].land_type;
		var bet_id = rows[0].bet_id;
		var bet_qnt = rows[0].bet_qnt;
		var win = rows[0].win;
		var lose = rows[0].lose;

		if (choice == 0) {
			connection.query('UPDATE event_arena_status SET extracted = 0, dragon_1 = 0, dragon_2 = 0, land_type = 0, choice = 0, bet_id = 0, bet_qnt = 0, fight_time = NULL WHERE player_id = ' + watcher_id, function (err, rows, fields) {
				if (err) throw err;
				bot.sendMessage(chat_id, "Tempo scaduto per la selezione del drago preferito, torna all'arena per assistere ad un altro scontro");
			});
			return;
		}

		connection.query('SELECT * FROM dragon WHERE id = ' + dragon1, function (err, rows, fields) {
			if (err) throw err;

			var myId = rows[0].id;
			var name1 = rows[0].name;
			if (name1.lenght > 30) {
				name1 = name1.substring(0, 30) + "...";
			}
			var myLife = Math.round(parseInt(rows[0].exp * 10));
			var totMyLife = myLife;
			var myDmg = parseInt(rows[0].damage) + parseInt(rows[0].claws);
			var myCrit = parseInt(rows[0].critical);
			var myType = rows[0].type;
			var player_id1 = rows[0].player_id;

			connection.query('SELECT class, chat_id, charm_id, reborn FROM player WHERE id = ' + player_id1, function (err, rows, fields) {
				if (err) throw err;

				var reborn = rows[0].reborn;
				var class_id = rows[0].class;
				var charm_id = rows[0].charm_id;
				var chat_id1 = rows[0].chat_id;

				if (charm_id == 602) {
					myDmg += 25;
					myCrit += 10;
				}
				if (charm_id == 695) {
					myDmg += 30;
					myCrit += 15;
				}

				if ((class_id == 7) && (reborn == 3)) {
					myCrit += 5;
				}
				if ((class_id == 7) && (reborn >= 4)) {
					myCrit += 7;
				}

				connection.query('SELECT * FROM dragon WHERE id = ' + dragon2, function (err, rows, fields) {
					if (err) throw err;

					var enemyId = rows[0].player_id;
					var name2 = rows[0].name;
					if (name2.lenght > 30) {
						name2 = name2.substring(0, 30) + "...";
					}
					var enemyLife = Math.round(parseInt(rows[0].exp * 10));
					var enemyDmg = parseInt(rows[0].damage) + parseInt(rows[0].claws);
					var enemyCrit = parseInt(rows[0].critical);
					var enemyType = rows[0].type;
					var player_id2 = rows[0].player_id;

					connection.query('SELECT class, chat_id, charm_id, reborn FROM player WHERE id = ' + player_id2, function (err, rows, fields) {
						if (err) throw err;

						var reborn2 = rows[0].reborn;
						var class_id2 = rows[0].class;
						var enemyCharm_id = rows[0].charm_id;
						var chat_id2 = rows[0].chat_id;

						if (enemyCharm_id == 602) {
							enemyDmg += 25;
							enemyCrit += 10;
						}
						if (enemyCharm_id == 695) {
							enemyDmg += 30;
							enemyDmg += 15;
						}
						if ((class_id2 == 7) && (reborn2 == 3)) {
							enemyCrit += 5;
						}
						if ((class_id2 == 7) && (reborn2 >= 4)) {
							enemyCrit += 7;
						}

						var totEnemyLife = enemyLife;

						var rDmg = 0;
						var rDmg2 = 0;
						var killed = 0;
						var code = 0;
						var rand = 0;

						var landRand = 0;
						var landDesc = "";

						var critTxt1 = "";
						var critTxt2 = "";

						if (landType == 1) {
							landDesc = "Scottatura";
						} else if (landType == 2) {
							landDesc = "Congelamento;"
						} else if (landType == 3) {
							landDesc = "Avvelenamento";
						} else if (landType == 4) {
							landDesc = "Sonno";
						} else if (landType == 5) {
							landDesc = "Rallentamento";
						} else {
							landDesc = "Terrore";
						}

						var weak = 0;

						if ((myType == "dell'OscuritÃ ") && (enemyType == "dei Ghiacci")) {
							myDmg = myDmg * 1.5;
						}
						if ((myType == "dell'OscuritÃ ") && (enemyType == "dei Cieli")) {
							enemyDmg = enemyDmg * 1.5;
							weak = 1;
						}

						if ((myType == "dei Ghiacci") && (enemyType == "dei Cieli")) {
							myDmg = myDmg * 1.5;
						}
						if ((myType == "dei Ghiacci") && (enemyType == "Infernale")) {
							enemyDmg = enemyDmg * 1.5;
							weak = 1;
						}

						if ((myType == "dei Mari") && (enemyType == "Infernale")) {
							myDmg = myDmg * 1.5;
						}
						if ((myType == "dei Mari") && (enemyType == "delle Montagne")) {
							enemyDmg = enemyDmg * 1.5;
							weak = 1;
						}

						if ((myType == "dei Cieli") && (enemyType == "dell'OscuritÃ ")) {
							myDmg = myDmg * 1.5;
						}
						if ((myType == "dei Cieli") && (enemyType == "dei Ghiacci")) {
							enemyDmg = enemyDmg * 1.5;
							weak = 1;
						}

						if ((myType == "delle Montagne") && (enemyType == "dei Mari")) {
							myDmg = myDmg * 1.5;
						}
						if ((myType == "delle Montagne") && (enemyType == "dell'OscuritÃ ")) {
							enemyDmg = enemyDmg * 1.5;
							weak = 1;
						}

						if ((myType == "Infernale") && (enemyType == "delle Montagne")) {
							myDmg = myDmg * 1.5;
						}
						if ((myType == "delle Montagne") && (enemyType == "dei Mari")) {
							enemyDmg = enemyDmg * 1.5;
							weak = 1;
						}

						var actions = [];

						actions.push("La salute di " + name2 + " " + dragonSym(enemyType) + " Ã¨ *" + totEnemyLife + "* hp, quella di " + name1 + " " + dragonSym(myType) + " Ã¨ *" + totMyLife + "* hp");
						actions.push("Lo scontro avviene su un terreno che provoca *" + landDesc + "* " + landSym(landType));
						actions.push("<=>");

						var nextNull = 0;
						var nextMid = 0;
						var nextCrit = 0;
						var nextWeak = 0;

						var nextNull2 = 0;
						var nextMid2 = 0;
						var nextCrit2 = 0;
						var nextWeak2 = 0;

						var landRandB = 0;
						var landRandB2 = 0;
						var landDmg = 0;
						var landDmg2 = 0;

						var hits = 0;
						var hits2 = 0;

						var hit_arr = ["ferisce", "sfregia", "squarta", "urta", "infilza"];
						var hit_len = Object.keys(hit_arr).length;

						while (killed == 0) {
							landRandB = Math.random() * 100;
							landRandB2 = Math.random() * 100;

							if (nextNull == 1) {
								actions.push(name1 + " non Ã¨ riuscito a colpire l'avversario!");
								nextNull = 0;
							} else {
								hits2++;

								rDmg = Math.round(Math.random() * (myDmg * 2) + myDmg);
								if (nextWeak == 1) {
									landDmg = (rDmg / 100) * 10;
									rDmg -= landDmg;
									nextWeak = 0;
								}

								if (nextMid2 == 1) {
									rDmg = rDmg / 2;
									nextMid = 0;
								}

								rDmg = Math.round(rDmg);
								enemyLife = Math.round(enemyLife - rDmg);

								// drago 2 >> drago 1

								landDmg2 = (rDmg / 100) * 10;
								landDmg2 = Math.round(landDmg2);

								if ((landType == 1) && (enemyType != "Infernale")) {
									if (landRandB2 < 50) {
										actions.push("Per *Scottatura*, " + name2 + " subisce ulteriori " + landDmg2 + " danni");
										rDmg += landDmg;
									}
								}
								if ((landType == 2) && (enemyType != "dei Ghiacci")) {
									if (landRandB2 < 40) {
										actions.push("Per *Congelamento*, " + name2 + " viene paralizzato dal freddo");
										nextNull = 1;
									}
								}
								if ((landType == 3) && (enemyType != "delle Montagne")) {
									if (landRandB2 < 50) {
										actions.push("Per *Avvelenamento*, " + name2 + " ha il danno dimezzato");
										nextMid = 1;
									}
								}
								if ((landType == 4) && (enemyType != "dei Cieli")) {
									if (landRandB2 < 40) {
										actions.push("Per *Sonno*, " + name2 + " subisce un danno critico");
										nextCrit = 1;
									}
								}
								if ((landType == 5) && (enemyType != "dei Mari")) {
									if (landRandB2 < 50) {
										actions.push("Per *Rallentamento*, il danno di " + name2 + " sarÃ  piÃ¹ debole");
										nextWeak = 1;
									}
								}
								if ((landType == 6) && (enemyType != "dell'OscuritÃ ")) {
									if (landRandB2 < 40) {
										actions.push("Per *Terrore*, " + name2 + " rimane paralizzato");
										nextNull = 1;
									}
								}

								rand = Math.random() * 100;
								if (rand <= myCrit) {
									rDmg = rDmg * 2;
									critTxt1 = "Danno Critico!";
								} else {
									critTxt1 = "";
								}

								actions.push(name1 + " " + hit_arr[Math.round(Math.random() * hit_len) - 1] + " il drago avversario -" + rDmg + " (" + enemyLife + " hp) " + critTxt1);
							}

							if (enemyLife <= 0) {
								killed = 1;
								code = 1;
								actions.push("*" + name1 + " Ã¨ il vincitore*! (" + hits + " turni)");
							} else {
								if (nextNull2 == 1) {
									actions.push(name2 + " non Ã¨ riuscito a colpire l'avversario!");
									nextNull2 = 0;
								} else {
									hits++;

									rDmg2 = Math.round(Math.random() * (enemyDmg * 2) + enemyDmg);
									if (nextWeak2 == 1) {
										landDmg = (rDmg / 100) * 10;
										rDmg2 -= landDmg;
										nextWeak2 = 0;
									}

									if (nextMid2 == 1) {
										rDmg2 = rDmg2 / 2;
										nextMid2 = 0;
									}

									// drago 1 >> drago 2

									landDmg = (rDmg2 / 100) * 10;
									landDmg = Math.round(landDmg);

									if ((landType == 1) && (myType != "Infernale")) {
										if (landRandB < 50) {
											actions.push("Per *Scottatura*, " + name1 + " subisce ulteriori " + landDmg + " danni");
											rDmg2 += landDmg;
										}
									}
									if ((landType == 2) && (myType != "dei Ghiacci")) {
										if (landRandB < 40) {
											actions.push("Per *Congelamento*, " + name1 + " 1 viene paralizzato dal freddo");
											nextNull2 = 1;
										}
									}
									if ((landType == 3) && (myType != "delle Montagne")) {
										if (landRandB < 50) {
											actions.push("Per *Avvelenamento*, " + name1 + " ha il danno dimezzato");
											nextMid2 = 1;
										}
									}
									if ((landType == 4) && (myType != "dei Cieli")) {
										if (landRandB < 40) {
											actions.push("Per *Sonno*, " + name1 + " subisce un danno critico");
											nextCrit2 = 1;
										}
									}
									if ((landType == 5) && (myType != "dei Mari")) {
										if (landRandB < 50) {
											actions.push("Per *Rallentamento*, il danno di " + name1 + " sarÃ  piÃ¹ debole");
											nextWeak2 = 1;
										}
									}
									if ((landType == 6) && (myType != "dell'OscuritÃ ")) {
										if (landRandB < 40) {
											actions.push("Per *Terrore*, " + name1 + " rimane paralizzato");
											nextNull2 = 1;
										}
									}

									rand = Math.random() * 100;
									if ((rand <= enemyCrit) || (nextCrit2 == 1)) {
										rDmg2 = rDmg2 * 2;
										critTxt2 = "Danno Critico!";
										nextCrit2 = 0;
									} else {
										critTxt2 = "";
									}

									myLife = Math.round(myLife - rDmg2);
									rDmg2 = Math.round(rDmg2);

									actions.push(name2 + " " + hit_arr[Math.round(Math.random() * hit_len) - 1] + " il drago avversario -" + rDmg2 + " (" + myLife + " hp) " + critTxt2);
								}
							};

							if (myLife <= 0) {
								killed = 1;
								code = 2;
								actions.push("*" + name2 + " Ã¨ il vincitore*! (" + hits2 + " turni)");
							}
						}

						var len = parseInt(Object.keys(actions).length);
						var battle = "";

						if (len > 60) {
							actions.splice(20, (len - 40));
							actions.splice(21, 0, "(...)");
							len = Object.keys(actions).length;
						}

						for (var i = 0; i < len; i++) {
							battle += actions[i] + "\n";
						}
						bot.sendMessage(chat_id, battle, mark);

						if (code == choice) {
							connection.query('UPDATE event_arena_status SET extracted = 0, win = win+1, dragon_1 = 0, dragon_2 = 0, land_type = 0, choice = 0, bet_id = 0, bet_qnt = 0, fight_time = NULL WHERE player_id = ' + watcher_id, function (err, rows, fields) {
								if (err) throw err;

								connection.query('SELECT name FROM item WHERE id = ' + bet_id, function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length == 0) {
										var stone = (67 + Math.round(Math.random() * 5 + 1));

										addItem(watcher_id, stone);
										connection.query('SELECT name FROM item WHERE id = ' + stone, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(chat_id, "Hai vinto e ottenuto " + rows[0].name + "!\nTorna all'arena per fare la prossima scelta!");
										});
									} else {

										var qnt = bet_qnt * 2;
										var rand_bonus = Math.random() * 100;
										var extra = "";
										if (rand_bonus < 5) {
											qnt++;
											extra = " BONUS";
										}

										addItem(watcher_id, bet_id, qnt);
										bot.sendMessage(chat_id, "*Hai vinto* e ottenuto " + qnt + "x *" + rows[0].name + "*" + extra + "!\nTorna all'arena per fare la prossima scelta!", mark);
									}

									if ((parseInt(win) + 1) % 10 == 0) {
										var chest = Math.round(Math.random() * 2 + 3);

										addChest(watcher_id, chest);
										connection.query('SELECT name FROM name WHERE id = ' + chest, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(chat_id, "Come bonus per le vittorie ottenute hai vinto anche uno " + rows[0].name + "!");
										});
									}
								});
							});
						} else {
							connection.query('UPDATE event_arena_status SET extracted = 0, lose = lose+1, dragon_1 = 0, dragon_2 = 0, land_type = 0, choice = 0, bet_id = 0, bet_qnt = 0, fight_time = NULL WHERE player_id = ' + watcher_id, function (err, rows, fields) {
								if (err) throw err;
								connection.query('SELECT name FROM item WHERE id = ' + bet_id, function (err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0) {
										bot.sendMessage(chat_id, "*Hai perso!*\nTorna all'arena per fare la prossima scelta!", mark);
									} else {
										bot.sendMessage(chat_id, "*Hai perso* e hai lasciato " + bet_qnt + "x " + rows[0].name + " alla segreteria dell'arena!\nTorna all'arena per fare la prossima scelta!", mark);
									}
								});
							});
						}

						//1 per drago 1, 2 per drago 2

						var dragon_win = 0;
						var dragon_lose = 0;

						if (choice == 1) {
							dragon_win = dragon1;
							dragon_lose = dragon2;

							connection.query('UPDATE player SET money = money+1000 WHERE id = ' + player_id1, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id1, "Il tuo drago ha ottenuto una vittoria nell'arena! Hai vinto 1.000 Â§!");
							});
						} else {
							dragon_win = dragon2;
							dragon_lose = dragon1;

							connection.query('UPDATE player SET money = money+1000 WHERE id = ' + player_id2, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id2, "Il tuo drago ha ottenuto una vittoria nell'arena! Hai vinto 1.000 Â§!");
							});
						}

						connection.query('SELECT dragon_id FROM event_arena_dragon WHERE dragon_id = ' + dragon_win, function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0) {
								connection.query('INSERT INTO event_arena_dragon (dragon_id, win, lose) VALUES (' + dragon_win + ', 1, 0)', function (err, rows, fields) {
									if (err) throw err;
								});
							} else {
								connection.query('UPDATE event_arena_dragon SET win = win+1 WHERE dragon_id = ' + dragon_win, function (err, rows, fields) {
									if (err) throw err;
								});
							}
						});
						connection.query('SELECT dragon_id FROM event_arena_dragon WHERE dragon_id = ' + dragon_lose, function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0) {
								connection.query('INSERT INTO event_arena_dragon (dragon_id, win, lose) VALUES (' + dragon_lose + ', 0, 1)', function (err, rows, fields) {
									if (err) throw err;
								});
							} else {
								connection.query('UPDATE event_arena_dragon SET lose = lose+1 WHERE dragon_id = ' + dragon_lose, function (err, rows, fields) {
									if (err) throw err;
								});
							}
						});
					});
				});
			});
		});
	});
};

bot.onText(/affronta boss|^scalata boss|^boss/i, function (message) {
	var iKeys = [];
	var boss = "";
	var team_id = 0;
	calcLife(message);

	var bossKb = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Affronta Boss"], ["Torna al menu"]]
		}
	};

	var bossKb2 = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Visualizza Boss"], ["Torna al menu"]]
		}
	};

	connection.query('SELECT team_player.team_id, team_player.kill_streak, COUNT(*) As num FROM `player`, team_player WHERE player.nickname = "' + message.from.username + '" AND team_player.player_id = player.id', function (err, rows, fields) {
		if (err) throw err;
		var team_id = 0;
		if (rows[0].num > 0) {
			team_id = rows[0].team_id;
		} else {
			bot.sendMessage(message.chat.id, "Puoi affrontare i boss solo se sei in un team.", back);
			return;
		}

		//fixBoss(team_id);

		var kill_streak = rows[0].kill_streak;

		connection.query('SELECT players FROM team WHERE id = ' + team_id, function (err, rows, fields) {
			if (err) throw err;

			if ((rows[0].players < 3) && (team_id != 2)) {
				bot.sendMessage(message.chat.id, "Il team deve possedere almeno 3 membri.", back);
				return;
			}

			connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
				if (err) throw err;
				var player_id = rows[0].id;
				var boss_id = rows[0].boss_id;
				var money = rows[0].money;
				var boss_time = rows[0].boss_time;
				var player_exp = rows[0].exp;
				var player_life = rows[0].life;
				var player_total_life = rows[0].total_life;
				var craft_count = rows[0].craft_count;
				var reborn = rows[0].reborn;
				var class_id = rows[0].class;
				var kill_streak_ok = rows[0].kill_streak_ok;

				var banReason = isBanned(rows[0].account_id);
				if (banReason != null) {
					var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
					bot.sendMessage(message.chat.id, text, mark);
					return;
				}
				if (rows[0].holiday == 1) {
					bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
					return;
				}

				if (player_id != 1) {
					if ((class_id == 1) && (reborn >= 3)) {
						bot.sendMessage(message.chat.id, "Raggiunta questa Rinascita la Vocazione Ã¨ obbligatoria, la puoi scegliere nella sezione Giocatore > Vocazione", back);
						return;
					}
				}

				if ((kill_streak >= 20) && (kill_streak_ok == 0)) {
					connection.query('UPDATE player SET kill_streak_ok = 1 WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
					});
				}

				helpMsg(message.chat.id, player_id, 3);

				if (rows[0].mission_id != 0) {
					bot.sendMessage(message.chat.id, "Non puoi affrontare i boss finchÃ¨ sei in missione.", bossKb2);
					return;
				}

				/*
				if (rows[0].mission_party > 0) {
					bot.sendMessage(message.chat.id, "Incarico in corso! Attendi il termine prima di avviare uno scontro contro un boss.", back)
					return;
				}
				*/

				if ((rows[0].travel_id != 0) || (rows[0].cave_id != 0)) {
					if (rows[0].travel_id != 0) {
						var time = new Date(rows[0].travel_time_end);
					} else {
						var time = new Date(rows[0].cave_time_end);
					}
					bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth() + 1) + "/" + time.getFullYear(), bossKb2);
					return;
				}

				if (player_life <= 0) {
					bot.sendMessage(message.chat.id, "Non hai abbastanza salute per combattere contro il boss! Riprova domani.", revive);
					return;
				}

				if (boss_time != null) {
					var time = new Date(boss_time);
					bot.sendMessage(message.chat.id, "Non puoi ancora affrontare i boss, ti sei appena trasferito (" + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth() + 1) + "/" + time.getFullYear() + ")", back);
					return;
				}

				if (Math.floor(player_exp / 10) < 5) {
					bot.sendMessage(message.chat.id, "Il tuo danno a questo livello Ã¨ troppo basso, non puoi procedere fino al raggiungimento del livello 5", back);
					return;
				}

				if (boss_id == null) {
					connection.query('SELECT team.boss_count, boss_team.life, boss_team.total_life, boss_team.killedby, boss_team.killeddate, team.boss_respawn, boss.name FROM team, boss_team, boss WHERE team.id = team_id AND boss_team.boss_id = boss.id AND unlocked = 1 AND team_id = ' + team_id + ' ORDER BY boss_id', function (err, rows, fields) {
						if (err) throw err;

						var boss_list = "\n";
						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "Il tuo team non Ã¨ ancora abilitato a visualizzare i boss, segnala all'amministratore.", back);
							return;
						}
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].life <= 0) {
								if (rows[i].killeddate != null) {
									var d = new Date(rows[i].killeddate);
									var short_date = addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1);
								} else {
									var short_date = "?";
								}
								boss_list += (i + 1) + ". <b>" + rows[i].name + "</b> (" + rows[i].killedby + " alle " + short_date + ")\n";
							} else {
								iKeys.push(["Affronta boss: " + rows[i].name]);
								boss_list += (i + 1) + ". <b>" + rows[i].name + "</b> (" + rows[i].life + "/" + rows[i].total_life + " hp)\n";
							}
						}
						if (rows[0].boss_respawn != null) {
							var d = new Date(rows[0].boss_respawn);
							var short_time = addZero(d.getHours()) + ":" + addZero(d.getMinutes());
							var short_date = addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

							boss_list += "\nI boss tornano in vita il " + short_date + " alle " + short_time;
						}

						var boss_count = rows[0].boss_count;
						if (validTeamMember(team_id, player_id) == 0) {
							bot.sendMessage(message.chat.id, "Il tuo team non Ã¨ abbastanza bilanciato, non puoi affrontare i boss", back);
							return;
						}

						iKeys.push(["Torna al menu"]);

						if (message.text.indexOf(":") != -1) {
							var boss = message.text.substring(message.text.indexOf(":") + 1).trim();

							connection.query('SELECT boss_team.id, boss.description, boss.name, boss_team.boss_id FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND unlocked = 1 AND team_id = ' + team_id + ' AND name = "' + boss + '" AND life > 0', function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0) {
									bot.sendMessage(message.chat.id, "Questo boss non Ã¨ valido!", back);
									return;
								}

								var boss_id = rows[0].id;
								var boss_id2 = rows[0].boss_id;
								var desc = "";
								if (rows[0].description != null)
									desc = rows[0].description + "\n\n";

								var name = rows[0].name;
								connection.query('SELECT boss_team.id FROM boss_team WHERE unlocked = 1 AND team_id = ' + team_id + ' AND boss_team.boss_id < ' + boss_id2, function (err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length < boss_id2-1) {
										bot.sendMessage(message.chat.id, "Devi prima affrontare tutti i boss precedenti!", back);
										return;
									}

									connection.query('UPDATE player SET boss_id = ' + boss_id + ' WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, desc + "Hai deciso di affrontare <b>" + name + "</b>!", bossKb);
									});
								});
							});

							connection.query('SELECT MAX(boss_id) As max FROM boss_team WHERE team_id = ' + team_id, function (err, rows, fields) {
								if (err) throw err;
								if (parseInt(rows[0].max) < 31) {
									console.log("Boss massimo: " + rows[0].max);
									connection.query('SELECT * FROM boss WHERE id > ' + rows[0].max, function (err, rows, fields) {
										if (err) throw err;
										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											if (rows[i].id == 1) {
												connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',1,' + team_id + ')', function (err, rows, fields) {
													if (err) throw err;
												});
											} else {
												connection.query('INSERT INTO `boss_team`(`id`, `boss_id`, `life`, `total_life`, `unlocked`, `team_id`) VALUES (DEFAULT,' + rows[i].id + ',' + rows[i].total_life + ',' + rows[i].total_life + ',0,' + team_id + ')', function (err, rows, fields) {
													if (err) throw err;
												});
											}
											console.log("Boss mancante aggiunto: " + rows[i].id);
										}
									});
								}
							});

							return;
						};

						var kb = {
							parse_mode: "HTML",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						bot.sendMessage(message.chat.id, "Seleziona il boss, i partecipanti ricevono il bottino in base al danno.\nI boss tornano in vita ogni 48 ore dopo aver ucciso il primo.\nPer sbloccare i boss successivi, il tuo team deve sconfiggerli in ordine.\n" + boss_list, kb);
					});
				} else {
					connection.query('SELECT boss_team.life, boss_team.total_life, boss.name, boss_team.unlocked FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND boss_team.id = ' + boss_id, function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0) {
							bot.sendMessage(message.chat.id, "Errore misterioso, contatta l'admin per segnalarlo.", back);
							return;
						}

						if (rows[0].unlocked == 0) {
							connection.query('UPDATE `player` SET `boss_id`=0 WHERE `id`=' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Sei pronto a tornare a sfidare il boss!", bossKb);
							});
							return;
						}

						var boss_life = rows[0].life;

						connection.query('UPDATE `player` SET magic_to = 1, dragon_to = 1 WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});

						var kb = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Attacco Leggero", "Attacco Pesante"], ["Incantesimi"], ["Utilizzabili Boss"], ["Visualizza Boss", "Trasmogrificazione"], ["Torna al menu"]]
							}
						};

						bot.sendMessage(message.chat.id, "*La tua salute*: " + player_life + " / " + player_total_life + "\n*Salute " + rows[0].name + "*: " + rows[0].life + " / " + rows[0].total_life + "\nCosa vuoi fare?", kb);
					});
				};
			});
		});
	});
});

bot.onText(/\/checkMember (.+)/i, function (message, match) {
	connection.query('SELECT id FROM player WHERE nickname = "' + match[1] + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		connection.query('SELECT team_id FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(message.chat.id, "Valido: " + validTeamMember(rows[0].team_id, player_id));
			console.log(validTeamMember(rows[0].team_id, player_id));
		});
	});
});

function validTeamMember(team_id, player_id) {

	// Controlla la coerenza col plus!

	const rows = connection_sync.query('SELECT player.id As player_id, team.kill_num1, team.kill_num2, team.name, player.reborn, player.nickname, FLOOR(player.exp/10) As level FROM team, team_player, player WHERE team.id = team_player.team_id AND team_player.player_id = player.id AND team.id = ' + team_id + ' ORDER BY player.reborn, player.exp DESC');

	var mediaTeam = 0;
	for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
		mediaTeam += parseInt(getRealLevel(rows[i].reborn, rows[i].level));
	}
	mediaTeam = mediaTeam / Object.keys(rows).length;

	var sum = 0;
	var lev = 0;
	var dev = 0;
	var calc = 0;
	for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
		lev = getRealLevel(rows[i].reborn, rows[i].level);
		sum += Math.pow(Math.abs(mediaTeam - lev), 2);
	}
	dev = Math.sqrt(sum / Object.keys(rows).length);

	var soglia = 2.9;
	if (rows[0].kill_num2 >= 30)
		soglia = 3.5;

	for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
		if (player_id == rows[i].player_id) {
			lev = getRealLevel(rows[i].reborn, rows[i].level);
			calc = Math.round((lev - mediaTeam) / dev * 100) / 100;
			if (isNaN(calc) || (calc < 0))
				calc = 0;
			if (calc > soglia) {
				return 0;
			} else {
				return 1;
			}
		}
	}
};

bot.onText(/^Incantesimi$/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var to = rows[0].magic_to;

		if (to == 0) {
			return;
		}

		var text = "Incantesimi:\n" +
			"*Furia dei Mari*: Ricarica la salute e riflette il colpo in base al danno subito\n" +
			"*Tempesta Folgorante*: Paralizza il bersaglio per alcuni turni\n" +
			"*Impeto di Fiamme*: Infligge un notevole danno al bersaglio\n" +
			"*Ira Astrale*: Aumenta la probabilitÃ  di critico per alcuni turni (dal turno successivo)\n" +
			"\nSe gli incantesimi vengono applicati al boss, ne beneficiano tutti i giocatori che lo attaccano.";

		connection.query('DELETE FROM magic WHERE quantity <= 0 AND player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			connection.query('SELECT type, power, quantity FROM magic WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				if (Object.keys(rows).length > 0) {
					var n = "";
					var iKeys = [];
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						if (rows[i].type == 1) {
							n = "Furia dei Mari";
						} else if (rows[i].type == 2) {
							n = "Tempesta Folgorante";
						} else if (rows[i].type == 3) {
							n = "Impeto di Fiamme";
						} else if (rows[i].type == 4) {
							n = "Ira Astrale";
						}
						iKeys.push(["Lancia " + n + " " + rows[i].power + " (" + rows[i].quantity + ")"]);
					}

					if (to == 1) {
						iKeys.push(["Affronta Boss"]);
					} else if (to == 2) {
						iKeys.push(["Torna al Dungeon"]);
					}
					iKeys.push(["Torna al menu"]);

					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					var extra = "";
					if (to == 1) {
						extra = "il boss";
					} else if (to == 2) {
						extra = "il mostro";
					}

					bot.sendMessage(message.chat.id, text + "\nSeleziona l'incantesimo da utilizzare contro " + extra + "!", kb);
				} else {
					var kb = {
						parse_mode: "Markdown",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Affronta Boss"], ["Dungeon"], ["Torna al menu"]]
						}
					};
					bot.sendMessage(message.chat.id, text + "\n\nNon possiedi alcun incantesimo, puoi ottenerli attraverso la Sintesi!", kb);
					return;
				}
			});
		});
	});
});

bot.onText(/^Attacco leggero|^Attacco pesante|^Lancia ([a-zA-Z ]+) ([0-9]+)/i, function (message, match) {

	var bossKb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Affronta Boss"], ["Torna al menu"]]
		}
	};

	var double = 0;
	if (message.text.indexOf("Pesante") != -1) {
		double = 1;
	}

	if (!checkSpam(message)) {
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Non ho trovato il tuo account", back);
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (Math.floor(rows[0].exp / 10) < 5) {
			bot.sendMessage(message.chat.id, "Il tuo danno a questo livello Ã¨ troppo basso, Ã¨ sconsigliato procedere fino al raggiungimento del livello 5", back);
			return;
		}

		var player_id = rows[0].id;
		var weapon_id = rows[0].weapon_id;
		var weapon2_id = rows[0].weapon2_id;
		var weapon3_id = rows[0].weapon3_id;
		var boss_time = rows[0].boss_time;
		var reborn = rows[0].reborn;
		var class_id = rows[0].class;
		var player_paralyzed = rows[0].paralyzed;
		var automagic1 = rows[0].weapon_enchant_bonus;
		var automagic2 = rows[0].weapon2_enchant_bonus;
		var automagic3 = rows[0].weapon3_enchant_bonus;
		var boost_cast = rows[0].boost_cast;

		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;
		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Scalata Boss"], ["Torna al menu"]]
			}
		};

		if (rows[0].res_time != null) {
			var now = new Date();
			var res_time = new Date(rows[0].res_time);
			var sec = Math.round(((res_time - now) / 1000));
			if (sec > 0) {
				bot.sendMessage(message.chat.id, "Sei appena tornato in vita, attendi ancora " + toTime(sec, 1), kb);
				return;
			} else {
				connection.query('UPDATE player SET res_time = NULL WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
				});
			}
		}

		if ((boost_mission == 0) && (boost_id != 0)) {
			connection.query('UPDATE player SET boost_id = 0 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		var critical = parseInt(rows[0].weapon_crit);
		var critical_armor = parseInt(rows[0].weapon2_crit);
		var critical_shield = parseInt(rows[0].weapon3_crit);

		var power_dmg = rows[0].power_dmg;
		var power_def = rows[0].power_def;
		var power_weapon = rows[0].power_weapon;
		var power_armor = rows[0].power_armor;
		var power_shield = rows[0].power_shield;

		critical += power_weapon;
		critical_armor += power_armor;
		critical_shield += power_shield;

		if (charm_id == 404) {
			critical += 6;
		}
		if (charm_id == 493) {
			critical += 2;
		}
		if (charm_id == 494) {
			critical += 4;
		}
		if (charm_id == 495) {
			critical_armor += 3;
		}
		if (charm_id == 496) {
			critical_shield += 3;
		}
		if (charm_id == 696) {
			critical += 5;
			critical_armor += 5;
			critical_shield += 3;
		}
		if ((class_id == 2) && (reborn == 3)) {
			critical_armor += 5;
		}
		if ((class_id == 2) && (reborn >= 4)) {
			critical_armor += 7;
			critical_shield += 7;
		}
		if ((class_id == 4) && (reborn == 3)) {
			critical += 2;
			critical_armor += 2;
			critical_shield += 2;
		}
		if ((class_id == 4) && (reborn >= 4)) {
			critical += 7;
			critical_armor += 7;
			critical_shield += 7;
		}
		if ((class_id == 5) && (reborn == 3)) {
			critical_shield += 4;
		}
		if ((class_id == 5) && (reborn >= 4)) {
			critical_shield += 8;
		}
		if ((class_id == 6) && (reborn == 3)) {
			critical_armor += 2;
		}
		if ((class_id == 6) && (reborn == 3)) {
			critical_shield += 2;
		}
		if ((class_id == 6) && (reborn >= 4)) {
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn >= 4)) {
			critical_shield += 7;
		}
		if ((class_id == 6) && (reborn == 5)) {
			critical_armor += 7;
		}
		if ((class_id == 6) && (reborn == 5)) {
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 3)) {
			critical_shield += 5;
		}
		if ((class_id == 8) && (reborn >= 4)) {
			critical_shield += 7;
		}
		if ((class_id == 8) && (reborn == 5)) {
			critical += 10;
		}
		if ((class_id == 9) && (reborn == 3)) {
			critical += 2;
			critical_shield += 2;
		}
		if ((class_id == 9) && (reborn >= 4)) {
			critical += 7;
			critical_shield += 7;
		}

		var danno = Math.round(Math.random() * (rows[0].exp / 10 + rows[0].weapon) + rows[0].weapon);
		danno += rows[0].weapon_enchant;
		danno += power_dmg;

		var charm_id = rows[0].charm_id;
		var player_exp = rows[0].exp;

		if (charm_id == 62) {
			danno += 5;
		} else if (charm_id == 184) {
			danno += 15;
		} else if (charm_id == 188) {
			danno += 20;
		} else if (charm_id == 698) {
			danno += 30;
		}

		var bonus = 0;
		if (rows[0].weapon2 < 0) {
			var bonus = Math.abs(rows[0].weapon2) + Math.abs(rows[0].weapon3) + rows[0].weapon2_enchant + rows[0].weapon3_enchant;
			bonus += Math.round(Math.random() * ((rows[0].exp / 10 + bonus) / 2));
		}
		bonus += power_def;
		var shield = rows[0].weapon3;
		var armor = rows[0].weapon2;

		danno = parseInt(danno);
		bonus = parseInt(bonus);

		var magic = 0;
		var magicId = 0;
		var magicPow = 0;
		var magicPowBase = 0;

		if (message.text.indexOf("Lancia") != -1) {
			if (rows[0].magic_to == 1) {
				//match[1] = match[1].slice(0, -1);
				if (match[1] == "Furia dei Mari") {
					magic = 1;
				} else if (match[1] == "Tempesta Folgorante") {
					magic = 2;
				} else if (match[1] == "Impeto di Fiamme") {
					magic = 3;
				} else if (match[1] == "Ira Astrale") {
					magic = 4;
				}
			} else {
				return;
			}
		}

		if (rows[0].mission_id != 0) {
			bot.sendMessage(message.chat.id, "Non puoi affrontare i boss finchÃ¨ sei in missione.", back);
			return;
		}

		/*
		if (rows[0].mission_party > 0) {
			bot.sendMessage(message.chat.id, "Incarico in corso! Attendi il termine prima di avviare uno scontro contro un boss.", back)
			return;
		}
		*/

		if ((rows[0].travel_id != 0) || (rows[0].cave_id != 0)) {
			if (rows[0].travel_id != 0) {
				var time = new Date(rows[0].travel_time_end);
			} else {
				var time = new Date(rows[0].cave_time_end);
			}
			bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth() + 1) + "/" + time.getFullYear(), abort_travel_2);
			return;
		}

		var pow = 0;
		if (match[2] != undefined) {
			pow = match[2];
		}

		connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 10', function (err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			if (Object.keys(rows).length > 0) {
				abBonus = parseInt(rows[0].ability_level) * rows[0].val;
			}

			connection.query('DELETE FROM magic WHERE quantity <= 0 AND player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var magicDouble = 0;
				connection.query('SELECT type, id, power, quantity FROM magic WHERE player_id = ' + player_id + ' AND power = ' + pow + ' AND type = ' + magic, function (err, rows, fields) {
					if (err) throw err;

					if (magic != 0) {
						if (Object.keys(rows).length > 0) {
							if (rows[0].quantity <= 0) {
								bot.sendMessage(message.chat.id, "Hai terminato gli utilizzi dell'incantesimo selezionato!", bossKb);
								return;
							} else {
								magicId = rows[0].id;
								magicPow = rows[0].power;
								magicPowBase = magicPow;

								var rand = Math.random() * 100;
								if ((class_id == 4) && ((magic == 3) || (magic == 4)) && (reborn == 5)) {
									abBonus += 25;
								}
								if (rand < abBonus) {
									magicDouble = 1;
									//console.log("BOSS_DOUBLE");
								}
							}
						} else {
							bot.sendMessage(message.chat.id, "Non possiedi l'incantesimo selezionato!", bossKb);
							return;
						}
					}

					var automagic = 0;

					if (charm_id == 698) {
						boost_cast += 3;
					}

					if (magic == 0) {
						var magicrand = Math.random() * 100;
						if (magicrand < (5 + boost_cast)) {
							if (weapon_id == 630) {
								magic = 2;
								automagic = 1;
								magicPow = 50;
							} else if (weapon_id == 631) {
								magic = 3;
								automagic = 1;
								magicPow = 50;
							} else if (weapon_id == 632) {
								magic = 1;
								automagic = 1;
								magicPow = 50;
							}
						}
						if (magicrand < (10 + boost_cast)) {
							if (weapon_id == 638) {
								magic = 2;
								automagic = 1;
								magicPow = 200;
							} else if (weapon_id == 639) {
								magic = 3;
								automagic = 1;
								magicPow = 150;
							} else if (weapon_id == 640) {
								magic = 1;
								automagic = 1;
								magicPow = 150;
							}
						}
						if (magicrand < (30 + boost_cast)) {
							if (weapon_id == 754) {
								magic = 4;
								automagic = 1;
								magicPow = 150;
							}
						}

						// Incantesimo da enchant
						if ((magicrand > 80) && (automagic1 > 0) && (automagic == 0)) {
							var magicrand2 = Math.random() * 100;
							if (automagic1 == 1) {
								magic = 1;
								automagic = 1;
								magicPow = 50;
							} else if (automagic1 == 2) {
								magic = 2;
								automagic = 1;
								magicPow = 150;
							} else {
								magic = 3;
								automagic = 1;
								magicPow = 50;
							}
						}
					}

					var check = 0;
					if (magicDouble == 1) {
						if (automagic == 0) {
							if ((class_id == 2) && (reborn == 3)) {
								magicPow += magicPow * 0.1;
								magicPow += magicPowBase;
								check = 1;
							}
							if ((class_id == 2) && (reborn == 4)) {
								magicPow += magicPow * 0.25;
								magicPow += magicPowBase;
								check = 1;
							}
							if ((class_id == 2) && (reborn == 5)) {
								magicPow += magicPow * 0.75;
								magicPow += magicPowBase;
								check = 1;
							}
							if ((class_id == 3) && (reborn == 5)) {
								magicPow += magicPow * 0.3;
								magicPow += magicPowBase;
								check = 1;
							}
						}
						if (check == 0) {
							magicPow += magicPowBase;
						}
					} else {
						if (automagic == 0) {
							if ((class_id == 2) && (reborn == 3)) {
								magicPow += magicPow * 0.1;
							}
							if ((class_id == 2) && (reborn == 4)) {
								magicPow += magicPow * 0.25;
							}
							if ((class_id == 2) && (reborn == 5)) {
								magicPow += magicPow * 0.75;
							}
							if ((class_id == 3) && (reborn == 5)) {
								magicPow += magicPow * 0.3;
							}
						}
					}

					if ((class_id == 8) && (reborn > 1)) {
						magicPow -= magicPow * 0.1;
					}
					if ((class_id == 5) && (reborn == 3) && (magic == 1)) {
						magicPow += magicPow * 0.5;
					}
					if ((class_id == 5) && (reborn >= 4) && (magic == 1)) {
						magicPow += magicPow * 1;
					}

					connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 1', function (err, rows, fields) {
						if (err) throw err;

						var abBonus = 0;
						if (Object.keys(rows).length > 0) {
							abBonus = rows[0].ability_level * rows[0].val;
							critical += abBonus;
							critical_armor += abBonus;
							critical_shield += abBonus;
						}

						connection.query('SELECT team_player.team_id, team_player.suspended, COUNT(*) As num, team.boost_id FROM player, team_player, team WHERE team.id = team_player.team_id AND player.id = ' + player_id + ' AND team_player.player_id = player.id', function (err, rows, fields) {
							if (err) throw err;
							var team_id = 0;
							if (rows[0].num > 0) {
								team_id = rows[0].team_id;
							} else {
								bot.sendMessage(message.chat.id, "Puoi affrontare i boss solo se sei in un team.", back);
								return;
							}

							var team_boost_id = rows[0].boost_id;
							if (team_boost_id == 1) {
								danno += danno * 0.5;
							}

							if (boss_time != null) {
								bot.sendMessage(message.chat.id, "Non puoi ancora affrontare i boss, ti sei appena trasferito.", back);
								return;
							}

							if (rows[0].suspended == 1) {
								bot.sendMessage(message.chat.id, "Non puoi attaccare i boss finchÃ¨ sei sospeso", back);
								return;
							}

							connection.query('SELECT level FROM team_boost WHERE team_id = ' + team_id + ' AND boost_id = 1', function (err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length > 0) {
									danno += danno * (0.03 * rows[0].level);
								}

								connection.query('SELECT level FROM team_boost WHERE team_id = ' + team_id + ' AND boost_id = 3', function (err, rows, fields) {
									if (err) throw err;

									var boost_reduction = 0;
									if (Object.keys(rows).length > 0) {
										boost_reduction = (0.03 * rows[0].level);
									}

									connection.query('SELECT players FROM team WHERE id = ' + team_id, function (err, rows, fields) {
										if (err) throw err;

										if ((rows[0].players < 3) && (team_id != 2)) {
											bot.sendMessage(message.chat.id, "Il team deve possedere almeno 3 membri.", back);
											return;
										}

										connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;

											var combat = 0;
											if (Object.keys(rows).length > 0) {
												combat = rows[0].combat;
											}

											connection.query('SELECT critical, damage, defence, claws, saddle, life, sleep_h FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												if ((Object.keys(rows).length > 0) && (combat == 0)) {
													if ((rows[0].life > 0) || ((rows[0].life == 0) && (rows[0].sleep_h > 0))) {
														if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
															rows[0].claws += rows[0].claws * 1;
														}else if ((class_id == 7) && (reborn > 1)) {
															rows[0].claws += rows[0].claws * 0.5;
														}
														if ((class_id == 7) && (reborn > 1) && (reborn == 5)) {
															rows[0].saddle  += rows[0].saddle  * 1;
														}else if ((class_id == 7) && (reborn > 1)) {
															rows[0].saddle  += rows[0].saddle  * 0.5;
														}

														danno += parseInt(rows[0].damage);
														danno += parseInt(rows[0].claws);
														bonus += parseInt(rows[0].defence);
														bonus += parseInt(rows[0].saddle);
														var dragon_crit = rows[0].critical;
														if (charm_id == 602) {
															danno += 25;
															dragon_crit += 10;
														}
														if (charm_id == 695) {
															danno += 30;
															dragon_crit += 15;
														}
														if ((class_id == 7) && (reborn == 3)) {
															dragon_crit += 5;
														}
														if ((class_id == 7) && (reborn >= 4)) {
															dragon_crit += 7;
														}
														if ((class_id == 7) && (reborn == 5)) {
															critical += dragon_crit / 2;
														}
													}
												}

												connection.query('SELECT * FROM player WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													var boss_id = rows[0].boss_id;
													var money = rows[0].money;
													var player_exp = rows[0].exp;
													var player_life = rows[0].life;
													var player_total_life = rows[0].total_life;
													var craft_count = rows[0].craft_count;

													if (player_life <= 0) {
														bot.sendMessage(message.chat.id, "Non abbastanza salute per combattere contro il boss! Riprova domani.", revive);
														return;
													}

													if (boss_id > 0) {
														connection.query('SELECT boss_team.life, boss_team.countdown, boss_team.paralyzed, boss.id As bossNum, boss_team.critic, boss_team.id, boss_team.total_life, boss.name, boss_team.unlocked FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND boss_team.id = ' + boss_id, function (err, rows, fields) {
															if (err) throw err;

															if (Object.keys(rows).length == 0) {
																bot.sendMessage(message.chat.id, "Errore misterioso, contatta l'admin per segnalarlo.", back);
																return;
															}

															var boss_num = rows[0].bossNum;
															if (rows[0].unlocked == 0) {
																connection.query('UPDATE player SET boss_id = NULL WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Sei pronto a tornare a sfidare il boss!", bossKb);
																});
																return;
															}

															if (boss_num == 31) {
																if ((magic != 0) && (automagic == 0)) {
																	bot.sendMessage(message.chat.id, "Questo boss Ã¨ immune agli incantesimi lanciati manualmente!");
																	magic = 0;
																}
															}

															var boss_name = rows[0].name;
															var boss_life = rows[0].life;
															var critic = rows[0].critic;
															var countdown = rows[0].countdown;
															var boss_total_life = rows[0].total_life;

															if (boss_life <= 0) {
																bot.sendMessage(message.chat.id, "Il boss Ã¨ giÃ  stato sconfitto!", back);
																return;
															}
															var boss_drop = boss_total_life / 10;
															var critical_rand = Math.round(Math.random() * 100) + 1;
															var crit_bool = 0;
															var crit_txt = "";

															if (double == 1) {
																danno = danno * 1.5;
															}

															if (crazyMode == 1) {
																danno = danno * 2;
															}

															if (critic > 0) {
																critical += 50;
															}

															if (critical_rand <= critical) {
																danno = danno * 2;
																crit_bool = 1;
															}

															var magic_txt = "";
															if (magic == 3) {
																danno = danno * (magicPow / 30);
																if (magicDouble == 1) {
																	magic_txt = "con un incantesimo (x2), ";
																} else {
																	magic_txt = "con un incantesimo, ";
																}
															}

															if ((class_id == 8) && (reborn == 2)) {
																danno += danno * 0.10;
															}else if ((class_id == 8) && (reborn == 3)) {
																danno += danno * 0.15;
															}else if ((class_id == 8) && (reborn == 4)) {
																danno += danno * 0.17;
															}else if ((class_id == 8) && (reborn == 5)) {
																danno += danno * 0.30;
															}

															//638 - Hoenir
															//639 - Xocotl
															//640 - Hydros

															if (boss_num == 28) { //Hoenir - Acqua
																if (weapon_id == 638) {
																	danno = 0;
																}
																if (weapon_id == 639) {
																	danno = danno * 1.5;
																}
																if (weapon_id == 640) {
																	danno = danno * 0.5;
																}
															}
															if (boss_num == 29) { //Hydros - Elettro
																if (weapon_id == 640) {
																	danno = 0;
																}
																if (weapon_id == 638) {
																	danno = danno * 1.5;
																}
																if (weapon_id == 639) {
																	danno = danno * 0.5;
																}
															}
															if (boss_num == 30) { //Xocotl - Fuoco
																if (weapon_id == 639) {
																	danno = 0;
																}
																if (weapon_id == 640) {
																	danno = danno * 1.5;
																}
																if (weapon_id == 638) {
																	danno = danno * 0.5;
																}
															}
															if (boss_num == 31) { //Phoenix
																if (weapon_id == 754) {
																	danno = danno * 1.5;
																}
															}

															danno = Math.floor(danno);

															var multi = Math.round(Math.floor(player_exp / 10) / 10);
															if (multi >= 5) {
																danno = danno * 5;
															} else {
																danno = danno * multi;
															}

															var kb = {
																parse_mode: "Markdown",
																reply_markup: {
																	resize_keyboard: true,
																	//one_time_keyboard: true,
																	"keyboard": [["Attacco Leggero", "Attacco Pesante"], ["Incantesimi"], ["Utilizzabili Boss"], ["Visualizza Boss"], ["Torna al menu"]]
																}
															};

															var next = {
																parse_mode: "Markdown",
																reply_markup: {
																	resize_keyboard: true,
																	//one_time_keyboard: true,
																	"keyboard": [["Continua"], ["Torna al menu"]]
																}
															};

															var status = "Normale";
															var my_status = "Normale";
															var paralyzed = rows[0].paralyzed;
															var critic = rows[0].critic;
															if (paralyzed > 0) {
																status = "Paralizzato (" + paralyzed + " turni)";
															}
															if (critic > 0) {
																status = "Vulnerabile (" + critic + " turni)";
															}
															if ((paralyzed > 0) && (critic > 0)){
																status = "Paralizzato (" + paralyzed + " turni) e Vulnerabile (" + critic + " turni)";
															}

															if (player_paralyzed > 0){
																my_status = "Paralizzato (" + player_paralyzed + " turni)";
															}

															if ((paralyzed > 0) && (automagic == 1) && (magic == 2)) {
																automagic = 0;
																magic = 0;
																connection.query('UPDATE player SET boost_cast = boost_cast+5 WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}
															if ((critic > 0) && (automagic == 1) && (magic == 4)){
																automagic = 0;
																magic = 0;
																connection.query('UPDATE player SET boost_cast = boost_cast+5 WHERE id = ' + player_id, function (err, rows, fields) {
																	if (err) throw err;
																});
															}

															bot.sendMessage(message.chat.id, "*" + boss_name + "*:\nStato boss: " + status + "\nSalute boss: *" + formatNumber(boss_life) + "* hp\nIl tuo stato: " + my_status + "\nLa tua salute: *" + formatNumber(player_life) + "* hp" + "", next).then(function () {
																answerCallbacks[message.chat.id] = function (answer) {
																	if (answer.text != "Continua") {
																		return;
																	}

																	if ((magic != 0) && (player_paralyzed == 0))
																		setAchievement(message.chat.id, player_id, 6, 1);

																	if ((boost_mission > 0) && (boost_id == 6)) {
																		connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		danno = danno * 2;
																	}

																	var meParalyzed = 0;
																	if (player_paralyzed > 0) {
																		connection.query('UPDATE player SET paralyzed = paralyzed-1 WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																		meParalyzed = 1;
																		danno = 0;
																		magic = 0;
																	}

																	if (magic != 1){
																		connection.query('UPDATE player SET boost_cast = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																			if (err) throw err;
																		});
																	}

																	if ((magic == 2) && (meParalyzed == 0)) {
																		var turn = 0;
																		if (magicPow < 100) {
																			turn = 1;
																		} else if (magicPow < 200) {
																			turn = 2;
																		} else if (magicPow < 250) {
																			turn = 3;
																		} else if (magicPow < 300) {
																			turn = 4;
																		} else if (magicPow < 350) {
																			turn = 5;
																		} else if (magicPow < 400) {
																			turn = 6;
																		} else {
																			turn = 7;
																		}
																		var r = Math.random() * 100;
																		if ((automagic == 1) && (r < 50))
																			turn++;
																		paralyzed = turn;
																		connection.query('UPDATE boss_team SET paralyzed = ' + turn + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																			if (err) throw err;
																			if (magicDouble == 1) {
																				bot.sendMessage(message.chat.id, "Il boss Ã¨ stato paralizzato per " + turn + " turni (x2)!");
																			} else {
																				bot.sendMessage(message.chat.id, "Il boss Ã¨ stato paralizzato per " + turn + " turni!");
																			}
																		});
																	}

																	var criticActivated = 0;
																	if ((magic == 4) && (meParalyzed == 0)) {
																		var turn = 0;
																		criticActivated = 1;
																		if (magicPow < 100) {
																			turn = 1;
																		} else if (magicPow < 200) {
																			turn = 2;
																		} else if (magicPow < 250) {
																			turn = 3;
																		} else if (magicPow < 300) {
																			turn = 4;
																		} else if (magicPow < 350) {
																			turn = 5;
																		} else if (magicPow < 400) {
																			turn = 6;
																		} else {
																			turn = 7;
																		}
																		var r = Math.random() * 100;
																		if ((automagic == 1) && (r < 50))
																			turn++;
																		critic = turn;
																		connection.query('UPDATE boss_team SET critic = ' + turn + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																			if (err) throw err;
																			if (magicDouble == 1) {
																				bot.sendMessage(message.chat.id, "Il boss Ã¨ vulnerabile ai colpi critici per " + turn + " turni (x2)!");
																			} else {
																				bot.sendMessage(message.chat.id, "Il boss Ã¨ vulnerabile ai colpi critici per " + turn + " turni!");
																			}
																		});
																	}

																	connection.query('SELECT life, paralyzed, critic, total_life FROM boss_team WHERE id = ' + boss_id, function (err, rows, fields) {
																		if (err) throw err;

																		var lifeB = rows[0].life;
																		if (paralyzed == 0)
																			paralyzed = rows[0].paralyzed;
																		if (critic == 0)
																			critic = rows[0].critic;

																		if (lifeB <= 0) {
																			bot.sendMessage(message.chat.id, "Il boss Ã¨ giÃ  stato sconfitto", bossKb);
																			return;
																		}

																		if ((critic > 0) && (criticActivated == 0)) {
																			connection.query('UPDATE boss_team SET critic = critic-1 WHERE id = ' + boss_id, function (err, rows, fields) {
																				if (err) throw err;
																			});
																		}

																		var damage = 0;
																		var max = Math.round((boss_drop / 15) * 1.5);
																		var min = Math.round((boss_drop / 16) * 1.5);
																		damage = Math.round(Math.random() * max + min) - bonus;
																		var heal = Math.round(((magicPow/350)*Math.abs(damage))/2);

																		if (magic == 1)
																			danno += heal;

																		if (lifeB - danno <= 0)
																			danno = lifeB;

																		if (danno < 0)
																			danno = 0;

																		lifeB = lifeB - danno;

																		setAchievement(message.chat.id, player_id, 2, danno);

																		connection.query('UPDATE boss_team SET life = life-' + danno + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																			if (err) throw err;

																			if (danno > 0){
																				connection.query('INSERT INTO boss_damage (boss_id, player_id, team_id, damage) VALUES (' + boss_id + ',' + player_id + ',' + team_id + ',' + danno + ')', function (err, rows, fields) {
																					if (err) throw err;
																				});
																			}

																			if ((magic != 0) && (automagic == 0) && (meParalyzed == 0)) {
																				if (magic != 3) { //SCALA MAGIE ECCETTO FIAMME
																					connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields) {
																						if (err) throw err;
																					});
																				}
																			}

																			connection.query('SELECT life FROM boss_team WHERE boss_team.id = ' + boss_id, function (err, rows, fields) {
																				if (err) throw err;

																				if (rows[0].life <= 0) {
																					if ((magic != 0) && (automagic == 0) && (meParalyzed == 0)) {
																						if (magic == 3) { //SCALA SOLO FIAMME
																							connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields) {
																								if (err) throw err;
																							});
																						}
																					}

																					connection.query('SELECT boss_respawn FROM team WHERE id = ' + team_id, function (err, rows, fields) {
																						if (err) throw err;
																						if (rows[0].boss_respawn == null) {
																							var now = new Date();
																							now.setHours(now.getHours() + 48);
																							var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
																							var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());

																							connection.query('UPDATE team SET boss_respawn = "' + long_date + '" WHERE id = ' + team_id, function (err, rows, fields) {
																								if (err) throw err;
																								bot.sendMessage(message.chat.id, "Il primo boss Ã¨ stato ucciso, il tuo team ha tempo fino alle " + short_date + " di dopodomani prima che i boss tornino in vita!");
																							});
																						}
																					});

																					var bonus_drop = 0;
																					var bonus_act = 0;
																					var acc_bonus = 0;

																					connection.query('SELECT T2.players, T2.level FROM team T1 JOIN team T2 ON T1.child_team = T2.id WHERE T1.id = ' + team_id, function (err, rows, fields) {
																						if (err) throw err;

																						//Se questa Ã¨ la madre
																						if (Object.keys(rows).length > 0) {
																							if (rows[0].level >= 5) {
																								bonus_act = 1;
																								acc_bonus = 1;
																							}
																						}

																						connection.query('SELECT T2.players, T2.level FROM team T1 JOIN team T2 ON T1.id = T2.id WHERE T1.child_team = ' + team_id, function (err, rows, fields) {
																							if (err) throw err;

																							//Se questa Ã¨ la accademia
																							if (Object.keys(rows).length > 0) {
																								if ((rows[0].level >= 5) && (bonus_act == 0)) {
																									acc_bonus = 1;
																								}
																							}

																							connection.query('SELECT level FROM team_boost WHERE team_id = ' + team_id + ' AND boost_id = 2', function (err, rows, fields) {
																								if (err) throw err;

																								var boost_bonus = 0;
																								if (Object.keys(rows).length > 0) {
																									boost_bonus = (0.03 * rows[0].level);
																								}

																								connection.query('SELECT team.max_players, team.level, team.kill_num1, team.kill_num2, player.id, player.nickname, player.chat_id FROM player, team_player, team WHERE team.id = team_player.team_id AND player.id = team_player.player_id AND team_player.team_id = ' + team_id, function (err, rows, fields) {
																									if (err) throw err;
																									var members_cnt = Object.keys(rows).length;
																									var drop = parseInt((boss_drop) + (members_cnt * 20));

																									var bonus = 0;
																									var bonus_parz = 0;
																									var bonus_compl = 0;
																									var max_players = rows[0].max_players;

																									if (rows[0].kill_num1 > 0)
																										bonus_parz = Math.floor(Math.log(rows[0].kill_num1) * 1000) + 800;

																									if (rows[0].kill_num2 > 0)
																										bonus_compl = Math.floor(Math.log2(rows[0].kill_num2) * 1500) + 1500;

																									bonus_drop += (100 * rows[0].level) + bonus_parz + bonus_compl;

																									if (members_cnt > 0) {
																										if (team_boost_id == 2) {
																											bonus_drop += bonus_drop * 0.5;
																										}
																										bonus_drop += bonus_drop * boost_bonus;
																										bonus_drop = Math.round(bonus_drop);

																										teamBoss(team_id, bonus_drop, message, acc_bonus);
																									}

																									var now = new Date();
																									var rand = Math.round(Math.random() * 5 + 3);
																									now.setHours(now.getHours() + rand);

																									connection_sync.query('UPDATE boss_team SET paralyzed = 0, critic = 0, killedby = "' + message.from.username + '", killeddate = "' + getNow("en") + '" WHERE id = ' + boss_id);

																									if (max_players >= 19)
																										max_players = 999;

																									var no_next = 0;
																									if ((boss_num + 1) <= max_players) {
																										connection.query('SELECT boss_id FROM boss_team WHERE id = ' + boss_id, function (err, rows, fields) {
																											if (Object.keys(rows).length > 0) {
																												connection.query('UPDATE boss_team SET unlocked = 1 WHERE team_id = ' + team_id + ' AND boss_id = ' + (parseInt(rows[0].boss_id) + 1), function (err, rows, fields) {
																													if (err) throw err;
																												});
																											}
																										});
																									} else {
																										no_next = 1;
																									}

																									connection.query('UPDATE player SET money = money+' + drop + ' WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});

																									var randCaps = Math.random()*1000;
																									if ((randCaps < 2) && (player_exp > 500)) {
																										if (getItemCnt(player_id, 169) == 0) {
																											addItem(player_id, 169);
																											bot.sendMessage(message.chat.id, "Hai ottenuto una RARISSIMA *Capsula di Antimateria*!", back);
																										};
																									}

																									if (boss_num == 20) {
																										connection.query('UPDATE team SET kill_num1 = kill_num1+1 WHERE id = ' + team_id, function (err, rows, fields) {
																											if (err) throw err;

																											incremBoss(team_id);
																										});
																									} else if (boss_num == 31) {
																										connection.query('UPDATE team SET kill_num2 = kill_num2+1 WHERE id = ' + team_id, function (err, rows, fields) {
																											if (err) throw err;

																											incremBoss(team_id);
																										});
																									}

																									var point = 1;
																									if (acc_bonus > 0)
																										point += acc_bonus;
																									connection.query('UPDATE team SET boss_count = boss_count+1, point = point+' + point + ' WHERE id = ' + team_id, function (err, rows, fields) {
																										if (err) throw err;
																									});

																									var next = ""
																									if (boss_num != 31)
																										next = "\nInoltre hai sbloccato il boss successivo!";
																									if (no_next == 1)
																										next = "\nPotenzia il team per sbloccare il boss successivo!";

																									bot.sendMessage(message.chat.id, "Hai ucciso il boss ed ottenuto *" + formatNumber(drop) + "* Â§" + next, bossKb);

																									//fixBoss(team_id);

																									setAchievement(message.chat.id, player_id, 19, 1);
																									if ((armor == 0) && (shield == 0)) {
																										setAchievement(message.chat.id, player_id, 44, 1);
																									}
																								});
																							});
																						});
																					});
																				} else {

																					if (crit_bool == 1) {
																						crit_txt = " CRITICI";
																						setAchievement(message.chat.id, player_id, 33, 1);
																					}

																					if (paralyzed > 0) {
																						connection.query('UPDATE boss_team SET paralyzed = paralyzed-1 WHERE id = ' + boss_id, function (err, rows, fields) {
																							if (err) throw err;

																							bot.sendMessage(message.chat.id, "Il boss Ã¨ paralizzato!", kb).then(function () {
																								answerCallbacks[message.chat.id] = function (answer) {
																									if (answer.text == "Consumabili") {
																										Consumabili(message, player_id, 1, player_total_life, player_life, boss_id);
																									}
																								};
																							});

																							setTimeout(function () {
																								bot.sendMessage(message.chat.id, "Hai colpito il boss " + magic_txt + "e hai inflitto *" + formatNumber(danno) + "* danni" + crit_txt + ", ha ancora " + formatNumber(lifeB) + " hp", mark);
																							}, 500);
																						});
																						if ((magic != 0) && (automagic == 0)) {
																							if (magic == 3) {
																								connection.query('UPDATE magic SET quantity = quantity-1 WHERE id = ' + magicId, function (err, rows, fields) {
																									if (err) throw err;
																								});
																							}
																						}
																						return;
																					}

																					var critical_rand2 = Math.round(Math.random() * 100) + 1;
																					var crit_txt2 = "";

																					if ((critical_rand2 <= critical_armor) && (meParalyzed == 0)) {
																						damage = damage / 1.5;
																						crit_txt2 = ", ridotti grazie alla tua corazza";
																						setAchievement(message.chat.id, player_id, 31, 1);
																					}

																					var critical_rand3 = Math.round(Math.random() * 100) + 1;
																					var crit_bool3 = 0;
																					var crit_txt3 = "";

																					if ((critical_rand3 <= critical_shield) && (meParalyzed == 0)) {
																						crit_bool3 = 1;
																						crit_txt3 = ", assorbito completamente dallo scudo";
																						setAchievement(message.chat.id, player_id, 32, 1);
																					}

																					if (charm_id == 63) {
																						damage = damage - 5;
																					} else if (charm_id == 186) {
																						damage = damage - 15;
																					} else if (charm_id == 189) {
																						damage = damage - 20;
																					}

																					var dmg = damage * Math.max(1, 1.5 - ((2 * boss_total_life) / 1000000) + ((3 * boss_num) / 31));
																					damage = dmg;

																					if (double == 1) {
																						damage = damage * 1.5;
																					}
																					if ((class_id == 2) && (reborn > 1)) {
																						damage += damage * 0.05;
																					}
																					if ((class_id == 6) && (reborn > 1)) {
																						damage -= damage * 0.15;
																					}
																					if ((class_id == 8) && (reborn > 1)) {
																						damage += damage * 0.1;
																					}
																					if ((class_id == 9) && (reborn > 1)) {
																						damage += damage * 0.1;
																					}

																					if (boost_reduction > 0) {
																						damage -= damage * boost_reduction;
																					}

																					if (team_boost_id == 3) {
																						damage -= damage * 0.5;
																					}

																					var special = "";
																					var specialRand = Math.random() * 100;
																					if (specialRand <= 20) {
																						if (boss_num == 28) {
																							special = "Obliterazione";
																							damage = Math.round(getRandomArbitrary(player_total_life * 0.1, player_total_life * 0.2));
																						}
																						if (boss_num == 29) {
																							special = "Ascensione di Nettuno";
																							damage = Math.round(getRandomArbitrary(player_total_life * 0.2, player_total_life * 0.3));
																						}
																						if (boss_num == 30) {
																							special = "Colonne dell'Inferno";
																							damage = Math.round(getRandomArbitrary(player_total_life * 0.4, player_total_life * 0.5));
																						}
																					}

																					var enemy_magic = "";
																					var enemy_magicRand = Math.random() * 100;
																					var heal_enemy = 0;
																					var restored = "";
																					if ((boss_num >= 18) && (special == "") && (paralyzed == 0)) {
																						//console.log(">>> DANNI: " + damage);
																						if ((boss_num - 17) > enemy_magicRand) {
																							var rand2 = Math.random() * 100;

																							if (boss_num == 30) {
																								rand2 = 20;
																							} else if (boss_num == 29) {
																								rand2 = 50;
																							} else if (boss_num == 28) {
																								rand2 = 80;
																							}

																							if (rand2 < 30) {
																								var r = 100;
																								rand = Math.random() * 100;
																								if ((weapon3_id == 672) || (automagic3 == 3)) {
																									r = 50;
																								}
																								if (r >= rand) {
																									enemy_magic = "Impeto di Fiamme";
																									damage = damage * 4;
																									if ((weapon2_id == 688) || (automagic2 == 3)) {
																										var r2 = Math.random() * 100;
																										if (r2 < 50) {
																											var restore = Math.round(getRandomArbitrary(100, 300));
																											restored = " Hai assorbito " + formatNumber(restore) + " Mana Rosso dall'incantesimo!";
																											connection.query('UPDATE event_mana_status SET mana_3 = mana_3 + ' + restore + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																												if (err) throw err;
																											});
																										}
																									}
																								}
																							} else if (rand2 < 60) {
																								var r = 100;
																								rand = Math.random() * 100;
																								if ((weapon3_id == 673) || (automagic3 == 1)) {
																									r = 50;
																								}
																								if (r >= rand) {
																									enemy_magic = "Furia dei Mari";
																									heal_enemy = getRandomArbitrary(boss_total_life * 0.01, boss_total_life * 0.05);
																									if (boss_life + heal_enemy > boss_total_life) {
																										heal_enemy = boss_total_life - boss_life;
																									}
																									if (heal_enemy < 0)
																										heal_enemy = Math.abs(heal_enemy);
																									if (heal_enemy > 50000) {
																										heal_enemy = 50000;
																									}
																									heal_enemy = Math.round(heal_enemy);
																									connection.query('UPDATE boss_team SET life = life+' + heal_enemy + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									if ((weapon2_id == 689) || (automagic2 == 1)) {
																										var r2 = Math.random() * 100;
																										if (r2 < 50) {
																											var restore = Math.round(getRandomArbitrary(100, 300));
																											restored = " Hai assorbito " + formatNumber(restore) + " Mana Blu dall'incantesimo!";
																											connection.query('UPDATE event_mana_status SET mana_1 = mana_1 + ' + restore + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																												if (err) throw err;
																											});
																										}
																									}
																								}
																							} else {
																								var r = 100;
																								rand = Math.random() * 100;
																								if ((weapon3_id == 671) || (automagic3 == 2)) {
																									r = 50;
																								}
																								if (r >= rand) {
																									enemy_magic = "Tempesta Folgorante";
																									connection.query('UPDATE player SET paralyzed = 2 WHERE id = ' + player_id, function (err, rows, fields) {
																										if (err) throw err;
																									});
																									if ((weapon2_id == 690) || (automagic2 == 2)) {
																										var r2 = Math.random() * 100;
																										if (r2 < 50) {
																											var restore = Math.round(getRandomArbitrary(100, 300));
																											restored = " Hai assorbito " + formatNumber(restore) + " Mana Giallo dall'incantesimo!";
																											connection.query('UPDATE event_mana_status SET mana_2 = mana_2 + ' + restore + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																												if (err) throw err;
																											});
																										}
																									}
																								}
																							}
																						}
																					}

																					var necroD = 10;

																					if (boss_num == 31) {
																						countdown++;
																						if (countdown >= necroD) {
																							special = "Necro-Anima";
																							damage = player_life;
																							countdown = 0;
																						} else {
																							if (countdown == necroD - 3) {
																								bot.sendMessage(message.chat.id, "3...");
																							} else if (countdown == necroD - 2) {
																								bot.sendMessage(message.chat.id, "2...");
																							} else if (countdown == necroD - 1) {
																								bot.sendMessage(message.chat.id, "1...");
																							}
																						}
																						connection.query('UPDATE boss_team SET countdown = ' + countdown + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																							if (err) throw err;
																							//console.log("Countdown: " + boss_id + " " + countdown);
																						});
																					}

																					damage = Math.round(damage);

																					if (damage <= 0) {
																						damage = 0;
																					}

																					if (crit_bool3 == 1) {
																						damage = 0;
																					}

																					if (magic == 1){
																						damage = 0;
																					}

																					setAchievement(message.chat.id, player_id, 30, damage);

																					connection.query('UPDATE player SET life = life-' + damage + ' WHERE id = ' + player_id, function (err, rows, fields) {
																						if (err) throw err;

																						if (magic == 3) {
																							connection.query('UPDATE magic SET quantity = quantity - 1 WHERE id = ' + magicId, function (err, rows, fields) {
																								if (err) throw err;
																								//console.log("Magia con ID " + magicId + " utilizzata");
																							});
																						}

																						var extra = "attacca";
																						if (special != "") {
																							extra = "colpisce con *" + special + "*";
																						}
																						if (enemy_magic != "") {
																							extra = "colpisce con *" + enemy_magic + "*";
																							if (heal_enemy != 0) {
																								extra += " recuperando " + heal_enemy + " hp";
																							}
																						}
																						if ((special != "") && (enemy_magic != "")){
																							extra = "colpisce con *" + special + "* e *" + enemy_magic + "*";
																							if (heal_enemy != 0) {
																								extra += " recuperando " + heal_enemy + " hp";
																							}
																						}

																						var magic_txt2 = "";

																						if (magic == 1) {
																							connection.query('UPDATE player SET life = life+' + heal + ' WHERE id = ' + player_id, function (err, rows, fields) {
																								if (err) throw err;
																								calcLife(message);
																							});
																							if (magicDouble == 1) {
																								magic_txt2 += " (+" + formatNumber(heal) + " hp e danni - x2)";
																							} else {
																								magic_txt2 += " (+" + formatNumber(heal) + " hp e danni)";
																							}
																						}

																						if (player_life - damage <= 0) {
																							var msg = "";
																							if (danno != 0) {
																								if ((extra != "") && (extra != "attacca")) {
																									extra = "e ti " + extra;
																									msg = "Hai colpito il boss infliggendo un danno pari a *" + formatNumber(danno) + "* hp, il boss ti infligge *" + formatNumber(damage) + "* hp " + extra + "!" + restored;
																								} else if (magic == 1){
																									msg = "Hai lanciato Furia dei Mari, previeni il danno del boss e ne rifletti una parte potenziando il tuo attacco (subisce *" + formatNumber(danno) + "* danni), inoltre ti curi di *" + formatNumber(heal) + "* hp, ma sei stato sconfitto con un colpo mortale da *" + formatNumber(damage) + "* hp!";
																								} else {
																									msg = "Hai colpito il boss infliggendo un danno pari a *" + formatNumber(danno) + "* hp, ma sei stato sconfitto con un colpo mortale da *" + formatNumber(damage) + "* hp!" + restored;
																								}
																							} else {
																								if (meParalyzed == 0) {
																									msg = "Il boss ti " + extra + " con un colpo mortale da *" + formatNumber(damage) + "* hp!" + restored;
																								} else {
																									msg = "Essendo paralizzato non riesci a colpire, invece il boss ti " + extra + " con un colpo mortale da *" + formatNumber(damage) + "* hp!" + restored;
																								}
																							}

																							var reviveItem = getItemCnt(player_id, 759);
																							if (reviveItem > 0){
																								delItem(player_id, 759, 1);
																								connection.query('UPDATE player SET life = total_life, paralyzed = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								bot.sendMessage(message.chat.id, msg + "\n\nSei tornato in piena salute consumando un Intruglio Revitalizzante (ancora " + formatNumber(reviveItem-1) + " disponibili)!", kb);
																							}else{
																								connection.query('UPDATE player SET life = 0, paralyzed = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																									if (err) throw err;
																								});
																								bot.sendMessage(message.chat.id, msg, revive);
																							}
																							return;
																						}

																						if (damage <= 0) {
																							var txt = "Hai evitato il colpo del boss" + crit_txt3 + magic_txt2 + "!" + restored;
																							if (enemy_magic != "") {
																								txt = "Il boss lancia " + enemy_magic + "! Comunque riesci ad evitare il colpo successivo!" + restored;
																							}else if (magic == 1){
																								txt = "Hai lanciato Furia dei Mari, previeni il danno del boss e ne rifletti una parte potenziando il tuo attacco (subisce *" + formatNumber(danno) + "* danni), inoltre ti curi di *" + formatNumber(heal) + "* hp";
																							}

																							bot.sendMessage(message.chat.id, txt, kb).then(function () {
																								answerCallbacks[message.chat.id] = function (answer) {
																									if (answer.text == "Consumabili") {
																										Consumabili(message, player_id, 1, player_total_life, player_life, boss_id);
																									}
																								};
																							});
																						} else {
																							bot.sendMessage(message.chat.id, "Il boss ti " + extra + " e perdi *" + formatNumber(damage) + "* hp" + crit_txt2 + magic_txt2 + ", hai ancora " + formatNumber(player_life - damage) + " hp!" + restored, kb).then(function () {
																								answerCallbacks[message.chat.id] = function (answer) {
																									if (answer.text == "Consumabili") {
																										Consumabili(message, player_id, 1, player_total_life, player_life, boss_id);
																									}
																								};
																							});
																						}

																						if ((magic != 1) && (meParalyzed == 0)){
																							setTimeout(function () {
																								if (meParalyzed == 0) {
																									bot.sendMessage(message.chat.id, "Hai colpito il boss " + magic_txt + "e hai inflitto *" + formatNumber(danno) + "* danni" + crit_txt + ", ha ancora " + formatNumber(lifeB) + " hp", mark);
																								} else {
																									if ((player_paralyzed - 1) != 0) {
																										bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il boss, sei ancora paralizzato per " + (player_paralyzed - 1) + " turni", mark);
																									} else {
																										bot.sendMessage(message.chat.id, "Non sei riuscito a colpire il mostro, e ora non sei piÃ¹ paralizzato");
																									}
																								}
																							}, 500);
																						}
																					});
																				}
																			});
																		});
																	});
																};
															});
														});
													}
												});
											});
										});
									});
								});
							});
						});
					});
				});
			});
		});
	});
});

bot.onText(/visualizza boss/i, function (message) {
	var bossKb = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Affronta Boss"], ["Torna al menu"]]
		}
	};


	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		connection.query('SELECT team_id FROM team_player WHERE player_id=' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0) {
				bot.sendMessage(message.chat.id, "Non sei in un team!", back)
				return;
			}

			var team_id = rows[0].team_id;

			connection.query('SELECT boss_team.life, boss_team.total_life, boss_team.killedby, boss_team.killeddate, boss.name FROM boss_team, boss WHERE boss_team.boss_id = boss.id AND unlocked = 1 AND team_id = ' + team_id + ' ORDER BY boss_id', function (err, rows, fields) {
				if (err) throw err;
				var boss_list = "\n";
				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].life <= 0) {
						if (rows[i].killeddate != null) {
							var d = new Date(rows[i].killeddate);
							var short_date = addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + " del " + addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1);
						} else {
							var short_date = "?";
						}
						boss_list += (i + 1) + ". <b>" + rows[i].name + "</b> (" + rows[i].killedby + " alle " + short_date + ")\n";
					} else {
						boss_list += (i + 1) + ". <b>" + rows[i].name + "</b> (" + rows[i].life + "/" + rows[i].total_life + " hp)\n";
					}
				}
				connection.query('SELECT boss_respawn FROM team WHERE id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					if (rows[0].boss_respawn != null) {
						var d = new Date(rows[0].boss_respawn);
						var short_time = addZero(d.getHours()) + ":" + addZero(d.getMinutes()) + ":" + addZero(d.getSeconds());
						var short_date = addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear();

						boss_list += "I boss tornano in vita il " + short_date + " alle " + short_time;
					}
					bot.sendMessage(message.chat.id, boss_list, bossKb);
				});
			});
		});
	});
});

bot.onText(/^pozioni|utilizzabili boss|^âš’$/i, function (message) {
	connection.query('SELECT id, life, total_life, boss_id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var life = rows[0].life;
		var total_life = rows[0].total_life;
		var boss_id = rows[0].boss_id;

		if (life <= 0) {
			bot.sendMessage(message.chat.id, "Sei morto, per tornare in vita ti serve una Piuma di Fenice!", revive);
			return;
		}

		if (message.text.indexOf("Utilizzabili") != -1) {
			if (message.text.indexOf("Boss") != -1) {
				Consumabili(message, player_id, 1, total_life, life, boss_id);
			}
		} else if (message.text.toLowerCase().indexOf("pozioni") != -1) {
			Consumabili(message, player_id, 2, total_life, life, 0);
		} else if (message.text.indexOf("âš’") != -1) {
			Consumabili(message, player_id, 4, total_life, life, 0);
		}
	});
});

bot.onText(/Torna in Vita/i, function (message) {

	connection.query('SELECT id, life, total_life, refilled, gender, class, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var player_id = rows[0].id;
		var life = rows[0].life;
		var total_life = rows[0].total_life;
		var refilled = rows[0].refilled;
		var class_id = rows[0].class;
		var reborn = rows[0].reborn;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 6', function (err, rows, fields) {
			if (err) throw err;

			var att = 0;
			if (Object.keys(rows).length > 0) {
				if (rows[0].ability_level > 0) {
					att = Math.ceil(rows[0].ability_level / 2);
				}
			}

			if ((class_id == 5) && (reborn == 5)) {
				att += 5;
			}

			var piume = getItemCnt(player_id, 619);
			var ceneri = getItemCnt(player_id, 647);

			var iKeys = [];

			if (piume > 0)
				iKeys.push(["Piuma di Fenice (" + piume + ")"]);

			if (ceneri > 0)
				iKeys.push(["Cenere di Fenice (" + ceneri + ")"]);

			if ((att - refilled) > 0)
				iKeys.push(["Intervento Divino (" + (att - refilled) + ")"]);

			iKeys.push(["Torna al menu"]);

			var kbHeal = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			var kbBack = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Affronta Boss"], ["Dungeon"], ["Torna al menu"]]
				}
			};

			if (life <= 0) {
				bot.sendMessage(message.chat.id, "Vuoi usare una Piuma di Fenice o una Cenere di Fenice per tornare in vita? Nel caso della Piuma dovrai attendere 3 minuti prima di tornare ad affrontare i boss!", kbHeal).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text.indexOf("Piuma di Fenice") != -1) {

							if (getItemCnt(player_id, 619) == 0) {
								bot.sendMessage(message.chat.id, "Non possiedi nessuna Piuma di Fenice", back);
							} else {
								delItem(player_id, 619, 1);
								var ten = total_life / 100 * 10;
								var perc = 0;
								var life = ten;
								var abBonus = 0;

								var now = new Date();
								now.setMinutes(now.getMinutes() + 3);
								var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
								var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());

								connection.query('UPDATE player SET life = ' + life + ', res_time = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Bentornat" + gender_text + "! ðŸŒŸ", kbBack);
									setAchievement(message.chat.id, player_id, 20, 1);
								});
							}
						} else if (answer.text.indexOf("Cenere di Fenice") != -1) {

							if (getItemCnt(player_id, 647) == 0) {
								bot.sendMessage(message.chat.id, "Non possiedi nessuna Cenere di Fenice", back);
							} else {
								delItem(player_id, 647, 1);
								connection.query('UPDATE player SET life = total_life WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "Bentornat" + gender_text + "! ðŸŒŸ", kbBack);
									setAchievement(message.chat.id, player_id, 20, 1);
								});
							}
						} else if (answer.text.indexOf("Intervento Divino") != -1) {
							connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 6', function (err, rows, fields) {
								if (err) throw err;

								if (Object.keys(rows).length == 0) {
									bot.sendMessage(message.chat.id, "Devi apprendere questo talento prima di poterlo utilizzare", back);
									return;
								}

								if (rows[0].ability_level == 0) {
									bot.sendMessage(message.chat.id, "Devi apprendere questo talento prima di poterlo utilizzare", back);
									return;
								}

								var att = Math.ceil(rows[0].ability_level / 2);
								if ((class_id == 5) && (reborn == 5)) {
									att += 5;
								}
								if (refilled >= att) {
									bot.sendMessage(message.chat.id, "Hai giÃ  consumato le " + att + " opportunitÃ  di oggi!", back);
									return;
								}

								var refill = Math.floor(total_life * (rows[0].ability_level / 10)); // Cura = livello*10%
								connection.query('UPDATE player SET refilled = refilled+1, life = ' + refill + ' WHERE id = ' + player_id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(message.chat.id, "L'Intervento Divino ti ha concesso di tornare in battaglia con " + formatNumber(refill) + "/" + formatNumber(total_life) + " hp!", kbBack);
									setAchievement(message.chat.id, player_id, 20, 1);
								});
							});
						}
					}
				});
			} else {
				bot.sendMessage(message.chat.id, "Sei in salute, non Ã¨ necessario tornare in vita", back);
			}
		});
	});
});

function calcConsumabili(boss_total_life, damage){
	return Math.round((boss_total_life/100 + 1000)*damage*(0.8+Math.random()*0.4));
}

function Consumabili(message, player_id, from, player_total_life, player_life, boss_id) {

	var query = "";
	if ((from == 1) || (from == 3)) { //BOSS	
		query = 'SELECT item.name, item.id, inventory.quantity As num, item.category, item.cons_val FROM inventory, item WHERE inventory.item_id = item.id AND category IN (1,4) AND player_id = ' + player_id + ' AND inventory.quantity > 0';
	} else if ((from == 2) || (from == 4)) { //ZAINO - DUNGEON
		query = 'SELECT item.name, item.id, inventory.quantity As num, item.category, item.cons_val FROM inventory, item WHERE inventory.item_id = item.id AND category = 1 AND player_id = ' + player_id + ' AND inventory.quantity > 0';
	}

	connection.query('SELECT * FROM boss_team WHERE id = ' + boss_id, function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			var boss_life = rows[0].life;
			var boss_total_life = rows[0].total_life;
		}
		connection.query(query, function (err, rows, fields) {
			if (err) throw err;
			var itemKeys = [];

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": itemKeys
				}
			};

			var kbAgain = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Usa Ancora"], ["Affronta Boss", "Torna al dungeon"], ["Torna al menu"]]
				}
			};
			var kbAgainD = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Usa Ancora"], ["Torna al dungeon"], ["Torna al menu"]]
				}
			};

			if (Object.keys(rows).length > 0) {
				var desc = "";
				var perc = 0;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					if (rows[i].category == 1){
						perc = Math.round((player_total_life / 100) * rows[i].cons_val);
						desc = "Recupera " + perc + " hp";
					}else if (rows[i].category == 4){
						perc = calcConsumabili(boss_total_life, rows[i].cons_val);
						desc = (rows[i].cons_val*10) + " gigatoni";
					}

					itemKeys.push([rows[i].name + " (" + rows[i].num + ") - " + desc]);
				}
				if (from == 1) {
					itemKeys.push(["Affronta Boss"]);
				}
				if (from == 2) {
					itemKeys.push(["Torna allo Zaino"]);
				}
				if (from == 4) {
					itemKeys.push(["Torna al dungeon"]);
				}
				itemKeys.push(["Torna al menu"]);

				bot.sendMessage(message.chat.id, "Quale oggetto vuoi usare?\nPossiedi " + formatNumber(player_life) + "/" + formatNumber(player_total_life) + " hp", kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {

						var oggetto = answer.text;
						if (oggetto == "Affronta Boss") {
							return;
						} else if (oggetto == "Torna al menu") {
							return;
						} else if (oggetto == "Torna allo Zaino") {
							return;
						} else if (oggetto == "Torna al dungeon") {
							return;
						}

						var pos = oggetto.indexOf(" (");
						if (pos != -1) {
							oggetto = oggetto.substring(0, pos);
						}
						connection.query('SELECT id, category, cons_val FROM item WHERE name = "' + oggetto + '"', function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length <= 0) {
								if ((from == 2) || (from == 3)) {
									bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste!", back);
								} else {
									bot.sendMessage(message.chat.id, "L'oggetto specificato non esiste!", kb);
								}
								return;
							}

							var item_id = rows[0].id;
							var category = rows[0].category;
							var gigatoni = 0;

							if (category == 1){
								perc = Math.round((player_total_life / 100) * rows[0].cons_val);
							}else if (category == 4){
								perc = calcConsumabili(boss_total_life, rows[0].cons_val);
								gigatoni = rows[0].cons_val*10;
							}else{
								if (from == 4) {
									bot.sendMessage(message.chat.id, "Oggetto non valido", kbAgainD);
								} else {
									bot.sendMessage(message.chat.id, "Oggetto non valido", kbAgain);
								}
								return;
							}

							if (category == 1) {
								if (item_id == 92) {
									var kbNum = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": [["1", "2", "3"], ["19", "20"], ["Torna al menu"]]
										}
									};
								} else if (item_id == 93) {
									var kbNum = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": [["1", "2", "3"], ["9", "10"], ["Torna al menu"]]
										}
									};
								} else {
									var kbNum = {
										parse_mode: "Markdown",
										reply_markup: {
											resize_keyboard: true,
											//one_time_keyboard: true,
											"keyboard": [["1", "2", "3"], ["4", "5"], ["Torna al menu"]]
										}
									};
								}

								if (player_life <= 0) {
									bot.sendMessage(message.chat.id, "Sei morto, per tornare in vita ti serve una Piuma di Fenice o la Cenere di Fenice!", revive);
									return;
								}

								bot.sendMessage(message.chat.id, "Quante pozioni vuoi usare?", kbNum).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {

										var qnt = parseInt(answer.text);
										if ((answer.text == "Torna al menu") || (answer.text == "Affronta boss")) {
											return;
										}
										if ((qnt < 1) || (qnt > 20) || (re.test(qnt) == false)) {
											if (from == 4) {
												bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbAgainD);
											} else {
												bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbAgain);
											}
											return;
										}

										connection.query('SELECT name FROM item WHERE id = ' + item_id, function (err, rows, fields) {
											if (err) throw err;

											if (getItemCnt(player_id, item_id) < qnt) {
												if (from == 4) {
													bot.sendMessage(message.chat.id, "Non hai abbastanza pozioni", kbAgainD);
												} else {
													bot.sendMessage(message.chat.id, "Non hai abbastanza pozioni", kbAgain);
												}
												return;
											}

											var itemName = rows[0].name;

											delItem(player_id, item_id, qnt);
											perc = perc * qnt;
											setAchievement(message.chat.id, player_id, 35, qnt);

											var all = 0;
											if ((player_life + perc) >= player_total_life) {
												perc = player_total_life - player_life;
												all = 1;
											}

											connection.query('UPDATE player SET life = life+' + perc + ' WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												if (all == 1) {
													if ((from == 2) || (from == 3)) {
														bot.sendMessage(message.chat.id, "Hai recuperato tutti gli hp!", kbAgain).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss") && (answer.text != "Torna al dungeon")) {
																	player_life = player_total_life;
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
													} else if (from == 4) {
														bot.sendMessage(message.chat.id, "Hai recuperato tutti gli hp!", kbAgainD).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss") && (answer.text != "Torna al dungeon")) {
																	player_life = player_total_life;
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
													} else {
														bot.sendMessage(message.chat.id, "Hai recuperato tutti gli hp!", kbAgain).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss") && (answer.text != "Torna al dungeon")) {
																	player_life = player_total_life;
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
													}
												} else {
													if ((from == 2) || (from == 3)) {
														bot.sendMessage(message.chat.id, "Hai usato " + qnt + "x " + itemName + ", hai recuperato " + perc + " hp, ora hai " + (player_life + perc) + "/" + player_total_life + " hp!", kbAgain).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss") && (answer.text != "Torna al dungeon")) {
																	player_life = player_life + perc;
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
													} else if (from == 4) {
														bot.sendMessage(message.chat.id, "Hai usato " + qnt + "x " + itemName + ", hai recuperato " + perc + " hp, ora hai " + (player_life + perc) + "/" + player_total_life + " hp!", kbAgainD).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss") && (answer.text != "Torna al dungeon")) {
																	player_life = player_life + perc;
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
													} else {
														bot.sendMessage(message.chat.id, "Hai usato " + qnt + "x " + itemName + ", hai recuperato " + perc + " hp, ora hai " + (player_life + perc) + "/" + player_total_life + " hp!", kbAgain).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss") && (answer.text != "Torna al dungeon")) {
																	player_life = player_life + perc;
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
													}
												}
											});
										});
									};
								});
							} else if (category == 4) {

								var kbNum = {
									parse_mode: "Markdown",
									reply_markup: {
										resize_keyboard: true,
										//one_time_keyboard: true,
										"keyboard": [["1", "5", "10"], ["25", "50", "100"], ["Torna al menu"]]
									}
								};

								bot.sendMessage(message.chat.id, "Quanti ne vuoi usare?", kbNum).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {

										var qnt = parseInt(answer.text);
										if ((answer.text == "Torna al menu") || (answer.text == "Affronta boss")) {
											return;
										}
										if ((qnt < 1) || (qnt > 100) || (re.test(qnt) == false)) {
											if (from == 4) {
												bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbAgainD);
											} else {
												bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbAgain);
											}
											return;
										}

										connection.query('SELECT name FROM item WHERE id = ' + item_id, function (err, rows, fields) {
											if (err) throw err;

											if (getItemCnt(player_id, item_id) < qnt) {
												if (from == 4) {
													bot.sendMessage(message.chat.id, "Non hai abbastanza oggetti", kbAgainD);
												} else {
													bot.sendMessage(message.chat.id, "Non hai abbastanza oggetti", kbAgain);
												}
												return;
											}

											var item_name = rows[0].name;

											connection.query('SELECT boss_id FROM boss_team WHERE id = ' + boss_id, function (err, rows, fields) {
												if (err) throw err;

												if (Object.keys(rows).length == 0) {
													bot.sendMessage(message.chat.id, "Boss non valido", back);
													return;
												}

												if (rows[0].boss_id == 31) {
													perc = 0;
													gigatoni = 0;
												}

												perc = perc * qnt;

												connection.query('SELECT * FROM boss_team WHERE id = ' + boss_id, function (err, rows, fields) {
													if (err) throw err;
													if (Object.keys(rows).length > 0) {
														boss_life = rows[0].life;
														boss_total_life = rows[0].total_life;
													}

													if ((boss_life - perc) <= 0) {
														bot.sendMessage(message.chat.id, "Il bersaglio ha pochi hp, non puoi usare un oggetto lanciabile per ucciderlo.", kbAgain).then(function () {
															answerCallbacks[message.chat.id] = function (answer) {
																if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss")) {
																	Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																	return;
																}
															};
														});
														return;
													}

													connection.query('SELECT * FROM boss_team WHERE id = ' + boss_id, function (err, rows, fields) {
														if (err) throw err;

														var lifeB = rows[0].life;
														var totlifeB = rows[0].total_life;

														if (lifeB <= 0) {
															connection.query('UPDATE `player` SET boss_id = NULL WHERE id=' + player_id, function (err, rows, fields) {
																if (err) throw err;
																bot.sendMessage(message.chat.id, "Purtroppo il boss Ã¨ giÃ  stato sconfitto, riprova domani o selezionane un altro.", back);
																return;
															});
														} else {
															connection.query('UPDATE boss_team SET life = life-' + perc + ' WHERE id = ' + boss_id, function (err, rows, fields) {
																if (err) throw err;
																delItem(player_id, item_id, qnt);

																bot.sendMessage(message.chat.id, "Hai usato " + qnt + "x " + item_name + ", hai inflitto " + formatNumber(perc) + " danni!\nSalute boss: " + (lifeB - perc) + "/" + totlifeB, kbAgain).then(function () {
																	answerCallbacks[message.chat.id] = function (answer) {
																		if ((answer.text != "Torna al menu") && (answer.text != "Affronta Boss")) {
																			Consumabili(message, player_id, from, player_total_life, player_life, boss_id);
																			return;
																		}
																	};
																});
																setAchievement(message.chat.id, player_id, 29, perc);
															});
														};
													});
												});
											});
										});
									};
								});
							}
						});
					};
				});
			} else {
				var Keys = [];
				if (from == 1) {
					Keys.push(["Affronta Boss"]);
				} else {
					Keys.push(["Torna al menu"]);
				}

				var kbBack = {
					parse_mode: "Markdown",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": Keys
					}
				};

				bot.sendMessage(message.chat.id, "Non possiedi nessun consumabile, creali o cercali nelle missioni.", kbBack);
			}
		});
	});
}

bot.onText(/spia rifugio|spia:/i, function (message) {

	var spy_null = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Nessuno"], ["Torna al rifugio"]]
		}
	};

	if (!checkSpam(message)) {
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (rows[0].spy_count >= 25) {
			bot.sendMessage(message.chat.id, "Hai raggiunto il limite giornaliero.");
			return;
		}

		var player_id = rows[0].id;
		var level = Math.floor(rows[0].exp / 10);
		var power = rows[0].weapon;
		var myhouse = rows[0].house_id;

		if (rows[0].money < 500) {
			bot.sendMessage(message.chat.id, "Non hai abbastanza soldi.", back);
			return;
		}

		if (rows[0].heist_protection != null) {
			bot.sendMessage(message.chat.id, "A causa del campo di forza non puoi spiare gli altri utenti", back);
			return;
		}

		if (message.text.indexOf(":") != -1) {
			var player = message.text.substring(message.text.indexOf(":") + 1);
			player = player.replace("@", "").trim();

			connection.query('SELECT id, heist_protection, chat_id, account_id, house_id FROM player WHERE nickname = "' + player + '"', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
				} else {
					var chat_id = rows[0].chat_id;
					var house_id = rows[0].house_id;

					if (player_id != 1){
						var banReason = isBanned(rows[0].account_id);
						if (banReason != null) {
							bot.sendMessage(message.chat.id, "Non puoi spiare un giocatore bannato", back);
							return;
						}

						if (rows[0].heist_protection != null) {
							bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione", back);
							return;
						}
					}

					if (rows[0].id == 1) {
						bot.sendMessage(message.chat.id, "Guardone :>", back);
						return;
					}

					if (rows[0].id == 3) {
						bot.sendMessage(message.chat.id, "Non si fanno ste cose :c", back);
						return;
					}

					if (player_id == rows[0].id) {
						bot.sendMessage(message.chat.id, "Per visualizzare il tuo equipaggiamento visita la sezione Giocatore", back);
						return;
					}

					setAchievement(message.chat.id, player_id, 42, 1);
					getInfo(message, player, myhouse);
					connection.query('UPDATE player SET spy_count = spy_count+1, money = money-500 WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
						if (err) throw err;
					});

					if (player_id != 1) {
						if (house_id == 1) {
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno ha spiato il tuo rifugio!");
						} else if (house_id == 2) {
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno *di livello " + level + "* ha spiato il tuo rifugio!", mark);
						} else if ((house_id == 3) || (house_id == 4)) {
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che *un livello " + level + ", con +" + power + " di danno* ha spiato il tuo rifugio!", mark);
						} else if (house_id >= 5) {
							bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che <b>" + message.from.username + "</b> ha spiato il tuo rifugio!", html);
						}
					}
				}
			});
			return;
		}

		bot.sendMessage(message.chat.id, "Puoi spiare un rifugio inserendo il nickname del giocatore, dovrai pagare 500 Â§!\nInserisci il nickname del giocatore oppure scrivi *Spia: Nomegiocatore*", spy_null).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				var player = answer.text;
				if ((player == "Nessuno") || (player == "Torna al rifugio"))
					return;

				player = player.replace("@", "").trim();

				connection.query('SELECT id, heist_protection, chat_id, house_id, account_id FROM player WHERE nickname="' + player + '"', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var chat_id = rows[0].chat_id;
						var house_id = rows[0].house_id;

						if (player_id != 1){
							var banReason = isBanned(rows[0].account_id);
							if (banReason != null) {
								bot.sendMessage(message.chat.id, "Non puoi spiare un giocatore bannato", back);
								return;
							}

							if (rows[0].heist_protection != null) {
								bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione", back);
								return;
							}
						}

						if (rows[0].id == 1) {
							bot.sendMessage(message.chat.id, "Guardone :>", back);
							return;
						}

						if (rows[0].id == 3) {
							bot.sendMessage(message.chat.id, "Non si fanno ste cose :c", back);
							return;
						}

						if (player_id == rows[0].id) {
							bot.sendMessage(message.chat.id, "Per visualizzare il tuo equipaggiamento visita la sezione Giocatore", back);
							return;
						}

						setAchievement(message.chat.id, player_id, 42, 1);
						getInfo(message, player, myhouse);
						connection.query('UPDATE player SET spy_count = spy_count+1, money = money-500 WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
							if (err) throw err;
						});

						if (player_id != 1) {
							if (house_id == 1) {
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno ha spiato il tuo rifugio!");
							} else if (house_id == 2) {
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che qualcuno *di livello " + level + "* ha spiato il tuo rifugio!", mark);
							} else if ((house_id == 3) || (house_id == 4)) {
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che *un livello " + level + ", con +" + power + " di danno* ha spiato il tuo rifugio!", mark);
							} else if (house_id >= 5) {
								bot.sendMessage(chat_id, "Le pattuglie intorno al villaggio ci hanno avvisato che <b>" + message.from.username + "</b> ha spiato il tuo rifugio!", html);
							}
						}
					} else {
						bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
					}
				});
			};
		});
	});
});

bot.onText(/lootteria/i, function (message) {
	if (lootteria == 0) {
		bot.sendMessage(message.chat.id, "Lo lootteria Ã¨ ancora chiusa!", back);
		return;
	}

	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["1 Biglietto (2.500 Â§)", "5 Biglietti (10.000 Â§)"], ["20 Biglietti (40.000 Â§)"], ["Torna al menu"]]
		}
	};

	var today = new Date();
	if ((today.getDay() != 6) && (today.getDay() != 0)) {
		bot.sendMessage(message.chat.id, "Oggi la lootteria Ã¨ chiusa! Torna nel weekend!", back);
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if ((rows[0].exp / 10 < 25) && (rows[0].reborn == 1)) {
			bot.sendMessage(message.chat.id, "Devi essere almeno livello 25 per partecipare alla lootteria", back)
			return;
		}

		if (rows[0].craft_count <= 100) {
			bot.sendMessage(message.chat.id, "Devi possedere almeno 100 punti creazione per partecipare alla lootteria", back)
			return;
		}

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		var date = new Date();
		var text = "";

		connection.query('SELECT extracted FROM `event_lottery_prize` WHERE day >= ' + date.getDay(), function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].extracted == 1) {
				bot.sendMessage(message.chat.id, "L'estrazione Ã¨ in corso o Ã¨ terminata, segui @EstrazioniLootteria!", back)
				return;
			}
			connection.query('SELECT COUNT(*) As num FROM event_lottery_coins WHERE player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function (err, rows, fields) {
				if (err) throw err;
				var ticketNum = rows[0].num;
				bot.sendMessage(message.chat.id, "Benvenut" + gender_text + " nella Lootteria!\nAcquista biglietti per avere piÃ¹ probabilitÃ  di essere estratt" + gender_text + ", l'estrazione avverrÃ  ogni sabato e domenica tra le 17 e le 20 e potrÃ  essere seguita su @EstrazioniLootteria!\nPossiedi " + ticketNum + "/20 biglietti", kb);
			});
		});
	});
});

bot.onText(/bigliett/i, function (message) {
	if (lootteria == 0) {
		bot.sendMessage(message.chat.id, "Lo lootteria Ã¨ chiusa!", back);
		return;
	}

	if (lootteria == 1) {
		var today = new Date();
		if ((today.getDay() != 6) && (today.getDay() != 0)) {
			bot.sendMessage(message.chat.id, "Oggi la lootteria Ã¨ chiusa! Torna nel weekend!", back);
			return;
		}
	}

	var ticketNum = parseInt(message.text.substring(0, message.text.indexOf(" ")));

	if ((ticketNum != 1) && (ticketNum != 2) && (ticketNum != 3) && (ticketNum != 4) && (ticketNum != 5) && (ticketNum != 20)) {
		bot.sendMessage(message.chat.id, "Numero biglietti non valido", back);
		return;
	}

	if (lootteriaBlock == 1) {
		bot.sendMessage(message.chat.id, "Non Ã¨ momentaneamente possibile acquistare biglietti", back);
		return;
	}

	bot.sendMessage(message.chat.id, "Confermi l'acquisto di " + ticketNum + " biglietti?", yesno).then(function () {
		answerCallbacks[message.chat.id] = function (answer) {
			if (answer.text.toLowerCase() == "si") {

				var date = new Date();

				connection.query('SELECT extracted FROM `event_lottery_prize`, item WHERE item.id = event_lottery_prize.item_id AND day >= ' + date.getDay(), function (err, rows, fields) {
					if (err) throw err;
					if (rows[0].extracted == 1) {
						bot.sendMessage(message.chat.id, "Durante l'estrazione non puoi acquistare biglietti!", back)
						return;
					}

					connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
						if (err) throw err;
						var player_id = rows[0].id;
						var money = rows[0].money;

						if (rows[0].craft_count <= 100) {
							bot.sendMessage(message.chat.id, "Non hai abbastanza punti creazione per partecipare alla lootteria", back)
							return;
						}

						if ((rows[0].exp / 10 < 25) && (rows[0].reborn == 1)) {
							bot.sendMessage(message.chat.id, "Devi essere almeno livello 25 per partecipare alla lootteria", back)
							return;
						}

						connection.query('SELECT COUNT(*) As num FROM event_lottery_coins WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							var playerTicket = parseInt(rows[0].num);

							if ((playerTicket > 20) || (playerTicket + ticketNum > 20)) {
								bot.sendMessage(message.chat.id, "Puoi possedere al massimo 20 biglietti per estrazione", back);
								return;
							}

							var tot = ticketNum * 2500;
							if (ticketNum == 5) {
								tot = 10000;
							} else if (ticketNum == 20) {
								tot = 40000;
							}

							if (money - tot <= 0) {
								bot.sendMessage(message.chat.id, "Non hai abbastanza soldi", back);
								return;
							}

							for (var i = 0; i < ticketNum; i++) {
								connection.query('INSERT INTO event_lottery_coins (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
									if (err) throw err;
								});
							}
							connection.query('UPDATE player SET money = money - ' + tot + ' WHERE id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai acquistato " + ticketNum + " biglietti per " + formatNumber(tot) + " Â§!", back);
							});
						});
					});
				});
			};
		};
	});
});

bot.onText(/necro del destino/i, function (message) {
	connection.query('SELECT id, account_id, holiday, necro_pnt, reborn FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back);
			return;
		}

		var player_id = rows[0].id;
		var necro_pnt = rows[0].necro_pnt;

		if (rows[0].reborn < 5){
			bot.sendMessage(message.chat.id, "Per accedere a questa funzione Ã¨ necessaria la Rinascita 4!", back);
			return;
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Scambia Necrospiriti ðŸ’ "], ["Ottieni Ricompense ðŸ”®"], ["Torna al menu"]]
			}
		};

		var kbBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Torna alla Necro del Destino"], ["Torna al menu"]]
			}
		};

		connection.query('SELECT step FROM necro_game WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var step = 0;
			if (Object.keys(rows).length == 0){
				connection.query('INSERT INTO necro_game (player_id) VALUES (' + player_id + ')', function (err, rows, fields) {
					if (err) throw err;
				});
			}else{
				step = rows[0].step;
			}

			bot.sendMessage(message.chat.id, "Benvenuto nella Necro del Destino ðŸ”®\nPuoi accumulare Necrospiriti ðŸ’  scambiandoli per oggetti U, e successivamente richiedere un premio, puoi ottenerli anche dalla Ruota della Luna. Cosa vuoi fare?\n\nAttualmente possiedi *" + necro_pnt + "* ðŸ’ ", kb).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {
					if (answer.text.toLowerCase().indexOf("scambia") != -1){

						connection.query('SELECT item.name, inventory.quantity As cnt FROM inventory, item WHERE inventory.item_id = item.id AND item.rarity = "U" AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length == 0){
								bot.sendMessage(message.chat.id, "Non hai alcun oggetto U da poter scambiare!", kbBack);
								return;
							}

							var iKeys = [];
							for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
								iKeys.push([rows[i].name + " (" + rows[i].cnt + ")"]);
							}

							iKeys.push(["Torna al menu"]);

							var itemList = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": iKeys
								}
							};

							var itemQnt = {
								parse_mode: "Markdown",
								reply_markup: {
									resize_keyboard: true,
									//one_time_keyboard: true,
									"keyboard": [["1","5","10"],["Torna alla Necro del Destino"]]
								}
							};

							bot.sendMessage(message.chat.id, "Seleziona l'oggetto U da scambiare", itemList).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text == "Torna al menu"){
										return;
									}else{

										var itemName = answer.text.substr(0, answer.text.indexOf("(")-1);

										bot.sendMessage(message.chat.id, "Inserisci la quantitÃ  di copie dell'oggetto da scambiare", itemQnt).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text == "Torna al menu"){
													return;
												}else{

													var qnt = parseInt(answer.text);
													if (isNaN(qnt)){
														bot.sendMessage(message.chat.id, "QuantitÃ  non valida", kbBack);
														return;
													}
													if ((qnt < 1) || (qnt > 10)){
														bot.sendMessage(message.chat.id, "QuantitÃ  non valida, minimo 1 e massimo 10 copie", kbBack);
														return;
													}


													connection.query('SELECT item.id, inventory.quantity As cnt FROM inventory, item WHERE inventory.item_id = item.id AND item.rarity = "U" AND inventory.player_id = ' + player_id + ' AND item.name = "' + itemName  + '"', function (err, rows, fields) {
														if (err) throw err;

														if (rows[0].cnt < qnt){
															bot.sendMessage(message.chat.id, "Non possiedi abbastanza copie dell'oggetto specificato!", kbBack);
															return;
														}

														delItem(player_id, rows[0].id, qnt);
														connection.query('UPDATE player SET necro_pnt = necro_pnt+' + qnt + ' WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Hai consumato gli oggetti e ottenuto " + qnt + " Necrospiriti ðŸ’ !", kbBack);
														});
													});
												}
											}
										});
									}
								}
							});
						});
					}else if (answer.text.toLowerCase().indexOf("ottieni") != -1){
						var prizeList = {
							parse_mode: "HTML",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Ricompensa 1", "Ricompensa 2"], ["Ricompensa 3", "Ricompensa 4"], ["Ricompensa 5", "Ricompensa 6"], ["Torna alla Necro del Destino"]]
							}
						};

						var dYesNo = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Si"], ["Torna alla Necro del Destino"]]
							}
						};

						bot.sendMessage(message.chat.id, "Con i Necrospiriti ðŸ’  puoi acquistare diversi oggetti:" +
										"\n> 2 Oggetti Casuali fino a UE (1)" + (step >= 1 ? " âœ…" : "") +
										"\n> 50 ðŸ’Ž (5)" + (step >= 2 ? " âœ…" : "") +
										"\n> Amuleto del Necrospirito (10)" + (step >= 3 ? " âœ…" : "") +
										"\n> 1 Frutto del Set Frutta (S) (15)" + (step >= 4 ? " âœ…" : "") +
										"\n> Salmone (S) (25)" + (step >= 5 ? " âœ…" : "") +
										"\n> Trasmogrificazione in Necrolama di Phoenix (50)\n\n" + (step >= 6 ? " âœ…" : "") +
										"\nOgni ricompensa puÃ² essere riscattata solo una volta ma devono essere riscattate in ordine. La prima puÃ² essere riscattata piÃ¹ volte dopo averle ottenute tutte.\n\n" +
										"Attualmente possiedi <b>" + necro_pnt + "</b> ðŸ’ ", prizeList).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if (answer.text.toLowerCase().indexOf("ricompensa") != -1){

									var num = parseInt(answer.text.split(" ")[1]);

									if (isNaN(num)){
										bot.sendMessage(message.chat.id, "Ricompensa non valida", kbBack);
										return;
									}
									if ((num < 1) || (num > 6)){
										bot.sendMessage(message.chat.id, "Ricompensa non valida, minimo 1 massimo 6", kbBack);
										return;
									}

									var ok = 0;
									if ((num == 1) && (step == 6)){
										ok = 1;
									}

									if (ok == 0){
										if (step < num-1){
											bot.sendMessage(message.chat.id, "Devi prima riscattare le ricompense precedenti!", kbBack);
											return;
										}
										if (step >= num){
											bot.sendMessage(message.chat.id, "Hai giÃ  riscattato questa ricompensa!", kbBack);
											return;
										}
									}

									var cost = 0;
									if (num == 1){
										cost = 1;
									}else if (num == 2){
										cost = 5;
									}else if (num == 3){
										cost = 10;
									}else if (num == 4){
										cost = 15;
									}else if (num == 5){
										cost = 25;
									}else if (num == 6){
										cost = 50;
									}else{
										bot.sendMessage(message.chat.id, "Ricompensa non valida", kbBack);
										return;
									}

									bot.sendMessage(message.chat.id, "Sei sicuro di voler spendere " + cost + " ðŸ’ ?", dYesNo).then(function () {
										answerCallbacks[message.chat.id] = function (answer) {
											if (answer.text.toLowerCase() == "si"){
												connection.query('SELECT necro_pnt FROM player WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;

													if (rows[0].necro_pnt < cost){
														bot.sendMessage(message.chat.id, "Non hai abbastanza ðŸ’ ", kbBack);
														return;
													}

													connection.query('UPDATE player SET necro_pnt = necro_pnt-' + cost + ' WHERE id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;

														var text = "Hai speso " + cost + " ðŸ’  ed ottenuto:\n";
														if (num == 1){
															var rows = connection_sync.query('SELECT id, name, rarity FROM item WHERE rarity NOT IN ("C","NC","X","S","IN","A") ORDER BY RAND()');
															addItem(player_id, rows[0].id);
															addItem(player_id, rows[1].id);
															text += "> " + rows[0].name + " (" + rows[0].rarity + ")\n";
															text += "> " + rows[1].name + " (" + rows[1].rarity + ")";
														}else if (num == 2){
															connection.query('UPDATE player SET gems = gems+50 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
															text += "> 50 ðŸ’Ž";
														}else if (num == 3){
															addItem(player_id, 753);
															text += "> Amuleto del Necrospirito (IN)";
														}else if (num == 4){
															var rows = connection_sync.query('SELECT id, name FROM item WHERE id IN (264, 266, 272) ORDER BY RAND()');
															addItem(player_id, rows[0].id);
															text += "> " + rows[0].name + " (S)\n";
														}else if (num == 5){
															addItem(player_id, 651);
															text += "> Salmone (S)";
														}else if (num == 6){
															text += "> PossibilitÃ  di Trasmogrificazione in Necrolama di Phoenix (X)";
														}

														if ((step == 6) && (num == 1)){
															connection.query('UPDATE necro_game SET step = 6 WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}else{
															connection.query('UPDATE necro_game SET step = ' + num + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}

														bot.sendMessage(message.chat.id, text, kbBack);
													});
												});
											}
										}
									});
								}
							}
						});
					}
				};
			});
		});
	});
});

bot.onText(/Sfide del Destino/i, function (message) {
	var kb = {
		parse_mode: "Markdown",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Ruota della Luna ðŸŒ•"], ["Necro del Destino ðŸ”®"], ["Torna al menu"]]
		}
	};
	bot.sendMessage(message.chat.id, "Seleziona il tipo di prova che vuoi affrontare", kb);
});

bot.onText(/Contatta lo Gnomo|Torna dallo Gnomo|^gnomo/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var myexp = rows[0].exp;
		var house_id = rows[0].house_id;
		var lev = Math.floor(myexp / 10);
		var life = rows[0].life;
		var reborn = rows[0].reborn;
		var ability = rows[0].ability;
		var heist_protection = rows[0].heist_protection;
		var heist_streak = rows[0].heist_streak;
		var global_end = rows[0].global_end;

		connection.query('SELECT * FROM heist_progress WHERE from_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				var kb = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Cambia Rune", "Tieni Combinazione"], ["Rinuncia", "Regole"], ["Torna al Rifugio"]]
					}
				};

				var kbBack = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Torna al Rifugio"], ["Torna al menu"]]
					}
				};

				var rBack = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Torna dallo Gnomo", "Torna al Rifugio"], ["Torna al menu"]]
					}
				};

				var kbYesNo = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["Si"], ["Torna dallo gnomo"]]
					}
				};

				var kbNum = {
					parse_mode: "HTML",
					reply_markup: {
						resize_keyboard: true,
						//one_time_keyboard: true,
						"keyboard": [["1", "2", "3"], ["4", "5"], ["1,2,3,4,5"], ["Torna dallo gnomo"]]
					}
				};

				var my_comb = "";
				var travel = parseInt(rows[0].travel);
				travel++;
				var combi = String(rows[0].combination);
				var isMatch = rows[0].isMatch;
				var toId = rows[0].to_id;

				if (rows[0].wait_time != null) {
					var now = new Date(rows[0].wait_time);
					var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());
					bot.sendMessage(message.chat.id, "Il tuo gnomo sta ancora raccogliendo le rune, attendi fino alle " + short_date, back);
					return;
				}

				if (rows[0].my_combination == 0) {
					for (i = 0; i < 5; i++) {
						my_comb += String(Math.round(Math.random() * 5 + 1));
					}

					my_comb = String(my_comb);

					var now = new Date();
					now.setMinutes(now.getMinutes() + 5);
					var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
					var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());

					connection.query('UPDATE heist_progress SET my_combination = ' + my_comb + ', wait_time = "' + long_date + '", travel=travel+1 WHERE from_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						bot.sendMessage(message.chat.id, "Il tuo gnomo Ã¨ andato a recuperare alcune rune, dovrai attendere il suo ritorno alle " + short_date, back);
					});
					return;
				} else {
					my_comb = String(rows[0].my_combination);
				}

				connection.query("SELECT chat_id, nickname FROM player WHERE id = " + toId, function (err, rows, fields) {
					if (err) throw err;

					var nick = rows[0].nickname;
					var toChat = rows[0].chat_id;
					var my_comb_arr = my_comb.split("");

					bot.sendMessage(message.chat.id, "Lo gnomo torna dal rifugio con 5 Rune, su ogni runa Ã¨ scritto un numero:\n\nðŸ’¬ " + my_comb_arr.join(" ") + "\n\nPer entrare nel rifugio di <b>" + nick + "</b> devi possedere delle Rune di un valore piÃ¹ alto rispetto a quelle del guardiano del cancello, come procedi?\n\nPuoi cambiare le Rune ancora " + (4 - travel) + " volte", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text == "Cambia Rune") {

								if (travel >= 4) {
									bot.sendMessage(message.chat.id, "Non puoi cambiare Rune piÃ¹ di 2 volte per ispezione!", rBack);
									return;
								}

								bot.sendMessage(message.chat.id, "Inserisci le <b>posizioni</b> delle Rune che vuoi cambiare, separate da una virgola. Dopo 5 minuti il tuo gnomo tornerÃ  con le nuove rune.", kbNum).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if ((answer.text == "Torna al rifugio") || (answer.text == "Torna dallo gnomo")) {
											return;
										}

										var numbers = answer.text.trim().split(",");
										var len = Object.keys(numbers).length;

										bot.sendMessage(message.chat.id, "Sicuro di voler cambiare le rune inserite?", kbYesNo).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text.toLowerCase() != "si"){
													return;
												}

												if (len < 1) {
													bot.sendMessage(message.chat.id, "Inserisci almeno un numero, riprova", rBack);
													return;
												}

												if (len > 5) {
													bot.sendMessage(message.chat.id, "Troppi numeri, massimo 5, riprova", rBack);
													return;
												}

												var check = 0;
												var checkn = 0;

												for (var i = 0; i < len; i++) {
													numbers[i] = Math.round(numbers[i]);

													if (isNaN(numbers[i])) {
														bot.sendMessage(message.chat.id, "Almeno un numero non Ã¨ valido, riprova", rBack);
														return;
													}
													if ((numbers[i] < 1) || (numbers[i] > 5)) {
														bot.sendMessage(message.chat.id, numbers[i] + " non Ã¨ valido, deve essere compreso tra 1 e 5", rBack);
														return;
													}
													checkn = 0;
													for (var j = 0; j < len; j++) {
														if (numbers[i] == numbers[j]) {
															checkn++;
														}
														if (checkn >= 2) {
															bot.sendMessage(message.chat.id, numbers[i] + " non Ã¨ valido, Ã¨ giÃ  stato inserito", rBack);
															return;
														}
													}
												}

												var now = new Date();
												now.setMinutes(now.getMinutes() + 5);
												var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
												var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());

												connection.query('UPDATE heist_progress SET changeComb = ' + numbers.join("") + ', wait_time = "' + long_date + '", travel = travel+1 WHERE from_id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "Lo gnomo Ã¨ stato inviato a sostituire le rune richieste, tornerÃ  alle " + short_date, rBack);
												});
											}
										});
									};
								});

							} else if (answer.text == "Tieni Combinazione") {

								var num = [];
								var end = "";
								var end_num = 0;

								var final1 = 0;
								var final2 = 0;
								var final_n1 = "";
								var final_n2 = "";
								var couple1 = 0;
								var couple2 = 0;

								var dcouple1 = 0;
								var dcouple2 = 0;
								var dcouple1b = 0;
								var dcouple2b = 0;
								var dcoupled1 = 0;
								var dcoupled2 = 0;
								var dcoupleSolo1 = 0;
								var dcoupleSolo2 = 0;

								var triple1 = 0;
								var triple2 = 0;
								var triple_a1 = 0;
								var triple_a2 = 0;
								var triple_b1 = 0;
								var triple_b2 = 0;
								var triple_d1 = 0;
								var triple_d2 = 0;

								var full1_d = 0;
								var full1_t = 0;
								var full1 = 0;
								var full2 = 0;
								var quad1 = 0;
								var quad2 = 0;
								var dquad1 = 0;
								var dquad2 = 0;
								var penta1 = 0;
								var penta2 = 0;
								var scalef1 = 0;
								var scalef2 = 0;
								var scales1 = 0;
								var scales2 = 0;

								for (i = 0; i < 2; i++) {

									if (i == 0) {
										num = my_comb.split("");
									} else {
										num = combi.split("");
									}
									num.sort();

									end = "";
									end_num = 0;

									//Cinque di un tipo
									if ((num[0] == num[1]) && (num[1] == num[2]) && (num[2] == num[3]) && (num[3] == num[4])) {
										end = "Cinque di un tipo";
										end_num = 8;
									}

									if ((i == 0) && (end_num == 8)) {
										penta1 = num[0];
									} else {
										penta2 = num[0];
									}

									if (end_num == 0) {
										//Quattro di un tipo
										var dquad = 0;
										if ((num[0] == num[1]) && (num[1] == num[2]) && (num[2] == num[3])) {
											end = "Quattro di un tipo";
											end_num = 7;
											dquad = num[4];
										}
										if ((num[1] == num[2]) && (num[2] == num[3]) && (num[3] == num[4])) {
											end = "Quattro di un tipo";
											end_num = 7;
											dquad = [0];
										}

										if ((i == 0) && (end_num == 7)) {
											quad1 = num[1];
											dquad1 = dquad;
										} else {
											quad2 = num[1];
											dquad2 = dquad;
										}
									}

									if (end_num == 0) {
										//Scala di 6
										if ((num[0] == 2) && (num[1] == 3) && (num[2] == 4) && (num[3] == 5) && (num[4] == 6)) {
											end = "Scala di 6";
											end_num = 6;
										}

										if ((i == 0) && (end_num == 6)) {
											scales1 = num[0];
										} else {
											scales2 = num[0];
										}
									}

									if (end_num == 0) {
										//Scala di 5
										if ((num[0] == 1) && (num[1] == 2) && (num[2] == 3) && (num[3] == 4) && (num[4] == 5)) {
											end = "Scala di 5";
											end_num = 5;
										}

										if ((i == 0) && (end_num == 5)) {
											scalef1 = num[0];
										} else {
											scalef2 = num[0];
										}
									}

									if (end_num == 0) {
										//Full House
										var full = 0;
										var fullDouble = 0;
										var fullTris = 0;
										var array_full = [];

										if ((num[0] == num[1]) && (num[1] == num[2])) {
											full++;
											fullTris = num[0];
											array_full.push(num[3]);
											array_full.push(num[4]);
										} else if ((num[1] == num[2]) && (num[2] == num[3])) {
											full++;
											fullTris = num[1];
											array_full.push(num[0]);
											array_full.push(num[4]);
										} else if ((num[2] == num[3]) && (num[3] == num[4])) {
											full++;
											fullTris = num[2];
											array_full.push(num[0]);
											array_full.push(num[1]);
										}

										if (full == 1) {
											if (array_full[0] == array_full[1]) {
												full++;
												fullDouble = array_full[0];
											}

											if (fullDouble != fullTris) {
												if (full == 2) {
													end = "Full";
													end_num = 4;
												}
												if ((i == 0) && (end_num == 4)) {
													full1_d = fullDouble;
													full1_t = fullTris;
												} else {
													if (fullTris == full1_t) {
														full2 = fullDouble;
														full1 = full1_d;
													} else {
														full2 = fullTris;
														full1 = full1_t;
													}
												}
											}
										}
									}

									if (end_num == 0) {
										//Tre di un tipo
										var triple = 0;
										var triple_d = 0;
										if ((num[0] == num[1]) && (num[1] == num[2])) {
											end = "Tre di un tipo";
											end_num = 3;
											triple = num[0];

											if (i == 0) {
												triple_a1 = num[3];
												triple_a2 = num[4];
											} else {
												triple_b1 = num[3];
												triple_b2 = num[4];
											}
										}
										if ((num[1] == num[2]) && (num[2] == num[3])) {
											end = "Tre di un tipo";
											end_num = 3;
											triple = num[1];

											if (i == 0) {
												triple_a1 = num[0];
												triple_a2 = num[4];
											} else {
												triple_b1 = num[0];
												triple_b2 = num[4];
											}
										}
										if ((num[2] == num[3]) && (num[3] == num[4])) {
											end = "Tre di un tipo";
											end_num = 3;
											triple = num[2];

											if (i == 0) {
												triple_a1 = num[0];
												triple_a2 = num[1];
											} else {
												triple_b1 = num[0];
												triple_b2 = num[1];
											}
										}

										if ((i == 0) && (end_num == 3)) {
											triple1 = triple;
										} else {
											triple2 = triple;

											if (triple_a2 == triple_b2) {
												if (triple_a1 >= triple_b1) {
													triple_d1 = triple_a1;
													triple_d2 = 0;
												} else {
													triple_d1 = 0;
													triple_d2 = triple_b1;
												}
											} else {
												if (triple_a2 >= triple_b2) {
													triple_d1 = triple_a2;
													triple_d2 = 0;
												} else {
													triple_d1 = 0;
													triple_d2 = triple_b2;
												}
											}
										}
									}

									if (end_num == 0) {
										//Doppia Coppia
										var double = 0;
										var doubleN = 0;
										var doubleN2 = 0;
										if (num[0] == num[1]) {
											double++;
											doubleN = num[0];
										}
										if (num[1] == num[2]) {
											double++;
											if (double == 2)
												doubleN2 = doubleN;
											if (num[1] > doubleN)
												doubleN = num[1];
										}
										if (num[2] == num[3]) {
											double++;
											if (double == 2)
												doubleN2 = doubleN;
											if (num[2] > doubleN)
												doubleN = num[2];
										}
										if (num[3] == num[4]) {
											double++;
											if (double == 2)
												doubleN2 = doubleN;
											if (num[3] > doubleN)
												doubleN = num[3];
										}
										if (double == 2) {
											end = "Doppia Coppia";
											end_num = 2;
										}

										var checkN = 0;

										if ((i == 0) && (end_num == 2)) {
											dcouple1 = doubleN;
											dcouple1b = doubleN2;

											for (k = 0; k < 5; k++) {
												checkN = 0;
												for (j = 0; j < 5; j++) {
													if (num[k] == num[j])
														checkN++;
												}
												if (checkN == 1)
													dcoupleSolo1 = num[k];
											}
										} else {
											dcouple2 = doubleN;
											dcouple2b = doubleN2;

											for (k = 0; k < 5; k++) {
												checkN = 0;
												for (j = 0; j < 5; j++) {
													if (num[k] == num[j])
														checkN++;
												}
												if (checkN == 1)
													dcoupleSolo2 = num[k];
											}
										}
									}

									if (end_num == 0) {
										//Coppia
										var coup = 0;
										if (num[0] == num[1]) {
											end = "Coppia";
											end_num = 1;
											coup = num[0];
										}
										if (num[1] == num[2]) {
											end = "Coppia";
											end_num = 1;
											coup = num[1];
										}
										if (num[2] == num[3]) {
											end = "Coppia";
											end_num = 1;
											coup = num[2];
										}
										if (num[3] == num[4]) {
											end = "Coppia";
											end_num = 1;
											coup = num[3];
										}

										if ((i == 0) && (end_num == 1)) {
											couple1 = coup;
										} else {
											couple2 = coup;
										}
									}

									if (i == 0) {
										final1 = end_num;
										final_n1 = end;
									} else {
										final2 = end_num;
										final_n2 = end;
									}
								}

								var text = "Punti 1: " + final1 + " (" + final_n1 + ")\nPunti 2: " + final2 + " (" + final_n2 + ")";
								//console.log(text);

								if ((final1 == 1) && (final2 == 1)) { //Coppia
									if (couple1 >= couple2) {
										final1++;
									} else {
										final2++;
									}
								}
								if ((final1 == 2) && (final2 == 2)) { //Doppia Coppia
									if (dcouple1 > dcouple2) {
										final1++;
									} else if (dcouple1 == dcouple2) {
										if (dcouple1b > dcouple2b) {
											final1++;
										} else if (dcouple1b == dcouple2b) {
											if (dcoupleSolo1 >= dcoupleSolo2)
												final1++;
											else
												final2++;
										} else {
											final2++;
										}
									} else {
										final2++;
									}
								}
								if ((final1 == 3) && (final2 == 3)) { //Tris
									if (triple1 == triple2) {
										if (triple_d1 >= triple_d2) {
											final1++;
										} else {
											final2++;
										}
									} else {
										if (triple1 >= triple2) {
											final1++;
										} else {
											final2++;
										}
									}
								}
								if ((final1 == 4) && (final2 == 4)) { //Full
									if (full1 >= full2) {
										final1++;
									} else {
										final2++;
									}
								}
								if ((final1 == 5) && (final2 == 5)) { //Scala 5
									if (scalef1 >= scalef2) {
										final1++;
									} else {
										final2++;
									}
								}
								if ((final1 == 6) && (final2 == 6)) { //Scala 6
									if (scales1 >= scales2) {
										final1++;
									} else {
										final2++;
									}
								}
								if ((final1 == 7) && (final2 == 7)) { //Quattro uguali
									if (quad1 > quad2) {
										final1++;
									} else {
										if (quad1 == quad2) {
											if (dquad1 >= dquad2) {
												final1++;
											} else {
												final2++;
											}
										} else {
											final2++;
										}
									}
								}
								if ((final1 == 8) && (final2 == 8)) { //Cinque uguali
									if (penta1 >= penta2) {
										final1++;
									} else {
										final2++;
									}
								}

								if ((final1 == 0) && (final2 == 0)){
									var n1 = my_comb.split("").sort().join("");
									var n2 = combi.split("").sort().join("");
									if (n2 > n1){
										final2++;
									}else{
										final1++;
									}
								}

								if (final1 >= final2) {
									connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 5', function (err, rows, fields) {
										if (err) throw err;

										var abBonus = 0;
										if (Object.keys(rows).length > 0) {
											abBonus = rows[0].ability_level * (rows[0].val / 10);
										}

										var money = ability * 10;

										connection.query("SELECT money FROM player WHERE id = " + toId, function (err, rows, fields) {
											if (err) throw err;

											money += money * (abBonus / 10);
											if (crazyMode == 1) {
												money = money * 2;
											}

											if (rows[0].money < money) {
												money = rows[0].money;
											}

											if (money < 0) {
												money = 0;
											}

											money = Math.round(money);

											connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + toId, function (err, rows, fields) {
												if (err) throw err;
												connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
													connection.query('DELETE FROM heist_progress WHERE from_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;

														var key = 1;
														/*
														if (global_end == 1){
															key = 5;
														}
														*/

														connection.query('UPDATE player SET mkeys = mkeys+' + key + ' WHERE id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
														});

														bot.sendMessage(message.chat.id, "La tua combinazione di rune (" + my_comb + ") Ã¨ migliore di quella del guardiano (" + combi + ")! In una stanzetta all'interno del rifugio hai trovato un sacchettino contenente " + formatNumber(money) + " Â§ e " + key + "x Chiave Mistica  ðŸ—!", kbBack);
														bot.sendMessage(toChat, message.from.username + " Ã¨ riuscito a sconfiggere il guardiano del tuo rifugio, purtroppo avendo lasciato incustodito un sacchettino di monete, hai perso " + formatNumber(money) + " Â§");

														if (travel <= 2) {
															setAchievement(message.chat.id, player_id, 8, 1);
														}

														var heistRand = Math.random() * 100;
														if (heist_streak + 1 >= 15) {
															var chestStreak = 4;
															if (heistRand % 2 == 0) {
																chestStreak = 5;
															}
															connection.query('UPDATE player SET heist_streak = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
																addChest(player_id, chestStreak);
																connection.query('SELECT name FROM chest WHERE id = ' + chestStreak, function (err, rows, fields) {
																	if (err) throw err;
																	bot.sendMessage(message.chat.id, "Per aver sconfitto 15 guardiani hai ricevuto uno <b>" + rows[0].name + "</b>!", html);
																});
															});
														} else {
															connection.query('UPDATE player SET heist_streak = heist_streak+1 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}
													});
												});
											});
										});
									});

									if (isMatch == 1) {
										setAchievement(message.chat.id, player_id, 13, 1);
										setExp(player_id, 3);
										connection.query('UPDATE player SET ability = ability+2 WHERE id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
										connection.query('UPDATE player SET ability = ability-1 WHERE ability > 0 AND id = ' + toId, function (err, rows, fields) {
											if (err) throw err;
										});
									}

									var d = new Date();
									var history_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

									connection.query('INSERT INTO heist_history (from_id, to_id, rate1, fail, time) VALUES ' +
													 '(' + player_id + ',' + toId + ',0,0,"' + history_date + '")',
													 function (err, rows, fields) {
										if (err) throw err;
									});

									if ((snowHouse == 1) && (snowHouseEnd == 0)){
										var rand = Math.random()*100;
										if (rand < 50){
											connection.query('SELECT COUNT(id) As cnt FROM event_snowball_status WHERE player_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												if (rows[0].cnt > 0){
													connection.query('SELECT COUNT(id) As cnt FROM event_snowball_list WHERE player_id = ' + player_id, function (err, rows, fields) {
														if (err) throw err;
														var snowball = 1+parseInt(rows[0].cnt);
														connection.query('UPDATE event_snowball_status SET snowball = snowball+' + snowball + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
															if (err) throw err;
															bot.sendMessage(message.chat.id, "Hai trovato " + snowball + " Palle di Neve!");
															console.log(snowball + " palle di neve a " + message.from.username);
														});
													});
												}
											});
										};
									};
								} else {
									connection.query('DELETE FROM heist_progress WHERE from_id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "La tua combinazione di rune (" + my_comb + ") Ã¨ peggiore di quella del guardiano (" + combi + ")! Il portone del rifugio si blocca ed il tuo gnomo Ã¨ costretto a tornare indietro", kbBack);
										bot.sendMessage(toChat, "<b>" + message.from.username + "</b> non Ã¨ riuscito a sconfiggere il guardiano del tuo portone, cosÃ¬ Ã¨ stato respinto", html);
									});

									if (isMatch == 1) {
										setExp(player_id, 1);
										setAchievement(toChat, toId, 9, 1);
										connection.query('UPDATE player SET ability = ability-2 WHERE ability > 0 AND id = ' + player_id, function (err, rows, fields) {
											if (err) throw err;
										});
										connection.query('UPDATE player SET ability = ability+1 WHERE id = ' + toId, function (err, rows, fields) {
											if (err) throw err;
										});
									}

									var d = new Date();
									var history_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

									connection.query('INSERT INTO heist_history (from_id, to_id, rate1, fail, time) VALUES ' +
													 '(' + player_id + ',' + toId + ',0,1,"' + history_date + '")',
													 function (err, rows, fields) {
										if (err) throw err;
									});
								}
							} else if (answer.text == "Rinuncia") {
								bot.sendMessage(message.chat.id, "Sicuro di voler rinunciare all'ispezione? Perderai 2 punti abilitÃ ", kbYesNo).then(function () {
									answerCallbacks[message.chat.id] = function (answer) {
										if (answer.text.toLowerCase() == "si") {
											connection.query('DELETE FROM heist_progress WHERE from_id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(message.chat.id, "Hai deciso di rinunciare all'ispezione", back);
												bot.sendMessage(toChat, "<b>" + message.from.username + "</b> ha rinunciato all'ispezione nel tuo rifugio", html);
											});

											if (isMatch == 1) {
												setAchievement(toChat, toId, 9, 1);
											}

											connection.query('UPDATE `player` SET ability = ability-1 WHERE id = ' + player_id, function (err, rows, fields) {
												if (err) throw err;
											});
											connection.query('UPDATE `player` SET ability = ability+1 WHERE id = ' + toId, function (err, rows, fields) {
												if (err) throw err;
											});

											var d = new Date();
											var history_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

											connection.query('INSERT INTO heist_history (from_id, to_id, rate1, fail, time) VALUES ' +
															 '(' + player_id + ',' + toId + ',0,1,"' + history_date + '")',
															 function (err, rows, fields) {
												if (err) throw err;
											});
										}
									};
								});
							} else if (answer.text == "Regole") {
								bot.sendMessage(message.chat.id, "Regole dello Scontro tra Rune:\nPer vincere contro il guardiano dovrai possedere una combinazione di rune con un valore piÃ¹ alto delle sue, in base a questo schema:\n- Coppia (2 uguali)\n- Doppia Coppia (2 coppie)\n- Tris (tre uguali)\n- Full (coppia e tris)\n- Scala 5 (da 1 a 5)\n- Scala 6 (da 2 a 6)\n- 4 Uguali\n- 5 Uguali\n\nPuoi cambiarne 1 o piÃ¹ inviando lo gnomo, oppure rinunciare (verrÃ  considerata come un'ispezione persa)", rBack);
							}
						};
					});
				});
			} else {
				bot.sendMessage(message.chat.id, "Il tuo gnomo non Ã¨ appostato a nessun rifugio", back);
			}
		});
	});
});

bot.onText(/^rifugio|Torna al rifugio/i, function (message) {

	if (message.text.indexOf("Elettricista") != -1) {
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var player_id = rows[0].id;
		var myexp = rows[0].exp;
		var house_id = rows[0].house_id;
		var lev = Math.floor(myexp / 10);
		var life = rows[0].life;
		var reborn = rows[0].reborn;
		var ability = rows[0].ability;
		var heist_protection = rows[0].heist_protection;
		var heist_streak = rows[0].heist_streak;
		var custom_name_h = rows[0].custom_name_h;
		var heist_count = rows[0].heist_count;
		var spy_count = rows[0].spy_count;

		var gender_text = "";
		if (rows[0].gender == "M"){
			gender_text = "o";
		}else{
			gender_text = "a";
		}

		if ((lev < 15) && (reborn == 1)) {
			bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ ancora troppo basso, torna quando avrai raggiunto il livello 15.", back);
			return;
		}

		var iKeys = [];
		connection.query('SELECT 1 FROM heist_progress WHERE from_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				iKeys.push(["Contatta lo Gnomo ðŸ’­"]);
			}
			iKeys.push(["Ispezione ðŸ”¦", "Spia Rifugio ðŸ‘€"]);
			iKeys.push(["Prelevazione ðŸŒ", "Migliora Rifugio ðŸ•", "Protezione ðŸ’«"]);
			iKeys.push(["Torna al menu"]);

			var kb = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			//var cost = Math.min(2000, ability*10);

			var kb2 = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": [["Matchmaking (2.000 Â§)"], ["Inserisci il Nickname (3.000 Â§)"], ["Torna al Rifugio"]]
				}
			};

			connection.query('SELECT name FROM house WHERE id = ' + house_id, function (err, rows, fields) {
				if (err) throw err;

				if (custom_name_h != null) {
					rifugio = "Rifugio " + custom_name_h + " (" + house_id + ")";
				} else {
					rifugio = rows[0].name + " (" + house_id + ")";
				}

				bot.sendMessage(message.chat.id, "Bentornat" + gender_text + " nel tuo ðŸ• *" + rifugio + "*, possiedi *" + ability + "* punti abilitÃ !\nPuoi ancora effettuare " + ((10 - heist_count) < 0 ? 0 : (10 - heist_count)) + " ispezioni e spiare " + (25 - spy_count) + " giocatori.", kb).then(function () {
					answerCallbacks[message.chat.id] = function (answer) {
						if (answer.text.indexOf("Ispezione") != -1){

							if (heist_protection != null) {
								bot.sendMessage(message.chat.id, "A causa del campo di forza non puoi ispezionare gli altri utenti", back);
								return;
							}

							bot.sendMessage(message.chat.id, "Invia uno gnomo ad un rifugio di un altro giocatore per cercare di ottenere il suo bottino e una Chiave Mistica, puoi usare il Matchmaking per sceglierlo casualmente (esclusi i compagni di team, di accademia o madre) in base alla tua abilitÃ  oppure inserire il suo nickname", kb2);
						}
					};
				});
			});
		});
	});
});


bot.onText(/matchmaking/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (rows[0].heist_protection != null) {
			bot.sendMessage(message.chat.id, "A causa del campo di forza non puoi ispezionare gli altri utenti", back);
			return;
		}

		var myexp = rows[0].exp;
		var lev = Math.floor(myexp / 10)
		var reborn = rows[0].reborn;
		var myab = rows[0].ability;
		var from_id = rows[0].id;
		var weapon_bonus = rows[0].weapon;
		var life = rows[0].life;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var heist_count = rows[0].heist_count;
		var last_mm = rows[0].last_mm;
		var global_end = rows[0].global_end;

		var travel = rows[0].travel_id;
		var cave = rows[0].cave_id;

		if ((life <= 0) && (myexp > 10)) {
			bot.sendMessage(message.chat.id, "Non puoi iniziare ispezioni da morto.", revive);
			return;
		}

		if ((lev < 15) && (reborn == 1)) {
			bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ ancora troppo basso, torna quando avrai raggiunto il livello 15.", back);
			return;
		}

		connection.query('SELECT id FROM heist_progress WHERE from_id = ' + from_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				bot.sendMessage(message.chat.id, "Stai svolgendo un ispezione, completala prima di iniziarne un'altra", back);
				return;
			}

			connection.query('SELECT datetime FROM heist WHERE from_id = ' + from_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					var date = new Date(rows[0].datetime);
					var short_date = addZero(date.getHours()) + ":" + addZero(date.getMinutes());
					bot.sendMessage(message.chat.id, "Ispezione in corso fino alle " + short_date, kb_heist);
					return;
				}

				if (heist_count >= 10) {
					bot.sendMessage(message.chat.id, "Puoi ispezionare un rifugio solamente 10 volte al giorno, riprova domani dalle 3.", back);
					return;
				}

				if (money < 2000) {
					bot.sendMessage(message.chat.id, "Non hai abbastanza monete!", back);
					return;
				}

				connection.query('SELECT team_id FROM team_player WHERE player_id = ' + from_id, function (err, rows, fields) {
					if (err) throw err;

					var team_id = 0;
					var my_team_id = 0;
					var heist_limit = 3;
					if (Object.keys(rows).length > 0) {
						team_id = rows[0].team_id;
						my_team_id = rows[0].team_id;
						heist_limit = 10;
					}

					connection.query('SELECT child_team FROM team WHERE id = ' + my_team_id, function (err, rows, fields) {
						if (err) throw err;
						if (Object.keys(rows).length > 0) {
							if (rows[0].child_team != 0)
								team_id += "," + rows[0].child_team;
						}

						connection.query('SELECT id FROM team WHERE child_team = ' + my_team_id, function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length > 0) {
								team_id += "," + rows[0].id;
							}

							var offset = Math.round(myab / 2);
							var offset2 = Math.round(myab / 3);
							var limit = 50;
							var count = 100;
							var i = 0;
							var minexp = 150;
							var found = 0;
							var rand;

							for(i = 0; i < 15; i++){
								var rows = connection_sync.query("SELECT nickname, exp, team_player.team_id FROM player, team_player WHERE player.heist_limit < " + heist_limit + " AND player.account_id NOT IN (SELECT account_id FROM banlist) AND player.id NOT IN (1,3) AND team_player.player_id = player.id AND team_player.team_id NOT IN (" + team_id + ") AND heist_protection IS NULL AND ability BETWEEN " + (myab - offset) + " AND " + (myab + offset2) + " AND nickname <> '" + message.from.username + "' AND money > 0 AND exp > " + minexp + " AND holiday = 0 AND player.id != " + last_mm + " ORDER BY ability DESC, heist_limit ASC, RAND() LIMIT " + limit);

								if (Object.keys(rows).length < 10) {
									offset += i*10;
									offset2 += i*10;
								}else{
									rand = Math.floor(Math.random() * Object.keys(rows).length);
									attack(rows[rand].nickname, message, from_id, weapon_bonus, 2000, 1, global_end);
									found = 1;
									break;
								}
							}

							if (found == 0)
								bot.sendMessage(message.chat.id, "Nessun giocatore adatto trovato, riprova.", back);
						});
					});
				});
			});
		});
	});
});

bot.onText(/inserisci il nickname|ispeziona: /i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (wanted == 0) {
			if (rows[0].heist_protection != null) {
				bot.sendMessage(message.chat.id, "A causa del campo di forza non puoi ispezionare gli altri utenti", back);
				return;
			}
		}

		var myexp = rows[0].exp;
		var lev = Math.floor(myexp / 10);
		var reborn = rows[0].reborn;
		var from_id = rows[0].id;
		var weapon_bonus = rows[0].weapon;
		var life = rows[0].life;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var heist_count = rows[0].heist_count;
		var global_end = rows[0].global_end;

		if ((lev < 15) && (reborn == 1)) {
			bot.sendMessage(message.chat.id, "Il tuo livello Ã¨ ancora troppo basso.", back);
			return;
		}

		var travel = rows[0].travel_id;
		var cave = rows[0].cave_id;

		connection.query('SELECT datetime FROM heist WHERE from_id=' + from_id, function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				var date = new Date(rows[0].datetime);
				var short_date = addZero(date.getHours()) + ":" + addZero(date.getMinutes());
				bot.sendMessage(message.chat.id, "Ispezione in corso fino alle " + short_date, kb_heist);
				return;
			}
			connection.query('SELECT id FROM heist_progress WHERE from_id=' + from_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					bot.sendMessage(message.chat.id, "Stai svolgendo un ispezione, completala prima di iniziarne un'altra", back);
					return;
				}

				connection.query('SELECT wanted_id FROM event_wanted_status WHERE player_id = ' + from_id, function (err, rows, fields) {
					if (err) throw err;

					var wanted_id = 0;
					if (Object.keys(rows).length > 0) {
						wanted_id = rows[0].wanted_id;
					}

					if (money < 3000) {
						bot.sendMessage(message.chat.id, "Non hai abbastanza monete!", back);
						return;
					}

					if (message.text.indexOf(":") != -1) {
						var usr = message.text.substring(message.text.indexOf(":") + 2).replace("@", "").trim();
						//console.log(usr);

						if (message.from.username.toLowerCase() == usr.toLowerCase()) {
							bot.sendMessage(message.chat.id, "Non puoi ispezionare te stesso.", back);
							return;
						}

						usr = usr.replace(/[^\w\s]/gi, '');

						connection.query('SELECT id, account_id, reborn, holiday FROM player WHERE nickname="' + usr + '"', function (err, rows, fields) {
							if (err) throw err;
							if (Object.keys(rows).length > 0) {
								var banReason = isBanned(rows[0].account_id);
								if (banReason != null) {
									bot.sendMessage(message.chat.id, "Non puoi ispezionare un giocatore bannato", back);
									return;
								}

								var d = new Date();
								var time = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate());

								if ((wanted == 0) && (rows[0].id != wanted_id)) {
									if (reborn > rows[0].reborn) {
										bot.sendMessage(message.chat.id, "Puoi ispezionare solamente un giocatore con una rinascita pari o superiore alla tua", back);
										return;
									}
									if (heist_count >= 10) {
										bot.sendMessage(message.chat.id, "Puoi ispezionare un rifugio solamente 10 volte al giorno, riprova domani dalle 3.", back);
										return;
									}
								}

								if (rows[0].holiday == 1) {
									bot.sendMessage(message.chat.id, "Non puoi ispezionare un giocatore in modalitÃ  vacanza.", back);
									return;
								}

								connection.query('SELECT id FROM heist_history WHERE from_id = ' + from_id + ' AND to_id = ' + rows[0].id + ' AND time LIKE "' + time + '%"', function (err, rows, fields) {
									if (err) throw err;
									if ((Object.keys(rows).length <= 2) || (wanted == 1)) {
										attack(usr, message, from_id, weapon_bonus, 3000, 0, global_end);
									} else {
										bot.sendMessage(message.chat.id, "Hai ispezionato troppe volte questo giocatore, riprova domani.", back);
									}
								});
							} else {
								bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
							}
						});
						return;
					}

					bot.sendMessage(message.chat.id, "Inserisci il nickname del giocatore da sfidare.\n*OPPURE* puoi ispezionare un giocatore scrivendo *Ispeziona: Nomeutente*", mark).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (message.text.indexOf(":") != -1) {
								return;
							}

							answer.text = answer.text.replace("@", "").trim();

							if (message.from.username.toLowerCase() == answer.text.toLowerCase()) {
								bot.sendMessage(message.chat.id, "Non puoi ispezionare te stesso.", back);
								return;
							}

							connection.query('SELECT reborn, id, account_id, holiday FROM player WHERE nickname = "' + answer.text + '"', function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length > 0) {

									var banReason = isBanned(rows[0].account_id);
									if (banReason != null) {
										bot.sendMessage(message.chat.id, "Non puoi ispezionare un giocatore bannato", back);
										return;
									}

									var d = new Date();
									var time = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate());

									if ((wanted == 0) && (rows[0].id != wanted_id)) {
										if (reborn > rows[0].reborn) {
											bot.sendMessage(message.chat.id, "Puoi ispezionare solamente un giocatore con una rinascita pari o superiore alla tua", back);
											return;
										}
										if (heist_count >= 10) {
											bot.sendMessage(message.chat.id, "Puoi ispezionare un rifugio solamente 10 volte al giorno, riprova domani dalle 3.", back);
											return;
										}
									}

									if (rows[0].holiday == 1) {
										bot.sendMessage(message.chat.id, "Non puoi ispezionare un giocatore in modalitÃ  vacanza.", back);
										return;
									}

									connection.query('SELECT id FROM heist_history WHERE from_id = ' + from_id + ' AND to_id = ' + rows[0].id + ' AND time LIKE "' + time + '%"', function (err, rows, fields) {
										if (err) throw err;
										if ((Object.keys(rows).length <= 2) || (wanted == 1)) {
											attack(answer.text, message, from_id, weapon_bonus, 3000, 0, global_end);
										} else {
											bot.sendMessage(message.chat.id, "Hai ispezionato troppe volte questo giocatore, riprova domani.", back);
										}
									});
								} else {
									bot.sendMessage(message.chat.id, "Giocatore non trovato, riprova.", back);
								}
							});
						};
					});
				});
			});
		});
	});
});

bot.onText(/^protezione/i, function (message) {

	if (message.text.toLowerCase().indexOf("protezione di stoffa") != -1)
		return;

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var player_id = rows[0].id;

		if (getItemCnt(player_id, 237) == 0) {
			bot.sendMessage(message.chat.id, "Ti serve il Campo di Forza.", back);
			return;
		}
		bot.sendMessage(message.chat.id, "Il Campo di Forza ti fornirÃ  protezione dalle Ispezioni per 24 ore, ma intanto non potrai ispezionare, confermi?", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				var conf = answer.text;
				if (conf == "Si") {

					if (getItemCnt(player_id, 237) == 0) {
						bot.sendMessage(message.chat.id, "Ti serve il Campo di Forza.", back);
						return;
					}

					var now = new Date();
					now.setHours(now.getHours() + 24);
					var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());
					var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes()) + " del " + addZero(now.getDate()) + "/" + addZero(now.getMonth() + 1);

					connection.query('UPDATE player SET heist_protection = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						bot.sendMessage(message.chat.id, "Sei protetto fino alle " + short_date, back);
					});
					delItem(player_id, 237, 1);
				}
			};
		});
	});
});

bot.onText(/^prelevazione/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var from_id = rows[0].id;
		var reborn = rows[0].reborn;
		var totlife1 = rows[0].total_life;

		var pre = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Preleva", "Estrai"], ["Torna al rifugio"], ["Torna al menu"]]
			}
		};

		var pBack = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Prelevazione"], ["Torna al menu"]]
			}
		};

		if (lootteria == 1) {
			bot.sendMessage(message.chat.id, "Durante la lootteria non puoi usare la capsula, monello ðŸŒ", back);
			return;
		}

		if (rows[0].heist_protection != null) {
			bot.sendMessage(message.chat.id, "A causa del campo di forza non puoi utilizzare le capsule", back);
			return;
		}

		bot.sendMessage(message.chat.id, "Seleziona il tipo di capsula da utilizzare.\nPrelevando otterrai un oggetto E o L da un giocatore casuale\nEstraendo otterrai uno scrigno ed un giocatore casuale dovrÃ  pagarlo per te", pre).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {

				if (answer.text == "Torna al menu") {
					return;
				}

				if ((answer.text != "Preleva") && (answer.text != "Estrai")) {
					bot.sendMessage(message.chat.id, "Tipo non valido!", back);
					return;
				}

				var cId = 0;
				var t = "";

				if (answer.text == "Preleva") {
					cId = 220;
				} else if (answer.text == "Estrai") {
					cId = 618;
				}

				connection.query('SELECT team_id FROM team_player WHERE player_id = ' + from_id, function (err, rows, fields) {
					if (err) throw err;

					var team_id = 0;
					if (Object.keys(rows).length > 0) {
						team_id = parseInt(rows[0].team_id);
					}

					bot.sendMessage(message.chat.id, "Sicuro di voler continuare? VerrÃ  selezionato un giocatore casuale come bersaglio", yesno).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text.toLowerCase() == "si") {
								if (getItemCnt(from_id, cId) == 0) {
									bot.sendMessage(message.chat.id, "Ti serve una Capsula del tipo selezionato.", back);
									return;
								}

								if (cId == 220) {
									if (getItemCnt(from_id, cId) == 0) {
										bot.sendMessage(message.chat.id, "Non possiedi la Capsula necessaria", pBack);
										return;
									}

									connection.query("SELECT player.id As player_id, player.nickname, player.house_id, player.chat_id FROM inventory, item, player, team_player WHERE team_player.player_id = player.id AND player.reborn >= " + reborn + " AND player.market_ban = 0 AND player.capsule_limit < 5 AND player.id = inventory.player_id AND inventory.item_id = item.id AND player.id != 3 AND player.heist_protection IS NULL AND item.rarity IN ('E','L') AND player.id != " + from_id + " AND team_player.team_id != " + team_id + " AND inventory.quantity > 0 GROUP BY nickname ORDER BY RAND() LIMIT 1", function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Non ci sono utenti prelevabili con questo tipo di capsula.", pBack);
											return;
										}

										var house_id = rows[0].house_id;
										var chat_id = rows[0].chat_id;
										var to_id = rows[0].player_id;
										var nickname = rows[0].nickname;

										connection.query('SELECT item.name, inventory.item_id FROM item, inventory WHERE inventory.item_id = item.id AND inventory.player_id = ' + to_id + ' AND (item.rarity = "E" OR item.rarity = "L") AND inventory.quantity > 0 ORDER BY RAND()', function (err, rows, fields) {
											if (err) throw err;

											var itemId = rows[0].item_id;

											connection.query('SELECT name FROM item WHERE id = ' + itemId, function (err, rows, fields) {
												if (err) throw err;
												var itemName = rows[0].name;
												addItem(from_id, itemId);
												delItem(to_id, itemId, 1);
												delItem(from_id, 220, 1);

												var randStone = Math.round(Math.random() * 3);
												var stone_id = 70 + randStone;
												connection.query('SELECT name FROM item WHERE id = ' + stone_id, function (err, rows, fields) {
													if (err) throw err;

													var stone_name = rows[0].name;
													addItem(from_id, stone_id, 3);

													bot.sendMessage(message.chat.id, "Sei riuscito a rubare <b>" + itemName + "</b> da <b>" + nickname + "</b> ed il druido delle prelevazioni ti ha premiato con 3x " + stone_name + "!", back_html);
													if (house_id != 6) {
														bot.sendMessage(chat_id, "Un truffatore professionista Ã¨ riuscito a rubarti *" + itemName + "* dallo zaino!", mark);
													} else {
														bot.sendMessage(chat_id, "Un truffatore di nome <b>" + message.from.username + "</b> Ã¨ riuscito a rubarti <b>" + itemName + "</b> dallo zaino!", html);
													}

													setAchievement(message.chat.id, from_id, 47, 1);

													var d = new Date();
													d.setHours(d.getHours() + 48);
													var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

													connection.query('UPDATE player SET capsule_limit = capsule_limit+1 WHERE id = ' + to_id, function (err, rows, fields) {
														if (err) throw err;
													});

													var rand = Math.random() * 200;
													if ((rand < 3) && (reborn >= 3)) {
														addItem(from_id, 532);
														bot.sendMessage(message.chat.id, "Un *Urlo di Morte* rieccheggia in lontananza... Wow!", mark);
													}
												});
											});
										});
									});
								} else if (cId == 618) {
									var chest = "";
									var money = 0;
									if ((reborn == 1) || (reborn == 2)) {
										var rand = Math.round(Math.random());
										if (rand == 1) {
											chest = 1;
											money = 600;
										} else {
											chest = 2;
											money = 1200;
										}
									} else if (reborn == 3) {
										var rand = Math.round(Math.random());
										if (rand == 1) {
											chest = 3;
											money = 2400;
										} else {
											chest = 4;
											money = 3600;
										}
									} else if ((reborn == 4) || (reborn == 5)) {
										var rand = Math.round(Math.random());
										if (rand == 1) {
											chest = 5;
											money = 7000;
										} else {
											chest = 6;
											money = 15000;
										}
									}

									connection.query("SELECT player.id, nickname, house_id, chat_id FROM player, team_player WHERE team_player.player_id = player.id AND reborn >= " + reborn + " AND market_ban = 0 AND capsule_limit < 5 AND heist_protection IS NULL AND money > " + money + " AND player.id != 3 AND player.id != " + from_id + " AND team_player.team_id != " + team_id + " ORDER BY RAND() LIMIT 1", function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length == 0) {
											bot.sendMessage(message.chat.id, "Non ci sono utenti prelevabili con questo tipo di capsula.", pBack);
											return;
										}

										var house_id = rows[0].house_id;
										var chat_id = rows[0].chat_id;
										var to_id = rows[0].id;
										var nickname = rows[0].nickname;


										if (getItemCnt(from_id, cId) == 0) {
											bot.sendMessage(message.chat.id, "Non possiedi la Capsula necessaria", pBack);
											return;
										}

										connection.query('SELECT name FROM chest WHERE id = ' + chest, function (err, rows, fields) {
											if (err) throw err;
											var chestName = rows[0].name;
											addChest(from_id, chest);

											connection.query('UPDATE player SET money = money-' + money + ' WHERE id = ' + to_id, function (err, rows, fields) {
												if (err) throw err;
											});

											delItem(from_id, 618, 1);

											var randStone = Math.round(Math.random() * 3);
											var stone_id = 70 + randStone;
											connection.query('SELECT name FROM item WHERE id = ' + stone_id, function (err, rows, fields) {
												if (err) throw err;

												var stone_name = rows[0].name;
												addItem(from_id, stone_id, 3);

												bot.sendMessage(message.chat.id, "Hai ottenuto uno <b>" + chestName + "</b>! Mentre <b>" + nickname + "</b> Ã¨ stato costretto a sborsare " + formatNumber(money) + " Â§. Intanto il druido delle prelevazioni ti ha premiato con 3x " + stone_name + "!", back_html);
												if (house_id != 6) {
													bot.sendMessage(chat_id, "Uno scassinatore professionista ti ha costretto a sborsare " + formatNumber(money) + " Â§ per il suo scrigno!");
												} else {
													bot.sendMessage(chat_id, "Un truffatore di nome <b>" + message.from.username + "</b> ti ha costretto a sborsare <b>" + formatNumber(money) + "</b> Â§ per il suo scrigno!", html);
												}

												setAchievement(message.chat.id, from_id, 47, 1);

												var d = new Date();
												d.setHours(d.getHours() + 48);
												var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

												connection.query('UPDATE player SET capsule_limit = capsule_limit+1 WHERE id = ' + to_id, function (err, rows, fields) {
													if (err) throw err;
												});

												var rand = Math.random() * 200;
												if ((rand < 5) && (reborn >= 3)) {
													addItem(from_id, 532);
													bot.sendMessage(message.chat.id, "Un *Urlo di Morte* rieccheggia in lontananza... Wow!", mark);
												}
											});
										});
									});
								}
							};
						};
					});
				});
			};
		});
	});
});

bot.onText(/migliora rifugio/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		var house_id = rows[0].house_id;
		var money = rows[0].money;
		var from_id = rows[0].id;

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if ((house_id + 1) > 6) {
			bot.sendMessage(message.chat.id, "Hai raggiunto il limite massimo di upgrade del rifugio.", back);
			return;
		}

		var level_text = "";
		var level = [];
		var level_money = 0;

		if ((house_id + 1) == 2) {
			level_text = "> Cemento Armato\n> Materiale da Costruzione\n> Marmo";
			level = [144, 145, 148];
			level_money = 1500;
		} else if ((house_id + 1) == 3) {
			level_text = "> Progetto di Costruzione\n> Materiale da Costruzione\n> Marmo";
			level = [147, 145, 148];
			level_money = 3000;
		} else if ((house_id + 1) == 4) {
			level_text = "> Progetto di Costruzione\n> Titanio\n> Marmo";
			level = [147, 149, 148];
			level_money = 4500;
		} else if ((house_id + 1) == 5) {
			level_text = "> Progetto di Costruzione\n> Titanio\n> Oro Nero";
			level = [147, 149, 105];
			level_money = 7000;
		} else if ((house_id + 1) == 6) {
			level_text = "> Progetto Definitivo\n> Congegno Parallelo\n> Cella Blindata";
			level = [359, 367, 370];
			level_money = 10000;
		}

		var check1 = "âœ…";
		var check2 = "âœ…";
		var check3 = "âœ…";

		if (getItemCnt(from_id, level[0]) == 0)
			check1 = "";

		if (getItemCnt(from_id, level[1]) == 0)
			check2 = "";

		if (getItemCnt(from_id, level[2]) == 0)
			check3 = "";

		if ((house_id + 1) == 2) {
			level_text = "> Cemento Armato " + check1 + "\n> Materiale da Costruzione " + check2 + "\n> Marmo " + check3;
		} else if ((house_id + 1) == 3) {
			level_text = "> Progetto di Costruzione " + check1 + "\n> Materiale da Costruzione " + check2 + "\n> Marmo " + check3;
		} else if ((house_id + 1) == 4) {
			level_text = "> Progetto di Costruzione " + check1 + "\n> Titanio " + check2 + "\n> Marmo " + check3;
		} else if ((house_id + 1) == 5) {
			level_text = "> Progetto di Costruzione " + check1 + "\n> Titanio " + check2 + "\n> Oro Nero " + check3;
		} else if ((house_id + 1) == 6) {
			level_text = "> Progetto Definitivo " + check1 + "\n> Congegno Parallelo " + check2 + "\n> Cella Blindata " + check3;
		}

		bot.sendMessage(message.chat.id, "Per passare al livello " + (house_id + 1) + " del rifugio devi possedere i seguenti oggetti:\n" + level_text + "\nOltre a " + level_money + " Â§", yesno).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				var action = answer.text;
				if (action == "Torna al menu") {
					return;
				}

				if (money < level_money) {
					bot.sendMessage(message.chat.id, "Non hai abbastanza monete!", back);
					return;
				}

				if (getItemCnt(from_id, level[0]) == 0) {
					bot.sendMessage(message.chat.id, "Non possiedi il primo oggetto richiesto.", back);
					return;
				}
				if (getItemCnt(from_id, level[1]) == 0) {
					bot.sendMessage(message.chat.id, "Non possiedi il secondo oggetto richiesto.", back);
					return;
				}
				if (getItemCnt(from_id, level[2]) == 0) {
					bot.sendMessage(message.chat.id, "Non possiedi il terzo oggetto richiesto.", back);
					return;
				}

				connection.query('UPDATE player SET house_id = house_id+1, money=money-' + level_money + ' WHERE id = ' + from_id, function (err, rows, fields) {
					if (err) throw err;
					bot.sendMessage(message.chat.id, "Potenziamento completato!", back);
				});

				delItem(from_id, level[0], 1);
				delItem(from_id, level[1], 1);
				delItem(from_id, level[2], 1);
			};
		});
	});
});

function attack(nickname, message, from_id, weapon_bonus, cost, source, global_end) {
	connection.query('SELECT exp, ability, chat_id, heist_count, heist_limit, heist_protection, house_id, custom_name_h, id, money, global_end, player_custom_nickname FROM player WHERE nickname = "' + nickname + '"', function (err, rows, fields) {
		if (err) throw err;
		var chat_id_nickname = rows[0].chat_id;
		var isMatch = source;

		if (Object.keys(rows).length == 0) {
			bot.sendMessage(message.chat.id, "Questo nickname non esiste, riprova.", back);
			return;
		}

		var to_id = rows[0].id;

		if ((to_id == 1) || (to_id == 3)) {
			bot.sendMessage(message.chat.id, "Dice il saggio: 'Campa cavallo sulla panca insieme alla capra facendo i cavolacci propri... In poche parole, fatti gli affari tuoi :>'", back);
			return;
		}

		var house_id = rows[0].house_id;
		var heist_count = parseInt(rows[0].heist_count);
		var heist_limit = parseInt(rows[0].heist_limit);
		var ability = parseInt(rows[0].ability);
		var custom_name_h = rows[0].custom_name_h;
		var player_custom_nickname = (rows[0].player_custom_nickname != null ? " " + rows[0].player_custom_nickname : "")

		var match = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [["Matchmaking"], ["Torna al menu"]]
			}
		};

		if (wanted == 0) {
			if (rows[0].heist_protection != null) {
				bot.sendMessage(message.chat.id, "Il bersaglio Ã¨ sotto protezione", match);
				return;
			}
			if (rows[0].money <= 0) {
				bot.sendMessage(message.chat.id, "Il bersaglio ha poche monete, riprova cambiando giocatore.", match);
				return;
			}

			if ((rows[0].exp <= 150) && (isMatch == 0)) {
				bot.sendMessage(message.chat.id, "Il bersaglio ha poca esperienza, riprova cambiando giocatore.", match);
				return;
			}
		}

		connection.query('SELECT level, name, type FROM dragon WHERE player_id = ' + to_id, function (err, rows, fields) {
			if (err) throw err;

			var dragon_lev = 0;
			var dragon_name = "";

			if (Object.keys(rows).length > 0) {
				dragon_lev = rows[0].level;
				dragon_name = rows[0].name + " " + rows[0].type;
			}

			connection.query('SELECT team.name FROM team_player, team WHERE team.id = team_player.team_id AND player_id = ' + to_id, function (err, rows, fields) {
				if (err) throw err;

				var team_name = "-";

				if (wanted == 0) {
					if (Object.keys(rows).length == 0) {
						if (heist_limit >= 3) {
							bot.sendMessage(message.chat.id, "Il bersaglio non possiede un team e ha raggiunto il limite di ispezioni subite. Riprova domani.", match);
							return;
						}
					} else {
						if (heist_limit >= 10) {
							bot.sendMessage(message.chat.id, "Il bersaglio ha raggiunto il limite di ispezioni subite. Riprova domani.", match);
							return;
						}
						team_name = rows[0].name;
					}
				}else{
					if (Object.keys(rows).length > 0) {
						team_name = rows[0].name;
					}
				}

				if (isMatch == 1) {
					connection.query('UPDATE player SET last_mm = ' + to_id + ' WHERE id = ' + from_id, function (err, rows, fields) {
						if (err) throw err;
					});
				}

				connection.query('SELECT name, rooms, grade FROM house WHERE id=' + house_id, function (err, rows, fields) {
					if (err) throw err;

					var house_name = rows[0].name;
					var grade = rows[0].grade;
					var rooms = rows[0].rooms;
					var iKeys = [];

					iKeys.push(["Invia Piedelesto"]);
					iKeys.push(["Invia Occhiofurbo"]);
					iKeys.push(["Invia Testacalda"]);
					iKeys.push(["Matchmaking (Â§)"]);
					iKeys.push(["Torna al menu"]);

					var option = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": iKeys
						}
					};

					connection.query('SELECT wanted_id FROM event_wanted_status WHERE player_id = ' + from_id, function (err, rows, fields) {
						if (err) throw err;

						var isWanted = 0;
						if (Object.keys(rows).length > 0) {
							if (rows[0].wanted_id == to_id) {
								isWanted = 1;
							}
						}

						var dragon_text = "";
						if (dragon_lev > 0) {
							dragon_text = " ed il drago ðŸ‰ <b>" + dragon_name + "</b> (" + dragon_lev + ") sorveglia la sua entrata";
						}

						if (custom_name_h != null) {
							house_name = "Rifugio " + custom_name_h;
						}

						var text = "Stai per inviare uno gnomo servitore al rifugio di <b>" + nickname + player_custom_nickname + "</b> (" + team_name + ") con abilitÃ  " + ability + ".\nAlloggia in un ðŸ• <b>" + house_name + "</b> (" + house_id + ")" + dragon_text + ". Seleziona quale gnomo servitore vuoi inviare.";
						if (isWanted == 1) {
							text = "Stai per inviare uno gnomo servitore alla cattura di <b>" + nickname + "</b>, seleziona quale gnomo esploratore vuoi inviare";
						}

						if (isWanted == 0) {
							connection.query('UPDATE player SET money = money-' + cost + ' WHERE id = ' + from_id, function (err, rows, fields) {
								if (err) throw err;
							});
						}

						bot.sendMessage(message.chat.id, text, option).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {
								if ((answer.text == "Torna al menu") || (answer.text == "Matchmaking")) {
									return;
								}

								connection.query('SELECT id FROM heist_progress WHERE from_id = ' + from_id, function (err, rows, fields) {
									if (err) throw err;
									if (Object.keys(rows).length > 0) {
										bot.sendMessage(message.chat.id, "Stai svolgendo un ispezione, completala prima di iniziarne un'altra", back);
										return;
									}

									connection.query('SELECT datetime FROM heist WHERE from_id = ' + from_id, function (err, rows, fields) {
										if (err) throw err;
										if (Object.keys(rows).length > 0) {
											var date = new Date(rows[0].datetime);
											var short_date = addZero(date.getHours()) + ":" + addZero(date.getMinutes());
											bot.sendMessage(message.chat.id, "Ispezione in corso fino alle " + short_date, kb_heist);
											return;
										}

										var query = "";
										var method = 0;
										if (answer.text == "Invia Piedelesto") {
											method = 1;
										} else if (answer.text == "Invia Occhiofurbo") {
											method = 3;
										} else if (answer.text == "Invia Testacalda") {
											method = 2;
										} else {
											return;
										}

										//Secondi (massimo 6*600 + 100)
										var totTime = (grade * 900);

										var rate = 50;

										if (method == 1) {
											totTime = Math.round(totTime * 0.6);
											rate = 40;
										} else if (method == 3) {
											totTime = Math.round(totTime * 1.2);
											rate = 60;
										}

										if (wanted == 1) {
											totTime = Math.round(totTime / 1.5);
										}

										if (crazyMode == 1) {
											totTime = Math.round(totTime / 2);
										}

										/*
										if (global_end == 1){
											totTime = Math.round(totTime / 2);
										}
										*/

										if (isWanted == 1) {
											totTime = (Math.round(Math.random() * 10 + 5) * method) * 60;
										}

										var now = new Date();
										now.setSeconds(now.getSeconds() + totTime);
										var short_date = addZero(now.getHours()) + ":" + addZero(now.getMinutes());
										var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

										connection.query('INSERT INTO heist (from_id, to_id, datetime, rate1, grade, matchmaking) ' +
														 'VALUES (' + from_id + ',' + to_id + ',"' + long_date + '",' + rate + ',' + grade + ',' + isMatch + ')',
														 function (err, rows, fields) {
											if (err) throw err;
											if (isWanted == 0) {
												bot.sendMessage(message.chat.id, "Hai inviato il tuo gnomo esploratore all'ispezione del rifugio selezionato, torna alle " + short_date + " per risolvere il dilemma del rifugio ed ottenere una ðŸ—", kb_heist);
											} else {
												bot.sendMessage(message.chat.id, "Hai inviato il tuo gnomo esploratore alla cattura del ricercato, torna alle " + short_date + " per scoprirne l'esito", kb_heist);
											}
										});
										if (isWanted == 0) {
											connection.query('UPDATE player SET heist_count = heist_count+1 WHERE id = ' + from_id, function (err, rows, fields) {
												if (err) throw err;
											});
										}
									});
								});
							};
						});
					});
				});
			});
		});
	});
}

function getRandomArbitrary(min, max) {
	return Math.random() * (max - min) + min;
}

bot.onText(/itinerario propizio|itinerari|regioni/i, function (message) {

	if (specialMission == 0) {
		return;
	}

	var d = new Date();
	if ((d.getDay() != 6) && (d.getDay() != 0)) {
		bot.sendMessage(message.chat.id, "Oggi l'evento non Ã¨ disponibile, torna nel weekend.", back);
		return;
	}

	connection.query('SELECT * FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (rows[0].mission_special_id != 0) {
			var time = new Date(rows[0].mission_special_time_end);
			bot.sendMessage(message.chat.id, "Sei in itinerario fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()), back);
			return;
		}

		if (rows[0].mission_id != 0) {
			bot.sendMessage(message.chat.id, "Non puoi iniziare un itinerario finchÃ¨ sei in missione", abort_mission);
			return;
		}

		if (rows[0].mission_party > 0) {
			bot.sendMessage(message.chat.id, "Incarico in corso! Attendi il termine prima di avviare un itinerario.", back)
			return;
		}

		var player_id = rows[0].id;
		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;
		var charm_id = rows[0].charm_id;
		var life = rows[0].life;
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;
		var money = rows[0].money;
		var class_id = rows[0].class;
		var travel_id = rows[0].travel_id;
		var cave_id = rows[0].cave_id;

		if ((boost_mission <= 0) && (boost_id != 0)) {
			connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
			boost_mission = 0;
			boost_id = 0;
		}

		connection.query('SELECT * FROM rarity WHERE special_mission IS NOT NULL', function (err, rows, fields) {
			if (err) throw err;

			var iKeys = [];
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				iKeys.push([rows[i].special_mission + " (" + rows[i].shortname + ")"]);
			}

			iKeys.push(["Torna al menu"]);

			var kbRar = {
				parse_mode: "Markdown",
				reply_markup: {
					resize_keyboard: true,
					//one_time_keyboard: true,
					"keyboard": iKeys
				}
			};

			bot.sendMessage(message.chat.id, "*Itinerario Propizio*\nDurante la tua avventura hai trovato una *mappa* che indica con precisione tutti i carichi di merci che viaggiano nel mondo di Lootia" +
							" ed il loro contenuto, puoi recarti in quei luoghi e magari potresti trovare un oggetto tra quelli segnati, buona fortuna!\n\n" +
							"Seleziona la regione e segui un itinerario", kbRar).then(function () {
				answerCallbacks[message.chat.id] = function (answer) {

					if (answer.text == "Torna al menu") {
						return;
					}

					var reg4 = /\((.+)\)/i;
					var rar = answer.text.match(reg4);

					if (rar == null){
						bot.sendMessage(message.chat.id, "Itinerario non valido.", back);
						return;
					}

					connection.query('SELECT * FROM mission_zone WHERE rarity = "' + rar[1] + '"', function (err, rows, fields) {
						if (err) throw err;

						var iKeys = [];
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							iKeys.push([rows[i].name + " (" + Math.round(rows[i].duration / 60) + " minuti)"]);
						}

						iKeys.push(["Torna alle regioni"]);
						iKeys.push(["Torna al menu"]);

						var kbMiss = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": iKeys
							}
						};

						var missConf = {
							parse_mode: "Markdown",
							reply_markup: {
								resize_keyboard: true,
								//one_time_keyboard: true,
								"keyboard": [["Si"], ["Torna agli itinerari"], ["Torna al menu"]]
							}
						};

						bot.sendMessage(message.chat.id, "Seleziona la zona in cui iniziare un itinerario", kbMiss).then(function () {
							answerCallbacks[message.chat.id] = function (answer) {

								if ((answer.text == "Torna al menu") || (answer.text == "Torna alle regioni")) {
									return;
								}

								var zn = answer.text.substring(0, answer.text.indexOf("(") - 1);

								connection.query('SELECT * FROM mission_zone WHERE name = "' + zn + '"', function (err, rows, fields) {
									if (err) throw err;

									if (Object.keys(rows).length == 0) {
										bot.sendMessage(message.chat.id, "Zona non valida", back);
										return;
									}

									var name = rows[0].name;
									var mission_id = rows[0].id;
									var duration = rows[0].duration;
									var mission_description = rows[0].description;
									var rarity = rows[0].rarity;
									var items = "";

									connection.query('SELECT item.name, item.rarity FROM mission_zone_item, item, mission_zone WHERE mission_zone_item.zone_id = mission_zone.id AND mission_zone.id = ' + mission_id + ' AND mission_zone_item.item_id = item.id', function (err, rows, fields) {
										if (err) throw err;

										for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
											items += "\n> " + rows[i].name + " (" + rows[i].rarity + ")";
										}

										if ((parseInt(life) <= 0) && (parseInt(exp) > 10)) {
											bot.sendMessage(message.chat.id, "Non puoi affrontare gli itinerari da morto.", revive);
											return;
										}

										var parsedDate = new Date();
										var extra1 = "âœ…";
										var extra2 = "âœ…";

										if (charm_id == 60) { //RapiditÃ 
											duration -= duration * 0.05;
										} else if (charm_id == 187) {
											duration -= duration * 0.1;
										} else if (charm_id == 188) {
											duration -= duration * 0.15;
										} else if (charm_id == 697) {
											duration -= duration * 0.2;
										} else {
											extra1 = "âŒ";
										} 
										if ((class_id == 3) && (reborn == 3)) {
											duration -= (duration * 0.05);
										}
										if ((class_id == 3) && (reborn >= 4)) {
											duration -= (duration * 0.1);
										}

										if (boost_id == 1) {
											duration = duration / 2;
											name = name + " (Velocizzata)";
										} else if ((boost_id == 0) || (boost_id == 3) || (boost_id == 8)) {
											extra2 = "âŒ";
										}

										parsedDate.setSeconds(parsedDate.getSeconds() + duration);

										bot.sendMessage(message.chat.id, "Iniziare l'itinerario nel " + name + "?\n\nTalismano VelocitÃ : " + extra1 + "\nBevanda: " + extra2 + "\n\nOggetti trovabili in questo luogo:" + items, missConf).then(function () {
											answerCallbacks[message.chat.id] = function (answer) {
												if (answer.text.toLowerCase() == "si") {
													var mission_date = addZero(parsedDate.getHours()) + ":" + addZero(parsedDate.getMinutes()) + ":" + addZero(parsedDate.getSeconds());

													var description = mission_description.replace(new RegExp("%player%", "g"), message.from.username);

													var long_date = parsedDate.getFullYear() + "-" + addZero(parsedDate.getMonth() + 1) + "-" + addZero(parsedDate.getDate()) + " " + addZero(parsedDate.getHours()) + ':' + addZero(parsedDate.getMinutes()) + ':' + addZero(parsedDate.getSeconds());

													bot.sendMessage(message.chat.id, "<b>" + name + "</b>\n" + message.from.username + ", " + description + " " + mission_date + " <i>(" + toTime(duration) + ")</i>", back_html);

													connection.query('UPDATE player SET event = 0, mission_special_id = ' + mission_id + ', chat_id =' + message.chat.id + ', mission_special_time_end ="' + long_date + '" WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
														if (err) throw err;
													});

													if (boost_id == 1) {
														if (boost_mission - 1 == 0) {
															connection.query('UPDATE `player` SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														} else {
															connection.query('UPDATE `player` SET boost_mission = boost_mission - 1 WHERE id = ' + player_id, function (err, rows, fields) {
																if (err) throw err;
															});
														}
													}
													dailyChest(message, player_id);
												}
											};
										});
									});
								});
							};
						});
					});
				};
			});
		});
	});
});

bot.onText(/missione/i, function (message) {
	connection.query('SELECT * FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		if (rows[0].mission_special_id != 0) {
			var time = new Date(rows[0].mission_special_time_end);
			bot.sendMessage(message.chat.id, "Sei in itinerario fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()), back);
			return;
		}

		if (rows[0].mission_party > 0) {
			bot.sendMessage(message.chat.id, "Incarico in corso! Attendi il termine prima di avviare una missione.", back)
			return;
		}

		var player_id = rows[0].id;
		var boost_id = rows[0].boost_id;
		var boost_mission = rows[0].boost_mission;
		var charm_id = rows[0].charm_id;
		var life = rows[0].life;
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;
		var money = rows[0].money;
		var class_id = rows[0].class;
		var global_end = rows[0].global_end;

		if (player_id != 1) {
			if ((class_id == 1) && (reborn >= 3)) {
				bot.sendMessage(message.chat.id, "Raggiunta questa Rinascita la Vocazione Ã¨ obbligatoria, la puoi scegliere nella sezione Giocatore > Vocazione", back);
				return;
			}
		}

		helpMsg(message.chat.id, player_id, 2);

		if ((boost_mission <= 0) && (boost_id != 0)) {
			connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
			boost_mission = 0;
			boost_id = 0;
		}

		if (parseInt(life) <= 0) {
			if ((exp > 10) && (reborn == 1)) {
				bot.sendMessage(message.chat.id, "Non puoi affrontare le missioni da morto.", revive);
				return;
			} else if (reborn > 1) {
				bot.sendMessage(message.chat.id, "Non puoi affrontare le missioni da morto.", revive);
				return;
			}
		}

		if ((rows[0].travel_id != 0) || (rows[0].cave_id != 0)){
			bot.sendMessage(message.chat.id, "Non puoi andare in missione finchÃ¨ sei in viaggio.", back);
			return;
		}
		connection.query('SELECT mission_id, lore_page, lore_mission, mission_time_end, mission_auto_id, global_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var id = rows[0].mission_id;
			var time = new Date(rows[0].mission_time_end);
			var mission_auto = rows[0].mission_auto_id;
			var current = 0;
			var lore_page = rows[0].lore_page;
			var lore_mission = rows[0].lore_mission;
			var global_end = rows[0].global_end;

			connection.query('SELECT name, type FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var dragon_name = "";
				if (Object.keys(rows).length > 0) {
					dragon_name = rows[0].name + " " + rows[0].type;
				}

				if (id != 0) {
					bot.sendMessage(message.chat.id, "Sei in missione fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth() + 1) + "/" + time.getFullYear(), abort_mission);
					return;
				}

				if ((lore_page == 1) && (lore_mission == 0)) {
					var rand = Math.random() * 500;
					if (rand < 1) {
						var newDate = new Date();
						newDate.setHours(newDate.getHours() + 1);
						var mission_date = addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());

						var description = "peregrini: furente, incoerente; rimbombo di passi; miraggio - rimbomba -, ora realtÃ : e grigia Ã¨ la chioma, grigia la polvere d'un lungo itinerare, d'un vecchio, vetusto, che a lungo potÃ© errare; e agli occhi l'effimero - strepita -, il sempiterno: o Lootia, te vide, di te volle scrivere, in te fu pregno. Giacque dunque la punta su un foglio, e di essa l'inchiostro grondante. Ma d'una tempesta si ode il crepito; langue, al suon della morte; fredda la quiete, prima del fremito. 'Al Tempio, al Tempio!', rimembri i canti, 'Al Tempo giocoso, a Spazi cangianti'. E rimbomba, o rimbomba, il suon dei suoi passi - quasi in un ballo in fa diesis minore -; urla la fenice, spirando la vita; a Un Nuovo Inizio sorge in albore." +
							"\nE s'aprirÃ  l'entrata al vecchio inchiostro di un possesso per sempre." +
							"\n\n...\n\nSilenzio.\n\n...\n\n" +
							"Ah, sÃ¬, ricevi anche un macabro omaggio e torni al Rifugio alle " + mission_date;

						var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth() + 1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());

						connection.query('UPDATE `player` SET lore_mission = 1, event = 1, `mission_id` = 1001, mission_gem = 0, `mission_time_end`="' + long_date + '" WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "<b>Polvere</b>\n" + message.from.username + ", " + description, abort_mission);
						});
						return;
					}
				}

				if ((lore_page == 1) && (lore_mission == 1) && (reborn >= 3)) {
					var rand = Math.random() * 1000;
					if (rand < 1) {
						var newDate = new Date();
						newDate.setHours(newDate.getHours() + 12);
						var mission_date = addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());

						var description = "albergo fra il Mana ch'Ã¨ Xocotl e Loki ch'Ã¨ Polvere. Qui regno, tre i Troni; lÃ¬ volano, tre gli Astri, senza Mana lÃ¬ brancolano, tre le Ombre. RiceverÃ  un vecchio, durante una Missione: ora si svegli.\n\nTi svegli alle " + mission_date;

						var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth() + 1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());

						connection.query('UPDATE player SET lore_mission = 2, event = 0, mission_id = 1002, mission_gem = 0, mission_time_end = "' + long_date + '" WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "<b>Efesto</b>\n" + message.from.username + ", " + description, abort_mission);
						});
						return;
					}
				}
				if ((lore_page == 1) && (lore_mission == 2) && (reborn >= 2)) {
					var rand = Math.random() * 1500;
					if (rand < 1) {
						var newDate = new Date();
						newDate.setHours(newDate.getHours() + 3);
						var mission_date = addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());

						var description = "trovi una lettera speciale sulla soglia del Rifugio.\n\n'Egr. Dott. " + message.from.username + ", Le chiediamo di raggiungere il Centro Esterno di Ricerca Neutrale, al fine di effettuare una breve indagine sulla recente dipartita del Dott. DÍ•Ì£.Ì¤Ì«3Í“Í•oÌžÌ . Comunichi la Sua decisione allâ€™indirizzo seguente: AdA URP. Nella speranza che Lei collabori, A.d.A.\n\nL'A.d.A. ti Ã¨ familiare: lâ€™Associazione degli Avventurieri, cosÃ¬ come vollero chiamarla. A quanto pare, il nome le Ã¨ rimasto. Ãˆ ironico: lo stesso DÍ•Ì£.Ì¤Ì«3Í“Í•oÌžÌ  vi si era opposto, ritenendolo infantile e quanto mai superbo - ed ora Ã¨ morto. Morto, e con lui quel piccolo centro che speranzoso aveva fondatoâ€¦ forse. Forse, poichÃ© il tuo ultimo contatto con lâ€™A.d.A. e il Dottore Ã¨ ormai antico, tanto antico, o addirittura tanto giovane da non ricordarti neppure quanto. Aspetta, sei sicuro dâ€™esser mai stato nellâ€™A.d.A.? Ma certo, sei stato unâ€™intima conoscenza per DÍ•Ì£.Ì¤Ì«3Í“Í•oÌžÌ . Piangi, e fra le lacrime selli il tuo " + dragon_name + ": la sua ubicazione Ã¨ balenata nella tua mente, come un ricordo sfolgorante o unâ€™abbagliante illuminazione. Quel desolato angolo dellâ€™Edoria, ora ospitante il C.E.R.N., Ã¨ infatti detto Tecnâš™ï¸ria.\nEcco: al palesarsi di un enorme edificio, lÃ¬, ai lati dell'immane entrata, un solare ragazzo 'Accoglie " + message.from.username + "': un cartello sÃ¬ spartano, ma fedele alla corrispondenza avvenuta fra te e Jarvas - colui che ora ti ha gentilmente accolto, mentre " + dragon_name + " s'Ã¨ cautamente adagiato. Al varcar della soglia s'apre allora una sala, enorme, trafficata, lontano una porta, oltre un corridoio. Jarvas vi si avventura, al che entrambi entrate in un ufficio. In quel momento, lontano da occhi indiscreti, il... robot? Androide? Qualsiasi cosa giustifichi i circuiti? Proprio lui, Jarvas, porge a te una grande scatola, con essa la sua chiave. Ãˆ un ordine del Dottore, cosÃ¬ dice, un dono destinato a un 'vero avventuriero', nonchÃ© 'suo vero amico'. DÍ•Ì£.Ì¤Ì«3Í“Í•oÌžÌ  ha celato una ricerca allâ€™Associazione. Ãˆ strano, perÃ²: non ricordi quale fosse, nÃ© lui chi fosse. Un allarme ti distrae: alcuni dirigenti ti aspettano, con la promessa di una breve riunione.\nAssopitosi il sole, saluti Jarvas e sali in groppa a " + dragon_name + ".\n\nVoli.\n\nFra le fresche brezze della sera, ti rendi conto di non ricordare alcunchÃ©. V'Ã¨ una scatola, nello Zaino: che debba essere aperta? Giunto al Rifugio, la apri alle " + mission_date;

						var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth() + 1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());

						connection.query('UPDATE player SET lore_mission = 3, event = 1, mission_id = 1003, mission_gem = 0, mission_time_end = "' + long_date + '" WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "<b>Tecnâš™ria</b>\n" + message.from.username + ", " + description, abort_mission);
						});
						return;
					}
				}
				if ((lore_page == 1) && (lore_mission == 3) && (reborn >= 2)) {
					var rand = Math.random() * 1500;
					if (rand < 1) {
						var newDate = new Date();
						newDate.setHours(newDate.getHours() + 5);
						var mission_date = addZero(newDate.getHours()) + ":" + addZero(newDate.getMinutes()) + ":" + addZero(newDate.getSeconds());

						var description = "dopo ore di attente ricerche, hai finalmente recuperato lo scrigno speciale di Jarvas, dimenticato in soffitta.\n[Rapporto di missione - fascicolo archiviato]\n[Il resto del fascicolo Ã¨ stato collocato nella sezione riservata della Biblioteca ðŸ›] - " + mission_date;

						var long_date = newDate.getFullYear() + "-" + addZero(newDate.getMonth() + 1) + "-" + addZero(newDate.getDate()) + " " + addZero(newDate.getHours()) + ':' + addZero(newDate.getMinutes()) + ':' + addZero(newDate.getSeconds());

						connection.query('UPDATE player SET lore_mission = 4, event = 1, mission_id = 1004, mission_gem = 0, mission_time_end = "' + long_date + '" WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(message.chat.id, "<b>Ritorno a Tecnâš™ria</b>\n" + message.from.username + ", " + description, abort_mission);
						});
						return;
					}
				}

				if (mission_auto == 0) {
					mission_auto += 1;
				}

				connection.query('SELECT chest_id FROM mission_auto WHERE id = ' + mission_auto, function (err, rows, fields) {
					if (err) throw err;

					var chest_id = rows[0].chest_id;
					if (chest_id == 6) {
						var rand = Math.random() * 100;
						if (rand <= 30) {
							chest_id = 7;
						}
					}

					var result = 0;
					if (chest_id != 7) {
						var minTime = [0, 600, 1000, 5200, 9500, 36000, 85000];
						var maxTime = [0, 900, 3000, 9400, 23000, 54000, 93000];
						var stdev = [0, 200, 977, 1787, 6635, 10220, 3348];
						var media = [0, 889, 1822, 6297, 17252, 47798, 88004];

						var randx = 0;
						var randy = 1;
						var checkDuration = 0;

						while (randy > checkDuration) {
							randx = getRandomArbitrary(minTime[chest_id], maxTime[chest_id]);
							randy = getRandomArbitrary(0, 1 / Math.sqrt(2 * stdev[chest_id]));
							checkDuration = (1 / Math.sqrt(2 * Math.PI * stdev[chest_id])) * Math.exp(-1 / 2 * Math.pow((randx - media[chest_id]) / stdev[chest_id]), 2);
						}
						result = Math.round(randx);
					} else if (chest_id == 7) {
						result = 172800;
					}

					var duration = result;	// in secondi

					connection.query('SELECT name, description, id As mission_id FROM mission WHERE chest_id = ' + chest_id + ' ORDER BY RAND()', function (err, rows, fields) {
						if (err) throw err;
						var name = rows[0].name;
						var mission_id = rows[0].mission_id;
						var mission_description = rows[0].description;

						var extra1 = "âœ…";
						var extra2 = "âœ…";

						if (charm_id == 60) {
							duration = duration - (duration / 100 * 5);
						} else if (charm_id == 187) {
							duration = duration - (duration / 100 * 10);
						} else if (charm_id == 188) {
							duration = duration - (duration / 100 * 15);
						} else if (charm_id == 697) {
							duration = duration - (duration / 100 * 20);
						} else {
							extra1 = "âŒ";
						}
						if ((class_id == 3) && (reborn == 3)) {
							duration -= (duration * 0.05);
						}
						if ((class_id == 3) && (reborn >= 4)) {
							duration -= (duration * 0.1);
						}

						if (boost_id == 1) {
							duration = duration / 2;
							name = name + " (Velocizzata)";
						} else if ((boost_id == 0) || (boost_id == 3) || (boost_id == 6) || (boost_id == 8)) {
							extra2 = "âŒ";
						}

						if (crazyMode == 1) {
							duration = duration / 2;
							name = name + " (FOLLE)";
						}

						if (luckyMode == 1) {
							name = name + " (FORTUNA?)";
						}

						connection.query('SELECT rarity_shortname FROM chest WHERE id = ' + chest_id, function (err, rows, fields) {
							if (err) throw err;

							var rarity_short = rows[0].rarity_shortname;
							if (rarity_short == "U") {
								rarity_short = "E";
							}

							bot.sendMessage(message.chat.id, "Iniziare la missione?\nRaritÃ  Scrigno: " + rarity_short + "\nTalismano VelocitÃ : " + extra1 + "\nBevanda: " + extra2, yesno).then(function () {
								answerCallbacks[message.chat.id] = function (answer) {
									if (answer.text.toLowerCase() != "si") {
										return;
									}

									var finishDate = new Date();
									finishDate.setSeconds(finishDate.getSeconds() + duration);

									var d = new Date();
									var today = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate());

									connection.query('SELECT nickname FROM last_command, player WHERE player.account_id = last_command.account_id AND last_command.time LIKE "' + today + '%" ORDER BY RAND()', function (err, random_player, fields) {
										if (err) throw err;

										var description = mission_description;
										description = description.replace(new RegExp("%player%", "g"), message.from.username);
										description = description.replace(new RegExp("%drago%", "g"), dragon_name);
										var nth = 0;
										description = description.replace(/%casuale%/g, function (match, i, original) {
											nth++;
											return random_player[nth].nickname;
										});

										var short_date = addZero(finishDate.getHours()) + ":" + addZero(finishDate.getMinutes());
										var long_date = finishDate.getFullYear() + "-" + addZero(finishDate.getMonth() + 1) + "-" + addZero(finishDate.getDate()) + " " + addZero(finishDate.getHours()) + ':' + addZero(finishDate.getMinutes()) + ':' + addZero(finishDate.getSeconds());

										bot.sendMessage(message.chat.id, "<b>" + name + "</b>\n" + message.from.username + ", " + description + " " + short_date + " <i>(" + toTime(duration) + ")</i>", abort_mission);

										if ((mission_auto + 1) > max_mission_id) {
											mission_auto = 1;
										} else {
											mission_auto++;
										}

										connection.query('UPDATE player SET event = 0, mission_id = ' + mission_id + ', chat_id = ' + message.chat.id + ', mission_auto_id = ' + mission_auto + ', mission_gem = 0, mission_time_end = "' + long_date + '" WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
											if (err) throw err;
										});

										if (boost_id == 1) {
											if (boost_mission - 1 == 0) {
												connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											} else {
												connection.query('UPDATE player SET boost_mission = boost_mission - 1 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
											}
										}
										if (crazyMode == 1) {
											if ((rarity_short == "L") || (rarity_short == "E")) {
												connection.query('UPDATE player SET gems = gems+1 WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
													if (err) throw err;
													bot.sendMessage(message.chat.id, "FOLLE! Hai ricevuto una Gemma ðŸ’Ž!");
												});
											}
										}

										dailyChest(message, player_id);
									});
								};
							});
						});
					});
				});
			});
		});
	});
});

function helpMsg(chat_id, player_id, type) {
	connection.query('SELECT * FROM help_message WHERE player_id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			connection.query('INSERT INTO help_message (player_id, type_' + type + ') VALUES (' + player_id + ',1)', function (err, rows, fields) {
				if (err) throw err;
			});
		} else {
			var name = 'rows[0].type_' + type;
			if (eval(name) == 1) {
				return;
			}
			connection.query('UPDATE help_message SET type_' + type + ' = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		var text = "";
		switch (type) {
			case 1:
				text = "*LE IMPRESE*\n\n" +
					"Le imprese sono degli obbiettivi giornalieri di tipi molto differenti, che vanno dalle missioni da completare, a viaggi, a oggetti da creare. Ogni impresa completata fornisce Â§ e viene contata per un premio finale dopo un certo numero di completamenti. Le imprese vengono resettate ogni giorno a mezzanotte e non sono disponibili durante il weekend, a differenza degli eventi. Nella schermata principale inoltre viene visualizzata l'impresa che si Ã¨ prossimi a completare, cosÃ¬ da agevolarne l'ottenimento del premio. Infine per quanto riguarda i casi in cui un'impresa fosse riferita ad un oggetto, quest'ultimo verrÃ  visualizzato in questa sezione del menÃ¹.";
				break;
			case 2:
				text = "*LE MISSIONI*\n\n" +
					"Le missioni sono uno dei tanti modi per ottenere oggetti nel bot, una volta iniziate Ã¨ sufficiente attendere il tempo specificato per ricevere automaticamente uno scrigno corrispondente alla raritÃ  della stessa. Dopo aver ottenuto lo scrigno, recarsi nella sezione Scrigni del menu principale per aprirlo. Nelle missioni Ã¨ possibile ottenere bevande che offrono vari effetti come raddoppio delle monete o diminuzione del tempo di attesa. I Talismani e altri oggetti equipaggiabili possono influire nella missione. Si tratta di una delle funzioni fondamentali del gioco, svolgine il piÃ¹ possibile!";
				break;
			case 3:
				text = "*I BOSS*\n\n" +
					"I boss sono dei temibili mostri affrontabili solamente in team, alla loro uccisione tutti ne otterrete monete e esperienza. E' possibili utilizzare diversi tipi di attacchi come il Leggero, il Pesante, gli Incantesimi e i Consumabili, considerando che il boss Ã¨ condiviso fra tutti i membri, Ã¨ necessario coordinarsi il piÃ¹ possibile per sconfiggerli tutti e 20 e ottenere il premio finale. Tuttavia se ti trovi ad un livello basso, Ã¨ sconsigliato lanciarsi anche contro i boss piÃ¹ deboli.";
				break;
			case 4:
				text = "*IL TEAM*\n\n" +
					"I team sono dei gruppi di giocatori utili a ottenere piÃ¹ monete e affrontare i boss per ottenere exp, Ã¨ possibile anche creare dei sotto team, dette accademie. La partecipazione e la collaborazione Ã¨ importante per abbattere tutti i boss e scalare la classifica.\nPuoi anche formare dei party e partecipare alle Imprese, molto utili per ottenere importanti oggetti o bonus.";
				break;
			case 5:
				text = "*IL DRAGO*\n\n" +
					"Il drago Ã¨ il tuo fedele compagno di avventure, puÃ² nascere con 6 pietre di diverso tipo ottenute dalle cave dal livello 10, una volta nato Ã¨ necessario dargli da mangiare per farlo crescere e ottenere piÃ¹ bonus in battaglia e nei viaggi, come l'aumento del danno e la riduzione dei tempi di attesa, come la produzione continua di bevande grazie ai suoi poteri. Inoltre Ã¨ utile negli eventi e nella difesa del rifugio.";
				break;
			case 6:
				text = "*L'EMPORIO*\n\n" +
					"All'emporio Ã¨ possibile acquistare Pozioni, Scrigni o Piume di Fenice, oppure vendere qualsiasi oggetto a prezzo base, tramite la funzione Ricicla invece Ã¨ possibile convertire 5 oggetti uguali in un altro oggetto della stessa raritÃ  oppure della raritÃ  successiva.";
				break;
			case 7:
				text = "*IL MERCATO*\n\n" +
					"Il mercato Ã¨ il luogo in cui si possono incontrare mercanti che vendono oggetti a buon prezzo, oppure regalarne. Da qui puoi seguire il link per entrare nel gruppo apposito e commerciare in gran quantitÃ . Il Mercante Pazzo mette a disposizione dei pacchetti di oggetti a buon prezzo ogni giorno, ricorda di darci un'occhiata!";
				break;
			case 8:
				text = "*IL GIOCATORE*\n\n" +
					"In questa sezione trovi tutte le informazioni sul tuo giocatore, oppure su quelle del giocatore che stai spiando, in base al livello del tuo rifugio ti vengono rivelate piÃ¹ informazioni sul bersaglio. Attraverso i pulsanti di Statistiche puoi visualizzare altre informazioni sulla tua avventura, se non visualizzi ancora il drago, visita l'apposita sezione dal menÃ¹ principale per ottenere altre informazioni. Ecco una descrizione per ogni voce:\n\nGiocatore ðŸ‘¤\nOgni simbolo sta ad indicare la tua esperienza e la tua RINASCITA\nâœ¨ Rinascita 0 \nðŸ”† Rinascita 1\nðŸ’« Rinascita 2\nâ­ï¸ Rinascita 3\nðŸŒŸ Rinascita 4\nðŸ¹ La tua vocazione, una volta scelta non sarÃ  possibile cambiarla!\nðŸ’Ž Le Gemme in tuo possesso\nðŸ’° I soldi in tuo possesso\nâ¤ï¸ La tua vita, attuale e totale\nðŸ“¦ I punti creazione che hai realizzato fin'ora, tra parentesi quelli settimanali\n\nEquipaggiamento âš”ï¸\nðŸ—¡ La tua fedelissima arma\nðŸ¥‹ La tua armatura\nðŸ›¡ Il tuo scudo\nðŸ“¿ Il talismano che indossi\n\nðŸ‰ Il migliore amico del giocatore, il tuo draghetto!\nðŸ’± Informazioni sulla tua abilitÃ  nelle ispezioni, il tuo rango e una piccola descrizione personale";
				break;
			case 9:
				text = "*LA MODALITA' VACANZA*\n\n" +
					"Puoi attivare la modalitÃ  vacanza per essere protetto dalle ispezioni durante un periodo in cui non giochi, essa si attiva automaticamente se non giochi per un lungo periodo di tempo cosÃ¬ da non diventare preda facile. La durata minima Ã¨ 2 settimane durante le quali non potrai effettuare alcuna azione nel bot. Procedi con cautela.";
				break;
			case 10:
				text = "*IL CERCA*\n\n" +
					"Puoi utilizzare il comando Cerca per trovare informazioni su tutti gli oggetti disponibili nel bot. Puoi cercare anche un testo parziale, se invece vuoi cercare in modo 'preciso', inserisci l'asterisco al fondo per isolare l'oggetto interessato. Ogni ricerca mostrerÃ  anche gli oggetti necessari alla creazione dell'oggetto, ed a sua volta per quali oggetti puÃ² essere utile.\nAttraverso questa funzione puoi creare l'oggetto con il pulsante Crea NomeOggetto, puoi anche scriverlo a mano. Infine puoi cercare per categoria o per raritÃ  utilizzando Cerca Armi oppure Cerca C 1 o Cerca C 0 (solo craftati o solo base).";
				break;
			case 11:
				text = "*I VIAGGI E LE CAVE*\n\n" +
					"I viaggi sono delle lunghe missioni dove al termine riceverai discrete somme di denaro o scrigni, pensate soprattutto nei periodi in cui il giocatore Ã¨ assente sul bot, magari in vacanza, in ogni caso si consiglia di utilizzarli solamente in questi casi.\nDopo pochi livelli sbloccherai le Cave, attraverso le quali sarÃ  possibile ottenere le Pietre del Drago, per nutrirlo e farlo combattere al tuo fianco.";
				break;
		}
		bot.sendMessage(chat_id, text, mark);
	});
}

bot.onText(/^imprese/i, function (message) {

	if (message.text.toLowerCase().indexOf("completate") != -1) {
		return;
	}

	connection.query('SELECT id, account_id, achievement_count, dungeon_count, mission_count, craft_count, exp, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var player_id = rows[0].id;
		var cnt = rows[0].achievement_count;
		var lev = Math.floor(rows[0].exp / 10);
		var mission_count = rows[0].mission_count;
		var dungeon_count = rows[0].dungeon_count;
		var craft_count = rows[0].craft_count;
		var reb = rows[0].reborn;

		helpMsg(message.chat.id, player_id, 1);
		setAchievementProgress(player_id, 1);

		connection.query('SELECT SUM(value) As globalVal FROM achievement_global', function (err, rows, fields) {
			if (err) throw err;

			var globalVal = rows[0].globalVal;
			if (globalVal == null) {
				globalVal = 0;
			}

			connection.query('SELECT global_eventon, global_eventwait, global_eventhide, global_cap FROM config', function (err, rows, fields) {
				if (err) throw err;

				var global = rows[0].global_eventon;
				var global_wait = rows[0].global_eventwait;
				var global_hide = rows[0].global_eventhide;
				var global_cap = rows[0].global_cap;

				connection.query('SELECT L.name, L.det, L.value, L.reward, L.type, S.progress, I.name As itemName, L.multiply, S.completed FROM achievement_daily D INNER JOIN achievement_list L ON D.achievement_id = L.id LEFT JOIN achievement_status S ON S.achievement_id = D.achievement_id AND S.player_id = ' + player_id + ' LEFT JOIN item I ON D.item_id = I.id', function (err, rows, fields) {
					if (err) throw err;
					var text = "<b>Imprese giornaliere</b>\n";
					if (Object.keys(rows).length > 0) {
						for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
							if (rows[i].progress == null) {
								rows[i].progress = 0;
							}
							if (rows[i].type == 12) {
								rows[i].name += " (" + rows[i].itemName + ")";
							}
							if (rows[i].multiply == 1){
								rows[i].reward = rows[i].reward*reb;
								rows[i].value = rows[i].value*reb;
							}
							if (rows[i].completed == 1) {
								text += "> <b>" + rows[i].name + "</b>: " + formatNumber(rows[i].reward) + " Â§ ottenuti âœ…\n";
							} else {
								text += "> <b>" + rows[i].name + "</b>: " + formatNumber(rows[i].progress) + "/" + formatNumber(rows[i].value) + " " + rows[i].det + " (" + formatNumber(rows[i].reward) + " Â§)\n";
							}
						}
					} else {
						text += "Oggi non sono disponibili imprese giornaliere :(\n";
					}

					text += "\n<b>Imprese complessive</b>\n";

					var end = 0;
					for (var i = 0, len = Object.keys(progLev).length; i < len; i++) {
						if (getRealLevel(reb, lev) >= progLev[i]) {
							end = (i + 1);
						}
					}
					if (progLev[end] == undefined) {
						text += "Imprese per livello completate âœ…\n";
					} else {
						text += "Livello " + formatNumber(getRealLevel(reb, lev)) + " su " + formatNumber(progLev[end]) + " totali (" + formatNumber(progLevRew[end]) + " Â§)\n";
					}

					end = 0;
					for (var i = 0, len = Object.keys(progMis).length; i < len; i++) {
						if (mission_count >= progMis[i]) {
							end = (i + 1);
						}
					}
					if (progMis[end] == undefined) {
						text += "Imprese per missioni completate âœ…\n";
					} else {
						text += formatNumber(mission_count) + " su " + formatNumber(progMis[end]) + " missioni completate (" + formatNumber(progMisRew[end]) + " Â§)\n";
					}

					end = 0;
					for (var i = 0, len = Object.keys(progDung).length; i < len; i++) {
						if (dungeon_count >= progDung[i]) {
							end = (i + 1);
						}
					}
					if (progDung[end] == undefined) {
						text += "Imprese per dungeon completate âœ…\n";
					} else {
						text += formatNumber(dungeon_count) + " su " + formatNumber(progDung[end]) + " dungeon completati (" + formatNumber(progDungRew[end]) + " Â§)\n";
					}

					end = 0;
					for (var i = 0, len = Object.keys(progCraft).length; i < len; i++) {
						if (craft_count >= progCraft[i]) {
							end = (i + 1);
						}
					}
					if (progCraft[end] == undefined) {
						text += "Imprese di creazione completate âœ…\n";
					} else {
						text += formatNumber(craft_count) + " su " + formatNumber(progCraft[end]) + " punti creazione (" + formatNumber(progCraftRew[end]) + " Â§)\n";
					}

					var time_start = new Date("2018-05-01 12:00:00");
					var now = new Date();
					var diffD = Math.floor(((time_start - now) / 1000) / 60 / 60 / 24);
					var diffH = Math.floor(((time_start - now) / 1000) / 60 / 60);
					var diffM = Math.floor(((time_start - now) / 1000) / 60);
					var diff = "";
					if (diffH < 1) {
						diff = diffM + " min";
					} else if (diffD < 2) {
						diff = diffH + " ore";
					} else {
						diff = diffD + " giorni";
					}

					text += "\n<b>Impresa globale</b>\n";

					if ((global == 1) && (diffM < 0) && (globalVal < global_cap)) {
						text += "Impresa fallita! ðŸš«\nSe non hai partecipato attivamente, riceverai un malus a breve!\n";
					} else {
						if (globalVal >= global_cap) {
							text += "Impresa completata! âœ…\nSe hai partecipato, riceverai una ricompensa ed il bonus l'ultimo giorno del mese!\n";
						} else {
							var cap = formatNumber(global_cap);
							if (global_wait == 1){
								text += "L'impresa sta raccogliendo dati, pazienta fino al primo giorno del mese alle 12:00!\n";
							}else{
								if (global_hide == 1)
									cap = "???";
								text += "Progresso: <b>" + formatNumber(globalVal) + "</b> / <b>" + cap + "</b> punti esperienza ottenuti\nTempo rimanente: <b>" + diff + "</b>\nAl completamento si otterrÃ  un bonus, al fallimento un malus, forza!\n";
							}
						}
					}

					var kb = {
						parse_mode: "HTML",
						reply_markup: {
							resize_keyboard: true,
							//one_time_keyboard: true,
							"keyboard": [["Informazioni Impresa Globale"], ["Impresa Globale"], ["Torna al menu"]]
						}
					};

					bot.sendMessage(message.chat.id, text + "\n<b>Imprese giornaliere completate</b>: " + formatNumber(cnt) + "\n\nLe imprese giornaliere con il * in caso di cap raggiunto (livello drago, talenti, ecc.), verranno completate automaticamente accedendo alla relativa sezione\nAlcune imprese giornaliere diventano piÃ¹ complicate ma allo stesso tempo piÃ¹ remunerative procedendo con le rinascite", kb).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text.indexOf("Informazioni") != -1){
								bot.sendMessage(message.chat.id, "Informazioni sulle Imprese Globali:\n\n" +
												"> Se la globale viene completata prima del termine effettivo, bisogna attendere l'ultimo giorno del mese per ottenere le ricompense\n" +
												"> Il punto di 'partecipazione attiva' viene ottenuto solamente se la globale viene completata ed in classifica viene segnalato il fatto che verrÃ  effettivamente ricevuto\n" +
												"> Il bonus viene applicato solo se l'impresa Ã¨ effettivamente completata\n" +
												"> Il malus viene applicato solo se l'impresa Ã¨ fallita oltrepassando il tempo limite\n" +
												"> Il bonus viene ottenuto solo dalle persone che hanno superato una certa soglia (variabile in base al tipo di impresa)\n" +
												"> Il malus viene ottenuto solo dalle persone che non hanno superato una certa soglia (variabile in base al tipo di impresa)\n" +
												"> Il malus viene ottenuto anche da chi non ha effettivamente partecipato ma poteva farlo (attivo nell'ultimo mese e rinato almeno una volta)", back);
							}
						}
					});
				});
			});
		});
	});
});

function getRealLevel(reb, lev) {
	if (reb == 2) {
		lev += 100;
	}
	if (reb == 3) {
		lev += 100;
		lev += 150;
	}
	if (reb == 4) {
		lev += 100;
		lev += 150;
		lev += 200;
	}
	if (reb == 5) {
		lev += 100;
		lev += 150;
		lev += 200;
		lev += 300;
	}
	return lev;
}

function getLevel(lev) {
	var reb = 0;
	if (lev >= 750) {
		lev -= 100;
		lev -= 150;
		lev -= 200;
		lev -= 300;
		reb = 5;
	} else if (lev >= 450) {
		lev -= 100;
		lev -= 150;
		lev -= 200;
		reb = 4;
	} else if (lev >= 250) {
		lev -= 100;
		lev -= 150;
		reb = 3;
	} else if (lev >= 100) {
		lev -= 100;
		reb = 2;
	}
	return lev + " R" + (reb - 1);
}

bot.onText(/^vacanza/i, function (message) {
	var iKeys = [];
	connection.query('SELECT account_id, holiday, id FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}

		var holiday = rows[0].holiday;
		var player_id = rows[0].id;
		var btn = "Avvia ModalitÃ  Vacanza";

		helpMsg(message.chat.id, player_id, 9);

		if (holiday != 0) {
			btn = "Disattiva ModalitÃ  Vacanza";
		}

		var kb = {
			parse_mode: "Markdown",
			reply_markup: {
				resize_keyboard: true,
				//one_time_keyboard: true,
				"keyboard": [[btn], ["Torna al menu"]]
			}
		};

		bot.sendMessage(message.chat.id, "Puoi entrare in modalitÃ  vacanza quando sai di non riuscire ad accedere al gioco per lungo tempo, non vuoi essere Ispezionato o espulso dal team.\nDurante questo periodo non potrai effettuare alcuna operazione se non di visualizzazione. *La durata minima Ã¨ 2 settimane*, quando vuoi disattivarla dopo questo periodo torna su questa pagina e clicca Disattiva ModalitÃ  Vacanza.", kb).then(function () {
			answerCallbacks[message.chat.id] = function (answer) {
				if (answer.text == "Avvia ModalitÃ  Vacanza") {
					if (holiday == 0) {
						bot.sendMessage(message.chat.id, "Sei giÃ  in vacanza!", back);
						return;
					}

					var now = new Date();
					now.setDate(now.getDate() + 14);
					var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

					var now2 = new Date();
					now2.setDate(now2.getDate() + 365);
					var long_date2 = now2.getFullYear() + "-" + addZero(now2.getMonth() + 1) + "-" + addZero(now2.getDate()) + " " + addZero(now2.getHours()) + ':' + addZero(now2.getMinutes()) + ':' + addZero(now2.getSeconds());

					bot.sendMessage(message.chat.id, "Sei sicuro? Non potrai annullare la modalitÃ  per due settimane!", yesno).then(function () {
						answerCallbacks[message.chat.id] = function (answer) {
							if (answer.text.toLowerCase() == "si") {
								connection.query('INSERT INTO holiday (player_id, time_end) VALUES (' + player_id + ',"' + long_date + '")', function (err, rows, fields) {
									if (err) throw err;
									connection.query('UPDATE player SET holiday = 1, heist_protection = "' + long_date2 + '" WHERE id = ' + player_id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(message.chat.id, "Hai attivato la modalitÃ  vacanza!", back);
									});
								});
							}
						};
					});
				} else if (answer.text == "Disattiva ModalitÃ  Vacanza") {
					if (holiday == 0) {
						bot.sendMessage(message.chat.id, "Non sei in vacanza!", back);
						return;
					}

					connection.query('SELECT time_end FROM holiday WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						var now = new Date();
						var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

						var end = new Date(rows[0].time_end);
						var long_date_end = end.getFullYear() + "-" + addZero(end.getMonth() + 1) + "-" + addZero(end.getDate()) + " " + addZero(end.getHours()) + ':' + addZero(end.getMinutes()) + ':' + addZero(end.getSeconds());

						if (long_date_end > long_date) {
							var long_date = addZero(end.getHours()) + ":" + addZero(end.getMinutes()) + ":" + addZero(end.getSeconds()) + " del " + addZero(end.getDate()) + "/" + addZero(end.getMonth() + 1) + "/" + end.getFullYear();
							bot.sendMessage(message.chat.id, "Non puoi ancora tornare dalla vacanza, devi aspettare fino alle " + long_date + "!", back);
							return;
						}

						connection.query('UPDATE player SET holiday = 0, heist_protection = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							connection.query('DELETE FROM holiday WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(message.chat.id, "Hai disattivato la modalitÃ  vacanza!", back);
							});
						});
					});
				}
			};
		});
	});
});

bot.onText(/viaggi/i, function (message) {
	var iKeys = [];

	connection.query('SELECT mission_special_id, mission_special_time_end, mission_id, id, reborn, exp, life, account_id, global_end, mission_party, holiday, class FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			return;
		}

		var banReason = isBanned(rows[0].account_id);
		if (banReason != null) {
			var text = "Il tuo account Ã¨ stato *bannato* per il seguente motivo: _" + banReason + "_";
			bot.sendMessage(message.chat.id, text, mark);
			return;
		}
		if (rows[0].holiday == 1) {
			bot.sendMessage(message.chat.id, "Sei in modalitÃ  vacanza!\nVisita la sezione Giocatore per disattivarla!", back)
			return;
		}

		var lev = rows[0].exp / 10;
		var life = rows[0].life;
		var exp = rows[0].exp;
		var reborn = rows[0].reborn;
		var player_id = rows[0].id;
		var global_end = rows[0].global_end;
		var class_id = rows[0].class;

		helpMsg(message.chat.id, player_id, 11);

		if ((life <= 0) && (exp > 10)) {
			bot.sendMessage(message.chat.id, "Non puoi affrontare i viaggi da morto.", revive);
			return;
		}

		if (rows[0].mission_id != 0) {
			bot.sendMessage(message.chat.id, "Non puoi andare in viaggio finchÃ¨ sei in missione.", back);
			return;
		}

		if (rows[0].mission_party > 0) {
			bot.sendMessage(message.chat.id, "Incarico in corso! Attendi il termine prima di avviare un viaggio.", back)
			return;
		}

		connection.query('SELECT * FROM event_mana_status WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length > 0) {
				if (rows[0].zone_id != 0) {
					bot.sendMessage(message.chat.id, "Non puoi andare in viaggio finchÃ¨ sei in miniera.", back);
					return;
				}
			}

			connection.query('SELECT travel_id, travel_time_end, cave_id, cave_time_end, id, boost_id, boost_mission, charm_id FROM player WHERE nickname="' + message.from.username + '"', function (err, rows, fields) {
				if (err) throw err;
				var player_id = rows[0].id;
				var boost_id = rows[0].boost_id;
				var boost_mission = rows[0].boost_mission;
				var charm_id = rows[0].charm_id;

				if (rows[0].travel_id != 0) {
					var time = new Date(rows[0].travel_time_end);
					bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth() + 1) + "/" + time.getFullYear(), abort_travel);
					return;
				} else if (rows[0].cave_id != 0) {
					var time = new Date(rows[0].cave_time_end);
					bot.sendMessage(message.chat.id, "Sei in viaggio fino alle " + addZero(time.getHours()) + ":" + addZero(time.getMinutes()) + ":" + addZero(time.getSeconds()) + " del " + addZero(time.getDate()) + "/" + addZero(time.getMonth() + 1) + "/" + time.getFullYear(), abort_travel_2);
					return;
				} else {
					var extra = "SELECT name, duration FROM cave UNION ALL ";
					if ((lev < 10) && (reborn == 1)) {
						extra = "";
					}
					connection.query('SELECT combat FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						var combat = 0;
						if (Object.keys(rows).length > 0) {
							combat = rows[0].combat;
						}

						connection.query('SELECT level, life, sleep_h FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							var dragon_level = 0;
							var text = "";

							if ((Object.keys(rows).length > 0) && (combat == 0)) {
								if ((rows[0].life > 0) || ((rows[0].life == 0) && (rows[0].sleep_h > 0))) {
									dragon_level = rows[0].level;
								}
							}

							connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 15', function (err, rows, fields) {
								if (err) throw err;

								var abBonus = 0;
								var double = 0;
								if (Object.keys(rows).length > 0) {
									var rand = Math.random() * 100;
									abBonus = parseInt(rows[0].ability_level) * rows[0].val;
									if (rand < abBonus) {
										double = 1;
									}
								}

								connection.query(extra + 'SELECT name, duration FROM travel', function (err, rows, fields) {
									if (err) throw err;
									for (var i = 0, len = Object.keys(rows).length; i < len; i++) {

										if (rows[i].name.indexOf("Cava") != 1){
											if ((class_id == 7) && (reborn > 1)){
												rows[i].duration -= rows[i].duration*0.05;
											}
										}

										rows[i].duration -= rows[i].duration*(dragon_level/300);
										iKeys.push(["Viaggia a " + rows[i].name + " (" + toTime(rows[i].duration*60, 0) + ")"]);
									}
									if (Object.keys(iKeys).length > 0) {
										iKeys.push(["Torna al menu"]);
										var viaggio = "";

										var kb = {
											parse_mode: "Markdown",
											reply_markup: {
												resize_keyboard: true,
												//one_time_keyboard: true,
												"keyboard": iKeys
											}
										};

										var kb2 = {
											parse_mode: "Markdown",
											reply_markup: {
												resize_keyboard: true,
												//one_time_keyboard: true,
												"keyboard": [["Si"],["Torna ai viaggi"],["Torna al menu"]]
											}
										};

										if (message.text.indexOf("Viaggia a") != -1) {
											viaggio = message.text.substring(getPosition(message.text, " ", 2) + 1);

											var pos = viaggio.indexOf("(");
											if (pos != -1) {
												viaggio = viaggio.substr(0, pos - 1);
											}

											if ((boost_id == 3) && (boost_mission <= 0)) {
												connection.query('UPDATE player SET boost_id = 0 AND boost_mission = 0 WHERE id = ' + player_id, function (err, rows, fields) {
													if (err) throw err;
												});
												boost_id = 0;
											}

											var boost_text = "";
											if (viaggio.indexOf("Cava") != -1) {
												boost_text = "\nBevanda: âŒ";
												if ((boost_id == 3) && (boost_mission > 0)) {
													boost_text = "\nBevanda: âœ…";
												}
												if ((charm_id == 603) || (charm_id == 695)) {
													boost_text += "\nTalismano bonus pietre: âœ…";
												}else{
													boost_text += "\nTalismano bonus pietre: âŒ";
												}
											}

											bot.sendMessage(message.chat.id, "Iniziare il viaggio?" + boost_text, kb2).then(function () {
												answerCallbacks[message.chat.id] = function (answer) {
													var resp = answer.text;
													if (resp.toLowerCase() != "si") {
														return;
													}
													var cavepos = viaggio.indexOf("Cava");
													if (cavepos != -1) {
														if ((exp < 100) && (reborn == 1)) {
															bot.sendMessage(message.chat.id, "Non puoi viaggiare in cava fino al livello 10.", back);
															return;
														}

														connection.query('SELECT * FROM cave WHERE name = "' + viaggio + '"', function (err, rows, fields) {
															if (err) throw err;
															if (Object.keys(iKeys).length == 0) {
																bot.sendMessage(message.chat.id, "Cava non valida.", back);
																return;
															}else{

																var split = "";
																if (double == 1) {
																	rows[0].duration = rows[0].duration/2;
																	split = " dimezzato!";
																}
																if ((class_id == 7) && (reborn > 1)){
																	rows[0].duration -= rows[0].duration*0.05;
																}

																rows[0].duration -= rows[0].duration*(dragon_level/300);
																var now = new Date();
																now.setMinutes(now.getMinutes() + rows[0].duration);
																var time = " <i>(" + toTime(rows[0].duration*60, 0) + split + ")</i>";

																var short_date = addZero(now.getDate()) + "/" + addZero(now.getMonth() + 1) + "/" + now.getFullYear() + " alle " + addZero(now.getHours()) + ":" + addZero(now.getMinutes());

																var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

																bot.sendMessage(message.chat.id, "<b>" + rows[0].name + "</b>\n" + message.from.username + ", ti aspetta un esplorazione nella " + viaggio + " che terminerÃ  il " + short_date + time, abort_travel_2);

																connection.query('UPDATE player SET exp = exp+1, cave_id = ' + rows[0].id + ', chat_id = ' + message.chat.id + ', cave_time_end = "' + long_date + '", cave_gem = 0 WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
																	if (err) throw err;
																});
															}
														});
													} else {
														connection.query('SELECT * FROM travel WHERE name = "' + viaggio + '"', function (err, rows, fields) {
															if (err) throw err;
															if (Object.keys(rows).length == 0) {
																bot.sendMessage(message.chat.id, "Viaggio non valido.", back);
																return;
															}else{

																var split = "";
																if (double == 1) {
																	rows[0].duration = rows[0].duration/2;
																	split = " dimezzato!";
																}

																rows[0].duration -= rows[0].duration*(dragon_level/300);
																var now = new Date();
																now.setMinutes(now.getMinutes() + rows[0].duration);
																var time = " <i>(" + toTime(rows[0].duration*60, 0) + split + ")</i>";

																var short_date = addZero(now.getDate()) + "/" + addZero(now.getMonth() + 1) + "/" + now.getFullYear() + " alle " + addZero(now.getHours()) + ":" + addZero(now.getMinutes());

																var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

																bot.sendMessage(message.chat.id, "<b>" + rows[0].name + "</b>\n" + message.from.username + ", ti aspetta un incredibile viaggio, " + rows[0].description + " " + short_date + time, abort_travel);

																connection.query('UPDATE `player` SET exp = exp+1, travel_id = ' + rows[0].id + ', chat_id = ' + message.chat.id + ', travel_time_end = "' + long_date + '" WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
																	if (err) throw err;
																});
															}
														});
													}
												};
											});
											return;
										};

										var extra = "\n";
										if (abBonus > 0){
											extra += "Talento: " + Math.round(abBonus) + "% di dimezzare il tempo\n";
										}
										if (dragon_level > 1){
											extra += "Drago: -" + Math.round(dragon_level/3) + "% tempo\n";
										}
										if ((class_id == 7) && (reborn > 1)){
											extra += "Vocazione: -5% tempo Cave\n";
										}

										bot.sendMessage(message.chat.id, "Seleziona il viaggio o la cava da esplorare" + extra, kb);
									}
								});
							});
						});
					});
				}
			});
		});
	});
});


//FUNZIONI

function refreshBosses() {
	connection.query('SELECT id FROM team WHERE boss_respawn < NOW() AND boss_respawn IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			var team_id = rows[0].id;
			connection.query('SELECT id, team_id, boss_id FROM boss_team WHERE team_id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					rows.forEach(respawnBoss);
				}
			});

			connection.query('SELECT player_id, chat_id FROM team_player, player WHERE team_player.player_id = player.id AND team_id = ' + team_id + ' ORDER BY team_player.id', function (err, rows, fields) {
				if (err) throw err;

				for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
					bot.sendMessage(rows[i].chat_id, "I boss sono tornati in vita, torna a combattere!");
				}
			});
		}
	});
}

function respawnBoss(element, index, array) {
	if (element.boss_id == 1) {
		connection.query('UPDATE boss_team SET life = total_life, killedby = NULL, killeddate = NULL, unlocked = 1, paralyzed = 0, critic = 0, countdown = 0 WHERE id = ' + element.id, function (err, rows, fields) {
			if (err) throw err;
		});
	} else {
		connection.query('UPDATE boss_team SET life = total_life, killedby = NULL, killeddate = NULL, unlocked = 0, paralyzed = 0, critic = 0, countdown = 0 WHERE id = ' + element.id, function (err, rows, fields) {
			if (err) throw err;
		});
	}
	connection.query('UPDATE team SET boss_respawn = NULL, boost_id = 0 WHERE id = ' + element.team_id, function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('DELETE FROM boss_damage WHERE team_id = ' + element.team_id, function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('UPDATE player P INNER JOIN team_player T ON P.id = T.player_id SET P.boss_id = NULL WHERE T.team_id = ' + element.team_id, function (err, rows, fields) {
		if (err) throw err;
	});
}

function respawnBossMan(team_id) {
	connection.query('SELECT id, team_id, boss_id FROM boss_team WHERE team_id = ' + team_id, function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				if (rows[i].boss_id == 1) {
					connection.query('UPDATE boss_team SET life = total_life, killedby = NULL, killeddate = NULL, unlocked = 1 WHERE id = ' + rows[i].id, function (err, rows, fields) {
						if (err) throw err;
					});
				} else {
					connection.query('UPDATE boss_team SET life = total_life, killedby = NULL, killeddate = NULL, unlocked = 0 WHERE id = ' + rows[i].id, function (err, rows, fields) {
						if (err) throw err;
					});
				}
			};
			connection.query('UPDATE team SET boss_respawn = NULL, boost_id = 0 WHERE id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('DELETE FROM boss_damage WHERE team_id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE player P INNER JOIN team_player T ON P.id = T.player_id SET P.boss_id = NULL WHERE T.team_id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
			});
		};
	});
}

function refreshLife() {
	connection.query('UPDATE player SET life = total_life, paralyzed = 0, status = NULL, status_cnt = 0', function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('UPDATE dragon SET life = total_life', function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('DELETE FROM daily_chest', function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('UPDATE merchant_offer SET day_cnt = 0', function (err, rows, fields) {
		if (err) throw err;
	});
	console.log(getNow("it") + " refreshLife ok.");
}

function cleanDragon() {
	connection.query('DELETE FROM dragon_dummy', function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('DELETE FROM dragon_top_dummy', function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('UPDATE dragon_top_status SET is_dummy = 0, enemy_dragon_id = NULL', function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('UPDATE dragon_top_rank SET combat = 0', function (err, rows, fields) {
		if (err) throw err;
	});
	console.log(getNow("it") + " cleanDragon ok.");
}

function checkDragonNoBattle() {
	connection.query('UPDATE dragon_top_status D1, dragon_top_rank D2 SET D2.rank = D2.rank-1 WHERE D2.rank > 0', function (err, rows, fields) {
		if (err) throw err;
	});
};

function checkDragonSleep() {
	connection.query('SELECT player.chat_id, dragon.id, dragon.name, dragon.sleep_h, dragon.total_life, dragon.life FROM dragon, player WHERE dragon.player_id = player.id AND sleep_time_end < NOW() AND sleep_time_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 drago svegliato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " draghi svegliati\x1b[0m");
			}
			rows.forEach(setDragonSleep);
		}
	});
};

function checkDragonNoMatch() {
	connection.query('UPDATE dragon_top_status SET no_match_time = NULL WHERE no_match_time < NOW() AND no_match_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
	});
};

function setDragonSleep(element, index, array) {
	var sleep_h = element.sleep_h;
	var life = element.life + Math.round(element.total_life / 100 * sleep_h);
	var chat_id = element.chat_id;
	var total_life = element.total_life;

	if (life > total_life) {
		life = total_life;
	}

	var d = new Date();
	d.setMinutes(d.getMinutes() + 15);
	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

	connection.query('UPDATE dragon_top_status SET poison = 0, dmg_boost = 0, confusion = 0, wait_dmg = 0, ice = 0, no_match_time = "' + long_date + '" WHERE dragon_id = ' + element.id, function (err, rows, fields) {
		if (err) throw err;
		connection.query('UPDATE dragon SET sleep_time_end = NULL, sleep_h = 0, life = ' + life + ' WHERE id = ' + element.id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Il tuo drago si Ã¨ risvegliato dopo aver recuperato il " + sleep_h + "% della salute!");
		});
	});
};

function checkDragonSearchCd() {
	connection.query('SELECT id, chat_id FROM player WHERE status IS NOT NULL AND status_cnt >= 30', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 ricerca scaduta\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " ricerche scadute\x1b[0m");
			}
			rows.forEach(setDragonSearchCd);
		}
	});
};

function setDragonSearchCd(element, index, array) {
	var player_id = element.id;

	//bot.sendMessage(element.chat_id, "Il tempo in coda Ã¨ scaduto, entra nuovamente per ritentare la ricerca");
	// Questa funzione serve sempre per far scadere i draghi in coda che non vengono selezionati per matchare

	console.log("Ricerca scaduta, avvio scontro dummy");
	connection.query('SELECT player.chat_id, player.id As player_id, dragon_top_rank.top_id, dragon_top_rank.dragon_id, dragon.name, dragon.type, dragon.arms_id, player.status_cnt, dragon.level, dragon_top_rank.rank, dragon.exp FROM dragon_top_rank, player, dragon WHERE dragon_top_rank.dragon_id = dragon.id AND dragon_top_rank.player_id = player.id AND player.id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		dragonDummyStart(rows[0].top_id, rows[0].chat_id, rows[0].rank, rows[0].dragon_id, rows[0].player_id, rows[0].exp, rows[0].arms_id);
	});
};

function checkDragonSearch() {
	connection.query('SELECT player.chat_id, MIN(player.status) As status, player.id As player_id, dragon_top_rank.top_id, dragon_top_rank.dragon_id, dragon.name, dragon.type, dragon.arms_id, player.status_cnt, dragon.level, dragon_top_rank.rank, dragon.exp FROM dragon_top_rank, player, dragon WHERE dragon_top_rank.dragon_id = dragon.id AND dragon_top_rank.player_id = player.id AND player.status IS NOT NULL GROUP BY top_id ORDER BY top_id DESC, status ASC', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 ricerca drago avversario in corso\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " ricerche draghi in corso\x1b[0m");
			}
			rows.forEach(setDragonSearch);
		}
	});
};

function littleVar(num, variation){
	var number = 0;
	number = num;
	return Math.round(getRandomArbitrary(number-variation, number+variation));
}

function setDragonSearch(element, index, array) {
	var kbCombat = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [['Entra in combattimento'], ['Torna al menu']]
		}
	};

	var dragon_id = element.dragon_id;
	var player_id = element.player_id;
	var top_id = element.top_id;
	var dragon_name = element.name;
	var my_dragon_type = element.type;
	var dragon_arms_id = element.arms_id;
	var dragon_lev = element.level;
	var chat_id = element.chat_id;
	var status_cnt = element.status_cnt;
	var my_rank = element.rank;
	var my_exp = element.exp;

	// incrementa ogni ricerca
	connection.query('UPDATE player p INNER JOIN dragon_top_rank d ON p.id = d.player_id SET p.status_cnt = p.status_cnt+1 WHERE p.status IS NOT NULL AND d.top_id = ' + top_id, function (err, rows, fields) {
		if (err) throw err;
	});

	var d = new Date();
	d.setMinutes(d.getMinutes() + 20);
	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

	var status_cnt_limit = 25;

	if (player_id == 1)
		status_cnt_limit = 3;

	/*
	if (status_cnt >= status_cnt_limit) {
		console.log("Ricerca limite, avvio scontro dummy");
		dragonDummyStart(top_id, chat_id, my_rank, dragon_id, player_id, my_exp, dragon_arms_id);
		return;
	}
	*/

	if (status_cnt >= 30){
		// per non matchare quando dovrebbe scadere (?)
		console.log("Salto match per status_cnt a " + status_cnt);
		return;
	}

	var diff = ((status_cnt * 2) + 20);
	var searchOpt = "D.level";
	var searchVal = dragon_lev;

	var rand = Math.random()*100;
	if (rand < 50){
		searchOpt = "D.level BETWEEN " + (dragon_lev-50) + " AND " + (dragon_lev+50) + " AND R.rank";
		searchVal = my_rank;
		diff = Math.round(diff/5);
	}

	var query = 'SELECT P.chat_id, R.dragon_id, R.rank, D.name, D.type, D.level, D.arms_id FROM dragon_top_rank R, dragon D, player P, dragon_top_status D2 WHERE D2.dragon_id = D.id AND P.id = D.player_id AND ' + searchOpt + ' BETWEEN ' + (searchVal - diff) + ' AND ' + (searchVal + diff) + ' AND R.dragon_id = D.id AND R.top_id = ' + top_id + ' AND R.dragon_id != ' + dragon_id + ' AND R.combat = 0 AND D.sleep_h = 0 AND D.life > 0 AND D2.no_match_time IS NULL AND R.dragon_id != 3 AND P.status IS NULL ORDER BY RAND()';
	connection.query(query, function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0) {
			//console.log("Nessun drago disponibile");
			return;
		}

		console.log("Drago trovato!");

		var name = rows[0].name;
		var type = rows[0].type;
		var rank = rows[0].rank;
		var level = rows[0].level;
		var enemy_dragon_arms_id = rows[0].arms_id;
		var enemy_dragon_id = rows[0].dragon_id;
		var chat_id2 = rows[0].chat_id;

		connection.query('UPDATE player SET status = NULL, status_cnt = 0 WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			connection.query('UPDATE dragon_top_status SET poison = 0, protection = 0, dmg_boost = 0, confusion = 0, wait_dmg = 0, ice = 0, enemy_dragon_id = ' + enemy_dragon_id + ', battle_time = "' + long_date + '", no_match_time = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) {
					bot.sendMessage(chat_id, "A causa di un problema sei stato escluso dal combattimento in vetta senza penalitÃ , ora puoi rientrare in coda");
					console.log("ERRORE DUPLICAZIONE player_id " + player_id);
					throw err;
					return;
				}

				// se duplicato si rompe qua com'Ã¨ giusto che sia

				connection.query('UPDATE dragon_top_rank SET combat = 1 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
					if (err) throw err;
					connection.query('UPDATE dragon_top_rank SET combat = 1 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
						if (err) throw err;

						var scale = 1;
						if (dragon_arms_id == 709) {
							var rand = Math.random() * 100;
							if (rand < 50) {
								scale = 2;
							}
						}
						var enemy_scale = 1;
						if (enemy_dragon_arms_id == 709) {
							var rand = Math.random() * 100;
							if (rand < 50) {
								enemy_scale = 2;
							}
						}

						connection.query('UPDATE dragon SET scale = ' + enemy_scale + ' WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
							if (err) throw err;
							connection.query('UPDATE dragon SET scale = ' + scale + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "La â™¨ï¸ Fiamma del Prescelto si muove sopra i nomi dei draghi del monte e si ferma sul drago <b>" + name + " " + type + "</b> " + dragonSym(type) + ". Questo sfidante ha raggiunto <b>" + rank + " Ã</b> ed Ã¨ un drago di livello <b>" + level + "</b>. Buona fortuna!", kbCombat);
								bot.sendMessage(chat_id2, "Il tuo drago Ã¨ stato sfidato nella vetta da <b>" + dragon_name + " " + my_dragon_type + "</b>!", html);

								connection.query("UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id IN (SELECT dragon_id FROM dragon_top_unlinked)", function (err, rows, fields) {
									if (err) throw err;
								});
							});
						});
					});
				});
			});
		});
	});
}

function dragonDummyStart(top_id, chat_id, my_rank, dragon_id, player_id, my_exp, dragon_arms_id){

	var kbCombat = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [['Entra in combattimento'], ['Torna al menu']]
		}
	};

	var d = new Date();
	d.setMinutes(d.getMinutes() + 20);
	var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

	var name_list = connection_sync.query("SELECT name FROM dragon_name_list ORDER BY RAND()");
	var dummy_name = name_list[0].name;
	var dummy_exp = littleVar(my_exp, 700);	// 10 livelli di differenza max
	if (dummy_exp > 14000)
		dummy_exp = 14000;
	var dummy_level = Math.floor(dummy_exp/70);
	var dummy_scale = 1;
	var type_array = ["dei Mari", "delle Montagne", "Infernale", "dell'OscuritÃ ", "dei Cieli", "dei Ghiacci"];
	var dummy_type = type_array[Math.floor(Math.random() * type_array.length)];
	var equip_rarity = "";
	if (dummy_level < 50){
		equip_rarity = "'NC','R','UR'";
	}else if (dummy_level < 100){
		equip_rarity = "'L','E'";
	}else if (dummy_level < 150){
		equip_rarity = "'E','UE'";
	}else{
		equip_rarity = "'UE'";
	}
	var claws_list = connection_sync.query("SELECT id, dragon_power FROM item WHERE name LIKE 'Artigli %' AND rarity IN (" + equip_rarity + ") ORDER BY RAND()");
	var dummy_claws_id = claws_list[0].id;
	var dummy_claws = claws_list[0].dragon_power;
	var saddle_list = connection_sync.query("SELECT id, dragon_power FROM item WHERE name LIKE 'Sella %' AND rarity IN (" + equip_rarity + ") ORDER BY RAND()");
	var dummy_saddle_id = saddle_list[0].id;
	var dummy_saddle = Math.abs(claws_list[0].dragon_power);
	var arms_list = 0;
	var dummy_arms_id = 0;
	if (dummy_level > 150){
		arms_list = connection_sync.query("SELECT id FROM item WHERE name LIKE 'Stemma %' AND rarity = 'UE' ORDER BY RAND()");
		dummy_arms_id = arms_list[0].id;
	}
	var dummy_evolved = 0;
	if (dummy_level > 100)
		dummy_evolved = 1;

	if (dummy_arms_id == 709) {
		var rand = Math.random() * 100;
		if (rand < 50) {
			dummy_scale = 2;
		}
	}

	connection.query('INSERT INTO dragon_dummy (name, exp, level, scale, claws_id, claws, saddle_id, saddle, arms_id, type, evolved) VALUES ("' + dummy_name + '", ' + dummy_exp + ', ' + dummy_level + ',' + dummy_scale + ',' + dummy_claws_id + ',' + dummy_claws + ',' + dummy_saddle_id + ',' + dummy_saddle + ',' + dummy_arms_id + ',"' + dummy_type + '",' + dummy_evolved + ')', function (err, rows, fields) {
		if (err) throw err;

		var dummy_id = rows.insertId;
		checkDragon(dummy_id, 1);

		var scale = 1;
		if (dragon_arms_id == 709) {
			var rand = Math.random() * 100;
			if (rand < 50) {
				scale = 2;
			}
		}

		connection.query('INSERT INTO dragon_top_dummy (dragon_id, top_id) VALUES (' + dummy_id + ',' + top_id + ')', function (err, rows, fields) {
			if (err) throw err;

			var enemy_dragon_id = dummy_id;

			connection.query('UPDATE dragon_top_status SET poison = 0, protection = 0, dmg_boost = 0, confusion = 0, wait_dmg = 0, ice = 0, enemy_dragon_id = ' + enemy_dragon_id + ', battle_time = "' + long_date + '", no_match_time = NULL, is_dummy = 1 WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				connection.query('UPDATE dragon_top_rank SET combat = 1 WHERE dragon_id = ' + dragon_id, function (err, rows, fields) {
					if (err) throw err;
					connection.query('UPDATE dragon SET scale = ' + scale + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;

						var dummy_rank = my_rank;

						bot.sendMessage(chat_id, "La â™¨ï¸ Fiamma del Prescelto si muove sopra i nomi dei draghi del monte e si ferma sul drago <b>" + dummy_name + " " + dummy_type + "</b> " + dragonSym(dummy_type) + ". Questo sfidante ha raggiunto <b>" + dummy_rank + " Ã</b> ed Ã¨ un drago di livello <b>" + dummy_level + "</b>. Buona fortuna!", kbCombat);

						connection.query("UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id IN (SELECT dragon_id FROM dragon_top_unlinked)", function (err, rows, fields) {
							if (err) throw err;
						});
						connection.query('UPDATE player SET status_cnt = 0, status = NULL WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					});
				});
			});
		});
	});
}

function checkDragonTop() {
	connection.query('SELECT player.chat_id, player.id As player_id, dragon_top_rank.rank, dragon_top_rank.top_id FROM dragon_top_rank, player WHERE dragon_top_rank.player_id = player.id', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 drago passato di monte\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " draghi passati di monte\x1b[0m");
			}
			rows.forEach(setDragonTop);
		}
	});
};

function setDragonTop(element, index, array) {
	var chat_id = element.chat_id;
	var player_id = element.player_id;
	var rank = element.rank;
	var top = element.top_id;
	var res = 0;

	connection.query('SELECT pnt FROM dragon_top_list WHERE id = ' + top, function(err, rows, fields) {
		if (err) throw err;

		var reset = 0;
		if (rank <= 2) {
			if (top > 1) {
				top--;
				reset = 6;
			} else {
				reset = rank;
			}
			res = -1;
		} else if (rank >= rows[0].pnt) {
			if (top < 5){
				top++;
				res = 1;
				reset = 6;
			}else{
				res = 0;
				reset = rank;
			}
		} else {
			res = 0;
			reset = rank;
		}

		connection.query('SELECT name FROM dragon_top_list WHERE id = ' + top, function (err, rows, fields) {
			if (err) throw err;
			var name = rows[0].name;
			connection.query('UPDATE dragon_top_status SET top_id = ' + top + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
				connection.query('UPDATE dragon_top_rank SET top_id = ' + top + ', rank = ' + reset + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					if (res == 1) {
						bot.sendMessage(chat_id, "In base al tuo posizionamento nella vetta sei stato portato al monte successivo! Il *" + name + "*!", mark);
					} else if (res == -1) {
						bot.sendMessage(chat_id, "In base al tuo posizionamento nella vetta sei stato retrocesso al monte precedente! Il *" + name + "*!", mark);
					} else if (res == 0) {
						bot.sendMessage(chat_id, "In base al tuo posizionamento nella vetta sei rimasto nel monte attuale! Il *" + name + "*!", mark);
					}
				});
			});
		});
	});
}

function checkDragonBattle() {
	connection.query('SELECT player.chat_id, player.id, enemy_dragon_id, dragon_id, is_dummy, top_id FROM dragon_top_status, player WHERE dragon_top_status.player_id = player.id AND battle_time < NOW() AND battle_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 battaglia drago scaduta\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " battaglie drago scadute\x1b[0m");
			}
			rows.forEach(setDragonBattle);
		}
	});
};

function setDragonBattle(element, index, array) {
	var chat_id = element.chat_id;
	var player_id = element.id;
	var enemy_dragon_id = element.enemy_dragon_id;
	var dragon_id = element.dragon_id;
	var is_dummy = element.is_dummy;
	var top_id = element.top_id;

	connection.query('SELECT rank FROM dragon_top_rank WHERE player_id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;

		var my_rank = rows[0].rank;

		connection.query('SELECT rank, top_id FROM dragon_top_rank WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
			if (err) throw err;

			if (is_dummy == 0){
				if (Object.keys(rows).length == 0) {
					return;
				}

				var enemy_rank = rows[0].rank;
				var enemy_top_id = rows[0].top_id;
			}else{
				enemy_rank = my_rank;
				enemy_top_id = top_id;
			}

			connection.query('SELECT level FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;

				var dragon_level = rows[0].level;

				var table = "dragon";
				var table2 = "dragon_top_status";
				if (is_dummy == 1){
					table = "dragon_dummy";
					table2 = "dragon_top_dummy";
				}

				connection.query('SELECT level, arms_id FROM ' + table + ' WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
					if (err) throw err;

					var enemy_dragon_level = rows[0].level;
					var enemy_dragon_arms_id = rows[0].arms_id;

					var rank = 1;
					var rank_lost = 1;
					if ((enemy_dragon_level + 20) < dragon_level) {
						rank = 2;
						rank_lost = 2;
					}
					if (my_rank >= rank_lost) {
						connection.query('UPDATE dragon_top_rank SET rank = rank-' + rank_lost + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					} else { //Riprova con 1 rank, sperando che chi perde abbia almeno un rango
						rank_lost = 1;
						if (my_rank >= rank_lost) {
							connection.query('UPDATE dragon_top_rank SET rank = rank-' + rank_lost + ' WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
							});
						} else {
							rank_lost = 0; //Nel caso in cui chi perde abbia zero rango
						}
					}

					if (enemy_top_id < 5){
						if (enemy_rank + rank >= rank_cap) {
							rank = rank_cap - enemy_rank;
							if (rank < 0)
								rank = 0;
						}
					}
					connection.query('UPDATE dragon_top_rank SET rank = rank+' + rank + ' WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
						if (err) throw err;
					});

					var d = new Date();
					d.setMinutes(d.getMinutes() + 15);
					var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

					connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						connection.query('UPDATE dragon_top_rank SET combat = 0 WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
							if (err) throw err;
							connection.query('UPDATE dragon_top_status SET enemy_dragon_id = NULL, battle_time = NULL, is_dummy = 0 WHERE player_id = ' + player_id, function (err, rows, fields) {
								if (err) throw err;
								connection.query('UPDATE ' + table2 + ' SET enemy_dragon_id = NULL, battle_time = NULL, no_match_time = "' + long_date + '" WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
									if (err) throw err;
									connection.query('SELECT player.chat_id, player.id FROM player, dragon WHERE dragon.id = ' + enemy_dragon_id + ' AND player.id = dragon.player_id', function (err, rows, fields) {
										if (err) throw err;

										var chest = 1;
										if (enemy_dragon_level > (dragon_level + 50)) {
											chest = 0;
										}

										if (enemy_dragon_arms_id == 714) {
											var randS = Math.random() * 100;
											if (randS < 50) {
												chest++;
											}
										}

										if (my_rank == 0)
											chest = 0;

										var extra = "";
										if (chest == 1) {
											extra = " ed uno Scrigno Scaglia";

											if (is_dummy == 0){
												addChest(rows[0].id, 9);
											}
										} else if (chest > 1) {
											extra = " e " + chest + " Scrigni Scaglia";
											if (is_dummy == 0){
												addChest(rows[0].id, 9, chest);
											}
										}

										bot.sendMessage(chat_id, "La battaglia nella vetta Ã¨ scaduta, hai perso " + rank_lost + " Ã!");

										if (is_dummy == 0){
											bot.sendMessage(rows[0].chat_id, "Lo sfidante nella vetta ha lasciato scadere la battaglia, hai ottenuto " + rank + " Ã" + extra + "!");

											var d = new Date();
											var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
											connection.query('INSERT INTO dragon_top_log (player_id, dragon_id, enemy_player_id, enemy_dragon_id, time, win, note) VALUES (' + player_id + ',' + dragon_id + ',' + rows[0].id + ',' + enemy_dragon_id + ',"' + long_date + '",2,"Scaduta")', function (err, rows, fields) {
												if (err) throw err;
											});
										}else if (is_dummy == 1){
											connection.query('DELETE FROM dragon_top_dummy WHERE dragon_id = ' + enemy_dragon_id, function (err, rows, fields) {
												if (err) throw err;
												connection.query('DELETE FROM dragon_dummy WHERE id = ' + enemy_dragon_id, function (err, rows, fields) {
													if (err) throw err;
												});
											});
										}
									});
								});
							});
						});
					});
				});
			});
		});
	});
};

function checkDragonTopCd() {
	connection.query('SELECT player.chat_id, dragon_top_status.id, dragon.sleep_h FROM dragon_top_status, player, dragon WHERE dragon.id = dragon_top_status.dragon_id AND dragon_top_status.player_id = player.id AND wait_time < NOW() AND wait_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 drago timeout vetta\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " draghi timeout vetta\x1b[0m");
			}
			rows.forEach(setDragonTopCd);
		}
	});
};

function setDragonTopCd(element, index, array) {
	var chat_id = element.chat_id;

	connection.query('UPDATE dragon_top_status SET wait_time = NULL WHERE id = ' + element.id, function (err, rows, fields) {
		if (err) throw err;
		if (element.sleep_h == 0) {
			bot.sendMessage(chat_id, "Il drago puÃ² tornare a combattere nella vetta!");
		}
	});
};

function checkTeam() {
	connection.query('SELECT id, chat_id FROM player WHERE team_time < NOW() AND team_time IS NOT NULL', function (err, rows, fields) {
		var chat_id = 0;
		var id = 0;
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				chat_id = rows[i].chat_id;
				id = rows[i].id;

				bot.sendMessage(chat_id, "E' scaduto il tempo di attesa per accedere ad un nuovo team!");

				connection.query('UPDATE player SET team_time = NULL WHERE id = ' + id, function (err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
	connection.query('SELECT id, chat_id FROM player WHERE boss_time < NOW() AND boss_time IS NOT NULL', function (err, rows, fields) {
		var chat_id = 0;
		var id = 0;
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				chat_id = rows[i].chat_id;
				id = rows[i].id;

				connection.query('UPDATE player SET boss_time = NULL WHERE id = ' + id, function (err, rows, fields) {
					if (err) throw err;
				});
			}
		}
	});
};

function checkEvents() {
	connection.query('SELECT * FROM player WHERE event = 0 AND mission_id != 0 AND money > 500 AND exp > 100 ORDER BY RAND() LIMIT 10', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 evento da notificare\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " eventi da notificare\x1b[0m");
			}
			rows.forEach(setEvents);
		}
	});
}

function setEvents(element, index, array) {
	var player_id = 0;
	var chat_id = 0;
	var level = 0;
	var rand = 0;
	var text = "";
	var itemName = "";
	var itemName2 = "";
	var itemName3 = "";
	var chat_id_t = 0;
	var money = 0;
	var mission_id = element.mission_id;

	rand = Math.round(Math.random() * 46);

	if (crazyMode == 1) {
		rand = Math.round(Math.random() * 50);
	}

	player_id = element.id;
	boss_id = element.boss_id;
	chat_id = element.chat_id;
	level = element.exp / 10;
	exp = element.exp;
	money = element.money;

	if (mission_id == 1002) {
		text = "Durante la Missione vieni distratto da una rauca voce che invoca il tuo nome dall'oscuro portone di un edificio in rovina. La voce appartiene a una figura incappucciata che, al tuo apparire, senza mostrare il volto, ti porge cauta un tomo possente. Ne Ã¨ adorno il fronte, che a una bianca gemma ne cinge tre: cosÃ¬ Ã¨ rossa, gialla ed eguale blu. Scompare la figura, ciÃ² tuttavia s'accresce l'ardore: desideri leggerlo, desideri imparare. Un luogo conosciuto potrebbe aiutarti.";
		bot.sendMessage(chat_id, text);

		connection.query('UPDATE player SET event = 1 WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});
		return;
	}

	if (rand == 0) {
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("C", "NC") AND item.craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			addItem(player_id, rows[0].id);
			text = "Durante la missione hai incontrato un mercante, che con la sua immensa ed incredibile gentilezza ti lascia un dono per il tuo grande coraggio, ti ha regalato un " + itemName;
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 1) {
		var damage = Math.round(Math.random() * (exp * 3)) + 1;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione un mostro ti ha attaccato alle spalle e ti ha tolto " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 2) {
		var damage = Math.round(Math.random() * (exp * 2)) + 1;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione una trappola ti ha sorpreso e hai perso " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 3) {
		var value = Math.round(Math.random() * (exp * 5)) + 1;
		if (money - value <= 0) {
			return;
		}
		if (value <= 0) {
			value == 0;
		}
		connection.query('UPDATE player SET money = money - ' + value + ' WHERE player.id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione un ladro ti ha spintonato e rubato " + formatNumber(value) + " Â§";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 4) {
		var value = Math.round(Math.random() * (exp)) + 50;
		if (money - value <= 0) {
			value = 1;
		}
		connection.query('UPDATE player SET money = money - ' + value + ' WHERE player.id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione incontri un uomo bisognoso, decidi di donargli " + formatNumber(value) + " Â§";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 5) {
		var value = Math.round(Math.random() * (exp * 2)) + 10;
		connection.query('UPDATE player SET money = money + ' + value + ' WHERE player.id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione trovi un sacchetto pieno d'oro, ottieni cosÃ¬ " + formatNumber(value) + " Â§";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 6) {
		connection.query('SELECT life, total_life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var value = Math.round(Math.random() * (rows[0].total_life / 5)) + 10;

			connection.query('UPDATE player SET life = life + ' + value + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione ti imbatti in un piccolo villaggio e recuperi " + formatNumber(value) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 7) {
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("C", "NC") AND item.craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			addItem(player_id, rows[0].id);
			text = "Durante la missione salvi un bambino dai manigoldi del villaggio, e ricevi come ricompensa " + itemName;
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 8) {
		var value = Math.round(Math.random() * (exp / 4)) + 15;
		connection.query('UPDATE player SET life = life + ' + value + ' WHERE player.id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			text = "Durante una missione ricevi una bevanda rigenerante, grazie ad essa recuperi " + formatNumber(value) + " hp";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 9) {
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("NC","R") AND item.craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			addItem(player_id, rows[0].id);
			text = "Durante la missione trovi un piccolo scrigno che potrebbe contentere qualcosa di interessante, lo apri e trovi " + itemName;
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 10) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 10);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione trovi una scorciatoia, risparmi cosÃ¬ 10 minuti";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 11) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 10);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione ti imbatti in un bivio, tuttavia prendi la strada piÃ¹ lunga, tornerai 10 minuti piÃ¹ tardi";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 12) {
		var damage = Math.round(Math.random() * (level * 2)) + 10;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione il cielo si fa scuro e comincia a piovere, solamente che la pioggia che cade ti brucia la pelle, perdi cosÃ¬ " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 13) {

		connection.query('SELECT item.id, item.name FROM inventory, item WHERE item.id = inventory.item_id AND item.rarity IN ("C","NC","R") AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				var itemId = rows[0].id;
				var itemName = rows[0].name;
				delItem(player_id, itemId, 1);

				text = "Durante la missione ti accorgi che lo zaino Ã¨ piÃ¹ leggero, controlli ed effettivamente manca l'oggetto " + itemName + "!";
				bot.sendMessage(chat_id, text);
			} else {
				text = "Durante la missione ti accorgi che lo zaino Ã¨ piÃ¹ leggero, controlli ma non manca nulla! Era solo un impressione...";
				bot.sendMessage(chat_id, text);
			}
		});
	} else if (rand == 14) {
		var textArray = [
			'Durante la missione rischi di scivolare scalando una montagna, ma per fortuna mantieni salda la presa e non succede nulla',
			'Durante la missione un cavallo sulla collina vicina, diventa improvvisamente un orco. Fortunatamente non ti vede e non succede nulla',
			'Durante la missione osservi un uccellino che sta consumando il suo pranzo, quando ti accorgi che in realtÃ  si tratta di uno stivale, decidi di andartene e non succede nulla',
			'Durante la missione vedi uno scheletro adagiato su un angolino della strada, ma ti strofini gli occhi e ti accorgi che in realtÃ  si tratta di una paperella, ah',
			'Durante la missione inizi una missione, ma nemmeno in quella accade nulla di strano, che strano, peccato',
			'Durante la missione... no fa troppo caldo, quindi non fai nulla',
			'Durante la missione un ladro ti spintona e ti ruba lo zaino. Ah! Scherzavo.',
			'Durante la missione trovi il collo di Maurizio Costanzo che in realtÃ  non esiste quindi non succede nulla',
			'Durante la missione vedi un mercante addormentato. Decidi di derubarlo quando all\'improvviso risuona una voce che fa "E SE POI TE NE PENTI?". Allora cambi idea e continui per la tua strada'
		];
		var rand = Math.floor(Math.random() * textArray.length);
		bot.sendMessage(chat_id, textArray[rand]);
	} else if (rand == 15) {
		var damage = Math.round(Math.random() * (exp * 7)) + 40;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione scivoli da un dirupo molto alto, ti rompi un osso della gamba e perdi " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 16) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 20);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione un goblin ti nota e ti insegue con la bava alla bocca, sei costretto a deviare la strada quindi tornerai 20 minuti piÃ¹ tardi";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 17) {
		var value = Math.round(Math.random() * (exp * 3)) + 5;
		if (money - value <= 0) {
			value = money;
		}
		connection.query('UPDATE player SET money = money - ' + value + ' WHERE player.id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione ti distrai in un casinÃ², ma sfortunatamente non sei un buon giocatore cosÃ¬ perdi " + formatNumber(value) + " Â§";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 18) {
		var value = Math.round(Math.random() * (exp * 3)) + 5;
		connection.query('UPDATE player SET money = money + ' + value + ' WHERE player.id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione ti distrai in un casinÃ², sei un gran giocatore! Vinci cosÃ¬ " + formatNumber(value) + " Â§";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 19) {
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.rarity IN ("C","NC","R") AND item.craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			itemName2 = rows[1].name;
			itemName3 = rows[2].name;

			text = "Durante la missione noti un mercante qualche metro davanti a te, ad un certo punto perÃ² il suo sacco pieno si rompe, raccogli gli oggetti e trovi " + itemName + ", " + itemName2 + " e " + itemName3;
			bot.sendMessage(chat_id, text);

			addItem(player_id, rows[0].id);
			addItem(player_id, rows[1].id);
			addItem(player_id, rows[2].id);
		});
	} else if (rand == 20) {
		var damage = Math.round(Math.random() * (exp * 2)) + 40;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione trovi uno scrigno pieno di monete d'oro sul ciglio della strada, solo che dopo un attimo ti accorgi che si tratta di cioccolata, preso dalla disperazione divori il contenuto dello scrigno e perdi " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 21) {
		var itemId = Math.round(Math.random() * 5 + 68);
		connection.query('SELECT item.id, item.name, item.rarity FROM `item` WHERE item.id = ' + itemId + ' AND item.craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			addItem(player_id, rows[0].id);
			text = "Durante la missione senti qualcosa toccarti un piede, abbassi lo sguardo e vedi una pietra strana, ricevi " + itemName + "!";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 22) {
		var damage = Math.round(Math.random() * (exp / 2)) + 20;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione uno stregone ti coglie di sorpresa e ti ruba " + formatNumber(damage) + " hp, che poi andrÃ  a donare alla congrega dei maghi oscuri";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 23) {
		var damage = Math.round(Math.random() * (exp / 2));
		connection.query('SELECT * FROM player WHERE craft_count > 20 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			var nick = rows[0].nickname;
			var chat_id2 = rows[0].chat_id;
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione trovi un arco e una freccia per terra, decidi di scoccarla verso il cielo in segno vittorioso ma senza volerlo colpisci un passante di nome <b>" + nick + "</b>, che perde " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text, html);
				var text2 = "Vedi una freccia in lontananza avvicinarsi a te a gran velocitÃ , ti si conficca nel ginocchio e purtroppo perdi " + formatNumber(damage) + " hp!";
				bot.sendMessage(chat_id2, text2);
			});
		});
	} else if (rand == 24) {
		var money = Math.round(Math.random() * (exp)) + 20;
		connection.query('SELECT chat_id, nickname FROM player WHERE exp > 30 AND money >= ' + money + ' ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;

			var chat_id2 = rows[0].chat_id;

			text = "Durante la missione vedi qualcuno con la testa china sul cellulare, con la coda dell'occhio noti che sta giocando ad uno strano bot, leggi il suo nickname e scopri che si chiama " + rows[0].nickname + ", per fargli uno scherzo gli fai uno sgambetto e gli fai cliccare a caso, cosÃ¬ perde " + formatNumber(money) + " Â§";
			var text2 = "Un passante per la strada ti fa uno sgambetto e cliccando a caso sul cellulare perdi " + formatNumber(money) + " Â§!";
			bot.sendMessage(chat_id, text);
			bot.sendMessage(chat_id2, text2);

			connection.query('UPDATE player SET money = money - ' + money + ' WHERE nickname="' + rows[0].nickname + '"', function (err, rows, fields) {
				if (err) throw err;
			});
		});
	} else if (rand == 25) {
		var money = Math.round(Math.random() * (exp)) + 50;
		connection.query('UPDATE player SET money = money + ' + money + ' WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});

		text = "Durante la missione trovi una leva nascosta dentro un albero cavo. Curioso la tiri, ma non succede niente. In realtÃ  la leva ha fatto cadere un sacchettino pieno di qualcosa, ottieni " + formatNumber(money) + " Â§!";
		bot.sendMessage(chat_id, text);
	} else if (rand == 26) {
		var damage = Math.round(Math.random() * (exp * 2)) + 20;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione trovi un pulsante a forma di papera e inizi a premerlo a ripetizione. Dopo giusto alcuni secondi ti accorgi che il pulsante ti toglie hp ogni volta che lo tocchi, infatti hai perso " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 27) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 15);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione finisci nel mezzo di un uragano. Sollevato e lanciato lontano, quando ti riprendi scopri di essere tornato al luogo di partenza. Corri per recuperare il tempo perso, ma aumenti il tempo missione di 15 minuti";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 28) {
		var damage = Math.round(Math.random() * (exp * 2)) + 20;
		if (boss_id > 0) {
			connection.query('UPDATE boss_team SET life = life - ' + damage + ' WHERE id = ' + boss_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione vedi sfrecciare sopra di te una figura rossa. Ti distrai non tanto per la figura, ma per il fatto che sembra aver perso una nocciolina che precipitando ti urta la fronte attirando la tua attenzione. Un po'per vendetta un po' per fame mangi la nocciolina con tutto il guscio e scopri con sommo piacere che era una super arachide di super Pippo. Ti precipiti contro il boss che stai sfidando, che perde immediatamente " + damage + " hp con un megapugno!";
				bot.sendMessage(chat_id, text);
			});
		};
	} else if (rand == 29) {
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			connection.query('UPDATE player SET life = life - (life/10) WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione incontri tutti i boss riuniti assieme. Ti fissano, tu li fissi. Loro ti colpiscono violentemente e ti lasciano a terra nel fango";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 30) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 15);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione senti che qualcuno ti sta seguendo. Inizi a girare la zona per seminarlo, ma dopo esserti accorto che si tratta della tua ombra scopri di aver corso nella direzione giusta, risparmiandoti 15 minuti di viaggio";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 31) {
		var damage = Math.round(Math.random() * (exp * 3)) + 100;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione ti distrai giocando a Loot Bot sul cellulare e sbatti violentemente contro un muro, perdendo " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 32) {
		connection.query('SELECT item.id, item.name FROM inventory, item WHERE item.id = inventory.item_id AND item.rarity IN ("NC","R") AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				var itemId = rows[0].id;
				var itemName = rows[0].name;
				delItem(player_id, itemId, 1);
				text = "Durante la missione incontri un uomo seduto sul marciapiede, decidi cosÃ¬ di derubarlo. Si scopre perÃ² che quell'uomo Ã¨ LastSoldier95. Lui ti guarda, apparentemente non succede nulla. Ma quando controlli nello zaino, noti che manca " + itemName + "!";
				bot.sendMessage(chat_id, text);
			} else {
				text = "Durante la missione incontri un uomo seduto sul marciapiede, decidi cosÃ¬ di derubarlo. Si scopre perÃ² che quell'uomo Ã¨ LastSoldier95. Lui ti guarda, non succede nulla. Oggi Ã¨ magnanimo.";
				bot.sendMessage(chat_id, text);
			}
		});
	} else if (rand == 33) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 60);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			connection.query('SELECT name, id FROM chest WHERE id IN (1,2) ORDER BY RAND()', function (err, rows, fields) {
				if (err) throw err;
				var chestName = rows[0].name;
				var chestId = rows[0].id;
				addChest(player_id, chestId);
				text = "Durante la missione decidi di intraprendere un'altra missione. Impiegherai un ora in piÃ¹ per tornare, ma ricevi " + chestName;
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 34) {
		var damage = Math.round(Math.random() * (exp / 5)) + 10;
		connection.query('SELECT nickname FROM player WHERE exp > 30 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			text = "Durante la missione incontri " + rows[0].nickname + " e vi salutate. Entrambi recuperate " + formatNumber(damage) + " hp (d'altronde Ã¨ salutare).";
			bot.sendMessage(chat_id, text);

			connection.query('UPDATE player SET life = life + ' + damage + ' WHERE nickname="' + rows[0].nickname + '"', function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE player SET life = life + ' + damage + ' WHERE nickname="' + element.nickname + '"', function (err, rows, fields) {
				if (err) throw err;
			});
		});
	} else if (rand == 35) {
		var damage = Math.round(Math.random() * (exp / 2)) + 1;
		connection.query('SELECT life FROM player WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
			if (rows[0].life - damage <= 0) {
				return;
			}
			connection.query('UPDATE player SET life = life - ' + damage + ' WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
				text = "Durante la missione incontri Jovanotti che ti lancia un faffo. Perdi " + formatNumber(damage) + " hp";
				bot.sendMessage(chat_id, text);
			});
		});
	} else if (rand == 36) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 60);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione cadi in un portale spazio temporale a forma di papera. Impiegherai un ora in meno per tornare.";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 37) {
		connection.query('SELECT item.id, item.name, item.rarity FROM item WHERE item.rarity = "R" AND item.craftable = 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			itemName = rows[0].name;
			addItem(player_id, rows[0].id);
			text = "Durante la missione entri erroneamente nell'ufficio di fenix45. Prima di andartene perÃ², vai al suo computer personale e modifichi i dati del tuo pg aggiungendo 10.000 Â§ e " + itemName;
			bot.sendMessage(chat_id, text);

			connection.query('UPDATE player SET money = money + 10000 WHERE player.id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		});
	} else if (rand == 38) {
		connection.query('SELECT mission_time_end FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() + 30);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET life = life + (life/20), mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			text = "Durante la missione incontri tua nonna che ti invita a fare uno spuntino. Impieghi 30 minuti in piÃ¹ per tornare, ma recuperi un po' di salute.";
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 39) {
		connection.query('UPDATE player SET mission_id = 0, mission_time_end = null WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});
		text = "Durante una missione dimentichi di essere in missione e torni nel tuo rifugio senza ricompense.";
		bot.sendMessage(chat_id, text);
	} else if (rand == 40) {
		connection.query('SELECT name, id FROM chest WHERE id < 5 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			text = "Durante una missione pesti per sbaglio un sasso che in realtÃ  era una leva nascosta! Si apre una fenditura nel muro e trovi uno " + rows[0].name + "!";
			bot.sendMessage(chat_id, text);

			addChest(player_id, rows[0].id);
		});
	} else if (rand == 41) {
		connection.query('SELECT life, total_life FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			if (rows[0].life < rows[0].total_life) {
				text = "Durante una missione incontri una fata graziosissima, diventate cosÃ¬ amici che decide di ricaricarti la vita al massimo!";
				bot.sendMessage(chat_id, text);

				connection.query('UPDATE player SET life = total_life WHERE player.id=' + player_id, function (err, rows, fields) {
					if (err) throw err;
				});
			};
		});
	} else if (rand == 42) {
		connection.query('SELECT mission_time_end, money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var time_end = new Date(rows[0].mission_time_end);
			time_end.setMinutes(time_end.getMinutes() - 20);

			var long_date = time_end.getFullYear() + "-" + addZero(time_end.getMonth() + 1) + "-" + addZero(time_end.getDate()) + " " + addZero(time_end.getHours()) + ':' + addZero(time_end.getMinutes()) + ':' + addZero(time_end.getSeconds());
			connection.query('UPDATE player SET mission_time_end = "' + long_date + '" WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});

			if (rows[0].money > 250) {
				text = "Durante una missione incontri un motociclista spericolato che ti dÃ  un passaggio, risparmi cosÃ¬ 20 minuti di missione, ma per ringraziarlo gli dai 250 Â§";
				connection.query('UPDATE player SET money = money-250 WHERE id=' + player_id, function (err, rows, fields) {
					if (err) throw err;
				});
			} else {
				text = "Durante una missione incontri un motociclista spericolato che ti dÃ  un passaggio, risparmi cosÃ¬ 20 minuti di missione, per stavolta lo fa gratuitamente";
			}
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 43) {
		connection.query('SELECT item.name, item.id FROM inventory, item WHERE item.id = inventory.item_id AND item.rarity = "NC" AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
			if (err) throw err;
			var money = 500;
			var itemName = rows[0].name;
			if (Object.keys(rows).length > 0) {
				text = "Durante una missione, all'improvviso irrompe un fulmine, accecandoti. Ti accorgi in realtÃ  che il fulmine nient'altro era il boss di un villaggio vicino, che rubava ai sudditi e per non farsi riconoscere si era lanciato su se stesso un incantesimo che lo rendeva veloce come un fulmine. Quest'ultimo ti ha preso dallo zaino " + itemName + " ma al suo posto ti ha lasciato " + formatNumber(money) + " Â§.";
				delItem(player_id, rows[0].id, 1);
			} else {
				money = 300;
				text = "Durante una missione, all'improvviso irrompe un fulmine, accecandoti. Ti accorgi in realtÃ  che il fulmine nient'altro era il boss di un villaggio vicino, che rubava ai sudditi e per non farsi riconoscere si era lanciato su se stesso un incantesimo che lo rendeva veloce come un fulmine. Quest'ultimo non ti ha preso nulla dallo zaino, e ti ha lasciato " + formatNumber(money) + " Â§.";
			}
			connection.query('UPDATE player SET money = money+' + money + ' WHERE id=' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
			bot.sendMessage(chat_id, text);
		});
	} else if (rand == 44) {
		addItem(player_id, 73);
		text = "Durante la missione incontri il grande mastro domatore di draghi Fuligah. Dopo una breve chiaccherata ti lascia in dono una Pietra Spirito Epico!";
		bot.sendMessage(chat_id, text);
	} else if (rand == 45) {
		connection.query('UPDATE player SET life = life - (life/3) WHERE id=' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});

		text = "Durante la missione incontri l'immenso drago di LastSoldier95 intento a consumare il suo pasto quotidiano. Dato che non vuoi diventare parte del banchetto, pian pianino torni indietro senza fare il minimo rumore e senza farti vedere. Ma quando pensi di essere scappato, il drago ti starnutisce addosso e perdi 1/3 della tua salute.";
		bot.sendMessage(chat_id, text);
	} else if (rand == 46) {
		var rand = Math.random() * 100;
		var text2 = "";
		if (rand > 50) {
			text2 = "per la profonda disperazione ti distrai, inciampi e perdi il 2% delle monete";
			connection.query('UPDATE player SET money = money - ((money/100)*2) WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		} else {
			connection.query('UPDATE player SET money = money + ((money/100)*5) WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
			text2 = "tuttavia ci riprensa e si rende conto che in effetti, non fosse poi cosÃ¬ male, allora si congratula con te e ti regala il 5% delle monete in piÃ¹!"
		}

		text = "Durante la missione ti viene l'ispirazione poetica e decidi di scrivere una poesia avventurosa, ma appena finisci di scriverla non essendo un bravo scrittore dietro di te appare Lara997 e te la strappa perchÃ¨ scritta male, " + text2;
		bot.sendMessage(chat_id, text);
	} else if (rand == 47) {
		connection.query('SELECT money FROM player WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			var money = rows[0].money;

			if (money < 1000) {		
				connection.query('SELECT item.id, item.name FROM item, inventory WHERE item.rarity = "R" AND item.id = inventory.player_id AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length == 0) {
						return;
					}
					var itemName = rows[0].name;
					var itemId = rows[0].id;
					text = "Durante la missione vedi una insegna che recita L'EMPORIO e decidi di entrare a dare un'occhiata. Il simpatico proprietario ekvas ti ubriaca di chiacchiere sull'andamento del mercato e dei prezzi. Esci con una Colla ma ti accorgi di esser stato convinto a scambiarla con " + itemName + "...";
					bot.sendMessage(chat_id, text);

					delItem(player_id, item_id, 1);
				});
			} else {
				var lost = Math.round(money / 100) * 5;
				text = "Durante la missione vedi una insegna che recita L'EMPORIO e decidi di entrare a dare un'occhiata. Il simpatico proprietario ekvas ti ubriaca di chiacchiere sull'andamento del mercato e dei prezzi. Esci con una Colla ma ti accorgi di esser stato convinto a pagarla " + formatNumber(lost) + " Â§...";
				addItem(player_id, 3);

				bot.sendMessage(chat_id, text);
				connection.query('UPDATE player SET money = money - ' + lost + ' WHERE id=' + player_id, function (err, rows, fields) {
					if (err) throw err;
				});
			}
		});
	} else if (rand == 48) {
		addChest(player_id, 6);

		text = "Durante la missione senti scorrere la follia dentro di te, al punto che senti l'anima esplodere e mostrare tutto il suo spirito d'avventura. Intraprendi una missione alla velocitÃ  della luce e questa missione ti fornisce uno Scrigno Epico!";
		bot.sendMessage(chat_id, text);
	} else if (rand == 49) {
		setExp(player_id, 15);
		text = "Durante la missione incontri un folle barcollante sul ciglio della strada, avvicinandoti scopri che si tratta di un elfo delle Lande Immaginarie, una razza ormai estinta, notandolo in fin di vita gli vai a comprare alcune pozioni, e lui ricambia donandoti 15 exp con un incantesimo";
		bot.sendMessage(chat_id, text);
	} else if (rand == 50) {	
		connection.query('SELECT item.id, item.name FROM inventory, item WHERE inventory.item_id = item.id AND item.rarity = "L" AND inventory.player_id = ' + player_id + ' AND inventory.quantity > 0 ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length == 0) {
				text = "Durante la missione ti rechi all'Emporio della Follia, deciso ad acquistare qualche strano intruglio, ma stavolta arrivi troppo tardi, Ã¨ chiuso.";
				bot.sendMessage(chat_id, text);
				return;
			}
			var item1 = rows[0].name;
			var item1_id = rows[0].id;
			connection.query('SELECT item.id, item.name FROM item WHERE item.rarity = "L" ORDER BY RAND()', function (err, rows, fields) {
				if (err) throw err;
				var item2 = rows[0].name;
				var item2_id = rows[0].id;

				addItem(player_id, item2_id);
				delItem(player_id, item1_id, 1);

				text = "Durante la missione ti rechi all'Emporio della Follia, incuriosito dai prodotti acquisti la Polvere Inverter, da applicare su un oggetto nello zaino ne cambia l'aspetto. Incuriosito procedi subito seguendo le istruzioni e il tuo oggetto " + item1 + " si trasforma in un " + item2 + "!";
				bot.sendMessage(chat_id, text);
			});
		});
	}

	connection.query('UPDATE player SET event = 1 WHERE player.id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
	});
};

function refreshHeists() {
	connection.query('UPDATE player SET heist_count = 0, heist_limit = 0, capsule_limit = 0, spy_count = 0', function (err, rows, fields) {
		if (err) throw err;
	});
};

function checkAct() {
	connection.query('SELECT P.nickname, P.id As player_id, P.chat_id, CAST(L.time As date) As last_action, CURDATE(), DATEDIFF(CURDATE(), CAST(L.time As date)) As last_access FROM player P INNER JOIN last_command L ON P.account_id = L.account_id WHERE P.holiday != 1 HAVING last_access > 60 LIMIT 20', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 giocatore espulso\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " giocatori espulsi\x1b[0m");
			}
			rows.forEach(setFinishedAct);
		}
	});
};

function setFinishedAct(element, index, array) {
	var player_id = element.player_id;
	var nickname = element.nickname;
	var chat_id = element.chat_id;
	var last_access = element.last_access;

	console.log(">> " + player_id + " - " + nickname + " inattivo da " + last_access + " giorni");

	var now = new Date();
	now.setDate(now.getDate() + 14);
	var long_date = now.getFullYear() + "-" + addZero(now.getMonth() + 1) + "-" + addZero(now.getDate()) + " " + addZero(now.getHours()) + ':' + addZero(now.getMinutes()) + ':' + addZero(now.getSeconds());

	var now2 = new Date();
	now2.setDate(now2.getDate() + 365);
	var long_date2 = now2.getFullYear() + "-" + addZero(now2.getMonth() + 1) + "-" + addZero(now2.getDate()) + " " + addZero(now2.getHours()) + ':' + addZero(now2.getMinutes()) + ':' + addZero(now2.getSeconds());

	connection.query('INSERT INTO holiday (player_id, time_end) VALUES (' + player_id + ',"' + long_date + '")', function (err, rows, fields) {
		if (err) throw err;
		connection.query('UPDATE player SET holiday = 1, heist_protection = "' + long_date2 + '" WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Per inattivitÃ  Ã¨ stata attivata automaticamente la modalitÃ  vacanza!");
		});
	});
}

function checkTeamAct() {
	connection.query('SELECT P.nickname, P.chat_id, T.team_id, T.player_id, CAST(L.time As date) As last_action, CURDATE(), DATEDIFF(CURDATE(), CAST(L.time As date)) As last_access FROM player P INNER JOIN team_player T ON P.id = T.player_id INNER JOIN last_command L ON P.account_id = L.account_id WHERE P.holiday != 1 HAVING last_access > 14 LIMIT 20', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 giocatore espulso\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " giocatori espulsi\x1b[0m");
			}
			rows.forEach(setFinishedTeamAct);
		}
	});
};

function setFinishedTeamAct(element, index, array) {
	var player_id = element.player_id;
	var nickname = element.nickname;
	var chat_id = element.chat_id;
	var team_id = element.team_id;

	//console.log(">> " + player_id + " - " + nickname + " in espulsione");

	connection.query('DELETE FROM team_player WHERE player_id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "Sei stato espulso dal team per inattivitÃ ");
		connection.query('SELECT P.chat_id FROM player P, team_player T WHERE T.player_id = P.id AND T.team_id = ' + team_id + ' AND T.role = 1', function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(rows[0].chat_id, nickname + " Ã¨ stato espulso dal team per inattivitÃ ");
		});
	});
};

function checkHeists() {
	connection.query('SELECT heist.id FROM `player`, heist WHERE player.id = heist.from_id AND heist.datetime < NOW() AND heist.datetime IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 ispezione terminata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " ispezioni terminate\x1b[0m");
			}
			rows.forEach(setFinishedHeist);
		}
	});
};

function checkHeistsProgress() {
	connection.query('SELECT player.id, chat_id, changeComb, my_combination, to_id, nickname FROM player, heist_progress WHERE player.id = heist_progress.from_id AND heist_progress.wait_time < NOW() AND heist_progress.wait_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 ispezione progressiva terminata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " ispezioni progressive terminate\x1b[0m");
			}
			rows.forEach(setFinishedHeistProgress);
		}
	});
};

function checkDust() {
	connection.query('SELECT player.nickname, event_dust_status.qnt, event_dust_status.generated, player.chat_id, event_dust_status.max_qnt, event_dust_status.id, player.id As player_id FROM event_dust_status, player WHERE player.id = event_dust_status.player_id AND extracting = 1 AND last_update < DATE_SUB(NOW(), INTERVAL 1 HOUR) AND notified = 0', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			rows.forEach(setDust);
		}
	});
};

function setDust(element, index, array) {
	var id = element.id;
	var player_id = element.player_id;
	var nick = element.nickname;
	var chat_id = element.chat_id;
	var max_qnt = element.max_qnt;
	var qnt = element.qnt;
	var generated = element.generated;

	connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 14', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			qnt += parseInt(rows[0].ability_level);
		}

		if (generated + qnt >= max_qnt) {
			bot.sendMessage(chat_id, "Il generatore Ã¨ pieno! Svuotalo per produrre altra polvere!");
			connection.query('UPDATE event_dust_status SET notified = 1 WHERE id = ' + id, function (err, rows, fields) {
				if (err) throw err;
			});
		}
		if (generated < max_qnt) {
			var d = new Date();
			var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
			if (generated + qnt > max_qnt)
				qnt = max_qnt - generated;
			connection.query('UPDATE event_dust_status SET `generated` = `generated`+' + qnt + ', last_update = "' + long_date + '" WHERE id = ' + id, function (err, rows, fields) {
				if (err) throw err;
			});
		}
	});
};

function checkMissions() {
	connection.query('SELECT nickname, id, mission_id, chat_id, charm_id, class, global_end, mission_auto_id, boost_id, boost_mission, reborn, exp, mission_gem, mission_count, global_end FROM player WHERE mission_time_end < NOW() AND mission_time_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 missione terminata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " missioni terminate\x1b[0m");
			}
			rows.forEach(setFinishedMission);
		}
	});
};

function checkTeamMissions() {
	connection.query('SELECT party_id, assigned_to, part_id, team_id, report_id FROM mission_team_party T WHERE T.mission_time_end < NOW() AND T.mission_time_end IS NOT NULL AND wait = 0', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 missione team terminata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " missioni team terminate\x1b[0m");
			}
			rows.forEach(setFinishedTeamMission);
		}
	});
};

function setFinishedTeamMission(element, index, array) {
	var party_id = element.party_id;
	var assigned_to = element.assigned_to;
	var part_id = element.part_id;
	var team_id = element.team_id;
	var report_id = element.report_id;

	var new_part_id = (part_id+1);

	connection.query('SELECT question, answ1, answ2, answ3 FROM mission_team_list_part WHERE list_id = ' + assigned_to + ' AND part_id = ' + new_part_id, function (err, rows, fields) {
		if (err) throw err;

		if ((Object.keys(rows).length == 0) && (new_part_id > 1)){
			connection.query('SELECT pnt, text FROM mission_team_report WHERE report_id = ' + report_id, function (err, rows, fields) {
				if (err) throw err;

				var endText = "";
				var rewardText = "";
				var totPnt = 0;
				for (i = 0; i < Object.keys(rows).length; i++) {
					endText += rows[i].text;
					totPnt += rows[i].pnt;
				}

				connection.query('SELECT parts FROM mission_team_list WHERE id = ' + assigned_to, function (err, rows, fields) {
					if (err) throw err;

					var parts = rows[0].parts;

					connection.query('SELECT AVG(complex) As diff, reward_code, duration, parts FROM mission_team_list L, mission_team_requirement R WHERE L.requirement_id = R.requirement_id AND L.id = ' + assigned_to, function (err, rows, fields) {
						if (err) throw err;

						var complex = rows[0].diff;
						var rewardLevel = Math.ceil((totPnt/parts)/(3.5-complex/4))*Math.round(Math.log2(parts)+1)*2;
						var rewardQuery = "";
						var rewardStr = rows[0].reward_code.split(":");

						var paPnt = 1;
						var expPnt = Math.floor((rows[0].duration*(rows[0].parts+1))/60/60);
						var qnt = rewardLevel*rewardStr[0];
						rewardText += "\n> " + paPnt + " ðŸ¦‹ (team)";
						rewardText += "\n> " + expPnt + " exp (a testa)";
						var isExp = 0;
						var isItem = 0;
						var isChest = 0;

						// la query viene eseguita qnt volte

						if (rewardStr[1].indexOf("item") != -1){
							var itemid = rewardStr[1].match(/\d+/g)[0];
							var item = connection_sync.query("SELECT name, rarity FROM item WHERE id = " + itemid);
							rewardText += "\n> " + qnt + "x " + item[0].name + " (" + item[0].rarity + ") (a testa)";
							isItem = 1;
						}else if (rewardStr[1] == "mana1"){
							rewardText += "\n> " + qnt + "x Mana Blu (a testa)";
							rewardQuery = "UPDATE event_mana_status M, player P SET M.mana_1 = M.mana_1+1 WHERE M.player_id = P.id AND P.id = %playerid%";
						}else if (rewardStr[1] == "mana2"){
							rewardText += "\n> " + qnt + "x Mana Giallo (a testa)";
							rewardQuery = "UPDATE event_mana_status M, player P SET M.mana_2 = M.mana_2+1 WHERE M.player_id = P.id AND P.id = %playerid%";
						}else if (rewardStr[1] == "mana3"){
							rewardText += "\n> " + qnt + "x Mana Rosso (a testa)";
							rewardQuery = "UPDATE event_mana_status M, player P SET M.mana_3 = M.mana_3+1 WHERE M.player_id = P.id AND P.id = %playerid%";
						}else if (rewardStr[1] == "mana"){
							rewardText += "\n> " + qnt + "x Mana tutti i tipi (a testa)";
							rewardQuery = "UPDATE event_mana_status M, player P SET M.mana_1 = M.mana_1+1, M.mana_2 = M.mana_2+1, M.mana_3 = M.mana_3+1 WHERE M.player_id = P.id AND P.id = %playerid%";
						}else if (rewardStr[1] == "exp"){
							rewardText += "\n> " + qnt + " exp (a testa)";
							rewardQuery = "";
							isExp = 1;
						}else if (rewardStr[1].indexOf("chest") != -1){
							var chestid = rewardStr[1].match(/\d+/g)[0];
							var chest = connection_sync.query("SELECT name, rarity_shortname FROM chest WHERE id = " + chestid);
							rewardText += "\n> " + qnt + "x " + chest[0].name + " (" + chest[0].rarity_shortname + ") (a testa)";
							isChest = 1;
						}else if (rewardStr[1] == "money"){
							rewardText += "\n> " + formatNumber(qnt*1000) + " Â§ (a testa)";
							rewardQuery = "UPDATE player SET money = money+1000 WHERE id = %playerid%";
						}else{
							console.log("Errore premi");
							return;
						}

						console.log("Reward incarico: " + rewardStr + " - " + qnt)

						connection.query('SELECT P.chat_id, T.team_id, P.id, TP.suspended FROM mission_team_party_player T, player P, team_player TP WHERE TP.player_id = P.id AND T.player_id = P.id AND T.party_id = ' + party_id + ' AND T.team_id = ' + team_id, function (err, rows, fields) {
							if (err) throw err;
							for (i = 0; i < Object.keys(rows).length; i++) {
								if (rows[i].suspended == 0){
									bot.sendMessage(rows[i].chat_id, "Hai completato l'incarico insieme al tuo party!\nEcco il rapporto dell'incarico:\n<i>" + endText + "</i>\n\nL'ufficio incarichi vi premia con: " + rewardText, html);

									for (j = 0; j < qnt; j++) {
										if (isExp == 1){
											setExp(rows[i].id, 1);
										}else if (isItem == 1){
											addItem(rows[i].id, itemid);
										}else if (isChest == 1){
											addChest(rows[i].id, chestid);
										}else{
											connection.query(rewardQuery.replace("%playerid%", rows[i].id), function (err, rows, fields) {
												if (err) throw err;
											});
										}
									};
									setAchievement(rows[i].chat_id, rows[i].id, 22, 1);

									setExp(rows[i].id, expPnt); // exp a tutti
								}else{
									bot.sendMessage(rows[i].chat_id, "Hai completato l'incarico insieme al tuo party!\nEcco il rapporto:\n<i>" + endText + "</i>\n\nNon ricevi ricompense poichÃ¨ sei stato sospeso dall'amministratore", html);
								}
								connection.query('UPDATE player SET mission_party = 0, mission_team_count = mission_team_count+1 WHERE id = ' + rows[i].id, function (err, rows, fields) {
									if (err) throw err;
								});
							}

							connection.query('SELECT player.chat_id, player.id FROM team_player, player WHERE team_player.player_id = player.id AND team_player.role IN (1,2) AND team_id = ' + team_id, function (err, rows, fields) {
								if (err) throw err;
								for (i = 0; i < Object.keys(rows).length; i++) {		// In caso di piÃ¹ admin
									bot.sendMessage(rows[i].chat_id, "Il Party " + party_id + " ha completato l'incarico assegnato!");
								}

								connection.query('UPDATE team SET mission_count = mission_count+1, mission_count_diff = mission_count_diff+' + complex + ', point = point+' + paPnt + ' WHERE id = ' + team_id, function (err, rows, fields) {
									if (err) throw err;
								});

								// Pulizia (aggiorna anche l'altra)
								connection.query('UPDATE mission_team_party SET part_id = 0, assigned_to = NULL, report_id = NULL, mission_start = NULL, mission_time_end = NULL, wait = 0, mission_time_limit = NULL WHERE team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
									if (err) throw err;
								});
								connection.query('UPDATE mission_team_party_player SET answ_id = 0 WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
									if (err) throw err;
								});
								/*	// Mantenere per log?
								connection.query('DELETE FROM mission_team_report WHERE team_id = ' + team_id + ' AND party_id = ' + party_id + ' AND report_id = ' + report_id, function (err, rows, fields) {
									if (err) throw err;
								});
								*/
							});
						});
					});
				});
			});
			return;
		}

		var question = rows[0].question;
		var answ1 = rows[0].answ1;
		var answ2 = rows[0].answ2;
		var answ3 = rows[0].answ3;

		connection.query('SELECT text FROM mission_team_report WHERE report_id = ' + report_id + ' ORDER BY id DESC', function (err, rows, fields) {
			if (err) throw err;

			var last_answer = "";
			if (Object.keys(rows).length > 0){
				last_answer = capitalizeFirstLetter(rows[0].text);
			}

			connection.query('UPDATE mission_team_party_player SET answ_id = 0 WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
				connection.query('UPDATE mission_team_party SET part_id = ' + new_part_id + ', wait = 1 WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
					if (err) throw err;
					connection.query('SELECT P.chat_id, P.nickname FROM mission_team_party_player T, player P WHERE T.player_id = P.id AND T.party_id = ' + party_id + ' AND T.team_id = ' + team_id + ' ORDER BY RAND()', function (err, rows, fields) {
						if (err) throw err;

						if (Object.keys(rows).length == 0){
							console.log("Party senza membri: " + party_id + " del team " + team_id);
							return;
						}

						var iKeys = [];
						iKeys.push([{
							text: answ1,
							callback_data: "team_miss:1:" + new_part_id
						}]);
						iKeys.push([{
							text: answ2,
							callback_data: "team_miss:2:" + new_part_id
						}]);
						iKeys.push([{
							text: answ3,
							callback_data: "team_miss:3:" + new_part_id
						}]);

						// order by rand per %casuale%
						question = question.replace("%casuale%", rows[0].nickname);

						for (i = 0; i < Object.keys(rows).length; i++) {
							bot.sendMessage(rows[i].chat_id, "<b>Incarico in corso</b>\n\n" + last_answer + question + "\n", {parse_mode: 'HTML', reply_markup: {inline_keyboard: iKeys}});
						}
					});
				});
			});
		});
	});
};

bot.onText(/^\/incarico/, function (message, match) {

	if (!checkSpam(message)) {
		return;
	}

	connection.query('SELECT team_id, party_id, answ_id FROM mission_team_party_player WHERE player_id = (SELECT id FROM player WHERE nickname = "' + message.from.username + '")', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length == 0){
			bot.sendMessage(message.chat.id, "Non sei in team o in un party", back);
			return;
		}

		var party_id = rows[0].party_id;
		var team_id = rows[0].team_id;

		if (rows[0].answ_id > 0){
			bot.sendMessage(message.chat.id, "Hai giÃ  votato per questa parte di incarico", back);
			return;
		}

		connection.query('SELECT party_id, assigned_to, part_id, team_id, report_id FROM mission_team_party T WHERE T.party_id = ' + party_id + ' AND T.team_id = ' + team_id + ' AND wait = 1', function (err, rows, fields) {
			if (err) throw err;

			if (Object.keys(rows).length == 0){
				bot.sendMessage(message.chat.id, "Nessun incarico valido da richiamare", back);
				return;
			}

			var assigned_to = rows[0].assigned_to;
			var part_id = rows[0].part_id;
			var report_id = rows[0].report_id;

			//console.log("Richiamo manuale incarico per party " + party_id + " e team " + team_id);

			connection.query('SELECT question, answ1, answ2, answ3 FROM mission_team_list_part WHERE list_id = ' + assigned_to + ' AND part_id = ' + part_id, function (err, rows, fields) {
				if (err) throw err;

				var question = rows[0].question;
				var answ1 = rows[0].answ1;
				var answ2 = rows[0].answ2;
				var answ3 = rows[0].answ3;

				connection.query('SELECT text FROM mission_team_report WHERE report_id = ' + report_id + ' ORDER BY id DESC', function (err, rows, fields) {
					if (err) throw err;

					var last_answer = "";
					if (Object.keys(rows).length > 0){
						last_answer = capitalizeFirstLetter(rows[0].text);
					}

					var iKeys = [];
					iKeys.push([{
						text: answ1,
						callback_data: "team_miss:1:" + part_id
					}]);
					iKeys.push([{
						text: answ2,
						callback_data: "team_miss:2:" + part_id
					}]);
					iKeys.push([{
						text: answ3,
						callback_data: "team_miss:3:" + part_id
					}]);

					question = question.replace("%casuale%", "qualcuno");

					bot.sendMessage(message.chat.id, "<b>Incarico in corso</b>\n\n" + last_answer + question + "\n", {parse_mode: 'HTML', reply_markup: {inline_keyboard: iKeys}});
				});
			});
		});
	});
});

function capitalizeFirstLetter(string) {
	return string.charAt(0).toUpperCase() + string.slice(1);
}

function checkSpecialMissions() {
	connection.query('SELECT nickname, id, mission_special_id, chat_id FROM `player` WHERE mission_special_time_end < NOW() AND mission_special_time_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 itinerario terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " itinerari terminati\x1b[0m");
			}
			rows.forEach(setFinishedSpecialMission);
		}
	});
};

function checkEnchant() {
	connection.query('SELECT id, chat_id FROM `player` WHERE weapon_enchant_end < NOW() AND weapon_enchant_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 incantamento arma terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " incantamento terminato\x1b[0m");
			}
			rows.forEach(setFinishedEnchant1);
		}
	});
};

function checkEnchant2() {
	connection.query('SELECT id, chat_id FROM `player` WHERE weapon2_enchant_end < NOW() AND weapon2_enchant_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 incantamento armatura terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " incantamento terminato\x1b[0m");
			}
			rows.forEach(setFinishedEnchant2);
		}
	});
};

function checkEnchant3() {
	connection.query('SELECT id, chat_id FROM `player` WHERE weapon3_enchant_end < NOW() AND weapon3_enchant_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 incantamento scudo terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " incantamento terminato\x1b[0m");
			}
			rows.forEach(setFinishedEnchant3);
		}
	});
};

function setFinishedEnchant1(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET weapon_enchant_end = NULL, weapon_enchant = 0, weapon_enchant_bonus = 0 WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "L'incantamento dell'arma Ã¨ terminato");
	});
};

function setFinishedEnchant2(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET weapon2_enchant_end = NULL, weapon2_enchant = 0, weapon2_enchant_bonus = 0 WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "L'incantamento dell'armatura Ã¨ terminato");
	});
};

function setFinishedEnchant3(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET weapon3_enchant_end = NULL, weapon3_enchant = 0, weapon3_enchant_bonus = 0 WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "L'incantamento dello scudo Ã¨ terminato");
	});
};

function checkDragonArena() {
	connection.query('SELECT player_id, chat_id FROM player, event_arena_status WHERE event_arena_status.player_id = player.id AND fight_time < NOW() AND fight_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 scontro drago terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " draghi terminati\x1b[0m");
			}
			rows.forEach(setFinishedArena);
		}
	});
};

function checkMerchant() {
	connection.query('SELECT M.player_id, P.chat_id, M.day_cnt FROM player P, merchant_offer M WHERE P.id = M.player_id AND M.time_end < NOW() AND M.time_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 contrabbandiere terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " contrabbandieri terminati\x1b[0m");
			}
			rows.forEach(setFinishedMerchant);
		}
	});
};

function setFinishedMerchant(element, index, array) {
	var player_id = element.player_id;
	var chat_id = element.chat_id;
	var day_cnt = element.day_cnt;

	connection.query('UPDATE merchant_offer SET time_end = NULL WHERE player_id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		if (day_cnt < merchant_limit) {
			var d = new Date();
			if ((d.getHours() > 8) && (d.getHours() < 23)) {
				bot.sendMessage(chat_id, "Il Contrabbandiere ha una nuova offerta per te!");
			}
		}
	});
};

function reloadFestival(manualFinish) {
	connection.query('SELECT MAX(id) As maxid FROM event_crafting_item', function (err, rows, fields) {
		if (err) throw err;

		connection.query('SELECT id FROM event_crafting_item WHERE time < NOW() AND time IS NOT NULL AND id = ' + rows[0].maxid, function (err, rows, fields) {
			if (err) throw err;

			if ((Object.keys(rows).length == 0) && (manualFinish == 0)) {
				return;
			}

			connection.query('SELECT total_price, cnt, name FROM event_crafting_item, item WHERE event_crafting_item.item_id = item.id ORDER BY event_crafting_item.id DESC', function (err, rows, fields) {
				if (err) throw err;

				var tot = parseInt(rows[0].total_price) / parseInt(rows[0].cnt);
				var item_name = rows[0].name;

				connection.query('SELECT nickname, player_id, cnt, chat_id FROM event_crafting_status, player WHERE player.id = event_crafting_status.player_id AND cnt > 0', function (err, rows, fields) {
					if (err) throw err;

					var money = 0;
					for (i = 0; i < Object.keys(rows).length; i++) {
						money = Math.round(tot * rows[i].cnt);
						console.log(rows[i].nickname + ": " + rows[i].cnt + " creazioni per " + money + "Â§");
						connection.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + rows[i].player_id, function (err, rows, fields) {
							if (err) throw err;
						});
						bot.sendMessage(rows[i].chat_id, "Si Ã¨ conclusa la possibilitÃ  di creare *" + item_name + "*!\nNe hai creati " + rows[i].cnt + " ottenendo cosÃ¬ *" + formatNumber(money) + "Â§* come ricompensa!", mark);
					}

					connection.query('UPDATE event_crafting_status SET cnt = 0', function (err, rows, fields) {
						if (err) throw err;
					});

					connection.query('SELECT shortname FROM rarity WHERE shortname IN ("NC","R","UR","L","E") ORDER BY RAND()', function (err, rows, fields) {
						if (err) throw err;

						var shortname = rows[0].shortname;

						connection.query('SELECT item.rarity, item.name, item.id FROM item, craft WHERE craft.material_result = item.id AND ((material_1 IN (SELECT item_id FROM event_crafting_item)) OR (material_2 IN (SELECT item_id FROM event_crafting_item)) OR (material_3 IN (SELECT item_id FROM event_crafting_item))) AND item.craftable = 1 AND item.rarity = "' + shortname + '" AND item.id NOT IN (SELECT item_id FROM event_crafting_item) ORDER BY RAND()', function (err, rows, fields) {
							if (err) throw err;

							var item_id = 0;
							var item_rarity = "";
							var item_name = "";

							if (Object.keys(rows).length > 0) {
								item_id = rows[0].id;
								item_rarity = rows[0].rarity;
								item_name = rows[0].name;
							}

							connection.query('SELECT rarity, name, id FROM item WHERE craftable = 1 AND rarity = "' + shortname + '" AND id NOT IN (SELECT item_id FROM event_crafting_item) ORDER BY RAND()', function (err, rows, fields) {
								if (err) throw err;

								if ((Object.keys(rows).length > 0) && (item_id == 0)) {
									item_id = rows[0].id;
									item_rarity = rows[0].rarity;
									item_name = rows[0].name;
								}

								connection.query('SELECT rarity, name, id FROM item WHERE craftable = 1 AND rarity = "' + shortname + '"', function (err, rows, fields) {
									if (err) throw err;

									if ((Object.keys(rows).length > 0) && (item_id == 0)) {
										item_id = rows[0].id;
										item_rarity = rows[0].rarity;
										item_name = rows[0].name;
									}

									var wait_min = 15;

									var d = new Date();
									d.setHours(d.getHours() + 2);
									d.setMinutes(d.getMinutes() + wait_min);
									var time_end = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

									var value = merchantPrice(item_id);
									var increm = 0;
									if (manualFinish == 1) {
										var rows = connection_sync.query('SELECT increm FROM event_crafting_item ORDER BY id DESC');
										if (Object.keys(rows).length > 0) {
											var pastIncrem = parseInt(rows[0].increm);
											if (pastIncrem < 200)
												increm = parseInt(pastIncrem) + 10;
										}
									}

									var d = new Date();
									d.setMinutes(d.getMinutes() + wait_min);
									var wait_time = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

									if (isNaN(increm)){
										increm = 0;
										console.log("Increm a nan");
									}

									connection.query('INSERT INTO event_crafting_item (item_id, time, start_price, full_price, increm, wait_time) VALUES (' + item_id + ',"' + time_end + '",' + Math.round(value / 10) + ',' + value + ', ' + increm + ',"' + wait_time + '")', function (err, rows, fields) {
										if (err) throw err;
										console.log(getNow("it") + "\x1b[32m Festival aggiornato\x1b[0m");
									});
								});
							});
						});
					});
				});
			});
		});
	});
};

bot.onText(/^\/firstfestival/, function (message, match) {
	connection.query('SELECT shortname FROM rarity WHERE shortname IN ("NC","R","UR","L","E") ORDER BY RAND()', function (err, rows, fields) {
		if (err) throw err;

		var shortname = rows[0].shortname;

		connection.query('SELECT item.rarity, item.name, item.id FROM item, craft WHERE craft.material_result = item.id AND ((material_1 IN (SELECT item_id FROM event_crafting_item)) OR (material_2 IN (SELECT item_id FROM event_crafting_item)) OR (material_3 IN (SELECT item_id FROM event_crafting_item))) AND item.craftable = 1 AND item.rarity = "' + shortname + '" AND item.id NOT IN (SELECT item_id FROM event_crafting_item) ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;

			var item_id = 0;
			var item_rarity = "";
			var item_name = "";

			if (Object.keys(rows).length > 0) {
				item_id = rows[0].id;
				item_rarity = rows[0].rarity;
				item_name = rows[0].name;
			}

			connection.query('SELECT rarity, name, id FROM item WHERE craftable = 1 AND rarity = "' + shortname + '" AND id NOT IN (SELECT item_id FROM event_crafting_item) ORDER BY RAND()', function (err, rows, fields) {
				if (err) throw err;

				if ((Object.keys(rows).length > 0) && (item_id == 0)) {
					item_id = rows[0].id;
					item_rarity = rows[0].rarity;
					item_name = rows[0].name;
				}

				connection.query('SELECT rarity, name, id FROM item WHERE craftable = 1 AND rarity = "' + shortname + '"', function (err, rows, fields) {
					if (err) throw err;

					if ((Object.keys(rows).length > 0) && (item_id == 0)) {
						item_id = rows[0].id;
						item_rarity = rows[0].rarity;
						item_name = rows[0].name;
					}

					var wait_min = 15;

					var d = new Date();
					d.setHours(d.getHours() + 2);
					d.setMinutes(d.getMinutes() + wait_min);
					var time_end = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

					var value = merchantPrice(item_id);
					var increm = 0;

					var d = new Date();
					d.setMinutes(d.getMinutes() + wait_min);
					var wait_time = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

					connection.query('INSERT INTO event_crafting_item (item_id, time, start_price, full_price, increm, wait_time) VALUES (' + item_id + ',"' + time_end + '",' + Math.round(value / 10) + ',' + value + ', ' + increm + ',"' + wait_time + '")', function (err, rows, fields) {
						if (err) throw err;
						console.log(getNow("it") + "\x1b[32m Festival aggiornato\x1b[0m");
					});
				});
			});
		});
	});
});

function checkDungeonNotification() {
	connection.query('SELECT player_id, id FROM dungeon_status WHERE TIMESTAMPDIFF(MINUTE, NOW(), finish_time) < 60 AND finish_time IS NOT NULL AND notified = 0', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 dungeon notificato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " dungeon notificati\x1b[0m");
			}
			rows.forEach(setFinishedDungeonNotification);
		}
	});
};

function checkDungeonNotificationIstance() {
	connection.query('SELECT id FROM dungeon_list WHERE TIMESTAMPDIFF(MINUTE, NOW(), finish_date) < 180 AND finish_date IS NOT NULL AND notified = 0', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 istanza dungeon notificata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " istanze dungeon notificate\x1b[0m");
			}
			rows.forEach(setFinishedDungeonNotificationIstance);
		}
	});
};

function setFinishedDungeonNotification(element, index, array) {
	var player_id = element.player_id;
	var id = element.id;

	connection.query('SELECT chat_id FROM player WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		var chat_id = rows[0].chat_id;
		connection.query('UPDATE dungeon_status SET notified = 1 WHERE id = ' + id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Ti rimane solamente 1 ora per terminare il dungeon! Forza!");
		});
	});
};

function setFinishedDungeonNotificationIstance(element, index, array) {
	var dungeon_id = element.id;

	connection.query('UPDATE dungeon_list SET notified = 1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
		if (err) throw err;
	});

	connection.query('SELECT player_id FROM dungeon_status WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
		if (err) throw err;
		for (i = 0; i < Object.keys(rows).length; i++) {
			connection.query('SELECT chat_id FROM player WHERE id = ' + rows[i].player_id, function (err, rows, fields) {
				if (err) throw err;
				var chat_id = rows[0].chat_id;
				bot.sendMessage(chat_id, "Ti rimangono solamente 3 ore prima del crollo dell'istanza! Forza!");
			});
		};
	});
};

function checkDungeonRoom() {
	connection.query('SELECT dungeon_status.id As room_id, player.id As player_id, player.chat_id As chat_id FROM dungeon_status, player WHERE dungeon_status.player_id = player.id AND room_time < NOW() AND room_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 stanza terminata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " stanze terminate\x1b[0m");
			}
			rows.forEach(setFinishedDungeonRoom);
		}
	});
};

function checkGnome() {
	connection.query('SELECT heist_progress.id As progressId, player.id As player_id, player.chat_id As chat_id FROM heist_progress, player WHERE heist_progress.from_id = player.id AND time_end < NOW() AND time_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 gnomo scaduto\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " gnomi scaduti\x1b[0m");
			}
			rows.forEach(setFinishedGnome);
		}
	});
};

function setFinishedGnome(element, index, array) {
	var chat_id = element.chat_id;

	connection.query('DELETE FROM heist_progress WHERE id = ' + element.progressId, function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "Il tuo gnomo Ã¨ stato troppo tempo fuori! E' tornato al tuo rifugio senza aver terminato la partita.");
	});
};

function checkDungeonEnd() {
	connection.query('SELECT id, chat_id FROM player WHERE dungeon_time < NOW() AND dungeon_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 dungeon terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " dungeon terminati\x1b[0m");
			}
			rows.forEach(setFinishedDungeonEnd);
		}
	});
};

function checkMissionTeamExpire() {
	connection.query('SELECT party_id, team_id, report_id FROM mission_team_party WHERE mission_time_limit < NOW() AND mission_time_limit IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 missione team scaduta\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " missioni team scadute\x1b[0m");
			}
			rows.forEach(setFinishedMissionTeamExpire);
		}
	});
};

function setFinishedMissionTeamExpire(element, index, array) {
	var party_id = element.party_id;
	var team_id = element.team_id;
	var report_id = element.report_id;

	connection.query('SELECT P.chat_id, P.id FROM player P, mission_team_party_player M WHERE P.id = M.player_id AND M.party_id = ' + party_id + ' AND M.team_id = ' + team_id, function (err, rows, fields) {
		if (err) throw err;
		for(i = 0; i < Object.keys(rows).length; i++){
			bot.sendMessage(rows[i].chat_id, "Il tempo a disposizione per completare l'incarico Ã¨ terminato! Tutto il party torna al villaggio a mani vuote...");
			connection.query('UPDATE player SET mission_party = 0 WHERE id = ' + rows[i].id, function (err, rows, fields) {
				if (err) throw err;
			});
		}
	});
	connection.query('SELECT chat_id FROM team_player, player WHERE team_player.team_id = ' + team_id + ' AND team_player.role IN (1,2) AND team_player.player_id = player.id', function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(rows[0].chat_id, "Il Party " + party_id + " non Ã¨ riuscito a completare l'incarico in tempo!");
	});

	// Pulizia (aggiorna anche l'altra)
	connection.query('UPDATE mission_team_party SET part_id = 0, assigned_to = NULL, report_id = NULL, mission_start = NULL, mission_time_end = NULL, wait = 0, mission_time_limit = NULL WHERE team_id = ' + team_id + ' AND party_id = ' + party_id, function (err, rows, fields) {
		if (err) throw err;
	});
	connection.query('UPDATE mission_team_party_player SET answ_id = 0 WHERE party_id = ' + party_id + ' AND team_id = ' + team_id, function (err, rows, fields) {
		if (err) throw err;
	});
	if (report_id != null){
		connection.query('DELETE FROM mission_team_report WHERE team_id = ' + team_id + ' AND party_id = ' + party_id + ' AND report_id = ' + report_id, function (err, rows, fields) {
			if (err) throw err;
		});
	}
}

function checkDungeonExpire() {
	connection.query('SELECT dungeon_status.id As dungeon_status_id, dungeon_status.dungeon_id As dungeon_id, player.id As player_id, player.chat_id FROM dungeon_status, player WHERE dungeon_status.player_id = player.id AND dungeon_status.finish_time < NOW() AND dungeon_status.finish_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 giocatore istanza dungeon scaduto\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " giocatori in istanze dungeon scaduti\x1b[0m");
			}
			rows.forEach(setFinishedDungeonExpire);
		}
	});
};

function checkIstanceExpire() {
	connection.query('SELECT dungeon_list.id As dungeon_id FROM dungeon_list WHERE dungeon_list.finish_date < NOW() AND dungeon_list.finish_date IS NOT NULL AND dungeon_list.main = 0 LIMIT 100', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 istanza dungeon scaduta\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " istanze dungeon scadute\x1b[0m");
			}
			rows.forEach(setFinishedIstanceExpire);
		}
	});
};

function setFinishedIstanceExpire(element, index, array) {
	var dungeon_id = element.dungeon_id;

	//console.log("Cancellazione istanza ID " + dungeon_id);

	connection.query('SELECT player.id As player_id, player.chat_id FROM dungeon_status, player, dungeon_list ' +
					 'WHERE dungeon_status.dungeon_id = dungeon_list.id AND dungeon_status.player_id = player.id AND dungeon_list.id = ' + dungeon_id,
					 function (err, rows, fields) {
		if (Object.keys(rows).length > 0) {
			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				//console.log("Notifica crollo istanza ID " + dungeon_id + " del player id " + rows[i].player_id);
				bot.sendMessage(rows[i].chat_id, "L'intera istanza Ã¨ scaduta, sei costretto ad uscire dal dungeon!");
			}
		}
		connection.query('DELETE FROM dungeon_list WHERE id = ' + dungeon_id, function (err, rows, fields) {
			if (err) throw err;
		});
		connection.query('DELETE FROM dungeon_status WHERE dungeon_id = ' + dungeon_id, function (err, rows, fields) {
			if (err) throw err;
		});
	});

};

function setFinishedDungeonExpire(element, index, array) {
	var player_id = element.player_id;
	var dungeon_status_id = element.dungeon_status_id;
	var dungeon_id = element.dungeon_id;
	var chat_id = element.chat_id;

	connection.query('UPDATE dungeon_list SET duration = duration-1 WHERE id = ' + dungeon_id, function (err, rows, fields) {
		if (err) throw err;
		connection.query('DELETE FROM dungeon_status WHERE id = ' + dungeon_status_id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Hai impiegato troppo tempo per completare il dungeon, i muri cominciano a crollare e sei costretto a scappare!");
		});
	});
};

function setFinishedDungeonEnd(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;

	connection.query('UPDATE player SET dungeon_time = NULL WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(element.chat_id, "I dungeon sono di nuovo disponibili!");
	});
};

function setFinishedDungeonRoom(element, index, array) {
	var player_id = element.player_id;
	var chat_id = element.chat_id;

	connection.query('UPDATE dungeon_status SET room_time = NULL WHERE id = ' + element.room_id, function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(element.chat_id, "Sei tornato in forze per proseguire il dungeon!");
	});
};

function checkEventMissions() {
	connection.query('SELECT player.nickname, player.id As player_id, player.chat_id, mission_event_status.mission_id FROM `player`, mission_event_status WHERE mission_event_status.player_id = player.id AND mission_end < NOW() AND mission_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 missione evento terminata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " missioni evento terminate\x1b[0m");
			}
			rows.forEach(setFinishedEventMission);
		}
	});
};

function teamBoss(team_id, drop, message, acc_bonus) {
	connection.query('SELECT team_player.notification, player.nickname, player.class, player.reborn, player.id, player.chat_id, boss_team.boss_id, boss_team.id As boss_id_absolute, player.global_end FROM team_player, player LEFT JOIN boss_team ON boss_team.id = player.boss_id WHERE team_player.suspended = 0 AND player.id = team_player.player_id AND player.holiday = 0 AND team_player.team_id = ' + team_id + ' ORDER BY player.boss_id DESC', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			rows.forEach(function (element, index, arr) {
				setTeamBoss(element, index, arr, drop, message.from.username, message, team_id, acc_bonus);
			});
		}
	});
};

function setTeamBoss(element, index, array, drop, killerName, message, team_id, acc_bonus) {
	var chat_id = element.chat_id;
	var notify = element.notification;
	var boss_id = element.boss_id;
	var player_id = element.id;
	var nickname = element.nickname;
	var class_id = element.class;
	var reborn = element.reborn;
	var boss_id_absolute = element.boss_id_absolute;	// Nella vista Ã¨ usato il boss_id dell'auto increment
	var global_end = element.global_end;

	connection.query('SELECT damage FROM boss_damage_view WHERE boss_id = ' + boss_id_absolute + ' AND player_id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;

		var text = "Inoltre hai ottenuto:\n";											// messaggio per chi uccide il boss
		if (nickname != killerName)
			text = "Il boss Ã¨ stato ucciso da " + killerName + "! Hai ottenuto:\n";		// messaggio per tutti gli altri

		var extra = "";
		if (acc_bonus > 0)
			extra = " (+1 da Accademia/Madre)";

		text += "> <b>" + formatNumber(drop) + "</b> Â§, <b>1</b> exp e <b>1</b> ðŸ¦‹ al team" + extra + " per l'uccisione\n";

		if (Object.keys(rows).length > 0) {
			var damage = rows[0].damage;
			var rows = connection_sync.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + player_id + ' AND ability_id = 12');

			var abBonus = 0;
			if (Object.keys(rows).length > 0) {
				abBonus = rows[0].ability_level * rows[0].val;
			}

			var money = damage / 2;
			money += (money * abBonus / 100);

			var global_extra = "";
			if (global_end == 1){
				var global_bonus = Math.round(money*0.05);
				money += global_bonus;
				global_extra = " (" + formatNumber(global_bonus) + " grazie alla globale)";
			}
			money = Math.round(money);

			setExp(player_id, 2);
			connection_sync.query('UPDATE player SET money = money+' + money + ' WHERE id = ' + player_id);
			text += "> <b>" + formatNumber(money) + "</b> Â§ e <b>2</b> exp per il tuo contributo" + global_extra + "\n";
		}

		if (boss_id == 20) {
			addChest(player_id, 7);
			text += "> uno <b>Scrigno Capsula</b>\n";
		} else if (boss_id == 31) {
			var mana = Math.round(getRandomArbitrary(750, 1500));
			var gems = Math.round(getRandomArbitrary(5, 10));

			text += "> <b>" + formatNumber(mana) + "</b> Mana, <b>" + gems + "</b> ðŸ’Ž e <b>1</b> ðŸ¦‹ al team\n";

			connection.query('UPDATE event_mana_status SET mana_1 = mana_1 + ' + mana + ', mana_2 = mana_2 + ' + mana + ', mana_3 = mana_3 + ' + mana + ' WHERE player_id = ' + element.id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE player SET gems = gems+' + gems + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE team_player SET kill_streak = kill_streak+1 WHERE player_id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
			connection.query('UPDATE team SET point = point+1 WHERE id = ' + team_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		setExp(player_id, 1);
		connection.query('UPDATE player SET money = money+' + drop + ', boss_id = NULL WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});

		if (notify == 1)
			bot.sendMessage(chat_id, text, html);
	});
};

function checkTravels() {
	connection.query('SELECT nickname, id, travel_id, chat_id FROM `player` WHERE travel_time_end < NOW() AND travel_time_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 viaggio terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " viaggi terminati\x1b[0m");
			}
			rows.forEach(setFinishedTravel);
		}
	});
};

function resetDungeonSkip() {
	connection.query('UPDATE player SET dungeon_skip = 0 WHERE dungeon_skip != 0', function (err, rows, fields) {
		if (err) throw err;
	});
};

function resetRefill() {
	connection.query('UPDATE player SET refilled = 0 WHERE refilled > 0', function (err, rows, fields) {
		if (err) throw err;
	});
};

function deleteSearch() {
	connection.query('DELETE FROM search_history WHERE TIMESTAMPDIFF(DAY, time, NOW()) > 30', function (err, rows, fields) {
		if (err) throw err;
	});
};

function checkCave() {
	connection.query('SELECT nickname, reborn, boost_id, charm_id, id, cave_id, chat_id, boost_mission, cave_gem FROM player WHERE cave_time_end < NOW() AND cave_time_end IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 viaggio cava terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " viaggi cava terminati\x1b[0m");
			}
			rows.forEach(setFinishedCave);
		}
	});
};

function checkGlobalMsg() {
	connection.query('SELECT global_msg, global_msg_on FROM config', function (err, rows, fields) {
		if (err) throw err;
		var msg = rows[0].global_msg;
		if (rows[0].global_msg_on == 1){
			connection.query('SELECT * FROM global_msg LIMIT 200', function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length > 0) {
					for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
						bot.sendMessage(rows[i].chat_id, msg + "\n\nUsa /globali per bloccare la ricezioni di questi messaggi, sconsigliato!", html_no_preview);
						var cnt = (rows[i].id % 200)
						if (cnt == 0)
							cnt = 200;
						console.log("Invio msg globale a " + rows[i].chat_id + " " + cnt + "/" + Object.keys(rows).length);
						connection.query('DELETE FROM global_msg WHERE chat_id = ' + rows[i].chat_id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				}else{
					connection.query('UPDATE config SET global_msg_on = 0', function (err, rows, fields) {
						if (err) throw err;
					});
				}
			});
		}
	});
}

function checkFestivalWait() {
	connection.query('SELECT id FROM event_crafting_item WHERE wait_time < NOW() AND wait_time IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			connection.query('UPDATE event_crafting_item SET wait_time = NULL WHERE id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
				console.log("Tempo preparazione festival terminato");
			});
		}
	});
}

function checkFestivalFinish() {
	connection.query('SELECT id FROM event_crafting_item WHERE completed = 1 AND reward = 0', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			connection.query('UPDATE event_crafting_item SET reward = 1 WHERE id = ' + rows[0].id, function (err, rows, fields) {
				if (err) throw err;
				reloadFestival(1);
			});
		}
	});
}

function checkProtection() {
	connection.query('SELECT nickname, id, chat_id FROM `player` WHERE heist_protection < NOW() AND heist_protection IS NOT NULL', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 protezione terminata\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " protezioni terminate\x1b[0m");
			}
			rows.forEach(setFinishedProtection);
		}
	});
};

function setFinishedProtection(element, index, array) {
	var chat_id = element.chat_id;
	connection.query('UPDATE `player` SET `heist_protection`=NULL WHERE nickname="' + element.nickname + '"', function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "L'effetto del Campo di Forza Ã¨ terminato!");
	});
}

function checkBoost() {
	connection.query('SELECT nickname, id, boost_id, chat_id FROM player WHERE boost_mission = 0 AND boost_id != 0', function (err, rows, fields) {
		if (err) throw err;

		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 boost terminato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " boost terminati\x1b[0m");
			}
			rows.forEach(setFinishedBoost);
		}
	});
};

function toTime(seconds, withSec = 0) {
	var numdays = Math.floor((seconds % 31536000) / 86400);
	var numhours = Math.floor(((seconds % 31536000) % 86400) / 3600);
	var numminutes = Math.floor((((seconds % 31536000) % 86400) % 3600) / 60);
	var numseconds = Math.floor((((seconds % 31536000) % 86400) % 3600) % 60);

	if (withSec == 0) {
		if (numdays > 0) {
			if (numdays == 1) {
				if (numminutes > 0)
					return numdays + " giorno, " + numhours + " ore e " + numminutes + " min";
				else
					return numdays + " giorno, " + numhours + " ore";
			} else {
				if (numminutes > 0)
					return numdays + " giorni, " + numhours + " ore e " + numminutes + " min";
				else
					return numdays + " giorni, " + numhours + " ore e " + numminutes + " min";
			}
		} else {
			if (numhours > 1) {
				if (numminutes > 0)
					return numhours + " ore e " + numminutes + " min";
				else
					return numhours + " ore";
			} else if (numhours == 1) {
				if (numminutes > 0)
					return numhours + " ora e " + numminutes + " min";
				else
					return numhours + " ora";
			} else if (numhours < 1) {
				return numminutes + " min";
			}
		}
	} else {
		if (numdays > 0) {
			if (numdays == 1) {
				return numdays + " giorno, " + numhours + " ore, " + numminutes + " min e " + numseconds + " sec";
			} else {
				return numdays + " giorni, " + numhours + " ore, " + numminutes + " min e " + numseconds + " sec";
			}
		} else {
			if (numhours > 1) {
				return numhours + " ore, " + numminutes + " min e " + numseconds + " sec";
			} else if (numhours == 1) {
				return numhours + " ora, " + numminutes + " min e " + numseconds + " sec";
			} else if (numhours < 1) {
				return numminutes + " min e " + numseconds + " sec";
			}
		}
	}
}

function setFinishedEventMission(element, index, array) {
	var chat_id = element.chat_id;

	//console.log("Event: " + element.player_id + " - " + element.mission_id);

	connection.query('SELECT choice FROM mission_event_text WHERE id = ' + element.mission_id, function (err, rows, fields) {
		if (err) throw err;
		var choice = rows[0].choice;
		connection.query('UPDATE mission_event_status SET mission_end = NULL, mission_id = 0, choice_id = ' + rows[0].choice + ' WHERE player_id = ' + element.player_id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Hai completato la missione evento!\nProsegui la storia attraverso il pulsante nel menÃ¹.");
		});
	});
}


function setFinishedMission(element, index, array) {
	var chat_id = element.chat_id;

	var charm_id = parseInt(element.charm_id);
	var auto_id = parseInt(element.mission_auto_id);
	var boost_id = parseInt(element.boost_id);
	var boost_mission = parseInt(element.boost_mission);
	var reborn = parseInt(element.reborn);
	var class_id = parseInt(element.class);
	var level = Math.floor(element.exp / 10);
	var mission_gem = element.mission_gem;
	var global_end = element.global_end;
	var mission_count = element.mission_count;
	var global_end = element.global_end;

	if ((boost_mission <= 0) && (boost_id != 0)) {
		connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + element.id, function (err, rows, fields) {
			if (err) throw err;
		});
		boost_mission = 0;
		boost_id = 0;
	}

	connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 9', function (err, rows, fields) {
		if (err) throw err;

		var abBonus = 0;
		var double = 0;
		if (Object.keys(rows).length > 0) {
			var rand = Math.random() * 100;
			abBonus = parseInt(rows[0].ability_level) * rows[0].val;
			if (rand < abBonus) {
				double = 1;
			}
		}

		if (rows.affectedRows == 0) {
			console.log(">> ERRORE UPDATE MISSIONE: " + element.mission_id + " DI " + element.nickname);
			return;
		}

		connection.query('UPDATE player SET mission_id = 0, mission_time_end = NULL WHERE id = ' + element.id, function (err, rows, fields) {
			if (err) throw err;

			if (element.mission_id == 1001) {
				addItem(element.id, 15);
				bot.sendMessage(chat_id, "Missione completata!\nHai trovato un misterioso *Tavolino*", mark);

				setExp(element.id, 1);
				connection.query('UPDATE player SET mission_count = mission_count + 1 WHERE id = ' + element.id, function (err, rows, fields) {
					if (err) throw err;
				});
				return;
			}

			if ((element.mission_id == 1002) || (element.mission_id == 1003)) {

				var exp = 0;
				if (element.mission_id == 1002) {
					exp = 6;
				} else if (element.mission_id == 1003) {
					exp = 4;
				}

				bot.sendMessage(chat_id, "Missione completata!\nHai ottenuto virtÃ¹ e conoscenza, nonchÃ© " + exp + " punti exp!", mark);
				setExp(element.id, exp);
				connection.query('UPDATE player SET mission_count = mission_count + 1 WHERE id = ' + element.id, function (err, rows, fields) {
					if (err) throw err;
				});
				return;
			}

			if (element.mission_id == 1004){
				bot.sendMessage(chat_id, "Entrato in Biblioteca ðŸ›, recuperi l'archivio segreto e la memoria di un'importante missione...", mark);
				connection.query('UPDATE player SET mission_count = mission_count + 1 WHERE id = ' + element.id, function (err, rows, fields) {
					if (err) throw err;
				});
				return;
			}

			connection.query('SELECT chest_id FROM mission WHERE id = ' + element.mission_id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					console.log(">> ERRORE CHEST: " + element.mission_id + " DI " + element.nickname);
					return;
				}

				var mission_chest = rows[0].chest_id;
				var rand = 0;
				var evolved = 0;
				var evolved_text = "";

				rand = Math.round((Math.random() * 100) + 1);
				var bonus = 0;
				if (charm_id == 61) {
					bonus = 5;
				} else if (charm_id == 185) {
					bonus = 10;
				} else if (charm_id == 189) {
					bonus = 15;
				} else if (charm_id == 697) {
					bonus = 20;
				}

				if ((class_id == 3) && (reborn >= 4)) {
					bonus += 5;
				}
				if ((class_id == 3) && (reborn == 3)) {
					bonus += 2.5;
				}
				if ((class_id == 7) && (reborn == 3)) {
					bonus += 10;
				}
				if ((class_id == 7) && (reborn >= 4)) {
					bonus += 15;
				}

				var exp_lost = 0;
				if (luckyMode == 1) {
					var d = new Date();
					if (d.getDay() == 6) {
						bonus += 50;
					} else if (d.getDay() == 0) {
						var r = Math.random();
						if (r < 50) {
							bonus += 50;
						} else if ((r > 50) && (r < 75)) {
							exp_lost = 1;
						}
					}
				}

				if (boost_id == 5) {
					bonus = bonus * 2;
				}

				if (mission_chest < 6) {
					if (rand <= bonus) {
						mission_chest++;
						evolved = 1;
					}
				}

				rand = Math.random() * 100;

				connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 11', function (err, rows, fields) {
					if (err) throw err;

					var abBonus = 0;
					var rand_c = 15;

					if (Object.keys(rows).length > 0) {
						abBonus = rows[0].ability_level * rows[0].val;
					}
					rand_c += abBonus;

					var d = new Date();
					if (d.getDay() == 2) {
						rand_c += 10;
					}
					if (crazyMode == 1) {
						rand_c += 20;
					}

					if ((rand >= 5) && (rand <= rand_c) && (boost_id == 0)) {
						var rand2 = Math.round(Math.random() * 7);

						connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 19', function (err, rows, fields) {
							if (err) throw err;

							var abBonusStone = 0;
							if (Object.keys(rows).length > 0) {
								abBonusStone = parseInt(rows[0].ability_level) * rows[0].val;
							}

							var rand3 = Math.random()*100;
							var mplus = 0;
							var m = 0;
							if (rand3 < abBonusStone){
								mplus = 1;
							}

							if (rand2 == 0) {
								m = 3+mplus;
								connection.query('UPDATE player SET boost_id = 1, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato una Bevanda Energetica! Per " + m + " missioni il tempo di esecuzione missioni Ã¨ dimezzato.");
								});
							} else if (rand2 == 1) {
								m = 3+mplus;
								connection.query('UPDATE player SET boost_id = 2, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato una Bevanda Scrigno! Per " + m + " missioni gli scrigni ottenuti a fine missione sono raddoppiati.");
								});
							} else if (rand2 == 2) {
								m = 3+mplus;
								if (level > 20) {
									connection.query('UPDATE player SET boost_id = 3, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(chat_id, "Hai trovato una Bevanda Fiamma di Drago! Per " + m + " viaggi in cava le pietre ottenute sono raddoppiate.");
									});
								}
							} else if (rand2 == 3) {
								m = 2+mplus;
								connection.query('UPDATE player SET boost_id = 4, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato una Bevanda Livellante! Per " + m + " missioni i punti esperienza ottenuti a fine missione sono raddoppiati.");
								});
							} else if (rand2 == 4) {
								m = 3+mplus;
								connection.query('UPDATE player SET boost_id = 5, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato una Bevanda Quadrifoglio! Per " + m + " missioni la fortuna Ã¨ raddoppiata.");
								});
							} else if (rand2 == 5) {
								m = 3+mplus;
								connection.query('UPDATE player SET boost_id = 6, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato una Bevanda Furia! Per " + m + " attacchi il tuo danno Ã¨ raddoppiato.");
								});
							} else if (rand2 == 6) {
								m = 3+mplus;
								connection.query('UPDATE player SET boost_id = 7, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato una Bevanda Bottino! Per " + m + " missioni fornisce il doppio delle monete.");
								});
							} else if (rand2 == 7) {
								m = 2+mplus;
								connection.query('UPDATE player SET boost_id = 8, boost_mission = ' + m + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(chat_id, "Hai trovato una Bevanda Corsa! Per " + m + " stanze dungeon il tempo di attesa Ã¨ dimezzato.");
								});
							}
						});

						setAchievement(chat_id, element.id, 37, 1);
					}

					if ((rand > 2) && (rand < 5)) {
						if (getChestCnt(element.id, 8) == 0){
							addChest(element.id, 8);
							bot.sendMessage(chat_id, "Hai trovato uno Scrigno Mistico! Che fortuna!");
							setAchievement(chat_id, element.id, 37, 1);
						}
					}

					if ((rand > 99) && (reborn >= 2)) {
						connection.query('UPDATE player SET gems = gems+1 WHERE id = ' + element.id, function (err, rows, fields) {
							if (err) throw err;
							bot.sendMessage(chat_id, "Hai trovato una Gemma ðŸ’Ž!");
							setAchievement(chat_id, element.id, 37, 1);
						});
					}

					if (luckyMode == 1) {
						if ((rand > 80) && (rand < 84)) {
							connection.query('UPDATE player SET moon_coin = moon_coin+1 WHERE id = ' + element.id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Al ritorno dalla missione vedi un bagliore lucente per terra e abbassi lo sguardo... Hai trovato una Moneta Lunare ðŸŒ•!");
								setAchievement(chat_id, element.id, 37, 1);
							});
						}
					} else {
						if ((rand > 80) && (rand < 81) && (mission_chest >= 3)) {
							connection.query('UPDATE player SET moon_coin = moon_coin+1 WHERE id = ' + element.id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(chat_id, "Al ritorno dalla missione vedi un bagliore lucente per terra e abbassi lo sguardo... Hai trovato una Moneta Lunare ðŸŒ•!");
								setAchievement(chat_id, element.id, 37, 1);
							});
						}
					}

					if (auto_id == (max_mission_id + 1)) {
						auto_id = 1;
					}

					connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 2', function (err, rows, fields) {
						if (err) throw err;

						var abBonus = 0;
						if (Object.keys(rows).length > 0) {
							abBonus = parseInt(rows[0].ability_level) * rows[0].val;
						}

						connection.query('SELECT rarity.shortname As rarity FROM mission_auto, mission, rarity WHERE mission.chest_id = rarity.id AND mission.chest_id = mission_auto.chest_id AND mission_auto.id = ' + auto_id + ' LIMIT 1', function (err, rows, fields) {
							if (err) throw err;
							var rarity_miss = "";

							if (Object.keys(rows).length > 0) {
								rarity_miss = "\nLa prossima sarÃ  di raritÃ  " + rows[0].rarity;
							}

							connection.query('SELECT name, rarity_shortname, id FROM chest WHERE id = ' + mission_chest, function (err, rows, fields) {
								if (err) throw err;
								if (Object.keys(rows).length == 0) {
									bot.sendMessage(chat_id, "Si Ã¨ verificato un problema, contatta l'amministratore.");
									return;
								}
								var chest_id = rows[0].id;
								var money = Math.round(((Math.random() * 100) + 100) * mission_chest);

								if (luckyMode == 1) {
									var d = new Date();
									if (d.getDay() == 6) {
										var rand = Math.random() * 100;
										if (rand < 75) {
											money = money * 2;
										}
									} else if (d.getDay() == 0) {
										var rand = Math.random() * 100;
										if (rand < 50) {
											money = money * 2;
										} else {
											money = money / 2;
										}
									}
								}

								money += abBonus;

								if (boost_id == 7) {
									money = money * 2;
								}

								if ((class_id == 3) && (reborn == 5)) {
									money += money * 0.1;
								}

								if (charm_id == 697) {
									money += money * 0.2;
								}

								var exp = 0;
								exp = mission_chest;
								exp = exp - exp_lost;

								if (evolved == 1) {
									evolved_text = ", evoluto grazie alla fortuna";
								}
								if (boost_id == 4) {
									exp = exp * 2;
								}

								var crazyText = "";
								var num = 1;

								if (boost_id == 2) {
									num++;
									crazyText = num + "x ";

									addChest(element.id, chest_id);
								}
								if (double == 1) {
									num++;
									crazyText = num + "x ";

									addChest(element.id, chest_id);
								}
								if (crazyMode == 1) {
									num++;
									crazyText = num + "x ";

									addChest(element.id, chest_id);
								}

								if (crazyMode == 1) {
									var rand = Math.random() * 100;
									if ((chest_id >= 5) && (rand < 3)) {
										addItem(element.id, 200);
										bot.sendMessage(chat_id, "Sei stato veramente molto fortunato ed hai ottenuto un Necronucleo! Woah!");
									}

									if ((chest_id == 6) && (rand > 90)) {
										addChest(element.id, 7);

										bot.sendMessage(chat_id, "FOLLE! Hai trovato uno *Scrigno Capsula*!", mark);
										return;
									}
								}

								if ((class_id == 7) && (reborn > 1)) {
									money -= money * 0.15;
								}
								if ((class_id == 9) && (reborn > 1)) {
									money += money * 0.15;
								}

								if (reborn == 1){
									money = money * Math.round(6-level/20);
								}

								money = Math.round(money);

								if (mission_gem == 0) {
									// non gemmata
								}

								var extra = "";
								/*
								if (global_end == 1){
									if ((rows[0].rarity_shortname == "C") || (rows[0].rarity_shortname == "NC")){
										exp += 1;
									}else{
										exp += 2;
									}
									extra = " (aumentati grazie al bonus impresa globale)";
								}
								*/

								bot.sendMessage(chat_id, "Missione completata! Hai ottenuto:\n" + crazyText + "*" + rows[0].name + "* (" + rows[0].rarity_shortname + ")" + evolved_text + ", *" + formatNumber(money) + "* Â§ e *" + exp + "* exp " + extra + "!" + rarity_miss, mark);

								addChest(element.id, chest_id);
								setExp(element.id, exp);

								if (mission_count+1 >= 5){
									connection.query("SELECT referral_list.id, referral_list.player_id, player.chat_id FROM referral_list, player WHERE player.id = referral_list.player_id AND referral_list.new_player = " + element.id + " AND referral_list.reward = 0", function (err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length > 0) {
											var referall_money = 50000;	// Proprietario del link invito
											var referall_gems = 2;

											bot.sendMessage(rows[0].chat_id, "L'utente <b>" + element.nickname + "</b> che hai invitato ha completato abbastanza missioni, ottieni quindi <b>" + formatNumber(referall_money) + " Â§</b> e <b>" + referall_gems + "</b> ðŸ’Ž!", html);

											connection.query('UPDATE player SET money = money+' + referall_money + ', gems = gems+' + referall_gems + ' WHERE id = ' + rows[0].player_id, function (err, rows, fields) {
												if (err) throw err;
											});
											connection.query('UPDATE referral_list SET reward = 1 WHERE id = ' + rows[0].id, function (err, rows, fields) {
												if (err) throw err;
												console.log("Referral di " + element.id + " dopo " + (mission_count+1) + " missioni")
											});
										}
									});
								}

								connection.query('UPDATE player SET mission_count = mission_count + 1, money = money + ' + money + ' WHERE id = ' + element.id, function (err, rows, fields) {
									if (err) throw err;
									setAchievementProgress(element.id, 2);
								});

								if (villa == 1) {
									connection.query('SELECT points FROM event_villa_status WHERE player_id = ' + element.id, function (err, rows, fields) {
										if (err) throw err;

										if (Object.keys(rows).length > 0) {
											var points = parseInt(rows[0].points);
											connection.query('UPDATE event_villa_status SET points = points+' + chest_id + ' WHERE player_id = ' + element.id, function (err, rows, fields) {
												if (err) throw err;
												bot.sendMessage(chat_id, "Hai ricevuto " + chest_id + " punti per l'evento di LastSoldier95! Ora ne possiedi *" + (points + chest_id) + "*!", mark);
											});
										};
									});
								}

								if ((boost_id == 2) || (boost_id == 4) || (boost_id == 5) || (boost_id == 7)) {
									if (boost_mission - 1 == 0) {
										connection.query('UPDATE player SET boost_mission = 0, boost_id = 0 WHERE id = ' + element.id, function (err, rows, fields) {
											if (err) throw err;
										});
									} else {
										connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + element.id, function (err, rows, fields) {
											if (err) throw err;
										});
									}
								}

								if ((snowHouse == 1) && (snowHouseEnd == 0)){
									var rand = Math.random()*100;
									if (rand < 15){
										connection.query('SELECT COUNT(id) As cnt FROM event_snowball_status WHERE player_id = ' + element.id, function (err, rows, fields) {
											if (err) throw err;
											if (rows[0].cnt > 0){
												connection.query('SELECT COUNT(id) As cnt FROM event_snowball_list WHERE player_id = ' + element.id, function (err, rows, fields) {
													if (err) throw err;
													var snowball = 1+parseInt(rows[0].cnt);
													connection.query('UPDATE event_snowball_status SET snowball = snowball+' + snowball + ' WHERE player_id = ' + element.id, function (err, rows, fields) {
														if (err) throw err;
														bot.sendMessage(chat_id, "Hai trovato " + snowball + " Palle di Neve!");
														console.log(snowball + " palle di neve a " + element.nickname);
													});
												});
											}
										});
									};
								};

								setAchievement(chat_id, element.id, 1, 1);
							});
						});
					});
				});
			});
		});
	});
}

function setFinishedSpecialMission(element, index, array) {
	var chat_id = element.chat_id;
	var mission_id = element.mission_special_id;

	connection.query('SELECT charm_id, class, boost_id, boost_mission, reborn FROM player WHERE nickname="' + element.nickname + '"', function (err, rows, fields) {
		if (err) throw err;
		var charm_id = parseInt(rows[0].charm_id);
		var boost_id = parseInt(rows[0].boost_id);
		var boost_mission = parseInt(rows[0].boost_mission);
		var reborn = parseInt(rows[0].reborn);
		var class_id = parseInt(rows[0].class);

		if ((boost_mission <= 0) && (boost_id != 0)) {
			connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE nickname = "' + element.nickname + '"', function (err, rows, fields) {
				if (err) throw err;
			});
			boost_mission = 0;
			boost_id = 0;
		}

		connection.query('UPDATE `player` SET `mission_special_id`=0,`mission_special_time_end`=NULL WHERE nickname="' + element.nickname + '" AND mission_special_id != 0', function (err, rows, fields) {
			if (err) throw err;

			connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 11', function (err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				var rand_c = 15;

				if (Object.keys(rows).length > 0) {
					abBonus = rows[0].ability_level * rows[0].val;
				}
				rand_c += abBonus;

				var d = new Date();
				if (d.getDay() == 2) {
					rand_c += 10;
				}

				connection.query('SELECT item.name, rarity.id As rarityid, item.rarity, item.id FROM item, rarity, mission_zone_item WHERE item.rarity = rarity.shortname AND zone_id = ' + mission_id + ' AND item.id = mission_zone_item.item_id ORDER BY RAND()', function (err, rows, fields) {
					if (err) throw err;

					var item_id = rows[0].id;
					var exp = rows[0].rarityid;
					var dust = exp;
					var num = 1;

					if (boost_id == 2) {
						num++;

						addItem(element.id, item_id);
					}
					if (boost_id == 4) {
						exp = exp * 2;
					}

					bot.sendMessage(chat_id, "Itinerario completato! Hai ottenuto:\n" + num + "x *" + rows[0].name + "* (" + rows[0].rarity + "), *" + exp + "* exp e *" + dust + "x Polvere* (S)!", mark);

					addItem(element.id, item_id);
					addItem(element.id, 646, dust);

					connection.query('UPDATE player SET exp = exp+' + exp + ' WHERE nickname = "' + element.nickname + '"', function (err, rows, fields) {
						if (err) throw err;
					});

					if ((boost_id == 2) || (boost_id == 4) || (boost_id == 5)) {
						if (boost_mission - 1 == 0) {
							connection.query('UPDATE player SET boost_mission = 0, boost_id = 0 WHERE id = ' + element.id, function (err, rows, fields) {
								if (err) throw err;
							});
						} else {
							connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + element.id, function (err, rows, fields) {
								if (err) throw err;
							});
						}
					}
				});
			});
		});
	});
}

function setFinishedHeistProgress(element, index, array) {
	var player_id = element.id;
	var chat_id = element.chat_id;
	var ext = element.extracted;
	var word = element.word;
	var to_id = element.to_id;
	var nick = element.nickname;
	var changeComb = String(element.changeComb);
	var myComb = String(element.my_combination);

	var rBack = {
		parse_mode: "HTML",
		reply_markup: {
			resize_keyboard: true,
			//one_time_keyboard: true,
			"keyboard": [["Torna al Rifugio"], ["Torna al menu"]]
		}
	};

	if (changeComb == 0) {
		connection.query('UPDATE heist_progress SET wait_time = NULL WHERE from_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
			bot.sendMessage(chat_id, "Il tuo gnomo ha terminato la raccolta delle rune, torna al rifugio!", rBack);
		});
	} else {
		var numbers = changeComb.split("");
		var my_numbers = myComb.split("");
		var len = Object.keys(numbers).length;

		var randCom = 0;
		for (i = 0; i < len; i++) {
			randCom = Math.round(Math.random() * 5 + 1);
			if (randCom != my_numbers[numbers[i] - 1])
				my_numbers[numbers[i] - 1] = randCom;
			else
				i--;
		}

		connection.query('UPDATE heist_progress SET my_combination = ' + my_numbers.join("") + ', changeComb = 0, wait_time = NULL WHERE from_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});

		connection.query('SELECT level FROM dragon WHERE player_id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;

			var dragon = 0;
			if (Object.keys(rows).length > 0) {
				dragon = rows[0].level / 4;
			}

			var rand = Math.random() * 100;
			var text = "";

			if ((rand > 3) && (rand < 8)) {
				connection.query('SELECT id, name FROM item WHERE rarity = "D" AND name LIKE "Pietra%" ORDER BY RAND()', function (err, rows, fields) {
					if (err) throw err;
					if (Object.keys(rows).length > 0) {
						var name = rows[0].name;
						var id = rows[0].id;
						addItem(player_id, id);
						connection.query('UPDATE heist_progress SET wait_time = NULL WHERE from_id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
							text = "Durante il viaggio Ã¨ caduto in un buco profondo ed ha trovato una <b>" + name + "</b>!";
							bot.sendMessage(chat_id, "Il tuo gnomo ha cambiato le rune richieste, torna al rifugio!\n" + text, rBack);
						});
					}
				});
			} else if ((rand > 10) && (rand < 12)) {			
				connection.query('SELECT item.id As item_id, item.name FROM inventory, item WHERE item.id = inventory.item_id AND item.rarity NOT IN ("U","IN","S","D","A","X") AND inventory.player_id = ' + to_id + ' AND inventory.quantity > 0 ORDER BY RAND()', function (err, rows, fields) {
					if (err) throw err;
					var name = "";
					var id = 0;
					if (Object.keys(rows).length > 0) {
						name = rows[0].name;
						id = rows[0].item_id;
						delItem(to_id, id, 1);
						addItem(player_id, id);
					}

					connection.query('UPDATE heist_progress SET wait_time = NULL WHERE from_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						if (id != 0) {
							text = "Durante il viaggio Ã¨ stato catturato dai guardiani del rifugio e durante la sua avventurosa fuga Ã¨ riuscito a sgraffignare un <b>" + name + "</b>!";
							bot.sendMessage(chat_id, "Il tuo gnomo ha cambiato le rune richieste, torna al rifugio!\n" + text, rBack);
							connection.query('SELECT chat_id FROM player WHERE id = ' + to_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(rows[0].chat_id, "Lo gnomo di " + nick + " Ã¨ riuscito a sgraffignarti <b>" + name + "</b>!", html);
							});
						}
					});
				});
			} else if ((rand > 20) && (rand < 22)) {
				connection.query('SELECT C.id, C.name FROM chest C, inventory_chest I WHERE C.id = I.chest_id AND I.player_id = ' + to_id + ' AND quantity > 0 ORDER BY RAND()', function (err, rows, fields) {
					if (err) throw err;

					var name = "";
					var id = 0;
					if (Object.keys(rows).length > 0) {
						name = rows[0].name;
						id = rows[0].id;
						delChest(to_id, id, 1);
						addChest(player_id, id);
					}

					connection.query('UPDATE heist_progress SET wait_time = NULL WHERE from_id = ' + player_id, function (err, rows, fields) {
						if (err) throw err;
						if (id != 0) {
							text = "Durante il viaggio Ã¨ stato catturato e durante la sua avventurosa fuga Ã¨ riuscito a sgraffignare un <b>" + name + "</b>!";
							bot.sendMessage(chat_id, "Il tuo gnomo ha cambiato le rune richieste, torna al rifugio!\n" + text, rBack);
							connection.query('SELECT chat_id FROM player WHERE id = ' + to_id, function (err, rows, fields) {
								if (err) throw err;
								bot.sendMessage(rows[0].chat_id, "Lo gnomo di " + nick + " Ã¨ riuscito a sgraffignarti <b>" + name + "</b>!", html);
							});
						}
					});
				});
			} else {
				bot.sendMessage(chat_id, "Il tuo gnomo ha cambiato le rune richieste, torna al rifugio!", rBack);
				return;
			};
		});
	};
};

function setFinishedHeist(element, index, array) {
	connection.query('SELECT player.nickname, player.exp, player.heist_streak, player.ability, player.money, player.id, player.chat_id, heist.grade, heist.rate1, heist.to_id, heist.matchmaking FROM player, heist WHERE heist.from_id = player.id AND heist.id = ' + element.id, function (err, rows, fields) {
		if (err) throw err;
		var fromNick = rows[0].nickname;
		var fromId = rows[0].id;
		var toId = rows[0].to_id;
		var fromChat = rows[0].chat_id;
		var fromMoney = parseInt(rows[0].money);
		var fromAbility = parseInt(rows[0].ability);
		var fromLevel = Math.floor(rows[0].exp / 10);
		var streak = parseInt(rows[0].heist_streak);
		var isMatch = rows[0].matchmaking;
		var rate = rows[0].rate1; //ProbabilitÃ  di successo
		var grade = rows[0].grade;

		connection.query('SELECT * FROM dragon WHERE player_id = ' + toId, function (err, rows, fields) {
			if (err) throw err;
			var dragon_room = 0;
			var dragon_level = 0;
			var dragon_name = "";
			if (Object.keys(rows).length > 0) {
				dragon_level = rows[0].level;
				dragon_name = rows[0].name + " " + rows[0].type;
			}
			connection.query('SELECT player.nickname, player.ability, player.id As playerid, player.chat_id, player.money FROM player, heist WHERE heist.to_id = player.id AND heist.id = ' + element.id, function (err, rows, fields) {
				if (err) throw err;
				if (Object.keys(rows).length == 0) {
					console.log("Errore id ispezione: " + element.id);
					return;
				}
				var toNick = rows[0].nickname;
				var toId = rows[0].playerid;
				var toMoney = parseInt(rows[0].money);
				var toChat = rows[0].chat_id;
				var toAbility = parseInt(rows[0].ability);

				connection.query('SELECT wanted_id, player_id FROM event_wanted_status WHERE player_id = ' + fromId, function (err, rows, fields) {
					if (err) throw err;

					if (((wanted == 1) || (fromId == 1)) && (Object.keys(rows).length > 0)) {
						if (toId == rows[0].wanted_id) {
							var rand_succ = Math.random() * 100;
							var wantedId = rows[0].wanted_id;

							connection.query('SELECT heist_win_2 FROM event_wanted_status WHERE player_id = ' + wantedId, function (err, rows, fields) {
								if (err) throw err;
								var heist = rows[0].heist_win_2;

								var randChest = 0;
								var chest_id = 0;

								randChest = Math.round((Math.random() * 99) + 1);
								if ((randChest <= 100) && (randChest >= 50)) { //50%
									chest_id = 2;
								} else if ((randChest < 50) && (randChest >= 20)) { //30%   
									chest_id = 3;
								} else if ((randChest < 20) && (randChest >= 5)) { //15%
									chest_id = 4;
								} else if ((randChest < 5) && (randChest >= 0)) { //5%
									chest_id = 5;
								}
								connection.query('SELECT name, rarity_shortname FROM chest WHERE id = ' + chest_id, function (err, rows, fields) {
									if (err) throw err;
									addChest(fromId, chest_id);
									bot.sendMessage(fromChat, "Come ricompensa per il tentativo hai ricevuto uno *" + rows[0].name + "* (" + rows[0].rarity_shortname + ")!", mark);
								});

								connection.query('SELECT money, chat_id FROM player WHERE id = ' + wantedId, function (err, rows, fields) {
									if (err) throw err;

									var wanted_chat = rows[0].chat_id;

									if (rand_succ < 35) {
										var money = ((parseInt(heist) * 100) + 1000);

										if (money > 15000) {
											money = 15000;
										}

										//bot.sendMessage(wanted_chat, "Lo gnomo di " + fromNick + " Ã¨ riuscito a catturarti! AndrÃ  meglio la prossima volta!");

										connection.query('UPDATE player SET money = money + ' + money + ' WHERE id = ' + fromId, function (err, rows, fields) {
											if (err) throw err;
											bot.sendMessage(fromChat, "Il tuo gnomo ha catturato il ricercato e hai ottenuto la sua taglia pari a *" + money + "* Â§\nTorna nella schermata dell'evento per visualizzare il nuovo ricercato!", mark);
										});

										connection.query('UPDATE event_wanted_status SET heist_win = heist_win+1 WHERE player_id = ' + fromId, function (err, rows, fields) {
											if (err) throw err;
										});
										connection.query('UPDATE event_wanted_status SET heist_lost_2 = heist_lost_2+1 WHERE player_id = ' + wantedId, function (err, rows, fields) {
											if (err) throw err;
										});

										connection.query('SELECT nickname, from_id, COUNT(from_id) FROM heist_history, player, event_wanted_status WHERE account_id NOT IN (SELECT account_id FROM banlist) AND fail = 0 AND event_wanted_status.player_id = player.id AND player.id = heist_history.from_id AND player.id != ' + fromId + ' AND time between DATE_SUB(now(),INTERVAL 2 MONTH) AND NOW() GROUP BY from_id ORDER BY COUNT(from_id) DESC LIMIT 200', function (err, rows, fields) {
											if (err) throw err;

											var len = Object.keys(rows).length;
											var rand = Math.round(Math.random() * len);

											var sel = rows[rand].from_id;
											connection.query('UPDATE event_wanted_status SET wanted_id = ' + sel + ' WHERE player_id = ' + fromId, function (err, rows, fields) {
												if (err) throw err;
												//bot.sendMessage(fromChat, "Ora ispeziona il nuovo ricercato!");
											});
										});
									} else {
										//bot.sendMessage(wanted_chat, "Lo gnomo di " + fromNick + " ha tentato di catturarti, ma fortunatamente sei riuscito a scappare!");
										bot.sendMessage(fromChat, "Il tuo tentativo di cattura Ã¨ stato un FALLIMENTO, riprova tentando ancora!");

										connection.query('UPDATE event_wanted_status SET heist_lost = heist_lost+1 WHERE player_id = ' + fromId, function (err, rows, fields) {
											if (err) throw err;
										});
										connection.query('UPDATE event_wanted_status SET heist_win_2 = heist_win_2+1 WHERE player_id = ' + wantedId, function (err, rows, fields) {
											if (err) throw err;
										});
									}
									connection.query('DELETE FROM `heist` WHERE `id`=' + element.id, function (err, rows, fields) {
										if (err) throw err;
									});
								});
							});
							return;
						}
					}
					connection.query('SELECT house_id FROM player WHERE id = ' + toId, function (err, rows, fields) {
						if (err) throw err;

						var to_house_id = rows[0].house_id;

						rate -= to_house_id * 5;
						rate -= dragon_level / 5;
						rate += fromLevel / 20;

						connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + fromId + ' AND ability_id = 4', function (err, rows, fields) {
							if (err) throw err;

							var abBonus = 0;
							var abBonus2 = 0;
							if (Object.keys(rows).length > 0) {
								abBonus = rows[0].ability_level;
								rate = parseInt(rate) + (abBonus * rows[0].val);
							}

							var rand = Math.random() * 100;
							var fail = 1;

							if (rate < 5)
								rate = 5;
							if (rate > 80)
								rate = 80;

							if (rand < rate) {
								fail = 0;
							}

							if (fromId == 1)
								fail = 0;

							connection.query('UPDATE player SET heist_limit = heist_limit+1 WHERE id = ' + toId, function (err, rows, fields) {
								if (err) throw err;
							});

							if (fail == 1) {
								connection.query('SELECT chat_id FROM player WHERE id = ' + toId, function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(fromChat, "Il tuo gnomo non Ã¨ riuscito a raggiungere il rifugio nemico, dannazione!");
									bot.sendMessage(rows[0].chat_id, "Lo gnomo di <b>" + fromNick + "</b> Ã¨ stato respinto dal tuo guardiano del cancello!", html);
									if (isMatch == 1){
										setAchievement(rows[0].chat_id, toId, 9, 1);
									}
								});

								var d = new Date();
								var history_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());

								connection.query('INSERT INTO heist_history (from_id, to_id, rate1, fail, time) VALUES ' +
												 '(' + fromId + ',' + toId + ',0,1,"' + history_date + '")',
												 function (err, rows, fields) {
									if (err) throw err;
								});
							} else {
								var d = new Date();
								d.setHours(d.getHours() + 12);
								var long_date = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
								var short_time = addZero(d.getHours()) + ':' + addZero(d.getMinutes());

								var combi = "";
								for (i = 0; i < 5; i++) {
									combi += String(Math.round(Math.random() * 5 + 1));
								}

								connection.query('INSERT INTO heist_progress (from_id, to_id, combination, time_end, isMatch) VALUES (' + fromId + ',' + toId + ',' + combi + ', "' + long_date + '",' + isMatch + ')', function (err, rows, fields) {
									if (err) throw err;
									bot.sendMessage(fromChat, "Il tuo gnomo Ã¨ arrivato al rifugio nemico, il guardiano del cancello ti propone uno strano gioco con le Rune, hai tempo fino alle " + short_time + " per partecipare!");
									connection.query('SELECT chat_id FROM player WHERE id = ' + toId, function (err, rows, fields) {
										if (err) throw err;
										bot.sendMessage(rows[0].chat_id, "Lo gnomo di <b>" + fromNick + "</b> Ã¨ riuscito ad arrivare davanti al tuo rifugio!", html);
									});
								});
							}
							connection.query('DELETE FROM heist WHERE id = ' + element.id, function (err, rows, fields) {
								if (err) throw err;
							});
						});
					});
				});
			});
		});
	});
};

function setFinishedTravel(element, index, array) {
	var chat_id = element.chat_id;

	connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 9', function (err, rows, fields) {
		if (err) throw err;

		var abBonus = 0;
		var double = 0;
		if (Object.keys(rows).length > 0) {
			var rand = Math.random();
			abBonus = parseInt(rows[0].ability_level) * rows[0].val;
			if (rand < abBonus) {
				double = 1;
			}
		}

		connection.query('UPDATE player SET travel_id = 0, travel_time_end = NULL WHERE id = ' + element.id, function (err, rows, fields) {
			if (err) throw err;
			connection.query('SELECT chest_id, money FROM travel WHERE id = "' + element.travel_id + '"', function (err, rows, fields) {
				if (err) throw err;
				var mission_chest = rows[0].chest_id;
				var money = rows[0].money;
				connection.query('SELECT name, rarity_shortname FROM chest WHERE id = "' + mission_chest + '"', function (err, rows, fields) {
					if (err) throw err;
					var chest_id = mission_chest;

					var qnt = 5;
					var exp = element.travel_id*10;

					if (double == 1) {
						qnt = 10;
					}

					bot.sendMessage(chat_id, "Viaggio completato, hai ottenuto " + qnt + "x *" + rows[0].name + "* (" + rows[0].rarity_shortname + "), *" + formatNumber(money) + "* Â§ e *" + exp + "* exp!", mark);

					addChest(element.id, chest_id, qnt);

					setExp(element.id, exp);
					connection.query('UPDATE player SET travel_limit = 0, money = money + ' + money + ', exp = exp+' + exp + ' WHERE id = ' + element.id, function (err, rows, fields) {
						if (err) throw err;
					});
				});
			});
		});
	});
}

function setFinishedCave(element, index, array) {
	var chat_id = element.chat_id;
	var boost_id = element.boost_id;
	var boost_mission = element.boost_mission;
	var cave_gem = element.cave_gem;

	if ((boost_mission <= 0) && (boost_id != 0)) {
		connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE id = ' + element.id, function (err, rows, fields) {
			if (err) throw err;
		});
		boost_mission = 0;
		boost_id = 0;
	}

	connection.query('SELECT * FROM cave WHERE id=' + element.cave_id, function (err, rows, fields) {
		if (err) throw err;

		var rand = 0;
		var stone_id = 0;
		var charm_id = element.charm_id;

		var caveid = parseInt(element.cave_id) + 2;
		if (charm_id == 603) {
			caveid += 2;
		}
		if (charm_id == 695) {
			caveid += 5;
		}

		if (luckyMode == 1) {
			var d = new Date();
			if (d.getDay() == 6) {
				var rand = Math.random() * 100;
				if (rand < 15) {
					caveid = caveid * 2;
				}
			} else if (d.getDay() == 0) {
				var rand = Math.random() * 100;
				if (rand < 10) {
					caveid = caveid * 2;
				} else if ((rand > 10) && (rand < 25)) {
					caveid = 0;
				}
			}
		}

		connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 16', function (err, rows, fields) {
			if (err) throw err;

			var abBonus = 0;
			var double = 0;
			if (Object.keys(rows).length > 0) {
				var rand = Math.random() * 100;
				abBonus = parseInt(rows[0].ability_level) * rows[0].val;
				if ((rand < abBonus) && (luckyMode == 0)) {
					caveid = caveid * 2;
				}
			}

			connection.query('SELECT ability_level, val FROM ability, ability_list WHERE ability.ability_id = ability_list.id AND player_id = ' + element.id + ' AND ability_id = 8', function (err, rows, fields) {
				if (err) throw err;

				var abBonus = 0;
				if (Object.keys(rows).length > 0) {
					abBonus = parseInt(rows[0].ability_level) * rows[0].val;
				}

				var boost_text = "";
				if (boost_id == 3) {
					caveid = caveid * 2;
					boost_text = "\n\nRaddoppiate grazie alla Bevanda Fiamma di Drago!";
					connection.query('UPDATE player SET boost_mission = boost_mission-1 WHERE id = ' + element.id, function (err, rows, fields) {
						if (err) throw err;
					});
				}

				var text = "";
				var rand2 = 0;
				var evolved = 0;
				var totPnt = 0;

				for (i = 0; i < caveid; i++) {
					evolved = 0;

					rand = Math.round(Math.random() * 100);
					if (rand <= 5) {
						stone_id = 73;
					} else if (rand <= 15) {
						stone_id = 72;
					} else if (rand <= 30) {
						stone_id = 71;
					} else if (rand <= 50) {
						stone_id = 70;
					} else if (rand <= 75) {
						stone_id = 69;
					} else if (rand <= 100) {
						stone_id = 68;
					}

					rand2 = Math.random() * 100;
					if ((rand2 < abBonus) && (stone_id != 73)) {
						evolved = 1;
						stone_id++;
					}

					totPnt += (stone_id-67);

					addItem(element.id, stone_id);
					if (evolved == 1) {
						connection.query('SELECT name FROM item WHERE id=' + stone_id, function (err, rows, fields) {
							if (err) throw err;
							text = text + "\n> " + rows[0].name + " evoluta!";
						});
					} else {
						connection.query('SELECT name FROM item WHERE id=' + stone_id, function (err, rows, fields) {
							if (err) throw err;
							text = text + "\n> " + rows[0].name;
						});
					}
				}

				connection.query('UPDATE player SET cave_limit = 0, cave_id = 0, cave_time_end = NULL WHERE id = ' + element.id + ' AND cave_id != 0', function (err, rows, fields) {
					if (err) throw err;
					if (caveid == 0) {
						bot.sendMessage(chat_id, "Hai completato l'esplorazione della cava ma non hai ottenuto alcuna pietra!");
					} else {
						bot.sendMessage(chat_id, "Hai completato l'esplorazione della cava e hai ottenuto:" + text + boost_text);
					}
				});

				var now = new Date();
				var rand = Math.random() * 200;
				if ((now.getHours() == 11) && (rand < 3) && (element.reborn >= 3)) {
					addItem(element.id, 201);
					bot.sendMessage(chat_id, "Hai ottenuto un Respiro di Morte! Che fortuna!");
				}
				setAchievement(chat_id, element.id, 11, 1);
			});
		});
	});
}

function setFinishedBoost(element, index, array) {
	var chat_id = element.chat_id;
	connection.query('UPDATE player SET boost_id = 0, boost_mission = 0 WHERE nickname = "' + element.nickname + '" AND boost_id != 0', function (err, rows, fields) {
		if (err) throw err;
		bot.sendMessage(chat_id, "Effetto della bevanda terminato!");
	});
}

function checkReborn() {
	connection.query('SELECT id, exp, life, total_life, reborn, chat_id, nickname FROM player WHERE (reborn = 1 AND exp >= 1000) OR (reborn > 1)', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			var player_id = 0;
			var chat_id = 0;
			var nick = "";

			for (var i = 0, len = Object.keys(rows).length; i < len; i++) {
				player_id = rows[i].id;
				chat_id = rows[i].chat_id;
				nick = rows[i].nickname;
				if (rows[i].reborn == 1) {
					if (rows[i].exp >= 1000) {
						connection.query('UPDATE player SET exp = 1000 WHERE id = ' + rows[i].id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				} else if (rows[i].reborn == 2) {
					if (rows[i].exp >= 1500) {
						connection.query('UPDATE player SET exp = 1500 WHERE id = ' + rows[i].id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				} else if (rows[i].reborn == 3) {
					if (rows[i].exp >= 2000) {
						connection.query('UPDATE player SET exp = 2000 WHERE id = ' + rows[i].id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				} else if (rows[i].reborn == 4) {
					if (rows[i].exp >= 3000) {
						connection.query('UPDATE player SET exp = 3000 WHERE id = ' + rows[i].id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				} else if (rows[i].reborn == 5) {
					if (rows[i].exp >= 10000) {
						connection.query('UPDATE player SET exp = 10000 WHERE id = ' + rows[i].id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				}

				var realLev = getRealLevel(rows[i].reborn, Math.floor(rows[i].exp/10));
				if (realLev >= 750){
					lacrima(player_id, chat_id);
				}
				if (realLev >= 1250){
					lacrima2(player_id, chat_id);
				}
				if (realLev >= 1650){
					lacrima3(player_id, chat_id);
				}

				var life = rows[i].exp * 10;
				if ((rows[i].life == 0) && (rows[i].total_life == 0)) {
					connection.query('UPDATE player SET life = ' + life + ', total_life = ' + life + ' WHERE id = ' + rows[i].id, function (err, rows, fields) {
						if (err) throw err;
					});
				} else {
					connection.query('UPDATE player SET total_life = ' + life + ' WHERE id = ' + rows[i].id, function (err, rows, fields) {
						if (err) throw err;
					});
				}
			}
		}
	});
};

function updateSpecialItem() {
	connection.query('SELECT material_3 FROM craft WHERE material_result = 759', function (err, rows, fields) {
		if (err) throw err;
		connection.query('SELECT id FROM item WHERE rarity IN ("C","NC","R") AND craftable = 0 AND id != ' + rows[0].material_3 + ' ORDER BY RAND()', function (err, rows, fields) {
			if (err) throw err;
			connection.query('UPDATE craft SET material_3 = ' + rows[0].id + ' WHERE material_result = 759', function (err, rows, fields) {
				if (err) throw err;
			});
		});
	});
}

function resetSpecialItem() {
	connection.query('UPDATE craft SET material_3 = 646 WHERE material_result = 759', function (err, rows, fields) {
		if (err) throw err;
	});
}

function checkTeamClean() {
	connection.query('SELECT team.id, team.name, team.players, COUNT(team_player.player_id) As cnt FROM team LEFT JOIN team_player ON team.id = team_player.team_id GROUP BY team.id HAVING cnt = 0', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 team da cancellare\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " team da cancellare\x1b[0m");
			}
			rows.forEach(setFinishedTeamClean);
		}
	});
};

function setFinishedTeamClean(element, index, array) {
	var name = element.name;
	var id = element.id;

	connection.query('DELETE FROM team WHERE id = ' + id, function (err, rows, fields) {
		if (err) throw err;
		console.log("Team eliminato: " + name);
	});
};

function checkTeamPlayers() {
	connection.query('SELECT team.id, team.name, team.players, COUNT(team_player.player_id) As cnt FROM team LEFT JOIN team_player ON team.id = team_player.team_id GROUP BY team.id', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length > 0) {
			if (Object.keys(rows).length == 1) {
				console.log(getNow("it") + "\x1b[32m 1 team adeguato\x1b[0m");
			} else {
				console.log(getNow("it") + "\x1b[32m " + Object.keys(rows).length + " team adeguato\x1b[0m");
			}
			rows.forEach(setFinishedTeamPlayers);
		}
	});
};

function setFinishedTeamPlayers(element, index, array) {
	var name = element.name;
	var id = element.id;
	var players = element.players;
	var cnt = element.cnt;

	if (players != cnt) {
		connection.query('UPDATE team SET players = ' + cnt + ' WHERE id = ' + id, function (err, rows, fields) {
			if (err) throw err;
			console.log("Team adeguato: " + name + " " + players + " -> " + cnt);
		});
	}
};

function setExp(player_id, exp) {
	connection.query('SELECT exp, reborn, nickname FROM player WHERE id = ' + player_id, function (err, rows, fields) {
		if (err) throw err;

		globalAchievement(player_id, exp);

		if (((rows[0].reborn == 1) && (rows[0].exp < 1000)) ||
			((rows[0].reborn == 2) && (rows[0].exp < 1500)) ||
			((rows[0].reborn == 3) && (rows[0].exp < 2000)) ||
			((rows[0].reborn == 4) && (rows[0].exp < 3000)) ||
			(rows[0].reborn == 5)) {
			if (rows[0].exp < 10000) {
				connection.query('UPDATE player SET exp = exp+' + exp + ' WHERE id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
				});
			} else if (rows[0].exp == 10000) {
				connection.query('SELECT COUNT(*) As cnt FROM artifacts WHERE item_id = 675 AND player_id = ' + player_id, function (err, rows, fields) {
					if (err) throw err;
					if (rows[0].cnt > 0) {
						connection.query('UPDATE player SET gain_exp = gain_exp+' + exp + ' WHERE id = ' + player_id, function (err, rows, fields) {
							if (err) throw err;
						});
					}
				});
			}
		}
	});
}

// Gestione oggetti

function addItem(player_id, item_id, qnt = 1) {
	qnt = parseInt(qnt);
	if (isNaN(qnt)){
		console.log("ERRORE! addItem di " + qnt + "x " + item_id + " per player " + player_id);
		return;
	}

	var rows = connection_sync.query('UPDATE inventory SET quantity = quantity+' + qnt + ' WHERE player_id = ' + player_id + ' AND item_id = ' + item_id);
	if (rows.affectedRows == 0){
		connection_sync.query('INSERT INTO inventory (player_id, item_id, quantity) VALUES (' + player_id + ',' + item_id + ', ' + qnt + ')');
	}
}

function delItem(player_id, item_id, qnt = 1) {
	qnt = parseInt(qnt);
	if (isNaN(qnt)){
		console.log("ERRORE! delItem di " + qnt + "x " + item_id + " per player " + player_id);
		return;
	}

	connection.query('UPDATE inventory SET quantity = quantity-' + qnt + ' WHERE player_id = ' + player_id + ' AND item_id = ' + item_id, function (err, rows, fields) {
		if (err) throw err;
	});
}

function delAllItem(player_id, item_id) {
	connection.query('DELETE FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + item_id, function (err, rows, fields) {
		if (err) throw err;
	});
}

function delAllInventory(player_id) {
	connection_sync.query('DELETE FROM inventory WHERE player_id = ' + player_id);
}

function getItemCnt(player_id, item_id) {
	var item = connection_sync.query('SELECT quantity FROM inventory WHERE player_id = ' + player_id + ' AND item_id = ' + item_id);
	if (Object.keys(item).length == 0)
		return 0;
	else
		return item[0].quantity;
}

// Gestione scrigni

function addChest(player_id, chest_id, qnt = 1) {
	qnt = parseInt(qnt);
	if (isNaN(qnt)){
		console.log("ERRORE! addChest di " + qnt + "x " + chest_id + " per player " + player_id);
		return;
	}

	var rows = connection_sync.query('UPDATE inventory_chest SET quantity = quantity+' + qnt + ' WHERE player_id = ' + player_id + ' AND chest_id = ' + chest_id);
	if (rows.affectedRows == 0){
		connection_sync.query('INSERT INTO inventory_chest (player_id, chest_id, quantity) VALUES (' + player_id + ',' + chest_id + ', ' + qnt + ')');
	}
}

function delChest(player_id, chest_id, qnt = 1) {
	qnt = parseInt(qnt);
	if (isNaN(qnt)){
		console.log("ERRORE! delChest di " + qnt + "x " + chest_id + " per player " + player_id);
		return;
	}
	connection.query('UPDATE inventory_chest SET quantity = quantity-' + qnt + ' WHERE player_id = ' + player_id + ' AND chest_id = ' + chest_id, function (err, rows, fields) {
		if (err) throw err;
	});
}

function delAllChest(player_id, chest_id) {
	connection.query('DELETE FROM inventory_chest WHERE player_id = ' + player_id + ' AND chest_id = ' + chest_id, function (err, rows, fields) {
		if (err) throw err;
	});
}

function delAllChestInventory(player_id) {
	connection_sync.query('DELETE FROM inventory_chest WHERE player_id = ' + player_id);
}

function getChestCnt(player_id, chest_id) {
	var item = connection_sync.query('SELECT quantity FROM inventory_chest WHERE player_id = ' + player_id + ' AND chest_id = ' + chest_id);
	if (Object.keys(item).length == 0)
		return 0;
	else
		return item[0].quantity;
}

function isBanned(account_id){
	var banned = connection_sync.query('SELECT reason FROM banlist WHERE account_id = ' + account_id);
	if (Object.keys(banned).length == 0){
		return null;
	}else{
		console.log(account_id + " Ã¨ bannato");
		return banned[0].reason;
	}
}

function calcLife(message) {
	connection.query('SELECT id, exp, life, weapon_id, weapon2_id, weapon3_id, total_life, reborn FROM player WHERE nickname = "' + message.from.username + '"', function (err, rows, fields) {
		if (err) throw err;
		if (Object.keys(rows).length == 0) {
			return;
		}
		var player_id = rows[0].id;

		connection.query('UPDATE player SET total_life = exp*10 WHERE id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});

		var lev = Math.floor(rows[0].exp / 10);
		var power = Math.round(50 + (lev / 2));

		if ((rows[0].weapon_id == 221) || (rows[0].weapon_id == 638) || (rows[0].weapon_id == 639) || (rows[0].weapon_id == 640) || (rows[0].weapon_id == 754)) {
			connection.query('UPDATE player SET weapon = ' + power + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		power = Math.round(25 + (lev / 2));
		power = -Math.abs(power);

		if ((rows[0].weapon2_id == 577) || (rows[0].weapon2_id == 688) || (rows[0].weapon2_id == 689) || (rows[0].weapon2_id == 690)) {
			connection.query('UPDATE player SET weapon2 = ' + power + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		power = Math.round(20 + (lev / 2));
		power = -Math.abs(power);

		if ((rows[0].weapon3_id == 600) || (rows[0].weapon3_id == 671) || (rows[0].weapon3_id == 672) || (rows[0].weapon3_id == 673)) {
			connection.query('UPDATE player SET weapon3 = ' + power + ' WHERE id = ' + player_id, function (err, rows, fields) {
				if (err) throw err;
			});
		}

		connection.query('UPDATE player SET life = total_life WHERE life > total_life AND id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});
		/*
		connection.query('UPDATE player SET life = 0 WHERE life < 0 AND id = ' + player_id, function (err, rows, fields) {
			if (err) throw err;
		});
		*/
	});
}

bot.onText(/^\/last (.+)/, function (message, match) {
	var nick = match[1];

	if (message.from.id == 20471035) {
		connection.query('SELECT time FROM last_command, player WHERE last_command.account_id = player.account_id AND player.nickname = "' + nick + '"', function (err, rows, fields) {
			if (err) throw err;
			if (Object.keys(rows).length > 0) {
				var d = new Date(rows[0].time);
				var long_date = addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds()) + " " + addZero(d.getDate()) + "/" + addZero(d.getMonth()+1) + "/" + d.getFullYear();
				bot.sendMessage(message.chat.id, long_date);
			} else {
				bot.sendMessage(message.chat.id, "Boh!");
			}
		});
	};
});

function addZero(i) {
	if (i < 10)
		i = "0" + i;
	return i;
}

function formatNumber(num) {
	return ("" + num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, function ($1) {
		return $1 + "."
	});
}

function toDate(lang, date) {
	var d = new Date(date);
	if (typeof date == "object")
		d = date;
	if (lang == "it") {
		var datetime = addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear() + " alle " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	} else if (lang == "en") {
		var datetime = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	} else {
		var datetime = "Lingua non specificata";
	}
	return datetime;
}

function getNow(lang, obj) {
	var d = new Date();
	obj = typeof obj !== 'undefined' ? obj : false;
	if (lang == "it") {
		var datetime = addZero(d.getDate()) + "/" + addZero(d.getMonth() + 1) + "/" + d.getFullYear() + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	} else if (lang == "en") {
		var datetime = d.getFullYear() + "-" + addZero(d.getMonth() + 1) + "-" + addZero(d.getDate()) + " " + addZero(d.getHours()) + ':' + addZero(d.getMinutes()) + ':' + addZero(d.getSeconds());
	} else {
		var datetime = "Lingua non specificata";
	}
	if (obj == true) {
		datetime = new Date(datetime);
	}
	return datetime
}

function callNTimes(time, fn) {
	function callFn() {
		if (1 < 0) return;
		fn();
		setTimeout(callFn, time);
	}
	setTimeout(callFn, time);
}

function findAndRemove(array, str) {
	for (var i = 0; i < array.length; i++) {
		if (array[i] == str) {
			array.splice(i, 1);
		}
	}
	return array;
}

function findInArray(array, str) {
	for (var i = 0; i < array.length; i++) {
		if (array[i] == str) {
			return true;
		}
	}
	return false;
}

function getPosition(str, m, i) {
	return str.split(m, i).join(m).length;
}

function shuffle(array) {
	var currentIndex = array.length,
		temporaryValue, randomIndex;

	while (0 !== currentIndex) {
		randomIndex = Math.floor(Math.random() * currentIndex);
		currentIndex -= 1;

		temporaryValue = array[currentIndex];
		array[currentIndex] = array[randomIndex];
		array[randomIndex] = temporaryValue;
	}
	return array;
}

function mysql_real_escape_string(str) {
	return str.replace(/[\0\x08\x09\x1a\n\r"'\\\%]/g, function (char) {
		switch (char) {
			case "\0":
				return "\\0";
			case "\x08":
				return "\\b";
			case "\x09":
				return "\\t";
			case "\x1a":
				return "\\z";
			case "\n":
				return "\\n";
			case "\r":
				return "\\r";
			case "\"":
			case "'":
			case "\\":
			case "%":
				return "\\" + char;
		}
	});
}

function estimate(values) {
	if (values.length <= 2)
		return average(values);
	var avg = average(values),
		upper = [],
		lower = [];
	values.forEach(function (val) {
		if (val >= avg)
			upper.push(val);
		else
			lower.push(val);
	});

	if (upper.length == 0)
		return average(lower);
	if (lower.length == 0)
		return average(upper);

	var upperDev = deviationFromAvg(upper, avg),
		lowerDev = deviationFromAvg(lower, avg);
	if (upperDev >= lowerDev)
		return estimate(lower);
	else
		return estimate(upper);
}

function searchArrayInString(str, strArray) {
	for (var j = 0; j < strArray.length; j++) {
		if (str.indexOf(strArray[j]) != -1)
			return j;
	}
	return -1;
}

function average(values) {
	var sum = 0;
	values.forEach(function (el) {
		sum += +el;
	});
	return Math.floor(sum / values.length);
}

function deviationFromAvg(values, avg) {
	var dev = 0;
	values.forEach(function (el) {
		dev += Math.abs(el - avg);
	});
	return Math.floor(dev / values.length);
}

String.prototype.replaceAll = function (search, replacement) {
	var target = this;
	return target.replace(new RegExp(search, 'g'), replacement);
};
